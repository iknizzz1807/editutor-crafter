{"html":"<h1 id=\"url-shortener-engineering-design-document\">URL Shortener — Engineering Design Document</h1>\n<h2 id=\"system-purpose\">System Purpose</h2>\n<p>Five independently deployable Go services (four domain services plus a gateway) implement a production-grade URL shortener: accepting long URLs, generating collision-resistant 7-character base62 short codes, serving sub-millisecond redirects via a Redis read-through cache, and delivering asynchronous side-effects (click analytics, milestone notifications) through a RabbitMQ topic exchange. The system uses URL shortening as a deliberately narrow domain so that every architectural boundary—service ownership, event flow, cache semantics, auth propagation—is unambiguous and verifiable in isolation.</p>\n<h2 id=\"service-map\">Service Map</h2>\n<table>\n<thead>\n<tr>\n<th>Service</th>\n<th>Port</th>\n<th>Responsibility</th>\n<th>DB</th>\n<th>Owns Events</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>api-gateway</td>\n<td>8080</td>\n<td>JWT validation, per-IP token-bucket rate limiting, circuit breaker, correlation ID injection, reverse proxy routing</td>\n<td>Redis (rate-limit counters)</td>\n<td>None</td>\n</tr>\n<tr>\n<td>url-service</td>\n<td>8081</td>\n<td>Shorten, redirect (read-through cache), list/delete URLs, outbox worker pool</td>\n<td>url_db (PostgreSQL)</td>\n<td>URLCreatedEvent, URLClickedEvent, URLDeletedEvent</td>\n</tr>\n<tr>\n<td>user-service</td>\n<td>8082</td>\n<td>Registration, bcrypt password hashing, HS256 JWT issuance; exports shared/auth package consumed by all services</td>\n<td>user_db (PostgreSQL)</td>\n<td>None</td>\n</tr>\n<tr>\n<td>analytics-service</td>\n<td>8083</td>\n<td>Sequential URLClickedEvent consumer with event-ID deduplication, click aggregation, milestone detection, public stats API</td>\n<td>analytics_db (PostgreSQL)</td>\n<td>MilestoneReachedEvent</td>\n</tr>\n<tr>\n<td>notification-service</td>\n<td>8084</td>\n<td>Consumes url.created / url.deleted / milestone.reached events, persists notification rows, logs mock email delivery</td>\n<td>notification_db (PostgreSQL)</td>\n<td>None</td>\n</tr>\n</tbody></table>\n<h2 id=\"tech-stack\">Tech Stack</h2>\n<ul>\n<li><strong>Language:</strong> Go 1.23 — stdlib <code>net/http</code>, <code>log/slog</code>, <code>crypto/rand</code>, <code>math/big</code>; no HTTP framework</li>\n<li><strong>Message broker:</strong> RabbitMQ 3.13 — single topic exchange <code>url-shortener</code>; durable queues <code>analytics.clicks</code> and <code>notifications.events</code></li>\n<li><strong>Databases:</strong> PostgreSQL 16 — one container per service (host ports 5432–5435); <code>pgx/v5</code> with <code>pgxpool</code></li>\n<li><strong>Cache / rate-limit store:</strong> Redis 7 — ephemeral, no persistence; <code>go-redis/v9</code></li>\n<li><strong>Auth:</strong> HS256 JWT via <code>golang-jwt/jwt/v5</code>; verified locally by each service from a shared <code>JWT_SECRET</code> — no inter-service auth calls</li>\n<li><strong>Containerization:</strong> Docker Compose with per-service <code>depends_on: condition: service_healthy</code> gates; Go workspace (<code>go.work</code>) monorepo</li>\n</ul>\n<h2 id=\"key-design-decisions\">Key Design Decisions</h2>\n<ul>\n<li><strong>Outbox pattern over direct AMQP publish:</strong> URL mutations (create, click, delete) write the domain event into the <code>outbox</code> table within the same PostgreSQL transaction as the URL row change. A background coordinator (1 goroutine) polls every 2 seconds and fans out to 3 worker goroutines for publish. This decouples redirect latency from broker availability and prevents silent event loss on AMQP channel failure; <code>FOR UPDATE SKIP LOCKED</code> makes the poller safe against accidental dual-coordinator scenarios.</li>\n<li><strong>Redis as non-authoritative accelerator:</strong> The redirect hot path attempts a Redis <code>GET</code> with a 50 ms timeout; any error or miss falls through to PostgreSQL. Redis holds no data that is not already durable in Postgres. A 410-triggering deactivation immediately invalidates the Redis key after committing the SQL update, keeping the cache consistent without distributed coordination.</li>\n<li><strong>Database isolation enforced at the container level:</strong> Each service is given its own PostgreSQL container. Cross-service joins are physically impossible, not merely policy-prohibited. Service boundaries are therefore enforceable in tests without process-level mocking.</li>\n<li><strong>Gateway as stateless infrastructure:</strong> The gateway imports no domain packages (<code>shared/events</code> is explicitly excluded). It performs JWT HMAC verification locally, runs a <code>sync.Mutex</code>-guarded three-state circuit breaker (CLOSED → OPEN → HALF_OPEN) exclusively on the url-service proxy path, and applies Redis INCR+EXPIRE token-bucket rate limiting per client IP. Domain ownership rules and business validation live solely in downstream services.</li>\n<li><strong>Event payloads carry all consumer-needed context:</strong> <code>URLCreatedEvent</code>, <code>URLDeletedEvent</code>, and <code>MilestoneReachedEvent</code> include <code>user_email</code> directly. The notification service never calls user-service to resolve an email address, eliminating a synchronous dependency and a failure mode.</li>\n</ul>\n<h2 id=\"anti-patterns-explicitly-avoided\">Anti-Patterns Explicitly Avoided</h2>\n<table>\n<thead>\n<tr>\n<th>Anti-Pattern</th>\n<th>Mitigation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Shared database</strong></td>\n<td>Four separate PostgreSQL containers; no cross-service schema access at any layer</td>\n</tr>\n<tr>\n<td><strong>Synchronous call chain for analytics</strong></td>\n<td>Analytics consumes <code>URLClickedEvent</code> from RabbitMQ; it never calls url-service to validate a short_code</td>\n</tr>\n<tr>\n<td><strong>God service</strong></td>\n<td>Auth, URL lifecycle, analytics, and notifications are separate binaries with separate bounded contexts and separate databases</td>\n</tr>\n<tr>\n<td><strong>Chatty notification service</strong></td>\n<td>All consumer-needed fields (user email, short code) are denormalized into event payloads at publish time</td>\n</tr>\n<tr>\n<td><strong>Redis as source of truth</strong></td>\n<td>Every write goes to PostgreSQL first; Redis holds only TTL-bounded copies with a hard 1-hour cap</td>\n</tr>\n<tr>\n<td><strong>Algorithm confusion in JWT</strong></td>\n<td>Token verifier checks <code>token.Method.(*jwt.SigningMethodHMAC)</code> before accepting the key, rejecting RS256 and <code>none</code></td>\n</tr>\n</tbody></table>\n<hr>\n<h1 id=\"tdd\">TDD</h1>\n<p>Five independently deployable Go binaries (4 services + 1 gateway) communicate via HTTP/JSON for synchronous reads and RabbitMQ topic exchange for asynchronous side effects. Each service owns a dedicated PostgreSQL instance. Redis serves dual roles: read-through URL cache in url-service and shared rate-limit counter store in the gateway. The outbox pattern guarantees at-least-once event delivery without distributed transactions. A circuit breaker state machine protects the redirect hot path. Correlation IDs propagate through both sync HTTP headers and async event payloads, enabling full cross-service trace reconstruction from structured JSON logs.</p>\n<!-- TDD_MOD_ID: url-shortener-m1 -->\n\n<h1 id=\"foundation-repo-layout-shared-contracts-local-dev-stack\">Foundation: Repo Layout, Shared Contracts, Local Dev Stack</h1>\n<h2 id=\"module-id-url-shortener-m1\"><strong>Module ID:</strong> <code>url-shortener-m1</code></h2>\n<h2 id=\"1-module-charter\">1. Module Charter</h2>\n<h2 id=\"this-module-establishes-the-entire-structural-foundation-that-every-subsequent-milestone-builds-upon-it-creates-the-monorepo-directory-layout-writes-one-gomod-per-service-authors-the-docker-composeyml-that-defines-the-full-container-mesh-4-postgresql-instances-1-rabbitmq-1-redis-4-app-services-1-gateway-stub-defines-the-canonical-domain-event-go-structs-in-sharedevents-provides-a-structured-json-logger-stub-in-sharedlogger-and-wires-each-service-to-its-own-database-via-pgxpool-with-correct-pool-sizing-it-does-not-implement-any-business-logic-url-shortening-authentication-message-publishing-or-consumer-loops-the-only-rabbitmq-work-performed-here-is-topology-declaration-exchange-queue-binding-on-startup-no-messages-are-produced-or-consumed-the-only-http-surface-exposed-is-health-on-each-service-every-invariant-established-here-one-database-per-service-redis-as-optional-cache-never-authoritative-rabbitmq-connection-with-retry-backoff-fatal-exit-on-missing-required-config-must-never-be-violated-by-later-milestones-this-module-is-complete-when-docker-compose-up-brings-all-containers-to-a-healthy-state-within-60-seconds-and-every-health-endpoint-returns-200\">This module establishes the entire structural foundation that every subsequent milestone builds upon. It creates the monorepo directory layout, writes one <code>go.mod</code> per service, authors the <code>docker-compose.yml</code> that defines the full container mesh (4 PostgreSQL instances, 1 RabbitMQ, 1 Redis, 4 app services, 1 gateway stub), defines the canonical domain event Go structs in <code>shared/events</code>, provides a structured-JSON logger stub in <code>shared/logger</code>, and wires each service to its own database via <code>pgxpool</code> with correct pool sizing. It does <strong>not</strong> implement any business logic, URL shortening, authentication, message publishing, or consumer loops. The only RabbitMQ work performed here is topology declaration (exchange + queue + binding) on startup — no messages are produced or consumed. The only HTTP surface exposed is <code>/health</code> on each service. Every invariant established here — one database per service, Redis as optional cache (never authoritative), RabbitMQ connection with retry-backoff, fatal exit on missing required config — must never be violated by later milestones. This module is complete when <code>docker compose up</code> brings all containers to a healthy state within 60 seconds and every <code>/health</code> endpoint returns 200</h2>\n<h2 id=\"2-file-structure\">2. File Structure</h2>\n<p>Create files in the numbered order below. This ordering ensures dependencies (shared packages) exist before services import them.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>url-shortener/                          ← monorepo root\n│\n├── 1.  go.work                         ← Go workspace file tying all modules\n│\n├── shared/\n│   ├── events/\n│   │   ├── 2.  events.go               ← all domain event structs\n│   │   └── 3.  go.mod                  ← module: github.com/yourhandle/url-shortener/shared/events\n│   └── logger/\n│       ├── 4.  logger.go               ← structured JSON logger\n│       └── 5.  go.mod                  ← module: github.com/yourhandle/url-shortener/shared/logger\n│\n├── services/\n│   ├── url-service/\n│   │   ├── 6.  go.mod                  ← module: github.com/yourhandle/url-shortener/url-service\n│   │   ├── 7.  main.go\n│   │   ├── 8.  config.go\n│   │   ├── 9.  db.go\n│   │   ├── 10. redis.go\n│   │   ├── 11. rabbitmq.go\n│   │   ├── 12. health.go\n│   │   └── 13. Dockerfile\n│   │\n│   ├── analytics-service/\n│   │   ├── 14. go.mod\n│   │   ├── 15. main.go\n│   │   ├── 16. config.go\n│   │   ├── 17. db.go\n│   │   ├── 18. rabbitmq.go\n│   │   ├── 19. health.go\n│   │   └── 20. Dockerfile\n│   │\n│   ├── user-service/\n│   │   ├── 21. go.mod\n│   │   ├── 22. main.go\n│   │   ├── 23. config.go\n│   │   ├── 24. db.go\n│   │   ├── 25. health.go\n│   │   └── 26. Dockerfile\n│   │\n│   └── notification-service/\n│       ├── 27. go.mod\n│       ├── 28. main.go\n│       ├── 29. config.go\n│       ├── 30. db.go\n│       ├── 31. rabbitmq.go\n│       ├── 32. health.go\n│       └── 33. Dockerfile\n│\n├── gateway/\n│   ├── 34. go.mod                      ← module: github.com/yourhandle/url-shortener/gateway\n│   ├── 35. main.go                     ← stub: /health only\n│   ├── 36. config.go\n│   ├── 37. health.go\n│   └── 38. Dockerfile\n│\n├── 39. docker-compose.yml\n└── 40. README.md</code></pre></div>\n\n<hr>\n<h2 id=\"3-complete-data-model\">3. Complete Data Model</h2>\n<h3 id=\"31-domain-event-structs-sharedeventseventsgo\">3.1 Domain Event Structs (<code>shared/events/events.go</code>)</h3>\n<p>All events share a common header. Each event is serialized to JSON when placed in RabbitMQ message bodies. The <code>EventType</code> string is the RabbitMQ routing key.</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> events</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// EventType constants — these are also the RabbitMQ routing keys.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventTypeURLCreated</span><span style=\"color:#F97583\">      =</span><span style=\"color:#9ECBFF\"> \"url.created\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventTypeURLClicked</span><span style=\"color:#F97583\">      =</span><span style=\"color:#9ECBFF\"> \"url.clicked\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventTypeURLDeleted</span><span style=\"color:#F97583\">      =</span><span style=\"color:#9ECBFF\"> \"url.deleted\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    EventTypeMilestoneReached</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"milestone.reached\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// BaseEvent carries fields present on every domain event.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Embedding this in concrete events guarantees envelope consistency.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> BaseEvent</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventType     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"event_type\"`</span><span style=\"color:#6A737D\">      // routing key literal</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OccurredAt    </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"occurred_at\"`</span><span style=\"color:#6A737D\">     // UTC wall clock at event creation</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CorrelationID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"correlation_id\"`</span><span style=\"color:#6A737D\">  // propagated from HTTP X-Correlation-ID header</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventID       </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"event_id\"`</span><span style=\"color:#6A737D\">        // UUID v4, used for idempotency dedup</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// URLCreatedEvent is published by url-service after a new short URL is persisted.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Includes user email so notification-service never needs to call user-service.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> URLCreatedEvent</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    BaseEvent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OriginalURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"original_url\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID      </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"user_id\"`</span><span style=\"color:#6A737D\">   // UUID string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserEmail   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">    `json:\"user_email\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt   </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"expires_at,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// URLClickedEvent is published by url-service on every successful redirect.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Analytics-service is the primary consumer; milestone checks happen there.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> URLClickedEvent</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    BaseEvent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    IPHash      </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"ip_hash\"`</span><span style=\"color:#6A737D\">    // SHA-256(IP+salt), never raw IP</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserAgent   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"user_agent\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Referer     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"referer,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ClickedAt   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"clicked_at\"`</span><span style=\"color:#6A737D\"> // duplicates OccurredAt for query clarity</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// URLDeletedEvent is published by url-service when is_active set to false.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> URLDeletedEvent</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    BaseEvent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID    </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"user_id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserEmail </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"user_email\"`</span><span style=\"color:#6A737D\"> // for notification-service, avoids callback</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// MilestoneReachedEvent is published by analytics-service when a click</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// threshold (10, 100, 1000) is crossed for a short code.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> MilestoneReachedEvent</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    BaseEvent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID      </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"user_id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserEmail   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"user_email\"`</span><span style=\"color:#6A737D\"> // denormalized; analytics stores from URLClickedEvent context</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    MilestoneN  </span><span style=\"color:#F97583\">int</span><span style=\"color:#9ECBFF\">    `json:\"milestone\"`</span><span style=\"color:#6A737D\">  // 10 | 100 | 1000</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    TotalClicks </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">  `json:\"total_clicks\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Why each field exists:</strong></p>\n<ul>\n<li><code>EventID</code> (UUID): deduplication key for idempotent consumers; without it, at-least-once delivery causes double-counting.</li>\n<li><code>CorrelationID</code>: cross-service trace continuity through async boundary; must survive the message broker hop.</li>\n<li><code>UserEmail</code> on mutation events: prevents notification-service from calling user-service (avoids chatty service anti-pattern and sync coupling).</li>\n<li><code>ClickedAt</code> on <code>URLClickedEvent</code>: mirrors <code>OccurredAt</code> with explicit semantic name; PostgreSQL <code>date_trunc</code> queries use this column directly.</li>\n</ul>\n<h3 id=\"32-per-service-config-structs\">3.2 Per-Service Config Structs</h3>\n<p>Each service has its own <code>config.go</code>. All fields are populated once at startup from environment variables. <code>os.Getenv</code> is <strong>never</strong> called in handler or hot-path code.</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/url-service/config.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> urlservice</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Config</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DatabaseURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // required; fatal if empty</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RedisURL    </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // required; non-fatal if unreachable</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RabbitMQURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // required; retry with backoff</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Port        </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // default \"8080\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ServiceName </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // constant \"url-service\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> loadConfig</span><span style=\"color:#E1E4E8\">() (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Config</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Config</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        DatabaseURL: os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DATABASE_URL\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        RedisURL:    os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"REDIS_URL\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        RabbitMQURL: os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"RABBITMQ_URL\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Port:        </span><span style=\"color:#B392F0\">envOrDefault</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"PORT\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"8080\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ServiceName: </span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cfg.DatabaseURL </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DATABASE_URL is required\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cfg.RabbitMQURL </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"RABBITMQ_URL is required\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cfg.RedisURL </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"REDIS_URL is required\"</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#6A737D\">// required env var; non-fatal only if *connection* fails</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> cfg, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> envOrDefault</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">key</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">def</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> v </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(key); v </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> v</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> def</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/analytics-service/config.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> analytics</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Config</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DatabaseURL </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RabbitMQURL </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Port        </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ServiceName </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// services/user-service/config.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> userservice</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Config</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DatabaseURL </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Port        </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ServiceName </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// services/notification-service/config.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> notification</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Config</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DatabaseURL </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RabbitMQURL </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Port        </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ServiceName </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// gateway/config.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> gateway</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Config</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    URLServiceURL          </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // e.g. http://url-service:8080</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    AnalyticsServiceURL    </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserServiceURL         </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    NotificationServiceURL </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RedisURL               </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Port                   </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ServiceName            </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p>For services without Redis or RabbitMQ, those fields simply do not exist in the config struct.</p>\n<h3 id=\"33-health-response-schema\">3.3 Health Response Schema</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> HealthResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Status  </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"status\"`</span><span style=\"color:#6A737D\">  // always \"ok\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Service </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"service\"`</span><span style=\"color:#6A737D\"> // service name constant</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"34-rabbitmq-topology\">3.4 RabbitMQ Topology</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Exchange: &quot;url-shortener&quot;   type: topic   durable: true   autoDelete: false\nQueue: &quot;analytics.clicks&quot;\n  binding: exchange=&quot;url-shortener&quot;  routing_key=&quot;url.clicked&quot;  durable: true\nQueue: &quot;notifications.events&quot;\n  binding: exchange=&quot;url-shortener&quot;  routing_key=&quot;url.created&quot;  durable: true\n  binding: exchange=&quot;url-shortener&quot;  routing_key=&quot;url.deleted&quot;  durable: true\n  binding: exchange=&quot;url-shortener&quot;  routing_key=&quot;milestone.reached&quot;  durable: true</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-1.svg\" alt=\"Monorepo Directory Tree\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>┌─────────────────────────────────────────────────────────────────┐\n│                    RabbitMQ Broker                              │\n│                                                                 │\n│   Exchange: &quot;url-shortener&quot; (topic, durable)                    │\n│       │                                                         │\n│       ├─── routing_key: &quot;url.clicked&quot; ──────► Queue:           │\n│       │                                       &quot;analytics.clicks&quot;│\n│       │                                                         │\n│       ├─── routing_key: &quot;url.created&quot; ──────► Queue:           │\n│       │                                       &quot;notifications.   │\n│       ├─── routing_key: &quot;url.deleted&quot; ──────►  events&quot;          │\n│       │                                                         │\n│       └─── routing_key: &quot;milestone.reached&quot; ─►  (same queue)   │\n└─────────────────────────────────────────────────────────────────┘\nDeclaration responsibility:\n  url-service:            declares exchange &quot;url-shortener&quot;\n  analytics-service:      declares queue &quot;analytics.clicks&quot; + binding\n  notification-service:   declares queue &quot;notifications.events&quot; + all 3 bindings</code></pre></div>\n\n<hr>\n<h2 id=\"4-interface-contracts\">4. Interface Contracts</h2>\n<h3 id=\"41-sharedlogger-package\">4.1 <code>shared/logger</code> Package</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> logger</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">log/slog</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// New returns a *slog.Logger writing JSON to stdout.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// serviceName is embedded in every log record as \"service\" field.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// This is the ONLY logger constructor that should be used across all services.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">serviceName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Usage pattern (all services):</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   log := logger.New(\"url-service\")</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   log.Info(\"connected to DB\", \"host\", \"url_db:5432\")</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   log.Error(\"startup failure\", \"error\", err)</span></span></code></pre></div>\n\n<p><strong>Implementation detail:</strong> Use <code>slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions{Level: slog.LevelInfo})</code>. Wrap with <code>slog.New</code>. Add <code>serviceName</code> as a default attribute via <code>logger.With(&quot;service&quot;, serviceName)</code>. The returned logger is safe for concurrent use (slog guarantees this).\n<strong>Fields emitted in every log line:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Source</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>time</code></td>\n<td>RFC3339Nano</td>\n<td>slog default</td>\n</tr>\n<tr>\n<td><code>level</code></td>\n<td>string</td>\n<td>slog default</td>\n</tr>\n<tr>\n<td><code>service</code></td>\n<td>string</td>\n<td>constructor arg</td>\n</tr>\n<tr>\n<td><code>msg</code></td>\n<td>string</td>\n<td>log call</td>\n</tr>\n<tr>\n<td>any extras</td>\n<td>varies</td>\n<td>per log call</td>\n</tr>\n</tbody></table>\n<h3 id=\"42-db-connection-factory\">4.2 DB Connection Factory</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// db.go (per service — same pattern, different pool owner)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> urlservice</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/jackc/pgx/v5/pgxpool</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewDBPool creates a pgxpool with project-standard settings.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns fatal error if the pool cannot ping the DB within 10s.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Parameters:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   ctx        - a context with a 10-second timeout applied internally</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   databaseURL - postgres:// DSN from config</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   log        - structured logger for startup messages</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   *pgxpool.Pool - ready pool, caller must call .Close() on shutdown</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   error         - non-nil if DB unreachable; caller must os.Exit(1)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewDBPool</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">databaseURL</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> pgxpool.</span><span style=\"color:#B392F0\">ParseConfig</span><span style=\"color:#E1E4E8\">(databaseURL)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"parse db url: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg.MaxConns </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> 10</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg.MinConns </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> 2</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> pgxpool.</span><span style=\"color:#B392F0\">NewWithConfig</span><span style=\"color:#E1E4E8\">(ctx, cfg)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"create pool: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pingCtx, cancel </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithTimeout</span><span style=\"color:#E1E4E8\">(ctx, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#B392F0\"> cancel</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> pool.</span><span style=\"color:#B392F0\">Ping</span><span style=\"color:#E1E4E8\">(pingCtx); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        pool.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"ping db: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"connected to DB\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"max_conns\"</span><span style=\"color:#E1E4E8\">, cfg.MaxConns, </span><span style=\"color:#9ECBFF\">\"min_conns\"</span><span style=\"color:#E1E4E8\">, cfg.MinConns)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> pool, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Error contract:</strong></p>\n<ul>\n<li>If <code>pgxpool.ParseConfig</code> fails → return error immediately, do not attempt connection.</li>\n<li>If <code>pool.Ping</code> times out or is refused → close pool, return wrapped error.</li>\n<li>Caller in <code>main.go</code> must call <code>log.Error(...); os.Exit(1)</code> on non-nil return.</li>\n</ul>\n<h3 id=\"43-redis-connection-factory-url-service-only\">4.3 Redis Connection Factory (url-service only)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// redis.go — url-service only</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> urlservice</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/redis/go-redis/v9</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewRedisClient creates a Redis client and pings the server.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// UNLIKE the DB pool, a failed ping here is NON-FATAL.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// The function always returns a *redis.Client (usable even if server is down).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// The bool return indicates whether the initial ping succeeded.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Parameters:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   ctx      - used for initial ping only</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   redisURL - redis://host:port/0 DSN</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   log      - structured logger</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   *redis.Client - always non-nil; configured client</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   bool          - true if initial ping succeeded, false otherwise</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewRedisClient</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">redisURL</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Client</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    opts, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> redis.</span><span style=\"color:#B392F0\">ParseURL</span><span style=\"color:#E1E4E8\">(redisURL)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Warn</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"redis URL parse failed, cache disabled\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"error\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> redis.</span><span style=\"color:#B392F0\">NewClient</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Options</span><span style=\"color:#E1E4E8\">{Addr: </span><span style=\"color:#9ECBFF\">\"localhost:6379\"</span><span style=\"color:#E1E4E8\">}), </span><span style=\"color:#79B8FF\">false</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> redis.</span><span style=\"color:#B392F0\">NewClient</span><span style=\"color:#E1E4E8\">(opts)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pingCtx, cancel </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithTimeout</span><span style=\"color:#E1E4E8\">(ctx, </span><span style=\"color:#79B8FF\">3</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#B392F0\"> cancel</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> client.</span><span style=\"color:#B392F0\">Ping</span><span style=\"color:#E1E4E8\">(pingCtx).</span><span style=\"color:#B392F0\">Err</span><span style=\"color:#E1E4E8\">(); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Warn</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"redis unreachable on startup, cache will be disabled until available\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"error\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> client, </span><span style=\"color:#79B8FF\">false</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"connected to Redis cache\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"addr\"</span><span style=\"color:#E1E4E8\">, opts.Addr)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> client, </span><span style=\"color:#79B8FF\">true</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Critical:</strong> The Redis client is returned regardless of ping success. Later cache operations must each independently handle errors (wrap in a helper that logs and continues).</p>\n<h3 id=\"44-rabbitmq-connection-factory\">4.4 RabbitMQ Connection Factory</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// rabbitmq.go (url-service, analytics-service, notification-service)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> urlservice</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    amqp </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#B392F0\">github.com/rabbitmq/amqp091-go</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    exchangeName</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"url-shortener\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    exchangeType</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"topic\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RabbitMQConn wraps an AMQP connection and channel.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RabbitMQConn</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Conn    </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Connection</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Channel </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Channel</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewRabbitMQConn connects to RabbitMQ with exponential backoff.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Retries up to maxAttempts times before returning error.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Each attempt is logged. On success, declares the exchange.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Parameters:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   ctx         - for cancellation during retry loop</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   amqpURL     - amqp://user:pass@host:5672/</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   log         - structured logger</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   maxAttempts - typically 10 for startup; backoff doubles each retry (1s→2s→4s...max 30s)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   *RabbitMQConn - connected and channel-open; caller owns Close()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   error         - non-nil after maxAttempts exhausted</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewRabbitMQConn</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">amqpURL</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">maxAttempts</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">RabbitMQConn</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> conn </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Connection</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    backoff </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.Second</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> attempt </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\">; attempt </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#E1E4E8\"> maxAttempts; attempt</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        conn, err </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> amqp.</span><span style=\"color:#B392F0\">Dial</span><span style=\"color:#E1E4E8\">(amqpURL)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            break</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Warn</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"rabbitmq connection attempt failed\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"attempt\"</span><span style=\"color:#E1E4E8\">, attempt,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"max_attempts\"</span><span style=\"color:#E1E4E8\">, maxAttempts,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"backoff_seconds\"</span><span style=\"color:#E1E4E8\">, backoff.</span><span style=\"color:#B392F0\">Seconds</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"error\"</span><span style=\"color:#E1E4E8\">, err,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        )</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        select</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        case</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">ctx.</span><span style=\"color:#B392F0\">Done</span><span style=\"color:#E1E4E8\">():</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"context cancelled during rabbitmq connect: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, ctx.</span><span style=\"color:#B392F0\">Err</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        case</span><span style=\"color:#F97583\"> &#x3C;-</span><span style=\"color:#E1E4E8\">time.</span><span style=\"color:#B392F0\">After</span><span style=\"color:#E1E4E8\">(backoff):</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        backoff </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> min</span><span style=\"color:#E1E4E8\">(backoff</span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"rabbitmq connect after </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> attempts: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, maxAttempts, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ch, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> conn.</span><span style=\"color:#B392F0\">Channel</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        conn.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"open rabbitmq channel: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> declareExchange</span><span style=\"color:#E1E4E8\">(ch); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ch.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        conn.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"declare exchange: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"connected to RabbitMQ\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"exchange\"</span><span style=\"color:#E1E4E8\">, exchangeName)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">RabbitMQConn</span><span style=\"color:#E1E4E8\">{Conn: conn, Channel: ch}, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> declareExchange</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ch</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Channel</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">ExchangeDeclare</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        exchangeName, </span><span style=\"color:#6A737D\">// name</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        exchangeType, </span><span style=\"color:#6A737D\">// kind: \"topic\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        true</span><span style=\"color:#E1E4E8\">,         </span><span style=\"color:#6A737D\">// durable</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        false</span><span style=\"color:#E1E4E8\">,        </span><span style=\"color:#6A737D\">// autoDelete</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        false</span><span style=\"color:#E1E4E8\">,        </span><span style=\"color:#6A737D\">// internal</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        false</span><span style=\"color:#E1E4E8\">,        </span><span style=\"color:#6A737D\">// noWait</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        nil</span><span style=\"color:#E1E4E8\">,          </span><span style=\"color:#6A737D\">// args</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    )</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Close shuts down channel then connection in correct order.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">r </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">RabbitMQConn</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> r.Channel </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        r.Channel.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> r.Conn </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        r.Conn.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"45-queuebinding-declaration-consumer-services\">4.5 Queue/Binding Declaration (Consumer Services)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// analytics-service rabbitmq.go — additional function after NewRabbitMQConn</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> DeclareAnalyticsQueue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ch</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Channel</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    q, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">QueueDeclare</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"analytics.clicks\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// name</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        true</span><span style=\"color:#E1E4E8\">,               </span><span style=\"color:#6A737D\">// durable</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        false</span><span style=\"color:#E1E4E8\">,              </span><span style=\"color:#6A737D\">// autoDelete</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        false</span><span style=\"color:#E1E4E8\">,              </span><span style=\"color:#6A737D\">// exclusive</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        false</span><span style=\"color:#E1E4E8\">,              </span><span style=\"color:#6A737D\">// noWait</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        nil</span><span style=\"color:#E1E4E8\">,                </span><span style=\"color:#6A737D\">// args</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    )</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"declare analytics.clicks queue: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">QueueBind</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        q.Name,        </span><span style=\"color:#6A737D\">// queue name</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"url.clicked\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// routing key</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        exchangeName,  </span><span style=\"color:#6A737D\">// exchange</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        false</span><span style=\"color:#E1E4E8\">,         </span><span style=\"color:#6A737D\">// noWait</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        nil</span><span style=\"color:#E1E4E8\">,           </span><span style=\"color:#6A737D\">// args</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"bind analytics.clicks to url.clicked: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// notification-service rabbitmq.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> DeclareNotificationQueue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ch</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Channel</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    q, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">QueueDeclare</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"notifications.events\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        true</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    )</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"declare notifications.events queue: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, routingKey </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"url.created\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"url.deleted\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"milestone.reached\"</span><span style=\"color:#E1E4E8\">} {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> ch.</span><span style=\"color:#B392F0\">QueueBind</span><span style=\"color:#E1E4E8\">(q.Name, routingKey, exchangeName, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"bind notifications.events to </span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, routingKey, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Error contract for consumer services:</strong> If queue/binding declaration fails, it is <strong>fatal</strong>. The consumer service cannot function without its queue. Call <code>log.Error(...); os.Exit(1)</code>.</p>\n<h3 id=\"46-health-handler\">4.6 Health Handler</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// health.go (same pattern all services; serviceName differs)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> urlservice</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">encoding/json</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> HealthResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Status  </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"status\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Service </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"service\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewHealthHandler returns an http.HandlerFunc for GET /health.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// No authentication required. Responds in &#x3C; 10ms.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Does NOT check DB connectivity on every request (too expensive).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewHealthHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">serviceName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    resp </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> HealthResponse</span><span style=\"color:#E1E4E8\">{Status: </span><span style=\"color:#9ECBFF\">\"ok\"</span><span style=\"color:#E1E4E8\">, Service: serviceName}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    body, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Marshal</span><span style=\"color:#E1E4E8\">(resp) </span><span style=\"color:#6A737D\">// pre-encoded; never changes</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(http.StatusOK)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        w.</span><span style=\"color:#B392F0\">Write</span><span style=\"color:#E1E4E8\">(body)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h2 id=\"why-pre-encode-the-response-never-changes-during-the-process-lifetime-encoding-once-at-startup-avoids-per-request-allocation-jsonmarshal-on-this-tiny-struct-cannot-fail-no-custom-marshalers-no-channelsfuncs\"><strong>Why pre-encode:</strong> The response never changes during the process lifetime. Encoding once at startup avoids per-request allocation. <code>json.Marshal</code> on this tiny struct cannot fail (no custom marshalers, no channels/funcs)</h2>\n<h2 id=\"5-algorithm-specification\">5. Algorithm Specification</h2>\n<h3 id=\"51-startup-sequence-url-service-most-complex-others-are-subsets\">5.1 Startup Sequence — url-service (most complex; others are subsets)</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>1. loadConfig()\n   → if any required env var is empty: log.Error + os.Exit(1)\n2. log := logger.New(cfg.ServiceName)\n   → all subsequent log calls use this logger\n3. pool, err := NewDBPool(ctx, cfg.DatabaseURL, log)\n   → if err != nil: log.Error(&quot;db unreachable&quot;, &quot;error&quot;, err); os.Exit(1)\n   → if ok: log(&quot;connected to DB&quot;) already emitted inside factory\n4. redisClient, _ := NewRedisClient(ctx, cfg.RedisURL, log)\n   → warning already logged inside factory; continue regardless\n5. mq, err := NewRabbitMQConn(ctx, cfg.RabbitMQURL, log, maxAttempts=10)\n   → if err != nil: log.Error + os.Exit(1)\n   → exchange declared inside factory\n6. Register HTTP routes:\n   mux := http.NewServeMux()\n   mux.HandleFunc(&quot;GET /health&quot;, NewHealthHandler(cfg.ServiceName))\n7. Start HTTP server on cfg.Port\n   → log.Info(&quot;server listening&quot;, &quot;port&quot;, cfg.Port)\n8. Block on server.ListenAndServe() or OS signal\n   → on SIGTERM/SIGINT: pool.Close(), mq.Close(), redisClient.Close()</code></pre></div>\n\n<h3 id=\"52-startup-sequence-analytics-service\">5.2 Startup Sequence — analytics-service</h3>\n<p>Steps 1-5 as url-service except:</p>\n<ul>\n<li>No Redis (step 4 omitted)</li>\n<li>After step 5 (RabbitMQ connected), call <code>DeclareAnalyticsQueue(mq.Channel)</code><ul>\n<li>If error: log.Error + os.Exit(1)</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"53-startup-sequence-notification-service\">5.3 Startup Sequence — notification-service</h3>\n<p>Same as analytics-service but calls <code>DeclareNotificationQueue(mq.Channel)</code> instead.</p>\n<h3 id=\"54-startup-sequence-user-service\">5.4 Startup Sequence — user-service</h3>\n<p>Steps 1 (DATABASE_URL required, no RABBITMQ_URL), 2, 3, 6, 7, 8 only. No Redis, no RabbitMQ.</p>\n<h3 id=\"55-startup-sequence-gateway-stub\">5.5 Startup Sequence — gateway (stub)</h3>\n<p>Steps 1 (requires URLServiceURL, AnalyticsServiceURL, UserServiceURL, NotificationServiceURL), 2, 6, 7, 8. Registers <code>/health</code> only at this milestone.</p>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-2.svg\" alt=\"Docker Compose Container Topology\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>url-service startup:\n  ┌──────────┐  ┌────────┐  ┌───────┐  ┌─────────┐  ┌────────┐\n  │loadConfig│→ │DB ping │→ │Redis  │→ │RabbitMQ │→ │HTTP    │\n  │          │  │(fatal) │  │ping   │  │connect  │→ │server  │\n  └──────────┘  └────────┘  │(warn) │  │+ exch   │  │listen  │\n                             └───────┘  │(fatal)  │  └────────┘\n                                        └─────────┘\nanalytics/notification startup:\n  loadConfig → DB ping (fatal) → RabbitMQ connect (fatal) → queue declare (fatal) → HTTP\nuser-service startup:\n  loadConfig → DB ping (fatal) → HTTP\ngateway startup:\n  loadConfig → HTTP (health only for now)</code></pre></div>\n\n<hr>\n<h2 id=\"6-docker-compose-specification\">6. Docker Compose Specification</h2>\n<h3 id=\"61-complete-docker-composeyml\">6.1 Complete <code>docker-compose.yml</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">yaml</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#85E89D\">version</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"3.9\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  url-shortener</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    driver</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">bridge</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">volumes</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  url_db_data</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  analytics_db_data</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  user_db_data</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  notification_db_data</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  rabbitmq_data</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  redis_data</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">services</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  # ── Databases ────────────────────────────────────────────────────────────────</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  url_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    image</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">postgres:16-alpine</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_DB</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">urldb</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_USER</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">urluser</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_PASSWORD</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">urlpass</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"5432:5432\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    volumes</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">url_db_data:/var/lib/postgresql/data</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">url-shortener</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"pg_isready -U urluser -d urldb\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">10</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  analytics_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    image</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">postgres:16-alpine</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_DB</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">analyticsdb</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_USER</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">analyticsuser</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_PASSWORD</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">analyticspass</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"5433:5432\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    volumes</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">analytics_db_data:/var/lib/postgresql/data</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">url-shortener</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"pg_isready -U analyticsuser -d analyticsdb\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">10</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  user_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    image</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">postgres:16-alpine</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_DB</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">userdb</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_USER</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">useruser</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_PASSWORD</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">userpass</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"5434:5432\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    volumes</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">user_db_data:/var/lib/postgresql/data</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">url-shortener</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"pg_isready -U useruser -d userdb\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">10</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  notification_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    image</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">postgres:16-alpine</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_DB</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">notificationdb</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_USER</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">notificationuser</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      POSTGRES_PASSWORD</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">notificationpass</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"5435:5432\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    volumes</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">notification_db_data:/var/lib/postgresql/data</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">url-shortener</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"pg_isready -U notificationuser -d notificationdb\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">10</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  # ── Message Broker ───────────────────────────────────────────────────────────</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  rabbitmq</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    image</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">rabbitmq:3.13-management-alpine</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      RABBITMQ_DEFAULT_USER</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">guest</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      RABBITMQ_DEFAULT_PASS</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">guest</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"5672:5672\"</span><span style=\"color:#6A737D\"> # AMQP</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"15672:15672\"</span><span style=\"color:#6A737D\"> # Management UI</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    volumes</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">rabbitmq_data:/var/lib/rabbitmq</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">url-shortener</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"rabbitmq-diagnostics\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"ping\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">10</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">20s</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  # ── Cache ────────────────────────────────────────────────────────────────────</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  redis</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    image</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">redis:7-alpine</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    command</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">redis-server --save \"\" --appendonly no</span><span style=\"color:#6A737D\"> # ephemeral; cache only</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"6379:6379\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    volumes</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">redis_data:/data</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">url-shortener</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"redis-cli\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"ping\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">3s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">10</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">  # ── Application Services ─────────────────────────────────────────────────────</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  url-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    build</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      context</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">./services/url-service</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      dockerfile</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Dockerfile</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      DATABASE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">postgres://urluser:urlpass@url_db:5432/urldb</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      REDIS_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">redis://redis:6379/0</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      RABBITMQ_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">amqp://guest:guest@rabbitmq:5672/</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      PORT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"8080\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"8081:8080\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">url-shortener</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    depends_on</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      url_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      redis</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      rabbitmq</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"wget -qO- http://localhost:8080/health || exit 1\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">5</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">15s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  analytics-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    build</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      context</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">./services/analytics-service</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      dockerfile</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Dockerfile</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      DATABASE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">postgres://analyticsuser:analyticspass@analytics_db:5432/analyticsdb</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      RABBITMQ_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">amqp://guest:guest@rabbitmq:5672/</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      PORT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"8080\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"8082:8080\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">url-shortener</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    depends_on</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      analytics_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      rabbitmq</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"wget -qO- http://localhost:8080/health || exit 1\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">5</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">15s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  user-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    build</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      context</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">./services/user-service</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      dockerfile</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Dockerfile</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      DATABASE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">postgres://useruser:userpass@user_db:5432/userdb</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      PORT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"8080\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"8083:8080\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">url-shortener</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    depends_on</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      user_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"wget -qO- http://localhost:8080/health || exit 1\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">5</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">15s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  notification-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    build</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      context</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">./services/notification-service</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      dockerfile</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Dockerfile</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      DATABASE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">postgres://notificationuser:notificationpass@notification_db:5432/notificationdb</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      RABBITMQ_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">amqp://guest:guest@rabbitmq:5672/</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      PORT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"8080\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"8084:8080\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">url-shortener</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    depends_on</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      notification_db</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      rabbitmq</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"wget -qO- http://localhost:8080/health || exit 1\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">5</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">15s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  gateway</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    build</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      context</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">./gateway</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      dockerfile</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">Dockerfile</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      URL_SERVICE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">http://url-service:8080</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      ANALYTICS_SERVICE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">http://analytics-service:8080</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      USER_SERVICE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">http://user-service:8080</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      NOTIFICATION_SERVICE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">http://notification-service:8080</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      PORT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"8080\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ports</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">\"8080:8080\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    networks</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">      - </span><span style=\"color:#9ECBFF\">url-shortener</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    depends_on</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      url-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      analytics-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      user-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      notification-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">        condition</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">service_healthy</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    healthcheck</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      test</span><span style=\"color:#E1E4E8\">: [</span><span style=\"color:#9ECBFF\">\"CMD-SHELL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"wget -qO- http://localhost:8080/health || exit 1\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      interval</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">10s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      timeout</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">5s</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      retries</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">5</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">      start_period</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">20s</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-3.svg\" alt=\"Domain Event Struct Data Model\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Port mapping (host → container):\n  8080 → gateway\n  8081 → url-service\n  8082 → analytics-service\n  8083 → user-service\n  8084 → notification-service\n  5432 → url_db        (postgres)\n  5433 → analytics_db  (postgres)\n  5434 → user_db       (postgres)\n  5435 → notification_db (postgres)\n  5672 → rabbitmq      (AMQP)\n  15672→ rabbitmq      (management UI)\n  6379 → redis\ndepends_on chain (healthy gate):\n  gateway ← {url-service, analytics-service, user-service, notification-service}\n  url-service ← {url_db, redis, rabbitmq}\n  analytics-service ← {analytics_db, rabbitmq}\n  notification-service ← {notification_db, rabbitmq}\n  user-service ← {user_db}</code></pre></div>\n\n<h3 id=\"62-dockerfile-uniform-across-all-services\">6.2 Dockerfile (uniform across all services)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">dockerfile</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># services/url-service/Dockerfile</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> golang:1.23-alpine </span><span style=\"color:#F97583\">AS</span><span style=\"color:#E1E4E8\"> builder</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">WORKDIR</span><span style=\"color:#E1E4E8\"> /app</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Copy go.work and all module go.mod/go.sum files first (cache layer)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COPY</span><span style=\"color:#E1E4E8\"> go.mod go.sum ./</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Download dependencies</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">RUN</span><span style=\"color:#E1E4E8\"> go mod download</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Copy source</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COPY</span><span style=\"color:#E1E4E8\"> . .</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Build static binary</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">RUN</span><span style=\"color:#E1E4E8\"> CGO_ENABLED=0 GOOS=linux go build -ldflags=</span><span style=\"color:#9ECBFF\">\"-s -w\"</span><span style=\"color:#E1E4E8\"> -o /service ./...</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">FROM</span><span style=\"color:#E1E4E8\"> scratch</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">COPY</span><span style=\"color:#E1E4E8\"> --from=builder /service /service</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">EXPOSE</span><span style=\"color:#E1E4E8\"> 8080</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">ENTRYPOINT</span><span style=\"color:#E1E4E8\"> [</span><span style=\"color:#9ECBFF\">\"/service\"</span><span style=\"color:#E1E4E8\">]</span></span></code></pre></div>\n\n<p><strong>Note on go.work:</strong> Because services share <code>shared/events</code> and <code>shared/logger</code>, the <code>go.work</code> file at root must list all modules so Docker build context resolves replace directives correctly. Copy the entire monorepo into each service&#39;s build context, or use a root-level multi-stage build. The simpler approach for this milestone: set Docker build context to monorepo root and specify Dockerfile path per service.\nRevised <code>docker-compose.yml</code> build section for monorepo:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">yaml</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#85E89D\">url-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  build</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    context</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">.</span><span style=\"color:#6A737D\"> # monorepo root</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    dockerfile</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">services/url-service/Dockerfile</span></span></code></pre></div>\n\n<p>And corresponding Dockerfile modification to <code>WORKDIR /app</code> then <code>COPY . .</code> from root.</p>\n<h3 id=\"63-go-workspace-gowork\">6.3 Go Workspace (<code>go.work</code>)</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>go 1.23\nuse (\n    ./shared/events\n    ./shared/logger\n    ./services/url-service\n    ./services/analytics-service\n    ./services/user-service\n    ./services/notification-service\n    ./gateway\n)</code></pre></div>\n\n<p>Each service <code>go.mod</code> references shared packages:</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>// services/url-service/go.mod\nmodule github.com/yourhandle/url-shortener/url-service\ngo 1.23\nrequire (\n    github.com/yourhandle/url-shortener/shared/events v0.0.0\n    github.com/yourhandle/url-shortener/shared/logger v0.0.0\n    github.com/jackc/pgx/v5 v5.6.0\n    github.com/redis/go-redis/v9 v9.6.0\n    github.com/rabbitmq/amqp091-go v1.10.0\n)\nreplace (\n    github.com/yourhandle/url-shortener/shared/events =&gt; ../../shared/events\n    github.com/yourhandle/url-shortener/shared/logger =&gt; ../../shared/logger\n)</code></pre></div>\n\n<hr>\n<h2 id=\"7-error-handling-matrix\">7. Error Handling Matrix</h2>\n<table>\n<thead>\n<tr>\n<th>Error</th>\n<th>Detected By</th>\n<th>Recovery</th>\n<th>User-Visible?</th>\n<th>Exit?</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Missing required env var (DATABASE_URL, RABBITMQ_URL)</td>\n<td><code>loadConfig()</code> at startup</td>\n<td>Log descriptive message naming the variable</td>\n<td>No (pre-HTTP)</td>\n<td>Yes (<code>os.Exit(1)</code>)</td>\n</tr>\n<tr>\n<td>DB unreachable at startup (<code>pool.Ping</code> timeout)</td>\n<td><code>NewDBPool()</code></td>\n<td>Log error with DSN host (mask password)</td>\n<td>No</td>\n<td>Yes (<code>os.Exit(1)</code>)</td>\n</tr>\n<tr>\n<td>DB DSN malformed</td>\n<td><code>pgxpool.ParseConfig</code></td>\n<td>Log with raw error</td>\n<td>No</td>\n<td>Yes (<code>os.Exit(1)</code>)</td>\n</tr>\n<tr>\n<td>Redis URL malformed</td>\n<td><code>redis.ParseURL</code></td>\n<td>Log warning, use default client, continue</td>\n<td>No</td>\n<td>No</td>\n</tr>\n<tr>\n<td>Redis unreachable at startup (<code>Ping</code> fail)</td>\n<td><code>NewRedisClient()</code></td>\n<td>Log warning, return client anyway</td>\n<td>No</td>\n<td>No</td>\n</tr>\n<tr>\n<td>RabbitMQ unreachable, within maxAttempts</td>\n<td><code>amqp.Dial</code> in retry loop</td>\n<td>Log each attempt with backoff duration, retry</td>\n<td>No</td>\n<td>No (retrying)</td>\n</tr>\n<tr>\n<td>RabbitMQ unreachable, maxAttempts exhausted</td>\n<td><code>NewRabbitMQConn()</code></td>\n<td>Log fatal</td>\n<td>No</td>\n<td>Yes (<code>os.Exit(1)</code>)</td>\n</tr>\n<tr>\n<td>Exchange declare failure</td>\n<td><code>declareExchange()</code></td>\n<td>Log error</td>\n<td>No</td>\n<td>Yes (<code>os.Exit(1)</code>)</td>\n</tr>\n<tr>\n<td>Queue declare failure (consumer services)</td>\n<td><code>DeclareAnalyticsQueue</code> / <code>DeclareNotificationQueue</code></td>\n<td>Log error</td>\n<td>No</td>\n<td>Yes (<code>os.Exit(1)</code>)</td>\n</tr>\n<tr>\n<td>Queue binding failure</td>\n<td>same functions</td>\n<td>Log error</td>\n<td>No</td>\n<td>Yes (<code>os.Exit(1)</code>)</td>\n</tr>\n<tr>\n<td>Context cancelled during RabbitMQ retry</td>\n<td>select in retry loop</td>\n<td>Return wrapped error</td>\n<td>No</td>\n<td>Yes (caller exits)</td>\n</tr>\n<tr>\n<td><code>/health</code> handler write error</td>\n<td><code>w.Write</code> return</td>\n<td>Ignored (client disconnected)</td>\n<td>No</td>\n<td>No</td>\n</tr>\n</tbody></table>\n<p><strong>Password masking for DB DSN in logs:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// When logging the DSN in an error, strip credentials:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> maskDSN</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">dsn</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    u, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> url.</span><span style=\"color:#B392F0\">Parse</span><span style=\"color:#E1E4E8\">(dsn)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#9ECBFF\"> \"[unparseable DSN]\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    u.User </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> url.</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"***\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> u.</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<hr>\n<h2 id=\"8-implementation-sequence-with-checkpoints\">8. Implementation Sequence with Checkpoints</h2>\n<h3 id=\"phase-1-monorepo-scaffold-and-gomod-per-service-051h\">Phase 1: Monorepo Scaffold and go.mod per Service (0.5–1h)</h3>\n<ol>\n<li>Create directory tree exactly as shown in §2.</li>\n<li>Write <code>go.work</code> at root.</li>\n<li>Write <code>go.mod</code> for <code>shared/events</code> and <code>shared/logger</code> (no dependencies beyond stdlib for logger).</li>\n<li>Write <code>go.mod</code> for each service with the <code>require</code> + <code>replace</code> blocks.</li>\n<li>Run <code>go work sync</code> at root.\n<strong>Checkpoint:</strong> <code>go build ./...</code> from monorepo root exits 0 (even with empty <code>main.go</code> stubs that just <code>package main; func main() {}</code>).</li>\n</ol>\n<h3 id=\"phase-2-docker-composeyml-with-all-containers-115h\">Phase 2: docker-compose.yml with All Containers (1–1.5h)</h3>\n<ol>\n<li>Write <code>docker-compose.yml</code> as specified in §6.1.</li>\n<li>Verify <code>docker compose config</code> exits 0 (validates YAML syntax).</li>\n<li>Run <code>docker compose up rabbitmq redis url_db analytics_db user_db notification_db -d</code>.</li>\n<li>Check <code>docker compose ps</code> — all six infra containers show <code>healthy</code>.\n<strong>Checkpoint:</strong> <code>docker compose ps</code> shows all infra containers in <code>healthy</code> state. <code>psql -h localhost -p 5432 -U urluser -d urldb -c &#39;\\l&#39;</code> connects. <code>redis-cli -p 6379 ping</code> returns <code>PONG</code>. RabbitMQ management UI reachable at <code>http://localhost:15672</code> (guest/guest).</li>\n</ol>\n<h3 id=\"phase-3-sharedevents-and-sharedlogger-05h\">Phase 3: shared/events and shared/logger (0.5h)</h3>\n<ol>\n<li>Write <code>shared/events/events.go</code> exactly as §3.1.</li>\n<li>Write <code>shared/logger/logger.go</code>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> logger</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">log/slog</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">serviceName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> slog.</span><span style=\"color:#B392F0\">NewJSONHandler</span><span style=\"color:#E1E4E8\">(os.Stdout, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">HandlerOptions</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Level: slog.LevelInfo,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> slog.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(h).</span><span style=\"color:#B392F0\">With</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"service\"</span><span style=\"color:#E1E4E8\">, serviceName)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<ol>\n<li>Run <code>go build github.com/yourhandle/url-shortener/shared/...</code> → exits 0.\n<strong>Checkpoint:</strong> A throwaway <code>main.go</code> that imports <code>shared/logger</code>, calls <code>logger.New(&quot;test&quot;).Info(&quot;hello&quot;)</code>, and runs prints valid JSON to stdout: <code>{&quot;time&quot;:&quot;...&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;service&quot;:&quot;test&quot;,&quot;msg&quot;:&quot;hello&quot;}</code>.</li>\n</ol>\n<h3 id=\"phase-4-per-service-config-db-pool-redis-health-handler-115h\">Phase 4: Per-Service Config, DB Pool, Redis, Health Handler (1–1.5h)</h3>\n<p>For each service in order (url-service → analytics-service → user-service → notification-service → gateway):</p>\n<ol>\n<li>Write <code>config.go</code> (Config struct + <code>loadConfig()</code>).</li>\n<li>Write <code>db.go</code> (<code>NewDBPool</code>).</li>\n<li>(url-service only) Write <code>redis.go</code> (<code>NewRedisClient</code>).</li>\n<li>Write <code>health.go</code> (<code>NewHealthHandler</code>).</li>\n<li>Wire in <code>main.go</code>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/url-service/main.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> main</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os/signal</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">syscall</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourhandle/url-shortener/shared/logger</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> loadConfig</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // logger not yet initialized; use fmt</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        fmt.</span><span style=\"color:#B392F0\">Fprintf</span><span style=\"color:#E1E4E8\">(os.Stderr, </span><span style=\"color:#9ECBFF\">\"config error: </span><span style=\"color:#79B8FF\">%v\\n</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        os.</span><span style=\"color:#B392F0\">Exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> logger.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(cfg.ServiceName)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ctx </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewDBPool</span><span style=\"color:#E1E4E8\">(ctx, cfg.DatabaseURL, log)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"db unreachable\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"error\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        os.</span><span style=\"color:#B392F0\">Exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> pool.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    redisClient, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewRedisClient</span><span style=\"color:#E1E4E8\">(ctx, cfg.RedisURL, log)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> redisClient.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mq, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewRabbitMQConn</span><span style=\"color:#E1E4E8\">(ctx, cfg.RabbitMQURL, log, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"rabbitmq unreachable\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"error\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        os.</span><span style=\"color:#B392F0\">Exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> mq.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mux </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">NewServeMux</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /health\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">NewHealthHandler</span><span style=\"color:#E1E4E8\">(cfg.ServiceName))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    srv </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Server</span><span style=\"color:#E1E4E8\">{Addr: </span><span style=\"color:#9ECBFF\">\":\"</span><span style=\"color:#F97583\"> +</span><span style=\"color:#E1E4E8\"> cfg.Port, Handler: mux}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    go</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"server listening\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"port\"</span><span style=\"color:#E1E4E8\">, cfg.Port)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> srv.</span><span style=\"color:#B392F0\">ListenAndServe</span><span style=\"color:#E1E4E8\">(); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#F97583\"> &#x26;&#x26;</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> http.ErrServerClosed {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            log.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"server error\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"error\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            os.</span><span style=\"color:#B392F0\">Exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    quit </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">chan</span><span style=\"color:#B392F0\"> os</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Signal</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    signal.</span><span style=\"color:#B392F0\">Notify</span><span style=\"color:#E1E4E8\">(quit, syscall.SIGTERM, syscall.SIGINT)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    &#x3C;-</span><span style=\"color:#E1E4E8\">quit</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"shutting down\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    srv.</span><span style=\"color:#B392F0\">Shutdown</span><span style=\"color:#E1E4E8\">(ctx)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<ol>\n<li>Build each service: <code>go build ./services/url-service/...</code> → exits 0.\n<strong>Checkpoint:</strong> <code>go build ./...</code> from root exits 0 for all services. Each binary starts without panicking when environment variables are set.</li>\n</ol>\n<h3 id=\"phase-5-rabbitmq-exchange-and-queuebinding-declaration-051h\">Phase 5: RabbitMQ Exchange and Queue/Binding Declaration (0.5–1h)</h3>\n<ol>\n<li>Complete <code>rabbitmq.go</code> in url-service (exchange declare already in <code>NewRabbitMQConn</code>).</li>\n<li>Write <code>DeclareAnalyticsQueue</code> in analytics-service <code>rabbitmq.go</code>.</li>\n<li>Write <code>DeclareNotificationQueue</code> in notification-service <code>rabbitmq.go</code>.</li>\n<li>Call declare functions in <code>main.go</code> of analytics-service and notification-service after <code>NewRabbitMQConn</code> returns.\n<strong>Checkpoint:</strong> Run all four app services locally (with env vars pointing to Docker infra containers):</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">DATABASE_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">...</span><span style=\"color:#E1E4E8\"> REDIS_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">...</span><span style=\"color:#E1E4E8\"> RABBITMQ_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">...</span><span style=\"color:#B392F0\"> go</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#9ECBFF\"> ./services/url-service/</span></span></code></pre></div>\n\n<p>RabbitMQ management UI at <code>http://localhost:15672/#/exchanges</code> shows <code>url-shortener</code> exchange (type: topic, durable). <code>http://localhost:15672/#/queues</code> shows <code>analytics.clicks</code> and <code>notifications.events</code> queues with correct bindings.</p>\n<h3 id=\"phase-6-full-docker-compose-up-readme-05h\">Phase 6: Full docker compose up + README (0.5h)</h3>\n<ol>\n<li>Write Dockerfiles as §6.2, ensuring build context is monorepo root.</li>\n<li>Update <code>docker-compose.yml</code> build contexts to <code>.</code> with explicit Dockerfile paths.</li>\n<li>Run <code>docker compose up --build -d</code>.</li>\n<li>Wait up to 60s then check <code>docker compose ps</code> — all containers <code>healthy</code>.</li>\n<li>Smoke test each <code>/health</code> endpoint:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> port </span><span style=\"color:#F97583\">in</span><span style=\"color:#9ECBFF\"> 8080</span><span style=\"color:#9ECBFF\"> 8081</span><span style=\"color:#9ECBFF\"> 8082</span><span style=\"color:#9ECBFF\"> 8083</span><span style=\"color:#9ECBFF\"> 8084</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">do</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  echo</span><span style=\"color:#79B8FF\"> -n</span><span style=\"color:#9ECBFF\"> \"Port </span><span style=\"color:#E1E4E8\">$port</span><span style=\"color:#9ECBFF\">: \"</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:</span><span style=\"color:#E1E4E8\">$port</span><span style=\"color:#9ECBFF\">/health</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  echo</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">done</span></span></code></pre></div>\n\n<p>Expected output for each:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">json</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">{ </span><span style=\"color:#79B8FF\">\"status\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"ok\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">\"service\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"&#x3C;service-name>\"</span><span style=\"color:#E1E4E8\"> }</span></span></code></pre></div>\n\n<ol>\n<li>Write <code>README.md</code> (§9).\n<strong>Checkpoint:</strong> All five <code>/health</code> endpoints return 200 with correct <code>service</code> field. <code>docker compose down -v</code> tears down everything cleanly with exit 0. <code>docker compose up</code> again restores all to healthy.</li>\n</ol>\n<hr>\n<h2 id=\"9-test-specification\">9. Test Specification</h2>\n<h3 id=\"91-sharedevents-package-tests\">9.1 <code>shared/events</code> Package Tests</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// shared/events/events_test.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> events_test</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">encoding/json</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourhandle/url-shortener/shared/events</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestURLCreatedEvent_RoundTrip</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    evt </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URLCreatedEvent</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        BaseEvent: </span><span style=\"color:#B392F0\">events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">BaseEvent</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            EventType:     events.EventTypeURLCreated,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            OccurredAt:    time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">UTC</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Truncate</span><span style=\"color:#E1E4E8\">(time.Millisecond),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            CorrelationID: </span><span style=\"color:#9ECBFF\">\"corr-123\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            EventID:       </span><span style=\"color:#9ECBFF\">\"evt-456\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ShortCode:   </span><span style=\"color:#9ECBFF\">\"abc1234\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        OriginalURL: </span><span style=\"color:#9ECBFF\">\"https://example.com/long/path\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        UserID:      </span><span style=\"color:#9ECBFF\">\"user-uuid\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        UserEmail:   </span><span style=\"color:#9ECBFF\">\"user@example.com\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Marshal</span><span style=\"color:#E1E4E8\">(evt)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"marshal: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> decoded </span><span style=\"color:#B392F0\">events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URLCreatedEvent</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">(b, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">decoded); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"unmarshal: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> decoded.EventType </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> events.EventTypeURLCreated {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"event_type: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> want </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, decoded.EventType, events.EventTypeURLCreated)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> decoded.ShortCode </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> evt.ShortCode {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"short_code mismatch\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> decoded.ExpiresAt </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"nil expires_at should stay nil\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestURLClickedEvent_OmitEmptyReferer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    evt </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URLClickedEvent</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        BaseEvent: </span><span style=\"color:#B392F0\">events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">BaseEvent</span><span style=\"color:#E1E4E8\">{EventType: events.EventTypeURLClicked},</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Referer intentionally empty</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Marshal</span><span style=\"color:#E1E4E8\">(evt)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> m </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#B392F0\">any</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">(b, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">m)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> _, ok </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> m[</span><span style=\"color:#9ECBFF\">\"referer\"</span><span style=\"color:#E1E4E8\">]; ok {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"referer should be omitted when empty\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestEventTypeConstants</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // routing keys must match RabbitMQ binding keys exactly</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cases </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        events.EventTypeURLCreated:       </span><span style=\"color:#9ECBFF\">\"url.created\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        events.EventTypeURLClicked:       </span><span style=\"color:#9ECBFF\">\"url.clicked\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        events.EventTypeURLDeleted:       </span><span style=\"color:#9ECBFF\">\"url.deleted\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        events.EventTypeMilestoneReached: </span><span style=\"color:#9ECBFF\">\"milestone.reached\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> got, want </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> cases {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> got </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> want {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"constant mismatch: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> want </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, got, want)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"92-config-loading-tests\">9.2 Config Loading Tests</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/url-service/config_test.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> urlservice</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestLoadConfig_MissingDatabaseURL</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    os.</span><span style=\"color:#B392F0\">Unsetenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DATABASE_URL\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    os.</span><span style=\"color:#B392F0\">Setenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"RABBITMQ_URL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"amqp://localhost:5672\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    os.</span><span style=\"color:#B392F0\">Setenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"REDIS_URL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"redis://localhost:6379\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> loadConfig</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatal</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected error for missing DATABASE_URL\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestLoadConfig_MissingRabbitMQURL</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    os.</span><span style=\"color:#B392F0\">Setenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DATABASE_URL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"postgres://user:pass@localhost/db\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    os.</span><span style=\"color:#B392F0\">Unsetenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"RABBITMQ_URL\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    os.</span><span style=\"color:#B392F0\">Setenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"REDIS_URL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"redis://localhost:6379\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> loadConfig</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatal</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected error for missing RABBITMQ_URL\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestLoadConfig_DefaultPort</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    os.</span><span style=\"color:#B392F0\">Setenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DATABASE_URL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"postgres://user:pass@localhost/db\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    os.</span><span style=\"color:#B392F0\">Setenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"RABBITMQ_URL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"amqp://localhost:5672\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    os.</span><span style=\"color:#B392F0\">Setenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"REDIS_URL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"redis://localhost:6379\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    os.</span><span style=\"color:#B392F0\">Unsetenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"PORT\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> loadConfig</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"unexpected error: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cfg.Port </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"8080\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"default port: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> want </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, cfg.Port, </span><span style=\"color:#9ECBFF\">\"8080\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestLoadConfig_ServiceName</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    os.</span><span style=\"color:#B392F0\">Setenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DATABASE_URL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"postgres://user:pass@localhost/db\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    os.</span><span style=\"color:#B392F0\">Setenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"RABBITMQ_URL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"amqp://localhost:5672\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    os.</span><span style=\"color:#B392F0\">Setenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"REDIS_URL\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"redis://localhost:6379\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> loadConfig</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cfg.ServiceName </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"url-service\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"service name: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> want url-service\"</span><span style=\"color:#E1E4E8\">, cfg.ServiceName)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"93-health-handler-tests\">9.3 Health Handler Tests</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/url-service/health_test.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> urlservice</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">encoding/json</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http/httptest</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestHealthHandler_ResponseShape</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    handler </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewHealthHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/health\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    handler</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> http.StatusOK {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"status: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 200\"</span><span style=\"color:#E1E4E8\">, rec.Code)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ct </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> rec.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> ct </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"application/json\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"content-type: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> want application/json\"</span><span style=\"color:#E1E4E8\">, ct)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> resp </span><span style=\"color:#B392F0\">HealthResponse</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">(rec.Body.</span><span style=\"color:#B392F0\">Bytes</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">resp); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"parse body: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> resp.Status </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"ok\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"status field: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> want ok\"</span><span style=\"color:#E1E4E8\">, resp.Status)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> resp.Service </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"url-service\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"service field: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> want url-service\"</span><span style=\"color:#E1E4E8\">, resp.Service)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestHealthHandler_DifferentServiceNames</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, name </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"analytics-service\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"user-service\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"notification-service\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"gateway\"</span><span style=\"color:#E1E4E8\">} {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Run</span><span style=\"color:#E1E4E8\">(name, </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewHealthHandler</span><span style=\"color:#E1E4E8\">(name)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/health\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            h</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            var</span><span style=\"color:#E1E4E8\"> resp </span><span style=\"color:#B392F0\">HealthResponse</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">(rec.Body.</span><span style=\"color:#B392F0\">Bytes</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">resp)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> resp.Service </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> name {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"service: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> want </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, resp.Service, name)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"94-integration-smoke-test-shell-script\">9.4 Integration Smoke Test (shell script)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">#!/usr/bin/env bash</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># scripts/smoke_test.sh — run after docker compose up</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">set</span><span style=\"color:#79B8FF\"> -e</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">SERVICES</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  \"http://localhost:8080/health:gateway\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  \"http://localhost:8081/health:url-service\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  \"http://localhost:8082/health:analytics-service\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  \"http://localhost:8083/health:user-service\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  \"http://localhost:8084/health:notification-service\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> entry </span><span style=\"color:#F97583\">in</span><span style=\"color:#9ECBFF\"> \"${</span><span style=\"color:#E1E4E8\">SERVICES</span><span style=\"color:#9ECBFF\">[</span><span style=\"color:#F97583\">@</span><span style=\"color:#9ECBFF\">]}\"</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">do</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"${</span><span style=\"color:#E1E4E8\">entry</span><span style=\"color:#F97583\">%%:*</span><span style=\"color:#9ECBFF\">}\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  EXPECTED_SERVICE</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"${</span><span style=\"color:#E1E4E8\">entry</span><span style=\"color:#F97583\">##*:</span><span style=\"color:#9ECBFF\">}\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  RESPONSE</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -sf</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$URL</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  STATUS</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$RESPONSE</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> python3</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"import sys,json; d=json.load(sys.stdin); print(d['status'])\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  SERVICE</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$RESPONSE</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> python3</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"import sys,json; d=json.load(sys.stdin); print(d['service'])\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  if</span><span style=\"color:#E1E4E8\"> [ </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">$STATUS</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> !=</span><span style=\"color:#9ECBFF\"> \"ok\"</span><span style=\"color:#E1E4E8\"> ]; </span><span style=\"color:#F97583\">then</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    echo</span><span style=\"color:#9ECBFF\"> \"FAIL </span><span style=\"color:#E1E4E8\">$URL</span><span style=\"color:#9ECBFF\">: status=</span><span style=\"color:#E1E4E8\">$STATUS</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    exit</span><span style=\"color:#79B8FF\"> 1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  fi</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  if</span><span style=\"color:#E1E4E8\"> [ </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">$SERVICE</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> !=</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$EXPECTED_SERVICE</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\"> ]; </span><span style=\"color:#F97583\">then</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    echo</span><span style=\"color:#9ECBFF\"> \"FAIL </span><span style=\"color:#E1E4E8\">$URL</span><span style=\"color:#9ECBFF\">: service=</span><span style=\"color:#E1E4E8\">$SERVICE</span><span style=\"color:#9ECBFF\"> (expected </span><span style=\"color:#E1E4E8\">$EXPECTED_SERVICE</span><span style=\"color:#9ECBFF\">)\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    exit</span><span style=\"color:#79B8FF\"> 1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  fi</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  echo</span><span style=\"color:#9ECBFF\"> \"PASS </span><span style=\"color:#E1E4E8\">$URL</span><span style=\"color:#9ECBFF\"> → {status:ok, service:</span><span style=\"color:#E1E4E8\">$SERVICE</span><span style=\"color:#9ECBFF\">}\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">done</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"All health checks passed.\"</span></span></code></pre></div>\n\n<hr>\n<h2 id=\"10-performance-targets\">10. Performance Targets</h2>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>Target</th>\n<th>How to Measure</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>docker compose up</code> → all containers healthy</td>\n<td>≤ 60s</td>\n<td><code>time docker compose up -d</code> then poll <code>docker compose ps</code> until no container shows <code>starting</code></td>\n</tr>\n<tr>\n<td><code>/health</code> response time (any service)</td>\n<td>&lt; 10ms p99</td>\n<td><code>wrk -t1 -c10 -d10s http://localhost:8081/health</code> — check Latency 99th percentile</td>\n</tr>\n<tr>\n<td><code>pgxpool.Acquire</code> on warm pool</td>\n<td>&lt; 100ms</td>\n<td>Instrument <code>NewDBPool</code> with <code>time.Since</code> around <code>pool.Ping</code>; log duration</td>\n</tr>\n<tr>\n<td><code>docker compose down -v</code> teardown</td>\n<td>≤ 30s</td>\n<td><code>time docker compose down -v</code></td>\n</tr>\n<tr>\n<td>Service startup (process → HTTP ready)</td>\n<td>&lt; 5s after infra healthy</td>\n<td>Measure from container start to first successful healthcheck</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"11-readme-content\">11. README Content</h2>\n<pre><code class=\"language-markdown\"># URL Shortener — Microservices\n\n## Prerequisites\n\n- Docker &gt;= 24 with Compose v2\n- Go 1.23+ (for local development outside Docker)\n\n## Start the full stack\n\n\\```bash\ndocker compose up --build -d\n\\```\nWait ~60s for all containers to reach healthy state:\n\\```bash\ndocker compose ps\n\\```\n\n## Verify health\n\n\\```bash\nbash scripts/smoke_test.sh\n\\```\n\n## Stop and clean up (including volumes)\n\n\\```bash\ndocker compose down -v\n\\```\n\n## Service ports (host)\n\n| Service              | Port  |\n| -------------------- | ----- |\n| Gateway              | 8080  |\n| URL Service          | 8081  |\n| Analytics Service    | 8082  |\n| User Service         | 8083  |\n| Notification Service | 8084  |\n| RabbitMQ AMQP        | 5672  |\n| RabbitMQ Management  | 15672 |\n| Redis                | 6379  |\n| URL DB (PostgreSQL)  | 5432  |\n| Analytics DB         | 5433  |\n| User DB              | 5434  |\n| Notification DB      | 5435  |\n\n## RabbitMQ credentials\n\nUser: guest / Password: guest\nManagement UI: http://localhost:15672\n</code></pre>\n<hr>\n<h2 id=\"12-pitfall-prevention\">12. Pitfall Prevention</h2>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-4.svg\" alt=\"RabbitMQ Exchange/Queue/Binding Topology\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>PITFALL MAP for M1:\n1. Hardcoded &quot;localhost&quot; in DSN\n   Wrong:  DATABASE_URL=postgres://user:pass@localhost:5432/urldb\n   Right:  DATABASE_URL=postgres://user:pass@url_db:5432/urldb\n   Why: Docker bridge network resolves service names, not &quot;localhost&quot;\n2. Single PostgreSQL with multiple schemas\n   Wrong:  url_db: ... POSTGRES_DB: urls,analytics,users\n   Right:  Four separate postgres containers on ports 5432-5435\n   Why: database-per-service is the invariant; schemas in one instance\n        still couple services via a shared crash domain\n3. Producer-only exchange/queue declaration\n   Wrong:  url-service declares &quot;analytics.clicks&quot; queue\n   Right:  analytics-service declares its OWN queue and binding\n   Why:    If analytics-service starts first, messages publish to\n           exchange but no queue exists → messages dropped silently\n4. No depends_on + healthcheck → crash loop\n   Wrong:  app starts, DB isn't ready, pgxpool.Ping fails → os.Exit(1)\n           Docker restarts → repeat\n   Right:  depends_on with condition: service_healthy gates app start\n           until pg_isready returns 0\n5. Redis as authoritative store\n   Wrong:  Storing the canonical URL record only in Redis\n   Right:  All writes go to PostgreSQL first; Redis holds TTL copies</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-5.svg\" alt=\"Service Startup Sequence with Dependency Readiness\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Exchange/Queue declaration sequence (correct):\n  url-service     analytics-service    notification-service\n       │                  │                    │\n       ▼                  ▼                    ▼\n  ExchangeDeclare    QueueDeclare         QueueDeclare\n  &quot;url-shortener&quot;  &quot;analytics.clicks&quot;  &quot;notifications.events&quot;\n                         │                    │\n                    QueueBind            QueueBind × 3\n                    url.clicked          url.created\n                                         url.deleted\n                                         milestone.reached\nAll three declarations are idempotent:\n  → declaring an existing exchange/queue with same params = no-op\n  → declaring with DIFFERENT params = error (caught at startup)</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-6.svg\" alt=\"pgxpool Connection Pool Configuration Data Flow\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>startup fatality matrix:\nService               │ DB fail │ Redis fail │ RabbitMQ fail │ Queue declare fail\n──────────────────────┼─────────┼────────────┼───────────────┼───────────────────\nurl-service           │  FATAL  │  WARN+cont │    FATAL      │   N/A (producer)\nanalytics-service     │  FATAL  │     N/A    │    FATAL      │      FATAL\nuser-service          │  FATAL  │     N/A    │     N/A       │       N/A\nnotification-service  │  FATAL  │     N/A    │    FATAL      │      FATAL\ngateway               │   N/A   │     N/A    │     N/A       │       N/A</code></pre></div>\n\n<hr>\n<!-- END_TDD_MOD -->\n\n<!-- TDD_MOD_ID: url-shortener-m2 -->\n\n<h1 id=\"user-service-registration-login-jwt-issuance\">User Service: Registration, Login, JWT Issuance</h1>\n<h2 id=\"module-id-url-shortener-m2\"><strong>Module ID:</strong> <code>url-shortener-m2</code></h2>\n<h2 id=\"1-module-charter\">1. Module Charter</h2>\n<p>This module implements the User Service as a fully self-contained authentication provider. It owns the <code>users</code> table in its dedicated PostgreSQL instance (<code>user_db</code>), hashes passwords with bcrypt at cost 12, issues HS256-signed JWT tokens on successful login, and exposes three HTTP endpoints: <code>POST /register</code>, <code>POST /login</code>, and <code>GET /me</code>. It produces a reusable <code>shared/auth</code> package containing the JWT verification middleware consumed by <strong>all other services</strong> to validate tokens locally without inter-service calls.\nThis module does <strong>not</strong> publish domain events to RabbitMQ. It does <strong>not</strong> call any other service. It does <strong>not</strong> implement URL shortening, analytics, or notification logic. It does <strong>not</strong> maintain session state — every token verification is purely computational (HMAC-SHA256 + claims parsing), with no database round-trip after issuance. The User Service is the <strong>only</strong> service that writes to <code>user_db</code>; all other services treat user identity as a verified JWT claim, never as a DB lookup.\n<strong>Upstream dependencies:</strong> <code>shared/logger</code> (structured JSON logging), <code>shared/auth</code> (produced by this module, consumed by others), PostgreSQL <code>user_db</code> (this service&#39;s exclusive database), <code>shared/events</code> package (imported by go.mod but unused in this module — no events emitted).\n<strong>Downstream consumers:</strong> Every other service imports <code>shared/auth</code> for the <code>JWTMiddleware</code> and <code>VerifyToken</code> function. The <code>JWT_SECRET</code> environment variable is the shared secret — it must be identical across all services.\n<strong>Invariants that must always hold:</strong></p>\n<ul>\n<li>Plaintext passwords never appear in logs, HTTP responses, or the database.</li>\n<li>The bcrypt hash stored in <code>password_hash</code> column is never returned in any API response.</li>\n<li>Failed login always returns 401 with a generic message — the response must be identical whether the email does not exist or the password is wrong (timing-safe behavior at the application layer; bcrypt compare is constant-time internally).</li>\n<li><code>user_id</code> in JWT is always a UUID v4 (not an integer); integer IDs would be enumerable.</li>\n<li><code>JWT_SECRET</code> is read from environment at startup and stored in the Config struct; it is never read from <code>os.Getenv</code> in hot paths.</li>\n</ul>\n<hr>\n<h2 id=\"2-file-structure\">2. File Structure</h2>\n<p>Create files in the numbered order below. Shared packages first, then service files.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>url-shortener/\n│\n├── shared/\n│   └── auth/\n│       ├── 1. go.mod          ← module: github.com/yourhandle/url-shortener/shared/auth\n│       ├── 2. auth.go         ← Claims struct, TokenIssuer interface, VerifyToken func\n│       └── 3. middleware.go   ← JWTMiddleware: func(http.Handler) http.Handler\n│\n├── services/\n│   └── user-service/\n│       ├── (existing from M1)\n│       │   ├── go.mod         ← add shared/auth + golang-jwt/jwt dependency\n│       │   ├── main.go        ← extend: add routes, wire handler deps\n│       │   ├── config.go      ← extend: add JWTSecret, BCryptCost, TokenTTL fields\n│       │   ├── db.go          ← (unchanged from M1)\n│       │   └── health.go      ← (unchanged from M1)\n│       │\n│       ├── 4.  migration.sql  ← CREATE TABLE users + indexes\n│       ├── 5.  store.go       ← UserRepository interface + pgxUserStore implementation\n│       ├── 6.  password.go    ← PasswordHasher interface + bcryptHasher implementation\n│       ├── 7.  token.go       ← jwtTokenIssuer implementing TokenIssuer\n│       ├── 8.  handler.go     ← Handler struct with Register, Login, Me methods\n│       ├── 9.  validate.go    ← email format + password length validators\n│       ├── 10. errors.go      ← sentinel errors and writeError helper\n│       └── 11. user_test.go   ← unit tests (store mock, handler tests, validator tests)\n│\n└── (M1 files unchanged: docker-compose.yml, gateway/, analytics-service/, etc.)</code></pre></div>\n\n<hr>\n<h2 id=\"3-complete-data-model\">3. Complete Data Model</h2>\n<h3 id=\"31-postgresql-schema-migrationsql\">3.1 PostgreSQL Schema (<code>migration.sql</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- migration.sql (run once against user_db on startup or via init script)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> users (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    id            UUID        </span><span style=\"color:#F97583\">PRIMARY KEY</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#E1E4E8\"> gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    email         </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        UNIQUE</span><span style=\"color:#F97583\"> NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    password_hash </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    created_at    </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\"> NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Supports: lookup by email on login (exact match, unique index)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> UNIQUE INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_users_email </span><span style=\"color:#F97583\">ON</span><span style=\"color:#E1E4E8\"> users(email);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Note: no index needed on id — it is the PRIMARY KEY (clustered B-tree by default in pgx).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Note: created_at has no index; no time-range queries are required for this service.</span></span></code></pre></div>\n\n<p><strong>Column rationale:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Column</th>\n<th>Type</th>\n<th>Constraint</th>\n<th>Why</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>id</code></td>\n<td>UUID</td>\n<td>PK, DEFAULT gen_random_uuid()</td>\n<td>Non-enumerable identifier; safe to embed in JWT <code>sub</code> claim; no sequential leak</td>\n</tr>\n<tr>\n<td><code>email</code></td>\n<td>TEXT</td>\n<td>UNIQUE NOT NULL</td>\n<td>Login credential, must be unique; TEXT over VARCHAR because max email length (254 chars RFC 5321) is not worth constraining separately</td>\n</tr>\n<tr>\n<td><code>password_hash</code></td>\n<td>TEXT</td>\n<td>NOT NULL</td>\n<td>bcrypt output is always 60 chars but TEXT avoids coupling schema to algorithm output length</td>\n</tr>\n<tr>\n<td><code>created_at</code></td>\n<td>TIMESTAMPTZ</td>\n<td>NOT NULL DEFAULT now()</td>\n<td>Audit trail; timezone-aware</td>\n</tr>\n</tbody></table>\n<h3 id=\"32-go-structs-sharedauth-package\">3.2 Go Structs — <code>shared/auth</code> Package</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// shared/auth/auth.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> auth</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Claims is the JWT payload structure.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// These fields appear in every token issued by the User Service.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Other services parse this after signature verification.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Claims</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Sub is the user_id UUID string. Named \"sub\" per JWT RFC 7519 §4.1.2.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Sub   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"sub\"`</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Email is denormalized from the users table for convenience.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Avoids downstream services needing a DB lookup to display user context.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Email </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"email\"`</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Iss is the issuer claim. Always \"url-shortener\".</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Iss   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"iss\"`</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Iat is issued-at Unix timestamp (seconds).</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Iat   </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">  `json:\"iat\"`</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Exp is expiry Unix timestamp (seconds). Default: iat + 86400 (24h).</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Exp   </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">  `json:\"exp\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// IsExpired returns true if the current wall time is past Exp.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Does NOT verify the signature — that is done by VerifyToken.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">c </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Claims</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">IsExpired</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Unix</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">></span><span style=\"color:#E1E4E8\"> c.Exp</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ExpiresAt converts the Exp Unix timestamp to a time.Time for response serialization.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">c </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Claims</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ExpiresAt</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Unix</span><span style=\"color:#E1E4E8\">(c.Exp, </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">).</span><span style=\"color:#B392F0\">UTC</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// TokenIssuer and VerifyToken live in auth.go to co-locate the contract with Claims.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TokenIssuer abstracts JWT issuance. Allows test doubles.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Implemented by jwtTokenIssuer in user-service/token.go.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> TokenIssuer</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Issue creates and signs a JWT for the given user.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns the signed token string and the expiry time, or an error.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Issue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">userID</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">email</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#FFAB70\">tokenString</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">expiresAt</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Verify parses and validates a token string.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns the Claims on success, or an error if the token is expired,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // has an invalid signature, or is malformed.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Verify</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">tokenString</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Claims</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"33-go-structs-user-service-package\">3.3 Go Structs — <code>user-service</code> Package</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/user-service/store.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// User is the domain object. Never returned directly in HTTP responses.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> User</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID           </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // UUID string, e.g. \"550e8400-e29b-41d4-a716-446655440000\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Email        </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    PasswordHash </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // bcrypt hash; NEVER log this field</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt    </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// UserRepository abstracts all DB operations for the users table.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Defined at the consumer (handler package), not the producer (pgxUserStore).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> UserRepository</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert creates a new user row. Returns ErrDuplicateEmail if email exists.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">email</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">passwordHash</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // FindByEmail retrieves a user by email.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns ErrUserNotFound if no row matches.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    FindByEmail</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">email</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/user-service/password.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// PasswordHasher abstracts bcrypt to allow test doubles.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> PasswordHasher</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Hash returns a bcrypt hash of the plaintext password.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Cost is configured at construction time (default 12).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Hash</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">plaintext</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Verify compares a plaintext password against a stored hash.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns nil on match, ErrPasswordMismatch on mismatch.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // This call takes O(2^cost) CPU time — do not call in tight loops.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Verify</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">plaintext</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">hash</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/user-service/config.go (extended from M1)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> userservice</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">strconv</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Config</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DatabaseURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">        // required; fatal if empty</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Port        </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">        // default \"8080\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ServiceName </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">        // constant \"user-service\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    JWTSecret   </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">        // required; HS256 signing key; min 32 bytes recommended</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    BCryptCost  </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\">           // default 12; range [10, 14] for this project</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    TokenTTL    </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#6A737D\"> // default 24h; configurable via TOKEN_TTL_HOURS env var</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> loadConfig</span><span style=\"color:#E1E4E8\">() (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Config</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Config</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        DatabaseURL: os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DATABASE_URL\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        JWTSecret:   os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"JWT_SECRET\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Port:        </span><span style=\"color:#B392F0\">envOrDefault</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"PORT\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"8080\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ServiceName: </span><span style=\"color:#9ECBFF\">\"user-service\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        BCryptCost:  </span><span style=\"color:#79B8FF\">12</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        TokenTTL:    </span><span style=\"color:#79B8FF\">24</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Hour,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cfg.DatabaseURL </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DATABASE_URL is required\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cfg.JWTSecret </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"JWT_SECRET is required\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cost </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"BCRYPT_COST\"</span><span style=\"color:#E1E4E8\">); cost </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        n, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> strconv.</span><span style=\"color:#B392F0\">Atoi</span><span style=\"color:#E1E4E8\">(cost)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> n </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 10</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> n </span><span style=\"color:#F97583\">></span><span style=\"color:#79B8FF\"> 14</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"BCRYPT_COST must be integer in [10,14], got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, cost)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        cfg.BCryptCost </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> n</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> ttlHours </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"TOKEN_TTL_HOURS\"</span><span style=\"color:#E1E4E8\">); ttlHours </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        h, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> strconv.</span><span style=\"color:#B392F0\">Atoi</span><span style=\"color:#E1E4E8\">(ttlHours)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> h </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"TOKEN_TTL_HOURS must be positive integer, got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, ttlHours)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        cfg.TokenTTL </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">(h) </span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\"> time.Hour</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> cfg, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> envOrDefault</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">key</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">def</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> v </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(key); v </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> v</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> def</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"34-http-requestresponse-schemas\">3.4 HTTP Request/Response Schemas</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/user-service/handler.go — request/response types</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> registerRequest</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Email    </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"email\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Password </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"password\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> registerResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"user_id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Email  </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"email\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> loginRequest</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Email    </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"email\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Password </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"password\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> loginResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Token     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"token\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"expires_at\"`</span><span style=\"color:#6A737D\"> // RFC3339 format: \"2026-03-03T12:00:00Z\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> meResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"user_id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Email  </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"email\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> errorResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Error </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"error\"`</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Field is present only for 400 validation errors, identifying which input field failed.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Field </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"field,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"35-sentinel-errors-errorsgo\">3.5 Sentinel Errors (<code>errors.go</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/user-service/errors.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> userservice</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">errors</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ErrDuplicateEmail is returned by UserRepository.Insert when the email</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // already exists. Mapped to 409 Conflict in the handler.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrDuplicateEmail </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"email already registered\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ErrUserNotFound is returned by UserRepository.FindByEmail when no row matches.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // MUST NOT be surfaced directly to HTTP clients (email enumeration).</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrUserNotFound </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"user not found\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ErrPasswordMismatch is returned by PasswordHasher.Verify on wrong password.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // MUST NOT be surfaced directly to HTTP clients (same 401 as ErrUserNotFound).</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrPasswordMismatch </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"password mismatch\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ErrTokenInvalid is returned by TokenIssuer.Verify for any invalid token:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // expired, wrong signature, malformed. Maps to 401 Unauthorized.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrTokenInvalid </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"token invalid or expired\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-7.svg\" alt=\"User Service Module Architecture\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Data flow and ownership:\nHTTP Client\n    │\n    ▼\nuser-service (port 8083)\n    │\n    ├─ POST /register ──► validateEmail + validatePassword\n    │                       │\n    │                       ▼\n    │                   PasswordHasher.Hash(password) ──► bcrypt hash (60 chars)\n    │                       │\n    │                       ▼\n    │                   UserRepository.Insert(email, hash)\n    │                       │\n    │                       ▼\n    │                   user_db.users table\n    │                       │\n    │                       ▼\n    │                   201 {user_id, email}  ← PasswordHash NEVER included\n    │\n    ├─ POST /login ───► UserRepository.FindByEmail(email)\n    │                       │                      │\n    │                   found                   not found\n    │                       │                      │\n    │                       ▼                      ▼\n    │                   PasswordHasher.Verify   401 (generic)\n    │                       │          │\n    │                    match      mismatch\n    │                       │          │\n    │                       ▼          ▼\n    │                   TokenIssuer  401 (generic, same message as not-found)\n    │                   .Issue(id, email)\n    │                       │\n    │                       ▼\n    │                   200 {token, expires_at}\n    │\n    └─ GET /me ───────► JWTMiddleware (local HMAC verify, no DB)\n                            │                │\n                         valid            invalid/expired\n                            │                │\n                            ▼                ▼\n                        200 {user_id,     401\n                             email}\nshared/auth package:\n  TokenIssuer interface ──── implemented by ──── jwtTokenIssuer (user-service/token.go)\n  JWTMiddleware func ──────── imported by ──────── all other services (M3, M4, M5)\n  VerifyToken func ───────── imported by ──────── all other services\nuser_db (exclusive):\n  users table ── owned by user-service ONLY ── no other service reads this table</code></pre></div>\n\n<hr>\n<h2 id=\"4-interface-contracts\">4. Interface Contracts</h2>\n<h3 id=\"41-userrepository-pgxuserstore-implementation\">4.1 <code>UserRepository</code> — <code>pgxUserStore</code> Implementation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// store.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> pgxUserStore</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewUserStore</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">pool</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">UserRepository</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">pgxUserStore</span><span style=\"color:#E1E4E8\">{pool: pool}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>Insert(ctx context.Context, email, passwordHash string) (*User, error)</code></strong></p>\n<ul>\n<li>Executes: <code>INSERT INTO users (email, password_hash) VALUES ($1, $2) RETURNING id, email, created_at</code></li>\n<li><code>email</code> must not be empty (caller validates before Insert call; store does not re-validate)</li>\n<li><code>passwordHash</code> must not be empty (caller always hashes before calling Insert)</li>\n<li>On success: returns <code>*User</code> with <code>ID</code>, <code>Email</code>, <code>CreatedAt</code> populated; <code>PasswordHash</code> is <strong>not</strong> populated in the returned struct (read-once; no need to round-trip)</li>\n<li>On PostgreSQL error code <code>23505</code> (unique_violation): return <code>nil, ErrDuplicateEmail</code></li>\n<li>On any other DB error: return <code>nil, fmt.Errorf(&quot;insert user: %w&quot;, err)</code> — do NOT return <code>ErrDuplicateEmail</code> for other errors</li>\n<li>Detecting pg error code:</li>\n</ul>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">github.com/jackc/pgx/v5/pgconn</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> isPgUniqueViolation</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> pgErr </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgconn</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">PgError</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">As</span><span style=\"color:#E1E4E8\">(err, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">pgErr) </span><span style=\"color:#F97583\">&#x26;&#x26;</span><span style=\"color:#E1E4E8\"> pgErr.Code </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"23505\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>FindByEmail(ctx context.Context, email string) (*User, error)</code></strong></p>\n<ul>\n<li>Executes: <code>SELECT id, email, password_hash, created_at FROM users WHERE email = $1</code></li>\n<li>On no rows: return <code>nil, ErrUserNotFound</code></li>\n<li>On success: return <code>*User</code> with all four fields populated (including <code>PasswordHash</code> — needed for bcrypt comparison)</li>\n<li>On any other DB error: return <code>nil, fmt.Errorf(&quot;find user by email: %w&quot;, err)</code></li>\n<li>Uses <code>pool.QueryRow</code> + <code>pgx.ErrNoRows</code> detection:</li>\n</ul>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">github.com/jackc/pgx/v5</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">row </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> s.pool.</span><span style=\"color:#B392F0\">QueryRow</span><span style=\"color:#E1E4E8\">(ctx, </span><span style=\"color:#9ECBFF\">`SELECT id, email, password_hash, created_at FROM users WHERE email = $1`</span><span style=\"color:#E1E4E8\">, email)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> u </span><span style=\"color:#B392F0\">User</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> row.</span><span style=\"color:#B392F0\">Scan</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">u.ID, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">u.Email, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">u.PasswordHash, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">u.CreatedAt)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">if</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">Is</span><span style=\"color:#E1E4E8\">(err, pgx.ErrNoRows) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, ErrUserNotFound</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"find user by email: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#E1E4E8\">u, </span><span style=\"color:#79B8FF\">nil</span></span></code></pre></div>\n\n<h3 id=\"42-passwordhasher-bcrypthasher-implementation\">4.2 <code>PasswordHasher</code> — <code>bcryptHasher</code> Implementation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// password.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> bcryptHasher</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cost </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewPasswordHasher</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">cost</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">PasswordHasher</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">bcryptHasher</span><span style=\"color:#E1E4E8\">{cost: cost}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>Hash(plaintext string) (string, error)</code></strong></p>\n<ul>\n<li>Calls <code>bcrypt.GenerateFromPassword([]byte(plaintext), h.cost)</code></li>\n<li>Returns the hash as a string (bcrypt output is always valid UTF-8, 60 chars, starts with <code>$2a$</code>)</li>\n<li>Returns <code>(&quot;&quot;, fmt.Errorf(&quot;hash password: %w&quot;, err))</code> on failure (extremely rare — only on system entropy failure)</li>\n<li>Does <strong>not</strong> validate password length or format — that is the validator&#39;s responsibility</li>\n<li>The returned hash string is what gets stored in <code>password_hash</code> column\n<strong><code>Verify(plaintext, hash string) error</code></strong></li>\n<li>Calls <code>bcrypt.CompareHashAndPassword([]byte(hash), []byte(plaintext))</code></li>\n<li>Returns <code>nil</code> on match</li>\n<li>Returns <code>ErrPasswordMismatch</code> on <code>bcrypt.ErrMismatchedHashAndPassword</code></li>\n<li>Returns <code>fmt.Errorf(&quot;verify password: %w&quot;, err)</code> on any other error (malformed hash — should not occur in production)</li>\n<li><strong>Timing note:</strong> <code>bcrypt.CompareHashAndPassword</code> is inherently slow (that is the security property). Do not add artificial delays. Do not short-circuit before calling bcrypt even when the user is not found — see Login handler algorithm in §5.2 for the dummy-hash strategy.</li>\n</ul>\n<h3 id=\"43-tokenissuer-jwttokenissuer-implementation\">4.3 <code>TokenIssuer</code> — <code>jwtTokenIssuer</code> Implementation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// token.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> jwtTokenIssuer</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    secret []</span><span style=\"color:#F97583\">byte</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ttl    </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewTokenIssuer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">secret</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">ttl</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">TokenIssuer</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">jwtTokenIssuer</span><span style=\"color:#E1E4E8\">{secret: []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(secret), ttl: ttl}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>Issue(userID, email string) (string, time.Time, error)</code></strong></p>\n<ul>\n<li>Algorithm: see §5.3</li>\n<li>Returns <code>(&quot;&quot;, time.Time{}, fmt.Errorf(&quot;sign token: %w&quot;, err))</code> on HMAC failure\n<strong><code>Verify(tokenString string) (*Claims, error)</code></strong></li>\n<li>Algorithm: see §5.4</li>\n<li>Returns <code>(nil, ErrTokenInvalid)</code> for <strong>all</strong> failure modes (expired, wrong signature, malformed, wrong issuer)</li>\n<li>Must not return different errors for different failure reasons — all map to 401 with no hint</li>\n</ul>\n<h3 id=\"44-sharedauth-jwtmiddleware\">4.4 <code>shared/auth</code> — <code>JWTMiddleware</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// shared/auth/middleware.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// JWTMiddleware returns an http.Handler middleware that:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   1. Reads the Authorization header</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   2. Strips the \"Bearer \" prefix</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   3. Verifies the token using the provided secret</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   4. On success: injects Claims into request context using claimsKey</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   5. On failure: writes 401 JSON and does NOT call next</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Parameters:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   secret  - the HS256 signing secret (must match JWT_SECRET env var)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   next    - the downstream handler to call on success</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns: http.Handler</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> JWTMiddleware</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">secret</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ClaimsFromContext extracts Claims injected by JWTMiddleware.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns (nil, false) if the context has no claims (middleware not applied or failed).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> ClaimsFromContext</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Claims</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// claimsKey is the unexported context key type — prevents collisions with other packages.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> claimsKey</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\">{}</span></span></code></pre></div>\n\n<p><strong>Authorization header parsing:</strong></p>\n<ul>\n<li>Must be exactly <code>Authorization: Bearer &lt;token&gt;</code> (case-sensitive header name, case-sensitive scheme)</li>\n<li>Header absent → 401 <code>{&quot;error&quot;: &quot;authorization header required&quot;}</code></li>\n<li>Header present but not starting with <code>&quot;Bearer &quot;</code> (with space) → 401 <code>{&quot;error&quot;: &quot;invalid authorization header format&quot;}</code></li>\n<li>Token string empty after stripping prefix → 401 <code>{&quot;error&quot;: &quot;token is required&quot;}</code></li>\n</ul>\n<h3 id=\"45-sharedauth-verifytoken-standalone-function\">4.5 <code>shared/auth</code> — <code>VerifyToken</code> Standalone Function</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// shared/auth/auth.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// VerifyToken parses and verifies a JWT token string using the given secret.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Used by services that verify tokens outside of HTTP middleware (e.g., in RabbitMQ consumers).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Parameters:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   tokenString - raw JWT string (no \"Bearer \" prefix)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   secret      - HS256 signing key bytes</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   *Claims - populated on success</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   error   - ErrTokenInvalid on any failure (expired, wrong sig, malformed)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> VerifyToken</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">tokenString</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">secret</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Claims</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n\n<h3 id=\"46-validation-functions-validatego\">4.6 Validation Functions (<code>validate.go</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/user-service/validate.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// validateEmail returns an error if email does not match a minimal valid format.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Uses regexp: ^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Does NOT do DNS MX lookup — format check only.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns nil on valid, non-nil with field=\"email\" on invalid.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> validateEmail</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">email</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// validatePassword returns an error if password is shorter than 8 characters.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// No other complexity rules (no uppercase/symbol requirements per spec).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns nil on valid, non-nil with field=\"password\" on invalid.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> validatePassword</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">password</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span></code></pre></div>\n\n<hr>\n<h2 id=\"5-algorithm-specification\">5. Algorithm Specification</h2>\n<h3 id=\"51-post-register-handler\">5.1 <code>POST /register</code> Handler</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Input:  JSON body { email: string, password: string }\nOutput: 201 { user_id, email } | 400 | 409 | 500\nStep 1: Decode JSON body\n  - json.NewDecoder(r.Body).Decode(&amp;req)\n  - On error (malformed JSON, wrong types): writeError(w, 400, &quot;invalid request body&quot;, &quot;&quot;)\n  - Limit body to 1MB: r.Body = http.MaxBytesReader(w, r.Body, 1&lt;&lt;20)\nStep 2: Validate inputs\n  - if err := validateEmail(req.Email); err != nil:\n      writeError(w, 400, &quot;invalid email format&quot;, &quot;email&quot;)\n      return\n  - if err := validatePassword(req.Password); err != nil:\n      writeError(w, 400, &quot;password must be at least 8 characters&quot;, &quot;password&quot;)\n      return\nStep 3: Hash password\n  - hash, err := h.hasher.Hash(req.Password)\n  - On error: log.Error(&quot;bcrypt hash failed&quot;, &quot;error&quot;, err)\n              writeError(w, 500, &quot;internal server error&quot;, &quot;&quot;)\n              return\nStep 4: Insert user\n  - user, err := h.store.Insert(r.Context(), req.Email, hash)\n  - if errors.Is(err, ErrDuplicateEmail):\n      writeError(w, 409, &quot;email already registered&quot;, &quot;&quot;)\n      return\n  - On other error: log.Error(&quot;insert user failed&quot;, &quot;error&quot;, err)\n                    writeError(w, 500, &quot;internal server error&quot;, &quot;&quot;)\n                    return\nStep 5: Write response\n  - w.Header().Set(&quot;Content-Type&quot;, &quot;application/json&quot;)\n  - w.WriteHeader(201)\n  - json.NewEncoder(w).Encode(registerResponse{UserID: user.ID, Email: user.Email})\nInvariants after execution:\n  - user.PasswordHash never appears in the HTTP response\n  - On 409: no new row was inserted (constraint violated → rolled back by Postgres)\n  - On 500: caller may retry; handler is idempotent per email (duplicate → 409)</code></pre></div>\n\n<h3 id=\"52-post-login-handler-timing-safe-design\">5.2 <code>POST /login</code> Handler — Timing-Safe Design</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Input:  JSON body { email: string, password: string }\nOutput: 200 { token, expires_at } | 401\nStep 1: Decode JSON body (same as /register step 1)\nStep 2: Attempt to find user\n  - user, findErr := h.store.FindByEmail(r.Context(), req.Email)\n  - Do NOT return 401 here yet — must always call bcrypt compare (see Step 3)\nStep 3: Constant-time password comparison\n  - if errors.Is(findErr, ErrUserNotFound):\n      // Dummy compare: prevents timing difference that reveals email existence.\n      // bcrypt.CompareHashAndPassword with dummyHash takes same wall time as real compare.\n      dummyHash := &quot;$2a$12$invalidhashfortimingsafetyonlyxx&quot;\n      h.hasher.Verify(req.Password, dummyHash)  // result intentionally discarded\n      writeError(w, 401, &quot;invalid credentials&quot;, &quot;&quot;)\n      return\n  - if findErr != nil:\n      log.Error(&quot;find user failed&quot;, &quot;error&quot;, findErr)\n      writeError(w, 500, &quot;internal server error&quot;, &quot;&quot;)\n      return\n  // User found:\n  - if err := h.hasher.Verify(req.Password, user.PasswordHash); err != nil:\n      // errors.Is(err, ErrPasswordMismatch) OR unexpected error: both → 401\n      writeError(w, 401, &quot;invalid credentials&quot;, &quot;&quot;)\n      return\nStep 4: Issue token\n  - tokenString, expiresAt, err := h.issuer.Issue(user.ID, user.Email)\n  - On error: log.Error(&quot;token issue failed&quot;, &quot;error&quot;, err)\n              writeError(w, 500, &quot;internal server error&quot;, &quot;&quot;)\n              return\nStep 5: Write response\n  - w.Header().Set(&quot;Content-Type&quot;, &quot;application/json&quot;)\n  - w.WriteHeader(200)\n  - json.NewEncoder(w).Encode(loginResponse{\n        Token:     tokenString,\n        ExpiresAt: expiresAt.Format(time.RFC3339),\n    })\nSECURITY NOTE on dummy hash:\n  The dummyHash literal must NOT be a valid bcrypt hash that could match any password.\n  Use a string that starts with &quot;$2a$12$&quot; (correct prefix) but has an invalid/impossible\n  body so bcrypt parse succeeds (cost extraction works) but comparison always fails.\n  Example: &quot;$2a$12$0000000000000000000000uZLbwxnpY0o6Fh.za8VOf/OjIPFGXGhG&quot;\n  (31 chars of deterministic non-random salt+hash data — bcrypt will always return mismatch)\n  This ensures the timing profile is identical to a real failed compare.</code></pre></div>\n\n<h3 id=\"53-tokenissuerissue-algorithm\">5.3 <code>TokenIssuer.Issue</code> Algorithm</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Input:  userID string (UUID), email string\nOutput: tokenString string, expiresAt time.Time, error\nStep 1: Build Claims\n  now := time.Now().UTC()\n  claims := Claims{\n      Sub:   userID,\n      Email: email,\n      Iss:   &quot;url-shortener&quot;,\n      Iat:   now.Unix(),\n      Exp:   now.Add(i.ttl).Unix(),\n  }\nStep 2: Create JWT token using golang-jwt/jwt\n  // Use map claims to avoid importing jwt in shared/auth — embed in jwtTokenIssuer\n  token := jwt.NewWithClaims(jwt.SigningMethodHS256, jwt.MapClaims{\n      &quot;sub&quot;:   claims.Sub,\n      &quot;email&quot;: claims.Email,\n      &quot;iss&quot;:   claims.Iss,\n      &quot;iat&quot;:   claims.Iat,\n      &quot;exp&quot;:   claims.Exp,\n  })\nStep 3: Sign\n  signed, err := token.SignedString(i.secret)\n  if err != nil:\n      return &quot;&quot;, time.Time{}, fmt.Errorf(&quot;sign token: %w&quot;, err)\nStep 4: Return\n  expiresAt := time.Unix(claims.Exp, 0).UTC()\n  return signed, expiresAt, nil\nToken format (HS256, compact serialization):\n  &lt;base64url(header)&gt;.&lt;base64url(payload)&gt;.&lt;base64url(signature)&gt;\n  Header: {&quot;alg&quot;:&quot;HS256&quot;,&quot;typ&quot;:&quot;JWT&quot;}\n  Payload: {&quot;sub&quot;:&quot;&lt;uuid&gt;&quot;,&quot;email&quot;:&quot;...&quot;,&quot;iss&quot;:&quot;url-shortener&quot;,&quot;iat&quot;:&lt;unix&gt;,&quot;exp&quot;:&lt;unix&gt;}\n  Signature: HMAC-SHA256(base64url(header) + &quot;.&quot; + base64url(payload), secret)</code></pre></div>\n\n<h3 id=\"54-tokenissuerverify-sharedauthverifytoken-algorithm\">5.4 <code>TokenIssuer.Verify</code> / <code>shared/auth.VerifyToken</code> Algorithm</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Input:  tokenString string, secret []byte\nOutput: *Claims, error\nStep 1: Parse token with golang-jwt/jwt\n  token, err := jwt.Parse(tokenString, func(token *jwt.Token) (interface{}, error) {\n      // Verify algorithm is HS256 — MANDATORY check\n      if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok {\n          return nil, fmt.Errorf(&quot;unexpected signing method: %v&quot;, token.Header[&quot;alg&quot;])\n      }\n      return secret, nil\n  })\nStep 2: Handle parse error\n  if err != nil:\n      return nil, ErrTokenInvalid\n      // NOTE: do not wrap err — all failures are opaque ErrTokenInvalid to callers\nStep 3: Check token.Valid\n  if !token.Valid:\n      return nil, ErrTokenInvalid\nStep 4: Extract MapClaims\n  mapClaims, ok := token.Claims.(jwt.MapClaims)\n  if !ok:\n      return nil, ErrTokenInvalid\nStep 5: Build Claims struct\n  claims := &amp;Claims{}\n  claims.Sub   = mapClaims[&quot;sub&quot;].(string)   // type assert; on panic → see Step 5a\n  claims.Email = mapClaims[&quot;email&quot;].(string)\n  claims.Iss   = mapClaims[&quot;iss&quot;].(string)\n  // iat and exp are float64 in JSON-decoded maps\n  if iat, ok := mapClaims[&quot;iat&quot;].(float64); ok:\n      claims.Iat = int64(iat)\n  if exp, ok := mapClaims[&quot;exp&quot;].(float64); ok:\n      claims.Exp = int64(exp)\nStep 5a: Safe extraction to avoid panic\n  Use a helper that returns (string, bool) and check ok before asserting:\n  func extractString(m jwt.MapClaims, key string) (string, bool) {\n      v, exists := m[key]\n      if !exists { return &quot;&quot;, false }\n      s, ok := v.(string)\n      return s, ok\n  }\n  If any required claim is absent or wrong type: return nil, ErrTokenInvalid\nStep 6: Verify issuer\n  if claims.Iss != &quot;url-shortener&quot;:\n      return nil, ErrTokenInvalid\nStep 7: Return\n  return claims, nil\nNOTE: golang-jwt/jwt automatically validates exp (token expired) during Parse\n      when the jwt.Parser's ValidateExpiry option is enabled (default true).\n      No manual time comparison is needed in this function.</code></pre></div>\n\n<h3 id=\"55-get-me-handler\">5.5 <code>GET /me</code> Handler</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Input:  Authorization: Bearer &lt;jwt&gt; in request header\n        (Claims already in context, injected by JWTMiddleware)\nOutput: 200 { user_id, email } | 401\nStep 1: Extract claims from context\n  claims, ok := auth.ClaimsFromContext(r.Context())\n  if !ok:\n      // Should not happen if middleware is correctly applied, but guard anyway\n      writeError(w, 401, &quot;unauthorized&quot;, &quot;&quot;)\n      return\nStep 2: Write response (no DB lookup)\n  w.Header().Set(&quot;Content-Type&quot;, &quot;application/json&quot;)\n  w.WriteHeader(200)\n  json.NewEncoder(w).Encode(meResponse{\n      UserID: claims.Sub,\n      Email:  claims.Email,\n  })</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-8.svg\" alt=\"POST /register Data Flow\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>POST /login timing-safe flow:\nFindByEmail(email)\n       │\n  ┌────┴────────────────────────────────────────────────┐\n  │ User NOT found                  User found           │\n  │       │                              │               │\n  │       ▼                              ▼               │\n  │  Verify(password,           Verify(password,         │\n  │  dummyHash)                 user.PasswordHash)       │\n  │  [always fails,             [bcrypt.CompareHash...]  │\n  │   takes ~same time]              │           │       │\n  │       │                       match       mismatch   │\n  │       ▼                          │              │    │\n  │  401 generic              Issue(id, email)   401 generic\n  │                                  │\n  │                           200 {token, expires_at}\n  └────────────────────────────────────────────────────┘\nCRITICAL: Both 401 paths go through bcrypt.CompareHashAndPassword.\n          Network latency variation masks the residual timing difference\n          between a valid bcrypt hash and the dummy hash structure,\n          but using the same cost prefix minimizes it further.</code></pre></div>\n\n<h3 id=\"56-schema-migration-on-service-startup\">5.6 Schema Migration on Service Startup</h3>\n<p>The user-service does not use a migration tool in M2. Migration is applied via a startup SQL exec:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// main.go — after NewDBPool succeeds</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> schema</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> `</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE TABLE IF NOT EXISTS users (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    id            UUID        PRIMARY KEY DEFAULT gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    email         TEXT        UNIQUE NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    password_hash TEXT        NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    created_at    TIMESTAMPTZ NOT NULL DEFAULT now()</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">);</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE UNIQUE INDEX IF NOT EXISTS idx_users_email ON users(email);</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">`</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> runMigrations</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">pool</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> pool.</span><span style=\"color:#B392F0\">Exec</span><span style=\"color:#E1E4E8\">(ctx, schema)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"run migrations: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"migrations applied\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h2 id=\"called-in-main-after-newdbpool-before-starting-the-http-server-fatal-on-error\">Called in <code>main()</code> after <code>NewDBPool</code>, before starting the HTTP server. Fatal on error</h2>\n<h2 id=\"6-error-handling-matrix\">6. Error Handling Matrix</h2>\n<table>\n<thead>\n<tr>\n<th>Error Scenario</th>\n<th>Detected By</th>\n<th>HTTP Status</th>\n<th>Response Body</th>\n<th>Log Level</th>\n<th>Log Fields</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Missing <code>DATABASE_URL</code></td>\n<td><code>loadConfig()</code></td>\n<td>— (pre-HTTP)</td>\n<td>stderr message</td>\n<td><code>Error</code> (fmt.Fprintf)</td>\n<td>env var name</td>\n</tr>\n<tr>\n<td>Missing <code>JWT_SECRET</code></td>\n<td><code>loadConfig()</code></td>\n<td>— (pre-HTTP)</td>\n<td>stderr message</td>\n<td><code>Error</code> (fmt.Fprintf)</td>\n<td>env var name</td>\n</tr>\n<tr>\n<td>DB unreachable at startup</td>\n<td><code>NewDBPool</code> → <code>pool.Ping</code></td>\n<td>— (pre-HTTP)</td>\n<td>—</td>\n<td><code>Error</code> + <code>os.Exit(1)</code></td>\n<td>masked DSN</td>\n</tr>\n<tr>\n<td>Migration SQL fails</td>\n<td><code>runMigrations</code></td>\n<td>— (pre-HTTP)</td>\n<td>—</td>\n<td><code>Error</code> + <code>os.Exit(1)</code></td>\n<td>error string</td>\n</tr>\n<tr>\n<td>Malformed JSON request body</td>\n<td><code>json.Decode</code> in handler</td>\n<td>400</td>\n<td><code>{&quot;error&quot;:&quot;invalid request body&quot;}</code></td>\n<td><code>Warn</code></td>\n<td>path, body size</td>\n</tr>\n<tr>\n<td>Invalid email format</td>\n<td><code>validateEmail</code></td>\n<td>400</td>\n<td><code>{&quot;error&quot;:&quot;invalid email format&quot;,&quot;field&quot;:&quot;email&quot;}</code></td>\n<td>none</td>\n<td>—</td>\n</tr>\n<tr>\n<td>Password &lt; 8 chars</td>\n<td><code>validatePassword</code></td>\n<td>400</td>\n<td><code>{&quot;error&quot;:&quot;password must be at least 8 characters&quot;,&quot;field&quot;:&quot;password&quot;}</code></td>\n<td>none</td>\n<td>—</td>\n</tr>\n<tr>\n<td>Duplicate email on register</td>\n<td><code>isPgUniqueViolation</code> in store</td>\n<td>409</td>\n<td><code>{&quot;error&quot;:&quot;email already registered&quot;}</code></td>\n<td><code>Info</code></td>\n<td>email (safe to log)</td>\n</tr>\n<tr>\n<td>DB error on Insert</td>\n<td><code>store.Insert</code> non-unique error</td>\n<td>500</td>\n<td><code>{&quot;error&quot;:&quot;internal server error&quot;}</code></td>\n<td><code>Error</code></td>\n<td>error string</td>\n</tr>\n<tr>\n<td>User not found on login</td>\n<td><code>store.FindByEmail</code> → <code>ErrUserNotFound</code></td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;invalid credentials&quot;}</code></td>\n<td>none (timing-safe: log would reveal)</td>\n<td>—</td>\n</tr>\n<tr>\n<td>Wrong password on login</td>\n<td><code>hasher.Verify</code> → <code>ErrPasswordMismatch</code></td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;invalid credentials&quot;}</code></td>\n<td>none</td>\n<td>—</td>\n</tr>\n<tr>\n<td>DB error on FindByEmail</td>\n<td><code>store.FindByEmail</code> non-ErrUserNotFound</td>\n<td>500</td>\n<td><code>{&quot;error&quot;:&quot;internal server error&quot;}</code></td>\n<td><code>Error</code></td>\n<td>error string</td>\n</tr>\n<tr>\n<td>bcrypt hash failure (Hash)</td>\n<td><code>bcrypt.GenerateFromPassword</code></td>\n<td>500</td>\n<td><code>{&quot;error&quot;:&quot;internal server error&quot;}</code></td>\n<td><code>Error</code></td>\n<td>error string</td>\n</tr>\n<tr>\n<td>bcrypt unexpected verify error</td>\n<td><code>bcrypt.CompareHashAndPassword</code> non-mismatch</td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;invalid credentials&quot;}</code></td>\n<td><code>Error</code></td>\n<td>error (malformed stored hash — serious)</td>\n</tr>\n<tr>\n<td>Token sign failure</td>\n<td><code>token.SignedString</code></td>\n<td>500</td>\n<td><code>{&quot;error&quot;:&quot;internal server error&quot;}</code></td>\n<td><code>Error</code></td>\n<td>error string</td>\n</tr>\n<tr>\n<td>Missing Authorization header</td>\n<td><code>JWTMiddleware</code></td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;authorization header required&quot;}</code></td>\n<td>none</td>\n<td>—</td>\n</tr>\n<tr>\n<td>Malformed Authorization header</td>\n<td><code>JWTMiddleware</code></td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;invalid authorization header format&quot;}</code></td>\n<td>none</td>\n<td>—</td>\n</tr>\n<tr>\n<td>JWT signature invalid</td>\n<td><code>jwt.Parse</code> error</td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;unauthorized&quot;}</code></td>\n<td>none</td>\n<td>—</td>\n</tr>\n<tr>\n<td>JWT expired</td>\n<td><code>jwt.Parse</code> exp validation</td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;unauthorized&quot;}</code></td>\n<td>none</td>\n<td>—</td>\n</tr>\n<tr>\n<td>JWT wrong issuer</td>\n<td>claims.Iss check</td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;unauthorized&quot;}</code></td>\n<td>none</td>\n<td>—</td>\n</tr>\n<tr>\n<td><code>GET /me</code> missing claims in context</td>\n<td><code>ClaimsFromContext</code></td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;unauthorized&quot;}</code></td>\n<td><code>Warn</code></td>\n<td>path</td>\n</tr>\n</tbody></table>\n<p><strong><code>writeError</code> helper:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/user-service/errors.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> writeError</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">status</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">message</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">field</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(status)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    resp </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> errorResponse</span><span style=\"color:#E1E4E8\">{Error: message, Field: field}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">NewEncoder</span><span style=\"color:#E1E4E8\">(w).</span><span style=\"color:#B392F0\">Encode</span><span style=\"color:#E1E4E8\">(resp) </span><span style=\"color:#6A737D\">// encode error intentionally ignored</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h2 id=\"security-note-401-responses-for-login-always-use-the-message-quotinvalid-credentialsquot-regardless-of-whether-the-email-was-not-found-or-the-password-was-wrong-the-log-lines-for-these-two-paths-are-also-identical-neither-logs-this-prevents-log-based-email-enumeration\"><strong>Security note:</strong> 401 responses for login always use the message <code>&quot;invalid credentials&quot;</code> regardless of whether the email was not found or the password was wrong. The log lines for these two paths are also identical (neither logs). This prevents log-based email enumeration</h2>\n<h2 id=\"7-threat-model\">7. Threat Model</h2>\n<table>\n<thead>\n<tr>\n<th>Attack</th>\n<th>Surface</th>\n<th>Mitigation</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Password disclosure</td>\n<td>HTTP response</td>\n<td><code>password_hash</code> field never serialized in any response type</td>\n</tr>\n<tr>\n<td>Password disclosure</td>\n<td>Logs</td>\n<td><code>req.Password</code> and <code>user.PasswordHash</code> never passed to any logger</td>\n</tr>\n<tr>\n<td>Email enumeration via login timing</td>\n<td>POST /login</td>\n<td>Dummy bcrypt compare on unknown email; same response body and status for both paths</td>\n</tr>\n<tr>\n<td>Email enumeration via login response</td>\n<td>POST /login</td>\n<td>Identical 401 body <code>{&quot;error&quot;:&quot;invalid credentials&quot;}</code> for both cases</td>\n</tr>\n<tr>\n<td>Email enumeration via register</td>\n<td>POST /register</td>\n<td>409 on duplicate does reveal email existence — this is documented and acceptable per spec (user is self-registering)</td>\n</tr>\n<tr>\n<td>JWT algorithm confusion</td>\n<td><code>jwt.Parse</code> key func</td>\n<td><code>if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok { return nil, err }</code> — rejects RS256/none</td>\n</tr>\n<tr>\n<td>JWT <code>none</code> algorithm attack</td>\n<td><code>jwt.Parse</code> key func</td>\n<td>Same check above rejects <code>jwt.SigningMethodNone</code></td>\n</tr>\n<tr>\n<td>JWT secret brute force</td>\n<td>JWT_SECRET env</td>\n<td>Secret must be ≥ 32 bytes (loaded from env; weak secrets are an ops problem, not caught in code)</td>\n</tr>\n<tr>\n<td>Integer user_id enumeration</td>\n<td>JWT <code>sub</code> claim</td>\n<td>UUID v4, not sequential integer</td>\n</tr>\n<tr>\n<td>Hardcoded JWT_SECRET</td>\n<td>Config</td>\n<td><code>loadConfig</code> enforces <code>os.Getenv(&quot;JWT_SECRET&quot;)</code> — fatal if empty; no default value</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"8-concurrency-specification\">8. Concurrency Specification</h2>\n<p>The User Service is stateless at the handler level. <code>net/http</code>&#39;s default server dispatches each request in its own goroutine. The shared state components are:</p>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Thread Safety</th>\n<th>Rationale</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>pgxpool.Pool</code></td>\n<td>✅ Safe</td>\n<td>pgxpool is goroutine-safe; connection acquisition uses internal mutex</td>\n</tr>\n<tr>\n<td><code>bcryptHasher</code></td>\n<td>✅ Safe</td>\n<td>No mutable state; <code>bcrypt.GenerateFromPassword</code> and <code>CompareHashAndPassword</code> are pure functions</td>\n</tr>\n<tr>\n<td><code>jwtTokenIssuer</code></td>\n<td>✅ Safe</td>\n<td><code>secret []byte</code> is read-only after construction; <code>golang-jwt/jwt</code> operations are pure</td>\n</tr>\n<tr>\n<td><code>pgxUserStore</code></td>\n<td>✅ Safe</td>\n<td>Only holds <code>*pgxpool.Pool</code> which is safe</td>\n</tr>\n<tr>\n<td><code>Handler</code> struct</td>\n<td>✅ Safe</td>\n<td>All fields set at construction; no mutation after <code>main()</code> wires dependencies</td>\n</tr>\n<tr>\n<td>No mutexes are required in this module. The <code>JWTMiddleware</code> uses <code>context.WithValue</code> which is goroutine-safe. The pre-encoded health response byte slice in <code>NewHealthHandler</code> is read-only after construction.</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td><strong>bcrypt CPU saturation:</strong> At cost 12, each <code>bcrypt.GenerateFromPassword</code> call takes ~200–400ms of CPU. Under concurrent load (N simultaneous logins), N goroutines will each consume one CPU for ~300ms. <code>net/http</code>&#39;s goroutine-per-request model means the OS scheduler handles this automatically; no explicit worker pool is needed at this traffic level. If load becomes a concern in future milestones, a semaphore can limit concurrent bcrypt operations — not required for M2.</td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"9-implementation-sequence-with-checkpoints\">9. Implementation Sequence with Checkpoints</h2>\n<h3 id=\"phase-1-sharedauth-package-users-table-migration-115h\">Phase 1: <code>shared/auth</code> Package + <code>users</code> Table Migration (1–1.5h)</h3>\n<ol>\n<li>Create <code>shared/auth/go.mod</code>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>module github.com/yourhandle/url-shortener/shared/auth\ngo 1.23\nrequire github.com/golang-jwt/jwt/v5 v5.2.1</code></pre></div>\n\n<ol>\n<li>Write <code>shared/auth/auth.go</code>: <code>Claims</code> struct, <code>IsExpired()</code>, <code>ExpiresAt()</code>, <code>TokenIssuer</code> interface, <code>VerifyToken</code> function, <code>ErrTokenInvalid</code> sentinel.</li>\n<li>Write <code>shared/auth/middleware.go</code>: <code>JWTMiddleware</code>, <code>ClaimsFromContext</code>, <code>claimsKey</code> type.</li>\n<li>Add <code>shared/auth</code> to <code>go.work</code>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>use (\n    ...\n    ./shared/auth\n)</code></pre></div>\n\n<ol>\n<li>Write <code>services/user-service/migration.sql</code> as specified in §3.1.</li>\n<li>Update <code>services/user-service/go.mod</code>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>require (\n    github.com/yourhandle/url-shortener/shared/auth v0.0.0\n    github.com/yourhandle/url-shortener/shared/logger v0.0.0\n    github.com/jackc/pgx/v5 v5.6.0\n    golang.org/x/crypto v0.23.0   // for bcrypt\n    github.com/golang-jwt/jwt/v5 v5.2.1\n)\nreplace (\n    github.com/yourhandle/url-shortener/shared/auth =&gt; ../../shared/auth\n    github.com/yourhandle/url-shortener/shared/logger =&gt; ../../shared/logger\n)</code></pre></div>\n\n<ol>\n<li>Run <code>go work sync</code> at monorepo root.\n<strong>Checkpoint:</strong> <code>go build github.com/yourhandle/url-shortener/shared/auth</code> exits 0. Write a throwaway test that calls <code>VerifyToken(&quot;bad-token&quot;, &quot;secret&quot;)</code> and asserts it returns <code>ErrTokenInvalid</code>. Run: <code>go test ./shared/auth/...</code> → PASS.</li>\n</ol>\n<h3 id=\"phase-2-storego-passwordgo-tokengo-errorsgo-115h\">Phase 2: <code>store.go</code>, <code>password.go</code>, <code>token.go</code>, <code>errors.go</code> (1–1.5h)</h3>\n<ol>\n<li>Write <code>services/user-service/errors.go</code> with four sentinel errors and <code>writeError</code> helper.</li>\n<li>Write <code>services/user-service/store.go</code>: <code>User</code> struct, <code>UserRepository</code> interface, <code>pgxUserStore</code>, <code>isPgUniqueViolation</code> helper.</li>\n<li>Write <code>services/user-service/password.go</code>: <code>PasswordHasher</code> interface, <code>bcryptHasher</code>, both methods.</li>\n<li>Write <code>services/user-service/token.go</code>: <code>jwtTokenIssuer</code>, <code>Issue</code> and <code>Verify</code> methods.\n<strong>Checkpoint:</strong> <code>go build ./services/user-service/...</code> exits 0. Run unit tests for store (with mock), password hasher (Hash → Verify round trip), and token issuer (Issue → Verify round trip). See §10 for test specs. Run: <code>go test ./services/user-service/...</code> → PASS.</li>\n</ol>\n<h3 id=\"phase-3-validatego-handlergo-updated-configgo-and-maingo-152h\">Phase 3: <code>validate.go</code> + <code>handler.go</code> + Updated <code>config.go</code> and <code>main.go</code> (1.5–2h)</h3>\n<ol>\n<li>Write <code>services/user-service/validate.go</code> with <code>validateEmail</code> and <code>validatePassword</code>.</li>\n<li>Update <code>services/user-service/config.go</code> to add <code>JWTSecret</code>, <code>BCryptCost</code>, <code>TokenTTL</code>.</li>\n<li>Write <code>services/user-service/handler.go</code>:<ul>\n<li><code>Handler</code> struct holding <code>store UserRepository</code>, <code>hasher PasswordHasher</code>, <code>issuer TokenIssuer</code>, <code>log *slog.Logger</code></li>\n<li><code>NewHandler</code> constructor</li>\n<li><code>Register</code>, <code>Login</code>, <code>Me</code> methods</li>\n</ul>\n</li>\n<li>Update <code>services/user-service/main.go</code>:<ul>\n<li>Load config (now includes JWT fields)</li>\n<li>Call <code>runMigrations</code></li>\n<li>Construct <code>NewUserStore</code>, <code>NewPasswordHasher</code>, <code>NewTokenIssuer</code>, <code>NewHandler</code></li>\n<li>Register routes: <code>POST /register</code>, <code>POST /login</code>, <code>GET /me</code> (wrapped in <code>JWTMiddleware</code>)</li>\n<li>Remove old stub routes if any</li>\n</ul>\n</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// main.go route registration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST /register\"</span><span style=\"color:#E1E4E8\">, h.Register)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST /login\"</span><span style=\"color:#E1E4E8\">, h.Login)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /me\"</span><span style=\"color:#E1E4E8\">, auth.</span><span style=\"color:#B392F0\">JWTMiddleware</span><span style=\"color:#E1E4E8\">(cfg.JWTSecret)(http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(h.Me)))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /health\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">NewHealthHandler</span><span style=\"color:#E1E4E8\">(cfg.ServiceName))</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> Start service locally:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">DATABASE_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"postgres://useruser:userpass@localhost:5434/userdb\"</span><span style=\"color:#B392F0\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">JWT_SECRET=</span><span style=\"color:#9ECBFF\">\"supersecretkey-at-least-32-chars-long\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">go </span><span style=\"color:#9ECBFF\">run</span><span style=\"color:#9ECBFF\"> ./services/user-service/</span></span></code></pre></div>\n\n<p><code>curl http://localhost:8080/health</code> → <code>{&quot;status&quot;:&quot;ok&quot;,&quot;service&quot;:&quot;user-service&quot;}</code>.\n<code>curl -X POST http://localhost:8080/register -d &#39;{&quot;email&quot;:&quot;test@example.com&quot;,&quot;password&quot;:&quot;password123&quot;}&#39; -H &#39;Content-Type: application/json&#39;</code> → <code>201 {&quot;user_id&quot;:&quot;...&quot;,&quot;email&quot;:&quot;test@example.com&quot;}</code>.</p>\n<h3 id=\"phase-4-jwtmiddleware-integration-get-me-1h\">Phase 4: <code>JWTMiddleware</code> Integration + <code>GET /me</code> (1h)</h3>\n<ol>\n<li>Verify <code>JWTMiddleware</code> in <code>shared/auth/middleware.go</code> correctly injects claims into context.</li>\n<li>Verify <code>ClaimsFromContext</code> returns claims from context.</li>\n<li>Wire <code>GET /me</code> handler using the middleware (done in Phase 3 above).</li>\n<li>Test <code>GET /me</code> with a valid token and with an expired/invalid token.\n<strong>Checkpoint:</strong> Full manual flow:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Register</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">RESP</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/register</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"user@example.com\",\"password\":\"securepass\"}'</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> 'Content-Type: application/json'</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#E1E4E8\"> $RESP  </span><span style=\"color:#6A737D\"># {\"user_id\":\"&#x3C;uuid>\",\"email\":\"user@example.com\"}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Login</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">TOKEN_RESP</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/login</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"user@example.com\",\"password\":\"securepass\"}'</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> 'Content-Type: application/json'</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">TOKEN</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#79B8FF\">echo</span><span style=\"color:#E1E4E8\"> $TOKEN_RESP </span><span style=\"color:#F97583\">|</span><span style=\"color:#B392F0\"> python3</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"import sys,json; print(json.load(sys.stdin)['token'])\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Me</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:8080/me</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># → {\"user_id\":\"&#x3C;uuid>\",\"email\":\"user@example.com\"}</span></span></code></pre></div>\n\n<h3 id=\"phase-5-integration-test-12h\">Phase 5: Integration Test (1–2h)</h3>\n<p>Write <code>services/user-service/user_test.go</code> covering full round trip. See §10 for detailed test specifications. Run with Docker-started <code>user_db</code>:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">DATABASE_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"postgres://useruser:userpass@localhost:5434/userdb\"</span><span style=\"color:#B392F0\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">JWT_SECRET=</span><span style=\"color:#9ECBFF\">\"testsecret-at-least-32-chars-long-ok\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">go </span><span style=\"color:#9ECBFF\">test</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#79B8FF\"> -run</span><span style=\"color:#9ECBFF\"> TestIntegration</span><span style=\"color:#9ECBFF\"> ./services/user-service/...</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> All integration tests PASS. No test leaks connections (each test uses <code>t.Cleanup</code>).\n{{DIAGRAM:tdd-diag-9}}</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Dependency wiring in main.go:\n  loadConfig() ─────────────────────────────────────────────────────┐\n       │                                                             │\n       ▼                                                             ▼\n  NewDBPool() ──► *pgxpool.Pool ──► NewUserStore() ──► UserRepository\n       │                                                             │\n       │          cfg.BCryptCost ──► NewPasswordHasher() ──► PasswordHasher\n       │                                                             │\n       │          cfg.JWTSecret  ──► NewTokenIssuer() ──► TokenIssuer\n       │          cfg.TokenTTL                                       │\n       │                                                             │\n       │          log *slog.Logger                                   │\n       │                                                             ▼\n       └────────────────────────────────────► NewHandler(store, hasher, issuer, log)\n                                                         │\n                                             mux.Handle(&quot;POST /register&quot;, h.Register)\n                                             mux.Handle(&quot;POST /login&quot;, h.Login)\n                                             mux.Handle(&quot;GET /me&quot;,\n                                               JWTMiddleware(secret)(h.Me))\n                                             mux.Handle(&quot;GET /health&quot;, healthHandler)</code></pre></div>\n\n<hr>\n<h2 id=\"10-test-specification\">10. Test Specification</h2>\n<h3 id=\"101-unit-tests-validators-validate_testgo\">10.1 Unit Tests — Validators (<code>validate_test.go</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestValidateEmail</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cases </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        input   </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        wantErr </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"user@example.com\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"user+tag@sub.domain.org\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},               </span><span style=\"color:#6A737D\">// empty</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"notanemail\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},     </span><span style=\"color:#6A737D\">// no @</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"@nodomain.com\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},  </span><span style=\"color:#6A737D\">// empty local part</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"user@\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},          </span><span style=\"color:#6A737D\">// no domain</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"user @example.com\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">}, </span><span style=\"color:#6A737D\">// space in email</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, tc </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> cases {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Run</span><span style=\"color:#E1E4E8\">(tc.input, </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> validateEmail</span><span style=\"color:#E1E4E8\">(tc.input)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> (err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> tc.wantErr {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"validateEmail(</span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">) err=</span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">, wantErr=</span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, tc.input, err, tc.wantErr)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestValidatePassword</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cases </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        input   </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        wantErr </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"12345678\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">},    </span><span style=\"color:#6A737D\">// exactly 8 chars</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"longerpassword\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"1234567\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},      </span><span style=\"color:#6A737D\">// 7 chars</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},             </span><span style=\"color:#6A737D\">// empty</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"       7\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">},    </span><span style=\"color:#6A737D\">// 8 spaces — valid (no complexity rules)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, tc </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> cases {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Run</span><span style=\"color:#E1E4E8\">(fmt.</span><span style=\"color:#B392F0\">Sprintf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"len</span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(tc.input)), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> validatePassword</span><span style=\"color:#E1E4E8\">(tc.input)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> (err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> tc.wantErr {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"validatePassword(</span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">) err=</span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">, wantErr=</span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, tc.input, err, tc.wantErr)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"102-unit-tests-bcrypthasher\">10.2 Unit Tests — <code>bcryptHasher</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestBcryptHasher_HashAndVerify</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewPasswordHasher</span><span style=\"color:#E1E4E8\">(bcrypt.MinCost) </span><span style=\"color:#6A737D\">// cost=4 for test speed</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    hash, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">Hash</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"mypassword\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Hash: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> hash </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatal</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"hash is empty\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">Verify</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"mypassword\"</span><span style=\"color:#E1E4E8\">, hash); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Verify correct password: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">Verify</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"wrongpassword\"</span><span style=\"color:#E1E4E8\">, hash); </span><span style=\"color:#F97583\">!</span><span style=\"color:#E1E4E8\">errors.</span><span style=\"color:#B392F0\">Is</span><span style=\"color:#E1E4E8\">(err, ErrPasswordMismatch) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Verify wrong password: got </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">, want ErrPasswordMismatch\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestBcryptHasher_DifferentHashesSamePassword</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewPasswordHasher</span><span style=\"color:#E1E4E8\">(bcrypt.MinCost)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    hash1, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">Hash</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"samepassword\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    hash2, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">Hash</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"samepassword\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> hash1 </span><span style=\"color:#F97583\">==</span><span style=\"color:#E1E4E8\"> hash2 {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"bcrypt should produce different hashes (different salts)\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Both should verify correctly</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">Verify</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"samepassword\"</span><span style=\"color:#E1E4E8\">, hash1); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"hash1 verify: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">Verify</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"samepassword\"</span><span style=\"color:#E1E4E8\">, hash2); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"hash2 verify: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"103-unit-tests-jwttokenissuer\">10.3 Unit Tests — <code>jwtTokenIssuer</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestJWTTokenIssuer_IssueAndVerify</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    issuer </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewTokenIssuer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"test-secret-32-chars-long-exactly\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">24</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Hour)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    tokenStr, expiresAt, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> issuer.</span><span style=\"color:#B392F0\">Issue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"user-uuid-123\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"user@example.com\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Issue: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> tokenStr </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatal</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"token string is empty\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Until</span><span style=\"color:#E1E4E8\">(expiresAt) </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 23</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Hour {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expiresAt too soon: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, expiresAt)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    claims, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> issuer.</span><span style=\"color:#B392F0\">Verify</span><span style=\"color:#E1E4E8\">(tokenStr)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Verify: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> claims.Sub </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"user-uuid-123\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"sub: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, claims.Sub)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> claims.Email </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"user@example.com\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"email: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, claims.Email)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> claims.Iss </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"url-shortener\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"iss: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, claims.Iss)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestJWTTokenIssuer_Verify_InvalidSignature</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    issuer1 </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewTokenIssuer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"secret-one-32-chars-long-exactly\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">24</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Hour)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    issuer2 </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewTokenIssuer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"secret-two-32-chars-long-exactly\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">24</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Hour)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    tok, _, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> issuer1.</span><span style=\"color:#B392F0\">Issue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"uid\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"u@e.com\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> issuer2.</span><span style=\"color:#B392F0\">Verify</span><span style=\"color:#E1E4E8\">(tok)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">errors.</span><span style=\"color:#B392F0\">Is</span><span style=\"color:#E1E4E8\">(err, ErrTokenInvalid) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"wrong secret verify: got </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">, want ErrTokenInvalid\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestJWTTokenIssuer_Verify_Expired</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    issuer </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewTokenIssuer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"test-secret-32-chars-long-exactly\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">-</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Hour) </span><span style=\"color:#6A737D\">// negative TTL → already expired</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    tok, _, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> issuer.</span><span style=\"color:#B392F0\">Issue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"uid\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"u@e.com\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> issuer.</span><span style=\"color:#B392F0\">Verify</span><span style=\"color:#E1E4E8\">(tok)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">errors.</span><span style=\"color:#B392F0\">Is</span><span style=\"color:#E1E4E8\">(err, ErrTokenInvalid) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expired token verify: got </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">, want ErrTokenInvalid\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestJWTTokenIssuer_Verify_Malformed</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    issuer </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewTokenIssuer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"test-secret-32-chars-long-exactly\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">24</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Hour)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> issuer.</span><span style=\"color:#B392F0\">Verify</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"not.a.jwt\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">errors.</span><span style=\"color:#B392F0\">Is</span><span style=\"color:#E1E4E8\">(err, ErrTokenInvalid) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"malformed token: got </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">, want ErrTokenInvalid\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"104-unit-tests-handlers-with-mock-store\">10.4 Unit Tests — Handlers (with mock store)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Mock implementations for handler unit tests:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> mockStore</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    insertFn      </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">email</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">hash</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    findByEmailFn </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">email</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">mockStore</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">email</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">hash</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> m.</span><span style=\"color:#B392F0\">insertFn</span><span style=\"color:#E1E4E8\">(ctx, email, hash)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">mockStore</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">FindByEmail</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">email</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> m.</span><span style=\"color:#B392F0\">findByEmailFn</span><span style=\"color:#E1E4E8\">(ctx, email)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRegisterHandler_Success</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        insertFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">email</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">hash</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">{ID: </span><span style=\"color:#9ECBFF\">\"test-uuid\"</span><span style=\"color:#E1E4E8\">, Email: email, CreatedAt: time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">()}, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    issuer </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewTokenIssuer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"test-secret-32-chars-long-exactly\"</span><span style=\"color:#E1E4E8\">, time.Hour)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewHandler</span><span style=\"color:#E1E4E8\">(store, </span><span style=\"color:#B392F0\">NewPasswordHasher</span><span style=\"color:#E1E4E8\">(bcrypt.MinCost), issuer, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    body </span><span style=\"color:#F97583\">:=</span><span style=\"color:#9ECBFF\"> `{\"email\":\"test@example.com\",\"password\":\"securepass\"}`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/register\"</span><span style=\"color:#E1E4E8\">, strings.</span><span style=\"color:#B392F0\">NewReader</span><span style=\"color:#E1E4E8\">(body))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req.Header.</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h.</span><span style=\"color:#B392F0\">Register</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 201</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"status: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 201, body: </span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, rec.Code, rec.Body.</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> resp </span><span style=\"color:#B392F0\">registerResponse</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">(rec.Body.</span><span style=\"color:#B392F0\">Bytes</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">resp)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> resp.UserID </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"test-uuid\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"user_id: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, resp.UserID)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Ensure PasswordHash is NOT in response:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> strings.</span><span style=\"color:#B392F0\">Contains</span><span style=\"color:#E1E4E8\">(rec.Body.</span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"password\"</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"response body must not contain password or password_hash\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRegisterHandler_DuplicateEmail</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        insertFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, ErrDuplicateEmail</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewHandler</span><span style=\"color:#E1E4E8\">(store, </span><span style=\"color:#B392F0\">NewPasswordHasher</span><span style=\"color:#E1E4E8\">(bcrypt.MinCost), </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    body </span><span style=\"color:#F97583\">:=</span><span style=\"color:#9ECBFF\"> `{\"email\":\"dup@example.com\",\"password\":\"password123\"}`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/register\"</span><span style=\"color:#E1E4E8\">, strings.</span><span style=\"color:#B392F0\">NewReader</span><span style=\"color:#E1E4E8\">(body))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req.Header.</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h.</span><span style=\"color:#B392F0\">Register</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 409</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"status: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 409\"</span><span style=\"color:#E1E4E8\">, rec.Code)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRegisterHandler_ShortPassword</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    body </span><span style=\"color:#F97583\">:=</span><span style=\"color:#9ECBFF\"> `{\"email\":\"user@example.com\",\"password\":\"short\"}`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/register\"</span><span style=\"color:#E1E4E8\">, strings.</span><span style=\"color:#B392F0\">NewReader</span><span style=\"color:#E1E4E8\">(body))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req.Header.</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h.</span><span style=\"color:#B392F0\">Register</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 400</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"status: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 400\"</span><span style=\"color:#E1E4E8\">, rec.Code)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> errResp </span><span style=\"color:#B392F0\">errorResponse</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">(rec.Body.</span><span style=\"color:#B392F0\">Bytes</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">errResp)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> errResp.Field </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"password\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"field: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> want password\"</span><span style=\"color:#E1E4E8\">, errResp.Field)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestLoginHandler_InvalidCredentials_UnknownEmail</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        findByEmailFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, ErrUserNotFound</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewHandler</span><span style=\"color:#E1E4E8\">(store, </span><span style=\"color:#B392F0\">NewPasswordHasher</span><span style=\"color:#E1E4E8\">(bcrypt.MinCost), </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    body </span><span style=\"color:#F97583\">:=</span><span style=\"color:#9ECBFF\"> `{\"email\":\"nobody@example.com\",\"password\":\"somepassword\"}`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/login\"</span><span style=\"color:#E1E4E8\">, strings.</span><span style=\"color:#B392F0\">NewReader</span><span style=\"color:#E1E4E8\">(body))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req.Header.</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h.</span><span style=\"color:#B392F0\">Login</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 401</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"status: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 401\"</span><span style=\"color:#E1E4E8\">, rec.Code)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Verify response body is generic — no hint of user existence</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> errResp </span><span style=\"color:#B392F0\">errorResponse</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">(rec.Body.</span><span style=\"color:#B392F0\">Bytes</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">errResp)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> errResp.Error </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"invalid credentials\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"error message: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">, want opaque message\"</span><span style=\"color:#E1E4E8\">, errResp.Error)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestLoginHandler_WrongPassword</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    hash, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> bcrypt.</span><span style=\"color:#B392F0\">GenerateFromPassword</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"correctpassword\"</span><span style=\"color:#E1E4E8\">), bcrypt.MinCost)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        findByEmailFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">User</span><span style=\"color:#E1E4E8\">{ID: </span><span style=\"color:#9ECBFF\">\"uid\"</span><span style=\"color:#E1E4E8\">, Email: </span><span style=\"color:#9ECBFF\">\"u@e.com\"</span><span style=\"color:#E1E4E8\">, PasswordHash: </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">(hash)}, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewHandler</span><span style=\"color:#E1E4E8\">(store, </span><span style=\"color:#B392F0\">NewPasswordHasher</span><span style=\"color:#E1E4E8\">(bcrypt.MinCost), </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    body </span><span style=\"color:#F97583\">:=</span><span style=\"color:#9ECBFF\"> `{\"email\":\"u@e.com\",\"password\":\"wrongpassword\"}`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/login\"</span><span style=\"color:#E1E4E8\">, strings.</span><span style=\"color:#B392F0\">NewReader</span><span style=\"color:#E1E4E8\">(body))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req.Header.</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h.</span><span style=\"color:#B392F0\">Login</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 401</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"status: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 401\"</span><span style=\"color:#E1E4E8\">, rec.Code)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestMeHandler_ValidToken</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    claims </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Claims</span><span style=\"color:#E1E4E8\">{Sub: </span><span style=\"color:#9ECBFF\">\"user-uuid\"</span><span style=\"color:#E1E4E8\">, Email: </span><span style=\"color:#9ECBFF\">\"user@example.com\"</span><span style=\"color:#E1E4E8\">, Iss: </span><span style=\"color:#9ECBFF\">\"url-shortener\"</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ctx </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithValue</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#B392F0\">auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">TestClaimsKey</span><span style=\"color:#E1E4E8\">{}, claims)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/me\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">).</span><span style=\"color:#B392F0\">WithContext</span><span style=\"color:#E1E4E8\">(ctx)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h.</span><span style=\"color:#B392F0\">Me</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 200</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"status: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, rec.Code)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> resp </span><span style=\"color:#B392F0\">meResponse</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">(rec.Body.</span><span style=\"color:#B392F0\">Bytes</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">resp)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> resp.UserID </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"user-uuid\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"user_id: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, resp.UserID)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Note on <code>TestClaimsKey</code>:</strong> Expose an exported key type from <code>shared/auth</code> for testing purposes only:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// shared/auth/auth.go — add alongside unexported claimsKey</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TestClaimsKey is exported ONLY for use in handler unit tests.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Do not use in production code; use JWTMiddleware instead.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> TestClaimsKey</span><span style=\"color:#F97583\"> =</span><span style=\"color:#B392F0\"> claimsKey</span></span></code></pre></div>\n\n<h3 id=\"105-integration-test-full-round-trip\">10.5 Integration Test — Full Round Trip</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// +build integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Run with: go test -tags integration -run TestIntegrationRoundTrip ./services/user-service/...</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestIntegrationRoundTrip</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Requires running user_db at DATABASE_URL env var</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> loadConfig</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Skipf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"config not available (set DATABASE_URL, JWT_SECRET): </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewDBPool</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), cfg.DatabaseURL, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"db: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    t.</span><span style=\"color:#B392F0\">Cleanup</span><span style=\"color:#E1E4E8\">(pool.Close)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> runMigrations</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), pool, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">()); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"migrate: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewUserStore</span><span style=\"color:#E1E4E8\">(pool)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    hasher </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewPasswordHasher</span><span style=\"color:#E1E4E8\">(bcrypt.MinCost) </span><span style=\"color:#6A737D\">// fast cost for tests</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    issuer </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewTokenIssuer</span><span style=\"color:#E1E4E8\">(cfg.JWTSecret, cfg.TokenTTL)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewHandler</span><span style=\"color:#E1E4E8\">(store, hasher, issuer, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mux </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">NewServeMux</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST /register\"</span><span style=\"color:#E1E4E8\">, h.Register)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST /login\"</span><span style=\"color:#E1E4E8\">, h.Login)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /me\"</span><span style=\"color:#E1E4E8\">, auth.</span><span style=\"color:#B392F0\">JWTMiddleware</span><span style=\"color:#E1E4E8\">(cfg.JWTSecret)(http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(h.Me)))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    srv </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewServer</span><span style=\"color:#E1E4E8\">(mux)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    t.</span><span style=\"color:#B392F0\">Cleanup</span><span style=\"color:#E1E4E8\">(srv.Close)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    email </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Sprintf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"integration+</span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">@example.com\"</span><span style=\"color:#E1E4E8\">, time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">UnixNano</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    password </span><span style=\"color:#F97583\">:=</span><span style=\"color:#9ECBFF\"> \"testpassword123\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Step 1: Register</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    regBody, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Marshal</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"email\"</span><span style=\"color:#E1E4E8\">: email, </span><span style=\"color:#9ECBFF\">\"password\"</span><span style=\"color:#E1E4E8\">: password})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    regResp, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">Post</span><span style=\"color:#E1E4E8\">(srv.URL</span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\">\"/register\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">, bytes.</span><span style=\"color:#B392F0\">NewReader</span><span style=\"color:#E1E4E8\">(regBody))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"register request: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> regResp.StatusCode </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 201</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        body, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> io.</span><span style=\"color:#B392F0\">ReadAll</span><span style=\"color:#E1E4E8\">(regResp.Body)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"register: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">, body: </span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, regResp.StatusCode, body)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> regResult </span><span style=\"color:#B392F0\">registerResponse</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">NewDecoder</span><span style=\"color:#E1E4E8\">(regResp.Body).</span><span style=\"color:#B392F0\">Decode</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">regResult)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> regResult.UserID </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatal</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"user_id is empty\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Step 2: Login</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    loginBody, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Marshal</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"email\"</span><span style=\"color:#E1E4E8\">: email, </span><span style=\"color:#9ECBFF\">\"password\"</span><span style=\"color:#E1E4E8\">: password})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    loginResp, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">Post</span><span style=\"color:#E1E4E8\">(srv.URL</span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\">\"/login\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">, bytes.</span><span style=\"color:#B392F0\">NewReader</span><span style=\"color:#E1E4E8\">(loginBody))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> loginResp.StatusCode </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 200</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        body, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> io.</span><span style=\"color:#B392F0\">ReadAll</span><span style=\"color:#E1E4E8\">(loginResp.Body)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"login: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">, body: </span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, loginResp.StatusCode, body)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> loginResult </span><span style=\"color:#B392F0\">loginResponse</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">NewDecoder</span><span style=\"color:#E1E4E8\">(loginResp.Body).</span><span style=\"color:#B392F0\">Decode</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">loginResult)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> loginResult.Token </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatal</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"token is empty\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Step 3: GET /me</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    meReq, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, srv.URL</span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\">\"/me\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    meReq.Header.</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Authorization\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"Bearer \"</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">loginResult.Token)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    meResp, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.DefaultClient.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(meReq)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> meResp.StatusCode </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 200</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        body, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> io.</span><span style=\"color:#B392F0\">ReadAll</span><span style=\"color:#E1E4E8\">(meResp.Body)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"me: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">, body: </span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, meResp.StatusCode, body)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> meResult </span><span style=\"color:#B392F0\">meResponse</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">NewDecoder</span><span style=\"color:#E1E4E8\">(meResp.Body).</span><span style=\"color:#B392F0\">Decode</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">meResult)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> meResult.UserID </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> regResult.UserID {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"user_id mismatch: register=</span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> me=</span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, regResult.UserID, meResult.UserID)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> meResult.Email </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> email {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"email mismatch: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> want </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, meResult.Email, email)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Step 4: Duplicate email returns 409</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    regBody2, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Marshal</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"email\"</span><span style=\"color:#E1E4E8\">: email, </span><span style=\"color:#9ECBFF\">\"password\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"differentpassword\"</span><span style=\"color:#E1E4E8\">})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    dupResp, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">Post</span><span style=\"color:#E1E4E8\">(srv.URL</span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\">\"/register\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">, bytes.</span><span style=\"color:#B392F0\">NewReader</span><span style=\"color:#E1E4E8\">(regBody2))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> dupResp.StatusCode </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 409</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"duplicate email: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 409\"</span><span style=\"color:#E1E4E8\">, dupResp.StatusCode)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Step 5: Wrong password returns 401 (same body as unknown email)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    badLoginBody, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Marshal</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"email\"</span><span style=\"color:#E1E4E8\">: email, </span><span style=\"color:#9ECBFF\">\"password\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"wrongpassword\"</span><span style=\"color:#E1E4E8\">})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    badLoginResp, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">Post</span><span style=\"color:#E1E4E8\">(srv.URL</span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\">\"/login\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">, bytes.</span><span style=\"color:#B392F0\">NewReader</span><span style=\"color:#E1E4E8\">(badLoginBody))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> badLoginResp.StatusCode </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 401</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"wrong password: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 401\"</span><span style=\"color:#E1E4E8\">, badLoginResp.StatusCode)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Step 6: Unknown email returns 401 with identical body</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    unknownLoginBody, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Marshal</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"email\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"nobody@example.com\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"password\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"whatever\"</span><span style=\"color:#E1E4E8\">})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    unknownLoginResp, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">Post</span><span style=\"color:#E1E4E8\">(srv.URL</span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\">\"/login\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">, bytes.</span><span style=\"color:#B392F0\">NewReader</span><span style=\"color:#E1E4E8\">(unknownLoginBody))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> unknownLoginResp.StatusCode </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 401</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"unknown email: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 401\"</span><span style=\"color:#E1E4E8\">, unknownLoginResp.StatusCode)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Verify response bodies are identical (anti-enumeration)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    badBody, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> io.</span><span style=\"color:#B392F0\">ReadAll</span><span style=\"color:#E1E4E8\">(badLoginResp.Body)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    unknownBody, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> io.</span><span style=\"color:#B392F0\">ReadAll</span><span style=\"color:#E1E4E8\">(unknownLoginResp.Body)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">(badBody) </span><span style=\"color:#F97583\">!=</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">(unknownBody) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"401 bodies differ: wrong-password=</span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> unknown-email=</span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, badBody, unknownBody)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-10.svg\" alt=\"JWT Claims Layout and Shared Verification Flow\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Integration test sequence:\n  Test        user-service        user_db\n   │               │                │\n   ├─POST /register─►               │\n   │               ├─INSERT users──►│\n   │               │◄──{id,email}───┤\n   │◄──201{user_id}─┤               │\n   │               │                │\n   ├─POST /login───►               │\n   │               ├─SELECT users──►│\n   │               │◄──{row}────────┤\n   │               ├─bcrypt.Compare │\n   │               ├─jwt.Sign       │\n   │◄──200{token}──┤               │\n   │               │                │\n   ├─GET /me───────►               │\n   │  (Bearer tok) │                │\n   │               ├─jwt.Parse(tok) │  ← no DB call\n   │               ├─context inject │\n   │◄──200{user_id}─┤               │\n   │               │                │\n   ├─POST /register (dup email)     │\n   │               ├─INSERT users──►│\n   │               │◄──PgError 23505┤\n   │◄──409──────────┤               │</code></pre></div>\n\n<hr>\n<h2 id=\"11-performance-targets\">11. Performance Targets</h2>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>Target</th>\n<th>Measurement Command</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>POST /register</code> (bcrypt cost=12)</td>\n<td>&lt; 400ms p99</td>\n<td><code>wrk -t4 -c4 -d30s -s register.lua http://localhost:8083/register</code> — check Latency 99th</td>\n</tr>\n<tr>\n<td><code>POST /login</code> (bcrypt compare cost=12 + DB)</td>\n<td>&lt; 500ms p99</td>\n<td><code>wrk -t4 -c4 -d30s -s login.lua http://localhost:8083/login</code></td>\n</tr>\n<tr>\n<td><code>GET /me</code> (local JWT verify, no DB)</td>\n<td>&lt; 2ms p99</td>\n<td><code>wrk -t4 -c20 -d10s http://localhost:8083/me</code> with valid Bearer token in header via lua script</td>\n</tr>\n<tr>\n<td><code>GET /health</code></td>\n<td>&lt; 10ms p99</td>\n<td><code>wrk -t1 -c10 -d10s http://localhost:8083/health</code></td>\n</tr>\n<tr>\n<td><code>NewDBPool</code> startup ping</td>\n<td>&lt; 10s total (10s timeout)</td>\n<td>Instrument with <code>time.Since</code> around <code>pool.Ping</code>; log as <code>Info</code></td>\n</tr>\n<tr>\n<td>bcrypt cost=12 single hash</td>\n<td>&lt; 400ms</td>\n<td><code>go test -bench=BenchmarkHash -benchtime=10s ./services/user-service/</code></td>\n</tr>\n</tbody></table>\n<p><strong>bcrypt benchmark:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkBcryptHash</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewPasswordHasher</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">12</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b.</span><span style=\"color:#B392F0\">ResetTimer</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#E1E4E8\"> b.N; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        h.</span><span style=\"color:#B392F0\">Hash</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"benchmarkpassword123\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkBcryptVerify</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewPasswordHasher</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">12</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    hash, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> h.</span><span style=\"color:#B392F0\">Hash</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"benchmarkpassword123\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b.</span><span style=\"color:#B392F0\">ResetTimer</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#E1E4E8\"> b.N; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        h.</span><span style=\"color:#B392F0\">Verify</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"benchmarkpassword123\"</span><span style=\"color:#E1E4E8\">, hash)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p>Expected output: <code>BenchmarkBcryptHash-8    4    280000000 ns/op</code> (≈280ms per op at cost 12 on modern hardware).</p>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-11.svg\" alt=\"users Table Schema and Index\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Request latency breakdown:\nPOST /register:\n  ┌─────────────────────────────────────────────────────┐\n  │ Network + parse: ~1ms                               │\n  │ validateEmail + validatePassword: &lt;1ms              │\n  │ bcrypt.GenerateFromPassword (cost=12): ~250-350ms   │ ← dominates\n  │ pgxpool.Exec INSERT: ~1-3ms                         │\n  │ JSON encode response: &lt;1ms                          │\n  │ TOTAL: ~252-355ms (bcrypt is intentionally slow)    │\n  └─────────────────────────────────────────────────────┘\nPOST /login:\n  ┌─────────────────────────────────────────────────────┐\n  │ Network + parse: ~1ms                               │\n  │ pgxpool.QueryRow SELECT: ~1-2ms                     │\n  │ bcrypt.CompareHashAndPassword (cost=12): ~250-350ms │ ← dominates\n  │ jwt.Sign (HMAC-SHA256): &lt;1ms                        │\n  │ JSON encode response: &lt;1ms                          │\n  │ TOTAL: ~252-354ms                                   │\n  └─────────────────────────────────────────────────────┘\nGET /me:\n  ┌─────────────────────────────────────────────────────┐\n  │ Network + parse: ~0.5ms                             │\n  │ JWTMiddleware (jwt.Parse + HMAC-SHA256): &lt;1ms       │ ← pure computation\n  │ ClaimsFromContext: &lt;0.1ms                           │\n  │ JSON encode response: &lt;0.1ms                        │\n  │ TOTAL: ~1-2ms ✓ well within 2ms p99 target         │\n  └─────────────────────────────────────────────────────┘</code></pre></div>\n\n<hr>\n<h2 id=\"12-docker-composeyml-addition-for-jwt_secret\">12. <code>docker-compose.yml</code> Addition for JWT_SECRET</h2>\n<p>Add <code>JWT_SECRET</code> to the user-service environment block. The same value must be added to <strong>all</strong> services that consume <code>shared/auth</code> in later milestones:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">yaml</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#85E89D\">user-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    DATABASE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">postgres://useruser:userpass@user_db:5432/userdb</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    JWT_SECRET</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"change-this-in-production-minimum-32-chars\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    PORT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"8080\"</span></span></code></pre></div>\n\n<h2 id=\"add-to-gowork-and-gomod-replace-directives-for-sharedauth-in-all-services-that-will-verify-jwts-url-service-analytics-service-notification-service-gateway-even-though-those-services-don39t-use-it-until-m3-adding-the-dependency-now-prevents-gowork-synchronization-issues\">Add to <code>go.work</code> and <code>go.mod</code> replace directives for <code>shared/auth</code> in all services that will verify JWTs (url-service, analytics-service, notification-service, gateway) — even though those services don&#39;t use it until M3+, adding the dependency now prevents <code>go.work</code> synchronization issues</h2>\n<!-- END_TDD_MOD -->\n\n<!-- TDD_MOD_ID: url-shortener-m3 -->\n\n<h1 id=\"url-service-shorten-redirect-crud-domain-event-publishing\">URL Service: Shorten, Redirect, CRUD + Domain Event Publishing</h1>\n<h2 id=\"module-id-url-shortener-m3\"><strong>Module ID:</strong> <code>url-shortener-m3</code></h2>\n<h2 id=\"1-module-charter\">1. Module Charter</h2>\n<p>This module implements the core business logic of the URL shortener: accepting long URLs, generating collision-resistant 7-character base62 short codes, storing URL records in the <code>urls</code> table, serving redirects with a Redis read-through cache, and guaranteeing asynchronous event delivery to RabbitMQ via the outbox pattern. It extends the url-service binary established in M1 with the full HTTP surface (<code>POST /shorten</code>, <code>GET /:code</code>, <code>GET /urls</code>, <code>DELETE /urls/:code</code>) and a background outbox worker pool (1 coordinator + 3 workers).\nThis module does <strong>not</strong> implement analytics — click events are published to RabbitMQ and consumed by analytics-service in M4. It does <strong>not</strong> send emails or touch the notification queue. It does <strong>not</strong> implement the API Gateway layer. It does <strong>not</strong> call any other service synchronously — the redirect hot path is entirely self-contained (DB + Redis). It does <strong>not</strong> run database migrations against any service&#39;s DB other than <code>url_db</code>.\n<strong>Upstream dependencies:</strong> <code>shared/events</code> (event struct definitions), <code>shared/auth</code> (JWT middleware + <code>ClaimsFromContext</code>), <code>shared/logger</code> (structured JSON logger), <code>pgxpool</code> (from M1 <code>NewDBPool</code>), <code>NewRedisClient</code> (from M1), <code>NewRabbitMQConn</code> (from M1), <code>url_db</code> PostgreSQL instance.\n<strong>Downstream consumers:</strong> analytics-service consumes <code>URLClickedEvent</code> from queue <code>analytics.clicks</code>. notification-service consumes <code>URLCreatedEvent</code> and <code>URLDeletedEvent</code> from queue <code>notifications.events</code>. The outbox pattern guarantees at-least-once delivery to both.\n<strong>Invariants that must always hold:</strong></p>\n<ul>\n<li>Every <code>POST /shorten</code> and <code>DELETE /urls/:code</code> writes the URL row and its outbox event in a <strong>single database transaction</strong> — no partial writes ever occur.</li>\n<li>Redis is never authoritative: every cache miss falls through to PostgreSQL; Redis errors are non-fatal and logged at <code>Warn</code> level.</li>\n<li>Short codes use <code>crypto/rand</code> exclusively — <code>math/rand</code> is forbidden.</li>\n<li>Expired URLs (<code>expires_at &lt; now()</code>) always return 410, never 404.</li>\n<li>Deactivated URLs (<code>is_active = false</code>) always return 410, never 404.</li>\n<li>URL ownership is verified on <code>DELETE</code> — mismatched <code>user_id</code> returns 403.</li>\n<li>Cache TTL is always <code>min(expires_at - now, 1h)</code> for URLs with expiry; <code>1h</code> for perpetual URLs; never unbounded.</li>\n</ul>\n<hr>\n<h2 id=\"2-file-structure\">2. File Structure</h2>\n<p>Create files in the numbered order below. Shared packages exist from M1/M2; only url-service files are new here.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>url-shortener/\n│\n├── shared/                             ← unchanged from M1/M2\n│   ├── events/events.go\n│   ├── auth/auth.go + middleware.go\n│   └── logger/logger.go\n│\n└── services/\n    └── url-service/\n        ├── (from M1, extended)\n        │   ├── go.mod                  ← add dependencies (see §6.3)\n        │   ├── main.go                 ← extend: wire all new components, start outbox\n        │   ├── config.go               ← extend: add ShortURLBase, OutboxPollInterval\n        │   ├── db.go                   ← unchanged\n        │   ├── redis.go                ← unchanged\n        │   ├── rabbitmq.go             ← unchanged\n        │   └── health.go               ← unchanged\n        │\n        ├── 1.  migration.sql           ← urls + outbox tables, all indexes\n        ├── 2.  store.go                ← URLRepository interface + pgxURLStore\n        ├── 3.  outbox_store.go         ← OutboxRepository interface + pgxOutboxStore\n        ├── 4.  base62.go               ← Base62Encoder, alphabet constant\n        ├── 5.  codegen.go              ← ShortCodeGenerator (crypto/rand, collision retry)\n        ├── 6.  cache.go                ← RedisCache: Get/Set/Del with error isolation\n        ├── 7.  publisher.go            ← RabbitMQPublisher interface + amqpPublisher\n        ├── 8.  outbox.go               ← OutboxCoordinator + OutboxWorker\n        ├── 9.  handler.go              ← Handler struct, Shorten/Redirect/ListURLs/DeleteURL\n        ├── 10. validate.go             ← URL format validator (scheme + host check)\n        ├── 11. errors.go               ← sentinel errors, writeError, writeJSON helpers\n        ├── 12. url_test.go             ← unit tests (base62, codegen, handler, cache)\n        └── 13. bench_test.go           ← redirect benchmark</code></pre></div>\n\n<hr>\n<h2 id=\"3-complete-data-model\">3. Complete Data Model</h2>\n<h3 id=\"31-postgresql-schema-migrationsql\">3.1 PostgreSQL Schema (<code>migration.sql</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- ── urls table ────────────────────────────────────────────────────────────────</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> urls (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    id           UUID         </span><span style=\"color:#F97583\">PRIMARY KEY</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#E1E4E8\"> gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    short_code   </span><span style=\"color:#F97583\">VARCHAR</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">)  </span><span style=\"color:#F97583\">UNIQUE</span><span style=\"color:#F97583\"> NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    original_url </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">         NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    user_id      UUID         </span><span style=\"color:#F97583\">NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    created_at   </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\">  NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    expires_at   </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\">  NULL</span><span style=\"color:#E1E4E8\">,         </span><span style=\"color:#6A737D\">-- NULL means no expiry</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    is_active    </span><span style=\"color:#F97583\">BOOLEAN</span><span style=\"color:#F97583\">      NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#E1E4E8\"> true</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Redirect lookup: short_code → row. UNIQUE implies B-tree index;</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- explicit name for EXPLAIN ANALYZE verification.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> UNIQUE INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_urls_short_code</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    ON</span><span style=\"color:#E1E4E8\"> urls(short_code);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Paginated user URL list, newest-first.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Composite index supports: WHERE user_id = $1 AND id > $2 ORDER BY created_at DESC.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_urls_user_id_created</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    ON</span><span style=\"color:#E1E4E8\"> urls(user_id, created_at </span><span style=\"color:#F97583\">DESC</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- ── outbox table ──────────────────────────────────────────────────────────────</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> outbox (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    id           UUID         </span><span style=\"color:#F97583\">PRIMARY KEY</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#E1E4E8\"> gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    event_type   </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">         NOT NULL</span><span style=\"color:#E1E4E8\">,     </span><span style=\"color:#6A737D\">-- routing key, e.g. \"url.created\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    payload      JSONB        </span><span style=\"color:#F97583\">NOT NULL</span><span style=\"color:#E1E4E8\">,     </span><span style=\"color:#6A737D\">-- full event struct serialized</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    created_at   </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\">  NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    published_at </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\">  NULL</span><span style=\"color:#6A737D\">          -- NULL = unpublished; set by worker on success</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Outbox poller index: fetch only unpublished rows, oldest first.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Partial index omits published rows (WHERE published_at IS NULL) to stay small.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_outbox_unpublished</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    ON</span><span style=\"color:#E1E4E8\"> outbox(created_at </span><span style=\"color:#F97583\">ASC</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    WHERE</span><span style=\"color:#E1E4E8\"> published_at </span><span style=\"color:#F97583\">IS</span><span style=\"color:#F97583\"> NULL</span><span style=\"color:#E1E4E8\">;</span></span></code></pre></div>\n\n<p><strong>Column rationale:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Column</th>\n<th>Type</th>\n<th>Constraint</th>\n<th>Rationale</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>urls.id</code></td>\n<td>UUID</td>\n<td>PK</td>\n<td>Non-enumerable; used as cursor in pagination</td>\n</tr>\n<tr>\n<td><code>urls.short_code</code></td>\n<td>VARCHAR(10)</td>\n<td>UNIQUE NOT NULL</td>\n<td>7-char base62 + room for custom codes up to 10 chars</td>\n</tr>\n<tr>\n<td><code>urls.original_url</code></td>\n<td>TEXT</td>\n<td>NOT NULL</td>\n<td>Unbounded URL length; TEXT avoids artificial limit</td>\n</tr>\n<tr>\n<td><code>urls.user_id</code></td>\n<td>UUID</td>\n<td>NOT NULL</td>\n<td>Owner reference; checked on DELETE for 403</td>\n</tr>\n<tr>\n<td><code>urls.expires_at</code></td>\n<td>TIMESTAMPTZ</td>\n<td>NULL</td>\n<td>NULL = perpetual; compared with <code>now()</code> on redirect</td>\n</tr>\n<tr>\n<td><code>urls.is_active</code></td>\n<td>BOOLEAN</td>\n<td>DEFAULT true</td>\n<td>Soft delete; false → 410 Gone</td>\n</tr>\n<tr>\n<td><code>outbox.event_type</code></td>\n<td>TEXT</td>\n<td>NOT NULL</td>\n<td>RabbitMQ routing key; must match <code>events.EventType*</code> constants</td>\n</tr>\n<tr>\n<td><code>outbox.payload</code></td>\n<td>JSONB</td>\n<td>NOT NULL</td>\n<td>Full event JSON; worker deserializes to verify, then publishes as AMQP body</td>\n</tr>\n<tr>\n<td><code>outbox.published_at</code></td>\n<td>TIMESTAMPTZ</td>\n<td>NULL</td>\n<td>Poller criterion: <code>WHERE published_at IS NULL</code>; set atomically by worker</td>\n</tr>\n</tbody></table>\n<h3 id=\"32-go-structs\">3.2 Go Structs</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// store.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> urlservice</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// URLRecord is the domain object mapped from the urls table.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Never returned directly in HTTP responses — projection structs handle serialization.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> URLRecord</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID          </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">     // UUID string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode   </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OriginalURL </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID      </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">     // UUID string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt   </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\"> // nil if no expiry</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    IsActive    </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// OutboxRecord is the domain object mapped from the outbox table.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> OutboxRecord</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID          </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">     // UUID string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventType   </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Payload     []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#6A737D\">     // raw JSONB bytes; sent as AMQP message body</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    PublishedAt </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\"> // nil if unpublished</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// cache.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CachedURL is the Redis-stored projection for the redirect path.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Small enough to fit in a single Redis string value.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Storing is_active avoids returning 301 for a deactivated URL cached before deletion.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> CachedURL</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OriginalURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">     `json:\"original_url\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt   </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#9ECBFF\"> `json:\"expires_at,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    IsActive    </span><span style=\"color:#F97583\">bool</span><span style=\"color:#9ECBFF\">       `json:\"is_active\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// handler.go — HTTP request/response types</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> shortenRequest</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    URL        </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"url\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CustomCode </span><span style=\"color:#F97583\">*</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"custom_code,omitempty\"`</span><span style=\"color:#6A737D\"> // nil = auto-generate</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt  </span><span style=\"color:#F97583\">*</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"expires_at,omitempty\"`</span><span style=\"color:#6A737D\">  // RFC3339 string or absent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> shortenResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortURL    </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"short_url\"`</span><span style=\"color:#6A737D\">    // cfg.ShortURLBase + \"/\" + short_code</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OriginalURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"original_url\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt   </span><span style=\"color:#F97583\">*</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"expires_at,omitempty\"`</span><span style=\"color:#6A737D\"> // RFC3339 or absent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> urlListItem</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OriginalURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"original_url\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt   </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"created_at\"`</span><span style=\"color:#6A737D\">           // RFC3339</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ExpiresAt   </span><span style=\"color:#F97583\">*</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"expires_at,omitempty\"`</span><span style=\"color:#6A737D\"> // RFC3339 or absent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    IsActive    </span><span style=\"color:#F97583\">bool</span><span style=\"color:#9ECBFF\">    `json:\"is_active\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> urlListResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    URLs       []</span><span style=\"color:#B392F0\">urlListItem</span><span style=\"color:#9ECBFF\"> `json:\"urls\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    NextCursor </span><span style=\"color:#F97583\">*</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">       `json:\"next_cursor\"`</span><span style=\"color:#6A737D\"> // null if no more pages</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// config.go (extended from M1)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Config</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DatabaseURL         </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RedisURL            </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RabbitMQURL         </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Port                </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ServiceName         </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    JWTSecret           </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">        // required; added in M2 for other services, now url-service needs it</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortURLBase        </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">        // e.g. \"http://localhost:8080\" or \"https://sho.rt\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OutboxPollInterval  </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#6A737D\"> // default 2s; configurable via OUTBOX_POLL_INTERVAL_MS</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OutboxWorkerCount   </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\">           // default 3; fixed per spec but readable from config</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"33-repository-interfaces\">3.3 Repository Interfaces</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// store.go — URLRepository</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> URLRepository</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert creates a new URL record. Returns ErrShortCodeConflict if short_code already exists.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">rec</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">URLRecord</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">URLRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // FindByCode retrieves a URL by short_code.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns ErrURLNotFound if no row exists (active or not).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    FindByCode</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">URLRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // FindByUserID returns paginated URLs for a user, ordered by created_at DESC.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // afterID is the cursor: if non-empty, returns rows with id &#x3C; afterID in created_at DESC order.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // limit is the page size (max 50).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns slice (possibly empty) and the next cursor UUID string (empty if no more pages).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    FindByUserID</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">userID</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">afterID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">limit</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">URLRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Deactivate sets is_active=false for the given short_code owned by userID.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns ErrURLNotFound if short_code doesn't exist.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns ErrNotOwner if the row exists but user_id doesn't match.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Deactivate</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">userID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// outbox_store.go — OutboxRepository</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> OutboxRepository</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // InsertWithURL inserts a URL record and an outbox row atomically within tx.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Called only by the shorten handler via a transaction helper.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // tx is a *pgx.Tx passed from the handler's transaction scope.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    InsertWithURL</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">urlRec</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">URLRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">outboxRec</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">OutboxRecord</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // InsertEvent inserts a single outbox row (used for URLDeletedEvent, URLClickedEvent).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Also called within an existing transaction.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    InsertEvent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">outboxRec</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">OutboxRecord</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // FetchUnpublished returns up to limit outbox rows with published_at IS NULL,</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ordered by created_at ASC. Uses SELECT ... FOR UPDATE SKIP LOCKED to prevent</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // multiple coordinator instances from picking the same row (safe for future scaling).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    FetchUnpublished</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">limit</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">OutboxRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // MarkPublished sets published_at = now() for the given outbox row ID.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    MarkPublished</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">id</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// publisher.go — RabbitMQPublisher</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RabbitMQPublisher</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Publish sends a message to the exchange with the given routing key.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // body is the raw JSON bytes (outbox.payload column value).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns error if the AMQP channel is closed or publish fails.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Publish</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">routingKey</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">body</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-12.svg\" alt=\"URL Service Module Architecture\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Data ownership and flow:\n                                        url_db (exclusive)\n                                        ┌─────────────────────┐\nurl-service                             │  urls table          │\n┌──────────────────────────────┐        │  outbox table        │\n│  POST /shorten               │        └─────────────────────┘\n│    │                         │               ▲\n│    ▼                         │               │  single transaction\n│  validateURL() + JWT claims  │               │\n│    │                         │        INSERT urls + INSERT outbox\n│    ▼                         │               │\n│  ShortCodeGenerator          │    ───────────┘\n│    │                         │\n│    ▼                         │        outbox rows (published_at IS NULL)\n│  pgxURLStore.Insert(tx) ─────┼──►            │\n│  pgxOutboxStore.Insert(tx) ──┼──►     OutboxCoordinator (polls every 2s)\n│    │                         │               │\n│    ▼                         │        buffered channel (cap=50)\n│  201 response                │               │\n│                              │        3 × OutboxWorker\n│  GET /:code                  │               │\n│    │                         │        amqpPublisher.Publish()\n│    ▼                         │               │\n│  RedisCache.Get(code) ───────┼──► hit: 301   │\n│    │ miss                    │        RabbitMQ exchange &quot;url-shortener&quot;\n│    ▼                         │               │\n│  pgxURLStore.FindByCode() ───┼──►     routing key &quot;url.created&quot; ──► analytics.clicks\n│    │                         │        routing key &quot;url.clicked&quot; ──► notifications.events\n│    ▼                         │        routing key &quot;url.deleted&quot; ──► notifications.events\n│  RedisCache.Set(code) ───────┼──►\n│    │                         │\n│    ▼                         │\n│  301 Location redirect       │\n└──────────────────────────────┘</code></pre></div>\n\n<hr>\n<h2 id=\"4-interface-contracts\">4. Interface Contracts</h2>\n<h3 id=\"41-urlrepository-pgxurlstore-implementation\">4.1 <code>URLRepository</code> — <code>pgxURLStore</code> Implementation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// store.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> pgxURLStore</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewURLStore</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">pool</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">URLRepository</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">pgxURLStore</span><span style=\"color:#E1E4E8\">{pool: pool}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>Insert(ctx context.Context, rec *URLRecord) (*URLRecord, error)</code></strong>\nCalled within a transaction scope from the shorten handler. The <code>rec.ID</code> field is left empty on input — the DB generates it via <code>DEFAULT gen_random_uuid()</code>.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL:\n  INSERT INTO urls (short_code, original_url, user_id, expires_at)\n  VALUES ($1, $2, $3, $4)\n  RETURNING id, short_code, original_url, user_id, created_at, expires_at, is_active\nParameters: rec.ShortCode, rec.OriginalURL, rec.UserID, rec.ExpiresAt (nil OK)\nOn success:  return populated *URLRecord (all fields from RETURNING clause)\nOn pgError 23505 (unique_violation on short_code): return nil, ErrShortCodeConflict\nOn other DB error: return nil, fmt.Errorf(&quot;insert url: %w&quot;, err)</code></pre></div>\n\n<p><strong><code>FindByCode(ctx context.Context, shortCode string) (*URLRecord, error)</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL:\n  SELECT id, short_code, original_url, user_id, created_at, expires_at, is_active\n  FROM urls\n  WHERE short_code = $1\nOn pgx.ErrNoRows: return nil, ErrURLNotFound\nOn success: return *URLRecord with all fields\nOn other DB error: return nil, fmt.Errorf(&quot;find url by code: %w&quot;, err)\nNote: This returns the row regardless of is_active and expires_at.\n      The caller (handler) decides 404 vs 410 semantics.</code></pre></div>\n\n<p><strong><code>FindByUserID(ctx context.Context, userID, afterID string, limit int) ([]*URLRecord, string, error)</code></strong>\nImplements cursor-based pagination. The cursor is the <code>id</code> (UUID) of the last item returned in the previous page. Because <code>created_at</code> is the sort column and UUIDs are unique, the cursor resolves to a created_at boundary using a subquery.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>When afterID == &quot;&quot; (first page):\n  SQL:\n    SELECT id, short_code, original_url, user_id, created_at, expires_at, is_active\n    FROM urls\n    WHERE user_id = $1\n    ORDER BY created_at DESC, id DESC\n    LIMIT $2\nWhen afterID != &quot;&quot; (subsequent pages):\n  SQL:\n    SELECT id, short_code, original_url, user_id, created_at, expires_at, is_active\n    FROM urls\n    WHERE user_id = $1\n      AND (created_at, id) &lt; (\n          SELECT created_at, id FROM urls WHERE id = $2\n      )\n    ORDER BY created_at DESC, id DESC\n    LIMIT $3\n  Parameters: userID, afterID (cursor UUID), limit+1\nAfter query: fetch limit+1 rows to determine if a next page exists.\n  - If len(rows) == limit+1: nextCursor = rows[limit].ID; return rows[:limit]\n  - If len(rows) &lt;= limit:   nextCursor = &quot;&quot;; return rows as-is\n  - Uses idx_urls_user_id_created; verify with EXPLAIN ANALYZE (checkpoint §9)\nOn success: return ([]*URLRecord, nextCursorString, nil)\n  nextCursorString is &quot;&quot; if no more pages (JSON null in response)\nOn DB error: return nil, &quot;&quot;, fmt.Errorf(&quot;find urls by user: %w&quot;, err)</code></pre></div>\n\n<p><strong><code>Deactivate(ctx context.Context, shortCode, userID string) error</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL:\n  UPDATE urls\n  SET is_active = false\n  WHERE short_code = $1\n  RETURNING user_id\nOn pgx.ErrNoRows from QueryRow: return ErrURLNotFound\nOn success scan: compare returned user_id with param userID\n  - If different: return ErrNotOwner\n  - If same: return nil\nOn other DB error: return fmt.Errorf(&quot;deactivate url: %w&quot;, err)\nNote: Uses RETURNING user_id to do ownership check and update in one round-trip.</code></pre></div>\n\n<h3 id=\"42-outboxrepository-pgxoutboxstore-implementation\">4.2 <code>OutboxRepository</code> — <code>pgxOutboxStore</code> Implementation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// outbox_store.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> pgxOutboxStore</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewOutboxStore</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">pool</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">OutboxRepository</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">pgxOutboxStore</span><span style=\"color:#E1E4E8\">{pool: pool}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>InsertWithURL(ctx context.Context, tx pgx.Tx, urlRec *URLRecord, outboxRec *OutboxRecord) error</code></strong>\nBoth inserts execute on the same <code>pgx.Tx</code>. Called from the handler&#39;s transaction scope.</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Implementation pattern — caller provides the tx:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgxOutboxStore</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">InsertWithURL</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">urlRec</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">URLRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">outboxRec</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">OutboxRecord</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert URL row</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    row </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> tx.</span><span style=\"color:#B392F0\">QueryRow</span><span style=\"color:#E1E4E8\">(ctx,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        `INSERT INTO urls (short_code, original_url, user_id, expires_at)</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">         VALUES ($1, $2, $3, $4)</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">         RETURNING id, short_code, original_url, user_id, created_at, expires_at, is_active`</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        urlRec.ShortCode, urlRec.OriginalURL, urlRec.UserID, urlRec.ExpiresAt,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    )</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> row.</span><span style=\"color:#B392F0\">Scan</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">urlRec.ID, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">urlRec.ShortCode, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">urlRec.OriginalURL,</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        &#x26;</span><span style=\"color:#E1E4E8\">urlRec.UserID, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">urlRec.CreatedAt, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">urlRec.ExpiresAt, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">urlRec.IsActive); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#B392F0\"> isPgUniqueViolation</span><span style=\"color:#E1E4E8\">(err) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#E1E4E8\"> ErrShortCodeConflict</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"insert url in tx: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert outbox row in same transaction</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> s.</span><span style=\"color:#B392F0\">InsertEvent</span><span style=\"color:#E1E4E8\">(ctx, tx, outboxRec)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>InsertEvent(ctx context.Context, tx pgx.Tx, outboxRec *OutboxRecord) error</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL (on tx):\n  INSERT INTO outbox (event_type, payload)\n  VALUES ($1, $2)\n  RETURNING id, created_at\nParameters: outboxRec.EventType, outboxRec.Payload ([]byte)\nOn success: populate outboxRec.ID and outboxRec.CreatedAt from RETURNING clause\nOn error: return fmt.Errorf(&quot;insert outbox event: %w&quot;, err)</code></pre></div>\n\n<p><strong><code>FetchUnpublished(ctx context.Context, limit int) ([]*OutboxRecord, error)</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL:\n  SELECT id, event_type, payload, created_at\n  FROM outbox\n  WHERE published_at IS NULL\n  ORDER BY created_at ASC\n  LIMIT $1\n  FOR UPDATE SKIP LOCKED\nParameters: limit (always 50 per coordinator call)\nReturns: slice of *OutboxRecord with ID, EventType, Payload, CreatedAt\nOn empty result: return empty slice, nil (not an error)\nOn DB error: return nil, fmt.Errorf(&quot;fetch unpublished outbox: %w&quot;, err)\nNote: FOR UPDATE SKIP LOCKED is safe here even with a single coordinator instance.\n      It prevents double-processing if a second coordinator is ever started.\n      The coordinator runs this in a pgxpool.BeginTx context — see §5.5.</code></pre></div>\n\n<p><strong><code>MarkPublished(ctx context.Context, id string) error</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL:\n  UPDATE outbox SET published_at = now() WHERE id = $1\nOn 0 rows affected: not an error (idempotent; already marked by another instance)\nOn DB error: return fmt.Errorf(&quot;mark outbox published: %w&quot;, err)</code></pre></div>\n\n<h3 id=\"43-rediscache\">4.3 <code>RedisCache</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// cache.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RedisCache</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Client</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log    </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewRedisCache</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">client</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Client</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">RedisCache</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> cacheKeyPrefix</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"url:\"</span><span style=\"color:#6A737D\">  // key format: \"url:{short_code}\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> defaultCacheTTL</span><span style=\"color:#F97583\"> =</span><span style=\"color:#E1E4E8\"> time.Hour</span></span></code></pre></div>\n\n<p><strong><code>Get(ctx context.Context, shortCode string) (*CachedURL, bool)</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>key := &quot;url:&quot; + shortCode\nval, err := c.client.Get(ctx, key).Bytes()\n  - On redis.Nil (key missing): return nil, false   // cache miss — normal\n  - On other error: c.log.Warn(&quot;redis get failed&quot;, &quot;key&quot;, key, &quot;error&quot;, err)\n                    return nil, false               // treat as miss, fall to DB\n  - On success: unmarshal val into *CachedURL\n      - If unmarshal fails: c.log.Warn(&quot;redis unmarshal failed&quot;, &quot;key&quot;, key, &quot;error&quot;, err)\n                            return nil, false        // treat as miss\n      - If success: return &amp;cachedURL, true          // cache hit</code></pre></div>\n\n<p><strong><code>Set(ctx context.Context, shortCode string, cu *CachedURL, expiresAt *time.Time)</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>key := &quot;url:&quot; + shortCode\nttl := computeTTL(expiresAt)           // see algorithm below\nbody, err := json.Marshal(cu)\n  - If marshal fails: c.log.Warn(&quot;redis marshal failed&quot;, &quot;key&quot;, key, &quot;error&quot;, err); return\nval := c.client.Set(ctx, key, body, ttl)\n  - If val.Err() != nil: c.log.Warn(&quot;redis set failed&quot;, &quot;key&quot;, key, &quot;error&quot;, val.Err())\n  - Either way: return (no error propagated to caller)\ncomputeTTL(expiresAt *time.Time) time.Duration:\n  if expiresAt == nil:\n      return defaultCacheTTL  // 1 hour\n  remaining := time.Until(*expiresAt)\n  if remaining &lt;= 0:\n      return 1 * time.Second  // will expire immediately; don't cache at all in practice\n                               // (handler returns 410 before reaching Set; but guard here)\n  if remaining &lt; defaultCacheTTL:\n      return remaining\n  return defaultCacheTTL</code></pre></div>\n\n<p><strong><code>Del(ctx context.Context, shortCode string)</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>key := &quot;url:&quot; + shortCode\nerr := c.client.Del(ctx, key).Err()\n  - If err != nil: c.log.Warn(&quot;redis del failed&quot;, &quot;key&quot;, key, &quot;error&quot;, err)\n  - Either way: return (best-effort; caller does not see error)</code></pre></div>\n\n<h3 id=\"44-base62encoder-and-shortcodegenerator\">4.4 <code>Base62Encoder</code> and <code>ShortCodeGenerator</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// base62.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> base62Alphabet</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> shortCodeLength</span><span style=\"color:#F97583\"> =</span><span style=\"color:#79B8FF\"> 7</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Encode converts a big.Int to a base62 string of exactly shortCodeLength characters.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Pads with '0' (alphabet[0]) on the left if the number requires fewer digits.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> Encode</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">n</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">big</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Decode converts a base62 string back to a big.Int (used in tests for round-trip verification).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> Decode</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">s</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">big</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// codegen.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ShortCodeGenerator</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewShortCodeGenerator</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">ShortCodeGenerator</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Generate creates a cryptographically random 7-character base62 short code.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Uses crypto/rand to fill 5 bytes (40 bits → max value 2^40 = 1,099,511,627,776)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// then takes modulo 62^7 = 3,521,614,606,208 to map into base62 space.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Probability analysis:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   62^7 = 3.5 trillion codes.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   After 1 million URLs: collision probability ≈ 1.4 × 10^-7 per attempt.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   5-retry budget makes the probability of all 5 colliding negligible.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns: 7-character string from base62Alphabet</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Never returns an error (crypto/rand failure panics — system entropy failure is unrecoverable)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">g </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">ShortCodeGenerator</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Generate</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">string</span></span></code></pre></div>\n\n<h3 id=\"45-rabbitmqpublisher-amqppublisher-implementation\">4.5 <code>RabbitMQPublisher</code> — <code>amqpPublisher</code> Implementation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// publisher.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> amqpPublisher</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ch          </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Channel</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    exchangeName </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log         </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewRabbitMQPublisher</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ch</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Channel</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RabbitMQPublisher</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">amqpPublisher</span><span style=\"color:#E1E4E8\">{ch: ch, exchangeName: </span><span style=\"color:#9ECBFF\">\"url-shortener\"</span><span style=\"color:#E1E4E8\">, log: log}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>Publish(ctx context.Context, routingKey string, body []byte) error</code></strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#E1E4E8\">err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> p.ch.</span><span style=\"color:#B392F0\">PublishWithContext</span><span style=\"color:#E1E4E8\">(ctx,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    p.exchangeName,  </span><span style=\"color:#6A737D\">// exchange</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    routingKey,      </span><span style=\"color:#6A737D\">// routing key = event_type constant</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    false</span><span style=\"color:#E1E4E8\">,           </span><span style=\"color:#6A737D\">// mandatory: false — drop if no queue bound (shouldn't happen)</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    false</span><span style=\"color:#E1E4E8\">,           </span><span style=\"color:#6A737D\">// immediate: false — AMQP 0-9-1 doesn't support immediate</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Publishing</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ContentType:  </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        DeliveryMode: amqp.Persistent, </span><span style=\"color:#6A737D\">// survive broker restart</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Body:         body,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"amqp publish </span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, routingKey, err)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> nil</span></span></code></pre></div>\n\n<hr>\n<h2 id=\"5-algorithm-specification\">5. Algorithm Specification</h2>\n<h3 id=\"51-shortcodegeneratorgenerate-base62-random-code\">5.1 <code>ShortCodeGenerator.Generate()</code> — Base62 Random Code</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Input:  none\nOutput: 7-character string from base62Alphabet [0-9A-Za-z]\nStep 1: Allocate 8-byte buffer\n  buf := make([]byte, 8)\nStep 2: Fill with crypto/rand\n  if _, err := rand.Read(buf); err != nil {\n      panic(fmt.Sprintf(&quot;crypto/rand read failed: %v&quot;, err))\n  }\n  // Panicking here is correct: crypto/rand failure means the OS entropy pool\n  // is exhausted — no safe randomness is possible. The process must not continue.\nStep 3: Convert to big.Int and reduce to base62 space\n  n := new(big.Int).SetBytes(buf)\n  // 62^7 = 3,521,614,606,208\n  maxCode := new(big.Int).Exp(big.NewInt(62), big.NewInt(7), nil)\n  n.Mod(n, maxCode)\nStep 4: Encode to base62 string of length 7\n  return Encode(n)  // left-pads with '0' if n encodes to fewer than 7 chars\nEncode(n *big.Int) string:\n  result := make([]byte, shortCodeLength)\n  // Fill right-to-left:\n  sixty2 := big.NewInt(62)\n  mod := new(big.Int)\n  for i := shortCodeLength - 1; i &gt;= 0; i-- {\n      n.DivMod(n, sixty2, mod)\n      result[i] = base62Alphabet[mod.Int64()]\n  }\n  return string(result)</code></pre></div>\n\n<h3 id=\"52-post-shorten-handler-full-algorithm\">5.2 <code>POST /shorten</code> Handler — Full Algorithm</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Input:  JWT-authenticated request; body: shortenRequest\nOutput: 201 {short_code, short_url, original_url, expires_at} | 400 | 409 | 422 | 503\nStep 1: Extract JWT claims\n  claims, ok := auth.ClaimsFromContext(r.Context())\n  if !ok: writeError(w, 401, &quot;unauthorized&quot;, &quot;&quot;); return\nStep 2: Decode and validate request body\n  Limit body: r.Body = http.MaxBytesReader(w, r.Body, 1&lt;&lt;20)\n  var req shortenRequest\n  if err := json.NewDecoder(r.Body).Decode(&amp;req); err != nil:\n      writeError(w, 400, &quot;invalid request body&quot;, &quot;&quot;); return\nStep 3: Validate URL\n  if err := validateURL(req.URL); err != nil:\n      writeError(w, 422, err.Error(), &quot;url&quot;); return\nStep 4: Parse optional expires_at\n  var expiresAt *time.Time\n  if req.ExpiresAt != nil:\n      t, err := time.Parse(time.RFC3339, *req.ExpiresAt)\n      if err != nil:\n          writeError(w, 422, &quot;expires_at must be RFC3339 format&quot;, &quot;expires_at&quot;); return\n      if t.Before(time.Now()):\n          writeError(w, 422, &quot;expires_at must be in the future&quot;, &quot;expires_at&quot;); return\n      expiresAt = &amp;t\nStep 5: Determine short code\n  var shortCode string\n  if req.CustomCode != nil:\n      shortCode = *req.CustomCode\n      if len(shortCode) == 0 || len(shortCode) &gt; 10:\n          writeError(w, 422, &quot;custom_code must be 1-10 characters&quot;, &quot;custom_code&quot;); return\n      // Custom code: attempt insert directly; DB unique constraint handles conflict\n      // (no retry loop for custom codes)\n  else:\n      shortCode = &quot;&quot;  // will be set in retry loop below\nStep 6: Insert URL + outbox in single transaction (with collision retry)\n  const maxRetries = 5\n  var urlRec *URLRecord\n  var insertErr error\n  for attempt := 0; attempt &lt; maxRetries; attempt++:\n      if shortCode == &quot;&quot; {  // auto-generate\n          shortCode = h.codegen.Generate()\n      }\n      urlRec = &amp;URLRecord{\n          ShortCode:   shortCode,\n          OriginalURL: req.URL,\n          UserID:      claims.Sub,\n          ExpiresAt:   expiresAt,\n      }\n      // Build outbox record (payload serialized before tx opens)\n      event := &amp;events.URLCreatedEvent{\n          BaseEvent: events.BaseEvent{\n              EventType:     events.EventTypeURLCreated,\n              OccurredAt:    time.Now().UTC(),\n              CorrelationID: correlationIDFromContext(r.Context()),\n              EventID:       newUUID(),\n          },\n          ShortCode:   shortCode,\n          OriginalURL: req.URL,\n          UserID:      claims.Sub,\n          UserEmail:   claims.Email,\n          ExpiresAt:   expiresAt,\n      }\n      payload, err := json.Marshal(event)\n      if err != nil:\n          log.Error(&quot;marshal URLCreatedEvent&quot;, &quot;error&quot;, err)\n          writeError(w, 500, &quot;internal server error&quot;, &quot;&quot;); return\n      outboxRec := &amp;OutboxRecord{\n          EventType: events.EventTypeURLCreated,\n          Payload:   payload,\n      }\n      // Open transaction\n      tx, err := h.pool.Begin(r.Context())\n      if err != nil:\n          log.Error(&quot;begin tx&quot;, &quot;error&quot;, err)\n          writeError(w, 500, &quot;internal server error&quot;, &quot;&quot;); return\n      insertErr = h.outboxStore.InsertWithURL(r.Context(), tx, urlRec, outboxRec)\n      if insertErr == nil:\n          if err := tx.Commit(r.Context()); err != nil:\n              tx.Rollback(r.Context())\n              log.Error(&quot;commit tx&quot;, &quot;error&quot;, err)\n              writeError(w, 500, &quot;internal server error&quot;, &quot;&quot;); return\n          break  // success\n      tx.Rollback(r.Context())\n      if errors.Is(insertErr, ErrShortCodeConflict):\n          if req.CustomCode != nil:\n              // Custom code conflict is permanent — do not retry\n              writeError(w, 409, &quot;short code already taken&quot;, &quot;custom_code&quot;); return\n          // Auto-generated: reset and retry with new code\n          shortCode = &quot;&quot;\n          continue\n      // Other DB error\n      log.Error(&quot;insert url+outbox&quot;, &quot;error&quot;, insertErr, &quot;attempt&quot;, attempt)\n      writeError(w, 500, &quot;internal server error&quot;, &quot;&quot;); return\n  if insertErr != nil:\n      // Exhausted maxRetries on collision\n      log.Error(&quot;short code collision exhausted&quot;, &quot;attempts&quot;, maxRetries)\n      writeError(w, 503, &quot;service temporarily unavailable, try again&quot;, &quot;&quot;); return\nStep 7: Write response\n  var expiresAtStr *string\n  if urlRec.ExpiresAt != nil:\n      s := urlRec.ExpiresAt.Format(time.RFC3339)\n      expiresAtStr = &amp;s\n  writeJSON(w, 201, shortenResponse{\n      ShortCode:   urlRec.ShortCode,\n      ShortURL:    h.cfg.ShortURLBase + &quot;/&quot; + urlRec.ShortCode,\n      OriginalURL: urlRec.OriginalURL,\n      ExpiresAt:   expiresAtStr,\n  })</code></pre></div>\n\n<h3 id=\"53-get-code-read-through-cache-redirect\">5.3 <code>GET /:code</code> — Read-Through Cache Redirect</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Input:  path parameter: code string (from URL path)\nOutput: 301 Location | 404 | 410\nStep 1: Extract short_code from path\n  code := r.PathValue(&quot;code&quot;)   // Go 1.22+ net/http pattern: &quot;GET /{code}&quot;\n  if code == &quot;&quot;: writeError(w, 404, &quot;not found&quot;, &quot;&quot;); return\nStep 2: Try Redis cache\n  cacheCtx, cancel := context.WithTimeout(r.Context(), 50*time.Millisecond)\n  defer cancel()\n  cached, hit := h.cache.Get(cacheCtx, code)\n  if hit:\n      if !cached.IsActive:\n          writeError(w, 410, &quot;url has been deactivated&quot;, &quot;&quot;); return\n      if cached.ExpiresAt != nil &amp;&amp; cached.ExpiresAt.Before(time.Now()):\n          writeError(w, 410, &quot;url has expired&quot;, &quot;&quot;); return\n      http.Redirect(w, r, cached.OriginalURL, http.StatusMovedPermanently)  // 301\n      return\nStep 3: Cache miss — query PostgreSQL\n  urlRec, err := h.urlStore.FindByCode(r.Context(), code)\n  if errors.Is(err, ErrURLNotFound):\n      writeError(w, 404, &quot;short url not found&quot;, &quot;&quot;); return\n  if err != nil:\n      h.log.Error(&quot;find url by code&quot;, &quot;code&quot;, code, &quot;error&quot;, err)\n      writeError(w, 500, &quot;internal server error&quot;, &quot;&quot;); return\nStep 4: Evaluate active + expiry state\n  if !urlRec.IsActive:\n      // Do NOT cache deactivated URLs\n      writeError(w, 410, &quot;url has been deactivated&quot;, &quot;&quot;); return\n  if urlRec.ExpiresAt != nil &amp;&amp; urlRec.ExpiresAt.Before(time.Now()):\n      // Do NOT cache expired URLs (TTL would be negative)\n      writeError(w, 410, &quot;url has expired&quot;, &quot;&quot;); return\nStep 5: Populate cache (non-blocking, errors swallowed inside Set)\n  setCtx, cancel := context.WithTimeout(r.Context(), 100*time.Millisecond)\n  defer cancel()\n  h.cache.Set(setCtx, code, &amp;CachedURL{\n      OriginalURL: urlRec.OriginalURL,\n      ExpiresAt:   urlRec.ExpiresAt,\n      IsActive:    urlRec.IsActive,\n  }, urlRec.ExpiresAt)\nStep 6: Write click event to outbox (same transaction as redirect is impractical —\n        redirect is a read, not a write. Click event MUST be in its own transaction\n        to be atomic. If service crashes between redirect and click insert, event\n        is lost — this is acceptable per spec: the redirect happened; the click\n        event may be delayed or lost. The outbox pattern provides at-least-once\n        for the write path, not for reads.)\n  clickEvent := &amp;events.URLClickedEvent{\n      BaseEvent: events.BaseEvent{\n          EventType:     events.EventTypeURLClicked,\n          OccurredAt:    time.Now().UTC(),\n          CorrelationID: correlationIDFromContext(r.Context()),\n          EventID:       newUUID(),\n      },\n      ShortCode: code,\n      IPHash:    hashIP(r.RemoteAddr),  // SHA-256(IP + salt), see §5.6\n      UserAgent: r.Header.Get(&quot;User-Agent&quot;),\n      Referer:   r.Header.Get(&quot;Referer&quot;),\n      ClickedAt: time.Now().UTC(),\n  }\n  payload, err := json.Marshal(clickEvent)\n  if err == nil:\n      tx, err := h.pool.Begin(r.Context())\n      if err == nil:\n          outboxRec := &amp;OutboxRecord{EventType: events.EventTypeURLClicked, Payload: payload}\n          if err := h.outboxStore.InsertEvent(r.Context(), tx, outboxRec); err != nil:\n              tx.Rollback(r.Context())\n              h.log.Warn(&quot;insert click event outbox&quot;, &quot;code&quot;, code, &quot;error&quot;, err)\n          else:\n              if err := tx.Commit(r.Context()); err != nil:\n                  h.log.Warn(&quot;commit click event tx&quot;, &quot;error&quot;, err)\n      else:\n          h.log.Warn(&quot;begin click tx&quot;, &quot;error&quot;, err)\n  // Click event failure is always non-fatal — redirect proceeds regardless\nStep 7: Redirect\n  http.Redirect(w, r, urlRec.OriginalURL, http.StatusMovedPermanently)  // 301</code></pre></div>\n\n<p><strong>Critical design note on click atomicity:</strong> The M3 spec states the outbox write must be atomic. For <code>URLClickedEvent</code>, this is written in its own transaction immediately after the redirect decision is made. If the process crashes after writing the redirect response but before committing the outbox row, the click is lost — this is the acceptable trade-off documented in the spec. The alternative (writing the event before sending the redirect) risks a phantom event if the redirect fails. The outbox guarantees at-least-once for events that do commit; it cannot guarantee events for HTTP responses already sent.</p>\n<h3 id=\"54-delete-urlscode-handler\">5.4 <code>DELETE /urls/:code</code> Handler</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Input:  JWT-authenticated; path param: code\nOutput: 204 | 403 | 404 | 500\nStep 1: Extract claims\n  claims, ok := auth.ClaimsFromContext(r.Context())\n  if !ok: writeError(w, 401, &quot;unauthorized&quot;, &quot;&quot;); return\nStep 2: Deactivate in DB (ownership check inside store)\n  tx, err := h.pool.Begin(r.Context())\n  if err != nil: writeError(w, 500, &quot;internal server error&quot;, &quot;&quot;); return\n  // Must read the URL before deactivating to build the event payload\n  urlRec, err := h.urlStore.FindByCode(r.Context(), r.PathValue(&quot;code&quot;))\n  if errors.Is(err, ErrURLNotFound): tx.Rollback(r.Context()); writeError(w, 404, ...); return\n  if err != nil: tx.Rollback(r.Context()); writeError(w, 500, ...); return\n  if urlRec.UserID != claims.Sub: tx.Rollback(r.Context()); writeError(w, 403, &quot;forbidden&quot;, &quot;&quot;); return\n  // Deactivate (UPDATE within same tx)\n  // Execute: UPDATE urls SET is_active = false WHERE short_code = $1 AND user_id = $2\n  _, err = tx.Exec(r.Context(),\n      `UPDATE urls SET is_active = false WHERE short_code = $1 AND user_id = $2`,\n      r.PathValue(&quot;code&quot;), claims.Sub)\n  if err != nil: tx.Rollback(r.Context()); writeError(w, 500, ...); return\nStep 3: Insert URLDeletedEvent into outbox (same tx)\n  event := &amp;events.URLDeletedEvent{\n      BaseEvent: events.BaseEvent{\n          EventType:     events.EventTypeURLDeleted,\n          OccurredAt:    time.Now().UTC(),\n          CorrelationID: correlationIDFromContext(r.Context()),\n          EventID:       newUUID(),\n      },\n      ShortCode: r.PathValue(&quot;code&quot;),\n      UserID:    claims.Sub,\n      UserEmail: claims.Email,\n  }\n  payload, _ := json.Marshal(event)\n  outboxRec := &amp;OutboxRecord{EventType: events.EventTypeURLDeleted, Payload: payload}\n  if err := h.outboxStore.InsertEvent(r.Context(), tx, outboxRec); err != nil:\n      tx.Rollback(r.Context())\n      h.log.Error(&quot;insert delete event outbox&quot;, &quot;error&quot;, err)\n      writeError(w, 500, &quot;internal server error&quot;, &quot;&quot;); return\nStep 4: Commit\n  if err := tx.Commit(r.Context()); err != nil:\n      h.log.Error(&quot;commit delete tx&quot;, &quot;error&quot;, err)\n      writeError(w, 500, &quot;internal server error&quot;, &quot;&quot;); return\nStep 5: Invalidate Redis cache (best-effort, after commit)\n  delCtx, cancel := context.WithTimeout(context.Background(), 200*time.Millisecond)\n  defer cancel()\n  h.cache.Del(delCtx, r.PathValue(&quot;code&quot;))\n  // h.cache.Del always returns void; errors are logged inside Del\nStep 6: Write 204 No Content\n  w.WriteHeader(http.StatusNoContent)</code></pre></div>\n\n<h3 id=\"55-outbox-coordinator-worker-pool\">5.5 Outbox Coordinator + Worker Pool</h3>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-13.svg\" alt=\"urls and outbox Table Schemas with Index Annotations\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Outbox architecture:\n  main.go\n    │ go outboxCoordinator.Run(ctx)\n    │\n  OutboxCoordinator\n    │ every 2s: FetchUnpublished(limit=50)\n    │ for each row:\n    │   workerCh &lt;- row                    ← buffered channel, cap=50\n    │\n  OutboxWorker × 3 (goroutines)\n    │ for row := range workerCh:\n    │   publisher.Publish(row.EventType, row.Payload)\n    │   outboxStore.MarkPublished(row.ID)\n    │\n  Graceful shutdown:\n    ctx cancelled → coordinator stops polling → workerCh drained → workers exit</code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// outbox.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> OutboxCoordinator</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store     </span><span style=\"color:#B392F0\">OutboxRepository</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    workerCh  </span><span style=\"color:#F97583\">chan</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">OutboxRecord</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log       </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    interval  </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    workerCount </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewOutboxCoordinator</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    store</span><span style=\"color:#B392F0\"> OutboxRepository</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    publisher</span><span style=\"color:#B392F0\"> RabbitMQPublisher</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    interval</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    workerCount</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">OutboxCoordinator</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Run starts the coordinator and worker goroutines.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Blocks until ctx is cancelled.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Called with `go coordinator.Run(ctx)` in main.go.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">c </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">OutboxCoordinator</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Run</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n\n<p><strong><code>OutboxCoordinator.Run(ctx context.Context)</code> Algorithm:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Step 1: Create buffered worker channel\n  workerCh := make(chan *OutboxRecord, 50)\nStep 2: Start worker goroutines\n  var wg sync.WaitGroup\n  for i := 0; i &lt; c.workerCount; i++:\n      wg.Add(1)\n      go func():\n          defer wg.Done()\n          c.runWorker(ctx, workerCh)\n      ()\nStep 3: Poll loop\n  ticker := time.NewTicker(c.interval)\n  defer ticker.Stop()\n  for:\n      select:\n      case &lt;-ctx.Done():\n          close(workerCh)   // signal workers to drain and exit\n          wg.Wait()         // wait for all workers to finish in-flight publishes\n          c.log.Info(&quot;outbox coordinator stopped&quot;)\n          return\n      case &lt;-ticker.C:\n          c.poll(ctx, workerCh)\npoll(ctx context.Context, workerCh chan *OutboxRecord):\n  rows, err := c.store.FetchUnpublished(ctx, 50)\n  if err != nil:\n      c.log.Warn(&quot;outbox fetch failed&quot;, &quot;error&quot;, err); return\n  for _, row := range rows:\n      select:\n      case workerCh &lt;- row:  // send to available worker\n      case &lt;-ctx.Done():\n          return              // coordinator is shutting down\nrunWorker(ctx context.Context, workerCh &lt;-chan *OutboxRecord):\n  for row := range workerCh:   // exits when channel is closed\n      publishCtx, cancel := context.WithTimeout(ctx, 5*time.Second)\n      err := c.publisher.Publish(publishCtx, row.EventType, row.Payload)\n      cancel()\n      if err != nil:\n          c.log.Warn(&quot;outbox publish failed&quot;,\n              &quot;event_type&quot;, row.EventType,\n              &quot;outbox_id&quot;, row.ID,\n              &quot;error&quot;, err)\n          // Leave published_at NULL — coordinator will re-fetch on next poll\n          continue\n      if err := c.store.MarkPublished(context.Background(), row.ID); err != nil:\n          c.log.Warn(&quot;outbox mark published failed&quot;,\n              &quot;outbox_id&quot;, row.ID,\n              &quot;error&quot;, err)\n          // RabbitMQ got the message but DB update failed.\n          // Next poll will re-fetch this row and re-publish.\n          // Consumer must handle duplicate events (analytics-service does this in M4).</code></pre></div>\n\n<p><strong>Why <code>FOR UPDATE SKIP LOCKED</code> matters:</strong> If <code>MarkPublished</code> fails after a successful publish, the row remains in <code>published_at IS NULL</code> state. The next poll cycle picks it up and publishes again. The consumer (analytics-service) deduplicates by <code>EventID</code>. This is the at-least-once guarantee.</p>\n<h3 id=\"56-ip-hashing-haship\">5.6 IP Hashing (<code>hashIP</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// handler.go helper</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">crypto/sha256</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> ipHashSalt </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"IP_HASH_SALT\"</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#6A737D\">// set in docker-compose env; empty string is acceptable fallback</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> hashIP</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">remoteAddr</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ip, _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> net.</span><span style=\"color:#B392F0\">SplitHostPort</span><span style=\"color:#E1E4E8\">(remoteAddr)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ip </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> remoteAddr </span><span style=\"color:#6A737D\">// fallback: use raw if port parsing fails</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> sha256.</span><span style=\"color:#B392F0\">Sum256</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(ip </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> ipHashSalt))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Sprintf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">%x</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, h)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"57-startup-migration\">5.7 Startup Migration</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// main.go — after NewDBPool succeeds</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> urlServiceSchema</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> `</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE TABLE IF NOT EXISTS urls (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    id           UUID         PRIMARY KEY DEFAULT gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    short_code   VARCHAR(10)  UNIQUE NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    original_url TEXT         NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    user_id      UUID         NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    created_at   TIMESTAMPTZ  NOT NULL DEFAULT now(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    expires_at   TIMESTAMPTZ  NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    is_active    BOOLEAN      NOT NULL DEFAULT true</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">);</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE UNIQUE INDEX IF NOT EXISTS idx_urls_short_code ON urls(short_code);</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE INDEX IF NOT EXISTS idx_urls_user_id_created ON urls(user_id, created_at DESC);</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE TABLE IF NOT EXISTS outbox (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    id           UUID         PRIMARY KEY DEFAULT gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    event_type   TEXT         NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    payload      JSONB        NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    created_at   TIMESTAMPTZ  NOT NULL DEFAULT now(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    published_at TIMESTAMPTZ  NULL</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">);</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE INDEX IF NOT EXISTS idx_outbox_unpublished</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    ON outbox(created_at ASC) WHERE published_at IS NULL;</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">`</span></span></code></pre></div>\n\n<h3 id=\"58-route-registration-in-maingo\">5.8 Route Registration in <code>main.go</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// main.go (extended from M1)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">NewServeMux</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /health\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">NewHealthHandler</span><span style=\"color:#E1E4E8\">(cfg.ServiceName))</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Protected routes (JWT required)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">authMw </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> auth.</span><span style=\"color:#B392F0\">JWTMiddleware</span><span style=\"color:#E1E4E8\">(cfg.JWTSecret)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"POST /shorten\"</span><span style=\"color:#E1E4E8\">,       </span><span style=\"color:#B392F0\">authMw</span><span style=\"color:#E1E4E8\">(http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(h.Shorten)))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /urls\"</span><span style=\"color:#E1E4E8\">,           </span><span style=\"color:#B392F0\">authMw</span><span style=\"color:#E1E4E8\">(http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(h.ListURLs)))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">Handle</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DELETE /urls/{code}\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">authMw</span><span style=\"color:#E1E4E8\">(http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(h.DeleteURL)))</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Anonymous route</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /{code}\"</span><span style=\"color:#E1E4E8\">, h.Redirect)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Start outbox coordinator (before HTTP server, after RabbitMQ connected)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">appCtx, appCancel </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithCancel</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">coordinator </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewOutboxCoordinator</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    outboxStore,</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    NewRabbitMQPublisher</span><span style=\"color:#E1E4E8\">(mq.Channel, log),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg.OutboxPollInterval,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg.OutboxWorkerCount,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">go</span><span style=\"color:#E1E4E8\"> coordinator.</span><span style=\"color:#B392F0\">Run</span><span style=\"color:#E1E4E8\">(appCtx)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// On SIGTERM/SIGINT: appCancel() before pool.Close()</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-14.svg\" alt=\"Base62 Short Code Generation Algorithm\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>main.go startup sequence (url-service, M3 extended):\n  loadConfig()\n       │ ← fatal if DATABASE_URL | RABBITMQ_URL | REDIS_URL | JWT_SECRET missing\n       ▼\n  logger.New(&quot;url-service&quot;)\n       ▼\n  NewDBPool() ── fatal on error\n       ▼\n  runMigrations(pool) ── fatal on error\n       ▼\n  NewRedisClient() ── warn+continue on error\n       ▼\n  NewRabbitMQConn() ── fatal after 10 attempts\n       ▼\n  NewURLStore(pool)\n  NewOutboxStore(pool)\n  NewShortCodeGenerator()\n  NewRedisCache(redisClient, log)\n  NewRabbitMQPublisher(mq.Channel, log)\n  NewHandler(...)\n       ▼\n  coordinator := NewOutboxCoordinator(outboxStore, publisher, log, 2s, 3)\n  go coordinator.Run(appCtx)     ← background goroutine\n       ▼\n  mux := http.NewServeMux()\n  mux.Handle(...)                ← all routes registered\n       ▼\n  srv.ListenAndServe()           ← blocks\n       │\n       │ SIGTERM received\n       ▼\n  appCancel()   ← stops coordinator and workers\n  srv.Shutdown(ctx)\n  mq.Close()\n  redisClient.Close()\n  pool.Close()</code></pre></div>\n\n<h3 id=\"59-validateurl-function\">5.9 <code>validateURL</code> Function</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// validate.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> validateURL</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">rawURL</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> rawURL </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url is required\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    u, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> url.</span><span style=\"color:#B392F0\">Parse</span><span style=\"color:#E1E4E8\">(rawURL)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"invalid url: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> u.Scheme </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url must include a scheme (http:// or https://)\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> u.Scheme </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"http\"</span><span style=\"color:#F97583\"> &#x26;&#x26;</span><span style=\"color:#E1E4E8\"> u.Scheme </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"https\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url scheme must be http or https, got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, u.Scheme)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> u.Host </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url must include a host\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"510-correlation-id-propagation\">5.10 Correlation ID Propagation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// handler.go helper — reads X-Correlation-ID from request context or header</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// The correlation ID is injected by the gateway in M5; for direct calls it may be absent.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> correlationKey</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> correlationIDFromContext</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> id, ok </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> ctx.</span><span style=\"color:#B392F0\">Value</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">correlationKey</span><span style=\"color:#E1E4E8\">{}).(</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">); ok </span><span style=\"color:#F97583\">&#x26;&#x26;</span><span style=\"color:#E1E4E8\"> id </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> id</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#B392F0\"> newUUID</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#6A737D\">// generate one if missing (direct service call without gateway)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Middleware to read X-Correlation-ID header and inject into context.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Applied to all routes in main.go before auth middleware.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> CorrelationIDMiddleware</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">next</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        id </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> r.Header.</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"X-Correlation-ID\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> id </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            id </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> newUUID</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ctx </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithValue</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#B392F0\">correlationKey</span><span style=\"color:#E1E4E8\">{}, id)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"X-Correlation-ID\"</span><span style=\"color:#E1E4E8\">, id) </span><span style=\"color:#6A737D\">// echo back to client</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        next.</span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(w, r.</span><span style=\"color:#B392F0\">WithContext</span><span style=\"color:#E1E4E8\">(ctx))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// newUUID returns a random UUID v4 string using crypto/rand.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> newUUID</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rand.</span><span style=\"color:#B392F0\">Read</span><span style=\"color:#E1E4E8\">(b)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b[</span><span style=\"color:#79B8FF\">6</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (b[</span><span style=\"color:#79B8FF\">6</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#F97583\"> 0x</span><span style=\"color:#79B8FF\">0f</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">|</span><span style=\"color:#F97583\"> 0x</span><span style=\"color:#79B8FF\">40</span><span style=\"color:#6A737D\"> // version 4</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b[</span><span style=\"color:#79B8FF\">8</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (b[</span><span style=\"color:#79B8FF\">8</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#F97583\"> 0x</span><span style=\"color:#79B8FF\">3f</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">|</span><span style=\"color:#F97583\"> 0x</span><span style=\"color:#79B8FF\">80</span><span style=\"color:#6A737D\"> // variant bits</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Sprintf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">%08x</span><span style=\"color:#9ECBFF\">-</span><span style=\"color:#79B8FF\">%04x</span><span style=\"color:#9ECBFF\">-</span><span style=\"color:#79B8FF\">%04x</span><span style=\"color:#9ECBFF\">-</span><span style=\"color:#79B8FF\">%04x</span><span style=\"color:#9ECBFF\">-</span><span style=\"color:#79B8FF\">%012x</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        b[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">:</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">], b[</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">:</span><span style=\"color:#79B8FF\">6</span><span style=\"color:#E1E4E8\">], b[</span><span style=\"color:#79B8FF\">6</span><span style=\"color:#E1E4E8\">:</span><span style=\"color:#79B8FF\">8</span><span style=\"color:#E1E4E8\">], b[</span><span style=\"color:#79B8FF\">8</span><span style=\"color:#E1E4E8\">:</span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">], b[</span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">:</span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">])</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<hr>\n<h2 id=\"6-error-handling-matrix\">6. Error Handling Matrix</h2>\n<table>\n<thead>\n<tr>\n<th>Error Scenario</th>\n<th>Detected By</th>\n<th>HTTP Status</th>\n<th>Response Body</th>\n<th>Log Level</th>\n<th>Notes</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Missing JWT / invalid token</td>\n<td><code>JWTMiddleware</code></td>\n<td>401</td>\n<td><code>{&quot;error&quot;:&quot;unauthorized&quot;}</code></td>\n<td>none</td>\n<td>Handled before handler</td>\n</tr>\n<tr>\n<td>Invalid JSON request body</td>\n<td><code>json.Decode</code></td>\n<td>400</td>\n<td><code>{&quot;error&quot;:&quot;invalid request body&quot;}</code></td>\n<td>Warn</td>\n<td>Log path + size</td>\n</tr>\n<tr>\n<td>URL missing scheme</td>\n<td><code>validateURL</code></td>\n<td>422</td>\n<td><code>{&quot;error&quot;:&quot;url must include a scheme...&quot;,&quot;field&quot;:&quot;url&quot;}</code></td>\n<td>none</td>\n<td></td>\n</tr>\n<tr>\n<td>URL non-http scheme</td>\n<td><code>validateURL</code></td>\n<td>422</td>\n<td><code>{&quot;error&quot;:&quot;url scheme must be http or https...&quot;,&quot;field&quot;:&quot;url&quot;}</code></td>\n<td>none</td>\n<td></td>\n</tr>\n<tr>\n<td>URL missing host</td>\n<td><code>validateURL</code></td>\n<td>422</td>\n<td><code>{&quot;error&quot;:&quot;url must include a host&quot;,&quot;field&quot;:&quot;url&quot;}</code></td>\n<td>none</td>\n<td></td>\n</tr>\n<tr>\n<td><code>expires_at</code> malformed</td>\n<td>RFC3339 parse</td>\n<td>422</td>\n<td><code>{&quot;error&quot;:&quot;expires_at must be RFC3339 format&quot;,&quot;field&quot;:&quot;expires_at&quot;}</code></td>\n<td>none</td>\n<td></td>\n</tr>\n<tr>\n<td><code>expires_at</code> in past</td>\n<td>time comparison</td>\n<td>422</td>\n<td><code>{&quot;error&quot;:&quot;expires_at must be in the future&quot;,&quot;field&quot;:&quot;expires_at&quot;}</code></td>\n<td>none</td>\n<td></td>\n</tr>\n<tr>\n<td>Custom code already taken</td>\n<td><code>ErrShortCodeConflict</code>, <code>custom_code != nil</code></td>\n<td>409</td>\n<td><code>{&quot;error&quot;:&quot;short code already taken&quot;,&quot;field&quot;:&quot;custom_code&quot;}</code></td>\n<td>Info</td>\n<td></td>\n</tr>\n<tr>\n<td>Auto-code collision × 5</td>\n<td><code>ErrShortCodeConflict</code> × 5, attempts exhausted</td>\n<td>503</td>\n<td><code>{&quot;error&quot;:&quot;service temporarily unavailable, try again&quot;}</code></td>\n<td>Error</td>\n<td>Include attempt count</td>\n</tr>\n<tr>\n<td>DB error on INSERT urls</td>\n<td><code>InsertWithURL</code> non-conflict</td>\n<td>500</td>\n<td><code>{&quot;error&quot;:&quot;internal server error&quot;}</code></td>\n<td>Error</td>\n<td>Log full error</td>\n</tr>\n<tr>\n<td>DB begin tx error</td>\n<td><code>pool.Begin</code></td>\n<td>500</td>\n<td><code>{&quot;error&quot;:&quot;internal server error&quot;}</code></td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td>DB commit error</td>\n<td><code>tx.Commit</code></td>\n<td>500</td>\n<td><code>{&quot;error&quot;:&quot;internal server error&quot;}</code></td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td><code>GET /:code</code> not found</td>\n<td><code>ErrURLNotFound</code></td>\n<td>404</td>\n<td><code>{&quot;error&quot;:&quot;short url not found&quot;}</code></td>\n<td>none</td>\n<td></td>\n</tr>\n<tr>\n<td><code>GET /:code</code> is_active=false</td>\n<td><code>urlRec.IsActive == false</code></td>\n<td>410</td>\n<td><code>{&quot;error&quot;:&quot;url has been deactivated&quot;}</code></td>\n<td>none</td>\n<td></td>\n</tr>\n<tr>\n<td><code>GET /:code</code> expired</td>\n<td><code>expires_at &lt; now()</code></td>\n<td>410</td>\n<td><code>{&quot;error&quot;:&quot;url has expired&quot;}</code></td>\n<td>none</td>\n<td></td>\n</tr>\n<tr>\n<td>Redis GET error</td>\n<td><code>client.Get</code> non-nil error</td>\n<td>cache miss (fall through)</td>\n<td>none (no HTTP error)</td>\n<td>Warn</td>\n<td><code>&quot;redis get failed&quot;</code></td>\n</tr>\n<tr>\n<td>Redis SET error</td>\n<td><code>client.Set</code> non-nil error</td>\n<td>none (redirect succeeds)</td>\n<td>none</td>\n<td>Warn</td>\n<td><code>&quot;redis set failed&quot;</code></td>\n</tr>\n<tr>\n<td>Redis DEL error</td>\n<td><code>client.Del</code> non-nil error</td>\n<td>none (204 proceeds)</td>\n<td>none</td>\n<td>Warn</td>\n<td><code>&quot;redis del failed&quot;</code></td>\n</tr>\n<tr>\n<td><code>GET /urls</code> DB error</td>\n<td><code>FindByUserID</code></td>\n<td>500</td>\n<td><code>{&quot;error&quot;:&quot;internal server error&quot;}</code></td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td><code>GET /urls</code> invalid cursor</td>\n<td>UUID parse fail on <code>after</code> param</td>\n<td>400</td>\n<td><code>{&quot;error&quot;:&quot;invalid cursor&quot;,&quot;field&quot;:&quot;after&quot;}</code></td>\n<td>none</td>\n<td></td>\n</tr>\n<tr>\n<td><code>DELETE</code> URL not found</td>\n<td><code>ErrURLNotFound</code></td>\n<td>404</td>\n<td><code>{&quot;error&quot;:&quot;short url not found&quot;}</code></td>\n<td>none</td>\n<td></td>\n</tr>\n<tr>\n<td><code>DELETE</code> wrong owner</td>\n<td><code>urlRec.UserID != claims.Sub</code></td>\n<td>403</td>\n<td><code>{&quot;error&quot;:&quot;forbidden&quot;}</code></td>\n<td>Info</td>\n<td>Log user_id + owner</td>\n</tr>\n<tr>\n<td><code>DELETE</code> DB error</td>\n<td>any non-sentinel DB err</td>\n<td>500</td>\n<td><code>{&quot;error&quot;:&quot;internal server error&quot;}</code></td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td>Outbox publish failure</td>\n<td><code>amqpPublisher.Publish</code></td>\n<td>no HTTP (background)</td>\n<td>—</td>\n<td>Warn</td>\n<td><code>&quot;outbox_id&quot;</code>, <code>&quot;event_type&quot;</code>, <code>&quot;error&quot;</code></td>\n</tr>\n<tr>\n<td>Outbox MarkPublished failure</td>\n<td><code>MarkPublished</code></td>\n<td>no HTTP (background)</td>\n<td>—</td>\n<td>Warn</td>\n<td>Same fields; row re-published next cycle</td>\n</tr>\n<tr>\n<td>Outbox FetchUnpublished failure</td>\n<td><code>FetchUnpublished</code></td>\n<td>no HTTP (background)</td>\n<td>—</td>\n<td>Warn</td>\n<td><code>&quot;error&quot;</code>; coordinator continues next tick</td>\n</tr>\n<tr>\n<td>Click event outbox insert failure</td>\n<td>tx.Exec or InsertEvent</td>\n<td>no HTTP (redirect proceeds)</td>\n<td>—</td>\n<td>Warn</td>\n<td><code>&quot;code&quot;</code>, <code>&quot;error&quot;</code></td>\n</tr>\n<tr>\n<td><code>crypto/rand.Read</code> failure</td>\n<td><code>ShortCodeGenerator.Generate</code></td>\n<td>process panic</td>\n<td>—</td>\n<td>—</td>\n<td>Unrecoverable; OS entropy exhausted</td>\n</tr>\n</tbody></table>\n<p><strong><code>writeError</code> helper:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// errors.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> writeError</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">status</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">message</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">field</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(status)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    resp </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Error </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"error\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Field </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"field,omitempty\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }{Error: message, Field: field}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">NewEncoder</span><span style=\"color:#E1E4E8\">(w).</span><span style=\"color:#B392F0\">Encode</span><span style=\"color:#E1E4E8\">(resp)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> writeJSON</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">status</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">v</span><span style=\"color:#B392F0\"> any</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(status)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">NewEncoder</span><span style=\"color:#E1E4E8\">(w).</span><span style=\"color:#B392F0\">Encode</span><span style=\"color:#E1E4E8\">(v)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Sentinel errors:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// errors.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrShortCodeConflict </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"short code already exists\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrURLNotFound       </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url not found\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ErrNotOwner          </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"not the url owner\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n\n<hr>\n<h2 id=\"7-concurrency-specification\">7. Concurrency Specification</h2>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Goroutine</th>\n<th>Shared State</th>\n<th>Thread Safety</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>HTTP handlers</td>\n<td>per-request (net/http)</td>\n<td><code>*pgxpool.Pool</code>, <code>*RedisCache</code>, <code>*OutboxStore</code></td>\n<td>✅ All safe: pgxpool is goroutine-safe; RedisCache is stateless; OutboxStore holds only pool</td>\n</tr>\n<tr>\n<td><code>OutboxCoordinator.Run</code></td>\n<td>1 dedicated goroutine</td>\n<td><code>workerCh chan *OutboxRecord</code>, <code>OutboxRepository</code></td>\n<td>✅ Channel is the only shared state; only coordinator sends</td>\n</tr>\n<tr>\n<td><code>OutboxWorker.runWorker</code></td>\n<td>3 dedicated goroutines</td>\n<td><code>workerCh</code> (read-only), <code>RabbitMQPublisher</code>, <code>OutboxRepository</code></td>\n<td>✅ Workers only read from channel; pool is goroutine-safe</td>\n</tr>\n<tr>\n<td><code>amqpPublisher.Publish</code></td>\n<td>called from worker goroutines</td>\n<td><code>*amqp.Channel</code></td>\n<td>⚠️ <strong>NOT safe</strong> for concurrent calls — see below</td>\n</tr>\n<tr>\n<td><code>RedisCache</code></td>\n<td>called from HTTP goroutines</td>\n<td><code>*redis.Client</code></td>\n<td>✅ go-redis client is goroutine-safe</td>\n</tr>\n</tbody></table>\n<p><strong>AMQP Channel concurrency:</strong> <code>amqp091-go</code> channels are <strong>not</strong> goroutine-safe for concurrent publishes. Since 3 workers share one publisher, the publisher must protect the channel with a mutex:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// publisher.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> amqpPublisher</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mu           </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Mutex</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ch           </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Channel</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    exchangeName </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log          </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">p </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">amqpPublisher</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Publish</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">routingKey</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">body</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    p.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> p.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ... PublishWithContext call ...</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p>Alternatively, give each worker its own AMQP channel (3 channels from one connection). The mutex approach is simpler for this project. For higher throughput, switch to per-worker channels in a production system.\n<strong>Context cancellation flow:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>main.go: SIGTERM received\n  → appCancel()\n  → coordinator's ctx.Done() fires in select loop\n  → coordinator closes workerCh\n  → workers drain workerCh and exit (range loop terminates on close)\n  → wg.Wait() in coordinator returns\n  → coordinator returns\n  → main.go proceeds to srv.Shutdown()</code></pre></div>\n\n<p><strong>Timeout contexts for Redis:</strong></p>\n<ul>\n<li>All Redis operations must use a <code>context.WithTimeout</code> with 50ms for GET and 100ms for SET/DEL.</li>\n<li>Never use <code>r.Context()</code> directly for Redis — if the HTTP client disconnects, the context is cancelled and the cache operation is aborted, but the handler continues regardless.</li>\n</ul>\n<hr>\n<h2 id=\"8-implementation-sequence-with-checkpoints\">8. Implementation Sequence with Checkpoints</h2>\n<h3 id=\"phase-1-db-schema-urls-outbox-tables-migrations-indexes-1h\">Phase 1: DB Schema — <code>urls</code> + <code>outbox</code> Tables, Migrations, Indexes (1h)</h3>\n<ol>\n<li>Write <code>migration.sql</code> as specified in §3.1.</li>\n<li>Extend <code>main.go</code> to call <code>runMigrations</code> (add <code>urlServiceSchema</code> const, <code>runMigrations</code> func as in §5.7).</li>\n<li>Extend <code>config.go</code> to add <code>JWTSecret</code>, <code>ShortURLBase</code>, <code>OutboxPollInterval</code>, <code>OutboxWorkerCount</code>.</li>\n<li>Run against Docker <code>url_db</code>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> up</span><span style=\"color:#9ECBFF\"> url_db</span><span style=\"color:#79B8FF\"> -d</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">DATABASE_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"postgres://urluser:urlpass@localhost:5432/urldb\"</span><span style=\"color:#B392F0\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">JWT_SECRET=</span><span style=\"color:#9ECBFF\">\"testjwtsecret-minimum-32-chars-long\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">SHORT_URL_BASE=</span><span style=\"color:#9ECBFF\">\"http://localhost:8081\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">go </span><span style=\"color:#9ECBFF\">run</span><span style=\"color:#9ECBFF\"> ./services/url-service/</span></span></code></pre></div>\n\n<ol>\n<li>Verify schema:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">psql</span><span style=\"color:#79B8FF\"> -h</span><span style=\"color:#9ECBFF\"> localhost</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 5432</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> urluser</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> urldb</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -c</span><span style=\"color:#9ECBFF\"> \"\\d urls; \\d outbox; \\di idx_urls_*; \\di idx_outbox_*;\"</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> Tables <code>urls</code> and <code>outbox</code> exist with correct columns and types. All four indexes visible in <code>\\di</code> output. Service exits 0 after migration.</p>\n<h3 id=\"phase-2-base62-encoder-shortcodegenerator-with-collision-retry-115h\">Phase 2: Base62 Encoder + <code>ShortCodeGenerator</code> with Collision Retry (1–1.5h)</h3>\n<ol>\n<li>Write <code>base62.go</code>: <code>base62Alphabet</code> constant, <code>Encode(*big.Int) string</code>, <code>Decode(string) (*big.Int, error)</code>.</li>\n<li>Write <code>codegen.go</code>: <code>ShortCodeGenerator</code>, <code>Generate() string</code>.</li>\n<li>Write initial tests in <code>url_test.go</code> (§10.1):<ul>\n<li><code>TestBase62RoundTrip</code></li>\n<li><code>TestBase62Length</code></li>\n<li><code>TestBase62Alphabet</code></li>\n<li><code>TestShortCodeUniqueness</code></li>\n</ul>\n</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./services/url-service/</span><span style=\"color:#79B8FF\"> -run</span><span style=\"color:#9ECBFF\"> TestBase62</span><span style=\"color:#79B8FF\"> -v</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./services/url-service/</span><span style=\"color:#79B8FF\"> -run</span><span style=\"color:#9ECBFF\"> TestShortCode</span><span style=\"color:#79B8FF\"> -v</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> All base62 and codegen tests pass. <code>Generate()</code> always returns exactly 7 characters from the base62 alphabet.</p>\n<h3 id=\"phase-3-post-shorten-handler-atomic-urloutbox-insert-225h\">Phase 3: <code>POST /shorten</code> Handler + Atomic URL+Outbox Insert (2–2.5h)</h3>\n<ol>\n<li>Write <code>errors.go</code>: sentinels, <code>writeError</code>, <code>writeJSON</code>, <code>isPgUniqueViolation</code>.</li>\n<li>Write <code>validate.go</code>: <code>validateURL</code>.</li>\n<li>Write <code>store.go</code>: <code>URLRecord</code>, <code>URLRepository</code> interface, <code>pgxURLStore</code> with <code>Insert</code> (unique violation detection).</li>\n<li>Write <code>outbox_store.go</code>: <code>OutboxRecord</code>, <code>OutboxRepository</code> interface, <code>pgxOutboxStore</code> with <code>InsertWithURL</code> and <code>InsertEvent</code>.</li>\n<li>Write <code>handler.go</code>: <code>Handler</code> struct, <code>NewHandler</code>, <code>Shorten</code> method (full algorithm from §5.2).</li>\n<li>Wire in <code>main.go</code>: construct all dependencies, register <code>POST /shorten</code> route with <code>JWTMiddleware</code>.</li>\n<li>Add <code>CorrelationIDMiddleware</code> and wrap the mux with it.</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Start infra</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> up</span><span style=\"color:#9ECBFF\"> url_db</span><span style=\"color:#9ECBFF\"> rabbitmq</span><span style=\"color:#9ECBFF\"> redis</span><span style=\"color:#79B8FF\"> -d</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Start service with env vars</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">DATABASE_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">...</span><span style=\"color:#E1E4E8\"> RABBITMQ_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">...</span><span style=\"color:#E1E4E8\"> REDIS_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">...</span><span style=\"color:#E1E4E8\"> JWT_SECRET</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">...</span><span style=\"color:#B392F0\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">SHORT_URL_BASE=</span><span style=\"color:#9ECBFF\">\"http://localhost:8081\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">go </span><span style=\"color:#9ECBFF\">run</span><span style=\"color:#9ECBFF\"> ./services/url-service/</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Test (get a token from user-service first, or generate a test JWT)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8081/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://example.com/very/long/path\"}'</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> <code>POST /shorten</code> returns <code>201</code> with <code>{short_code, short_url, original_url}</code>. PostgreSQL <code>urls</code> table has 1 row. <code>outbox</code> table has 1 row with <code>published_at = NULL</code>. Duplicate URL returns 201 with a different short code. Invalid URL returns 422.</p>\n<h3 id=\"phase-4-redis-cache-helpers-get-code-redirect-225h\">Phase 4: Redis Cache Helpers + <code>GET /:code</code> Redirect (2–2.5h)</h3>\n<ol>\n<li>Write <code>cache.go</code>: <code>CachedURL</code>, <code>RedisCache</code>, <code>Get/Set/Del</code> methods with full error isolation.</li>\n<li>Write <code>publisher.go</code>: <code>RabbitMQPublisher</code> interface, <code>amqpPublisher</code> with mutex.</li>\n<li>Add <code>Redirect</code> method to <code>handler.go</code> (full algorithm from §5.3).</li>\n<li>Register <code>GET /{code}</code> route in <code>main.go</code> (anonymous, no auth middleware).</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># After POST /shorten returned {\"short_code\":\"abc1234\", ...}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#9ECBFF\"> http://localhost:8081/abc1234</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: HTTP/1.1 301 Moved Permanently</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">#         Location: https://example.com/very/long/path</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Second request (cache hit)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#9ECBFF\"> http://localhost:8081/abc1234</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: same 301, served from Redis in &#x3C; 5ms</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Redis verification</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">redis-cli</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 6379</span><span style=\"color:#9ECBFF\"> GET</span><span style=\"color:#9ECBFF\"> \"url:abc1234\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: {\"original_url\":\"https://example.com/very/long/path\",\"is_active\":true}</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> First redirect: EXPLAIN ANALYZE on <code>SELECT ... WHERE short_code = $1</code> uses <code>idx_urls_short_code</code>. Second redirect: Redis <code>GET url:&lt;code&gt;</code> returns JSON (cache hit). <code>outbox</code> table gains 1 row with <code>event_type = &quot;url.clicked&quot;</code> and <code>published_at = NULL</code>. Non-existent code returns 404. Redis key for expired URL has TTL set correctly.</p>\n<h3 id=\"phase-5-get-urls-delete-urlscode-152h\">Phase 5: <code>GET /urls</code> + <code>DELETE /urls/:code</code> (1.5–2h)</h3>\n<ol>\n<li>Add <code>FindByUserID</code> to <code>pgxURLStore</code> (cursor pagination with <code>limit+1</code> trick).</li>\n<li>Add <code>Deactivate</code> to <code>pgxURLStore</code>.</li>\n<li>Add <code>ListURLs</code> and <code>DeleteURL</code> methods to <code>Handler</code>.</li>\n<li>Register routes in <code>main.go</code>.</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># List URLs</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> http://localhost:8081/urls</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: {\"urls\":[...],\"next_cursor\":null} (first page)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Pagination test (create 10+ URLs first)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> \"http://localhost:8081/urls?after=&#x3C;uuid_from_previous_response>\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Delete</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> DELETE</span><span style=\"color:#9ECBFF\"> http://localhost:8081/urls/abc1234</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: 204 No Content</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify deactivated</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> http://localhost:8081/abc1234</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: 410 Gone</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify Redis cleared</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">redis-cli</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 6379</span><span style=\"color:#9ECBFF\"> EXISTS</span><span style=\"color:#9ECBFF\"> \"url:abc1234\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: (integer) 0</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Delete wrong owner</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> DELETE</span><span style=\"color:#9ECBFF\"> http://localhost:8081/urls/abc1234</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$OTHER_USER_TOKEN</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: 403 Forbidden</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify outbox has URLDeletedEvent</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">psql</span><span style=\"color:#79B8FF\"> -h</span><span style=\"color:#9ECBFF\"> localhost</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 5432</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> urluser</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> urldb</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -c</span><span style=\"color:#9ECBFF\"> \"SELECT event_type, payload FROM outbox WHERE event_type = 'url.deleted';\"</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> <code>EXPLAIN ANALYZE</code> on <code>GET /urls</code> query shows <code>Index Scan using idx_urls_user_id_created</code>. Pagination cursor works correctly. DELETE sets <code>is_active=false</code> in DB. Outbox has <code>url.deleted</code> row. Redis key deleted. 403 returned for non-owner.</p>\n<h3 id=\"phase-6-outbox-coordinator-3-worker-pool-graceful-shutdown-225h\">Phase 6: Outbox Coordinator + 3-Worker Pool + Graceful Shutdown (2–2.5h)</h3>\n<ol>\n<li>Write <code>outbox.go</code>: <code>OutboxCoordinator</code>, <code>runWorker</code>, coordinator poll loop (algorithm from §5.5).</li>\n<li>Start coordinator in <code>main.go</code> before HTTP server.</li>\n<li>Wire <code>appCancel</code> to OS signal handler.</li>\n<li>Start <code>analytics-service</code> + <code>notification-service</code> (M1 skeletons) to receive messages.</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> up</span><span style=\"color:#79B8FF\"> --build</span><span style=\"color:#79B8FF\"> -d</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Shorten a URL</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8081/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://example.com\"}'</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Wait 3s for outbox poll</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 3</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify published</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">psql</span><span style=\"color:#79B8FF\"> -h</span><span style=\"color:#9ECBFF\"> localhost</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 5432</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> urluser</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> urldb</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -c</span><span style=\"color:#9ECBFF\"> \"SELECT event_type, published_at FROM outbox ORDER BY created_at DESC LIMIT 5;\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: url.created row with published_at != NULL</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Check RabbitMQ management UI</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># http://localhost:15672/#/queues → analytics.clicks and notifications.events</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># should show message counts incrementing</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> Outbox rows transition from <code>published_at = NULL</code> to <code>published_at = &lt;timestamp&gt;</code> within 2-5 seconds of creation. RabbitMQ management UI shows messages delivered to queues. Coordinator logs <code>&quot;outbox coordinator stopped&quot;</code> on SIGTERM. All workers exit cleanly (no goroutine leak).</p>\n<h3 id=\"phase-7-tests-benchmark-115h\">Phase 7: Tests + Benchmark (1–1.5h)</h3>\n<ol>\n<li>Complete <code>url_test.go</code> with all test cases from §10.</li>\n<li>Write <code>bench_test.go</code> with the redirect benchmark.</li>\n<li>Run all tests:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./services/url-service/...</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#79B8FF\"> -count=1</span></span></code></pre></div>\n\n<ol>\n<li>Run redirect benchmark:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./services/url-service/</span><span style=\"color:#79B8FF\"> -bench=BenchmarkRedirectCacheHit</span><span style=\"color:#79B8FF\"> -benchtime=30s</span><span style=\"color:#79B8FF\"> -benchmem</span></span></code></pre></div>\n\n<h2 id=\"checkpoint-all-unit-tests-pass-redirect-benchmark-reports-p99-lt-5ms-under-100-concurrent-simulated-requests-see-9-for-wrk-command\"><strong>Checkpoint:</strong> All unit tests pass. Redirect benchmark reports p99 &lt; 5ms under 100 concurrent simulated requests (see §9 for wrk command)</h2>\n<h2 id=\"9-test-specification\">9. Test Specification</h2>\n<h3 id=\"91-base62-tests-url_testgo\">9.1 Base62 Tests (<code>url_test.go</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestBase62RoundTrip</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cases </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">61</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">62</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">3521614606207</span><span style=\"color:#E1E4E8\">} </span><span style=\"color:#6A737D\">// 0, 1, last single-digit, first two-digit, max 7-char</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, n </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> cases {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Run</span><span style=\"color:#E1E4E8\">(fmt.</span><span style=\"color:#B392F0\">Sprintf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"n=</span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, n), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            encoded </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> Encode</span><span style=\"color:#E1E4E8\">(big.</span><span style=\"color:#B392F0\">NewInt</span><span style=\"color:#E1E4E8\">(n))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            decoded, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> Decode</span><span style=\"color:#E1E4E8\">(encoded)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Decode: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> decoded.</span><span style=\"color:#B392F0\">Int64</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> n {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"round trip: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, decoded.</span><span style=\"color:#B392F0\">Int64</span><span style=\"color:#E1E4E8\">(), n)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestBase62Length</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // All encoded values must be exactly 7 chars (left-padded)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, n </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">big</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Int</span><span style=\"color:#E1E4E8\">{big.</span><span style=\"color:#B392F0\">NewInt</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">), big.</span><span style=\"color:#B392F0\">NewInt</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">), big.</span><span style=\"color:#B392F0\">NewInt</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">61</span><span style=\"color:#E1E4E8\">)} {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        s </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> Encode</span><span style=\"color:#E1E4E8\">(n)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(s) </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 7</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Encode(</span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">) = </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> len=</span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">, want 7\"</span><span style=\"color:#E1E4E8\">, n, s, </span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(s))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestBase62Alphabet</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(base62Alphabet) </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 62</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"alphabet length: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 62\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(base62Alphabet))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    seen </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(base62Alphabet); i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        c </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> base62Alphabet[i]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> seen[c] {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"duplicate character </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> at index </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, c, i)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        seen[c] </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> true</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Must start with digits, then uppercase, then lowercase</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> base62Alphabet[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> '</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> base62Alphabet[</span><span style=\"color:#79B8FF\">9</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> '</span><span style=\"color:#79B8FF\">9</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"first 10 chars must be 0-9\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> base62Alphabet[</span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> '</span><span style=\"color:#79B8FF\">A</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> base62Alphabet[</span><span style=\"color:#79B8FF\">35</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> '</span><span style=\"color:#79B8FF\">Z</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"chars 10-35 must be A-Z\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> base62Alphabet[</span><span style=\"color:#79B8FF\">36</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> '</span><span style=\"color:#79B8FF\">a</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> base62Alphabet[</span><span style=\"color:#79B8FF\">61</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> '</span><span style=\"color:#79B8FF\">z</span><span style=\"color:#9ECBFF\">'</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"chars 36-61 must be a-z\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestShortCodeLength</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    g </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewShortCodeGenerator</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 1000</span><span style=\"color:#E1E4E8\">; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        code </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> g.</span><span style=\"color:#B392F0\">Generate</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(code) </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 7</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"generated code </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> has length </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">, want 7\"</span><span style=\"color:#E1E4E8\">, code, </span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(code))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestShortCodeAlphabet</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    g </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewShortCodeGenerator</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    valid </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(base62Alphabet); i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        valid[base62Alphabet[i]] </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> true</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 100</span><span style=\"color:#E1E4E8\">; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        code </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> g.</span><span style=\"color:#B392F0\">Generate</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        for</span><span style=\"color:#E1E4E8\"> _, c </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(code) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">valid[c] {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"invalid char </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> in code </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, c, code)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestShortCodeUniqueness</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    g </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewShortCodeGenerator</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    seen </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Generate 10,000 codes; collision probability at 10k ≈ 1.4% — acceptable for test</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // (we're testing the generator produces varied output, not that it's collision-free)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 10_000</span><span style=\"color:#E1E4E8\">; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        code </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> g.</span><span style=\"color:#B392F0\">Generate</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        seen[code] </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> true</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect at least 9990 unique codes out of 10,000</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(seen) </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 9990</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"too many collisions: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> unique codes from 10,000 generates\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(seen))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"92-validateurl-tests\">9.2 <code>validateURL</code> Tests</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestValidateURL</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cases </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        input   </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        wantErr </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"https://example.com\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"http://example.com/path?q=1\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"https://sub.domain.org/a/b/c\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},                            </span><span style=\"color:#6A737D\">// empty</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"not-a-url\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},                   </span><span style=\"color:#6A737D\">// no scheme</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"ftp://example.com\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},           </span><span style=\"color:#6A737D\">// non-http scheme</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"http://\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},                     </span><span style=\"color:#6A737D\">// scheme but no host</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"//example.com\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},               </span><span style=\"color:#6A737D\">// no scheme</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"javascript:alert(1)\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},         </span><span style=\"color:#6A737D\">// non-http scheme</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, tc </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> cases {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Run</span><span style=\"color:#E1E4E8\">(tc.input, </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> validateURL</span><span style=\"color:#E1E4E8\">(tc.input)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> (err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> tc.wantErr {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"validateURL(</span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">) err=</span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\"> wantErr=</span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, tc.input, err, tc.wantErr)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"93-handler-unit-tests-with-mock-stores\">9.3 Handler Unit Tests (with mock stores)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// Mock implementations</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> mockURLStore</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    insertFn       </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">rec</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">URLRecord</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">URLRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    findByCodeFn   </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">code</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">URLRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    findByUserIDFn </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">userID</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">afterID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">limit</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">URLRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    deactivateFn   </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">code</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">userID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// (implement URLRepository interface — each method delegates to respective Fn)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> mockOutboxStore</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    insertWithURLFn </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">u</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">URLRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">o</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">OutboxRecord</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    insertEventFn   </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">o</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">OutboxRecord</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    fetchFn         </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">limit</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">OutboxRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    markFn          </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">id</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestShortenHandler_Success</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Verify: 201 response, short_code 7 chars, short_url has base prefix</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestShortenHandler_InvalidURL</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Input: {\"url\": \"not-a-url\"}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 422 with field=\"url\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestShortenHandler_ExpiredExpiresAt</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Input: expires_at = one hour ago</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 422</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestShortenHandler_CustomCodeConflict</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // mockOutboxStore.insertWithURLFn returns ErrShortCodeConflict</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // req.custom_code = \"mycode\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 409, no retry</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestShortenHandler_AutoCodeCollisionExhausted</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // insertWithURLFn always returns ErrShortCodeConflict</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // req has no custom_code</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 503 after 5 attempts (verify mock called exactly 5 times)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedirectHandler_CacheHit_Active</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // mockCache.Get returns &#x26;CachedURL{OriginalURL:\"https://x.com\", IsActive:true}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 301 Location: https://x.com; no DB call (mockURLStore.findByCode not called)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedirectHandler_CacheHit_Inactive</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // cached.IsActive = false</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 410</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedirectHandler_CacheMiss_Active</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // cache returns miss; store returns active URLRecord</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 301; cache.Set called</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedirectHandler_CacheMiss_NotFound</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // cache miss; store returns ErrURLNotFound</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 404</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedirectHandler_CacheMiss_Expired</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // cache miss; store returns URLRecord with ExpiresAt = 1 hour ago</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 410; cache.Set NOT called</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDeleteHandler_Success</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // store returns owned URLRecord; deactivate succeeds; outbox insert succeeds</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 204; cache.Del called</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDeleteHandler_NotFound</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // deactivate returns ErrURLNotFound</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 404</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestDeleteHandler_WrongOwner</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // urlRec.UserID != claims.Sub</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 403</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestListURLsHandler_EmptyPage</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // store.FindByUserID returns empty slice, \"\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 200 {\"urls\":[],\"next_cursor\":null}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestListURLsHandler_WithNextCursor</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // store returns 20 items and nextCursor = \"some-uuid\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 200 {\"urls\":[...],\"next_cursor\":\"some-uuid\"}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"94-rediscache-unit-tests\">9.4 <code>RedisCache</code> Unit Tests</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedisCache_GetMiss</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Use miniredis (github.com/alicebob/miniredis/v2) for in-process Redis</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mr </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> miniredis.</span><span style=\"color:#B392F0\">RunT</span><span style=\"color:#E1E4E8\">(t)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> redis.</span><span style=\"color:#B392F0\">NewClient</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Options</span><span style=\"color:#E1E4E8\">{Addr: mr.</span><span style=\"color:#B392F0\">Addr</span><span style=\"color:#E1E4E8\">()})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cache </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewRedisCache</span><span style=\"color:#E1E4E8\">(client, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    result, hit </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cache.</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"nonexistent\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> hit </span><span style=\"color:#F97583\">||</span><span style=\"color:#E1E4E8\"> result </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected cache miss\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedisCache_SetThenGet</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mr </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> miniredis.</span><span style=\"color:#B392F0\">RunT</span><span style=\"color:#E1E4E8\">(t)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> redis.</span><span style=\"color:#B392F0\">NewClient</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Options</span><span style=\"color:#E1E4E8\">{Addr: mr.</span><span style=\"color:#B392F0\">Addr</span><span style=\"color:#E1E4E8\">()})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cache </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewRedisCache</span><span style=\"color:#E1E4E8\">(client, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cu </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">CachedURL</span><span style=\"color:#E1E4E8\">{OriginalURL: </span><span style=\"color:#9ECBFF\">\"https://example.com\"</span><span style=\"color:#E1E4E8\">, IsActive: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cache.</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"abc1234\"</span><span style=\"color:#E1E4E8\">, cu, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    result, hit </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cache.</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"abc1234\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">hit {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatal</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected cache hit\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> result.OriginalURL </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"https://example.com\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"url: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, result.OriginalURL)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedisCache_Del</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mr </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> miniredis.</span><span style=\"color:#B392F0\">RunT</span><span style=\"color:#E1E4E8\">(t)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> redis.</span><span style=\"color:#B392F0\">NewClient</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Options</span><span style=\"color:#E1E4E8\">{Addr: mr.</span><span style=\"color:#B392F0\">Addr</span><span style=\"color:#E1E4E8\">()})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cache </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewRedisCache</span><span style=\"color:#E1E4E8\">(client, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cu </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">CachedURL</span><span style=\"color:#E1E4E8\">{OriginalURL: </span><span style=\"color:#9ECBFF\">\"https://example.com\"</span><span style=\"color:#E1E4E8\">, IsActive: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cache.</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"abc1234\"</span><span style=\"color:#E1E4E8\">, cu, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cache.</span><span style=\"color:#B392F0\">Del</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"abc1234\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    _, hit </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cache.</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"abc1234\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> hit {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected cache miss after Del\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedisCache_TTL_WithExpiry</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mr </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> miniredis.</span><span style=\"color:#B392F0\">RunT</span><span style=\"color:#E1E4E8\">(t)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> redis.</span><span style=\"color:#B392F0\">NewClient</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Options</span><span style=\"color:#E1E4E8\">{Addr: mr.</span><span style=\"color:#B392F0\">Addr</span><span style=\"color:#E1E4E8\">()})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cache </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewRedisCache</span><span style=\"color:#E1E4E8\">(client, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ExpiresAt 30 minutes from now → TTL should be ≈ 30min (&#x3C; 1h)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    expiresAt </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Add</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Minute)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cache.</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"code1\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">CachedURL</span><span style=\"color:#E1E4E8\">{OriginalURL: </span><span style=\"color:#9ECBFF\">\"x\"</span><span style=\"color:#E1E4E8\">, IsActive: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">}, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">expiresAt)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // miniredis doesn't check exact TTL but we can verify key exists</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    _, hit </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cache.</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"code1\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">hit {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected hit for unexpired key\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Fast-forward 31 minutes in miniredis</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mr.</span><span style=\"color:#B392F0\">FastForward</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">31</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Minute)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    _, hit </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> cache.</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"code1\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> hit {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected cache miss after TTL expiry\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRedisCache_ErrorIsolation</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Closed Redis client — verify Get returns (nil, false), not panics</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> redis.</span><span style=\"color:#B392F0\">NewClient</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Options</span><span style=\"color:#E1E4E8\">{Addr: </span><span style=\"color:#9ECBFF\">\"localhost:1\"</span><span style=\"color:#E1E4E8\">}) </span><span style=\"color:#6A737D\">// nothing listening</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cache </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewRedisCache</span><span style=\"color:#E1E4E8\">(client, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    result, hit </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cache.</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"code\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> hit </span><span style=\"color:#F97583\">||</span><span style=\"color:#E1E4E8\"> result </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected miss for unreachable Redis\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Del should not panic</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cache.</span><span style=\"color:#B392F0\">Del</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"code\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"95-outbox-worker-test\">9.5 Outbox Worker Test</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestOutboxWorker_PublishAndMark</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    published </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    marked </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> mu </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Mutex</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    publisher </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockPublisher</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        publishFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">routingKey</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">body</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">(); published </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> append</span><span style=\"color:#E1E4E8\">(published, routingKey); mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockOutboxStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        markFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">id</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">(); marked </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> append</span><span style=\"color:#E1E4E8\">(marked, id); mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ch </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">chan</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">OutboxRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ch </span><span style=\"color:#F97583\">&#x3C;-</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">OutboxRecord</span><span style=\"color:#E1E4E8\">{ID: </span><span style=\"color:#9ECBFF\">\"outbox-1\"</span><span style=\"color:#E1E4E8\">, EventType: </span><span style=\"color:#9ECBFF\">\"url.created\"</span><span style=\"color:#E1E4E8\">, Payload: []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`{}`</span><span style=\"color:#E1E4E8\">)}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    close</span><span style=\"color:#E1E4E8\">(ch)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> wg </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">WaitGroup</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    wg.</span><span style=\"color:#B392F0\">Add</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    go</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        defer</span><span style=\"color:#E1E4E8\"> wg.</span><span style=\"color:#B392F0\">Done</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Simulate a single worker run</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ctx </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        for</span><span style=\"color:#E1E4E8\"> row </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> ch {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            publisher.</span><span style=\"color:#B392F0\">Publish</span><span style=\"color:#E1E4E8\">(ctx, row.EventType, row.Payload)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            store.</span><span style=\"color:#B392F0\">MarkPublished</span><span style=\"color:#E1E4E8\">(ctx, row.ID)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    wg.</span><span style=\"color:#B392F0\">Wait</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(published) </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> published[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"url.created\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"published: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, published)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(marked) </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> marked[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"outbox-1\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"marked: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, marked)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestOutboxWorker_PublishFail_NoMark</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // If publish fails, MarkPublished must NOT be called (row stays unpublished for retry)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    markCalled </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> false</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    publisher </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockPublisher</span><span style=\"color:#E1E4E8\">{publishFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"amqp error\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockOutboxStore</span><span style=\"color:#E1E4E8\">{markFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        markCalled </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> true</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ... run worker with one row, publish fails ...</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> markCalled {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"MarkPublished must not be called when Publish fails\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"96-benchmark-bench_testgo\">9.6 Benchmark (<code>bench_test.go</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// +build integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Run: DATABASE_URL=... REDIS_URL=... go test -bench=BenchmarkRedirectCacheHit -benchtime=30s</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkRedirectCacheHit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Setup: insert a URL record and warm the Redis cache</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ...</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b.</span><span style=\"color:#B392F0\">ResetTimer</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b.</span><span style=\"color:#B392F0\">SetParallelism</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">100</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b.</span><span style=\"color:#B392F0\">RunParallel</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">pb</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">PB</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        for</span><span style=\"color:#E1E4E8\"> pb.</span><span style=\"color:#B392F0\">Next</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/\"</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">shortCode, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            handler.</span><span style=\"color:#B392F0\">Redirect</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 301</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                b.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected 301, got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, rec.Code)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>wrk-based end-to-end benchmark:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Warm the cache first:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> http://localhost:8081/</span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#9ECBFF\">cod</span><span style=\"color:#E1E4E8\">e</span><span style=\"color:#F97583\">></span><span style=\"color:#F97583\"> ></span><span style=\"color:#9ECBFF\"> /dev/null</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Then benchmark:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">wrk</span><span style=\"color:#79B8FF\"> -t4</span><span style=\"color:#79B8FF\"> -c100</span><span style=\"color:#79B8FF\"> -d30s</span><span style=\"color:#9ECBFF\"> http://localhost:8081/</span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#9ECBFF\">cod</span><span style=\"color:#E1E4E8\">e</span><span style=\"color:#F97583\">></span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Target: Latency 99% &#x3C; 5ms in \"Latency Distribution\" output</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-15.svg\" alt=\"POST /shorten Atomic Transaction: URL Insert + Outbox Insert\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Request lifecycle for GET /:code (cache hit path):\n  Client ──► url-service handler\n                │\n                ▼\n         CorrelationIDMiddleware (read/generate X-Correlation-ID)\n                │\n                ▼\n         RedisCache.Get(&quot;url:&lt;code&gt;&quot;) ──► Redis (50ms timeout ctx)\n                │                             │\n           cache hit                     cache miss or error\n                │                             │\n                ▼                             ▼\n         Check IsActive, ExpiresAt    pgxURLStore.FindByCode()\n                │                             │\n           expired/inactive              active URL\n                │                             │\n                ▼                             ▼\n              410                    RedisCache.Set() (100ms timeout ctx)\n                                              │\n                                              ▼\n                                    Insert URLClickedEvent to outbox\n                                    (separate tx, non-fatal)\n                                              │\n                                              ▼\n                                     301 Location: &lt;original_url&gt;</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-16.svg\" alt=\"GET /:code Read-Through Cache State Machine\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Transaction boundaries:\n  POST /shorten:\n  ┌─────────────────────────────────┐\n  │ BEGIN                           │\n  │   INSERT INTO urls (...)        │  ← URLRecord populated from RETURNING\n  │   INSERT INTO outbox (...)      │  ← URLCreatedEvent payload\n  │ COMMIT  ──► or ROLLBACK         │\n  └─────────────────────────────────┘\n  (one transaction, two tables, same url_db)\n  GET /:code (click event):\n  ┌─────────────────────────────────┐\n  │ BEGIN                           │\n  │   INSERT INTO outbox (...)      │  ← URLClickedEvent\n  │ COMMIT                          │\n  └─────────────────────────────────┘\n  (separate transaction; redirect response sent regardless of outcome)\n  DELETE /urls/:code:\n  ┌─────────────────────────────────┐\n  │ BEGIN                           │\n  │   SELECT ... FROM urls          │  ← read for ownership check\n  │   UPDATE urls SET is_active=false│\n  │   INSERT INTO outbox (...)      │  ← URLDeletedEvent\n  │ COMMIT                          │\n  └─────────────────────────────────┘\n  Post-commit: Redis DEL (best-effort, outside tx)</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-17.svg\" alt=\"Redis Cache Entry Format and TTL Calculation\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Cursor-based pagination for GET /urls:\n  First page (afterID = &quot;&quot;):\n    SELECT ... FROM urls\n    WHERE user_id = $1\n    ORDER BY created_at DESC, id DESC\n    LIMIT 21   ← limit+1 to detect next page\n    If 21 rows returned: nextCursor = rows[20].ID, return rows[:20]\n    If ≤20 rows:          nextCursor = &quot;&quot;,           return all rows\n  Second page (afterID = &quot;&lt;uuid&gt;&quot;):\n    SELECT ... FROM urls\n    WHERE user_id = $1\n      AND (created_at, id) &lt; (SELECT created_at, id FROM urls WHERE id = $2)\n    ORDER BY created_at DESC, id DESC\n    LIMIT 21\n  Index used: idx_urls_user_id_created ON urls(user_id, created_at DESC)\n  PostgreSQL can use this index for the WHERE user_id = $1 + ORDER BY created_at DESC.\n  The subquery for cursor resolution performs a single PK lookup.</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-18.svg\" alt=\"Outbox Worker Pool Architecture and Data Flow\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Outbox coordinator poll cycle:\n  t=0s:  FetchUnpublished(limit=50)\n         rows = [r1, r2, r3] (3 unpublished events)\n         workerCh &lt;- r1  ──► Worker-1 picks up r1\n         workerCh &lt;- r2  ──► Worker-2 picks up r2\n         workerCh &lt;- r3  ──► Worker-3 picks up r3\n  t=0.1s: Workers publish to RabbitMQ concurrently\n           Worker-1: Publish(&quot;url.created&quot;, r1.Payload) → OK → MarkPublished(r1.ID)\n           Worker-2: Publish(&quot;url.clicked&quot;, r2.Payload) → OK → MarkPublished(r2.ID)\n           Worker-3: Publish(&quot;url.deleted&quot;, r3.Payload) → FAIL → log + skip mark\n  t=2s:  FetchUnpublished(limit=50)\n         rows = [r3] (r3 still has published_at = NULL)\n         workerCh &lt;- r3  ──► Worker-1 picks up r3 (retry)\n         Worker-1: Publish(&quot;url.deleted&quot;, r3.Payload) → OK → MarkPublished(r3.ID)</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-19.svg\" alt=\"Outbox Worker Pool Sequence: Coordinator to Workers\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Short code generation probability analysis:\n  Base62 space: 62^7 = 3,521,614,606,208 ≈ 3.5 trillion codes\n  After N URLs inserted, collision probability on single attempt:\n    P(collision) ≈ N / 62^7\n  At N = 1,000,000 (1M URLs):\n    P(single collision) ≈ 2.84 × 10^-7 per attempt\n    P(all 5 attempts collide) ≈ (2.84e-7)^5 ≈ 4.5 × 10^-33\n  At N = 1,000,000,000 (1B URLs, 28.4% of space):\n    P(single collision) ≈ 0.284\n    P(all 5 attempts collide) ≈ 0.284^5 ≈ 0.18% → 503 error rate 0.18%\n    (At this scale, a longer code or different strategy is warranted)\n  For the scope of this project (&lt; 1M URLs): 5 retries is more than sufficient.</code></pre></div>\n\n<hr>\n<h2 id=\"10-performance-targets\">10. Performance Targets</h2>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>Target</th>\n<th>How to Measure</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>GET /:code</code> cache hit</td>\n<td>&lt; 5ms p99 under 100 concurrent requests</td>\n<td><code>wrk -t4 -c100 -d30s http://localhost:8081/&lt;warm-code&gt;</code> → Latency 99th &lt; 5ms</td>\n</tr>\n<tr>\n<td><code>GET /:code</code> cache miss</td>\n<td>&lt; 20ms p99</td>\n<td>Flush Redis key, then <code>wrk -t4 -c10 -d10s</code> (low concurrency to force misses)</td>\n</tr>\n<tr>\n<td><code>POST /shorten</code> (single tx: URL + outbox)</td>\n<td>&lt; 50ms p99</td>\n<td><code>wrk -t2 -c10 -d30s -s shorten.lua http://localhost:8081/shorten</code></td>\n</tr>\n<tr>\n<td><code>GET /urls</code> page 1 (cold, 20 results)</td>\n<td>&lt; 10ms p99</td>\n<td><code>EXPLAIN ANALYZE SELECT ... LIMIT 21</code> must show Index Scan on idx_urls_user_id_created</td>\n</tr>\n<tr>\n<td>Outbox poll-to-publish latency</td>\n<td>&lt; 5s</td>\n<td>Create URL → poll RabbitMQ management API until queue depth increases; time delta</td>\n</tr>\n<tr>\n<td><code>DELETE /urls/:code</code> (tx + cache del)</td>\n<td>&lt; 20ms p99</td>\n<td>Curl timing: <code>time curl -X DELETE ...</code></td>\n</tr>\n<tr>\n<td>Short code generation (single)</td>\n<td>&lt; 1ms</td>\n<td><code>go test -bench=BenchmarkGenerate -benchtime=10s</code> → ns/op &lt; 1,000,000</td>\n</tr>\n<tr>\n<td>Outbox coordinator memory</td>\n<td>&lt; 50MB steady-state</td>\n<td><code>docker stats url-service-1</code> after 10 minutes of load</td>\n</tr>\n</tbody></table>\n<p><strong>EXPLAIN ANALYZE verification:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">psql</span><span style=\"color:#79B8FF\"> -h</span><span style=\"color:#9ECBFF\"> localhost</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 5432</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> urluser</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> urldb</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">EXPLAIN ANALYZE</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">SELECT id, short_code, original_url, user_id, created_at, expires_at, is_active</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">FROM urls</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">WHERE user_id = 'some-uuid'</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">ORDER BY created_at DESC, id DESC</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">LIMIT 21;</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Must show: Index Scan using idx_urls_user_id_created on urls</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Must NOT show: Seq Scan</span></span></code></pre></div>\n\n<p><strong>Short code generation benchmark:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkShortCodeGenerate</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    g </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewShortCodeGenerator</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b.</span><span style=\"color:#B392F0\">ResetTimer</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#E1E4E8\"> b.N; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        g.</span><span style=\"color:#B392F0\">Generate</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Expected: ~1-5 µs/op (crypto/rand + big.Int arithmetic)</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-20.svg\" alt=\"Cursor-Based Pagination Query Plan\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Performance budget for GET /:code cache hit path:\n  ┌─────────────────────────────────────────────────────────┐\n  │ Network recv + HTTP parse:          ~0.1ms              │\n  │ CorrelationIDMiddleware:            &lt;0.1ms              │\n  │ RedisCache.Get (50ms ctx):          ~0.5ms (LAN Redis)  │ ← dominates\n  │ JSON unmarshal CachedURL:           &lt;0.1ms              │\n  │ is_active + expiry check:           &lt;0.01ms             │\n  │ http.Redirect (write headers):      ~0.1ms              │\n  │ Network send:                       ~0.1ms              │\n  │ TOTAL:                              ~1ms typical        │\n  │                                     &lt;5ms p99 ✓          │\n  └─────────────────────────────────────────────────────────┘\nPerformance budget for GET /:code cache miss path:\n  ┌─────────────────────────────────────────────────────────┐\n  │ RedisCache.Get (miss):              ~0.5ms              │\n  │ pgxpool.Acquire:                    ~0.1ms (warm pool)  │\n  │ pgx QueryRow (idx_urls_short_code): ~1-3ms (LAN PG)    │ ← dominates\n  │ RedisCache.Set:                     ~0.5ms (async-ish)  │\n  │ Begin outbox tx + Insert + Commit:  ~2-5ms              │\n  │ http.Redirect:                      ~0.1ms              │\n  │ TOTAL:                              ~5-10ms typical     │\n  │                                     &lt;20ms p99 ✓         │\n  └─────────────────────────────────────────────────────────┘</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-21.svg\" alt=\"DELETE /urls/:code Sequence with Ownership Check and Cache Invalidation\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>go.mod additions for url-service (M3):\n  (from M1): github.com/jackc/pgx/v5 v5.6.0\n             github.com/redis/go-redis/v9 v9.6.0\n             github.com/rabbitmq/amqp091-go v1.10.0\n  (from M2): github.com/yourhandle/url-shortener/shared/auth\n             github.com/golang-jwt/jwt/v5 v5.2.1\n  (new M3):  math/big — stdlib, no dependency\n             crypto/rand — stdlib, no dependency\n             github.com/alicebob/miniredis/v2 v2.32.0  (test only)\n  All require in go.mod:\n    require (\n        github.com/yourhandle/url-shortener/shared/auth v0.0.0\n        github.com/yourhandle/url-shortener/shared/events v0.0.0\n        github.com/yourhandle/url-shortener/shared/logger v0.0.0\n        github.com/jackc/pgx/v5 v5.6.0\n        github.com/redis/go-redis/v9 v9.6.0\n        github.com/rabbitmq/amqp091-go v1.10.0\n        github.com/golang-jwt/jwt/v5 v5.2.1\n        github.com/alicebob/miniredis/v2 v2.32.0\n    )\n  docker-compose.yml additions for url-service environment:\n    JWT_SECRET: &quot;change-this-in-production-minimum-32-chars&quot;\n    SHORT_URL_BASE: &quot;http://localhost:8080&quot;   ← or gateway URL in M5\n    IP_HASH_SALT: &quot;change-this-random-salt&quot;</code></pre></div>\n\n<hr>\n<h2 id=\"11-anti-pattern-guard\">11. Anti-Pattern Guard</h2>\n<p>The following checks must pass before this module is considered complete:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># 1. No shared DB: url-service must ONLY connect to url_db</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">grep</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> \"analytics_db\\|user_db\\|notification_db\"</span><span style=\"color:#9ECBFF\"> services/url-service/</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#79B8FF\"> echo</span><span style=\"color:#9ECBFF\"> \"PASS\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># 2. No synchronous analytics call</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">grep</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> \"analytics-service\\|analytics_service\\|8082\"</span><span style=\"color:#9ECBFF\"> services/url-service/</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#79B8FF\"> echo</span><span style=\"color:#9ECBFF\"> \"PASS\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># 3. crypto/rand only (no math/rand in production code)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">grep</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> \"math/rand\"</span><span style=\"color:#9ECBFF\"> services/url-service/</span><span style=\"color:#79B8FF\">*</span><span style=\"color:#9ECBFF\">.go</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#9ECBFF\"> \"_test.go\"</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#79B8FF\"> echo</span><span style=\"color:#9ECBFF\"> \"PASS\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># 4. No unbounded Redis TTL</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Verify Set always calls with non-zero TTL:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">grep</span><span style=\"color:#79B8FF\"> -A5</span><span style=\"color:#9ECBFF\"> \"client.Set\"</span><span style=\"color:#9ECBFF\"> services/url-service/cache.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Must show TTL parameter is never 0 or redis.KeepTTL except the 1s guard case</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># 5. Outbox and URL write in same transaction (POST /shorten)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Review handler.go: BEGIN → InsertWithURL (urls + outbox) → COMMIT</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Both tables must appear inside the same pool.Begin() ... tx.Commit() scope</span></span></code></pre></div>\n\n<hr>\n<!-- END_TDD_MOD -->\n\n<!-- TDD_MOD_ID: url-shortener-m4 -->\n\n<h1 id=\"analytics-service-click-ingestion-stats-api\">Analytics Service: Click Ingestion + Stats API</h1>\n<h2 id=\"module-id-url-shortener-m4\"><strong>Module ID:</strong> <code>url-shortener-m4</code></h2>\n<h2 id=\"1-module-charter\">1. Module Charter</h2>\n<p>This module implements the Analytics Service as a self-contained read-model consumer. It owns the <code>clicks</code>, <code>milestones</code>, and <code>processed_events</code> tables in its dedicated PostgreSQL instance (<code>analytics_db</code>), subscribes to the <code>analytics.clicks</code> queue on RabbitMQ, processes <code>URLClickedEvent</code> messages with at-least-once semantics, deduplicates by <code>event_id</code>, inserts anonymized click records, checks milestone thresholds (10, 100, 1000 clicks per short code), publishes <code>MilestoneReachedEvent</code> back to RabbitMQ when thresholds are crossed, and exposes two public (unauthenticated) HTTP endpoints for click statistics.\nThis module does <strong>not</strong> call the URL Service to validate <code>short_code</code> — it trusts the event. It does <strong>not</strong> store user PII — IP addresses are stored as SHA-256 hashes, never raw. It does <strong>not</strong> issue or verify JWTs — both <code>/stats</code> endpoints are public. It does <strong>not</strong> write to any database other than <code>analytics_db</code>. It does <strong>not</strong> implement the outbox pattern for <code>MilestoneReachedEvent</code> — publish failure is logged and the milestone row remains committed; the event may be re-triggered if the next click re-checks the threshold (thresholds are idempotent via <code>milestones</code> table). It does <strong>not</strong> implement a worker pool — a single sequential consumer goroutine with AMQP <code>prefetch=1</code> provides serialized processing without race conditions.\n<strong>Upstream dependencies:</strong> <code>shared/events</code> (event struct definitions), <code>shared/logger</code> (structured JSON logger), <code>NewRabbitMQConn</code> and <code>DeclareAnalyticsQueue</code> (from M1 <code>analytics-service/rabbitmq.go</code>), <code>analytics_db</code> PostgreSQL instance, <code>NewDBPool</code> (from M1).\n<strong>Downstream consumers:</strong> <code>notification-service</code> consumes <code>MilestoneReachedEvent</code> from <code>notifications.events</code> queue (bound to routing key <code>milestone.reached</code>). The analytics service publishes this event directly on the AMQP channel — not via the outbox — because the analytics DB is the authoritative source and the milestone row is already committed before publish is attempted.\n<strong>Invariants that must always hold:</strong></p>\n<ul>\n<li>A <code>URLClickedEvent</code> with a previously seen <code>event_id</code> is <strong>silently acknowledged and discarded</strong> — click count never increments more than once per event.</li>\n<li>Click insert, processed_event insert, and milestone insert (when triggered) all occur in <strong>one database transaction</strong> — no partial state.</li>\n<li>A malformed/unparseable AMQP message body is <strong>acknowledged</strong> (not nacked) to prevent infinite requeue loops; it is logged as a poison message.</li>\n<li>The <code>/health</code> endpoint returns <code>200 {&quot;status&quot;:&quot;ok&quot;}</code> even when the RabbitMQ consumer is temporarily paused due to connection drop.</li>\n<li><code>MilestoneReachedEvent</code> publish failure never causes the consumer to crash or nack the originating click message — the milestone row is already durable.</li>\n<li><code>ip_hash</code> is always <code>SHA-256(raw_ip + salt)</code> — the raw IP never enters the database.</li>\n</ul>\n<hr>\n<h2 id=\"2-file-structure\">2. File Structure</h2>\n<p>Create files in the numbered order below. Shared packages exist from M1/M2/M3; only analytics-service files are new here.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>url-shortener/\n│\n├── shared/                                 ← unchanged from prior milestones\n│   ├── events/events.go\n│   ├── auth/auth.go + middleware.go\n│   └── logger/logger.go\n│\n└── services/\n    └── analytics-service/\n        ├── (from M1, extended)\n        │   ├── go.mod                      ← add dependencies (see §6.3 / §10)\n        │   ├── main.go                     ← extend: wire consumer, start goroutine\n        │   ├── config.go                   ← extend: add IPHashSalt, MilestoneThresholds\n        │   ├── db.go                       ← unchanged from M1 (NewDBPool reused)\n        │   ├── rabbitmq.go                 ← extend: add DeclareAnalyticsQueue (already in M1)\n        │   └── health.go                   ← unchanged from M1\n        │\n        ├── 1.  migration.sql               ← clicks, milestones, processed_events + indexes\n        ├── 2.  store.go                    ← ClickRepository, MilestoneRepository, DeduplicationRepository interfaces + pgx implementations\n        ├── 3.  consumer.go                 ← ClickConsumer struct, Run(), message loop, panic recovery\n        ├── 4.  milestone.go                ← MilestoneChecker, CheckAndPublish, threshold constants\n        ├── 5.  publisher.go                ← AnalyticsPublisher interface + amqpAnalyticsPublisher (mirrors url-service/publisher.go pattern)\n        ├── 6.  handler.go                  ← StatsHandler, TimelineHandler, route registration helper\n        ├── 7.  errors.go                   ← writeError, writeJSON helpers, sentinel errors\n        ├── 8.  haship.go                   ← hashIP(remoteAddr, salt) string\n        └── 9.  analytics_test.go           ← unit + integration tests</code></pre></div>\n\n<hr>\n<h2 id=\"3-complete-data-model\">3. Complete Data Model</h2>\n<h3 id=\"31-postgresql-schema-migrationsql\">3.1 PostgreSQL Schema (<code>migration.sql</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- ── clicks table ──────────────────────────────────────────────────────────────</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> clicks (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    id          UUID        </span><span style=\"color:#F97583\">PRIMARY KEY</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#E1E4E8\"> gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    short_code  </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    clicked_at  </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\"> NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ip_hash     </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#E1E4E8\">,    </span><span style=\"color:#6A737D\">-- SHA-256(raw_ip + salt); never raw IP</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    user_agent  </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#9ECBFF\"> ''</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    referer     </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NULL</span><span style=\"color:#6A737D\">        -- NULL when no Referer header was present</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Primary query path: aggregate clicks per code in time windows.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- date_trunc bucketing and COUNT(*) both benefit from this index.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_clicks_short_code_time</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    ON</span><span style=\"color:#E1E4E8\"> clicks(short_code, clicked_at </span><span style=\"color:#F97583\">DESC</span><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Top-referers query: partial index omits rows with no referer (saves space).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_clicks_referer</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    ON</span><span style=\"color:#E1E4E8\"> clicks(short_code, referer)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    WHERE</span><span style=\"color:#E1E4E8\"> referer </span><span style=\"color:#F97583\">IS NOT NULL</span><span style=\"color:#E1E4E8\">;</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- ── milestones table ──────────────────────────────────────────────────────────</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> milestones (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    id            UUID        </span><span style=\"color:#F97583\">PRIMARY KEY</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#E1E4E8\"> gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    short_code    </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    milestone     </span><span style=\"color:#F97583\">INT</span><span style=\"color:#F97583\">         NOT NULL</span><span style=\"color:#E1E4E8\">,   </span><span style=\"color:#6A737D\">-- 10 | 100 | 1000</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    triggered_at  </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\"> NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    UNIQUE</span><span style=\"color:#E1E4E8\"> (short_code, milestone)        </span><span style=\"color:#6A737D\">-- exactly one row per (code, threshold)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Lookup: has this code already crossed a given milestone?</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> UNIQUE INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_milestones_code_milestone</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    ON</span><span style=\"color:#E1E4E8\"> milestones(short_code, milestone);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- ── processed_events table (deduplication) ────────────────────────────────────</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> processed_events (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    event_id    </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        PRIMARY KEY</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#6A737D\">-- events.BaseEvent.EventID (UUID v4 string)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    processed_at </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\"> NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- No additional index needed — PRIMARY KEY gives the O(log n) lookup we need.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Retention: rows here grow indefinitely for this project. A production system</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- would partition by processed_at and drop old partitions after TTL.</span></span></code></pre></div>\n\n<p><strong>Column rationale:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Column</th>\n<th>Type</th>\n<th>Constraint</th>\n<th>Rationale</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>clicks.id</code></td>\n<td>UUID</td>\n<td>PK</td>\n<td>Unique row identity; not exposed in API</td>\n</tr>\n<tr>\n<td><code>clicks.short_code</code></td>\n<td>TEXT</td>\n<td>NOT NULL</td>\n<td>Denormalized from event; analytics DB has no FK to url_db (no cross-DB joins)</td>\n</tr>\n<tr>\n<td><code>clicks.clicked_at</code></td>\n<td>TIMESTAMPTZ</td>\n<td>NOT NULL</td>\n<td>From <code>URLClickedEvent.ClickedAt</code>; used for time-window aggregation and <code>date_trunc</code></td>\n</tr>\n<tr>\n<td><code>clicks.ip_hash</code></td>\n<td>TEXT</td>\n<td>NOT NULL</td>\n<td>SHA-256(IP+salt) — 64-char hex string; GDPR-safe; salted to prevent rainbow table lookup</td>\n</tr>\n<tr>\n<td><code>clicks.user_agent</code></td>\n<td>TEXT</td>\n<td>NOT NULL DEFAULT &#39;&#39;</td>\n<td>From event; empty string when absent (not NULL — avoids NULL handling complexity in aggregations)</td>\n</tr>\n<tr>\n<td><code>clicks.referer</code></td>\n<td>TEXT</td>\n<td>NULL</td>\n<td>NULL when absent; partial index on non-NULL rows for top-referers query</td>\n</tr>\n<tr>\n<td><code>milestones.short_code</code></td>\n<td>TEXT</td>\n<td>NOT NULL</td>\n<td>Denormalized; no FK</td>\n</tr>\n<tr>\n<td><code>milestones.milestone</code></td>\n<td>INT</td>\n<td>NOT NULL</td>\n<td>Must be one of {10, 100, 1000}; enforced in application layer, not DB constraint</td>\n</tr>\n<tr>\n<td><code>milestones.UNIQUE(short_code, milestone)</code></td>\n<td>—</td>\n<td>—</td>\n<td>Prevents double-recording the same milestone; INSERT ... ON CONFLICT DO NOTHING is idempotent</td>\n</tr>\n<tr>\n<td><code>processed_events.event_id</code></td>\n<td>TEXT</td>\n<td>PK</td>\n<td>EventID from BaseEvent; TEXT not UUID to avoid parsing overhead on lookup; PRIMARY KEY gives unique constraint</td>\n</tr>\n<tr>\n<td><code>processed_events.processed_at</code></td>\n<td>TIMESTAMPTZ</td>\n<td>NOT NULL DEFAULT now()</td>\n<td>Audit trail; useful for future TTL-based cleanup</td>\n</tr>\n</tbody></table>\n<h3 id=\"32-go-structs\">3.2 Go Structs</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// store.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> analytics</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ClickRecord maps to one row in the clicks table.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Populated from URLClickedEvent fields.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ClickRecord</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID        </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // UUID, generated by DB (gen_random_uuid())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ClickedAt </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    IPHash    </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // SHA-256(raw_ip + salt); 64-char hex</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserAgent </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Referer   </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">    // empty string when absent (not nil pointer)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// MilestoneRecord maps to one row in the milestones table.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> MilestoneRecord</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID          </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode   </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Milestone   </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\">       // 10 | 100 | 1000</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    TriggeredAt </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// StatsResult is the aggregated response for GET /stats/:code.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Built from multiple DB queries in the handler.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> StatsResult</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode      </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    TotalClicks    </span><span style=\"color:#F97583\">int64</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ClicksLast24h  </span><span style=\"color:#F97583\">int64</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ClicksLast7d   </span><span style=\"color:#F97583\">int64</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    TopReferers    []</span><span style=\"color:#B392F0\">RefererCount</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RefererCount holds one entry in the top-referers list.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RefererCount</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Referer </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"referer\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Count   </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">  `json:\"count\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// TimelinePoint holds one bucket in the timeline response.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> TimelinePoint</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Period </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"period\"`</span><span style=\"color:#6A737D\"> // RFC3339 of the bucket start</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Clicks </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">  `json:\"clicks\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// config.go (extended from M1)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> analytics</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Config</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DatabaseURL        </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RabbitMQURL        </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Port               </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ServiceName        </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    IPHashSalt         </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">        // read from IP_HASH_SALT env var; empty string is acceptable</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    AMQPPrefetchCount  </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\">           // always 1 for this service (not configurable — fixed per spec)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    OutboxPollInterval </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#6A737D\"> // unused in analytics; kept for config struct symmetry</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> loadConfig</span><span style=\"color:#E1E4E8\">() (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Config</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Config</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        DatabaseURL:       os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DATABASE_URL\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        RabbitMQURL:       os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"RABBITMQ_URL\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Port:              </span><span style=\"color:#B392F0\">envOrDefault</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"PORT\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"8080\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ServiceName:       </span><span style=\"color:#9ECBFF\">\"analytics-service\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        IPHashSalt:        os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"IP_HASH_SALT\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        AMQPPrefetchCount: </span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cfg.DatabaseURL </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DATABASE_URL is required\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cfg.RabbitMQURL </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"RABBITMQ_URL is required\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> cfg, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> envOrDefault</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">key</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">def</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> v </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(key); v </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> v</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> def</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// handler.go — HTTP request/response types</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> analytics</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// statsResponse is the JSON shape for GET /stats/:code.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> statsResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode     </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">         `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    TotalClicks   </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">          `json:\"total_clicks\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ClicksLast24h </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">          `json:\"clicks_last_24h\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ClicksLast7d  </span><span style=\"color:#F97583\">int64</span><span style=\"color:#9ECBFF\">          `json:\"clicks_last_7d\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    TopReferers   []</span><span style=\"color:#B392F0\">RefererCount</span><span style=\"color:#9ECBFF\"> `json:\"top_referers\"`</span><span style=\"color:#6A737D\"> // always array, never null</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// timelineResponse is the JSON shape for GET /stats/:code/timeline.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> timelineResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ShortCode </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">          `json:\"short_code\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Interval  </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">          `json:\"interval\"`</span><span style=\"color:#6A737D\">  // \"day\" | \"hour\" echoed back</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Points    []</span><span style=\"color:#B392F0\">TimelinePoint</span><span style=\"color:#9ECBFF\"> `json:\"points\"`</span><span style=\"color:#6A737D\">    // always array, never null</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"33-repository-interfaces\">3.3 Repository Interfaces</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// store.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ClickRepository abstracts all DB operations on the clicks table.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ClickRepository</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert creates a new click row. Called within a transaction.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // rec.ID is populated by the DB (gen_random_uuid()); caller passes zero value.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">rec</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">ClickRecord</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // CountByCode returns total click count for a short_code.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    CountByCode</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // CountByCodeSince returns click count for a short_code after the given time.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    CountByCodeSince</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">since</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TopReferers returns the top N referers for a short_code by count, descending.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Only non-NULL referer rows are considered (partial index).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // n is always 5 in this project.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    TopReferers</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">n</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">RefererCount</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // TimelineBuckets returns click counts bucketed by the given PostgreSQL truncation unit.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // truncUnit is \"day\" or \"hour\" — validated by caller before reaching here.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns buckets ordered by period ASC.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    TimelineBuckets</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">truncUnit</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">TimelinePoint</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// MilestoneRepository abstracts all DB operations on the milestones table.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> MilestoneRepository</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // HasMilestone returns true if the given (shortCode, milestone) row exists.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    HasMilestone</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">milestone</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert records that a milestone was reached. Uses ON CONFLICT DO NOTHING for idempotency.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Called within a transaction.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">shortCode</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">milestone</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// DeduplicationRepository abstracts all DB operations on the processed_events table.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> DeduplicationRepository</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Exists checks if the given event_id has already been processed.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Called within a transaction (holds a row-level lock on the insert for the duration).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Exists</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">eventID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert records an event_id as processed. Called within the same transaction as Exists.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // On conflict (race between two consumer instances): ON CONFLICT DO NOTHING.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">eventID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-22.svg\" alt=\"Analytics Service Module Architecture\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Data ownership and flow:\nRabbitMQ                analytics-service               analytics_db\nqueue:                  ┌────────────────────────────┐  ┌──────────────────────┐\n&quot;analytics.clicks&quot;      │  ClickConsumer goroutine    │  │  clicks              │\n       │                │                            │  │  milestones          │\n       │ AMQP Deliver   │  1. decode JSON            │  │  processed_events    │\n       └───────────────►│  2. dedup check (tx)       │  └──────────────────────┘\n                        │  3. insert click (same tx) │           ▲\n                        │  4. milestone check (tx)   │           │\n                        │  5. commit tx              │───────────┘\n                        │  6. maybe publish          │\n                        │     MilestoneReachedEvent  │\n                        │  7. d.Ack()                │\n                        │                            │\nHTTP (public)           │  StatsHandler              │\nGET /stats/:code ──────►│    CountByCode             │\nGET /stats/.../timeline►│    CountByCodeSince        │\n                        │    TopReferers             │\n                        │    TimelineBuckets         │\n                        └────────────────────────────┘\n                                     │\n                              RabbitMQ publish\n                              routing key:\n                              &quot;milestone.reached&quot;\n                                     │\n                                     ▼\n                         notifications.events queue\n                         (notification-service M5)</code></pre></div>\n\n<hr>\n<h2 id=\"4-interface-contracts\">4. Interface Contracts</h2>\n<h3 id=\"41-clickrepository-pgxclickstore-implementation\">4.1 <code>ClickRepository</code> — <code>pgxClickStore</code> Implementation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// store.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> pgxClickStore</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewClickStore</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">pool</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ClickRepository</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">pgxClickStore</span><span style=\"color:#E1E4E8\">{pool: pool}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>Insert(ctx context.Context, tx pgx.Tx, rec *ClickRecord) error</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL (executed on tx):\n  INSERT INTO clicks (short_code, clicked_at, ip_hash, user_agent, referer)\n  VALUES ($1, $2, $3, $4, $5)\nParameters:\n  $1 rec.ShortCode\n  $2 rec.ClickedAt    (time.Time; pgx maps to TIMESTAMPTZ)\n  $3 rec.IPHash       (64-char hex string)\n  $4 rec.UserAgent    (empty string acceptable; NOT NULL DEFAULT '')\n  $5 rec.Referer      (empty string → NULL in DB via nilable helper; see note)\nReferer NULL handling:\n  Pass nil to pgx when rec.Referer == &quot;&quot; to store SQL NULL (allows partial index).\n  Use pgtype.Text{String: rec.Referer, Valid: rec.Referer != &quot;&quot;} or convert to *string.\nOn success: return nil\nOn DB error: return fmt.Errorf(&quot;insert click: %w&quot;, err)</code></pre></div>\n\n<p><strong><code>CountByCode(ctx context.Context, shortCode string) (int64, error)</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL:\n  SELECT COUNT(*) FROM clicks WHERE short_code = $1\nUses idx_clicks_short_code_time (leading column = short_code).\nOn success: return count, nil\nOn DB error: return 0, fmt.Errorf(&quot;count clicks by code: %w&quot;, err)</code></pre></div>\n\n<p><strong><code>CountByCodeSince(ctx context.Context, shortCode string, since time.Time) (int64, error)</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL:\n  SELECT COUNT(*) FROM clicks\n  WHERE short_code = $1 AND clicked_at &gt;= $2\nParameters: shortCode, since (time.Time)\nSince values in use:\n  24h window: time.Now().UTC().Add(-24 * time.Hour)\n   7d window: time.Now().UTC().Add(-7 * 24 * time.Hour)\nUses idx_clicks_short_code_time (composite: short_code + clicked_at DESC).\nOn success: return count, nil\nOn DB error: return 0, fmt.Errorf(&quot;count clicks since: %w&quot;, err)</code></pre></div>\n\n<p><strong><code>TopReferers(ctx context.Context, shortCode string, n int) ([]RefererCount, error)</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL:\n  SELECT referer, COUNT(*) AS cnt\n  FROM clicks\n  WHERE short_code = $1 AND referer IS NOT NULL\n  GROUP BY referer\n  ORDER BY cnt DESC\n  LIMIT $2\nParameters: shortCode, n (always 5)\nUses idx_clicks_referer (partial index WHERE referer IS NOT NULL).\nOn 0 rows: return empty []RefererCount{}, nil — NOT an error\nOn DB error: return nil, fmt.Errorf(&quot;top referers: %w&quot;, err)\nNote: Caller is responsible for initializing []RefererCount{} (not nil) so\n      JSON serializes as [] rather than null.</code></pre></div>\n\n<p><strong><code>TimelineBuckets(ctx context.Context, shortCode string, truncUnit string) ([]TimelinePoint, error)</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL:\n  SELECT\n    date_trunc($1, clicked_at AT TIME ZONE 'UTC') AS period,\n    COUNT(*) AS clicks\n  FROM clicks\n  WHERE short_code = $2\n  GROUP BY period\n  ORDER BY period ASC\nParameters:\n  $1 truncUnit (&quot;day&quot; or &quot;hour&quot;) — caller validates before passing\n  $2 shortCode\nOn success: scan each row into TimelinePoint{Period: period.Format(time.RFC3339), Clicks: count}\n  period is a time.Time from PostgreSQL; format with .UTC().Format(time.RFC3339)\nOn 0 rows: return empty []TimelinePoint{}, nil\nOn DB error: return nil, fmt.Errorf(&quot;timeline buckets: %w&quot;, err)</code></pre></div>\n\n<h3 id=\"42-milestonerepository-pgxmilestonestore-implementation\">4.2 <code>MilestoneRepository</code> — <code>pgxMilestoneStore</code> Implementation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> pgxMilestoneStore</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewMilestoneStore</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">pool</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">MilestoneRepository</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">pgxMilestoneStore</span><span style=\"color:#E1E4E8\">{pool: pool}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>HasMilestone(ctx context.Context, tx pgx.Tx, shortCode string, milestone int) (bool, error)</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL (on tx):\n  SELECT EXISTS(\n    SELECT 1 FROM milestones\n    WHERE short_code = $1 AND milestone = $2\n  )\nParameters: shortCode, milestone\nOn success: return bool, nil\nOn DB error: return false, fmt.Errorf(&quot;has milestone: %w&quot;, err)</code></pre></div>\n\n<p><strong><code>Insert(ctx context.Context, tx pgx.Tx, shortCode string, milestone int) error</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL (on tx):\n  INSERT INTO milestones (short_code, milestone)\n  VALUES ($1, $2)\n  ON CONFLICT (short_code, milestone) DO NOTHING\nParameters: shortCode, milestone\nON CONFLICT DO NOTHING: safe for concurrent consumers or replay scenarios.\nOn success (insert or no-op): return nil\nOn DB error (non-conflict): return fmt.Errorf(&quot;insert milestone: %w&quot;, err)</code></pre></div>\n\n<h3 id=\"43-deduplicationrepository-pgxdeduplicationstore-implementation\">4.3 <code>DeduplicationRepository</code> — <code>pgxDeduplicationStore</code> Implementation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> pgxDeduplicationStore</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewDeduplicationStore</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">pool</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">DeduplicationRepository</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">pgxDeduplicationStore</span><span style=\"color:#E1E4E8\">{pool: pool}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>Exists(ctx context.Context, tx pgx.Tx, eventID string) (bool, error)</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL (on tx):\n  SELECT EXISTS(SELECT 1 FROM processed_events WHERE event_id = $1)\nParameters: eventID\nOn success: return bool, nil\nOn DB error: return false, fmt.Errorf(&quot;dedup exists: %w&quot;, err)\nNote: Running inside the same transaction as Insert below ensures\n      that a concurrent consumer seeing the same event_id will either:\n      (a) see Exists=true (our tx already committed), or\n      (b) hit a PRIMARY KEY violation on Insert (our tx committed first).\n      Single consumer with prefetch=1 makes this moot in practice,\n      but the tx boundary is required for correctness.</code></pre></div>\n\n<p><strong><code>Insert(ctx context.Context, tx pgx.Tx, eventID string) error</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>SQL (on tx):\n  INSERT INTO processed_events (event_id)\n  VALUES ($1)\n  ON CONFLICT (event_id) DO NOTHING\nParameters: eventID\nOn success (insert or no-op conflict): return nil\nOn DB error (non-conflict): return fmt.Errorf(&quot;dedup insert: %w&quot;, err)</code></pre></div>\n\n<h3 id=\"44-analyticspublisher-interface\">4.4 <code>AnalyticsPublisher</code> Interface</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// publisher.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> AnalyticsPublisher</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // PublishMilestone sends a MilestoneReachedEvent to the \"url-shortener\" exchange</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // with routing key \"milestone.reached\".</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns error if publish fails; caller logs and continues.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    PublishMilestone</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">evt</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">MilestoneReachedEvent</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> amqpAnalyticsPublisher</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ch           </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Channel</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    exchangeName </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log          </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewAnalyticsPublisher</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ch</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Channel</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">AnalyticsPublisher</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">amqpAnalyticsPublisher</span><span style=\"color:#E1E4E8\">{ch: ch, exchangeName: </span><span style=\"color:#9ECBFF\">\"url-shortener\"</span><span style=\"color:#E1E4E8\">, log: log}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>PublishMilestone(ctx context.Context, evt *events.MilestoneReachedEvent) error</code></strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">p </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">amqpAnalyticsPublisher</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">PublishMilestone</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">evt</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">MilestoneReachedEvent</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    body, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Marshal</span><span style=\"color:#E1E4E8\">(evt)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"marshal MilestoneReachedEvent: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    err </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> p.ch.</span><span style=\"color:#B392F0\">PublishWithContext</span><span style=\"color:#E1E4E8\">(ctx,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        p.exchangeName,          </span><span style=\"color:#6A737D\">// exchange</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        events.EventTypeMilestoneReached, </span><span style=\"color:#6A737D\">// routing key: \"milestone.reached\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        false</span><span style=\"color:#E1E4E8\">,                   </span><span style=\"color:#6A737D\">// mandatory</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">        false</span><span style=\"color:#E1E4E8\">,                   </span><span style=\"color:#6A737D\">// immediate</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Publishing</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            ContentType:  </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            DeliveryMode: amqp.Persistent,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            Body:         body,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    )</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"amqp publish milestone: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Note on channel safety:</strong> <code>amqp091-go</code> channels are not safe for concurrent use. Since the consumer goroutine is the only goroutine calling <code>PublishMilestone</code>, no mutex is required here (unlike the url-service 3-worker case). If HTTP handlers ever need to publish, a mutex must be added.</p>\n<h3 id=\"45-milestonechecker\">4.5 <code>MilestoneChecker</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// milestone.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    MilestoneThreshold10</span><span style=\"color:#F97583\">   =</span><span style=\"color:#79B8FF\"> 10</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    MilestoneThreshold100</span><span style=\"color:#F97583\">  =</span><span style=\"color:#79B8FF\"> 100</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    MilestoneThreshold1000</span><span style=\"color:#F97583\"> =</span><span style=\"color:#79B8FF\"> 1000</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> MilestoneThresholds </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">int</span><span style=\"color:#E1E4E8\">{MilestoneThreshold10, MilestoneThreshold100, MilestoneThreshold1000}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> MilestoneChecker</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    clickStore     </span><span style=\"color:#B392F0\">ClickRepository</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    milestoneStore </span><span style=\"color:#B392F0\">MilestoneRepository</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    publisher      </span><span style=\"color:#B392F0\">AnalyticsPublisher</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log            </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewMilestoneChecker</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    clickStore</span><span style=\"color:#B392F0\"> ClickRepository</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    milestoneStore</span><span style=\"color:#B392F0\"> MilestoneRepository</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    publisher</span><span style=\"color:#B392F0\"> AnalyticsPublisher</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">MilestoneChecker</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CheckAndPublish is called inline in the consumer goroutine after a click is inserted.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// It reads total_clicks for the short_code (within the same tx to get the post-insert count),</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// checks each threshold, and for any newly crossed threshold: inserts a milestone row</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// and publishes MilestoneReachedEvent.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Parameters:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   ctx       - request context with deadline</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   tx        - the active transaction (click + dedup already inserted within it)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   shortCode - the code that just received a click</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   userID    - from URLClickedEvent (may be empty if not in event; use \"unknown\")</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   userEmail - from URLClickedEvent (may be empty; use \"\" for MilestoneReachedEvent)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//   corrID    - correlation ID for event propagation</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">//</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns: error only for fatal DB errors — publish failures are logged and swallowed.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">MilestoneChecker</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">CheckAndPublish</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    shortCode</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">userID</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">userEmail</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">corrID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span></code></pre></div>\n\n<hr>\n<h2 id=\"5-algorithm-specification\">5. Algorithm Specification</h2>\n<h3 id=\"51-consumer-startup-and-amqp-prefetch\">5.1 Consumer Startup and AMQP Prefetch</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>// consumer.go — called in main.go\ntype ClickConsumer struct {\n    conn       *RabbitMQConn        // from M1 factory\n    pool       *pgxpool.Pool\n    clickStore ClickRepository\n    milestoneStore MilestoneRepository\n    dedupStore DeduplicationRepository\n    checker    *MilestoneChecker\n    log        *slog.Logger\n    salt       string               // IP_HASH_SALT from config\n    healthy    atomic.Bool          // true when consumer loop is running\n}\nfunc NewClickConsumer(\n    conn *RabbitMQConn,\n    pool *pgxpool.Pool,\n    clickStore ClickRepository,\n    milestoneStore MilestoneRepository,\n    dedupStore DeduplicationRepository,\n    checker *MilestoneChecker,\n    log *slog.Logger,\n    salt string,\n) *ClickConsumer\n// Run starts the consumer loop. Blocks until ctx is Done.\n// Called with: go consumer.Run(ctx) in main.go.\nfunc (c *ClickConsumer) Run(ctx context.Context)</code></pre></div>\n\n<p><strong><code>Run(ctx context.Context)</code> Algorithm:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Step 1: Set quality-of-service (prefetch)\n  err := c.conn.Channel.Qos(\n      1,     // prefetchCount: process one message at a time\n      0,     // prefetchSize: no size limit\n      false, // global: apply per-consumer not per-channel\n  )\n  if err != nil:\n      c.log.Error(&quot;set qos failed&quot;, &quot;error&quot;, err)\n      os.Exit(1)  // fatal: cannot guarantee serial processing without prefetch\nStep 2: Register consumer\n  msgs, err := c.conn.Channel.Consume(\n      &quot;analytics.clicks&quot;, // queue (declared in M1 DeclareAnalyticsQueue)\n      &quot;&quot;,                 // consumer tag: auto-generated\n      false,              // autoAck: false — we ack manually after processing\n      false,              // exclusive: false\n      false,              // noLocal: false\n      false,              // noWait: false\n      nil,                // args\n  )\n  if err != nil:\n      c.log.Error(&quot;register consumer failed&quot;, &quot;error&quot;, err)\n      os.Exit(1)  // fatal: cannot function without consumer registration\nStep 3: Mark healthy\n  c.healthy.Store(true)\n  c.log.Info(&quot;consumer started&quot;, &quot;queue&quot;, &quot;analytics.clicks&quot;)\nStep 4: Message loop\n  for:\n      select:\n      case &lt;-ctx.Done():\n          c.healthy.Store(false)\n          c.log.Info(&quot;consumer stopped&quot;)\n          return\n      case d, ok := &lt;-msgs:\n          if !ok:\n              // Channel closed (RabbitMQ connection dropped)\n              c.healthy.Store(false)\n              c.log.Warn(&quot;amqp channel closed, consumer paused&quot;)\n              // Do NOT os.Exit — /health must remain 200\n              // Block until ctx is done (reconnect logic is future work; in-scope for M5)\n              &lt;-ctx.Done()\n              return\n          c.processDelivery(ctx, d)</code></pre></div>\n\n<p><strong><code>processDelivery(ctx context.Context, d amqp.Delivery)</code> Algorithm:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Step 1: Panic recovery (poison message guard)\n  defer func() {\n      if r := recover(); r != nil:\n          c.log.Error(&quot;consumer panic recovered&quot;,\n              &quot;panic&quot;, fmt.Sprintf(&quot;%v&quot;, r),\n              &quot;body_preview&quot;, truncate(string(d.Body), 200),\n          )\n          d.Ack(false)  // ack to remove from queue; do not requeue a panicking message\n  }()\nStep 2: Decode JSON\n  var evt events.URLClickedEvent\n  if err := json.Unmarshal(d.Body, &amp;evt); err != nil:\n      c.log.Error(&quot;poison message: JSON unmarshal failed&quot;,\n          &quot;error&quot;, err,\n          &quot;body_preview&quot;, truncate(string(d.Body), 200),\n      )\n      d.Ack(false)  // ack (NOT nack) to drain poison messages without requeue\n      return\nStep 3: Validate required fields\n  if evt.EventID == &quot;&quot; || evt.ShortCode == &quot;&quot;:\n      c.log.Error(&quot;poison message: missing required fields&quot;,\n          &quot;event_id&quot;, evt.EventID,\n          &quot;short_code&quot;, evt.ShortCode,\n      )\n      d.Ack(false)\n      return\nStep 4: Open transaction\n  tx, err := c.pool.Begin(ctx)\n  if err != nil:\n      c.log.Error(&quot;begin tx failed&quot;, &quot;error&quot;, err, &quot;event_id&quot;, evt.EventID)\n      d.Nack(false, true)  // nack + requeue — DB might recover\n      return\nStep 5: Idempotency check\n  exists, err := c.dedupStore.Exists(ctx, tx, evt.EventID)\n  if err != nil:\n      tx.Rollback(ctx)\n      c.log.Error(&quot;dedup exists check failed&quot;, &quot;error&quot;, err, &quot;event_id&quot;, evt.EventID)\n      d.Nack(false, true)\n      return\n  if exists:\n      tx.Rollback(ctx)\n      c.log.Info(&quot;duplicate event skipped&quot;, &quot;event_id&quot;, evt.EventID)\n      d.Ack(false)\n      return\nStep 6: Record event_id as processed\n  if err := c.dedupStore.Insert(ctx, tx, evt.EventID); err != nil:\n      tx.Rollback(ctx)\n      c.log.Error(&quot;dedup insert failed&quot;, &quot;error&quot;, err, &quot;event_id&quot;, evt.EventID)\n      d.Nack(false, true)\n      return\nStep 7: Build and insert click record\n  rec := &amp;ClickRecord{\n      ShortCode: evt.ShortCode,\n      ClickedAt: evt.ClickedAt,\n      IPHash:    evt.IPHash,   // already hashed by url-service; do NOT re-hash\n      UserAgent: evt.UserAgent,\n      Referer:   evt.Referer,\n  }\n  if err := c.clickStore.Insert(ctx, tx, rec); err != nil:\n      tx.Rollback(ctx)\n      c.log.Error(&quot;click insert failed&quot;, &quot;error&quot;, err, &quot;event_id&quot;, evt.EventID)\n      d.Nack(false, true)\n      return\nStep 8: Milestone check (inline, same tx)\n  corrID := evt.CorrelationID\n  if corrID == &quot;&quot; { corrID = evt.EventID }\n  if err := c.checker.CheckAndPublish(ctx, tx, evt.ShortCode, &quot;&quot;, &quot;&quot;, corrID); err != nil:\n      tx.Rollback(ctx)\n      c.log.Error(&quot;milestone check failed&quot;, &quot;error&quot;, err, &quot;event_id&quot;, evt.EventID)\n      d.Nack(false, true)\n      return\nStep 9: Commit transaction\n  if err := tx.Commit(ctx); err != nil:\n      c.log.Error(&quot;commit failed&quot;, &quot;error&quot;, err, &quot;event_id&quot;, evt.EventID)\n      d.Nack(false, true)\n      return\nStep 10: Acknowledge message\n  d.Ack(false)\n  c.log.Info(&quot;click processed&quot;,\n      &quot;event_id&quot;, evt.EventID,\n      &quot;short_code&quot;, evt.ShortCode,\n      &quot;correlation_id&quot;, corrID,\n  )</code></pre></div>\n\n<h3 id=\"52-milestonecheckercheckandpublish-algorithm\">5.2 <code>MilestoneChecker.CheckAndPublish</code> Algorithm</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Input:\n  ctx       context.Context\n  tx        pgx.Tx          (click + dedup already inserted, tx not yet committed)\n  shortCode string\n  userID    string          (from URLClickedEvent; may be empty — use &quot;&quot; in event payload)\n  userEmail string          (from URLClickedEvent; may be empty)\n  corrID    string\nStep 1: Count total clicks for this shortCode within the transaction\n  // Use pool directly (not tx) to get committed count + current tx count.\n  // IMPORTANT: Use tx.QueryRow so the count includes the click we just inserted\n  //            (the INSERT is visible within this transaction but not yet committed).\n  var totalClicks int64\n  row := tx.QueryRow(ctx,\n      &quot;SELECT COUNT(*) FROM clicks WHERE short_code = $1&quot;,\n      shortCode,\n  )\n  if err := row.Scan(&amp;totalClicks); err != nil:\n      return fmt.Errorf(&quot;count clicks for milestone: %w&quot;, err)\nStep 2: Check each threshold in ascending order\n  for _, threshold := range MilestoneThresholds:  // [10, 100, 1000]\n      if totalClicks &lt; int64(threshold):\n          continue  // not yet reached\n      // Has it already been recorded?\n      alreadyRecorded, err := m.milestoneStore.HasMilestone(ctx, tx, shortCode, threshold)\n      if err != nil:\n          return fmt.Errorf(&quot;has milestone %d: %w&quot;, threshold, err)\n      if alreadyRecorded:\n          continue  // already crossed and recorded\n      // New milestone! Record it.\n      if err := m.milestoneStore.Insert(ctx, tx, shortCode, threshold); err != nil:\n          return fmt.Errorf(&quot;insert milestone %d: %w&quot;, threshold, err)\n      // Publish MilestoneReachedEvent (outside tx — publish after milestone committed is\n      // safer; but here we publish before commit. If commit fails, we have a phantom event.\n      // This is acceptable: milestone.reached is informational; notification-service\n      // deduplication via processed_events in M5 handles replays.)\n      //\n      // Build and publish after tx.Commit() in the caller would be ideal but requires\n      // returning the milestone data from this function. For simplicity, publish here\n      // before commit. If publish fails, we still commit (milestone row is durable).\n      evt := &amp;events.MilestoneReachedEvent{\n          BaseEvent: events.BaseEvent{\n              EventType:     events.EventTypeMilestoneReached,\n              OccurredAt:    time.Now().UTC(),\n              CorrelationID: corrID,\n              EventID:       newUUID(),\n          },\n          ShortCode:   shortCode,\n          UserID:      userID,\n          UserEmail:   userEmail,\n          MilestoneN:  threshold,\n          TotalClicks: totalClicks,\n      }\n      publishCtx, cancel := context.WithTimeout(ctx, 3*time.Second)\n      if publishErr := m.publisher.PublishMilestone(publishCtx, evt); publishErr != nil:\n          m.log.Warn(&quot;milestone event publish failed&quot;,\n              &quot;threshold&quot;, threshold,\n              &quot;short_code&quot;, shortCode,\n              &quot;error&quot;, publishErr,\n          )\n          // Do NOT return error — milestone row is committed; publish failure is non-fatal\n      cancel()\nStep 3: Return nil (all thresholds checked)\n  return nil</code></pre></div>\n\n<p><strong>Design note on publish-before-commit:</strong> Publishing <code>MilestoneReachedEvent</code> inside the transaction scope means the event goes out before the milestone row is committed. If the commit subsequently fails, a phantom notification is sent. The alternative (publishing post-commit) requires returning milestone data from <code>CheckAndPublish</code> and restructuring the consumer. For this project&#39;s scope, the phantom-event risk is accepted because milestone notifications are informational, not transactional. A production system would use the outbox pattern here too.</p>\n<h3 id=\"53-get-statscode-handler\">5.3 <code>GET /stats/:code</code> Handler</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Input:  path parameter: code string\nOutput: 200 statsResponse | 404 | 500\nNo authentication required.\nStep 1: Extract short_code from path\n  code := r.PathValue(&quot;code&quot;)\n  if code == &quot;&quot;:\n      writeError(w, 400, &quot;short_code is required&quot;); return\nStep 2: Execute aggregation queries (concurrent with errgroup for performance)\n  g, gCtx := errgroup.WithContext(r.Context())\n  var total, last24h, last7d int64\n  var topRefs []RefererCount\n  g.Go(func() error {\n      var err error\n      total, err = h.clickStore.CountByCode(gCtx, code)\n      return err\n  })\n  g.Go(func() error {\n      var err error\n      last24h, err = h.clickStore.CountByCodeSince(gCtx, code, time.Now().UTC().Add(-24*time.Hour))\n      return err\n  })\n  g.Go(func() error {\n      var err error\n      last7d, err = h.clickStore.CountByCodeSince(gCtx, code, time.Now().UTC().Add(-7*24*time.Hour))\n      return err\n  })\n  g.Go(func() error {\n      var err error\n      topRefs, err = h.clickStore.TopReferers(gCtx, code, 5)\n      if topRefs == nil { topRefs = []RefererCount{} }  // ensure JSON []\n      return err\n  })\n  if err := g.Wait(); err != nil:\n      h.log.Error(&quot;stats query failed&quot;, &quot;code&quot;, code, &quot;error&quot;, err)\n      writeError(w, 500, &quot;internal server error&quot;); return\nStep 3: If total == 0 AND we want to return 404 for unknown codes...\n  Note: The spec says stats are public and does NOT require the code to exist in url_db\n  (analytics trusts events). A short_code with 0 clicks returns 200 with zeroed stats.\n  We do NOT call url-service to check existence. Return 200 with zeros.\nStep 4: Write response\n  writeJSON(w, 200, statsResponse{\n      ShortCode:     code,\n      TotalClicks:   total,\n      ClicksLast24h: last24h,\n      ClicksLast7d:  last7d,\n      TopReferers:   topRefs,\n  })</code></pre></div>\n\n<h3 id=\"54-get-statscodetimeline-handler\">5.4 <code>GET /stats/:code/timeline</code> Handler</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Input:  path parameter: code; query param: interval=day|hour\nOutput: 200 timelineResponse | 400 | 500\nStep 1: Extract and validate params\n  code := r.PathValue(&quot;code&quot;)\n  interval := r.URL.Query().Get(&quot;interval&quot;)\n  if interval != &quot;day&quot; &amp;&amp; interval != &quot;hour&quot;:\n      writeError(w, 400, `interval must be &quot;day&quot; or &quot;hour&quot;`); return\nStep 2: Map interval to PostgreSQL date_trunc unit\n  // &quot;day&quot; → &quot;day&quot;, &quot;hour&quot; → &quot;hour&quot;\n  // Both are valid PostgreSQL date_trunc units; no remapping needed.\n  truncUnit := interval\nStep 3: Query buckets\n  points, err := h.clickStore.TimelineBuckets(r.Context(), code, truncUnit)\n  if err != nil:\n      h.log.Error(&quot;timeline query failed&quot;, &quot;code&quot;, code, &quot;error&quot;, err)\n      writeError(w, 500, &quot;internal server error&quot;); return\n  if points == nil { points = []TimelinePoint{} }\nStep 4: Write response\n  writeJSON(w, 200, timelineResponse{\n      ShortCode: code,\n      Interval:  interval,\n      Points:    points,\n  })</code></pre></div>\n\n<h3 id=\"55-schema-migration-on-startup\">5.5 Schema Migration on Startup</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// main.go — after NewDBPool succeeds, before consumer or HTTP server start</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> analyticsSchema</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> `</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE TABLE IF NOT EXISTS clicks (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    id          UUID        PRIMARY KEY DEFAULT gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    short_code  TEXT        NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    clicked_at  TIMESTAMPTZ NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    ip_hash     TEXT        NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    user_agent  TEXT        NOT NULL DEFAULT '',</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    referer     TEXT        NULL</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">);</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE INDEX IF NOT EXISTS idx_clicks_short_code_time</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    ON clicks(short_code, clicked_at DESC);</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE INDEX IF NOT EXISTS idx_clicks_referer</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    ON clicks(short_code, referer)</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    WHERE referer IS NOT NULL;</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE TABLE IF NOT EXISTS milestones (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    id           UUID  PRIMARY KEY DEFAULT gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    short_code   TEXT  NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    milestone    INT   NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    triggered_at TIMESTAMPTZ NOT NULL DEFAULT now(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    UNIQUE (short_code, milestone)</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">);</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE UNIQUE INDEX IF NOT EXISTS idx_milestones_code_milestone</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    ON milestones(short_code, milestone);</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE TABLE IF NOT EXISTS processed_events (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    event_id     TEXT PRIMARY KEY,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    processed_at TIMESTAMPTZ NOT NULL DEFAULT now()</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">);</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">`</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> runMigrations</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">pool</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> pool.</span><span style=\"color:#B392F0\">Exec</span><span style=\"color:#E1E4E8\">(ctx, analyticsSchema)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"run analytics migrations: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"analytics migrations applied\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"56-haship-function-hashipgo\">5.6 <code>hashIP</code> Function (<code>haship.go</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// haship.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> analytics</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">crypto/sha256</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// hashIP extracts the IP from remoteAddr and returns SHA-256(ip + salt) as a hex string.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// If port splitting fails, uses the raw remoteAddr as the input.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// This function is NOT called in the analytics consumer — the ip_hash is already computed</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// by url-service before being embedded in URLClickedEvent.IPHash.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Provided here for local test utilities and future analytics-internal use.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> hashIP</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">remoteAddr</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">salt</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ip, _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> net.</span><span style=\"color:#B392F0\">SplitHostPort</span><span style=\"color:#E1E4E8\">(remoteAddr)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ip </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> remoteAddr</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> sha256.</span><span style=\"color:#B392F0\">Sum256</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(ip </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> salt))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Sprintf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">%x</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, h)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Critical:</strong> The analytics consumer reads <code>evt.IPHash</code> directly from the <code>URLClickedEvent</code>. It does <strong>not</strong> receive a raw IP. The <code>hashIP</code> function in analytics-service is present only for test utilities. The ip_hash field in the click row is always the value from the event payload, which was already hashed by url-service.</p>\n<h3 id=\"57-newuuid-helper\">5.7 <code>newUUID</code> Helper</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// consumer.go or a shared helpers.go within analytics package</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">crypto/rand</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> newUUID</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rand.</span><span style=\"color:#B392F0\">Read</span><span style=\"color:#E1E4E8\">(b)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b[</span><span style=\"color:#79B8FF\">6</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (b[</span><span style=\"color:#79B8FF\">6</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#F97583\"> 0x</span><span style=\"color:#79B8FF\">0f</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">|</span><span style=\"color:#F97583\"> 0x</span><span style=\"color:#79B8FF\">40</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b[</span><span style=\"color:#79B8FF\">8</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> (b[</span><span style=\"color:#79B8FF\">8</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#F97583\"> 0x</span><span style=\"color:#79B8FF\">3f</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">|</span><span style=\"color:#F97583\"> 0x</span><span style=\"color:#79B8FF\">80</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Sprintf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">%08x</span><span style=\"color:#9ECBFF\">-</span><span style=\"color:#79B8FF\">%04x</span><span style=\"color:#9ECBFF\">-</span><span style=\"color:#79B8FF\">%04x</span><span style=\"color:#9ECBFF\">-</span><span style=\"color:#79B8FF\">%04x</span><span style=\"color:#9ECBFF\">-</span><span style=\"color:#79B8FF\">%012x</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        b[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">:</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">], b[</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">:</span><span style=\"color:#79B8FF\">6</span><span style=\"color:#E1E4E8\">], b[</span><span style=\"color:#79B8FF\">6</span><span style=\"color:#E1E4E8\">:</span><span style=\"color:#79B8FF\">8</span><span style=\"color:#E1E4E8\">], b[</span><span style=\"color:#79B8FF\">8</span><span style=\"color:#E1E4E8\">:</span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">], b[</span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">:</span><span style=\"color:#79B8FF\">16</span><span style=\"color:#E1E4E8\">])</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"58-route-and-consumer-registration-in-maingo\">5.8 Route and Consumer Registration in <code>main.go</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// services/analytics-service/main.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> main</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os/signal</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">syscall</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourhandle/url-shortener/shared/logger</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> loadConfig</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        fmt.</span><span style=\"color:#B392F0\">Fprintf</span><span style=\"color:#E1E4E8\">(os.Stderr, </span><span style=\"color:#9ECBFF\">\"config error: </span><span style=\"color:#79B8FF\">%v\\n</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        os.</span><span style=\"color:#B392F0\">Exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> logger.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(cfg.ServiceName)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ctx, cancel </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithCancel</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#B392F0\"> cancel</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewDBPool</span><span style=\"color:#E1E4E8\">(ctx, cfg.DatabaseURL, log)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"db unreachable\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"error\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        os.</span><span style=\"color:#B392F0\">Exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> pool.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> runMigrations</span><span style=\"color:#E1E4E8\">(ctx, pool, log); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"migration failed\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"error\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        os.</span><span style=\"color:#B392F0\">Exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mq, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewRabbitMQConn</span><span style=\"color:#E1E4E8\">(ctx, cfg.RabbitMQURL, log, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"rabbitmq unreachable\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"error\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        os.</span><span style=\"color:#B392F0\">Exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    defer</span><span style=\"color:#E1E4E8\"> mq.</span><span style=\"color:#B392F0\">Close</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> DeclareAnalyticsQueue</span><span style=\"color:#E1E4E8\">(mq.Channel); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"declare analytics queue failed\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"error\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        os.</span><span style=\"color:#B392F0\">Exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Construct repositories</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    clickStore     </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewClickStore</span><span style=\"color:#E1E4E8\">(pool)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    milestoneStore </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewMilestoneStore</span><span style=\"color:#E1E4E8\">(pool)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    dedupStore     </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewDeduplicationStore</span><span style=\"color:#E1E4E8\">(pool)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    publisher      </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewAnalyticsPublisher</span><span style=\"color:#E1E4E8\">(mq.Channel, log)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    checker        </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewMilestoneChecker</span><span style=\"color:#E1E4E8\">(clickStore, milestoneStore, publisher, log)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    consumer </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewClickConsumer</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        mq, pool, clickStore, milestoneStore, dedupStore, checker, log, cfg.IPHashSalt,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    )</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Construct HTTP handler</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    statsHandler </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewStatsHandler</span><span style=\"color:#E1E4E8\">(clickStore, log)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mux </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">NewServeMux</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /health\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">NewHealthHandler</span><span style=\"color:#E1E4E8\">(cfg.ServiceName))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /stats/{code}\"</span><span style=\"color:#E1E4E8\">, statsHandler.Stats)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mux.</span><span style=\"color:#B392F0\">HandleFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET /stats/{code}/timeline\"</span><span style=\"color:#E1E4E8\">, statsHandler.Timeline)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Start consumer goroutine</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    go</span><span style=\"color:#E1E4E8\"> consumer.</span><span style=\"color:#B392F0\">Run</span><span style=\"color:#E1E4E8\">(ctx)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    srv </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Server</span><span style=\"color:#E1E4E8\">{Addr: </span><span style=\"color:#9ECBFF\">\":\"</span><span style=\"color:#F97583\"> +</span><span style=\"color:#E1E4E8\"> cfg.Port, Handler: mux}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    go</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"server listening\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"port\"</span><span style=\"color:#E1E4E8\">, cfg.Port)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> srv.</span><span style=\"color:#B392F0\">ListenAndServe</span><span style=\"color:#E1E4E8\">(); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#F97583\"> &#x26;&#x26;</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> http.ErrServerClosed {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            log.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"server error\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"error\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            os.</span><span style=\"color:#B392F0\">Exit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    quit </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">chan</span><span style=\"color:#B392F0\"> os</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Signal</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    signal.</span><span style=\"color:#B392F0\">Notify</span><span style=\"color:#E1E4E8\">(quit, syscall.SIGTERM, syscall.SIGINT)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    &#x3C;-</span><span style=\"color:#E1E4E8\">quit</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"shutting down analytics-service\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    cancel</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    srv.</span><span style=\"color:#B392F0\">Shutdown</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-23.svg\" alt=\"Analytics DB Schema: clicks, milestones, processed_events\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Startup sequence — analytics-service:\n  loadConfig() ── fatal if DATABASE_URL or RABBITMQ_URL missing\n       │\n       ▼\n  logger.New(&quot;analytics-service&quot;)\n       │\n       ▼\n  NewDBPool() ── fatal on error\n       │\n       ▼\n  runMigrations() ── fatal on error\n       │\n       ▼\n  NewRabbitMQConn() ── fatal after 10 attempts; declares exchange\n       │\n       ▼\n  DeclareAnalyticsQueue() ── fatal on error\n       │              declares queue &quot;analytics.clicks&quot;\n       │              binds routing key &quot;url.clicked&quot;\n       │\n       ▼\n  Construct: clickStore, milestoneStore, dedupStore, publisher, checker, consumer\n       │\n       ▼\n  go consumer.Run(ctx) ── background goroutine\n       │       sets prefetch=1, registers consumer, marks healthy\n       │\n       ▼\n  mux.HandleFunc(...) ── /health, /stats/{code}, /stats/{code}/timeline\n       │\n       ▼\n  srv.ListenAndServe() ── blocks\n       │\n       │ SIGTERM\n       ▼\n  cancel() → consumer.Run exits → srv.Shutdown()</code></pre></div>\n\n<hr>\n<h2 id=\"6-error-handling-matrix\">6. Error Handling Matrix</h2>\n<table>\n<thead>\n<tr>\n<th>Error Scenario</th>\n<th>Detected By</th>\n<th>Recovery</th>\n<th>HTTP Status / AMQP Action</th>\n<th>Log Level</th>\n<th>Notes</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Missing <code>DATABASE_URL</code></td>\n<td><code>loadConfig()</code></td>\n<td><code>fmt.Fprintf(stderr)</code> + <code>os.Exit(1)</code></td>\n<td>— (pre-HTTP)</td>\n<td>Error (stderr)</td>\n<td>Name the missing var</td>\n</tr>\n<tr>\n<td>Missing <code>RABBITMQ_URL</code></td>\n<td><code>loadConfig()</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>— (pre-HTTP)</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td>DB unreachable at startup</td>\n<td><code>NewDBPool</code> / <code>pool.Ping</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>— (pre-HTTP)</td>\n<td>Error</td>\n<td>Log masked DSN</td>\n</tr>\n<tr>\n<td>Migration SQL fails</td>\n<td><code>runMigrations</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>— (pre-HTTP)</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td>RabbitMQ unreachable (all 10 attempts)</td>\n<td><code>NewRabbitMQConn</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>— (pre-HTTP)</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td>Queue declare fails</td>\n<td><code>DeclareAnalyticsQueue</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>— (pre-HTTP)</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td>Consumer QoS set fails</td>\n<td><code>ch.Qos(1,0,false)</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>— (pre-HTTP)</td>\n<td>Error</td>\n<td>Serial guarantees lost without prefetch=1</td>\n</tr>\n<tr>\n<td>Consumer registration fails</td>\n<td><code>ch.Consume(...)</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>— (pre-HTTP)</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td>AMQP channel closed mid-run</td>\n<td><code>&lt;-msgs</code> ok=false</td>\n<td>Mark unhealthy, block on <code>&lt;-ctx.Done()</code></td>\n<td>—</td>\n<td>Warn</td>\n<td><code>/health</code> still returns 200 (healthcheck only checks HTTP)</td>\n</tr>\n<tr>\n<td>Malformed JSON in message body</td>\n<td><code>json.Unmarshal</code></td>\n<td><code>d.Ack(false)</code></td>\n<td>—</td>\n<td>Error</td>\n<td><code>&quot;poison message&quot;</code> + body preview (truncated 200 chars)</td>\n</tr>\n<tr>\n<td>Missing <code>event_id</code> or <code>short_code</code></td>\n<td>Field check after decode</td>\n<td><code>d.Ack(false)</code></td>\n<td>—</td>\n<td>Error</td>\n<td><code>&quot;poison message: missing required fields&quot;</code></td>\n</tr>\n<tr>\n<td>Consumer panic</td>\n<td><code>defer recover()</code></td>\n<td><code>d.Ack(false)</code></td>\n<td>—</td>\n<td>Error</td>\n<td>Log panic value + body preview</td>\n</tr>\n<tr>\n<td>DB <code>pool.Begin</code> fails</td>\n<td><code>pool.Begin</code></td>\n<td><code>d.Nack(false, true)</code> — requeue</td>\n<td>—</td>\n<td>Error</td>\n<td><code>&quot;begin tx failed&quot;</code></td>\n</tr>\n<tr>\n<td><code>Exists</code> (dedup check) DB error</td>\n<td><code>dedupStore.Exists</code></td>\n<td>Rollback + <code>d.Nack(false, true)</code></td>\n<td>—</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td><code>Insert</code> (dedup) DB error</td>\n<td><code>dedupStore.Insert</code></td>\n<td>Rollback + <code>d.Nack(false, true)</code></td>\n<td>—</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td>Duplicate <code>event_id</code></td>\n<td><code>exists == true</code></td>\n<td>Rollback + <code>d.Ack(false)</code></td>\n<td>—</td>\n<td>Info</td>\n<td><code>&quot;duplicate event skipped&quot;</code></td>\n</tr>\n<tr>\n<td>Click insert DB error</td>\n<td><code>clickStore.Insert</code></td>\n<td>Rollback + <code>d.Nack(false, true)</code></td>\n<td>—</td>\n<td>Error</td>\n<td><code>&quot;click insert failed&quot;</code></td>\n</tr>\n<tr>\n<td>Milestone count DB error</td>\n<td><code>tx.QueryRow</code> COUNT</td>\n<td>Rollback + <code>d.Nack(false, true)</code></td>\n<td>—</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td><code>HasMilestone</code> DB error</td>\n<td><code>milestoneStore.HasMilestone</code></td>\n<td>Rollback + <code>d.Nack(false, true)</code></td>\n<td>—</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td><code>Insert</code> milestone DB error</td>\n<td><code>milestoneStore.Insert</code></td>\n<td>Rollback + <code>d.Nack(false, true)</code></td>\n<td>—</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td><code>MilestoneReachedEvent</code> publish fails</td>\n<td><code>publisher.PublishMilestone</code></td>\n<td>Log + continue (tx still commits)</td>\n<td>—</td>\n<td>Warn</td>\n<td><code>&quot;milestone event publish failed&quot;</code> + threshold + code</td>\n</tr>\n<tr>\n<td><code>tx.Commit</code> fails</td>\n<td><code>tx.Commit</code></td>\n<td><code>d.Nack(false, true)</code></td>\n<td>—</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td><code>GET /stats/:code</code> DB error (any query)</td>\n<td><code>errgroup.Wait</code></td>\n<td>500 response</td>\n<td>500</td>\n<td>Error</td>\n<td></td>\n</tr>\n<tr>\n<td><code>GET /stats/.../timeline</code> invalid interval</td>\n<td>param validation</td>\n<td>400 response</td>\n<td>400</td>\n<td>none</td>\n<td></td>\n</tr>\n<tr>\n<td><code>GET /stats/.../timeline</code> DB error</td>\n<td><code>clickStore.TimelineBuckets</code></td>\n<td>500 response</td>\n<td>500</td>\n<td>Error</td>\n<td></td>\n</tr>\n</tbody></table>\n<p><strong><code>writeError</code> and <code>writeJSON</code> helpers (<code>errors.go</code>):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// errors.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> analytics</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">encoding/json</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> writeError</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">status</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">message</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(status)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">NewEncoder</span><span style=\"color:#E1E4E8\">(w).</span><span style=\"color:#B392F0\">Encode</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Error </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"error\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }{Error: message})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> writeJSON</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">status</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">v</span><span style=\"color:#B392F0\"> any</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(status)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">NewEncoder</span><span style=\"color:#E1E4E8\">(w).</span><span style=\"color:#B392F0\">Encode</span><span style=\"color:#E1E4E8\">(v)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// truncate returns at most n bytes of s for safe logging of untrusted bodies.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> truncate</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">s</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">n</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(s) </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#E1E4E8\"> n {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> s</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> s[:n] </span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\"> \"...\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<hr>\n<h2 id=\"7-concurrency-specification\">7. Concurrency Specification</h2>\n<table>\n<thead>\n<tr>\n<th>Component</th>\n<th>Goroutine Model</th>\n<th>Shared State</th>\n<th>Thread Safety</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>ClickConsumer.Run</code></td>\n<td>1 dedicated goroutine</td>\n<td><code>*pgxpool.Pool</code>, <code>ClickRepository</code>, <code>MilestoneRepository</code>, <code>DeduplicationRepository</code>, <code>*amqp.Channel</code></td>\n<td>✅ All safe; single goroutine owns AMQP channel — no mutex needed</td>\n</tr>\n<tr>\n<td><code>StatsHandler.Stats</code></td>\n<td>per-request (net/http)</td>\n<td><code>ClickRepository</code> (pool)</td>\n<td>✅ pgxpool goroutine-safe</td>\n</tr>\n<tr>\n<td><code>StatsHandler.Timeline</code></td>\n<td>per-request (net/http)</td>\n<td><code>ClickRepository</code> (pool)</td>\n<td>✅ Same</td>\n</tr>\n<tr>\n<td><code>errgroup</code> goroutines in Stats handler</td>\n<td>4 sub-goroutines per request</td>\n<td><code>ClickRepository</code> (pool)</td>\n<td>✅ pgxpool handles concurrent Acquire internally</td>\n</tr>\n<tr>\n<td><code>amqpAnalyticsPublisher.PublishMilestone</code></td>\n<td>called only from consumer goroutine</td>\n<td><code>*amqp.Channel</code></td>\n<td>✅ Single caller; no mutex needed</td>\n</tr>\n<tr>\n<td><code>consumer.healthy</code> atomic</td>\n<td>read by health handler, written by consumer</td>\n<td><code>atomic.Bool</code></td>\n<td>✅ Lock-free atomic</td>\n</tr>\n</tbody></table>\n<p><strong>AMQP prefetch=1 consequence:</strong> The consumer goroutine processes exactly one message at a time. The broker will not deliver the next message until <code>d.Ack()</code> or <code>d.Nack()</code> is called. This provides the sequential processing guarantee without explicit locking in the consumer loop.\n<strong>No mutex on AMQP channel:</strong> Unlike url-service which has 3 workers sharing one channel, analytics-service has exactly one goroutine (the consumer) using the AMQP channel for both consuming and publishing. No concurrent access occurs.\n<strong><code>atomic.Bool</code> for health state:</strong> The <code>healthy</code> field is written by the consumer goroutine and read by HTTP handler goroutines. Using <code>sync/atomic.Bool</code> (Go 1.19+) avoids a mutex on the hot health-check path:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// consumer.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> ClickConsumer</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // ...</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    healthy </span><span style=\"color:#B392F0\">atomic</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// health.go (extended from M1 for consumer health awareness)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">c </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">ClickConsumer</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">IsHealthy</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> c.healthy.</span><span style=\"color:#B392F0\">Load</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Note on <code>/health</code> during consumer pause:</strong> The spec requires <code>/health</code> to return <code>200</code> even when RabbitMQ is down. The health handler checks HTTP server liveness only (<code>{&quot;status&quot;:&quot;ok&quot;,&quot;service&quot;:&quot;analytics-service&quot;}</code>). It does NOT check <code>consumer.IsHealthy()</code> — consumer state is operational metadata, not liveness. A Kubernetes readiness probe could check consumer health separately, but that is outside this project&#39;s scope.</p>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-24.svg\" alt=\"Consumer Message Processing State Machine\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Transaction boundary within processDelivery:\n  ┌──────────────────────────────────────────────────────────────────┐\n  │  BEGIN TRANSACTION                                               │\n  │                                                                  │\n  │  dedupStore.Exists(tx, evt.EventID)                              │\n  │       │                                                          │\n  │   exists=true ──► tx.Rollback() → d.Ack() → return              │\n  │       │                                                          │\n  │   exists=false                                                   │\n  │       │                                                          │\n  │  dedupStore.Insert(tx, evt.EventID)                              │\n  │       │                                                          │\n  │  clickStore.Insert(tx, &amp;ClickRecord{...})                        │\n  │       │                                                          │\n  │  checker.CheckAndPublish(ctx, tx, code, ...)                     │\n  │       │                                                          │\n  │       ├── SELECT COUNT(*) FROM clicks WHERE short_code=? (on tx) │\n  │       │                                                          │\n  │       ├── for each threshold [10, 100, 1000]:                    │\n  │       │     milestoneStore.HasMilestone(tx, code, threshold)     │\n  │       │       │                                                  │\n  │       │   not recorded yet                                       │\n  │       │       │                                                  │\n  │       │     milestoneStore.Insert(tx, code, threshold)           │\n  │       │       │                                                  │\n  │       │     publisher.PublishMilestone(ctx, evt)  ◄─ OUTSIDE tx  │\n  │       │       │                                                  │\n  │       │     (publish fail → log + continue; tx not affected)     │\n  │       │                                                          │\n  │  COMMIT TRANSACTION                                              │\n  │                                                                  │\n  │  d.Ack(false)                                                    │\n  └──────────────────────────────────────────────────────────────────┘\n  If any step errors before COMMIT: tx.Rollback() + d.Nack(false, true)\n  If COMMIT fails: d.Nack(false, true)\n  If publish fails after milestone INSERT but before COMMIT:\n    publish failure is logged; COMMIT still proceeds (milestone is durable)</code></pre></div>\n\n<hr>\n<h2 id=\"8-implementation-sequence-with-checkpoints\">8. Implementation Sequence with Checkpoints</h2>\n<h3 id=\"phase-1-db-schema-clicks-milestones-processed_events-tables-1h\">Phase 1: DB Schema — <code>clicks</code>, <code>milestones</code>, <code>processed_events</code> Tables (1h)</h3>\n<ol>\n<li>Write <code>migration.sql</code> as specified in §3.1.</li>\n<li>Write <code>runMigrations</code> function in <code>main.go</code> (same pattern as url-service).</li>\n<li>Extend <code>config.go</code> to add <code>IPHashSalt</code>.</li>\n<li>Run against Docker <code>analytics_db</code>:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> up</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#79B8FF\"> -d</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">DATABASE_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"postgres://analyticsuser:analyticspass@localhost:5433/analyticsdb\"</span><span style=\"color:#B392F0\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">RABBITMQ_URL=</span><span style=\"color:#9ECBFF\">\"amqp://guest:guest@localhost:5672/\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">go </span><span style=\"color:#9ECBFF\">run</span><span style=\"color:#9ECBFF\"> ./services/analytics-service/</span></span></code></pre></div>\n\n<ol>\n<li>Verify schema:</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">psql</span><span style=\"color:#79B8FF\"> -h</span><span style=\"color:#9ECBFF\"> localhost</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 5433</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analyticsuser</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analyticsdb</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -c</span><span style=\"color:#9ECBFF\"> \"\\d clicks; \\d milestones; \\d processed_events; \\di idx_clicks_*; \\di idx_milestones_*;\"</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> Tables <code>clicks</code>, <code>milestones</code>, <code>processed_events</code> exist with correct columns and types. All five indexes visible in <code>\\di</code> output. Service starts and logs <code>&quot;analytics migrations applied&quot;</code>. <code>go build ./services/analytics-service/...</code> exits 0.</p>\n<h3 id=\"phase-2-amqp-consumer-goroutine-prefetch-message-loop-panic-recovery-idempotency-225h\">Phase 2: AMQP Consumer Goroutine — Prefetch, Message Loop, Panic Recovery, Idempotency (2–2.5h)</h3>\n<ol>\n<li>Write <code>errors.go</code>: <code>writeError</code>, <code>writeJSON</code>, <code>truncate</code>.</li>\n<li>Write <code>haship.go</code>: <code>hashIP</code>, <code>newUUID</code>.</li>\n<li>Write <code>store.go</code>: <code>ClickRecord</code>, <code>MilestoneRecord</code>, all three repository interfaces, <code>pgxClickStore</code> stub (Insert + CountByCode only), <code>pgxMilestoneStore</code> stub (HasMilestone + Insert), <code>pgxDeduplicationStore</code> (both methods).</li>\n<li>Write <code>publisher.go</code>: <code>AnalyticsPublisher</code> interface, <code>amqpAnalyticsPublisher</code>, <code>PublishMilestone</code>.</li>\n<li>Write <code>milestone.go</code>: <code>MilestoneChecker</code> struct, <code>NewMilestoneChecker</code>, <code>CheckAndPublish</code> (stub returning nil for now — complete in Phase 3).</li>\n<li>Write <code>consumer.go</code>: <code>ClickConsumer</code>, <code>NewClickConsumer</code>, <code>Run</code>, <code>processDelivery</code> (full algorithm from §5.1 and §5.2).</li>\n<li>Wire consumer in <code>main.go</code>: construct all stores, call <code>go consumer.Run(ctx)</code>.</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> up</span><span style=\"color:#9ECBFF\"> analytics_db</span><span style=\"color:#9ECBFF\"> rabbitmq</span><span style=\"color:#79B8FF\"> -d</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Start url-service too so it publishes events on redirect</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> up</span><span style=\"color:#9ECBFF\"> url-service</span><span style=\"color:#79B8FF\"> -d</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Start analytics-service</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">DATABASE_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">...</span><span style=\"color:#E1E4E8\"> RABBITMQ_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">...</span><span style=\"color:#B392F0\"> go</span><span style=\"color:#9ECBFF\"> run</span><span style=\"color:#9ECBFF\"> ./services/analytics-service/</span></span></code></pre></div>\n\n<p>Manually trigger a URL click (against url-service):</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> http://localhost:8081/</span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#9ECBFF\">short_cod</span><span style=\"color:#E1E4E8\">e</span><span style=\"color:#F97583\">></span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> Consumer logs <code>&quot;click processed&quot;</code> with <code>event_id</code> and <code>short_code</code>. <code>psql -h localhost -p 5433 -U analyticsuser -d analyticsdb -c &quot;SELECT * FROM clicks LIMIT 5;&quot;</code> shows a row. <code>processed_events</code> has the <code>event_id</code>. Sending the <strong>same</strong> AMQP message twice (use RabbitMQ management UI to redeliver) logs <code>&quot;duplicate event skipped&quot;</code> and <code>clicks</code> count stays at 1.</p>\n<h3 id=\"phase-3-click-insert-milestone-check-milestonereachedevent-publish-one-transaction-225h\">Phase 3: Click Insert, Milestone Check, <code>MilestoneReachedEvent</code> Publish — One Transaction (2–2.5h)</h3>\n<ol>\n<li>Complete <code>pgxClickStore.Insert</code> with <code>pgtype.Text</code> for nullable referer.</li>\n<li>Complete all remaining <code>pgxClickStore</code> methods (<code>CountByCode</code>, <code>CountByCodeSince</code>, <code>TopReferers</code>, <code>TimelineBuckets</code>).</li>\n<li>Complete <code>MilestoneChecker.CheckAndPublish</code> (full algorithm from §5.2).</li>\n<li>Add <code>pgxMilestoneStore.HasMilestone</code> and <code>pgxMilestoneStore.Insert</code> (full implementations).</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Send 10 click events for the same short_code</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> $(</span><span style=\"color:#B392F0\">seq</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#79B8FF\"> 10</span><span style=\"color:#E1E4E8\">); </span><span style=\"color:#F97583\">do</span><span style=\"color:#B392F0\"> curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#9ECBFF\"> http://localhost:8081/</span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#9ECBFF\">short_cod</span><span style=\"color:#E1E4E8\">e</span><span style=\"color:#F97583\">></span><span style=\"color:#F97583\"> ></span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">done</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 3</span><span style=\"color:#6A737D\">  # wait for outbox poller</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">psql</span><span style=\"color:#79B8FF\"> -h</span><span style=\"color:#9ECBFF\"> localhost</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 5433</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analyticsuser</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analyticsdb</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -c</span><span style=\"color:#9ECBFF\"> \"SELECT short_code, milestone, triggered_at FROM milestones;\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: one row with milestone=10</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># RabbitMQ management UI → notifications.events queue → should show 1 message</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> After 10 redirects, <code>milestones</code> table has one row <code>(short_code=&lt;code&gt;, milestone=10)</code>. After 100 total redirects, a second row appears with <code>milestone=100</code>. Sending duplicate events does not create additional milestone rows. <code>MilestoneReachedEvent</code> appears in <code>notifications.events</code> queue (verify via RabbitMQ management UI or by checking queue depth).</p>\n<h3 id=\"phase-4-get-statscode-and-get-statscodetimeline-handlers-152h\">Phase 4: <code>GET /stats/:code</code> and <code>GET /stats/:code/timeline</code> Handlers (1.5–2h)</h3>\n<ol>\n<li>Write <code>handler.go</code>: <code>StatsHandler</code>, <code>NewStatsHandler</code>, <code>Stats</code> method, <code>Timeline</code> method.</li>\n<li>Register routes in <code>main.go</code> (already shown in §5.8).</li>\n<li>Test queries with EXPLAIN ANALYZE.</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># After inserting 20+ clicks across different times and referers:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> http://localhost:8082/stats/</span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#9ECBFF\">short_cod</span><span style=\"color:#E1E4E8\">e</span><span style=\"color:#F97583\">></span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: {\"short_code\":\"...\",\"total_clicks\":20,\"clicks_last_24h\":20,\"clicks_last_7d\":20,\"top_referers\":[]}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> \"http://localhost:8082/stats/&#x3C;short_code>/timeline?interval=day\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: {\"short_code\":\"...\",\"interval\":\"day\",\"points\":[{\"period\":\"2026-03-02T00:00:00Z\",\"clicks\":20}]}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> \"http://localhost:8082/stats/&#x3C;short_code>/timeline?interval=hour\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: [{...}] bucketed by hour</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> \"http://localhost:8082/stats/&#x3C;short_code>/timeline?interval=week\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: 400 {\"error\":\"interval must be \\\"day\\\" or \\\"hour\\\"\"}</span></span></code></pre></div>\n\n<p><strong>EXPLAIN ANALYZE verification:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">psql</span><span style=\"color:#79B8FF\"> -h</span><span style=\"color:#9ECBFF\"> localhost</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 5433</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analyticsuser</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analyticsdb</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">EXPLAIN ANALYZE</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">SELECT COUNT(*) FROM clicks</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">WHERE short_code = 'abc1234' AND clicked_at >= now() - interval '24 hours';</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Must show: Index Scan using idx_clicks_short_code_time</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> All four route variants return correct responses. EXPLAIN ANALYZE on <code>CountByCodeSince</code> shows <code>idx_clicks_short_code_time</code>. EXPLAIN ANALYZE on <code>TopReferers</code> shows <code>idx_clicks_referer</code>. <code>GET /health</code> still returns <code>200</code> regardless of RabbitMQ state.</p>\n<h3 id=\"phase-5-test-duplicate-urlclickedevent-click-count-1-1h\">Phase 5: Test — Duplicate <code>URLClickedEvent</code> → Click Count = 1 (1h)</h3>\n<ol>\n<li>Write <code>analytics_test.go</code> covering all test cases from §9.</li>\n<li>Run unit tests (mock stores) without Docker.</li>\n<li>Run integration tests with Docker <code>analytics_db</code>.</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Unit tests (no DB needed)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">go</span><span style=\"color:#9ECBFF\"> test</span><span style=\"color:#9ECBFF\"> ./services/analytics-service/...</span><span style=\"color:#79B8FF\"> -run</span><span style=\"color:#9ECBFF\"> TestUnit</span><span style=\"color:#79B8FF\"> -v</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Integration test (requires running analytics_db)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">DATABASE_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"postgres://analyticsuser:analyticspass@localhost:5433/analyticsdb\"</span><span style=\"color:#B392F0\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">RABBITMQ_URL=</span><span style=\"color:#9ECBFF\">\"amqp://guest:guest@localhost:5672/\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">go </span><span style=\"color:#9ECBFF\">test</span><span style=\"color:#9ECBFF\"> ./services/analytics-service/...</span><span style=\"color:#79B8FF\"> -run</span><span style=\"color:#9ECBFF\"> TestIntegration</span><span style=\"color:#79B8FF\"> -tags</span><span style=\"color:#9ECBFF\"> integration</span><span style=\"color:#79B8FF\"> -v</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> <code>TestDuplicateEventIDCountIsOne</code> passes: after processing the same <code>URLClickedEvent</code> twice (same <code>event_id</code>), <code>CountByCode</code> returns 1. <code>TestMilestoneTriggeredAtExactly10</code> passes. <code>TestPoisonMessageAcked</code> passes (malformed JSON → consumer continues, no nack). All unit tests green. <code>go test ./services/analytics-service/...</code> exits 0.</p>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-25.svg\" alt=\"Idempotent Click Insert Sequence\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Test scenario: duplicate URLClickedEvent\n  event_id = &quot;evt-abc-123&quot;\n  short_code = &quot;xyz7890&quot;\n  Message 1 delivered:\n    tx.Begin()\n    dedupStore.Exists(tx, &quot;evt-abc-123&quot;) → false\n    dedupStore.Insert(tx, &quot;evt-abc-123&quot;)\n    clickStore.Insert(tx, ClickRecord{ShortCode:&quot;xyz7890&quot;,...})\n    checker.CheckAndPublish(tx, &quot;xyz7890&quot;,...)\n    tx.Commit()\n    d.Ack()\n  Message 2 delivered (same event_id, redelivered by broker):\n    tx.Begin()\n    dedupStore.Exists(tx, &quot;evt-abc-123&quot;) → true   ← PRIMARY KEY hit\n    tx.Rollback()\n    d.Ack()   ← NOT Nack; duplicate is permanently consumed\n  Result:\n    clicks table: 1 row\n    processed_events: 1 row\n    CountByCode(&quot;xyz7890&quot;) = 1   ✓</code></pre></div>\n\n<hr>\n<h2 id=\"9-test-specification\">9. Test Specification</h2>\n<h3 id=\"91-unit-tests-milestonechecker-mock-stores\">9.1 Unit Tests — <code>MilestoneChecker</code> (mock stores)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// analytics_test.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> analytics</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">errors</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync/atomic</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/jackc/pgx/v5</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourhandle/url-shortener/shared/events</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// mockClickStore implements ClickRepository for testing</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> mockClickStore</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    insertFn           </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">rec</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">ClickRecord</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    countByCodeFn      </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">code</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    countByCodeSinceFn </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">code</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">since</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    topReferersFn      </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">code</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">n</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">RefererCount</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    timelineFn         </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">code</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">unit</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">TimelinePoint</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// (implement all ClickRepository methods by delegating to Fn fields)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// mockMilestoneStore implements MilestoneRepository for testing</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> mockMilestoneStore</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    hasMilestoneFn </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">code</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">m</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    insertFn       </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">tx</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">code</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">m</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// mockPublisher implements AnalyticsPublisher for testing</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> mockPublisher</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    publishCount </span><span style=\"color:#F97583\">int32</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    publishErr   </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    publishFn    </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">evt</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">MilestoneReachedEvent</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">m </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">mockPublisher</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">PublishMilestone</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">evt</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">MilestoneReachedEvent</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    atomic.</span><span style=\"color:#B392F0\">AddInt32</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">m.publishCount, </span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> m.publishFn </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> m.</span><span style=\"color:#B392F0\">publishFn</span><span style=\"color:#E1E4E8\">(ctx, evt) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> m.publishErr</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestMilestoneChecker_NoMilestoneBelow10</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    totalClicks </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> int64</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">9</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    clickStore </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockClickStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // CountByCode on tx returns 9</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    checker </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewMilestoneChecker</span><span style=\"color:#E1E4E8\">(clickStore, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">mockMilestoneStore</span><span style=\"color:#E1E4E8\">{}, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">mockPublisher</span><span style=\"color:#E1E4E8\">{}, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // pass a mock tx that returns 9 for COUNT(*)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // verify publishCount == 0</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // verify hasMilestone never called (optimization: skip check when below min threshold)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestMilestoneChecker_Threshold10Triggered</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    publisher </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockPublisher</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    milestoneStore </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockMilestoneStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        hasMilestoneFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">m</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#6A737D\"> // not yet recorded</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        insertFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">m</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // totalClicks = 10 (from mock tx COUNT query)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Run CheckAndPublish</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert publisher.publishCount == 1</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert published milestone == 10</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> publisher.publishCount </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected 1 publish, got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, publisher.publishCount)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestMilestoneChecker_AlreadyRecorded_NoPublish</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    publisher </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockPublisher</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    milestoneStore </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockMilestoneStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        hasMilestoneFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">m</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> true</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#6A737D\"> // already recorded for all thresholds</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // totalClicks = 100; all thresholds already recorded</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // publishCount must remain 0</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> publisher.publishCount </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"must not publish when milestone already recorded\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestMilestoneChecker_PublishFailureContinues</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // publisher returns error</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    publisher </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockPublisher</span><span style=\"color:#E1E4E8\">{publishErr: errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"amqp down\"</span><span style=\"color:#E1E4E8\">)}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    milestoneStore </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockMilestoneStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        hasMilestoneFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">m</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        insertFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">m</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // totalClicks = 10</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // CheckAndPublish must return nil (publish failure is non-fatal)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // err := checker.CheckAndPublish(ctx, tx, code, \"\", \"\", \"\")</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // if err != nil { t.Errorf(\"expected nil, got %v\", err) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestMilestoneChecker_MultipleThresholdsAtOnce</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // totalClicks = 1000 and no milestones recorded yet</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expect: 3 publishes (10, 100, 1000) and 3 inserts</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    publisher </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockPublisher</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    insertCount </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    milestoneStore </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockMilestoneStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        hasMilestoneFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">m</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">bool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> false</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        insertFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> pgx</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Tx</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">m</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            insertCount</span><span style=\"color:#F97583\">++</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // run with totalClicks=1000</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> publisher.publishCount </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 3</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected 3 publishes, got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, publisher.publishCount)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> insertCount </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 3</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected 3 milestone inserts, got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, insertCount)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"92-unit-tests-consumer-idempotency-and-poison-messages\">9.2 Unit Tests — Consumer Idempotency and Poison Messages</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcessDelivery_DuplicateEventID_SingleClick</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Integration-style test using miniredis-equivalent for DB: testcontainers or real analyticsdb</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 1. Create consumer with real pool (requires analytics_db running)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 2. Build a valid URLClickedEvent JSON with event_id = \"dedup-test-001\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 3. Call consumer.processDelivery twice with the same event_id</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // 4. Assert clickStore.CountByCode returns 1</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // This is the PRIMARY acceptance criterion for M4.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcessDelivery_MalformedJSON_Acked</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Create a mock amqp.Delivery with Body = []byte(\"not json\")</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Call processDelivery</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert: delivery was Acked (not Nacked)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert: no click row inserted</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Implementation note: wrap amqp.Delivery to allow test inspection of Ack/Nack calls</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcessDelivery_MissingEventID_Acked</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Body = valid JSON but event_id = \"\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert: Acked, no click row</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcessDelivery_MissingShortCode_Acked</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Body = valid JSON but short_code = \"\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert: Acked, no click row</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestProcessDelivery_DBError_Nacked</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Mock pool.Begin to fail</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert: Nacked with requeue=true</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"93-unit-tests-statshandler\">9.3 Unit Tests — <code>StatsHandler</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestStatsHandler_Returns200WithZeros_UnknownCode</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockClickStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        countByCodeFn:      </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) { </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        countByCodeSinceFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) { </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        topReferersFn:      </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">RefererCount</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#B392F0\">RefererCount</span><span style=\"color:#E1E4E8\">{}, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewStatsHandler</span><span style=\"color:#E1E4E8\">(store, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/stats/nonexistent\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req.</span><span style=\"color:#B392F0\">SetPathValue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"code\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"nonexistent\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h.</span><span style=\"color:#B392F0\">Stats</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 200</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected 200, got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, rec.Code)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> resp </span><span style=\"color:#B392F0\">statsResponse</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">(rec.Body.</span><span style=\"color:#B392F0\">Bytes</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">resp)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> resp.TotalClicks </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"total_clicks should be 0\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> resp.TopReferers </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"top_referers must be [] not null\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestStatsHandler_TopReferers_MaxFive</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockClickStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        countByCodeFn:      </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) { </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> 100</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        countByCodeSinceFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) { </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> 50</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        topReferersFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">n</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">RefererCount</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> n </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 5</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected n=5, got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, n) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#B392F0\">RefererCount</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                {</span><span style=\"color:#9ECBFF\">\"https://google.com\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">40</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                {</span><span style=\"color:#9ECBFF\">\"https://twitter.com\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">20</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                {</span><span style=\"color:#9ECBFF\">\"https://reddit.com\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">15</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                {</span><span style=\"color:#9ECBFF\">\"https://hn.algolia.com\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                {</span><span style=\"color:#9ECBFF\">\"https://lobste.rs\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">5</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewStatsHandler</span><span style=\"color:#E1E4E8\">(store, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/stats/abc1234\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req.</span><span style=\"color:#B392F0\">SetPathValue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"code\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"abc1234\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h.</span><span style=\"color:#B392F0\">Stats</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> resp </span><span style=\"color:#B392F0\">statsResponse</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">(rec.Body.</span><span style=\"color:#B392F0\">Bytes</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">resp)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(resp.TopReferers) </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 5</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected 5 top_referers, got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(resp.TopReferers))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> resp.TopReferers[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">].Referer </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"https://google.com\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"first referer wrong: </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, resp.TopReferers[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">].Referer)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestStatsHandler_DBError_Returns500</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockClickStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        countByCodeFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"db down\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        countByCodeSinceFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">int64</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) { </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        topReferersFn:      </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">RefererCount</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) { </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\"> },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewStatsHandler</span><span style=\"color:#E1E4E8\">(store, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/stats/abc1234\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req.</span><span style=\"color:#B392F0\">SetPathValue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"code\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"abc1234\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h.</span><span style=\"color:#B392F0\">Stats</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 500</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected 500, got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, rec.Code) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestTimelineHandler_InvalidInterval_Returns400</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewStatsHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">mockClickStore</span><span style=\"color:#E1E4E8\">{}, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, bad </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"week\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"month\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"DAY\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"Hour\"</span><span style=\"color:#E1E4E8\">} {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Run</span><span style=\"color:#E1E4E8\">(bad, </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/stats/abc/timeline?interval=\"</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">bad, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            req.</span><span style=\"color:#B392F0\">SetPathValue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"code\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"abc\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            h.</span><span style=\"color:#B392F0\">Timeline</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 400</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"interval=</span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">: expected 400, got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, bad, rec.Code)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestTimelineHandler_ValidIntervals_Return200</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockClickStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        timelineFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#B392F0\">TimelinePoint</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#B392F0\">TimelinePoint</span><span style=\"color:#E1E4E8\">{}, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewStatsHandler</span><span style=\"color:#E1E4E8\">(store, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, good </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"day\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"hour\"</span><span style=\"color:#E1E4E8\">} {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Run</span><span style=\"color:#E1E4E8\">(good, </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/stats/abc/timeline?interval=\"</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">good, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            req.</span><span style=\"color:#B392F0\">SetPathValue</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"code\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"abc\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            h.</span><span style=\"color:#B392F0\">Timeline</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 200</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"interval=</span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">: expected 200, got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, good, rec.Code)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            var</span><span style=\"color:#E1E4E8\"> resp </span><span style=\"color:#B392F0\">timelineResponse</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">(rec.Body.</span><span style=\"color:#B392F0\">Bytes</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">resp)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> resp.Points </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"points must be [] not null\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"94-integration-test-duplicate-urlclickedevent-click-count-1-primary-acceptance-criterion\">9.4 Integration Test — Duplicate <code>URLClickedEvent</code> → Click Count = 1 (Primary Acceptance Criterion)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// +build integration</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Run: DATABASE_URL=... RABBITMQ_URL=... go test -tags integration -run TestIntegrationDuplicate ./services/analytics-service/</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestIntegrationDuplicateEventIDCountIsOne</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> loadConfig</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Skipf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"config not available: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewDBPool</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), cfg.DatabaseURL, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"db: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    t.</span><span style=\"color:#B392F0\">Cleanup</span><span style=\"color:#E1E4E8\">(pool.Close)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> runMigrations</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), pool, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">()); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"migrate: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    clickStore     </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewClickStore</span><span style=\"color:#E1E4E8\">(pool)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    milestoneStore </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewMilestoneStore</span><span style=\"color:#E1E4E8\">(pool)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    dedupStore     </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewDeduplicationStore</span><span style=\"color:#E1E4E8\">(pool)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    publisher      </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockPublisher</span><span style=\"color:#E1E4E8\">{} </span><span style=\"color:#6A737D\">// don't need real RabbitMQ for this test</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    checker        </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewMilestoneChecker</span><span style=\"color:#E1E4E8\">(clickStore, milestoneStore, publisher, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Unique short_code and event_id for this test run</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    testCode    </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Sprintf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"tst</span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">UnixNano</span><span style=\"color:#E1E4E8\">()</span><span style=\"color:#F97583\">%</span><span style=\"color:#79B8FF\">100000</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    testEventID </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> newUUID</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Build a valid URLClickedEvent payload</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    evt </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URLClickedEvent</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        BaseEvent: </span><span style=\"color:#B392F0\">events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">BaseEvent</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            EventType:  events.EventTypeURLClicked,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            OccurredAt: time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">UTC</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            EventID:    testEventID,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ShortCode: testCode,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        IPHash:    </span><span style=\"color:#9ECBFF\">\"aabbcc\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        UserAgent: </span><span style=\"color:#9ECBFF\">\"test-agent\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ClickedAt: time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">UTC</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    body, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Marshal</span><span style=\"color:#E1E4E8\">(evt)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Helper: simulate processDelivery logic directly (without real AMQP)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    processOnce </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        tx, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> pool.</span><span style=\"color:#B392F0\">Begin</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> err }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        exists, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> dedupStore.</span><span style=\"color:#B392F0\">Exists</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), tx, testEventID)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { tx.</span><span style=\"color:#B392F0\">Rollback</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">()); </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> err }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> exists {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            tx.</span><span style=\"color:#B392F0\">Rollback</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#6A737D\"> // duplicate — expected on second call</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> dedupStore.</span><span style=\"color:#B392F0\">Insert</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), tx, testEventID); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            tx.</span><span style=\"color:#B392F0\">Rollback</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">()); </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> err</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">ClickRecord</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            ShortCode: evt.ShortCode,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            ClickedAt: evt.ClickedAt,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            IPHash:    evt.IPHash,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            UserAgent: evt.UserAgent,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> clickStore.</span><span style=\"color:#B392F0\">Insert</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), tx, rec); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            tx.</span><span style=\"color:#B392F0\">Rollback</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">()); </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> err</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> checker.</span><span style=\"color:#B392F0\">CheckAndPublish</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), tx, testCode, </span><span style=\"color:#9ECBFF\">\"\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"\"</span><span style=\"color:#E1E4E8\">); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            tx.</span><span style=\"color:#B392F0\">Rollback</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">()); </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> err</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> tx.</span><span style=\"color:#B392F0\">Commit</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Process the same event twice</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> processOnce</span><span style=\"color:#E1E4E8\">(); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"first process: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> processOnce</span><span style=\"color:#E1E4E8\">(); err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"second process: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err) }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert click count is exactly 1</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    count, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> clickStore.</span><span style=\"color:#B392F0\">CountByCode</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), testCode)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"count: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> count </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"click count after 2 identical events: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">, want 1\"</span><span style=\"color:#E1E4E8\">, count)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert processed_events has exactly 1 row for this event_id</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> dedupCount </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool.</span><span style=\"color:#B392F0\">QueryRow</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"SELECT COUNT(*) FROM processed_events WHERE event_id = $1\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        testEventID,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ).</span><span style=\"color:#B392F0\">Scan</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">dedupCount)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> dedupCount </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"processed_events count: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">, want 1\"</span><span style=\"color:#E1E4E8\">, dedupCount)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    _ </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> body </span><span style=\"color:#6A737D\">// suppress unused warning</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestIntegrationMilestoneAt10</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert 10 unique URLClickedEvents for the same short_code</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert milestones table has exactly one row with milestone=10</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert CountByCode = 10</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestIntegrationTopReferers</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert 20 clicks: 10 from \"https://google.com\", 5 from \"https://twitter.com\", 5 with nil referer</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Call TopReferers(code, 5)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert: 2 entries returned; google.com first with count=10</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert: nil-referer clicks NOT included</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestIntegrationTimelineDay</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert 5 clicks on 2026-03-01 and 3 clicks on 2026-03-02 (via direct INSERT with past clicked_at)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Call TimelineBuckets(code, \"day\")</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert: 2 TimelinePoints returned, ordered ASC</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Assert: point[0].Clicks == 5, point[1].Clicks == 3</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-26.svg\" alt=\"IP Anonymization: SHA-256 Hash with Per-Service Salt\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Integration test: duplicate event flow\n  Test                   analytics-service              analytics_db\n  process logic                layer                      (real DB)\n      │                         │                            │\n      ├──processOnce(evt-A)─────►                            │\n      │                         ├─BEGIN─────────────────────►│\n      │                         ├─Exists(&quot;evt-A&quot;)────────────►│\n      │                         │◄──false────────────────────┤\n      │                         ├─Insert(&quot;evt-A&quot;)────────────►│\n      │                         ├─INSERT clicks──────────────►│\n      │                         ├─COUNT(*) clicks─────────────►│\n      │                         │◄──1────────────────────────┤\n      │                         ├─COMMIT─────────────────────►│\n      │◄──nil────────────────────┤                            │\n      │                         │                            │\n      ├──processOnce(evt-A)─────► (same event_id)            │\n      │                         ├─BEGIN─────────────────────►│\n      │                         ├─Exists(&quot;evt-A&quot;)────────────►│\n      │                         │◄──true─────────────────────┤ ← PRIMARY KEY hit\n      │                         ├─ROLLBACK───────────────────►│\n      │◄──nil (no error)─────────┤                            │\n      │                         │                            │\n      ├─CountByCode()───────────►                            │\n      │                         ├─SELECT COUNT(*)────────────►│\n      │                         │◄──1────────────────────────┤\n      │◄──1──────────────────────┤                            │\n      │                         │                            │\n  assert count == 1 ✓</code></pre></div>\n\n<h3 id=\"95-pgxclickstore-referer-null-handling-test\">9.5 <code>pgxClickStore</code> Referer NULL Handling Test</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestClickInsert_NullReferer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert a ClickRecord with Referer = \"\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Verify the database stores NULL (not empty string \"\")</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // SELECT referer FROM clicks WHERE id = inserted_id → should return NULL</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // This ensures the partial index idx_clicks_referer filters it out correctly</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestClickInsert_NonNullReferer</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert a ClickRecord with Referer = \"https://example.com\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // SELECT referer FROM clicks WHERE id = inserted_id → should return \"https://example.com\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // SELECT COUNT(*) FROM clicks WHERE short_code = ? AND referer IS NOT NULL → 1</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<hr>\n<h2 id=\"10-performance-targets\">10. Performance Targets</h2>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>Target</th>\n<th>How to Measure</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>URLClickedEvent</code> consumer processing (dedup + click insert + milestone check + ack)</td>\n<td>&lt; 50ms p99</td>\n<td>Log <code>duration_ms</code> in <code>processDelivery</code>; after processing 1000 messages, check log percentiles with <code>jq</code></td>\n</tr>\n<tr>\n<td><code>GET /stats/:code</code> (4 concurrent aggregation queries)</td>\n<td>&lt; 30ms p99</td>\n<td><code>wrk -t4 -c20 -d30s http://localhost:8082/stats/&lt;code&gt;</code> → Latency 99th &lt; 30ms</td>\n</tr>\n<tr>\n<td><code>GET /stats/:code/timeline?interval=day</code></td>\n<td>&lt; 50ms p99</td>\n<td><code>wrk -t4 -c20 -d30s &#39;http://localhost:8082/stats/&lt;code&gt;/timeline?interval=day&#39;</code></td>\n</tr>\n<tr>\n<td><code>GET /stats/:code/timeline?interval=hour</code></td>\n<td>&lt; 50ms p99</td>\n<td>Same as day</td>\n</tr>\n<tr>\n<td><code>GET /health</code></td>\n<td>&lt; 10ms p99</td>\n<td><code>wrk -t1 -c10 -d10s http://localhost:8082/health</code></td>\n</tr>\n<tr>\n<td><code>CountByCode</code> query (1M click rows)</td>\n<td>&lt; 20ms</td>\n<td><code>EXPLAIN ANALYZE SELECT COUNT(*) FROM clicks WHERE short_code = &#39;...&#39;</code> — must show Index Scan</td>\n</tr>\n<tr>\n<td><code>CountByCodeSince</code> query (1M rows, 24h window)</td>\n<td>&lt; 20ms</td>\n<td>Same; must show Index Scan using <code>idx_clicks_short_code_time</code></td>\n</tr>\n<tr>\n<td><code>TopReferers</code> query</td>\n<td>&lt; 15ms</td>\n<td><code>EXPLAIN ANALYZE SELECT referer, COUNT(*) ... WHERE short_code = &#39;...&#39; AND referer IS NOT NULL</code></td>\n</tr>\n<tr>\n<td>Consumer memory steady-state</td>\n<td>&lt; 30MB</td>\n<td><code>docker stats analytics-service-1</code> after 30 min of load</td>\n</tr>\n<tr>\n<td><code>processed_events</code> PRIMARY KEY lookup</td>\n<td>&lt; 1ms</td>\n<td><code>EXPLAIN ANALYZE SELECT EXISTS(SELECT 1 FROM processed_events WHERE event_id = &#39;...&#39;)</code></td>\n</tr>\n</tbody></table>\n<p><strong>EXPLAIN ANALYZE verification commands:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">psql</span><span style=\"color:#79B8FF\"> -h</span><span style=\"color:#9ECBFF\"> localhost</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 5433</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analyticsuser</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analyticsdb</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">EXPLAIN ANALYZE</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">SELECT COUNT(*) FROM clicks</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">WHERE short_code = 'abc1234' AND clicked_at >= now() - interval '24 hours';</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Must show: Index Scan using idx_clicks_short_code_time on clicks</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">psql</span><span style=\"color:#79B8FF\"> -h</span><span style=\"color:#9ECBFF\"> localhost</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 5433</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analyticsuser</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analyticsdb</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">EXPLAIN ANALYZE</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">SELECT referer, COUNT(*) AS cnt</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">FROM clicks</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">WHERE short_code = 'abc1234' AND referer IS NOT NULL</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">GROUP BY referer ORDER BY cnt DESC LIMIT 5;</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Must show: Index Scan using idx_clicks_referer (partial index)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">psql</span><span style=\"color:#79B8FF\"> -h</span><span style=\"color:#9ECBFF\"> localhost</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 5433</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> analyticsuser</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> analyticsdb</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">EXPLAIN ANALYZE</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">SELECT date_trunc('day', clicked_at AT TIME ZONE 'UTC') AS period, COUNT(*) AS clicks</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">FROM clicks WHERE short_code = 'abc1234'</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">GROUP BY period ORDER BY period ASC;</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># May show Seq Scan if row count is low (optimizer preference); with 10k+ rows, Index Scan expected</span></span></code></pre></div>\n\n<p><strong>Consumer throughput logging:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// In processDelivery, add timing instrumentation:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">start </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ... all processing steps ...</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">c.log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"click processed\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"event_id\"</span><span style=\"color:#E1E4E8\">,      evt.EventID,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"short_code\"</span><span style=\"color:#E1E4E8\">,    evt.ShortCode,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"duration_ms\"</span><span style=\"color:#E1E4E8\">,   time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(start).</span><span style=\"color:#B392F0\">Milliseconds</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"correlation_id\"</span><span style=\"color:#E1E4E8\">, corrID,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-27.svg\" alt=\"Stats API Query Data Flow\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>GET /stats/:code concurrency (errgroup):\n  StatsHandler.Stats\n        │\n        ├─ errgroup.WithContext(r.Context())\n        │\n        ├─ go CountByCode(gCtx, code) ──────────────────────────►\n        │                                                  analytics_db\n        ├─ go CountByCodeSince(gCtx, code, now-24h) ──────────────►\n        │                                                  (4 concurrent\n        ├─ go CountByCodeSince(gCtx, code, now-7d) ───────────────►  pool acquires)\n        │\n        ├─ go TopReferers(gCtx, code, 5) ─────────────────────────►\n        │\n        └─ g.Wait() ◄── blocks until all 4 return\n               │\n           if any error:\n               500 response\n           else:\n               200 statsResponse{...}\nPerformance: 4 queries run concurrently (~5ms each) → ~5ms total (parallelism)\n             vs sequential (~20ms) → errgroup gives ~4× speedup for this endpoint.\npgxpool.Acquire is goroutine-safe; 4 concurrent acquires from pool(MaxConns=10)\nall succeed without blocking given adequate pool size.</code></pre></div>\n\n<h3 id=\"101-gomod-additions-for-analytics-service\">10.1 <code>go.mod</code> Additions for Analytics Service</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>// services/analytics-service/go.mod\nmodule github.com/yourhandle/url-shortener/analytics-service\ngo 1.23\nrequire (\n    github.com/yourhandle/url-shortener/shared/events v0.0.0\n    github.com/yourhandle/url-shortener/shared/logger v0.0.0\n    github.com/jackc/pgx/v5 v5.6.0\n    github.com/rabbitmq/amqp091-go v1.10.0\n    golang.org/x/sync v0.7.0         // for errgroup in stats handler\n)\nreplace (\n    github.com/yourhandle/url-shortener/shared/events =&gt; ../../shared/events\n    github.com/yourhandle/url-shortener/shared/logger =&gt; ../../shared/logger\n)</code></pre></div>\n\n<p>Note: <code>golang.org/x/sync</code> provides <code>errgroup</code>. Alternatively, implement the four concurrent stats queries manually with goroutines + channels; <code>errgroup</code> is cleaner.</p>\n<h3 id=\"102-docker-composeyml-additions\">10.2 <code>docker-compose.yml</code> Additions</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">yaml</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#85E89D\">analytics-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    DATABASE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">postgres://analyticsuser:analyticspass@analytics_db:5432/analyticsdb</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    RABBITMQ_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">amqp://guest:guest@rabbitmq:5672/</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    IP_HASH_SALT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"change-this-random-salt\"</span><span style=\"color:#6A737D\"> # same salt as url-service for consistency</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    PORT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"8080\"</span></span></code></pre></div>\n\n<hr>\n<h2 id=\"11-anti-pattern-guard\">11. Anti-Pattern Guard</h2>\n<p>The following assertions must hold before this module is considered complete:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># 1. Analytics service never connects to url_db, user_db, or notification_db</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">grep</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> \"url_db\\|user_db\\|notification_db\\|5432\\|5434\\|5435\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  services/analytics-service/</span><span style=\"color:#79B8FF\">*</span><span style=\"color:#9ECBFF\">.go</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#9ECBFF\"> \"_test.go\"</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#79B8FF\"> echo</span><span style=\"color:#9ECBFF\"> \"PASS: no cross-DB access\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># 2. Analytics service never calls url-service HTTP API</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">grep</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> \"url-service\\|8081\\|url_service\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  services/analytics-service/</span><span style=\"color:#79B8FF\">*</span><span style=\"color:#9ECBFF\">.go</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#9ECBFF\"> \"_test.go\"</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#79B8FF\"> echo</span><span style=\"color:#9ECBFF\"> \"PASS: no sync call to url-service\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># 3. Analytics service never stores raw IP addresses</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">grep</span><span style=\"color:#79B8FF\"> -r</span><span style=\"color:#9ECBFF\"> \"RemoteAddr\\|r\\.RemoteAddr\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">  services/analytics-service/</span><span style=\"color:#79B8FF\">*</span><span style=\"color:#9ECBFF\">.go</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#9ECBFF\"> \"haship\\|_test\"</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#79B8FF\"> echo</span><span style=\"color:#9ECBFF\"> \"PASS: no raw IP storage\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># 4. Consumer uses manual Ack (not autoAck)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">grep</span><span style=\"color:#9ECBFF\"> \"autoAck.*false\\|false.*autoAck\"</span><span style=\"color:#9ECBFF\"> services/analytics-service/consumer.go</span><span style=\"color:#E1E4E8\"> &#x26;&#x26; </span><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"PASS\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  ||</span><span style=\"color:#79B8FF\"> echo</span><span style=\"color:#9ECBFF\"> \"FAIL: autoAck must be false\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># 5. Poison messages are Acked (not Nacked) — prevent requeue loop</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">grep</span><span style=\"color:#79B8FF\"> -A3</span><span style=\"color:#9ECBFF\"> \"json.Unmarshal.*err\"</span><span style=\"color:#9ECBFF\"> services/analytics-service/consumer.go</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#9ECBFF\"> \"Ack\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  &#x26;&#x26; </span><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"PASS: poison msg acked\"</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#79B8FF\"> echo</span><span style=\"color:#9ECBFF\"> \"FAIL: check Ack vs Nack on parse error\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># 6. No fmt.Println in handlers or consumer (use structured logger)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">grep</span><span style=\"color:#79B8FF\"> -n</span><span style=\"color:#9ECBFF\"> \"fmt.Println\\|fmt.Printf\"</span><span style=\"color:#9ECBFF\"> services/analytics-service/</span><span style=\"color:#79B8FF\">*</span><span style=\"color:#9ECBFF\">.go</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">  |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#9ECBFF\"> \"_test.go\"</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#79B8FF\"> echo</span><span style=\"color:#9ECBFF\"> \"PASS: no fmt.Println\"</span></span></code></pre></div>\n\n<hr>\n<!-- END_TDD_MOD -->\n\n<!-- TDD_MOD_ID: url-shortener-m5 -->\n\n<h1 id=\"notification-service-api-gateway-circuit-breaker\">Notification Service + API Gateway + Circuit Breaker</h1>\n<h2 id=\"module-id-url-shortener-m5\"><strong>Module ID:</strong> <code>url-shortener-m5</code></h2>\n<h2 id=\"1-module-charter\">1. Module Charter</h2>\n<p>This module implements the two final infrastructure pieces that complete the system: the Notification Service and the API Gateway. The Notification Service owns the <code>notifications</code> table in <code>notification_db</code>, consumes <code>url.created</code>, <code>url.deleted</code>, and <code>milestone.reached</code> routing keys from the <code>notifications.events</code> RabbitMQ queue, persists notification rows with status tracking, logs mock email sends, and exposes <code>GET /notifications</code> with JWT verification. The API Gateway is a pure infrastructure component that provides the single client-facing entry point: it routes requests to the appropriate upstream service, verifies JWT tokens on all <code>/api/*</code> routes except <code>/api/auth/*</code>, enforces per-IP token-bucket rate limiting via Redis INCR+EXPIRE, implements a three-state circuit breaker (CLOSED → OPEN → HALF_OPEN → CLOSED) protecting the url-service proxy path, propagates <code>X-Correlation-ID</code> through all forwarded requests, and emits structured JSON logs for every request.\nThis module does <strong>not</strong> implement any business logic in the gateway — the gateway has no knowledge of URL records, users, clicks, or analytics. It does <strong>not</strong> have the notification service call any other service to look up user email addresses — all necessary context (user email, short code) is carried in the event payload itself (established in M1 <code>shared/events</code>). It does <strong>not</strong> implement the outbox pattern in either the notification service or the gateway. It does <strong>not</strong> add new domain events — it only consumes events produced by prior milestones. The circuit breaker applies only to the url-service proxy; other upstream proxies use standard error handling.\n<strong>Upstream dependencies:</strong> <code>shared/events</code> (event structs), <code>shared/auth</code> (JWT verification), <code>shared/logger</code> (structured JSON logger — extended in this module with <code>correlation_id</code> default field), RabbitMQ <code>notifications.events</code> queue (declared in M1), <code>notification_db</code> PostgreSQL, Redis (shared instance from M1, now used by gateway for rate limiting).\n<strong>Downstream consumers:</strong> End users and API clients communicate exclusively through the gateway. No service calls the notification service.\n<strong>Invariants that must always hold:</strong></p>\n<ul>\n<li>The gateway contains zero domain logic — no imports of <code>shared/events</code>, no URL record lookups, no analytics queries.</li>\n<li>The circuit breaker state transitions are guarded by a single <code>sync.Mutex</code> — no goroutine ever reads <code>failures</code> or <code>lastFailure</code> without holding the lock.</li>\n<li>Redis errors in the rate limiter cause fail-open behavior (request is allowed through) and are logged at <code>Warn</code> — they never return 5xx to the client.</li>\n<li>JWT verification in the gateway is stateless local HMAC verification — the gateway never calls user-service per request.</li>\n<li>The notification service consumer is a single goroutine with <code>prefetch=1</code> — no concurrent message processing occurs.</li>\n<li><code>notification_db</code> is the only database the notification service ever writes to.</li>\n</ul>\n<hr>\n<h2 id=\"2-file-structure\">2. File Structure</h2>\n<p>Create files in the numbered order below.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>url-shortener/\n│\n├── shared/\n│   └── logger/\n│       └── 1. logger.go          ← extend: WithCorrelationID helper, request logger middleware\n│\n├── services/\n│   └── notification-service/\n│       ├── (from M1)\n│       │   ├── go.mod            ← add dependencies\n│       │   ├── main.go           ← extend: wire consumer, handler, routes\n│       │   ├── config.go         ← extend: add JWTSecret field\n│       │   ├── db.go             ← unchanged\n│       │   ├── rabbitmq.go       ← unchanged (DeclareNotificationQueue from M1)\n│       │   └── health.go         ← unchanged\n│       │\n│       ├── 2.  migration.sql     ← notifications table + index\n│       ├── 3.  store.go          ← NotificationRepository interface + pgxNotificationStore\n│       ├── 4.  consumer.go       ← NotificationConsumer, Run(), processDelivery(), mockEmail()\n│       ├── 5.  handler.go        ← NotificationHandler, ListNotifications method\n│       ├── 6.  errors.go         ← writeError, writeJSON helpers\n│       └── 7.  notification_test.go ← unit + integration tests\n│\n└── gateway/\n    ├── (from M1 stub)\n    │   ├── go.mod                ← add all dependencies\n    │   ├── main.go               ← extend: full wiring\n    │   ├── config.go             ← extend: full config\n    │   ├── health.go             ← unchanged\n    │   └── Dockerfile            ← unchanged\n    │\n    ├── 8.  router.go             ← routing table, route matching, upstream selection\n    ├── 9.  proxy.go              ← ReverseProxy per upstream, request forwarding, response copy\n    ├── 10. middleware.go         ← CorrelationIDMiddleware, LoggingMiddleware, chain helper\n    ├── 11. ratelimit.go          ← RateLimiter interface, redisTokenBucket, 429 response\n    ├── 12. circuitbreaker.go     ← CircuitBreaker struct, state machine, Do() method\n    ├── 13. jwtmiddleware.go      ← gateway-local JWT middleware (wraps shared/auth)\n    └── 14. gateway_test.go       ← circuit breaker, rate limiter, routing, integration tests</code></pre></div>\n\n<hr>\n<h2 id=\"3-complete-data-model\">3. Complete Data Model</h2>\n<h3 id=\"31-postgresql-schema-notification-service-migrationsql\">3.1 PostgreSQL Schema — Notification Service (<code>migration.sql</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">sql</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">-- ── notifications table ───────────────────────────────────────────────────────</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> TABLE</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> notifications (</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    id         UUID        </span><span style=\"color:#F97583\">PRIMARY KEY</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#E1E4E8\"> gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    user_id    UUID        </span><span style=\"color:#F97583\">NOT NULL</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    event_type </span><span style=\"color:#F97583\">TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#E1E4E8\">,   </span><span style=\"color:#6A737D\">-- routing key: \"url.created\" | \"url.deleted\" | \"milestone.reached\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    payload    JSONB       </span><span style=\"color:#F97583\">NOT NULL</span><span style=\"color:#E1E4E8\">,   </span><span style=\"color:#6A737D\">-- full event JSON for audit; never queried for filtering</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    status</span><span style=\"color:#F97583\">     TEXT</span><span style=\"color:#F97583\">        NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#9ECBFF\"> 'sent'</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#6A737D\">-- \"pending\" | \"sent\" | \"failed\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    created_at </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\"> NOT NULL</span><span style=\"color:#F97583\"> DEFAULT</span><span style=\"color:#F97583\"> now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    sent_at    </span><span style=\"color:#F97583\">TIMESTAMPTZ</span><span style=\"color:#F97583\"> NULL</span><span style=\"color:#6A737D\">        -- set when mock email is logged; NULL if pending/failed</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">);</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">-- Primary query: caller's notifications newest-first, for GET /notifications pagination.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">CREATE</span><span style=\"color:#F97583\"> INDEX</span><span style=\"color:#B392F0\"> IF</span><span style=\"color:#F97583\"> NOT</span><span style=\"color:#F97583\"> EXISTS</span><span style=\"color:#E1E4E8\"> idx_notifications_user_created</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    ON</span><span style=\"color:#E1E4E8\"> notifications(user_id, created_at </span><span style=\"color:#F97583\">DESC</span><span style=\"color:#E1E4E8\">);</span></span></code></pre></div>\n\n<p><strong>Column rationale:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Column</th>\n<th>Type</th>\n<th>Constraint</th>\n<th>Rationale</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>id</code></td>\n<td>UUID</td>\n<td>PK</td>\n<td>Non-enumerable row identity</td>\n</tr>\n<tr>\n<td><code>user_id</code></td>\n<td>UUID</td>\n<td>NOT NULL</td>\n<td>Extracted from event payload; used to filter GET /notifications results</td>\n</tr>\n<tr>\n<td><code>event_type</code></td>\n<td>TEXT</td>\n<td>NOT NULL</td>\n<td>Routing key literal; displayed in API response and logs</td>\n</tr>\n<tr>\n<td><code>payload</code></td>\n<td>JSONB</td>\n<td>NOT NULL</td>\n<td>Full event JSON for audit trail; allows replaying notifications without re-querying upstream</td>\n</tr>\n<tr>\n<td><code>status</code></td>\n<td>TEXT</td>\n<td>NOT NULL DEFAULT &#39;sent&#39;</td>\n<td>Tracks notification delivery state; <code>sent</code> immediately after mock email log</td>\n</tr>\n<tr>\n<td><code>created_at</code></td>\n<td>TIMESTAMPTZ</td>\n<td>NOT NULL</td>\n<td>Cursor key for pagination; matches <code>idx_notifications_user_created</code></td>\n</tr>\n<tr>\n<td><code>sent_at</code></td>\n<td>TIMESTAMPTZ</td>\n<td>NULL</td>\n<td>Set when <code>mockEmail()</code> completes; NULL for failed or pending rows</td>\n</tr>\n<tr>\n<td><strong>Status lifecycle:</strong> In this implementation, all notifications immediately transition <code>pending → sent</code> in a single handler call (mock email = log line). The <code>status</code> column and <code>sent_at</code> column exist to support real email integration without schema changes.</td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h3 id=\"32-go-structs-notification-service\">3.2 Go Structs — Notification Service</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// store.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> notification</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NotificationRecord maps to one row in the notifications table.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> NotificationRecord</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID        </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">     // UUID string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserID    </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">     // UUID string; extracted from event payload</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventType </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">     // routing key literal</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Payload   []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#6A737D\">     // raw JSONB bytes (the full event JSON)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Status    </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">     // \"pending\" | \"sent\" | \"failed\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    SentAt    </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\"> // nil if pending/failed</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NotificationRepository abstracts all DB operations on the notifications table.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> NotificationRepository</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Insert creates a new notification row.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // rec.Status must be \"pending\" on input; implementation sets it to \"sent\" and</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // populates SentAt after the mock email log succeeds.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Both the insert and the status update occur in a single transaction.</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Insert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">rec</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // FindByUserID returns paginated notifications for a user, newest-first.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // afterID is the cursor UUID; empty string = first page.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // limit is the page size (default 20, max 50).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns ([]*NotificationRecord, nextCursorID string, error).</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    FindByUserID</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">userID</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">afterID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">limit</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// config.go (extended from M1)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> notification</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Config</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    DatabaseURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // required; fatal if empty</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RabbitMQURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // required; fatal if empty</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Port        </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // default \"8080\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ServiceName </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // constant \"notification-service\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    JWTSecret   </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // required; must match JWT_SECRET across all services</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> loadConfig</span><span style=\"color:#E1E4E8\">() (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Config</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Config</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        DatabaseURL: os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DATABASE_URL\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        RabbitMQURL: os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"RABBITMQ_URL\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        JWTSecret:   os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"JWT_SECRET\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Port:        </span><span style=\"color:#B392F0\">envOrDefault</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"PORT\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"8080\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ServiceName: </span><span style=\"color:#9ECBFF\">\"notification-service\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cfg.DatabaseURL </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"DATABASE_URL is required\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cfg.RabbitMQURL </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"RABBITMQ_URL is required\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cfg.JWTSecret </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"JWT_SECRET is required\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> cfg, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"33-http-response-schema-notification-service\">3.3 HTTP Response Schema — Notification Service</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// handler.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> notification</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> notificationItem</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ID        </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"id\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    EventType </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"event_type\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Payload   </span><span style=\"color:#B392F0\">any</span><span style=\"color:#9ECBFF\">     `json:\"payload\"`</span><span style=\"color:#6A737D\">    // re-decoded from JSONB for JSON embedding</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Status    </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"status\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CreatedAt </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">  `json:\"created_at\"`</span><span style=\"color:#6A737D\"> // RFC3339</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    SentAt    </span><span style=\"color:#F97583\">*</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"sent_at,omitempty\"`</span><span style=\"color:#6A737D\"> // RFC3339 or absent</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> notificationListResponse</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Notifications []</span><span style=\"color:#B392F0\">notificationItem</span><span style=\"color:#9ECBFF\"> `json:\"notifications\"`</span><span style=\"color:#6A737D\"> // always array, never null</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    NextCursor    </span><span style=\"color:#F97583\">*</span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\">            `json:\"next_cursor\"`</span><span style=\"color:#6A737D\">   // null if no more pages</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"34-go-structs-gateway\">3.4 Go Structs — Gateway</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// router.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> gateway</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Route describes one entry in the routing table.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// The gateway matches incoming requests against all routes and selects the first match.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Route</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Method        </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">   // HTTP method, or \"\" to match any method</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    PathPrefix    </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">   // matched with strings.HasPrefix against r.URL.Path</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Upstream      </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">   // config key: \"url-service\" | \"analytics-service\" | \"user-service\" | \"notification-service\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    StripPrefix   </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">   // strip this prefix before forwarding (e.g., \"/api\" stripped, \"/shorten\" left)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RequiresAuth  </span><span style=\"color:#F97583\">bool</span><span style=\"color:#6A737D\">     // true = JWT required; false = public</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RateLimitKey  </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">   // \"\" = no rate limit; \"shorten\" | \"redirect\" = apply named limit</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// circuitbreaker.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> gateway</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// State represents the circuit breaker's current state.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> State</span><span style=\"color:#F97583\"> int</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    StateClosed</span><span style=\"color:#B392F0\">   State</span><span style=\"color:#F97583\"> =</span><span style=\"color:#79B8FF\"> iota</span><span style=\"color:#6A737D\"> // normal operation; requests pass through</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    StateOpen</span><span style=\"color:#6A737D\">                  // tripped; requests fail immediately with 503</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    StateHalfOpen</span><span style=\"color:#6A737D\">              // probe mode; one request allowed through to test upstream</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">s </span><span style=\"color:#B392F0\">State</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">String</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    switch</span><span style=\"color:#E1E4E8\"> s {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> StateClosed:   </span><span style=\"color:#F97583\">return</span><span style=\"color:#9ECBFF\"> \"CLOSED\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> StateOpen:     </span><span style=\"color:#F97583\">return</span><span style=\"color:#9ECBFF\"> \"OPEN\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    case</span><span style=\"color:#E1E4E8\"> StateHalfOpen: </span><span style=\"color:#F97583\">return</span><span style=\"color:#9ECBFF\"> \"HALF_OPEN\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    default</span><span style=\"color:#E1E4E8\">:            </span><span style=\"color:#F97583\">return</span><span style=\"color:#9ECBFF\"> \"UNKNOWN\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CircuitBreaker implements a three-state circuit breaker protecting one upstream.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// All state is protected by mu. Do not embed State in other structs without this protection.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> CircuitBreaker</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mu              </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Mutex</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    state           </span><span style=\"color:#B392F0\">State</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    failures        </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\">       // consecutive failure count (reset on success in CLOSED)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    lastFailureTime </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\"> // time of most recent failure; drives OPEN→HALF_OPEN timeout</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Configuration (immutable after construction):</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    maxFailures     </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\">           // failures to trip: default 5</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    openTimeout     </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#6A737D\"> // how long to stay OPEN before probing: default 30s</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    failureWindow   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#6A737D\"> // window in which failures are counted: default 10s</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    windowStart     </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Time</span><span style=\"color:#6A737D\">     // when current failure window began</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// ratelimit.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> gateway</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RateLimiter abstracts the rate limiting strategy.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Implementation uses Redis INCR + EXPIRE for shared state across gateway replicas.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RateLimiter</span><span style=\"color:#F97583\"> interface</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Allow checks whether the given key has capacity remaining.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // key is typically \"rl:{route_key}:{ip}\" e.g. \"rl:shorten:192.168.1.1\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // limit is the maximum requests per window.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // windowSecs is the window duration in seconds (EXPIRE value).</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Returns:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //   allowed bool   - true if request should proceed; false if 429 should be returned</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //   retryAfter int - seconds until the window resets (used in Retry-After header)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //   err error      - non-nil only on infrastructure failure (Redis down); caller logs + allows</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    Allow</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">key</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">limit</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">windowSecs</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#FFAB70\">allowed</span><span style=\"color:#F97583\"> bool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">retryAfter</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// config.go (gateway, extended from M1 stub)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> gateway</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">fmt</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RateLimitConfig holds one named rate limit policy.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> RateLimitConfig</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Limit      </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\"> // requests per window</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    WindowSecs </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\"> // window duration in seconds</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Config</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    URLServiceURL          </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // required</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    AnalyticsServiceURL    </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // required</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    UserServiceURL         </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // required</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    NotificationServiceURL </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // required</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RedisURL               </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // required (rate limit store)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    JWTSecret              </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // required (local verification)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    Port                   </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // default \"8080\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ServiceName            </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\"> // constant \"gateway\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Circuit breaker settings for url-service:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CBMaxFailures   </span><span style=\"color:#F97583\">int</span><span style=\"color:#6A737D\">           // default 5</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CBOpenTimeout   </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#6A737D\"> // default 30s</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    CBFailureWindow </span><span style=\"color:#B392F0\">time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#6A737D\"> // default 10s</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Rate limit policies (keyed by route identifier):</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    RateLimits </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#B392F0\">RateLimitConfig</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Populated at loadConfig() as:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //   \"shorten\":  {Limit: 10, WindowSecs: 60}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    //   \"redirect\": {Limit: 300, WindowSecs: 60}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> loadConfig</span><span style=\"color:#E1E4E8\">() (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Config</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cfg </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Config</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        URLServiceURL:          os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"URL_SERVICE_URL\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        AnalyticsServiceURL:    os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"ANALYTICS_SERVICE_URL\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        UserServiceURL:         os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"USER_SERVICE_URL\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        NotificationServiceURL: os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"NOTIFICATION_SERVICE_URL\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        RedisURL:               os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"REDIS_URL\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        JWTSecret:              os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"JWT_SECRET\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Port:                   </span><span style=\"color:#B392F0\">envOrDefault</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"PORT\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"8080\"</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ServiceName:            </span><span style=\"color:#9ECBFF\">\"gateway\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        CBMaxFailures:          </span><span style=\"color:#79B8FF\">5</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        CBOpenTimeout:          </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        CBFailureWindow:        </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        RateLimits: </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#B392F0\">RateLimitConfig</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"shorten\"</span><span style=\"color:#E1E4E8\">:  {Limit: </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">, WindowSecs: </span><span style=\"color:#79B8FF\">60</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"redirect\"</span><span style=\"color:#E1E4E8\">: {Limit: </span><span style=\"color:#79B8FF\">300</span><span style=\"color:#E1E4E8\">, WindowSecs: </span><span style=\"color:#79B8FF\">60</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    required </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"URL_SERVICE_URL\"</span><span style=\"color:#E1E4E8\">:          cfg.URLServiceURL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"ANALYTICS_SERVICE_URL\"</span><span style=\"color:#E1E4E8\">:    cfg.AnalyticsServiceURL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"USER_SERVICE_URL\"</span><span style=\"color:#E1E4E8\">:         cfg.UserServiceURL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"NOTIFICATION_SERVICE_URL\"</span><span style=\"color:#E1E4E8\">: cfg.NotificationServiceURL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"REDIS_URL\"</span><span style=\"color:#E1E4E8\">:                cfg.RedisURL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"JWT_SECRET\"</span><span style=\"color:#E1E4E8\">:               cfg.JWTSecret,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> k, v </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> required {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> v </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\"> is required\"</span><span style=\"color:#E1E4E8\">, k)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> cfg, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> envOrDefault</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">key</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">def</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> v </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> os.</span><span style=\"color:#B392F0\">Getenv</span><span style=\"color:#E1E4E8\">(key); v </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> v</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> def</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"35-routing-table-immutable-after-construction\">3.5 Routing Table (Immutable After Construction)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// router.go — constructed once in main.go and never mutated</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">var</span><span style=\"color:#E1E4E8\"> routingTable </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#B392F0\">Route</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Auth routes — no JWT required</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    {Method: </span><span style=\"color:#9ECBFF\">\"POST\"</span><span style=\"color:#E1E4E8\">, PathPrefix: </span><span style=\"color:#9ECBFF\">\"/api/auth/register\"</span><span style=\"color:#E1E4E8\">, Upstream: </span><span style=\"color:#9ECBFF\">\"user-service\"</span><span style=\"color:#E1E4E8\">,         RequiresAuth: </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    {Method: </span><span style=\"color:#9ECBFF\">\"POST\"</span><span style=\"color:#E1E4E8\">, PathPrefix: </span><span style=\"color:#9ECBFF\">\"/api/auth/login\"</span><span style=\"color:#E1E4E8\">,    Upstream: </span><span style=\"color:#9ECBFF\">\"user-service\"</span><span style=\"color:#E1E4E8\">,         RequiresAuth: </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // URL service routes — auth required</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    {Method: </span><span style=\"color:#9ECBFF\">\"POST\"</span><span style=\"color:#E1E4E8\">, PathPrefix: </span><span style=\"color:#9ECBFF\">\"/api/shorten\"</span><span style=\"color:#E1E4E8\">,       Upstream: </span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#E1E4E8\">,          RequiresAuth: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">,  RateLimitKey: </span><span style=\"color:#9ECBFF\">\"shorten\"</span><span style=\"color:#E1E4E8\">,  StripPrefix: </span><span style=\"color:#9ECBFF\">\"/api\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    {Method: </span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">,  PathPrefix: </span><span style=\"color:#9ECBFF\">\"/api/urls\"</span><span style=\"color:#E1E4E8\">,          Upstream: </span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#E1E4E8\">,          RequiresAuth: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">,  StripPrefix: </span><span style=\"color:#9ECBFF\">\"/api\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    {Method: </span><span style=\"color:#9ECBFF\">\"DELETE\"</span><span style=\"color:#E1E4E8\">,PathPrefix:</span><span style=\"color:#9ECBFF\">\"/api/urls/\"</span><span style=\"color:#E1E4E8\">,         Upstream: </span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#E1E4E8\">,          RequiresAuth: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">,  StripPrefix: </span><span style=\"color:#9ECBFF\">\"/api\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Redirect — no auth, rate limited</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    {Method: </span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">,  PathPrefix: </span><span style=\"color:#9ECBFF\">\"/r/\"</span><span style=\"color:#E1E4E8\">,               Upstream: </span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#E1E4E8\">,          RequiresAuth: </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, RateLimitKey: </span><span style=\"color:#9ECBFF\">\"redirect\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Analytics — no auth</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    {Method: </span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">,  PathPrefix: </span><span style=\"color:#9ECBFF\">\"/api/stats/\"</span><span style=\"color:#E1E4E8\">,        Upstream: </span><span style=\"color:#9ECBFF\">\"analytics-service\"</span><span style=\"color:#E1E4E8\">,    RequiresAuth: </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">, StripPrefix: </span><span style=\"color:#9ECBFF\">\"/api\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Notifications — auth required</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    {Method: </span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">,  PathPrefix: </span><span style=\"color:#9ECBFF\">\"/api/notifications\"</span><span style=\"color:#E1E4E8\">, Upstream: </span><span style=\"color:#9ECBFF\">\"notification-service\"</span><span style=\"color:#E1E4E8\">, RequiresAuth: </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">,  StripPrefix: </span><span style=\"color:#9ECBFF\">\"/api\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>Path rewriting rule:</strong> When <code>StripPrefix</code> is non-empty, remove that prefix from <code>r.URL.Path</code> before forwarding. Example: <code>GET /api/shorten</code> → url-service receives <code>GET /shorten</code>. <code>GET /r/abc1234</code> → url-service receives <code>GET /r/abc1234</code> (no strip). <code>GET /api/stats/abc1234</code> → analytics-service receives <code>GET /stats/abc1234</code>.\n<strong>Redirect path rewrite:</strong> url-service internally handles <code>GET /{code}</code> (7-char codes). The gateway exposes <code>GET /r/{code}</code> and rewrites to <code>GET /{code}</code>:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// In proxy forwarding for redirect route: strip \"/r\" prefix</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// /r/abc1234 → /abc1234</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-28.svg\" alt=\"API Gateway Middleware Stack and Request Pipeline\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Gateway routing table (prefix matching, first match wins):\n  Incoming path                         → Upstream service      → Forwarded path\n  ─────────────────────────────────────────────────────────────────────────────\n  POST /api/auth/register               → user-service         → /register\n  POST /api/auth/login                  → user-service         → /login\n  POST /api/shorten         [auth+rl]   → url-service          → /shorten\n  GET  /api/urls            [auth]      → url-service          → /urls\n  DELETE /api/urls/*        [auth]      → url-service          → /urls/*\n  GET  /r/*                 [rl]        → url-service          → /*\n  GET  /api/stats/*                     → analytics-service    → /stats/*\n  GET  /api/notifications   [auth]      → notification-service → /notifications\n  GET  /health                          → gateway itself       → (no proxy)\n  * anything else                       → 404\n  [auth] = JWT middleware applied\n  [rl]   = rate limiter applied</code></pre></div>\n\n<h3 id=\"36-extended-sharedlogger-package\">3.6 Extended <code>shared/logger</code> Package</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// shared/logger/logger.go (extended)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> logger</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">context</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">log/slog</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">os</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> correlationKey</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\">{}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// New returns a *slog.Logger writing JSON to stdout with \"service\" pre-attached.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">serviceName</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> slog.</span><span style=\"color:#B392F0\">NewJSONHandler</span><span style=\"color:#E1E4E8\">(os.Stdout, </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">HandlerOptions</span><span style=\"color:#E1E4E8\">{Level: slog.LevelInfo})</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> slog.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(h).</span><span style=\"color:#B392F0\">With</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"service\"</span><span style=\"color:#E1E4E8\">, serviceName)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// WithCorrelationID returns a derived logger with \"correlation_id\" attached.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Used in handlers to bind the correlation ID to all log lines for a request.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> WithCorrelationID</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">correlationID</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> log.</span><span style=\"color:#B392F0\">With</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"correlation_id\"</span><span style=\"color:#E1E4E8\">, correlationID)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// CorrelationIDFromContext retrieves the correlation ID stored by CorrelationIDMiddleware.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Returns \"\" if not set.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> CorrelationIDFromContext</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> id, ok </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> ctx.</span><span style=\"color:#B392F0\">Value</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">correlationKey</span><span style=\"color:#E1E4E8\">{}).(</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">); ok {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> id</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#9ECBFF\"> \"\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ContextWithCorrelationID stores a correlation ID into a context.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> ContextWithCorrelationID</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">id</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithValue</span><span style=\"color:#E1E4E8\">(ctx, </span><span style=\"color:#B392F0\">correlationKey</span><span style=\"color:#E1E4E8\">{}, id)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// RequestLogger returns middleware that logs each HTTP request as a structured JSON line.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Emits: time, level, service, correlation_id, method, path, status, duration_ms, msg=\"request\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Applied at the outermost layer in the gateway; inner services apply it similarly.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> RequestLogger</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">next</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            start </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            corrID </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> CorrelationIDFromContext</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            rw </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">responseWriter</span><span style=\"color:#E1E4E8\">{ResponseWriter: w, status: http.StatusOK}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            next.</span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(rw, r)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"request\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"correlation_id\"</span><span style=\"color:#E1E4E8\">, corrID,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"method\"</span><span style=\"color:#E1E4E8\">,         r.Method,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"path\"</span><span style=\"color:#E1E4E8\">,           r.URL.Path,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"status\"</span><span style=\"color:#E1E4E8\">,         rw.status,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"duration_ms\"</span><span style=\"color:#E1E4E8\">,    time.</span><span style=\"color:#B392F0\">Since</span><span style=\"color:#E1E4E8\">(start).</span><span style=\"color:#B392F0\">Milliseconds</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            )</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// responseWriter wraps http.ResponseWriter to capture the status code.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> responseWriter</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">    http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    status </span><span style=\"color:#F97583\">int</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">rw </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">responseWriter</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">status</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rw.status </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> status</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rw.ResponseWriter.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(status)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<hr>\n<h2 id=\"4-interface-contracts\">4. Interface Contracts</h2>\n<h3 id=\"41-notificationrepository-pgxnotificationstore-implementation\">4.1 <code>NotificationRepository</code> — <code>pgxNotificationStore</code> Implementation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// store.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> pgxNotificationStore</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewNotificationStore</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">pool</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">NotificationRepository</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">pgxNotificationStore</span><span style=\"color:#E1E4E8\">{pool: pool}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>Insert(ctx context.Context, rec *NotificationRecord) (*NotificationRecord, error)</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Input:  rec.UserID, rec.EventType, rec.Payload, rec.Status=&quot;pending&quot;\n        (rec.ID, rec.CreatedAt, rec.SentAt are populated by DB / function)\nAlgorithm:\n  tx, err := s.pool.Begin(ctx)\n  if err: return nil, fmt.Errorf(&quot;begin notification tx: %w&quot;, err)\n  Step 1: INSERT with status=&quot;pending&quot;\n    SQL:\n      INSERT INTO notifications (user_id, event_type, payload, status)\n      VALUES ($1, $2, $3, 'pending')\n      RETURNING id, user_id, event_type, payload, status, created_at, sent_at\n    Params: rec.UserID, rec.EventType, rec.Payload\n  Step 2: Call mockEmail(rec) — log the mock send\n    // mockEmail logs: log.Info(&quot;would send email to &lt;user&gt;: &lt;message&gt;&quot;)\n    // Always succeeds (no real network call)\n  Step 3: UPDATE status to &quot;sent&quot;, set sent_at = now()\n    SQL:\n      UPDATE notifications\n      SET status = 'sent', sent_at = now()\n      WHERE id = $1\n      RETURNING sent_at\n    Param: inserted.ID\n  Step 4: COMMIT\n    if err: tx.Rollback(ctx); return nil, fmt.Errorf(&quot;commit notification tx: %w&quot;, err)\n  Step 5: Return populated *NotificationRecord (all fields from RETURNING + updated SentAt)\nOn any INSERT error:\n  tx.Rollback(ctx)\n  return nil, fmt.Errorf(&quot;insert notification: %w&quot;, err)\nOn UPDATE error:\n  tx.Rollback(ctx)\n  return nil, fmt.Errorf(&quot;update notification status: %w&quot;, err)</code></pre></div>\n\n<p><strong><code>FindByUserID(ctx context.Context, userID, afterID string, limit int) ([]*NotificationRecord, string, error)</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Cursor-based pagination — same pattern as url-service GET /urls.\nDefault limit: 20. Max enforced by caller.\nWhen afterID == &quot;&quot;:\n  SQL:\n    SELECT id, user_id, event_type, payload, status, created_at, sent_at\n    FROM notifications\n    WHERE user_id = $1\n    ORDER BY created_at DESC, id DESC\n    LIMIT $2\n  Params: userID, limit+1\nWhen afterID != &quot;&quot;:\n  SQL:\n    SELECT id, user_id, event_type, payload, status, created_at, sent_at\n    FROM notifications\n    WHERE user_id = $1\n      AND (created_at, id) &lt; (\n          SELECT created_at, id FROM notifications WHERE id = $2\n      )\n    ORDER BY created_at DESC, id DESC\n    LIMIT $3\n  Params: userID, afterID, limit+1\nNext-cursor logic:\n  Fetch limit+1 rows.\n  If len(rows) == limit+1: nextCursor = rows[limit].ID; return rows[:limit]\n  Else: nextCursor = &quot;&quot;; return all rows\nOn success: ([]*NotificationRecord, nextCursor string, nil)\nOn error:   nil, &quot;&quot;, fmt.Errorf(&quot;find notifications by user: %w&quot;, err)</code></pre></div>\n\n<h3 id=\"42-notificationconsumer\">4.2 <code>NotificationConsumer</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// consumer.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> NotificationConsumer</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    conn  </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">RabbitMQConn</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    pool  </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#B392F0\">NotificationRepository</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log   </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewNotificationConsumer</span><span style=\"color:#E1E4E8\">(</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    conn</span><span style=\"color:#F97583\">  *</span><span style=\"color:#B392F0\">RabbitMQConn</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    pool</span><span style=\"color:#F97583\">  *</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    store</span><span style=\"color:#B392F0\"> NotificationRepository</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#FFAB70\">    log</span><span style=\"color:#F97583\">   *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationConsumer</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Run starts the consumer loop. Blocks until ctx is Done.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">c </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationConsumer</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">Run</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n\n<p><strong><code>Run(ctx context.Context)</code> — full algorithm:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Step 1: Set QoS prefetch\n  c.conn.Channel.Qos(1, 0, false)\n  On error: log.Error + os.Exit(1)\nStep 2: Consume from &quot;notifications.events&quot;\n  msgs, err := c.conn.Channel.Consume(\n      &quot;notifications.events&quot;,\n      &quot;&quot;,     // auto consumer tag\n      false,  // autoAck = false\n      false, false, false, nil,\n  )\n  On error: log.Error + os.Exit(1)\nStep 3: Message loop\n  for:\n    select:\n    case &lt;-ctx.Done(): log.Info(&quot;notification consumer stopped&quot;); return\n    case d, ok := &lt;-msgs:\n      if !ok:\n        log.Warn(&quot;notification amqp channel closed&quot;)\n        &lt;-ctx.Done()\n        return\n      c.processDelivery(ctx, d)</code></pre></div>\n\n<p><strong><code>processDelivery(ctx context.Context, d amqp.Delivery)</code> — full algorithm:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Step 1: Panic recovery\n  defer func() {\n    if r := recover(); r != nil:\n      log.Error(&quot;notification consumer panic&quot;, &quot;panic&quot;, fmt.Sprintf(&quot;%v&quot;, r))\n      d.Ack(false)\n  }()\nStep 2: Determine event type from routing key\n  eventType := d.RoutingKey\n  if eventType is not one of {&quot;url.created&quot;,&quot;url.deleted&quot;,&quot;milestone.reached&quot;}:\n    log.Warn(&quot;unknown routing key&quot;, &quot;key&quot;, eventType)\n    d.Ack(false); return\nStep 3: Extract user_id and user_email from payload\n  // Route-specific unmarshaling to extract user context without calling other services.\n  var userID, userEmail, message string\n  switch eventType:\n  case &quot;url.created&quot;:\n    var evt events.URLCreatedEvent\n    if err := json.Unmarshal(d.Body, &amp;evt); err != nil:\n      log.Error(&quot;poison: unmarshal URLCreatedEvent&quot;, &quot;error&quot;, err,\n                &quot;body_preview&quot;, truncate(d.Body, 200))\n      d.Ack(false); return\n    userID    = evt.UserID\n    userEmail = evt.UserEmail\n    message   = fmt.Sprintf(&quot;Your short URL %s has been created for %s&quot;, evt.ShortCode, evt.OriginalURL)\n    correlationID = evt.CorrelationID\n  case &quot;url.deleted&quot;:\n    var evt events.URLDeletedEvent\n    if err := json.Unmarshal(d.Body, &amp;evt); err != nil:\n      log.Error(&quot;poison: unmarshal URLDeletedEvent&quot;, ...)\n      d.Ack(false); return\n    userID    = evt.UserID\n    userEmail = evt.UserEmail\n    message   = fmt.Sprintf(&quot;Your short URL %s has been deactivated&quot;, evt.ShortCode)\n    correlationID = evt.CorrelationID\n  case &quot;milestone.reached&quot;:\n    var evt events.MilestoneReachedEvent\n    if err := json.Unmarshal(d.Body, &amp;evt); err != nil:\n      log.Error(&quot;poison: unmarshal MilestoneReachedEvent&quot;, ...)\n      d.Ack(false); return\n    userID    = evt.UserID\n    userEmail = evt.UserEmail\n    message   = fmt.Sprintf(&quot;Your short URL %s has reached %d clicks!&quot;, evt.ShortCode, evt.MilestoneN)\n    correlationID = evt.CorrelationID\nStep 4: Validate required fields\n  if userID == &quot;&quot;:\n    log.Error(&quot;notification: missing user_id in event&quot;, &quot;event_type&quot;, eventType)\n    d.Ack(false); return\n  // userEmail may be &quot;&quot; for milestone events from incomplete event payloads; proceed\nStep 5: Build and insert notification record\n  rec := &amp;NotificationRecord{\n    UserID:    userID,\n    EventType: eventType,\n    Payload:   d.Body,\n    Status:    &quot;pending&quot;,\n  }\n  saved, err := c.store.Insert(ctx, rec)\n  if err != nil:\n    log.Error(&quot;notification insert failed&quot;, &quot;error&quot;, err, &quot;event_type&quot;, eventType)\n    d.Nack(false, true)  // requeue for retry\n    return\nStep 6: Mock email log\n  // mockEmail is called inside store.Insert before commit.\n  // Log here as confirmation with correlation_id for trace:\n  log.Info(&quot;would send email to user&quot;,\n    &quot;user_id&quot;,        userID,\n    &quot;user_email&quot;,     userEmail,\n    &quot;message&quot;,        message,\n    &quot;notification_id&quot;,saved.ID,\n    &quot;correlation_id&quot;, correlationID,\n  )\nStep 7: Acknowledge\n  d.Ack(false)\n  log.Info(&quot;notification processed&quot;,\n    &quot;notification_id&quot;, saved.ID,\n    &quot;event_type&quot;,      eventType,\n    &quot;correlation_id&quot;,  correlationID,\n  )</code></pre></div>\n\n<h3 id=\"43-notificationhandler\">4.3 <code>NotificationHandler</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// handler.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> NotificationHandler</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#B392F0\">NotificationRepository</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log   </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewNotificationHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">store</span><span style=\"color:#B392F0\"> NotificationRepository</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationHandler</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ListNotifications handles GET /notifications.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Requires JWT. Returns caller's notifications, newest-first, paginated.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Query params: after=&#x3C;uuid> (cursor), limit=&#x3C;int> (default 20, max 50)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">h </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationHandler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ListNotifications</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">)</span></span></code></pre></div>\n\n<p><strong><code>ListNotifications</code> Algorithm:</strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Step 1: Extract claims\n  claims, ok := auth.ClaimsFromContext(r.Context())\n  if !ok: writeError(w, 401, &quot;unauthorized&quot;); return\nStep 2: Parse query params\n  afterID := r.URL.Query().Get(&quot;after&quot;)\n  limit   := 20\n  if limitStr := r.URL.Query().Get(&quot;limit&quot;); limitStr != &quot;&quot;:\n    n, err := strconv.Atoi(limitStr)\n    if err != nil || n &lt; 1 || n &gt; 50:\n      writeError(w, 400, &quot;limit must be integer 1-50&quot;); return\n    limit = n\nStep 3: Fetch notifications\n  recs, nextCursor, err := h.store.FindByUserID(r.Context(), claims.Sub, afterID, limit)\n  if err != nil:\n    h.log.Error(&quot;find notifications failed&quot;, &quot;error&quot;, err, &quot;user_id&quot;, claims.Sub)\n    writeError(w, 500, &quot;internal server error&quot;); return\nStep 4: Build response items\n  items := make([]notificationItem, 0, len(recs))\n  for _, rec := range recs:\n    var rawPayload any\n    json.Unmarshal(rec.Payload, &amp;rawPayload)  // re-hydrate JSONB for embedding\n    item := notificationItem{\n      ID:        rec.ID,\n      EventType: rec.EventType,\n      Payload:   rawPayload,\n      Status:    rec.Status,\n      CreatedAt: rec.CreatedAt.UTC().Format(time.RFC3339),\n    }\n    if rec.SentAt != nil:\n      s := rec.SentAt.UTC().Format(time.RFC3339)\n      item.SentAt = &amp;s\n    items = append(items, item)\nStep 5: Build next_cursor pointer\n  var nextCursorPtr *string\n  if nextCursor != &quot;&quot;:\n    nextCursorPtr = &amp;nextCursor\nStep 6: Write response\n  writeJSON(w, 200, notificationListResponse{\n    Notifications: items,\n    NextCursor:    nextCursorPtr,\n  })</code></pre></div>\n\n<h3 id=\"44-circuitbreaker\">4.4 <code>CircuitBreaker</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// circuitbreaker.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewCircuitBreaker constructs a CircuitBreaker with explicit configuration.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewCircuitBreaker</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">maxFailures</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">openTimeout</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">failureWindow</span><span style=\"color:#B392F0\"> time</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Duration</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CircuitBreaker</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">CircuitBreaker</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        state:           StateClosed,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        maxFailures:     maxFailures,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        openTimeout:     openTimeout,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        failureWindow:   failureWindow,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        windowStart:     time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>Do(ctx context.Context, upstream func() error) error</code></strong>\nThis is the primary entry point. The gateway calls <code>cb.Do(ctx, func() error { return proxy.forward(req, resp) })</code>.</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>func (cb *CircuitBreaker) Do(ctx context.Context, upstream func() error) error:\nStep 1: Acquire lock and evaluate state\n  cb.mu.Lock()\n  switch cb.state:\n  case StateOpen:\n    // Check if openTimeout has elapsed since last failure\n    if time.Since(cb.lastFailureTime) &gt;= cb.openTimeout:\n      cb.state = StateHalfOpen\n      cb.mu.Unlock()\n      // fall through to execute probe request (StateHalfOpen case)\n    else:\n      cb.mu.Unlock()\n      return ErrCircuitOpen  // 503 immediately, no upstream call\n  case StateHalfOpen:\n    // Allow exactly one probe request through.\n    // Do NOT release any other concurrent requests — they would see StateHalfOpen\n    // and spin-wait or fail. With net/http single-request model, this is safe:\n    // set state to something that blocks others.\n    // Simple approach: transition to StateClosed optimistically; rollback on failure.\n    // This is acceptable for single-gateway, low concurrency probe scenarios.\n    cb.mu.Unlock()\n    // execute probe below\n  case StateClosed:\n    // Reset failure window if window has expired\n    if time.Since(cb.windowStart) &gt; cb.failureWindow:\n      cb.failures    = 0\n      cb.windowStart = time.Now()\n    cb.mu.Unlock()\n    // execute request below\nStep 2: Execute upstream function\n  err := upstream()\nStep 3: Record outcome\n  cb.mu.Lock()\n  defer cb.mu.Unlock()\n  if err == nil:\n    // Success\n    if cb.state == StateHalfOpen:\n      cb.state    = StateClosed\n      cb.failures = 0\n      cb.log.Info(&quot;circuit breaker CLOSED (probe succeeded)&quot;)\n    else if cb.state == StateClosed:\n      cb.failures = 0  // reset consecutive failures on success\n    return nil\n  // Failure\n  cb.lastFailureTime = time.Now()\n  if cb.state == StateHalfOpen:\n    cb.state = StateOpen\n    cb.log.Warn(&quot;circuit breaker OPEN (probe failed)&quot;)\n    return err\n  // StateClosed failure\n  cb.failures++\n  if cb.failures &gt;= cb.maxFailures:\n    cb.state       = StateOpen\n    cb.windowStart = time.Now()  // reset window for next open period\n    cb.log.Warn(&quot;circuit breaker OPEN&quot;,\n      &quot;failures&quot;, cb.failures,\n      &quot;max_failures&quot;, cb.maxFailures,\n    )\n  return err\n// ErrCircuitOpen is returned when the breaker is open and rejects the request.\nvar ErrCircuitOpen = errors.New(&quot;circuit breaker open&quot;)</code></pre></div>\n\n<p><strong>What counts as a failure:</strong> The <code>upstream</code> function passed to <code>Do</code> must return a non-nil error on any of the following conditions from the proxied response:</p>\n<ul>\n<li>HTTP 5xx response from upstream (500, 502, 503, 504)</li>\n<li>Network timeout or connection refused</li>\n<li>Context deadline exceeded\nHTTP 4xx responses (400, 401, 403, 404, 422, 429) are <strong>not</strong> failures — they indicate the upstream is healthy and responding correctly.</li>\n</ul>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-29.svg\" alt=\"Circuit Breaker State Machine\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Circuit breaker state machine:\n  ┌─────────────────────────────────────────────────────────────┐\n  │                                                             │\n  │    ┌──────────┐                                            │\n  │    │  CLOSED  │◄─────────────────────────────────────┐    │\n  │    │ (normal) │                                       │    │\n  │    └────┬─────┘                                       │    │\n  │         │                                             │    │\n  │   failures &gt;= maxFailures                     probe success │\n  │   within failureWindow (10s)                         │    │\n  │         │                                             │    │\n  │         ▼                                             │    │\n  │    ┌──────────┐   openTimeout (30s) elapsed    ┌──────┴───┐│\n  │    │   OPEN   │─────────────────────────────►  │HALF_OPEN ││\n  │    │  (trip)  │                                │ (probe)  ││\n  │    └──────────┘                                └──────────┘│\n  │         ▲                                             │    │\n  │         └─────────────── probe failure ───────────────┘    │\n  │                                                             │\n  │  CLOSED:    requests pass through; failures counted         │\n  │  OPEN:      requests rejected immediately → 503             │\n  │  HALF_OPEN: one probe request allowed; success→CLOSED,      │\n  │             failure→OPEN                                    │\n  └─────────────────────────────────────────────────────────────┘\n  Configuration: maxFailures=5, failureWindow=10s, openTimeout=30s\n  All state transitions guarded by sync.Mutex.\n  ILLEGAL transitions: CLOSED→HALF_OPEN, OPEN→CLOSED (must go through HALF_OPEN)</code></pre></div>\n\n<h3 id=\"45-ratelimiter-redistokenbucket-implementation\">4.5 <code>RateLimiter</code> — <code>redisTokenBucket</code> Implementation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// ratelimit.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> redisTokenBucket</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Client</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log    </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewRateLimiter</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">client</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Client</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">RateLimiter</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">redisTokenBucket</span><span style=\"color:#E1E4E8\">{client: client, log: log}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong><code>Allow(ctx context.Context, key string, limit int, windowSecs int) (bool, int, error)</code></strong></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Algorithm — uses two-command Redis pipeline (INCR + EXPIRE):\nStep 1: Build Redis key\n  redisKey := &quot;rl:&quot; + key   // e.g. &quot;rl:shorten:192.168.1.1&quot;\nStep 2: INCR the counter (creates key with value 1 if absent)\n  count, err := c.client.Incr(ctx, redisKey).Result()\n  if err != nil:\n    c.log.Warn(&quot;rate limit redis incr failed&quot;, &quot;key&quot;, redisKey, &quot;error&quot;, err)\n    return true, 0, err  // fail-open: allow the request\nStep 3: Set expiry only on the first increment (count == 1)\n  // Setting EXPIRE on every request would reset the window on each hit.\n  // Setting only on count==1 means the window starts with the first request\n  // and expires exactly windowSecs later. Subsequent requests in the window\n  // increment but do not reset the expiry.\n  if count == 1:\n    expireErr := c.client.Expire(ctx, redisKey, time.Duration(windowSecs)*time.Second).Err()\n    if expireErr != nil:\n      c.log.Warn(&quot;rate limit redis expire failed&quot;, &quot;key&quot;, redisKey, &quot;error&quot;, expireErr)\n      // Non-fatal: key will exist without TTL. INCR will keep counting but never expire.\n      // Accept this edge case: the counter resets on Redis restart anyway.\nStep 4: Calculate retryAfter\n  // Approximate: TTL of the current window.\n  // For simplicity, use windowSecs as retryAfter (conservative upper bound).\n  retryAfter := windowSecs\nStep 5: Check limit\n  if count &gt; int64(limit):\n    return false, retryAfter, nil  // 429\n  return true, 0, nil              // allowed\nNote on atomicity: INCR is atomic in Redis. The race condition where two concurrent\nrequests both see count==1 and both call EXPIRE is harmless — both EXPIRE calls\nset the same TTL on the same key. The window boundary is accurate.\nNote on key structure:\n  &quot;shorten&quot; route:  &quot;rl:shorten:&lt;client_ip&gt;&quot;\n  &quot;redirect&quot; route: &quot;rl:redirect:&lt;client_ip&gt;&quot;\n  IP extraction:    net.SplitHostPort(r.RemoteAddr) or r.Header.Get(&quot;X-Forwarded-For&quot;)\n                    (for this project: use RemoteAddr; no load balancer in front)</code></pre></div>\n\n<h3 id=\"46-gateway-reverseproxy\">4.6 Gateway <code>ReverseProxy</code></h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// proxy.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> gateway</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http/httputil</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/url</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// UpstreamProxy wraps httputil.ReverseProxy for one upstream service.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> UpstreamProxy</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    proxy    </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">httputil</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ReverseProxy</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    upstream </span><span style=\"color:#F97583\">string</span><span style=\"color:#6A737D\">  // service name for logging</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log      </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// NewUpstreamProxy constructs a reverse proxy targeting baseURL.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> NewUpstreamProxy</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">baseURL</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">upstream</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">UpstreamProxy</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    target, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> url.</span><span style=\"color:#B392F0\">Parse</span><span style=\"color:#E1E4E8\">(baseURL)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"parse upstream URL </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, baseURL, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rp </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httputil.</span><span style=\"color:#B392F0\">NewSingleHostReverseProxy</span><span style=\"color:#E1E4E8\">(target)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Custom error handler: capture upstream 5xx for circuit breaker</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rp.ErrorHandler </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">err</span><span style=\"color:#F97583\"> error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        log.</span><span style=\"color:#B392F0\">Warn</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"upstream error\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"upstream\"</span><span style=\"color:#E1E4E8\">, upstream, </span><span style=\"color:#9ECBFF\">\"error\"</span><span style=\"color:#E1E4E8\">, err,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">            \"correlation_id\"</span><span style=\"color:#E1E4E8\">, logger.</span><span style=\"color:#B392F0\">CorrelationIDFromContext</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">()))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        http.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#9ECBFF\">`{\"error\":\"upstream error\"}`</span><span style=\"color:#E1E4E8\">, http.StatusBadGateway)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">UpstreamProxy</span><span style=\"color:#E1E4E8\">{proxy: rp, upstream: upstream, log: log}, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// ServeHTTP forwards the request to the upstream. Strips the given prefix before forwarding.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">p </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">UpstreamProxy</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">stripPrefix</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">addPath</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Rewrite path: strip gateway-level prefix, optionally rewrite</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> stripPrefix </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        r.URL.Path </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> strings.</span><span style=\"color:#B392F0\">TrimPrefix</span><span style=\"color:#E1E4E8\">(r.URL.Path, stripPrefix)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> addPath </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        r.URL.Path </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> addPath </span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\"> r.URL.Path</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> r.URL.Path </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        r.URL.Path </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"/\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    p.proxy.</span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(w, r)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><strong>How the circuit breaker wraps the proxy:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// In the gateway handler — url-service only gets the circuit breaker:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">g </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Gateway</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">handleURLService</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">route</span><span style=\"color:#B392F0\"> Route</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rw </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">responseWriter</span><span style=\"color:#E1E4E8\">{ResponseWriter: w, status: </span><span style=\"color:#79B8FF\">200</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> g.urlServiceCB.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        g.urlProxy.</span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(rw, r, route.StripPrefix, </span><span style=\"color:#9ECBFF\">\"\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">        // Count 5xx as circuit breaker failures:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> rw.status </span><span style=\"color:#F97583\">>=</span><span style=\"color:#79B8FF\"> 500</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"upstream 5xx: </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, rw.status)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">Is</span><span style=\"color:#E1E4E8\">(err, ErrCircuitOpen):</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(http.StatusServiceUnavailable)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        w.</span><span style=\"color:#B392F0\">Write</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`{\"error\":\"service unavailable\"}`</span><span style=\"color:#E1E4E8\">))</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Other errors are already written by ErrorHandler</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<hr>\n<h2 id=\"5-algorithm-specification\">5. Algorithm Specification</h2>\n<h3 id=\"51-gateway-request-processing-pipeline\">5.1 Gateway Request Processing Pipeline</h3>\n<p>Every incoming request passes through this ordered middleware chain:</p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Incoming HTTP Request\n        │\n        ▼\n1. CorrelationIDMiddleware\n   - Read X-Correlation-ID header\n   - If absent: generate UUID v4\n   - Store in request context\n   - Echo as X-Correlation-ID response header\n        │\n        ▼\n2. RequestLogger (shared/logger.RequestLogger)\n   - Record start time\n   - Wrap ResponseWriter to capture status code\n   - Call next handler\n   - After response: log {time, level, service, correlation_id, method, path, status, duration_ms}\n        │\n        ▼\n3. Router.ServeHTTP\n   - Match request against routingTable (first match wins)\n   - If no match: 404 {&quot;error&quot;:&quot;not found&quot;}\n   - Determine: upstream, requiresAuth, rateLimitKey, stripPrefix\n        │\n        ▼\n4. [If requiresAuth] JWTMiddleware\n   - Read Authorization: Bearer &lt;token&gt;\n   - Verify HMAC-SHA256 locally (shared secret)\n   - On failure: 401 {&quot;error&quot;:&quot;unauthorized&quot;} — stop processing\n   - On success: inject Claims into context\n        │\n        ▼\n5. [If rateLimitKey != &quot;&quot;] RateLimiter.Allow\n   - key = &quot;rl:{rateLimitKey}:{clientIP}&quot;\n   - Redis INCR + conditional EXPIRE\n   - If count &gt; limit: 429 {&quot;error&quot;:&quot;rate limit exceeded&quot;} + Retry-After header — stop\n   - On Redis error: log Warn + allow (fail-open)\n        │\n        ▼\n6. Forward X-Correlation-ID to upstream\n   - r.Header.Set(&quot;X-Correlation-ID&quot;, correlationIDFromContext(r.Context()))\n        │\n        ▼\n7. [If upstream == &quot;url-service&quot;] CircuitBreaker.Do(upstream func)\n   - If OPEN: 503 {&quot;error&quot;:&quot;service unavailable&quot;} — stop\n   - If CLOSED/HALF_OPEN: execute proxy forward\n   - Record success or failure based on response status\n        │\n        ▼\n8. [All other upstreams] Direct proxy forward\n   - httputil.ReverseProxy.ServeHTTP\n   - Path rewrite per route.StripPrefix\n        │\n        ▼\n   Upstream response → client</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-30.svg\" alt=\"Circuit Breaker State Transition Sequence\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Gateway middleware chain (layered decorators):\n  ┌──────────────────────────────────────────────────────────────┐\n  │  net/http server                                             │\n  │                                                              │\n  │  handler := chain(                                           │\n  │    CorrelationIDMiddleware,      ← outermost (always runs)   │\n  │    logger.RequestLogger(log),   ← second (captures timing)  │\n  │    router.ServeHTTP,            ← matches route             │\n  │  )                                                           │\n  │                                                              │\n  │  Per-route (inside router):                                  │\n  │    if requiresAuth:  JWTMiddleware → 401 on fail            │\n  │    if rateLimitKey:  RateLimiter → 429 on exceeded          │\n  │    add correlation header                                    │\n  │    if upstream=url-service: CircuitBreaker.Do(proxy)        │\n  │    else: direct proxy                                        │\n  └──────────────────────────────────────────────────────────────┘</code></pre></div>\n\n<h3 id=\"52-correlationidmiddleware-implementation\">5.2 <code>CorrelationIDMiddleware</code> Implementation</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// middleware.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> gateway</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourhandle/url-shortener/shared/logger</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> CorrelationIDMiddleware</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">next</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        id </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> r.Header.</span><span style=\"color:#B392F0\">Get</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"X-Correlation-ID\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> id </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            id </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> newUUID</span><span style=\"color:#E1E4E8\">()  </span><span style=\"color:#6A737D\">// crypto/rand UUID v4 (same helper as other services)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ctx </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> logger.</span><span style=\"color:#B392F0\">ContextWithCorrelationID</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">(), id)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"X-Correlation-ID\"</span><span style=\"color:#E1E4E8\">, id)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        next.</span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(w, r.</span><span style=\"color:#B392F0\">WithContext</span><span style=\"color:#E1E4E8\">(ctx))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// chain applies middlewares right-to-left (outermost first in call order).</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> chain</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">h</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">middlewares</span><span style=\"color:#F97583\"> ...func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(middlewares) </span><span style=\"color:#F97583\">-</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">>=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i</span><span style=\"color:#F97583\">--</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        h </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> middlewares</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#B392F0\">i</span><span style=\"color:#E1E4E8\">](h)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> h</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"53-gateway-jwt-middleware\">5.3 Gateway JWT Middleware</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// jwtmiddleware.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> gateway</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">encoding/json</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">net/http</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">strings</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourhandle/url-shortener/shared/auth</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">github.com/yourhandle/url-shortener/shared/logger</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// GatewayJWTMiddleware verifies JWT on routes with requiresAuth=true.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// On success: injects Claims into context for downstream use.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// On failure: writes 401 and does NOT forward to upstream.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// This wraps shared/auth.JWTMiddleware to add gateway-specific logging.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> GatewayJWTMiddleware</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">secret</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    inner </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> auth.</span><span style=\"color:#B392F0\">JWTMiddleware</span><span style=\"color:#E1E4E8\">(secret)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">next</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Handler</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> http.</span><span style=\"color:#B392F0\">HandlerFunc</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // shared/auth.JWTMiddleware writes 401 if token invalid.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">            // We wrap it to log the rejection with correlation ID.</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            rw </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">responseWriter</span><span style=\"color:#E1E4E8\">{ResponseWriter: w, status: </span><span style=\"color:#79B8FF\">200</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">            inner</span><span style=\"color:#E1E4E8\">(next).</span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(rw, r)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> rw.status </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> 401</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"JWT rejected\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                    \"correlation_id\"</span><span style=\"color:#E1E4E8\">, logger.</span><span style=\"color:#B392F0\">CorrelationIDFromContext</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">()),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                    \"path\"</span><span style=\"color:#E1E4E8\">, r.URL.Path,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                )</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"54-rate-limiter-client-ip-extraction\">5.4 Rate Limiter — Client IP Extraction</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// ratelimit.go</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// clientIP extracts the real client IP from a request.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// For this project (no load balancer): uses RemoteAddr directly.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// In production with a reverse proxy, check X-Forwarded-For first.</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> clientIP</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ip, _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> net.</span><span style=\"color:#B392F0\">SplitHostPort</span><span style=\"color:#E1E4E8\">(r.RemoteAddr)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> r.RemoteAddr</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> ip</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// rateLimitKey builds the Redis key for a route+IP combination.</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">// Format: \"rl:{routeKey}:{ip}\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> buildRateLimitKey</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">routeKey</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">ip</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#9ECBFF\"> \"rl:\"</span><span style=\"color:#F97583\"> +</span><span style=\"color:#E1E4E8\"> routeKey </span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\"> \":\"</span><span style=\"color:#F97583\"> +</span><span style=\"color:#E1E4E8\"> ip</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"55-gateway-servehttp-full-router-logic\">5.5 Gateway <code>ServeHTTP</code> — Full Router Logic</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// router.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">type</span><span style=\"color:#B392F0\"> Gateway</span><span style=\"color:#F97583\"> struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    routes         []</span><span style=\"color:#B392F0\">Route</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    proxies        </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">UpstreamProxy</span><span style=\"color:#6A737D\">  // keyed by upstream service name</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    urlServiceCB   </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">CircuitBreaker</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rateLimiter    </span><span style=\"color:#B392F0\">RateLimiter</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    jwtSecret      </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rateLimits     </span><span style=\"color:#F97583\">map</span><span style=\"color:#E1E4E8\">[</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#B392F0\">RateLimitConfig</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log            </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\"> (</span><span style=\"color:#FFAB70\">g </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Gateway</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">r</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Request</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Find matching route</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> matched </span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">Route</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> g.routes {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        rt </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#E1E4E8\">g.routes[i]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> strings.</span><span style=\"color:#B392F0\">HasPrefix</span><span style=\"color:#E1E4E8\">(r.URL.Path, rt.PathPrefix) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> rt.Method </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#F97583\"> ||</span><span style=\"color:#E1E4E8\"> rt.Method </span><span style=\"color:#F97583\">==</span><span style=\"color:#E1E4E8\"> r.Method {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                matched </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> rt</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                break</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> matched </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        writeError</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#79B8FF\">404</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"not found\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // JWT authentication</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> matched.RequiresAuth {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        claims, ok </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> g.</span><span style=\"color:#B392F0\">verifyJWT</span><span style=\"color:#E1E4E8\">(w, r)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">ok {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#6A737D\">  // 401 already written</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        _ </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> claims  </span><span style=\"color:#6A737D\">// inject into context for upstream if needed</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Rate limiting</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> matched.RateLimitKey </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        rlCfg, exists </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> g.rateLimits[matched.RateLimitKey]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> exists {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            ip </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> clientIP</span><span style=\"color:#E1E4E8\">(r)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            key </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> buildRateLimitKey</span><span style=\"color:#E1E4E8\">(matched.RateLimitKey, ip)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            allowed, retryAfter, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> g.rateLimiter.</span><span style=\"color:#B392F0\">Allow</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">(), key, rlCfg.Limit, rlCfg.WindowSecs)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">allowed {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Retry-After\"</span><span style=\"color:#E1E4E8\">, strconv.</span><span style=\"color:#B392F0\">Itoa</span><span style=\"color:#E1E4E8\">(retryAfter))</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">                writeError</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#79B8FF\">429</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"rate limit exceeded\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Forward X-Correlation-ID header to upstream</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    corrID </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> logger.</span><span style=\"color:#B392F0\">CorrelationIDFromContext</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    r.Header.</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"X-Correlation-ID\"</span><span style=\"color:#E1E4E8\">, corrID)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Route to upstream</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    proxy, ok </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> g.proxies[matched.Upstream]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">ok {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        g.log.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"no proxy for upstream\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"upstream\"</span><span style=\"color:#E1E4E8\">, matched.Upstream)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">        writeError</span><span style=\"color:#E1E4E8\">(w, </span><span style=\"color:#79B8FF\">500</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"internal server error\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Apply path rewriting for redirect route</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    outPath </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> r.URL.Path</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> matched.StripPrefix </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        outPath </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> strings.</span><span style=\"color:#B392F0\">TrimPrefix</span><span style=\"color:#E1E4E8\">(outPath, matched.StripPrefix)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Special: /r/{code} → /{code}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> strings.</span><span style=\"color:#B392F0\">HasPrefix</span><span style=\"color:#E1E4E8\">(r.URL.Path, </span><span style=\"color:#9ECBFF\">\"/r/\"</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        outPath </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> strings.</span><span style=\"color:#B392F0\">TrimPrefix</span><span style=\"color:#E1E4E8\">(outPath, </span><span style=\"color:#9ECBFF\">\"/r\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    r2 </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> r.</span><span style=\"color:#B392F0\">Clone</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    r2.URL.Path </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> outPath</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> r2.URL.Path </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"\"</span><span style=\"color:#E1E4E8\"> { r2.URL.Path </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"/\"</span><span style=\"color:#E1E4E8\"> }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Circuit breaker for url-service only</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> matched.Upstream </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"url-service\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        rw </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">responseWriter</span><span style=\"color:#E1E4E8\">{ResponseWriter: w, status: </span><span style=\"color:#79B8FF\">200</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> g.urlServiceCB.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(r.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            proxy.proxy.</span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(rw, r2)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> rw.status </span><span style=\"color:#F97583\">>=</span><span style=\"color:#79B8FF\"> 500</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"upstream 5xx: </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, rw.status)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">Is</span><span style=\"color:#E1E4E8\">(err, ErrCircuitOpen) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(http.StatusServiceUnavailable)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            w.</span><span style=\"color:#B392F0\">Write</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`{\"error\":\"service unavailable\"}`</span><span style=\"color:#E1E4E8\">))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Direct proxy for other upstreams</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    proxy.proxy.</span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(w, r2)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"56-gateway-startup-sequence\">5.6 Gateway Startup Sequence</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>main.go startup — gateway:\n  1. loadConfig()\n     → if any required env var empty: fmt.Fprintf(stderr) + os.Exit(1)\n  2. log := logger.New(cfg.ServiceName)\n  3. Build Redis client for rate limiting:\n     opts, err := redis.ParseURL(cfg.RedisURL)\n     client := redis.NewClient(opts)\n     // Ping with 3s timeout; warn on failure (fail-open)\n     pingCtx, cancel := context.WithTimeout(ctx, 3*time.Second)\n     if err := client.Ping(pingCtx).Err(); err != nil:\n       log.Warn(&quot;gateway redis unreachable, rate limiting will fail-open&quot;, &quot;error&quot;, err)\n     cancel()\n  4. Build UpstreamProxy for each service:\n     proxies := map[string]*UpstreamProxy{\n       &quot;url-service&quot;:          NewUpstreamProxy(cfg.URLServiceURL, log, &quot;url-service&quot;),\n       &quot;analytics-service&quot;:    NewUpstreamProxy(cfg.AnalyticsServiceURL, log, &quot;analytics-service&quot;),\n       &quot;user-service&quot;:         NewUpstreamProxy(cfg.UserServiceURL, log, &quot;user-service&quot;),\n       &quot;notification-service&quot;: NewUpstreamProxy(cfg.NotificationServiceURL, log, &quot;notification-service&quot;),\n     }\n  5. Build CircuitBreaker:\n     cb := NewCircuitBreaker(cfg.CBMaxFailures, cfg.CBOpenTimeout, cfg.CBFailureWindow)\n  6. Build RateLimiter:\n     rl := NewRateLimiter(client, log)\n  7. Build Gateway:\n     gw := &amp;Gateway{\n       routes: routingTable,\n       proxies: proxies,\n       urlServiceCB: cb,\n       rateLimiter: rl,\n       jwtSecret: cfg.JWTSecret,\n       rateLimits: cfg.RateLimits,\n       log: log,\n     }\n  8. Build mux:\n     mux := http.NewServeMux()\n     mux.HandleFunc(&quot;GET /health&quot;, NewHealthHandler(cfg.ServiceName))\n     mux.Handle(&quot;/&quot;, chain(\n       gw,\n       logger.RequestLogger(log),\n       CorrelationIDMiddleware,\n     ))\n  9. Health-check all four downstream services on startup:\n     go func():\n       for _, upstream := range []struct{name, url string}{\n         {&quot;url-service&quot;, cfg.URLServiceURL},\n         {&quot;analytics-service&quot;, cfg.AnalyticsServiceURL},\n         {&quot;user-service&quot;, cfg.UserServiceURL},\n         {&quot;notification-service&quot;, cfg.NotificationServiceURL},\n       }:\n         resp, err := http.Get(upstream.url + &quot;/health&quot;)\n         if err != nil || resp.StatusCode != 200:\n           log.Warn(&quot;upstream not healthy at startup&quot;,\n             &quot;upstream&quot;, upstream.name,\n             &quot;error&quot;, err,\n           )\n         else:\n           log.Info(&quot;upstream healthy&quot;, &quot;upstream&quot;, upstream.name)\n     ()\n  10. srv.ListenAndServe()</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-31.svg\" alt=\"Redis Token Bucket Rate Limiter Implementation\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Gateway wiring diagram:\n                        ┌─────────────────────────────────┐\n  Client ──HTTP──►      │           API Gateway            │\n                        │                                  │\n                        │  CorrelationIDMiddleware         │\n                        │  RequestLogger                   │\n                        │  Router (routingTable)           │\n                        │    │                             │\n                        │    ├─[auth]   JWTMiddleware      │  ← shared/auth.VerifyToken\n                        │    ├─[rl]     redisTokenBucket   │  ← Redis INCR+EXPIRE\n                        │    └─[proxy]                     │\n                        │          │                       │\n                        │    url-service ──► CircuitBreaker│\n                        │          │                       │\n                        │    analytics-service ──► direct  │\n                        │    user-service ──► direct       │\n                        │    notification-service ──►direct│\n                        │                                  │\n                        │  Redis ◄───── rate limit keys    │\n                        └─────────────────────────────────┘\n                                        │\n                                  (proxied to)\n                              ┌─────────────────────────────┐\n                              │  url-service       :8081    │\n                              │  analytics-service :8082    │\n                              │  user-service      :8083    │\n                              │  notification-svc  :8084    │\n                              └─────────────────────────────┘</code></pre></div>\n\n<h3 id=\"57-notification-service-startup-sequence\">5.7 Notification Service Startup Sequence</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>main.go startup — notification-service:\n  1. loadConfig() → fatal if DATABASE_URL | RABBITMQ_URL | JWT_SECRET missing\n  2. log := logger.New(cfg.ServiceName)\n  3. ctx, cancel := context.WithCancel(context.Background())\n  4. NewDBPool(ctx, cfg.DatabaseURL, log) → fatal on error\n  5. runMigrations(ctx, pool, log) → fatal on error\n  6. NewRabbitMQConn(ctx, cfg.RabbitMQURL, log, 10) → fatal after 10 attempts\n  7. DeclareNotificationQueue(mq.Channel) → fatal on error (from M1)\n  8. store := NewNotificationStore(pool)\n  9. consumer := NewNotificationConsumer(mq, pool, store, log)\n  10. handler := NewNotificationHandler(store, log)\n  11. mux := http.NewServeMux()\n      mux.HandleFunc(&quot;GET /health&quot;, NewHealthHandler(cfg.ServiceName))\n      mux.Handle(&quot;GET /notifications&quot;,\n        auth.JWTMiddleware(cfg.JWTSecret)(http.HandlerFunc(handler.ListNotifications)))\n  12. go consumer.Run(ctx)\n  13. srv.ListenAndServe()\n  14. On SIGTERM: cancel(); srv.Shutdown(...)</code></pre></div>\n\n<h3 id=\"58-schema-migration-notification-service\">5.8 Schema Migration — Notification Service</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// main.go</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">const</span><span style=\"color:#79B8FF\"> notificationSchema</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> `</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE TABLE IF NOT EXISTS notifications (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    id         UUID        PRIMARY KEY DEFAULT gen_random_uuid(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    user_id    UUID        NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    event_type TEXT        NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    payload    JSONB       NOT NULL,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    status     TEXT        NOT NULL DEFAULT 'sent',</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    sent_at    TIMESTAMPTZ NULL</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">);</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">CREATE INDEX IF NOT EXISTS idx_notifications_user_created</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    ON notifications(user_id, created_at DESC);</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">`</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> runMigrations</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">pool</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">pgxpool</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Pool</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">log</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">slog</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Logger</span><span style=\"color:#E1E4E8\">) </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> pool.</span><span style=\"color:#B392F0\">Exec</span><span style=\"color:#E1E4E8\">(ctx, notificationSchema)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#E1E4E8\"> fmt.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"notification migrations: </span><span style=\"color:#79B8FF\">%w</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    log.</span><span style=\"color:#B392F0\">Info</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"notification migrations applied\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"59-docker-composeyml-additions-m5\">5.9 <code>docker-compose.yml</code> Additions (M5)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">yaml</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Extend existing service environment blocks:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">notification-service</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    DATABASE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">postgres://notificationuser:notificationpass@notification_db:5432/notificationdb</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    RABBITMQ_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">amqp://guest:guest@rabbitmq:5672/</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    JWT_SECRET</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"change-this-in-production-minimum-32-chars\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    PORT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"8080\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">gateway</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">  environment</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    URL_SERVICE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">http://url-service:8080</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    ANALYTICS_SERVICE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">http://analytics-service:8080</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    USER_SERVICE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">http://user-service:8080</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    NOTIFICATION_SERVICE_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">http://notification-service:8080</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    REDIS_URL</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">redis://redis:6379/0</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    JWT_SECRET</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"change-this-in-production-minimum-32-chars\"</span></span>\n<span class=\"line\"><span style=\"color:#85E89D\">    PORT</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"8080\"</span></span></code></pre></div>\n\n<h2 id=\"jwt_secret-must-be-identical-across-user-service-url-service-notification-service-gateway-any-mismatch-causes-all-jwt-verifications-to-fail-with-401\"><strong><code>JWT_SECRET</code> must be identical across:</strong> user-service, url-service, notification-service, gateway. Any mismatch causes all JWT verifications to fail with 401</h2>\n<h2 id=\"6-error-handling-matrix\">6. Error Handling Matrix</h2>\n<h3 id=\"61-notification-service\">6.1 Notification Service</h3>\n<table>\n<thead>\n<tr>\n<th>Error Scenario</th>\n<th>Detected By</th>\n<th>Recovery</th>\n<th>HTTP Status / AMQP</th>\n<th>Log Level</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Missing <code>DATABASE_URL</code></td>\n<td><code>loadConfig()</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>— (pre-HTTP)</td>\n<td>Error (stderr)</td>\n</tr>\n<tr>\n<td>Missing <code>RABBITMQ_URL</code></td>\n<td><code>loadConfig()</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>— (pre-HTTP)</td>\n<td>Error (stderr)</td>\n</tr>\n<tr>\n<td>Missing <code>JWT_SECRET</code></td>\n<td><code>loadConfig()</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>— (pre-HTTP)</td>\n<td>Error (stderr)</td>\n</tr>\n<tr>\n<td>DB unreachable at startup</td>\n<td><code>NewDBPool</code> ping</td>\n<td><code>os.Exit(1)</code></td>\n<td>—</td>\n<td>Error</td>\n</tr>\n<tr>\n<td>Migration SQL fails</td>\n<td><code>pool.Exec</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>—</td>\n<td>Error</td>\n</tr>\n<tr>\n<td>RabbitMQ unreachable (all 10 attempts)</td>\n<td><code>NewRabbitMQConn</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>—</td>\n<td>Error</td>\n</tr>\n<tr>\n<td>Queue declare fails</td>\n<td><code>DeclareNotificationQueue</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>—</td>\n<td>Error</td>\n</tr>\n<tr>\n<td>Consumer QoS fails</td>\n<td><code>ch.Qos</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>—</td>\n<td>Error</td>\n</tr>\n<tr>\n<td>Consumer <code>Consume</code> fails</td>\n<td><code>ch.Consume</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>—</td>\n<td>Error</td>\n</tr>\n<tr>\n<td>AMQP channel closed mid-run</td>\n<td><code>ok == false</code> on msgs</td>\n<td>Block on <code>&lt;-ctx.Done()</code></td>\n<td>—</td>\n<td>Warn</td>\n</tr>\n<tr>\n<td>Consumer panic</td>\n<td><code>defer recover()</code></td>\n<td><code>d.Ack(false)</code></td>\n<td>—</td>\n<td>Error</td>\n</tr>\n<tr>\n<td>Unknown routing key</td>\n<td>key not in {created,deleted,milestone}</td>\n<td><code>d.Ack(false)</code></td>\n<td>—</td>\n<td>Warn</td>\n</tr>\n<tr>\n<td>Malformed JSON body (any event type)</td>\n<td><code>json.Unmarshal</code></td>\n<td><code>d.Ack(false)</code></td>\n<td>—</td>\n<td>Error</td>\n</tr>\n<tr>\n<td>Missing <code>user_id</code> in event</td>\n<td>field check</td>\n<td><code>d.Ack(false)</code></td>\n<td>—</td>\n<td>Error</td>\n</tr>\n<tr>\n<td>DB <code>Insert</code> fails</td>\n<td><code>store.Insert</code></td>\n<td><code>d.Nack(false, true)</code></td>\n<td>—</td>\n<td>Error</td>\n</tr>\n<tr>\n<td>Missing Authorization header</td>\n<td><code>JWTMiddleware</code></td>\n<td>401</td>\n<td>401</td>\n<td>none</td>\n</tr>\n<tr>\n<td>Invalid/expired JWT on GET /notifications</td>\n<td><code>JWTMiddleware</code></td>\n<td>401</td>\n<td>401</td>\n<td>none</td>\n</tr>\n<tr>\n<td>DB <code>FindByUserID</code> fails</td>\n<td><code>store.FindByUserID</code></td>\n<td>500</td>\n<td>500</td>\n<td>Error</td>\n</tr>\n<tr>\n<td>Invalid <code>limit</code> query param</td>\n<td><code>strconv.Atoi</code></td>\n<td>400</td>\n<td>400</td>\n<td>none</td>\n</tr>\n<tr>\n<td>Invalid <code>after</code> cursor (non-UUID)</td>\n<td>subquery on PK</td>\n<td>DB returns 0 rows gracefully</td>\n<td>—</td>\n<td>none</td>\n</tr>\n</tbody></table>\n<h3 id=\"62-api-gateway\">6.2 API Gateway</h3>\n<table>\n<thead>\n<tr>\n<th>Error Scenario</th>\n<th>Detected By</th>\n<th>Recovery</th>\n<th>HTTP Status</th>\n<th>Log Level</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Missing required env var</td>\n<td><code>loadConfig()</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>—</td>\n<td>Error (stderr)</td>\n</tr>\n<tr>\n<td>Redis parse URL fails</td>\n<td><code>redis.ParseURL</code></td>\n<td>Warn + continue (fail-open)</td>\n<td>—</td>\n<td>Warn</td>\n</tr>\n<tr>\n<td>Redis unreachable at startup</td>\n<td><code>client.Ping</code></td>\n<td>Warn + continue (fail-open)</td>\n<td>—</td>\n<td>Warn</td>\n</tr>\n<tr>\n<td>Invalid upstream URL in config</td>\n<td><code>url.Parse</code></td>\n<td><code>os.Exit(1)</code></td>\n<td>—</td>\n<td>Error</td>\n</tr>\n<tr>\n<td>No matching route</td>\n<td>router loop exhausted</td>\n<td>404 <code>{&quot;error&quot;:&quot;not found&quot;}</code></td>\n<td>404</td>\n<td>none</td>\n</tr>\n<tr>\n<td>Missing Authorization header</td>\n<td><code>JWTMiddleware</code></td>\n<td>401 <code>{&quot;error&quot;:&quot;authorization header required&quot;}</code></td>\n<td>401</td>\n<td>Info</td>\n</tr>\n<tr>\n<td>Invalid/expired JWT</td>\n<td><code>auth.VerifyToken</code></td>\n<td>401 <code>{&quot;error&quot;:&quot;unauthorized&quot;}</code></td>\n<td>401</td>\n<td>Info</td>\n</tr>\n<tr>\n<td>Rate limit exceeded</td>\n<td><code>redisTokenBucket.Allow</code></td>\n<td>429 + <code>Retry-After: 60</code> header</td>\n<td>429</td>\n<td>none</td>\n</tr>\n<tr>\n<td>Redis INCR error (rate limiter)</td>\n<td><code>client.Incr</code></td>\n<td>Warn + allow (fail-open)</td>\n<td>—</td>\n<td>Warn</td>\n</tr>\n<tr>\n<td>Redis Expire error (rate limiter)</td>\n<td><code>client.Expire</code></td>\n<td>Warn + continue (non-fatal)</td>\n<td>—</td>\n<td>Warn</td>\n</tr>\n<tr>\n<td>Circuit OPEN, request rejected</td>\n<td><code>cb.Do</code> returns <code>ErrCircuitOpen</code></td>\n<td>503 <code>{&quot;error&quot;:&quot;service unavailable&quot;}</code></td>\n<td>503</td>\n<td>none (state transition already logged)</td>\n</tr>\n<tr>\n<td>Upstream returns 5xx</td>\n<td>proxy response status</td>\n<td>Increment circuit breaker failure counter</td>\n<td>5xx (proxied)</td>\n<td>Warn</td>\n</tr>\n<tr>\n<td>Upstream network error / timeout</td>\n<td><code>proxy.ErrorHandler</code></td>\n<td>502 <code>{&quot;error&quot;:&quot;upstream error&quot;}</code></td>\n<td>502</td>\n<td>Warn</td>\n</tr>\n<tr>\n<td>Circuit transitions CLOSED→OPEN</td>\n<td><code>cb.Do</code> failure count</td>\n<td>Log state transition</td>\n<td>—</td>\n<td>Warn</td>\n</tr>\n<tr>\n<td>Circuit transitions OPEN→HALF_OPEN</td>\n<td>timeout elapsed</td>\n<td>Log state transition</td>\n<td>—</td>\n<td>Info</td>\n</tr>\n<tr>\n<td>Probe succeeds (HALF_OPEN→CLOSED)</td>\n<td><code>cb.Do</code> success</td>\n<td>Log state transition</td>\n<td>—</td>\n<td>Info</td>\n</tr>\n<tr>\n<td>Probe fails (HALF_OPEN→OPEN)</td>\n<td><code>cb.Do</code> failure</td>\n<td>Log state transition</td>\n<td>—</td>\n<td>Warn</td>\n</tr>\n<tr>\n<td>Upstream health check fails at startup</td>\n<td><code>http.Get</code> on <code>/health</code></td>\n<td>Log warning; gateway starts anyway</td>\n<td>—</td>\n<td>Warn</td>\n</tr>\n<tr>\n<td>Response writer write error</td>\n<td><code>w.Write</code> return</td>\n<td>Ignored (client disconnected)</td>\n<td>—</td>\n<td>none</td>\n</tr>\n</tbody></table>\n<p><strong><code>writeError</code> and <code>writeJSON</code> in gateway (<code>router.go</code> or <code>errors.go</code>):</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">// errors.go in gateway package</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> writeError</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">status</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">message</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(status)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">NewEncoder</span><span style=\"color:#E1E4E8\">(w).</span><span style=\"color:#B392F0\">Encode</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        Error </span><span style=\"color:#F97583\">string</span><span style=\"color:#9ECBFF\"> `json:\"error\"`</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }{Error: message})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> writeJSON</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">w</span><span style=\"color:#B392F0\"> http</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">ResponseWriter</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">status</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">v</span><span style=\"color:#B392F0\"> any</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">Header</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">Set</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Content-Type\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"application/json\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    w.</span><span style=\"color:#B392F0\">WriteHeader</span><span style=\"color:#E1E4E8\">(status)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">NewEncoder</span><span style=\"color:#E1E4E8\">(w).</span><span style=\"color:#B392F0\">Encode</span><span style=\"color:#E1E4E8\">(v)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<hr>\n<h2 id=\"7-implementation-sequence-with-checkpoints\">7. Implementation Sequence with Checkpoints</h2>\n<h3 id=\"phase-1-notification-service-db-schema-consumer-handler-225h\">Phase 1: Notification Service — DB Schema, Consumer, Handler (2–2.5h)</h3>\n<ol>\n<li>Write <code>migration.sql</code> as specified in §3.1.</li>\n<li>Write <code>errors.go</code>: <code>writeError</code>, <code>writeJSON</code>, <code>truncate</code>.</li>\n<li>Write <code>store.go</code>: <code>NotificationRecord</code>, <code>NotificationRepository</code> interface, <code>pgxNotificationStore</code> with <code>Insert</code> (two-step tx: INSERT then UPDATE status) and <code>FindByUserID</code> (cursor pagination).</li>\n<li>Write <code>consumer.go</code>: <code>NotificationConsumer</code>, <code>Run()</code>, <code>processDelivery()</code> with full event-type switch and <code>mockEmail</code> log.</li>\n<li>Write <code>handler.go</code>: <code>NotificationHandler</code>, <code>ListNotifications</code> method.</li>\n<li>Extend <code>config.go</code> with <code>JWTSecret</code>.</li>\n<li>Extend <code>main.go</code>: <code>runMigrations</code>, wire all components, register routes, start consumer goroutine.</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> up</span><span style=\"color:#9ECBFF\"> notification_db</span><span style=\"color:#9ECBFF\"> rabbitmq</span><span style=\"color:#79B8FF\"> -d</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">DATABASE_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"postgres://notificationuser:notificationpass@localhost:5435/notificationdb\"</span><span style=\"color:#B392F0\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">RABBITMQ_URL=</span><span style=\"color:#9ECBFF\">\"amqp://guest:guest@localhost:5672/\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">JWT_SECRET=</span><span style=\"color:#9ECBFF\">\"test-secret-minimum-32-chars-long\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">go </span><span style=\"color:#9ECBFF\">run</span><span style=\"color:#9ECBFF\"> ./services/notification-service/</span></span></code></pre></div>\n\n<p>Verify schema:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">psql</span><span style=\"color:#79B8FF\"> -h</span><span style=\"color:#9ECBFF\"> localhost</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 5435</span><span style=\"color:#79B8FF\"> -U</span><span style=\"color:#9ECBFF\"> notificationuser</span><span style=\"color:#79B8FF\"> -d</span><span style=\"color:#9ECBFF\"> notificationdb</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -c</span><span style=\"color:#9ECBFF\"> \"\\d notifications; \\di idx_notifications_*;\"</span></span></code></pre></div>\n\n<p>Manually publish a test message to <code>notifications.events</code> queue via RabbitMQ management UI (routing key <code>url.created</code>, body matching <code>URLCreatedEvent</code> JSON with <code>user_id</code> and <code>user_email</code> populated).\n<strong>Checkpoint:</strong> Consumer logs <code>&quot;would send email to user&quot;</code> with <code>user_id</code> and <code>message</code>. <code>SELECT * FROM notifications;</code> shows one row with <code>status=&#39;sent&#39;</code> and non-null <code>sent_at</code>. <code>GET /notifications</code> with a valid JWT returns <code>200 [{&quot;id&quot;:&quot;...&quot;,&quot;event_type&quot;:&quot;url.created&quot;,...}]</code>. <code>go build ./services/notification-service/...</code> exits 0.</p>\n<h3 id=\"phase-2-extended-sharedlogger-051h\">Phase 2: Extended <code>shared/logger</code> (0.5–1h)</h3>\n<ol>\n<li>Extend <code>shared/logger/logger.go</code> with <code>WithCorrelationID</code>, <code>CorrelationIDFromContext</code>, <code>ContextWithCorrelationID</code>, <code>RequestLogger</code>, and the <code>responseWriter</code> capture struct.</li>\n<li>Update <code>go.work</code> if not already including <code>shared/logger</code>.</li>\n<li>Verify all existing services still compile: <code>go build ./...</code> from monorepo root.\n<strong>Checkpoint:</strong> <code>go build github.com/yourhandle/url-shortener/shared/logger</code> exits 0. A test that calls <code>logger.RequestLogger</code> as middleware and checks that the log line contains <code>&quot;correlation_id&quot;</code> passes.</li>\n</ol>\n<h3 id=\"phase-3-gateway-routing-table-and-reverse-proxy-115h\">Phase 3: Gateway Routing Table and Reverse Proxy (1–1.5h)</h3>\n<ol>\n<li>Extend <code>gateway/config.go</code> to full spec (§3.4 Config struct with all fields).</li>\n<li>Write <code>gateway/router.go</code>: <code>Route</code> struct, <code>routingTable</code> slice, <code>Gateway</code> struct, stub <code>ServeHTTP</code> that routes + proxies without auth/rate limit yet.</li>\n<li>Write <code>gateway/proxy.go</code>: <code>UpstreamProxy</code>, <code>NewUpstreamProxy</code>, <code>ServeHTTP</code> with path rewriting.</li>\n<li>Write <code>gateway/middleware.go</code>: <code>CorrelationIDMiddleware</code>, <code>chain</code> helper.</li>\n<li>Extend <code>gateway/main.go</code>: construct proxies, gateway, wire mux, start server.</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> up</span><span style=\"color:#9ECBFF\"> url-service</span><span style=\"color:#9ECBFF\"> analytics-service</span><span style=\"color:#9ECBFF\"> user-service</span><span style=\"color:#9ECBFF\"> notification-service</span><span style=\"color:#79B8FF\"> -d</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">REDIS_URL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"redis://localhost:6379/0\"</span><span style=\"color:#B392F0\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">URL_SERVICE_URL=</span><span style=\"color:#9ECBFF\">\"http://localhost:8081\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">ANALYTICS_SERVICE_URL=</span><span style=\"color:#9ECBFF\">\"http://localhost:8082\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">USER_SERVICE_URL=</span><span style=\"color:#9ECBFF\">\"http://localhost:8083\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">NOTIFICATION_SERVICE_URL=</span><span style=\"color:#9ECBFF\">\"http://localhost:8084\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">JWT_SECRET=</span><span style=\"color:#9ECBFF\">\"test-secret-minimum-32-chars-long\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">go </span><span style=\"color:#9ECBFF\">run</span><span style=\"color:#9ECBFF\"> ./gateway/</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Test proxy routing (no auth yet on protected routes in this phase):</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/auth/register</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"e2e@example.com\",\"password\":\"password123\"}'</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: 201 {user_id, email} (proxied to user-service)</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> <code>GET http://localhost:8080/health</code> returns <code>{&quot;status&quot;:&quot;ok&quot;,&quot;service&quot;:&quot;gateway&quot;}</code>. <code>POST /api/auth/register</code> proxied correctly to user-service. <code>GET /api/stats/&lt;code&gt;</code> proxied to analytics-service. Unknown path <code>/xyz</code> returns 404. <code>X-Correlation-ID</code> response header present on all responses.</p>\n<h3 id=\"phase-4-gateway-jwt-middleware-and-x-correlation-id-propagation-1h\">Phase 4: Gateway JWT Middleware and X-Correlation-ID Propagation (1h)</h3>\n<ol>\n<li>Write <code>gateway/jwtmiddleware.go</code>: <code>GatewayJWTMiddleware</code> wrapping <code>shared/auth.JWTMiddleware</code>.</li>\n<li>Integrate into <code>Gateway.ServeHTTP</code>: apply JWT check when <code>route.RequiresAuth == true</code>.</li>\n<li>Verify <code>X-Correlation-ID</code> is forwarded to upstream (set on <code>r.Header</code> before proxy).</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Without token on protected route:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/shorten</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://example.com\"}'</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: 401 {\"error\":\"authorization header required\"}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># With invalid token:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/urls</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer invalid.token.here\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: 401</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># With valid token (get one from login first):</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/urls</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$VALID_TOKEN</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: 200 {\"urls\":[],\"next_cursor\":null} (proxied to url-service)</span></span></code></pre></div>\n\n<p>Check that <code>X-Correlation-ID</code> appears in url-service logs:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> logs</span><span style=\"color:#9ECBFF\"> url-service</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#9ECBFF\"> correlation_id</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> Auth-protected routes return 401 without valid JWT. Valid JWT routes through to upstream. <code>X-Correlation-ID</code> appears in forwarded request headers and in downstream service logs. Public routes (<code>/api/auth/*</code>, <code>/r/*</code>, <code>/api/stats/*</code>) pass through without JWT check.</p>\n<h3 id=\"phase-5-redis-token-bucket-rate-limiter-with-429-retry-after-152h\">Phase 5: Redis Token-Bucket Rate Limiter with 429 + Retry-After (1.5–2h)</h3>\n<ol>\n<li>Write <code>gateway/ratelimit.go</code>: <code>RateLimiter</code> interface, <code>redisTokenBucket</code>, <code>Allow</code> implementation, <code>clientIP</code>, <code>buildRateLimitKey</code>.</li>\n<li>Integrate into <code>Gateway.ServeHTTP</code>: apply rate limit when <code>route.RateLimitKey != &quot;&quot;</code>.</li>\n<li>Wire <code>redis.Client</code> construction in <code>gateway/main.go</code>.</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Rate limit test for POST /api/shorten (limit=10/min):</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">TOKEN</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/auth/login</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"email\":\"e2e@example.com\",\"password\":\"password123\"}'</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> python3</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"import sys,json; print(json.load(sys.stdin)['token'])\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> $(</span><span style=\"color:#B392F0\">seq</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#79B8FF\"> 11</span><span style=\"color:#E1E4E8\">); </span><span style=\"color:#F97583\">do</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  RESP</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/shorten</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://example.com/'</span><span style=\"color:#E1E4E8\">$i</span><span style=\"color:#9ECBFF\">'\"}'</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  echo</span><span style=\"color:#9ECBFF\"> \"Request </span><span style=\"color:#E1E4E8\">$i</span><span style=\"color:#9ECBFF\">: HTTP </span><span style=\"color:#E1E4E8\">$RESP</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">done</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected output:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Request 1-10: HTTP 201 (or whatever url-service returns)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Request 11:   HTTP 429</span></span></code></pre></div>\n\n<p>Verify <code>Retry-After</code> header on 429:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -v</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> http://localhost:8080/api/shorten</span><span style=\"color:#9ECBFF\"> ...</span><span style=\"color:#F97583\"> 2>&#x26;1</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#79B8FF\"> -i</span><span style=\"color:#9ECBFF\"> retry-after</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: &#x3C; Retry-After: 60</span></span></code></pre></div>\n\n<p>Verify Redis keys:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">redis-cli</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 6379</span><span style=\"color:#9ECBFF\"> KEYS</span><span style=\"color:#9ECBFF\"> \"rl:*\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: [\"rl:shorten:127.0.0.1\"]</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">redis-cli</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 6379</span><span style=\"color:#9ECBFF\"> GET</span><span style=\"color:#9ECBFF\"> \"rl:shorten:127.0.0.1\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: \"11\" (or current count)</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">redis-cli</span><span style=\"color:#79B8FF\"> -p</span><span style=\"color:#79B8FF\"> 6379</span><span style=\"color:#9ECBFF\"> TTL</span><span style=\"color:#9ECBFF\"> \"rl:shorten:127.0.0.1\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: positive integer ≤ 60</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> 11th <code>POST /api/shorten</code> from same IP returns <code>429</code> with <code>Retry-After: 60</code> header. Redis key <code>rl:shorten:&lt;ip&gt;</code> has a TTL ≤ 60s. <code>GET /r/&lt;code&gt;</code> allows 300 requests before 429. Killing Redis and making a request: gateway logs <code>&quot;rate limit redis incr failed&quot;</code> at Warn, request is allowed (fail-open), no 500 returned.</p>\n<h3 id=\"phase-6-circuit-breaker-state-machine-225h\">Phase 6: Circuit Breaker State Machine (2–2.5h)</h3>\n<ol>\n<li>Write <code>gateway/circuitbreaker.go</code>: <code>State</code>, <code>CircuitBreaker</code>, <code>NewCircuitBreaker</code>, <code>Do()</code> method (full algorithm from §4.4).</li>\n<li>Integrate <code>CircuitBreaker</code> into <code>Gateway.ServeHTTP</code> for url-service only.</li>\n<li>Wire <code>NewCircuitBreaker(cfg.CBMaxFailures, cfg.CBOpenTimeout, cfg.CBFailureWindow)</code> in <code>main.go</code>.</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\"># Simulate url-service failure by stopping it:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> stop</span><span style=\"color:#9ECBFF\"> url-service</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Make 5 requests (will fail; circuit counts them):</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> $(</span><span style=\"color:#B392F0\">seq</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#79B8FF\"> 6</span><span style=\"color:#E1E4E8\">); </span><span style=\"color:#F97583\">do</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">  RESP</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#9ECBFF\"> http://localhost:8080/r/abc1234</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  echo</span><span style=\"color:#9ECBFF\"> \"Request </span><span style=\"color:#E1E4E8\">$i</span><span style=\"color:#9ECBFF\">: HTTP </span><span style=\"color:#E1E4E8\">$RESP</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">done</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Requests 1-5: HTTP 502 (upstream error, circuit counting)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Request 6+:   HTTP 503 (circuit OPEN, rejected immediately)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Wait 30s then try again (half-open probe):</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 31</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">RESP</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#9ECBFF\"> http://localhost:8080/r/abc1234</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"Probe: HTTP </span><span style=\"color:#E1E4E8\">$RESP</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># If url-service still stopped: 502 (probe fails → back to OPEN)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Start url-service again:</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> start</span><span style=\"color:#9ECBFF\"> url-service</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 31</span><span style=\"color:#6A737D\">  # wait for next half-open</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">RESP</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -o</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#9ECBFF\"> http://localhost:8080/r/abc1234</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"Probe after restart: HTTP </span><span style=\"color:#E1E4E8\">$RESP</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expect: 301 (probe succeeds → CLOSED)</span></span></code></pre></div>\n\n<p>Check gateway logs for state transitions:</p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> logs</span><span style=\"color:#9ECBFF\"> gateway</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#9ECBFF\"> \"circuit breaker\"</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># Expected lines:</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># {\"level\":\"WARN\",\"service\":\"gateway\",\"msg\":\"circuit breaker OPEN\",\"failures\":5,...}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># {\"level\":\"INFO\",\"service\":\"gateway\",\"msg\":\"circuit breaker CLOSED (probe succeeded)\",...}</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> Circuit opens after 5 consecutive 5xx responses within 10s. <code>GET /r/&lt;code&gt;</code> returns <code>503 {&quot;error&quot;:&quot;service unavailable&quot;}</code> immediately (&lt; 1ms, no upstream call) while circuit is OPEN. After 30s, one probe request is forwarded. On success, circuit closes. Other upstream proxies (analytics, user, notification) are NOT affected by url-service circuit breaker.</p>\n<h3 id=\"phase-7-end-to-end-integration-test-152h\">Phase 7: End-to-End Integration Test (1.5–2h)</h3>\n<ol>\n<li>Write <code>gateway/gateway_test.go</code> (§8 test cases).</li>\n<li>Write integration test script <code>scripts/e2e_test.sh</code>.</li>\n<li>Run full stack via <code>docker compose up --build -d</code> and execute end-to-end test.</li>\n</ol>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> up</span><span style=\"color:#79B8FF\"> --build</span><span style=\"color:#79B8FF\"> -d</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 60</span><span style=\"color:#6A737D\">  # wait for all containers healthy</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">bash</span><span style=\"color:#9ECBFF\"> scripts/e2e_test.sh</span></span></code></pre></div>\n\n<p><strong>Checkpoint:</strong> End-to-end test script passes all assertions. Rate limit test: 11th <code>POST /api/shorten</code> returns 429. Circuit breaker test: 6th request after simulated failure returns 503. <code>X-Correlation-ID</code> appears in logs of gateway, url-service, analytics-service, notification-service for the same request UUID. <code>docker compose down -v</code> teardown exits 0.</p>\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-32.svg\" alt=\"X-Correlation-ID Propagation Through Sync and Async Boundaries\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>End-to-end flow: register → login → shorten → redirect → stats → notifications\n  Client              Gateway              Services              Async\n    │                    │                     │                    │\n    ├─POST /api/auth/register──────────────►user-service           │\n    │◄──201{user_id}──────┤                     │                  │\n    │                    │                     │                  │\n    ├─POST /api/auth/login─────────────────►user-service           │\n    │◄──200{token}────────┤                     │                  │\n    │                    │                     │                  │\n    ├─POST /api/shorten──►                     │                  │\n    │  [JWT✓] [rl:shorten]────────────────►url-service            │\n    │◄──201{short_code}───┤                     │                  │\n    │                    │                     │        ─────────►outbox\n    │                    │                     │        ◄url.created event\n    │                    │                     │        ────────►analytics.clicks\n    │                    │                     │        ────────►notifications.events\n    │                    │                     │                    │\n    ├─GET /r/{code}──────►                     │                  │\n    │  [rl:redirect]──────────────────────►url-service            │\n    │◄──301 Location──────┤                     │                  │\n    │                    │                     │        ─────────►outbox(click)\n    │                    │                     │        ◄url.clicked event\n    │                    │                     │                    │\n    ├─GET /api/stats/{code}────────────────►analytics-service      │\n    │◄──200{total_clicks}─┤                     │                  │\n    │                    │                     │                  │\n    ├─GET /api/notifications──────────────►notification-service    │\n    │  [JWT✓]             │                     │                  │\n    │◄──200[{notifs...}]──┤                     │                  │\n    │                    │                     │                  │\n  X-Correlation-ID = &quot;abc-123&quot; appears in logs of:\n    gateway, url-service, analytics-service, notification-service ✓</code></pre></div>\n\n<hr>\n<h2 id=\"8-test-specification\">8. Test Specification</h2>\n<h3 id=\"81-circuit-breaker-unit-tests-gateway_testgo\">8.1 Circuit Breaker Unit Tests (<code>gateway_test.go</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">package</span><span style=\"color:#B392F0\"> gateway</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> (</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">errors</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">sync</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">    \"</span><span style=\"color:#B392F0\">time</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCircuitBreaker_InitiallyClosed</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewCircuitBreaker</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">5</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cb.state </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> StateClosed {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"initial state: got </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\"> want CLOSED\"</span><span style=\"color:#E1E4E8\">, cb.state)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCircuitBreaker_ClosedPassesSuccess</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewCircuitBreaker</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">5</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> })</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"success in CLOSED: got error </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> cb.state </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> StateClosed {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"state after success: got </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, cb.state)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCircuitBreaker_OpensAfterMaxFailures</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewCircuitBreaker</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    fail </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"upstream error\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 3</span><span style=\"color:#E1E4E8\">; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), fail)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    state </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cb.state</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> state </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> StateOpen {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"state after max failures: got </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\"> want OPEN\"</span><span style=\"color:#E1E4E8\">, state)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCircuitBreaker_OpenRejectsWithoutCallingUpstream</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewCircuitBreaker</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"fail\"</span><span style=\"color:#E1E4E8\">) }) </span><span style=\"color:#6A737D\">// trip</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    called </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> false</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        called </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> true</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> called {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"upstream should NOT be called when circuit is OPEN\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">errors.</span><span style=\"color:#B392F0\">Is</span><span style=\"color:#E1E4E8\">(err, ErrCircuitOpen) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected ErrCircuitOpen, got </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCircuitBreaker_TransitionsToHalfOpenAfterTimeout</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewCircuitBreaker</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Millisecond, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"fail\"</span><span style=\"color:#E1E4E8\">) }) </span><span style=\"color:#6A737D\">// trip</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    time.</span><span style=\"color:#B392F0\">Sleep</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">150</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Millisecond)</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Next Do should transition to HALF_OPEN and allow through</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    probeCalled </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> false</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        probeCalled </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> true</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        return</span><span style=\"color:#79B8FF\"> nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">probeCalled {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"probe request should be forwarded in HALF_OPEN\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    state </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cb.state</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> state </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> StateClosed {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"state after successful probe: got </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\"> want CLOSED\"</span><span style=\"color:#E1E4E8\">, state)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCircuitBreaker_HalfOpenFailureReopens</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewCircuitBreaker</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Millisecond, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"fail\"</span><span style=\"color:#E1E4E8\">) })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    time.</span><span style=\"color:#B392F0\">Sleep</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">150</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Millisecond)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"probe fail\"</span><span style=\"color:#E1E4E8\">) })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    state </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cb.state</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> state </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> StateOpen {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"state after failed probe: got </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\"> want OPEN\"</span><span style=\"color:#E1E4E8\">, state)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCircuitBreaker_SuccessResetFailureCount</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewCircuitBreaker</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    fail </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"fail\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), fail)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), fail) </span><span style=\"color:#6A737D\">// 2 failures</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> }) </span><span style=\"color:#6A737D\">// success — reset</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    failures </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cb.failures</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> failures </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"failures after success: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 0\"</span><span style=\"color:#E1E4E8\">, failures)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCircuitBreaker_ConcurrentSafe</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewCircuitBreaker</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">100</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> wg </span><span style=\"color:#B392F0\">sync</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">WaitGroup</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 100</span><span style=\"color:#E1E4E8\">; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        wg.</span><span style=\"color:#B392F0\">Add</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        go</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            defer</span><span style=\"color:#E1E4E8\"> wg.</span><span style=\"color:#B392F0\">Done</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        }()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    wg.</span><span style=\"color:#B392F0\">Wait</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#6A737D\">// must not race-detect or panic</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestCircuitBreaker_FailureWindowReset</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Failures in window 1 do not carry over to window 2</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewCircuitBreaker</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second, </span><span style=\"color:#79B8FF\">100</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Millisecond)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    fail </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"fail\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), fail)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), fail) </span><span style=\"color:#6A737D\">// 2 failures in window 1</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    time.</span><span style=\"color:#B392F0\">Sleep</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">150</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Millisecond) </span><span style=\"color:#6A737D\">// window expires</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), fail) </span><span style=\"color:#6A737D\">// 1 failure in window 2</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.mu.</span><span style=\"color:#B392F0\">Lock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    state </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cb.state</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    failures </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> cb.failures</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.mu.</span><span style=\"color:#B392F0\">Unlock</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> state </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> StateClosed {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"should still be CLOSED (only 1 failure in new window): got </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, state)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> failures </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"failures in new window: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 1\"</span><span style=\"color:#E1E4E8\">, failures)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"82-rate-limiter-unit-tests\">8.2 Rate Limiter Unit Tests</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRateLimiter_AllowsUnderLimit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mr </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> miniredis.</span><span style=\"color:#B392F0\">RunT</span><span style=\"color:#E1E4E8\">(t)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> redis.</span><span style=\"color:#B392F0\">NewClient</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Options</span><span style=\"color:#E1E4E8\">{Addr: mr.</span><span style=\"color:#B392F0\">Addr</span><span style=\"color:#E1E4E8\">()})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rl </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewRateLimiter</span><span style=\"color:#E1E4E8\">(client, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 10</span><span style=\"color:#E1E4E8\">; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        allowed, _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> rl.</span><span style=\"color:#B392F0\">Allow</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"test:127.0.0.1\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">60</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Allow error: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">allowed { t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"request </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> should be allowed\"</span><span style=\"color:#E1E4E8\">, i</span><span style=\"color:#F97583\">+</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRateLimiter_BlocksAtLimit</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mr </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> miniredis.</span><span style=\"color:#B392F0\">RunT</span><span style=\"color:#E1E4E8\">(t)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> redis.</span><span style=\"color:#B392F0\">NewClient</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Options</span><span style=\"color:#E1E4E8\">{Addr: mr.</span><span style=\"color:#B392F0\">Addr</span><span style=\"color:#E1E4E8\">()})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rl </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewRateLimiter</span><span style=\"color:#E1E4E8\">(client, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 10</span><span style=\"color:#E1E4E8\">; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        rl.</span><span style=\"color:#B392F0\">Allow</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"shorten:127.0.0.1\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">60</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    allowed, retryAfter, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> rl.</span><span style=\"color:#B392F0\">Allow</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"shorten:127.0.0.1\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">60</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"Allow error: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, err) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> allowed { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"11th request should be blocked\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> retryAfter </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 60</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"retryAfter: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 60\"</span><span style=\"color:#E1E4E8\">, retryAfter) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRateLimiter_KeyHasTTL</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mr </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> miniredis.</span><span style=\"color:#B392F0\">RunT</span><span style=\"color:#E1E4E8\">(t)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> redis.</span><span style=\"color:#B392F0\">NewClient</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Options</span><span style=\"color:#E1E4E8\">{Addr: mr.</span><span style=\"color:#B392F0\">Addr</span><span style=\"color:#E1E4E8\">()})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rl </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewRateLimiter</span><span style=\"color:#E1E4E8\">(client, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rl.</span><span style=\"color:#B392F0\">Allow</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"shorten:10.0.0.1\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">60</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ttl </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> mr.</span><span style=\"color:#B392F0\">TTL</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"rl:shorten:10.0.0.1\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> ttl </span><span style=\"color:#F97583\">&#x3C;=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"rate limit key must have a positive TTL\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> ttl </span><span style=\"color:#F97583\">></span><span style=\"color:#79B8FF\"> 60</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second { t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"TTL too long: </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, ttl) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRateLimiter_WindowResets</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mr </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> miniredis.</span><span style=\"color:#B392F0\">RunT</span><span style=\"color:#E1E4E8\">(t)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> redis.</span><span style=\"color:#B392F0\">NewClient</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Options</span><span style=\"color:#E1E4E8\">{Addr: mr.</span><span style=\"color:#B392F0\">Addr</span><span style=\"color:#E1E4E8\">()})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rl </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewRateLimiter</span><span style=\"color:#E1E4E8\">(client, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 10</span><span style=\"color:#E1E4E8\">; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        rl.</span><span style=\"color:#B392F0\">Allow</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"shorten:1.1.1.1\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mr.</span><span style=\"color:#B392F0\">FastForward</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#F97583\"> *</span><span style=\"color:#E1E4E8\"> time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    allowed, _, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> rl.</span><span style=\"color:#B392F0\">Allow</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"shorten:1.1.1.1\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">allowed { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"request after window reset should be allowed\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRateLimiter_FailOpenOnRedisError</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Unreachable Redis → Allow returns true (fail-open)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> redis.</span><span style=\"color:#B392F0\">NewClient</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Options</span><span style=\"color:#E1E4E8\">{Addr: </span><span style=\"color:#9ECBFF\">\"localhost:1\"</span><span style=\"color:#E1E4E8\">})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rl </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewRateLimiter</span><span style=\"color:#E1E4E8\">(client, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    allowed, _, err </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> rl.</span><span style=\"color:#B392F0\">Allow</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"test:1.2.3.4\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">60</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">allowed { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"should fail-open when Redis unreachable\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> err </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"err should be non-nil for infrastructure failure\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRateLimiter_DifferentIPsIndependent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    mr </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> miniredis.</span><span style=\"color:#B392F0\">RunT</span><span style=\"color:#E1E4E8\">(t)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> redis.</span><span style=\"color:#B392F0\">NewClient</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">redis</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Options</span><span style=\"color:#E1E4E8\">{Addr: mr.</span><span style=\"color:#B392F0\">Addr</span><span style=\"color:#E1E4E8\">()})</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rl </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewRateLimiter</span><span style=\"color:#E1E4E8\">(client, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Exhaust limit for IP1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#79B8FF\"> 10</span><span style=\"color:#E1E4E8\">; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        rl.</span><span style=\"color:#B392F0\">Allow</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"shorten:192.168.1.1\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">60</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // IP2 should still be allowed</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    allowed, _, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> rl.</span><span style=\"color:#B392F0\">Allow</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#9ECBFF\">\"shorten:192.168.1.2\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">60</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#F97583\"> !</span><span style=\"color:#E1E4E8\">allowed { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"different IP should not be rate limited\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"83-router-unit-tests\">8.3 Router Unit Tests</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRouter_MatchesCorrectRoute</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cases </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">struct</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        method   </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        path     </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        wantUpstream </span><span style=\"color:#F97583\">string</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        wantAuth </span><span style=\"color:#F97583\">bool</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"POST\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/api/auth/register\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"user-service\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"POST\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/api/auth/login\"</span><span style=\"color:#E1E4E8\">,    </span><span style=\"color:#9ECBFF\">\"user-service\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"POST\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/api/shorten\"</span><span style=\"color:#E1E4E8\">,       </span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#9ECBFF\">\"/api/urls\"</span><span style=\"color:#E1E4E8\">,          </span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#9ECBFF\">\"/r/abc1234\"</span><span style=\"color:#E1E4E8\">,         </span><span style=\"color:#9ECBFF\">\"url-service\"</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#9ECBFF\">\"/api/stats/abc1234\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"analytics-service\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">false</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        {</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">,  </span><span style=\"color:#9ECBFF\">\"/api/notifications\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"notification-service\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">true</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    gw </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">Gateway</span><span style=\"color:#E1E4E8\">{routes: routingTable, log: slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">()}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, tc </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> cases {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Run</span><span style=\"color:#E1E4E8\">(tc.method</span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\">\" \"</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">tc.path, </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            matched </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> gw.</span><span style=\"color:#B392F0\">matchRoute</span><span style=\"color:#E1E4E8\">(tc.method, tc.path)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> matched </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                t.</span><span style=\"color:#B392F0\">Fatal</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"no route matched\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> matched.Upstream </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> tc.wantUpstream {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"upstream: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\"> want </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, matched.Upstream, tc.wantUpstream)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> matched.RequiresAuth </span><span style=\"color:#F97583\">!=</span><span style=\"color:#E1E4E8\"> tc.wantAuth {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"auth: got </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\"> want </span><span style=\"color:#79B8FF\">%v</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, matched.RequiresAuth, tc.wantAuth)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRouter_NoMatchReturns404</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/nonexistent/path\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    gw </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> buildTestGateway</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    gw.</span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 404</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"unknown path: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 404\"</span><span style=\"color:#E1E4E8\">, rec.Code)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestRouter_JWTRequired_Returns401WithoutToken</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/api/urls\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    gw </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> buildTestGateway</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    gw.</span><span style=\"color:#B392F0\">ServeHTTP</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 401</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"protected route without JWT: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 401\"</span><span style=\"color:#E1E4E8\">, rec.Code)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"84-notification-consumer-unit-tests\">8.4 Notification Consumer Unit Tests</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestNotificationConsumer_URLCreatedEvent</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Build URLCreatedEvent JSON</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    evt </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URLCreatedEvent</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        BaseEvent: </span><span style=\"color:#B392F0\">events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">BaseEvent</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            EventType:     </span><span style=\"color:#9ECBFF\">\"url.created\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            OccurredAt:    time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">UTC</span><span style=\"color:#E1E4E8\">(),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            EventID:       </span><span style=\"color:#9ECBFF\">\"test-evt-001\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            CorrelationID: </span><span style=\"color:#9ECBFF\">\"corr-123\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ShortCode:   </span><span style=\"color:#9ECBFF\">\"abc1234\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        OriginalURL: </span><span style=\"color:#9ECBFF\">\"https://example.com\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        UserID:      </span><span style=\"color:#9ECBFF\">\"user-uuid-001\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        UserEmail:   </span><span style=\"color:#9ECBFF\">\"user@example.com\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    body, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Marshal</span><span style=\"color:#E1E4E8\">(evt)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    inserted </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> make</span><span style=\"color:#E1E4E8\">([]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockNotificationStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        insertFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">ctx</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">rec</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            inserted </span><span style=\"color:#F97583\">=</span><span style=\"color:#B392F0\"> append</span><span style=\"color:#E1E4E8\">(inserted, rec)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            rec.ID </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"notif-uuid-001\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#E1E4E8\"> rec, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    consumer </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">NotificationConsumer</span><span style=\"color:#E1E4E8\">{store: store, log: slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">()}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    d </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Delivery</span><span style=\"color:#E1E4E8\">{RoutingKey: </span><span style=\"color:#9ECBFF\">\"url.created\"</span><span style=\"color:#E1E4E8\">, Body: body}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    consumer.</span><span style=\"color:#B392F0\">processDelivery</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), d)  </span><span style=\"color:#6A737D\">// NOTE: test version that doesn't call d.Ack</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(inserted) </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected 1 insert, got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(inserted))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> inserted[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">].UserID </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"user-uuid-001\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"user_id: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, inserted[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">].UserID)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> inserted[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">].EventType </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"url.created\"</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"event_type: got </span><span style=\"color:#79B8FF\">%q</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, inserted[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">].EventType)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestNotificationConsumer_MalformedJSON_DoesNotInsert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    insertCalled </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> false</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockNotificationStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        insertFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            insertCalled </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> true</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    consumer </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">NotificationConsumer</span><span style=\"color:#E1E4E8\">{store: store, log: slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">()}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    d </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Delivery</span><span style=\"color:#E1E4E8\">{RoutingKey: </span><span style=\"color:#9ECBFF\">\"url.created\"</span><span style=\"color:#E1E4E8\">, Body: []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"not json\"</span><span style=\"color:#E1E4E8\">)}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    consumer.</span><span style=\"color:#B392F0\">processDelivery</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), d)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> insertCalled {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"insert should NOT be called for malformed JSON\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestNotificationConsumer_MissingUserID_DoesNotInsert</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // URLCreatedEvent with UserID = \"\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    evt </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">URLCreatedEvent</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        BaseEvent: </span><span style=\"color:#B392F0\">events</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">BaseEvent</span><span style=\"color:#E1E4E8\">{EventType: </span><span style=\"color:#9ECBFF\">\"url.created\"</span><span style=\"color:#E1E4E8\">, EventID: </span><span style=\"color:#9ECBFF\">\"x\"</span><span style=\"color:#E1E4E8\">},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        UserID:    </span><span style=\"color:#9ECBFF\">\"\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#6A737D\">// missing</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    body, _ </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> json.</span><span style=\"color:#B392F0\">Marshal</span><span style=\"color:#E1E4E8\">(evt)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    insertCalled </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> false</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockNotificationStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        insertFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            insertCalled </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> true</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    consumer </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">NotificationConsumer</span><span style=\"color:#E1E4E8\">{store: store, log: slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">()}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    consumer.</span><span style=\"color:#B392F0\">processDelivery</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#B392F0\">amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Delivery</span><span style=\"color:#E1E4E8\">{RoutingKey: </span><span style=\"color:#9ECBFF\">\"url.created\"</span><span style=\"color:#E1E4E8\">, Body: body})</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> insertCalled { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"insert must not be called when user_id is empty\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestNotificationConsumer_UnknownRoutingKey_Acked</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Routing key not in {url.created, url.deleted, milestone.reached}</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Must Ack (not Nack) and not insert</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    insertCalled </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> false</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockNotificationStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        insertFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">) (</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            insertCalled </span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\"> true</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    consumer </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">NotificationConsumer</span><span style=\"color:#E1E4E8\">{store: store, log: slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">()}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    consumer.</span><span style=\"color:#B392F0\">processDelivery</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#B392F0\">amqp</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Delivery</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        RoutingKey: </span><span style=\"color:#9ECBFF\">\"unknown.key\"</span><span style=\"color:#E1E4E8\">, Body: []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`{}`</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    })</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> insertCalled { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"unknown routing key must not trigger insert\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"85-notificationhandler-unit-tests\">8.5 <code>NotificationHandler</code> Unit Tests</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestListNotifications_EmptyList</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockNotificationStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        findByUserIDFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">{}, </span><span style=\"color:#9ECBFF\">\"\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewNotificationHandler</span><span style=\"color:#E1E4E8\">(store, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    claims </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Claims</span><span style=\"color:#E1E4E8\">{Sub: </span><span style=\"color:#9ECBFF\">\"user-uuid\"</span><span style=\"color:#E1E4E8\">, Email: </span><span style=\"color:#9ECBFF\">\"u@e.com\"</span><span style=\"color:#E1E4E8\">, Iss: </span><span style=\"color:#9ECBFF\">\"url-shortener\"</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ctx </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithValue</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#B392F0\">auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">TestClaimsKey</span><span style=\"color:#E1E4E8\">{}, claims)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/notifications\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">).</span><span style=\"color:#B392F0\">WithContext</span><span style=\"color:#E1E4E8\">(ctx)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h.</span><span style=\"color:#B392F0\">ListNotifications</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 200</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, rec.Code) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> resp </span><span style=\"color:#B392F0\">notificationListResponse</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">(rec.Body.</span><span style=\"color:#B392F0\">Bytes</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">resp)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> resp.Notifications </span><span style=\"color:#F97583\">==</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"notifications must be [] not null\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(resp.Notifications) </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected 0, got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#B392F0\">len</span><span style=\"color:#E1E4E8\">(resp.Notifications)) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> resp.NextCursor </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"next_cursor should be null\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestListNotifications_WithResults</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    createdAt </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> time.</span><span style=\"color:#B392F0\">Now</span><span style=\"color:#E1E4E8\">().</span><span style=\"color:#B392F0\">UTC</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    store </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">mockNotificationStore</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        findByUserIDFn: </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">_</span><span style=\"color:#B392F0\"> context</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Context</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">_</span><span style=\"color:#F97583\"> int</span><span style=\"color:#E1E4E8\">) ([]</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            return</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">*</span><span style=\"color:#B392F0\">NotificationRecord</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    ID:        </span><span style=\"color:#9ECBFF\">\"notif-001\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    UserID:    </span><span style=\"color:#9ECBFF\">\"user-uuid\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    EventType: </span><span style=\"color:#9ECBFF\">\"url.created\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    Payload:   []</span><span style=\"color:#F97583\">byte</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">`{\"short_code\":\"abc\"}`</span><span style=\"color:#E1E4E8\">),</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    Status:    </span><span style=\"color:#9ECBFF\">\"sent\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    CreatedAt: createdAt,</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }, </span><span style=\"color:#9ECBFF\">\"\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewNotificationHandler</span><span style=\"color:#E1E4E8\">(store, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    claims </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Claims</span><span style=\"color:#E1E4E8\">{Sub: </span><span style=\"color:#9ECBFF\">\"user-uuid\"</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    ctx </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithValue</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#B392F0\">auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">TestClaimsKey</span><span style=\"color:#E1E4E8\">{}, claims)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/notifications\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">).</span><span style=\"color:#B392F0\">WithContext</span><span style=\"color:#E1E4E8\">(ctx)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    h.</span><span style=\"color:#B392F0\">ListNotifications</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    var</span><span style=\"color:#E1E4E8\"> resp </span><span style=\"color:#B392F0\">notificationListResponse</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    json.</span><span style=\"color:#B392F0\">Unmarshal</span><span style=\"color:#E1E4E8\">(rec.Body.</span><span style=\"color:#B392F0\">Bytes</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#E1E4E8\">resp)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#B392F0\"> len</span><span style=\"color:#E1E4E8\">(resp.Notifications) </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Fatalf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"expected 1 notification\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> resp.Notifications[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">].ID </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"notif-001\"</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"id mismatch\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#E1E4E8\"> resp.Notifications[</span><span style=\"color:#79B8FF\">0</span><span style=\"color:#E1E4E8\">].EventType </span><span style=\"color:#F97583\">!=</span><span style=\"color:#9ECBFF\"> \"url.created\"</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Error</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"event_type mismatch\"</span><span style=\"color:#E1E4E8\">) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> TestListNotifications_InvalidLimitParam</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> _, bad </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> range</span><span style=\"color:#E1E4E8\"> []</span><span style=\"color:#F97583\">string</span><span style=\"color:#E1E4E8\">{</span><span style=\"color:#9ECBFF\">\"abc\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"0\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"51\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"-1\"</span><span style=\"color:#E1E4E8\">} {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        t.</span><span style=\"color:#B392F0\">Run</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"limit=\"</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">bad, </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">t</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">T</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            h </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewNotificationHandler</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">&#x26;</span><span style=\"color:#B392F0\">mockNotificationStore</span><span style=\"color:#E1E4E8\">{}, slog.</span><span style=\"color:#B392F0\">Default</span><span style=\"color:#E1E4E8\">())</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            claims </span><span style=\"color:#F97583\">:=</span><span style=\"color:#F97583\"> &#x26;</span><span style=\"color:#B392F0\">auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">Claims</span><span style=\"color:#E1E4E8\">{Sub: </span><span style=\"color:#9ECBFF\">\"uid\"</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            ctx </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> context.</span><span style=\"color:#B392F0\">WithValue</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#B392F0\">auth</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">TestClaimsKey</span><span style=\"color:#E1E4E8\">{}, claims)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            req </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRequest</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"GET\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"/notifications?limit=\"</span><span style=\"color:#F97583\">+</span><span style=\"color:#E1E4E8\">bad, </span><span style=\"color:#79B8FF\">nil</span><span style=\"color:#E1E4E8\">).</span><span style=\"color:#B392F0\">WithContext</span><span style=\"color:#E1E4E8\">(ctx)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            rec </span><span style=\"color:#F97583\">:=</span><span style=\"color:#E1E4E8\"> httptest.</span><span style=\"color:#B392F0\">NewRecorder</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            h.</span><span style=\"color:#B392F0\">ListNotifications</span><span style=\"color:#E1E4E8\">(rec, req)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            if</span><span style=\"color:#E1E4E8\"> rec.Code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 400</span><span style=\"color:#E1E4E8\"> { t.</span><span style=\"color:#B392F0\">Errorf</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"limit=</span><span style=\"color:#79B8FF\">%s</span><span style=\"color:#9ECBFF\">: got </span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\"> want 400\"</span><span style=\"color:#E1E4E8\">, bad, rec.Code) }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<h3 id=\"86-end-to-end-integration-test-script-scriptse2e_testsh\">8.6 End-to-End Integration Test Script (<code>scripts/e2e_test.sh</code>)</h3>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">bash</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#6A737D\">#!/usr/bin/env bash</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\"># scripts/e2e_test.sh — full end-to-end test through gateway</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">set</span><span style=\"color:#79B8FF\"> -e</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">BASE</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"http://localhost:8080\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">EMAIL</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"e2e+$(</span><span style=\"color:#B392F0\">date</span><span style=\"color:#9ECBFF\"> +%s)@example.com\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">PASSWORD</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"e2epassword123\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"=== 1. Register ===\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">REG</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -sf</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$BASE</span><span style=\"color:#9ECBFF\">/api/auth/register\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> \"{</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">email</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#E1E4E8\">$EMAIL</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">,</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">password</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#E1E4E8\">$PASSWORD</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">}\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">USER_ID</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$REG</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> python3</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"import sys,json; print(json.load(sys.stdin)['user_id'])\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"PASS: registered user_id=</span><span style=\"color:#E1E4E8\">$USER_ID</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"=== 2. Login ===\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">LOGIN</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -sf</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$BASE</span><span style=\"color:#9ECBFF\">/api/auth/login\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> \"{</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">email</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#E1E4E8\">$EMAIL</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">,</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">password</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#E1E4E8\">$PASSWORD</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">}\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">TOKEN</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$LOGIN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> python3</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"import sys,json; print(json.load(sys.stdin)['token'])\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"PASS: token obtained\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"=== 3. Shorten URL ===\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">SHORTEN</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -sf</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$BASE</span><span style=\"color:#9ECBFF\">/api/shorten\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://example.com/very/long/path\"}'</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">SHORT_CODE</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$SHORTEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> python3</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"import sys,json; print(json.load(sys.stdin)['short_code'])\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"PASS: short_code=</span><span style=\"color:#E1E4E8\">$SHORT_CODE</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"=== 4. Redirect ===\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">REDIRECT_STATUS</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -so</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#9ECBFF\"> \"http://localhost:8080/r/</span><span style=\"color:#E1E4E8\">$SHORT_CODE</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">if</span><span style=\"color:#E1E4E8\"> [ </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">$REDIRECT_STATUS</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> !=</span><span style=\"color:#9ECBFF\"> \"301\"</span><span style=\"color:#E1E4E8\"> ]; </span><span style=\"color:#F97583\">then</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  echo</span><span style=\"color:#9ECBFF\"> \"FAIL: redirect returned </span><span style=\"color:#E1E4E8\">$REDIRECT_STATUS</span><span style=\"color:#9ECBFF\">, want 301\"</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#79B8FF\">exit</span><span style=\"color:#79B8FF\"> 1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fi</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"PASS: redirect returned 301\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"=== 5. Check stats (wait 3s for outbox) ===\"</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 3</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">STATS</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -sf</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$BASE</span><span style=\"color:#9ECBFF\">/api/stats/</span><span style=\"color:#E1E4E8\">$SHORT_CODE</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">TOTAL</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$STATS</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> python3</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"import sys,json; print(json.load(sys.stdin)['total_clicks'])\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">if</span><span style=\"color:#E1E4E8\"> [ </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">$TOTAL</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> -lt</span><span style=\"color:#9ECBFF\"> \"1\"</span><span style=\"color:#E1E4E8\"> ]; </span><span style=\"color:#F97583\">then</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  echo</span><span style=\"color:#9ECBFF\"> \"FAIL: total_clicks=</span><span style=\"color:#E1E4E8\">$TOTAL</span><span style=\"color:#9ECBFF\">, expected >= 1\"</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#79B8FF\">exit</span><span style=\"color:#79B8FF\"> 1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fi</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"PASS: total_clicks=</span><span style=\"color:#E1E4E8\">$TOTAL</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"=== 6. Check notifications (wait 2s) ===\"</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 2</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">NOTIFS</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -sf</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$BASE</span><span style=\"color:#9ECBFF\">/api/notifications\"</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">COUNT</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$NOTIFS</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> python3</span><span style=\"color:#79B8FF\"> -c</span><span style=\"color:#9ECBFF\"> \"import sys,json; print(len(json.load(sys.stdin)['notifications']))\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">if</span><span style=\"color:#E1E4E8\"> [ </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">$COUNT</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> -lt</span><span style=\"color:#9ECBFF\"> \"1\"</span><span style=\"color:#E1E4E8\"> ]; </span><span style=\"color:#F97583\">then</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  echo</span><span style=\"color:#9ECBFF\"> \"FAIL: notifications count=</span><span style=\"color:#E1E4E8\">$COUNT</span><span style=\"color:#9ECBFF\">, expected >= 1\"</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#79B8FF\">exit</span><span style=\"color:#79B8FF\"> 1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fi</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"PASS: notifications count=</span><span style=\"color:#E1E4E8\">$COUNT</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"=== 7. Rate limit test (11 POST /api/shorten) ===\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> $(</span><span style=\"color:#B392F0\">seq</span><span style=\"color:#79B8FF\"> 1</span><span style=\"color:#79B8FF\"> 10</span><span style=\"color:#E1E4E8\">); </span><span style=\"color:#F97583\">do</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">  curl</span><span style=\"color:#79B8FF\"> -s</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$BASE</span><span style=\"color:#9ECBFF\">/api/shorten\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">    -d</span><span style=\"color:#9ECBFF\"> \"{</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">url</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">https://example.com/</span><span style=\"color:#E1E4E8\">$i</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">}\"</span><span style=\"color:#F97583\"> ></span><span style=\"color:#9ECBFF\"> /dev/null</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">done</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">ELEVENTH</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -so</span><span style=\"color:#9ECBFF\"> /dev/null</span><span style=\"color:#79B8FF\"> -w</span><span style=\"color:#9ECBFF\"> \"%{http_code}\"</span><span style=\"color:#79B8FF\"> -X</span><span style=\"color:#9ECBFF\"> POST</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$BASE</span><span style=\"color:#9ECBFF\">/api/shorten\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Content-Type: application/json\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -H</span><span style=\"color:#9ECBFF\"> \"Authorization: Bearer </span><span style=\"color:#E1E4E8\">$TOKEN</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> \\</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  -d</span><span style=\"color:#9ECBFF\"> '{\"url\":\"https://example.com/overflow\"}'</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">if</span><span style=\"color:#E1E4E8\"> [ </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">$ELEVENTH</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> !=</span><span style=\"color:#9ECBFF\"> \"429\"</span><span style=\"color:#E1E4E8\"> ]; </span><span style=\"color:#F97583\">then</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  echo</span><span style=\"color:#9ECBFF\"> \"FAIL: 11th shorten request returned </span><span style=\"color:#E1E4E8\">$ELEVENTH</span><span style=\"color:#9ECBFF\">, want 429\"</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#79B8FF\">exit</span><span style=\"color:#79B8FF\"> 1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fi</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"PASS: 11th request returned 429\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"=== 8. Correlation ID propagation ===\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">CORR_ID</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"test-corr-$(</span><span style=\"color:#B392F0\">date</span><span style=\"color:#9ECBFF\"> +%s)\"</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">curl</span><span style=\"color:#79B8FF\"> -sf</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$BASE</span><span style=\"color:#9ECBFF\">/api/stats/</span><span style=\"color:#E1E4E8\">$SHORT_CODE</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\"> -H</span><span style=\"color:#9ECBFF\"> \"X-Correlation-ID: </span><span style=\"color:#E1E4E8\">$CORR_ID</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> ></span><span style=\"color:#9ECBFF\"> /dev/null</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">sleep</span><span style=\"color:#79B8FF\"> 1</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">GW_LOG</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> logs</span><span style=\"color:#9ECBFF\"> gateway</span><span style=\"color:#F97583\"> 2></span><span style=\"color:#9ECBFF\">/dev/null</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$CORR_ID</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> wc</span><span style=\"color:#79B8FF\"> -l</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">ANALYTICS_LOG</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">$(</span><span style=\"color:#B392F0\">docker</span><span style=\"color:#9ECBFF\"> compose</span><span style=\"color:#9ECBFF\"> logs</span><span style=\"color:#9ECBFF\"> analytics-service</span><span style=\"color:#F97583\"> 2></span><span style=\"color:#9ECBFF\">/dev/null</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> grep</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#E1E4E8\">$CORR_ID</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> |</span><span style=\"color:#B392F0\"> wc</span><span style=\"color:#79B8FF\"> -l</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">if</span><span style=\"color:#E1E4E8\"> [ </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">$GW_LOG</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> -eq</span><span style=\"color:#9ECBFF\"> \"0\"</span><span style=\"color:#E1E4E8\"> ]; </span><span style=\"color:#F97583\">then</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  echo</span><span style=\"color:#9ECBFF\"> \"FAIL: correlation_id </span><span style=\"color:#E1E4E8\">$CORR_ID</span><span style=\"color:#9ECBFF\"> not found in gateway logs\"</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#79B8FF\">exit</span><span style=\"color:#79B8FF\"> 1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fi</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">if</span><span style=\"color:#E1E4E8\"> [ </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">$ANALYTICS_LOG</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> -eq</span><span style=\"color:#9ECBFF\"> \"0\"</span><span style=\"color:#E1E4E8\"> ]; </span><span style=\"color:#F97583\">then</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">  echo</span><span style=\"color:#9ECBFF\"> \"FAIL: correlation_id </span><span style=\"color:#E1E4E8\">$CORR_ID</span><span style=\"color:#9ECBFF\"> not found in analytics-service logs\"</span><span style=\"color:#E1E4E8\">; </span><span style=\"color:#79B8FF\">exit</span><span style=\"color:#79B8FF\"> 1</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">fi</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"PASS: correlation_id propagated to gateway and analytics-service logs\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">echo</span><span style=\"color:#9ECBFF\"> \"All end-to-end tests PASSED.\"</span></span></code></pre></div>\n\n<hr>\n<h2 id=\"9-performance-targets\">9. Performance Targets</h2>\n<table>\n<thead>\n<tr>\n<th>Operation</th>\n<th>Target</th>\n<th>How to Measure</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Gateway overhead (JWT verify + rate limit Redis check + proxy)</td>\n<td>&lt; 5ms added latency p99</td>\n<td>Compare <code>wrk</code> p99 direct to url-service vs through gateway on <code>GET /r/&lt;code&gt;</code></td>\n</tr>\n<tr>\n<td>Circuit breaker state read (CLOSED → allow)</td>\n<td>&lt; 1µs</td>\n<td><code>go test -bench=BenchmarkCBClosed -benchtime=10s ./gateway/</code></td>\n</tr>\n<tr>\n<td>Circuit breaker reject (OPEN → 503)</td>\n<td>&lt; 100µs</td>\n<td><code>go test -bench=BenchmarkCBOpen -benchtime=10s ./gateway/</code></td>\n</tr>\n<tr>\n<td>Rate limit check (<code>INCR</code> + conditional <code>EXPIRE</code>)</td>\n<td>&lt; 2ms p99</td>\n<td><code>wrk -t1 -c1 -d10s</code> against gateway shorten route; compare Redis latency via <code>redis-cli --latency</code></td>\n</tr>\n<tr>\n<td><code>GET /notifications</code> (DB query, 20 rows)</td>\n<td>&lt; 20ms p99</td>\n<td><code>wrk -t4 -c20 -d30s</code> with valid Bearer token via Lua script</td>\n</tr>\n<tr>\n<td>End-to-end register→shorten→redirect→stats through gateway</td>\n<td>&lt; 100ms p99</td>\n<td>Shell script with <code>curl --trace-time</code> measuring each step</td>\n</tr>\n<tr>\n<td>11th rate-limited request (429, no upstream call)</td>\n<td>&lt; 2ms</td>\n<td><code>curl -o /dev/null -w &quot;%{time_total}&quot;</code> on the 11th request</td>\n</tr>\n<tr>\n<td>503 circuit-open response (no upstream call)</td>\n<td>&lt; 1ms</td>\n<td>Same measurement approach</td>\n</tr>\n<tr>\n<td>Notification consumer message processing</td>\n<td>&lt; 30ms p99</td>\n<td>Log <code>duration_ms</code> in <code>processDelivery</code>, check after 1000 messages</td>\n</tr>\n<tr>\n<td>Gateway startup to HTTP ready</td>\n<td>&lt; 5s after all upstreams healthy</td>\n<td>Docker healthcheck pass time in <code>docker compose ps</code></td>\n</tr>\n</tbody></table>\n<p><strong>Circuit breaker benchmarks:</strong></p>\n<div class=\"code-block-wrapper\"><span class=\"code-lang\">go</span><pre class=\"arch-pre shiki-highlighted\"><code><span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkCircuitBreakerClosed</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewCircuitBreaker</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">5</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b.</span><span style=\"color:#B392F0\">ResetTimer</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#E1E4E8\"> b.N; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expected: ~200-500 ns/op (mutex acquire + single function call)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">func</span><span style=\"color:#B392F0\"> BenchmarkCircuitBreakerOpen</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#FFAB70\">b</span><span style=\"color:#F97583\"> *</span><span style=\"color:#B392F0\">testing</span><span style=\"color:#E1E4E8\">.</span><span style=\"color:#B392F0\">B</span><span style=\"color:#E1E4E8\">) {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb </span><span style=\"color:#F97583\">:=</span><span style=\"color:#B392F0\"> NewCircuitBreaker</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#79B8FF\">1</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#79B8FF\">30</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second, </span><span style=\"color:#79B8FF\">10</span><span style=\"color:#F97583\">*</span><span style=\"color:#E1E4E8\">time.Second)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#E1E4E8\"> errors.</span><span style=\"color:#B392F0\">New</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"trip\"</span><span style=\"color:#E1E4E8\">) })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    b.</span><span style=\"color:#B392F0\">ResetTimer</span><span style=\"color:#E1E4E8\">()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    for</span><span style=\"color:#E1E4E8\"> i </span><span style=\"color:#F97583\">:=</span><span style=\"color:#79B8FF\"> 0</span><span style=\"color:#E1E4E8\">; i </span><span style=\"color:#F97583\">&#x3C;</span><span style=\"color:#E1E4E8\"> b.N; i</span><span style=\"color:#F97583\">++</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        cb.</span><span style=\"color:#B392F0\">Do</span><span style=\"color:#E1E4E8\">(context.</span><span style=\"color:#B392F0\">Background</span><span style=\"color:#E1E4E8\">(), </span><span style=\"color:#F97583\">func</span><span style=\"color:#E1E4E8\">() </span><span style=\"color:#F97583\">error</span><span style=\"color:#E1E4E8\"> { </span><span style=\"color:#F97583\">return</span><span style=\"color:#79B8FF\"> nil</span><span style=\"color:#E1E4E8\"> })</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#6A737D\">    // Expected: ~100-200 ns/op (mutex acquire + state check + return ErrCircuitOpen)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">}</span></span></code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-33.svg\" alt=\"Structured JSON Log Schema\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Latency budget for GET /r/{code} through gateway (cache hit path):\n  ┌──────────────────────────────────────────────────────────────┐\n  │ Network recv + HTTP parse:                  ~0.1ms           │\n  │ CorrelationIDMiddleware (UUID gen if absent):&lt; 0.1ms         │\n  │ RequestLogger start:                         &lt; 0.01ms        │\n  │ Router.matchRoute (linear scan, 8 entries):  &lt; 0.01ms        │\n  │ [No auth required for redirect route]                        │\n  │ RateLimiter.Allow (Redis INCR):              ~0.5-1ms        │ ← network to Redis\n  │ Set X-Correlation-ID on forwarded request:   &lt; 0.01ms        │\n  │ CircuitBreaker.Do (mutex acquire, CLOSED):   &lt; 0.001ms       │\n  │ httputil.ReverseProxy.ServeHTTP:             ~1-3ms          │ ← url-service cache hit\n  │ ResponseWriter capture status:               &lt; 0.01ms        │\n  │ RequestLogger log write:                     &lt; 0.1ms         │\n  │ Network send:                                ~0.1ms           │\n  │ TOTAL gateway overhead (above direct call):  ~1-2ms typical  │\n  │                                              &lt; 5ms p99 ✓    │\n  └──────────────────────────────────────────────────────────────┘</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-34.svg\" alt=\"Notification Service Module Architecture and Consumer Flow\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Rate limiter Redis key lifecycle:\n  Request 1 (t=0):\n    INCR &quot;rl:shorten:192.168.1.1&quot; → 1\n    EXPIRE &quot;rl:shorten:192.168.1.1&quot; 60\n    allowed=true\n  Requests 2-10 (t=1s to t=10s):\n    INCR → 2, 3, ..., 10\n    (EXPIRE not called; count==1 is false)\n    allowed=true\n  Request 11 (t=11s):\n    INCR → 11\n    11 &gt; 10 → allowed=false, retryAfter=60\n    Response: 429 + &quot;Retry-After: 60&quot;\n  t=60s: Redis key expires automatically\n  Request 12 (t=61s):\n    INCR &quot;rl:shorten:192.168.1.1&quot; → 1 (key re-created)\n    EXPIRE &quot;rl:shorten:192.168.1.1&quot; 60\n    allowed=true (new window)</code></pre></div>\n\n<h3 id=\"91-gomod-additions\">9.1 <code>go.mod</code> Additions</h3>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>// services/notification-service/go.mod\nmodule github.com/yourhandle/url-shortener/notification-service\ngo 1.23\nrequire (\n    github.com/yourhandle/url-shortener/shared/events v0.0.0\n    github.com/yourhandle/url-shortener/shared/logger v0.0.0\n    github.com/yourhandle/url-shortener/shared/auth   v0.0.0\n    github.com/jackc/pgx/v5 v5.6.0\n    github.com/rabbitmq/amqp091-go v1.10.0\n    github.com/golang-jwt/jwt/v5 v5.2.1\n)\nreplace (\n    github.com/yourhandle/url-shortener/shared/events =&gt; ../../shared/events\n    github.com/yourhandle/url-shortener/shared/logger =&gt; ../../shared/logger\n    github.com/yourhandle/url-shortener/shared/auth   =&gt; ../../shared/auth\n)\n// gateway/go.mod\nmodule github.com/yourhandle/url-shortener/gateway\ngo 1.23\nrequire (\n    github.com/yourhandle/url-shortener/shared/logger v0.0.0\n    github.com/yourhandle/url-shortener/shared/auth   v0.0.0\n    github.com/golang-jwt/jwt/v5 v5.2.1\n    github.com/redis/go-redis/v9 v9.6.0\n    github.com/alicebob/miniredis/v2 v2.32.0  // test only\n)\nreplace (\n    github.com/yourhandle/url-shortener/shared/logger =&gt; ../shared/logger\n    github.com/yourhandle/url-shortener/shared/auth   =&gt; ../shared/auth\n)</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-35.svg\" alt=\"Gateway Routing Table\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Correlation ID propagation across all five processes:\n  Client               Gateway              url-service        analytics-service\n    │                     │                      │                      │\n    ├─X-Corr-ID: abc-123──►                     │                      │\n    │                     ├─CorrelationIDMiddleware: stores &quot;abc-123&quot;   │\n    │                     ├─RequestLogger: logs {correlation_id:&quot;abc-123&quot;,...}\n    │                     ├─X-Corr-ID: abc-123──►                      │\n    │                     │                ├─CorrelationIDMiddleware    │\n    │                     │                ├─handler logs {correlation_id:&quot;abc-123&quot;}\n    │                     │                ├─INSERT outbox(correlation_id:&quot;abc-123&quot;)\n    │                     │                │                     │\n    │                     │          [outbox poll → AMQP publish]│\n    │                     │            URLClickedEvent.CorrelationID = &quot;abc-123&quot;\n    │                     │                                ├─consumer.processDelivery\n    │                     │                                ├─log {correlation_id:&quot;abc-123&quot;}\n    │                     │                                │\n  async boundary:         │\n    │                     │\n  URLCreatedEvent.CorrelationID = &quot;abc-123&quot; → notifications.events\n    │                                                notification-service\n    │                                                ├─processDelivery\n    │                                                ├─log {correlation_id:&quot;abc-123&quot;}</code></pre></div>\n\n<p><img src=\"/api/project/url-shortener/architecture-doc/asset?path=diagrams%2Ftdd-diag-36.svg\" alt=\"End-to-End Request Trace: Register → Shorten → Redirect → Stats → Notifications\"></p>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>Anti-pattern guard — gateway contains ZERO domain logic:\n  FORBIDDEN imports in gateway/:\n    github.com/yourhandle/url-shortener/shared/events  ← domain events\n    Any reference to &quot;short_code&quot;, &quot;URLRecord&quot;, &quot;clicks&quot;\n  ALLOWED imports in gateway/:\n    github.com/yourhandle/url-shortener/shared/auth   ← JWT verification\n    github.com/yourhandle/url-shortener/shared/logger ← structured logging\n    github.com/redis/go-redis/v9                       ← rate limiting\n    net/http, net/http/httputil                        ← proxy\n    sync, time, strings, context                       ← stdlib\n  Verification command:\n    grep -r &quot;shared/events\\|URLRecord\\|short_code\\|ClickRecord&quot; gateway/ \\\n      | grep -v &quot;_test.go&quot; &amp;&amp; echo &quot;FAIL: domain logic in gateway&quot; \\\n      || echo &quot;PASS: gateway is domain-free&quot;\n  Additional anti-pattern: notification service MUST NOT call other services\n    grep -r &quot;url-service\\|analytics-service\\|user-service\\|8081\\|8082\\|8083&quot; \\\n      services/notification-service/*.go | grep -v &quot;_test.go&quot; \\\n      &amp;&amp; echo &quot;FAIL: notification-service makes cross-service call&quot; \\\n      || echo &quot;PASS: notification-service self-contained&quot;</code></pre></div>\n\n<hr>\n<!-- END_TDD_MOD -->\n\n<h1 id=\"project-structure-url-shortener-microservices\">Project Structure: URL Shortener (Microservices)</h1>\n<h2 id=\"directory-tree\">Directory Tree</h2>\n<div class=\"code-block-wrapper\"><pre class=\"arch-pre shiki-highlighted\"><code>url-shortener/                                          # Monorepo root\n│\n├── go.work                                             # Go workspace (all modules) — M1\n│\n├── shared/\n│   ├── events/\n│   │   ├── go.mod                                      # module: shared/events — M1\n│   │   ├── events.go                                   # All domain event structs + routing key constants — M1\n│   │   └── events_test.go                              # JSON round-trip + constant tests — M1\n│   │\n│   ├── logger/\n│   │   ├── go.mod                                      # module: shared/logger — M1\n│   │   └── logger.go                                   # JSON logger + WithCorrelationID + RequestLogger middleware — M1, M5\n│   │\n│   └── auth/\n│       ├── go.mod                                      # module: shared/auth — M2\n│       ├── auth.go                                     # Claims struct, TokenIssuer interface, VerifyToken, ErrTokenInvalid — M2\n│       └── middleware.go                               # JWTMiddleware, ClaimsFromContext, claimsKey — M2\n│\n├── services/\n│   │\n│   ├── url-service/\n│   │   ├── go.mod                                      # module: url-service; requires shared/events, auth, logger, pgx, redis, amqp, jwt — M1–M3\n│   │   ├── main.go                                     # Startup sequence, route wiring, outbox coordinator start, graceful shutdown — M1–M3\n│   │   ├── config.go                                   # Config struct: DB/Redis/AMQP/JWT/ShortURLBase/Outbox fields, loadConfig() — M1–M3\n│   │   ├── db.go                                       # NewDBPool (pgxpool, 10s ping, MaxConns=10) — M1\n│   │   ├── redis.go                                    # NewRedisClient (non-fatal ping, always returns client) — M1\n│   │   ├── rabbitmq.go                                 # NewRabbitMQConn (retry+backoff), declareExchange — M1\n│   │   ├── health.go                                   # NewHealthHandler (pre-encoded JSON, no DB check) — M1\n│   │   ├── migration.sql                               # urls + outbox tables, all 4 indexes — M3\n│   │   ├── store.go                                    # URLRecord, URLRepository interface, pgxURLStore (Insert/FindByCode/FindByUserID/Deactivate) — M3\n│   │   ├── outbox_store.go                             # OutboxRecord, OutboxRepository interface, pgxOutboxStore (InsertWithURL/InsertEvent/FetchUnpublished/MarkPublished) — M3\n│   │   ├── base62.go                                   # base62Alphabet const, Encode(*big.Int), Decode() — M3\n│   │   ├── codegen.go                                  # ShortCodeGenerator, Generate() using crypto/rand — M3\n│   │   ├── cache.go                                    # CachedURL, RedisCache (Get/Set/Del, error-isolated, TTL logic) — M3\n│   │   ├── publisher.go                                # RabbitMQPublisher interface, amqpPublisher with sync.Mutex — M3\n│   │   ├── outbox.go                                   # OutboxCoordinator, 3-worker pool, Run(), poll(), runWorker(), graceful drain — M3\n│   │   ├── handler.go                                  # Handler struct; Shorten/Redirect/ListURLs/DeleteURL; CorrelationIDMiddleware; hashIP; newUUID — M3\n│   │   ├── validate.go                                 # validateURL (scheme + host check) — M3\n│   │   ├── errors.go                                   # ErrShortCodeConflict, ErrURLNotFound, ErrNotOwner; writeError, writeJSON, isPgUniqueViolation — M3\n│   │   ├── url_test.go                                 # Base62 round-trip, codegen, validateURL, handler unit tests (mock stores), RedisCache tests (miniredis), outbox worker tests — M3\n│   │   ├── bench_test.go                               # BenchmarkRedirectCacheHit, BenchmarkShortCodeGenerate — M3\n│   │   └── Dockerfile                                  # Multi-stage Go build, scratch final image, EXPOSE 8080 — M1\n│   │\n│   ├── analytics-service/\n│   │   ├── go.mod                                      # module: analytics-service; requires shared/events, logger, pgx, amqp, golang.org/x/sync — M1, M4\n│   │   ├── main.go                                     # Startup: DB→migrations→AMQP→queues→stores→consumer goroutine→HTTP — M1, M4\n│   │   ├── config.go                                   # Config: DATABASE_URL, RABBITMQ_URL, IPHashSalt, AMQPPrefetchCount=1 — M1, M4\n│   │   ├── db.go                                       # NewDBPool reused from M1 pattern — M1\n│   │   ├── rabbitmq.go                                 # NewRabbitMQConn + DeclareAnalyticsQueue (&quot;analytics.clicks&quot; + &quot;url.clicked&quot; binding) — M1\n│   │   ├── health.go                                   # NewHealthHandler (always 200, no consumer state) — M1\n│   │   ├── migration.sql                               # clicks + milestones + processed_events tables, 5 indexes — M4\n│   │   ├── store.go                                    # ClickRecord, MilestoneRecord, StatsResult; ClickRepository, MilestoneRepository, DeduplicationRepository interfaces + pgx impls — M4\n│   │   ├── consumer.go                                 # ClickConsumer, Run() (prefetch=1, manual ack), processDelivery() (dedup→click→milestone in one tx), panic recovery, newUUID — M4\n│   │   ├── milestone.go                                # MilestoneChecker, CheckAndPublish() (thresholds 10/100/1000, tx-scoped COUNT, ON CONFLICT DO NOTHING) — M4\n│   │   ├── publisher.go                                # AnalyticsPublisher interface, amqpAnalyticsPublisher.PublishMilestone() — M4\n│   │   ├── handler.go                                  # StatsHandler; Stats() (errgroup 4 concurrent queries); Timeline() (day/hour validation) — M4\n│   │   ├── errors.go                                   # writeError, writeJSON, truncate helpers — M4\n│   │   ├── haship.go                                   # hashIP(remoteAddr, salt) → SHA-256 hex; newUUID — M4\n│   │   ├── analytics_test.go                           # MilestoneChecker unit tests (mock stores), consumer idempotency test, StatsHandler tests (mock), integration tests — M4\n│   │   └── Dockerfile                                  # Multi-stage Go build, scratch final image — M1\n│   │\n│   ├── user-service/\n│   │   ├── go.mod                                      # module: user-service; requires shared/auth, logger, pgx, bcrypt, jwt — M1, M2\n│   │   ├── main.go                                     # Startup: DB→migrations→stores→handler→routes (register/login/me) — M1, M2\n│   │   ├── config.go                                   # Config: DATABASE_URL, JWTSecret, BCryptCost=12, TokenTTL=24h — M1, M2\n│   │   ├── db.go                                       # NewDBPool — M1\n│   │   ├── health.go                                   # NewHealthHandler — M1\n│   │   ├── migration.sql                               # users table (id UUID PK, email UNIQUE, password_hash, created_at) + idx_users_email — M2\n│   │   ├── store.go                                    # User struct, UserRepository interface, pgxUserStore (Insert/FindByEmail), isPgUniqueViolation — M2\n│   │   ├── password.go                                 # PasswordHasher interface, bcryptHasher (Hash/Verify, ErrPasswordMismatch) — M2\n│   │   ├── token.go                                    # jwtTokenIssuer (Issue/Verify), dummy-hash constant for timing safety — M2\n│   │   ├── handler.go                                  # Handler struct; Register/Login (timing-safe)/Me methods; request/response types — M2\n│   │   ├── validate.go                                 # validateEmail (regex), validatePassword (min 8 chars) — M2\n│   │   ├── errors.go                                   # ErrDuplicateEmail, ErrUserNotFound, ErrPasswordMismatch, ErrTokenInvalid; writeError — M2\n│   │   ├── user_test.go                                # Validator tests, bcryptHasher tests, jwtTokenIssuer tests, handler unit tests (mock store), integration round-trip test — M2\n│   │   └── Dockerfile                                  # Multi-stage Go build, scratch final image — M1\n│   │\n│   └── notification-service/\n│       ├── go.mod                                      # module: notification-service; requires shared/events, auth, logger, pgx, amqp, jwt — M1, M5\n│       ├── main.go                                     # Startup: DB→migrations→AMQP→queues→store→consumer goroutine→HTTP (JWTMiddleware on /notifications) — M1, M5\n│       ├── config.go                                   # Config: DATABASE_URL, RABBITMQ_URL, JWTSecret — M1, M5\n│       ├── db.go                                       # NewDBPool — M1\n│       ├── rabbitmq.go                                 # NewRabbitMQConn + DeclareNotificationQueue (&quot;notifications.events&quot; + 3 bindings) — M1\n│       ├── health.go                                   # NewHealthHandler — M1\n│       ├── migration.sql                               # notifications table (id, user_id, event_type, payload JSONB, status, created_at, sent_at) + idx_notifications_user_created — M5\n│       ├── store.go                                    # NotificationRecord, NotificationRepository interface, pgxNotificationStore (Insert 2-step tx / FindByUserID cursor pagination) — M5\n│       ├── consumer.go                                 # NotificationConsumer, Run() (prefetch=1), processDelivery() (routing-key switch, mockEmail log, insert, ack/nack), panic recovery — M5\n│       ├── handler.go                                  # NotificationHandler, ListNotifications() (JWT claims→FindByUserID→paginated response) — M5\n│       ├── errors.go                                   # writeError, writeJSON, truncate — M5\n│       ├── notification_test.go                        # Consumer unit tests (mock store, all event types, malformed JSON, unknown key), handler unit tests, integration test — M5\n│       └── Dockerfile                                  # Multi-stage Go build, scratch final image — M1\n│\n├── gateway/\n│   ├── go.mod                                          # module: gateway; requires shared/auth, logger, go-redis, jwt, miniredis (test) — M1, M5\n│   ├── main.go                                         # Startup: config→Redis→proxies→CircuitBreaker→RateLimiter→Gateway→mux→upstream health checks→serve — M1, M5\n│   ├── config.go                                       # Config: all upstream URLs, RedisURL, JWTSecret, CB settings, RateLimits map — M1, M5\n│   ├── health.go                                       # NewHealthHandler — M1\n│   ├── router.go                                       # Route struct, routingTable (8 routes), Gateway struct, ServeHTTP (match→auth→rl→proxy), matchRoute() — M5\n│   ├── proxy.go                                        # UpstreamProxy (httputil.ReverseProxy wrapper), NewUpstreamProxy, path rewriting, ErrorHandler — M5\n│   ├── middleware.go                                   # CorrelationIDMiddleware, chain() helper — M5\n│   ├── ratelimit.go                                    # RateLimiter interface, redisTokenBucket (INCR+EXPIRE, fail-open), clientIP, buildRateLimitKey — M5\n│   ├── circuitbreaker.go                               # State enum, CircuitBreaker (sync.Mutex, 3-state machine), NewCircuitBreaker, Do(), ErrCircuitOpen — M5\n│   ├── jwtmiddleware.go                                # GatewayJWTMiddleware (wraps shared/auth.JWTMiddleware, adds correlation log) — M5\n│   ├── errors.go                                       # writeError, writeJSON helpers — M5\n│   ├── gateway_test.go                                 # CircuitBreaker unit tests (all transitions, concurrency), RateLimiter tests (miniredis), router matching tests, notification handler tests — M5\n│   └── Dockerfile                                      # Multi-stage Go build, scratch final image — M1\n│\n├── scripts/\n│   ├── smoke_test.sh                                   # Health-check all 5 /health endpoints — M1\n│   └── e2e_test.sh                                     # Full register→login→shorten→redirect→stats→notifications→rate-limit→correlation-ID test — M5\n│\n├── docker-compose.yml                                  # Full container mesh: 4 PostgreSQL, RabbitMQ, Redis, 4 services, gateway — M1 (extended M2–M5)\n└── README.md                                           # Prerequisites, startup commands, port table, RabbitMQ credentials — M1</code></pre></div>\n\n<hr>\n<h2 id=\"creation-order\">Creation Order</h2>\n<h3 id=\"1-project-scaffold-30-min\">1. Project Scaffold (30 min)</h3>\n<ul>\n<li>Create all directories: <code>shared/events/</code>, <code>shared/logger/</code>, <code>shared/auth/</code>, <code>services/url-service/</code>, <code>services/analytics-service/</code>, <code>services/user-service/</code>, <code>services/notification-service/</code>, <code>gateway/</code>, <code>scripts/</code></li>\n<li><code>go.work</code> (workspace root)</li>\n<li><code>shared/events/go.mod</code></li>\n<li><code>shared/logger/go.mod</code></li>\n<li>All five service <code>go.mod</code> files with empty <code>require</code> blocks (fill in as needed per phase)</li>\n<li>Stub <code>main.go</code> in each service/gateway: <code>package main; func main() {}</code></li>\n</ul>\n<h3 id=\"2-shared-packages-events-and-logger-30-min\">2. Shared Packages — Events and Logger (30 min)</h3>\n<ul>\n<li><code>shared/events/events.go</code> — BaseEvent, URLCreatedEvent, URLClickedEvent, URLDeletedEvent, MilestoneReachedEvent, EventType constants</li>\n<li><code>shared/events/events_test.go</code> — JSON round-trip tests, constant value tests</li>\n<li><code>shared/logger/logger.go</code> — <code>New()</code> (JSON handler, service field) — M5 extensions added later</li>\n</ul>\n<h3 id=\"3-infrastructure-config-docker-composeyml-115h\">3. Infrastructure Config — docker-compose.yml (1–1.5h)</h3>\n<ul>\n<li><code>docker-compose.yml</code> — all 4 PostgreSQL instances (ports 5432–5435), RabbitMQ (5672, 15672), Redis (6379), all 5 app containers with healthchecks and depends_on chains</li>\n<li>Verify: <code>docker compose config</code> → exit 0; <code>docker compose up</code> infra containers → all healthy</li>\n</ul>\n<h3 id=\"4-per-service-foundations-dbgo-redisgo-rabbitmqgo-healthgo-configgo-maingo-dockerfile-152h\">4. Per-Service Foundations: db.go, redis.go, rabbitmq.go, health.go, config.go, main.go, Dockerfile (1.5–2h)</h3>\n<ul>\n<li><strong>url-service</strong>: <code>config.go</code>, <code>db.go</code>, <code>redis.go</code>, <code>rabbitmq.go</code>, <code>health.go</code>, <code>main.go</code> (health route only), <code>Dockerfile</code></li>\n<li><strong>analytics-service</strong>: <code>config.go</code>, <code>db.go</code>, <code>rabbitmq.go</code> (+ <code>DeclareAnalyticsQueue</code>), <code>health.go</code>, <code>main.go</code>, <code>Dockerfile</code></li>\n<li><strong>user-service</strong>: <code>config.go</code>, <code>db.go</code>, <code>health.go</code>, <code>main.go</code>, <code>Dockerfile</code></li>\n<li><strong>notification-service</strong>: <code>config.go</code>, <code>db.go</code>, <code>rabbitmq.go</code> (+ <code>DeclareNotificationQueue</code>), <code>health.go</code>, <code>main.go</code>, <code>Dockerfile</code></li>\n<li><strong>gateway</strong>: <code>config.go</code> (stub), <code>health.go</code>, <code>main.go</code> (health only), <code>Dockerfile</code></li>\n<li><code>scripts/smoke_test.sh</code></li>\n<li><code>README.md</code></li>\n<li><strong>Checkpoint M1</strong>: <code>docker compose up --build -d</code> → all 10 containers healthy; all <code>/health</code> return <code>200 {&quot;status&quot;:&quot;ok&quot;}</code></li>\n</ul>\n<h3 id=\"5-shared-auth-package-1h\">5. Shared Auth Package (1h)</h3>\n<ul>\n<li><code>shared/auth/go.mod</code></li>\n<li><code>shared/auth/auth.go</code> — Claims, TokenIssuer interface, VerifyToken, ErrTokenInvalid, TestClaimsKey</li>\n<li><code>shared/auth/middleware.go</code> — JWTMiddleware, ClaimsFromContext, claimsKey</li>\n<li>Update <code>go.work</code> to include <code>./shared/auth</code></li>\n</ul>\n<h3 id=\"6-user-service-full-implementation-34h\">6. User Service — Full Implementation (3–4h)</h3>\n<ul>\n<li><code>services/user-service/migration.sql</code></li>\n<li><code>services/user-service/errors.go</code></li>\n<li><code>services/user-service/store.go</code></li>\n<li><code>services/user-service/password.go</code></li>\n<li><code>services/user-service/token.go</code></li>\n<li><code>services/user-service/validate.go</code></li>\n<li><code>services/user-service/handler.go</code></li>\n<li>Extend <code>services/user-service/config.go</code> (JWTSecret, BCryptCost, TokenTTL)</li>\n<li>Extend <code>services/user-service/main.go</code> (runMigrations, full route wiring)</li>\n<li><code>services/user-service/user_test.go</code></li>\n<li><strong>Checkpoint M2</strong>: register→login→GET /me round-trip succeeds; duplicate email → 409; wrong password → 401 (same body as unknown email)</li>\n</ul>\n<h3 id=\"7-url-service-full-implementation-68h\">7. URL Service — Full Implementation (6–8h)</h3>\n<ul>\n<li><code>services/url-service/migration.sql</code></li>\n<li><code>services/url-service/errors.go</code></li>\n<li><code>services/url-service/validate.go</code></li>\n<li><code>services/url-service/base62.go</code></li>\n<li><code>services/url-service/codegen.go</code></li>\n<li><code>services/url-service/store.go</code></li>\n<li><code>services/url-service/outbox_store.go</code></li>\n<li><code>services/url-service/cache.go</code></li>\n<li><code>services/url-service/publisher.go</code></li>\n<li><code>services/url-service/outbox.go</code></li>\n<li><code>services/url-service/handler.go</code></li>\n<li>Extend <code>services/url-service/config.go</code> (JWTSecret, ShortURLBase, OutboxPollInterval)</li>\n<li>Extend <code>services/url-service/main.go</code> (runMigrations, all routes, outbox coordinator start)</li>\n<li><code>services/url-service/url_test.go</code></li>\n<li><code>services/url-service/bench_test.go</code></li>\n<li><strong>Checkpoint M3</strong>: POST /shorten → 201; GET /:code → 301 (DB then Redis); DELETE → 204 + 410; outbox rows transition to <code>published_at != NULL</code> within 5s; <code>EXPLAIN ANALYZE</code> shows index scans</li>\n</ul>\n<h3 id=\"8-analytics-service-full-implementation-45h\">8. Analytics Service — Full Implementation (4–5h)</h3>\n<ul>\n<li><code>services/analytics-service/migration.sql</code></li>\n<li><code>services/analytics-service/errors.go</code></li>\n<li><code>services/analytics-service/haship.go</code></li>\n<li><code>services/analytics-service/store.go</code></li>\n<li><code>services/analytics-service/publisher.go</code></li>\n<li><code>services/analytics-service/milestone.go</code></li>\n<li><code>services/analytics-service/consumer.go</code></li>\n<li><code>services/analytics-service/handler.go</code></li>\n<li>Extend <code>services/analytics-service/config.go</code> (IPHashSalt)</li>\n<li>Extend <code>services/analytics-service/main.go</code> (runMigrations, consumer goroutine, /stats routes)</li>\n<li><code>services/analytics-service/analytics_test.go</code></li>\n<li><strong>Checkpoint M4</strong>: same <code>event_id</code> processed twice → click count = 1; 10 redirects → <code>milestones</code> row milestone=10; GET /stats → 200 with correct counts; <code>EXPLAIN ANALYZE</code> shows index scans</li>\n</ul>\n<h3 id=\"9-extended-sharedlogger-30-min\">9. Extended shared/logger (30 min)</h3>\n<ul>\n<li>Extend <code>shared/logger/logger.go</code> — add <code>WithCorrelationID</code>, <code>CorrelationIDFromContext</code>, <code>ContextWithCorrelationID</code>, <code>RequestLogger</code>, <code>responseWriter</code></li>\n<li>Verify <code>go build ./...</code> from root still exits 0</li>\n</ul>\n<h3 id=\"10-notification-service-full-implementation-23h\">10. Notification Service — Full Implementation (2–3h)</h3>\n<ul>\n<li><code>services/notification-service/migration.sql</code></li>\n<li><code>services/notification-service/errors.go</code></li>\n<li><code>services/notification-service/store.go</code></li>\n<li><code>services/notification-service/consumer.go</code></li>\n<li><code>services/notification-service/handler.go</code></li>\n<li>Extend <code>services/notification-service/config.go</code> (JWTSecret)</li>\n<li>Extend <code>services/notification-service/main.go</code> (runMigrations, consumer goroutine, /notifications route)</li>\n<li><code>services/notification-service/notification_test.go</code></li>\n<li><strong>Checkpoint M5-a</strong>: URLCreatedEvent consumed → notifications row inserted with status=&#39;sent&#39;; GET /notifications with valid JWT → 200 with notification item</li>\n</ul>\n<h3 id=\"11-api-gateway-full-implementation-45h\">11. API Gateway — Full Implementation (4–5h)</h3>\n<ul>\n<li>Extend <code>gateway/config.go</code> (all fields: upstream URLs, Redis, JWT, CB settings, RateLimits map)</li>\n<li><code>gateway/errors.go</code></li>\n<li><code>gateway/middleware.go</code></li>\n<li><code>gateway/proxy.go</code></li>\n<li><code>gateway/router.go</code></li>\n<li><code>gateway/jwtmiddleware.go</code></li>\n<li><code>gateway/ratelimit.go</code></li>\n<li><code>gateway/circuitbreaker.go</code></li>\n<li>Extend <code>gateway/main.go</code> (full wiring: Redis client, proxies, CB, RL, Gateway, mux, upstream health checks)</li>\n<li><code>gateway/gateway_test.go</code></li>\n<li><code>scripts/e2e_test.sh</code></li>\n<li><strong>Checkpoint M5-b</strong>: <code>bash scripts/e2e_test.sh</code> → all assertions pass; 11th POST /api/shorten → 429; 6th request after url-service stop → 503; circuit reopens after 30s probe; <code>X-Correlation-ID</code> in logs of all services for same request</li>\n</ul>\n<hr>\n<h2 id=\"file-count-summary\">File Count Summary</h2>\n<table>\n<thead>\n<tr>\n<th>Category</th>\n<th>Count</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>shared/</code> package files</td>\n<td>8</td>\n</tr>\n<tr>\n<td><code>url-service/</code> files</td>\n<td>18</td>\n</tr>\n<tr>\n<td><code>analytics-service/</code> files</td>\n<td>16</td>\n</tr>\n<tr>\n<td><code>user-service/</code> files</td>\n<td>15</td>\n</tr>\n<tr>\n<td><code>notification-service/</code> files</td>\n<td>14</td>\n</tr>\n<tr>\n<td><code>gateway/</code> files</td>\n<td>13</td>\n</tr>\n<tr>\n<td>Root / scripts / infra</td>\n<td>3</td>\n</tr>\n<tr>\n<td><strong>Total files</strong></td>\n<td><strong>87</strong></td>\n</tr>\n<tr>\n<td><strong>Directories</strong></td>\n<td><strong>14</strong></td>\n</tr>\n<tr>\n<td><strong>Estimated lines of code</strong></td>\n<td><strong>~6,500–8,000</strong></td>\n</tr>\n</tbody></table>\n","toc":[{"level":1,"text":"URL Shortener — Engineering Design Document","id":"url-shortener-engineering-design-document"},{"level":2,"text":"System Purpose","id":"system-purpose"},{"level":2,"text":"Service Map","id":"service-map"},{"level":2,"text":"Tech Stack","id":"tech-stack"},{"level":2,"text":"Key Design Decisions","id":"key-design-decisions"},{"level":2,"text":"Anti-Patterns Explicitly Avoided","id":"anti-patterns-explicitly-avoided"},{"level":1,"text":"TDD","id":"tdd"},{"level":1,"text":"Foundation: Repo Layout, Shared Contracts, Local Dev Stack","id":"foundation-repo-layout-shared-contracts-local-dev-stack"},{"level":2,"text":"Module ID: url-shortener-m1","id":"module-id-url-shortener-m1"},{"level":2,"text":"1. Module Charter","id":"1-module-charter"},{"level":2,"text":"This module establishes the entire structural foundation that every subsequent milestone builds upon. It creates the monorepo directory layout, writes one go.mod per service, authors the docker-compose.yml that defines the full container mesh (4 PostgreSQL instances, 1 RabbitMQ, 1 Redis, 4 app services, 1 gateway stub), defines the canonical domain event Go structs in shared/events, provides a structured-JSON logger stub in shared/logger, and wires each service to its own database via pgxpool with correct pool sizing. It does not implement any business logic, URL shortening, authentication, message publishing, or consumer loops. The only RabbitMQ work performed here is topology declaration (exchange + queue + binding) on startup — no messages are produced or consumed. The only HTTP surface exposed is /health on each service. Every invariant established here — one database per service, Redis as optional cache (never authoritative), RabbitMQ connection with retry-backoff, fatal exit on missing required config — must never be violated by later milestones. This module is complete when docker compose up brings all containers to a healthy state within 60 seconds and every /health endpoint returns 200","id":"this-module-establishes-the-entire-structural-foundation-that-every-subsequent-milestone-builds-upon-it-creates-the-monorepo-directory-layout-writes-one-gomod-per-service-authors-the-docker-composeyml-that-defines-the-full-container-mesh-4-postgresql-instances-1-rabbitmq-1-redis-4-app-services-1-gateway-stub-defines-the-canonical-domain-event-go-structs-in-sharedevents-provides-a-structured-json-logger-stub-in-sharedlogger-and-wires-each-service-to-its-own-database-via-pgxpool-with-correct-pool-sizing-it-does-not-implement-any-business-logic-url-shortening-authentication-message-publishing-or-consumer-loops-the-only-rabbitmq-work-performed-here-is-topology-declaration-exchange-queue-binding-on-startup-no-messages-are-produced-or-consumed-the-only-http-surface-exposed-is-health-on-each-service-every-invariant-established-here-one-database-per-service-redis-as-optional-cache-never-authoritative-rabbitmq-connection-with-retry-backoff-fatal-exit-on-missing-required-config-must-never-be-violated-by-later-milestones-this-module-is-complete-when-docker-compose-up-brings-all-containers-to-a-healthy-state-within-60-seconds-and-every-health-endpoint-returns-200"},{"level":2,"text":"2. File Structure","id":"2-file-structure"},{"level":2,"text":"3. Complete Data Model","id":"3-complete-data-model"},{"level":3,"text":"3.1 Domain Event Structs (shared/events/events.go)","id":"31-domain-event-structs-sharedeventseventsgo"},{"level":3,"text":"3.2 Per-Service Config Structs","id":"32-per-service-config-structs"},{"level":3,"text":"3.3 Health Response Schema","id":"33-health-response-schema"},{"level":3,"text":"3.4 RabbitMQ Topology","id":"34-rabbitmq-topology"},{"level":2,"text":"4. Interface Contracts","id":"4-interface-contracts"},{"level":3,"text":"4.1 shared/logger Package","id":"41-sharedlogger-package"},{"level":3,"text":"4.2 DB Connection Factory","id":"42-db-connection-factory"},{"level":3,"text":"4.3 Redis Connection Factory (url-service only)","id":"43-redis-connection-factory-url-service-only"},{"level":3,"text":"4.4 RabbitMQ Connection Factory","id":"44-rabbitmq-connection-factory"},{"level":3,"text":"4.5 Queue/Binding Declaration (Consumer Services)","id":"45-queuebinding-declaration-consumer-services"},{"level":3,"text":"4.6 Health Handler","id":"46-health-handler"},{"level":2,"text":"Why pre-encode: The response never changes during the process lifetime. Encoding once at startup avoids per-request allocation. json.Marshal on this tiny struct cannot fail (no custom marshalers, no channels/funcs)","id":"why-pre-encode-the-response-never-changes-during-the-process-lifetime-encoding-once-at-startup-avoids-per-request-allocation-jsonmarshal-on-this-tiny-struct-cannot-fail-no-custom-marshalers-no-channelsfuncs"},{"level":2,"text":"5. Algorithm Specification","id":"5-algorithm-specification"},{"level":3,"text":"5.1 Startup Sequence — url-service (most complex; others are subsets)","id":"51-startup-sequence-url-service-most-complex-others-are-subsets"},{"level":3,"text":"5.2 Startup Sequence — analytics-service","id":"52-startup-sequence-analytics-service"},{"level":3,"text":"5.3 Startup Sequence — notification-service","id":"53-startup-sequence-notification-service"},{"level":3,"text":"5.4 Startup Sequence — user-service","id":"54-startup-sequence-user-service"},{"level":3,"text":"5.5 Startup Sequence — gateway (stub)","id":"55-startup-sequence-gateway-stub"},{"level":2,"text":"6. Docker Compose Specification","id":"6-docker-compose-specification"},{"level":3,"text":"6.1 Complete docker-compose.yml","id":"61-complete-docker-composeyml"},{"level":3,"text":"6.2 Dockerfile (uniform across all services)","id":"62-dockerfile-uniform-across-all-services"},{"level":3,"text":"6.3 Go Workspace (go.work)","id":"63-go-workspace-gowork"},{"level":2,"text":"7. Error Handling Matrix","id":"7-error-handling-matrix"},{"level":2,"text":"8. Implementation Sequence with Checkpoints","id":"8-implementation-sequence-with-checkpoints"},{"level":3,"text":"Phase 1: Monorepo Scaffold and go.mod per Service (0.5–1h)","id":"phase-1-monorepo-scaffold-and-gomod-per-service-051h"},{"level":3,"text":"Phase 2: docker-compose.yml with All Containers (1–1.5h)","id":"phase-2-docker-composeyml-with-all-containers-115h"},{"level":3,"text":"Phase 3: shared/events and shared/logger (0.5h)","id":"phase-3-sharedevents-and-sharedlogger-05h"},{"level":3,"text":"Phase 4: Per-Service Config, DB Pool, Redis, Health Handler (1–1.5h)","id":"phase-4-per-service-config-db-pool-redis-health-handler-115h"},{"level":3,"text":"Phase 5: RabbitMQ Exchange and Queue/Binding Declaration (0.5–1h)","id":"phase-5-rabbitmq-exchange-and-queuebinding-declaration-051h"},{"level":3,"text":"Phase 6: Full docker compose up + README (0.5h)","id":"phase-6-full-docker-compose-up-readme-05h"},{"level":2,"text":"9. Test Specification","id":"9-test-specification"},{"level":3,"text":"9.1 shared/events Package Tests","id":"91-sharedevents-package-tests"},{"level":3,"text":"9.2 Config Loading Tests","id":"92-config-loading-tests"},{"level":3,"text":"9.3 Health Handler Tests","id":"93-health-handler-tests"},{"level":3,"text":"9.4 Integration Smoke Test (shell script)","id":"94-integration-smoke-test-shell-script"},{"level":2,"text":"10. Performance Targets","id":"10-performance-targets"},{"level":2,"text":"11. README Content","id":"11-readme-content"},{"level":2,"text":"12. Pitfall Prevention","id":"12-pitfall-prevention"},{"level":1,"text":"User Service: Registration, Login, JWT Issuance","id":"user-service-registration-login-jwt-issuance"},{"level":2,"text":"Module ID: url-shortener-m2","id":"module-id-url-shortener-m2"},{"level":2,"text":"1. Module Charter","id":"1-module-charter"},{"level":2,"text":"2. File Structure","id":"2-file-structure"},{"level":2,"text":"3. Complete Data Model","id":"3-complete-data-model"},{"level":3,"text":"3.1 PostgreSQL Schema (migration.sql)","id":"31-postgresql-schema-migrationsql"},{"level":3,"text":"3.2 Go Structs — shared/auth Package","id":"32-go-structs-sharedauth-package"},{"level":3,"text":"3.3 Go Structs — user-service Package","id":"33-go-structs-user-service-package"},{"level":3,"text":"3.4 HTTP Request/Response Schemas","id":"34-http-requestresponse-schemas"},{"level":3,"text":"3.5 Sentinel Errors (errors.go)","id":"35-sentinel-errors-errorsgo"},{"level":2,"text":"4. Interface Contracts","id":"4-interface-contracts"},{"level":3,"text":"4.1 UserRepository — pgxUserStore Implementation","id":"41-userrepository-pgxuserstore-implementation"},{"level":3,"text":"4.2 PasswordHasher — bcryptHasher Implementation","id":"42-passwordhasher-bcrypthasher-implementation"},{"level":3,"text":"4.3 TokenIssuer — jwtTokenIssuer Implementation","id":"43-tokenissuer-jwttokenissuer-implementation"},{"level":3,"text":"4.4 shared/auth — JWTMiddleware","id":"44-sharedauth-jwtmiddleware"},{"level":3,"text":"4.5 shared/auth — VerifyToken Standalone Function","id":"45-sharedauth-verifytoken-standalone-function"},{"level":3,"text":"4.6 Validation Functions (validate.go)","id":"46-validation-functions-validatego"},{"level":2,"text":"5. Algorithm Specification","id":"5-algorithm-specification"},{"level":3,"text":"5.1 POST /register Handler","id":"51-post-register-handler"},{"level":3,"text":"5.2 POST /login Handler — Timing-Safe Design","id":"52-post-login-handler-timing-safe-design"},{"level":3,"text":"5.3 TokenIssuer.Issue Algorithm","id":"53-tokenissuerissue-algorithm"},{"level":3,"text":"5.4 TokenIssuer.Verify / shared/auth.VerifyToken Algorithm","id":"54-tokenissuerverify-sharedauthverifytoken-algorithm"},{"level":3,"text":"5.5 GET /me Handler","id":"55-get-me-handler"},{"level":3,"text":"5.6 Schema Migration on Service Startup","id":"56-schema-migration-on-service-startup"},{"level":2,"text":"Called in main() after NewDBPool, before starting the HTTP server. Fatal on error","id":"called-in-main-after-newdbpool-before-starting-the-http-server-fatal-on-error"},{"level":2,"text":"6. Error Handling Matrix","id":"6-error-handling-matrix"},{"level":2,"text":"Security note: 401 responses for login always use the message &quot;invalid credentials&quot; regardless of whether the email was not found or the password was wrong. The log lines for these two paths are also identical (neither logs). This prevents log-based email enumeration","id":"security-note-401-responses-for-login-always-use-the-message-quotinvalid-credentialsquot-regardless-of-whether-the-email-was-not-found-or-the-password-was-wrong-the-log-lines-for-these-two-paths-are-also-identical-neither-logs-this-prevents-log-based-email-enumeration"},{"level":2,"text":"7. Threat Model","id":"7-threat-model"},{"level":2,"text":"8. Concurrency Specification","id":"8-concurrency-specification"},{"level":2,"text":"9. Implementation Sequence with Checkpoints","id":"9-implementation-sequence-with-checkpoints"},{"level":3,"text":"Phase 1: shared/auth Package + users Table Migration (1–1.5h)","id":"phase-1-sharedauth-package-users-table-migration-115h"},{"level":3,"text":"Phase 2: store.go, password.go, token.go, errors.go (1–1.5h)","id":"phase-2-storego-passwordgo-tokengo-errorsgo-115h"},{"level":3,"text":"Phase 3: validate.go + handler.go + Updated config.go and main.go (1.5–2h)","id":"phase-3-validatego-handlergo-updated-configgo-and-maingo-152h"},{"level":3,"text":"Phase 4: JWTMiddleware Integration + GET /me (1h)","id":"phase-4-jwtmiddleware-integration-get-me-1h"},{"level":3,"text":"Phase 5: Integration Test (1–2h)","id":"phase-5-integration-test-12h"},{"level":2,"text":"10. Test Specification","id":"10-test-specification"},{"level":3,"text":"10.1 Unit Tests — Validators (validate_test.go)","id":"101-unit-tests-validators-validate_testgo"},{"level":3,"text":"10.2 Unit Tests — bcryptHasher","id":"102-unit-tests-bcrypthasher"},{"level":3,"text":"10.3 Unit Tests — jwtTokenIssuer","id":"103-unit-tests-jwttokenissuer"},{"level":3,"text":"10.4 Unit Tests — Handlers (with mock store)","id":"104-unit-tests-handlers-with-mock-store"},{"level":3,"text":"10.5 Integration Test — Full Round Trip","id":"105-integration-test-full-round-trip"},{"level":2,"text":"11. Performance Targets","id":"11-performance-targets"},{"level":2,"text":"12. docker-compose.yml Addition for JWT_SECRET","id":"12-docker-composeyml-addition-for-jwt_secret"},{"level":2,"text":"Add to go.work and go.mod replace directives for shared/auth in all services that will verify JWTs (url-service, analytics-service, notification-service, gateway) — even though those services don&#39;t use it until M3+, adding the dependency now prevents go.work synchronization issues","id":"add-to-gowork-and-gomod-replace-directives-for-sharedauth-in-all-services-that-will-verify-jwts-url-service-analytics-service-notification-service-gateway-even-though-those-services-don39t-use-it-until-m3-adding-the-dependency-now-prevents-gowork-synchronization-issues"},{"level":1,"text":"URL Service: Shorten, Redirect, CRUD + Domain Event Publishing","id":"url-service-shorten-redirect-crud-domain-event-publishing"},{"level":2,"text":"Module ID: url-shortener-m3","id":"module-id-url-shortener-m3"},{"level":2,"text":"1. Module Charter","id":"1-module-charter"},{"level":2,"text":"2. File Structure","id":"2-file-structure"},{"level":2,"text":"3. Complete Data Model","id":"3-complete-data-model"},{"level":3,"text":"3.1 PostgreSQL Schema (migration.sql)","id":"31-postgresql-schema-migrationsql"},{"level":3,"text":"3.2 Go Structs","id":"32-go-structs"},{"level":3,"text":"3.3 Repository Interfaces","id":"33-repository-interfaces"},{"level":2,"text":"4. Interface Contracts","id":"4-interface-contracts"},{"level":3,"text":"4.1 URLRepository — pgxURLStore Implementation","id":"41-urlrepository-pgxurlstore-implementation"},{"level":3,"text":"4.2 OutboxRepository — pgxOutboxStore Implementation","id":"42-outboxrepository-pgxoutboxstore-implementation"},{"level":3,"text":"4.3 RedisCache","id":"43-rediscache"},{"level":3,"text":"4.4 Base62Encoder and ShortCodeGenerator","id":"44-base62encoder-and-shortcodegenerator"},{"level":3,"text":"4.5 RabbitMQPublisher — amqpPublisher Implementation","id":"45-rabbitmqpublisher-amqppublisher-implementation"},{"level":2,"text":"5. Algorithm Specification","id":"5-algorithm-specification"},{"level":3,"text":"5.1 ShortCodeGenerator.Generate() — Base62 Random Code","id":"51-shortcodegeneratorgenerate-base62-random-code"},{"level":3,"text":"5.2 POST /shorten Handler — Full Algorithm","id":"52-post-shorten-handler-full-algorithm"},{"level":3,"text":"5.3 GET /:code — Read-Through Cache Redirect","id":"53-get-code-read-through-cache-redirect"},{"level":3,"text":"5.4 DELETE /urls/:code Handler","id":"54-delete-urlscode-handler"},{"level":3,"text":"5.5 Outbox Coordinator + Worker Pool","id":"55-outbox-coordinator-worker-pool"},{"level":3,"text":"5.6 IP Hashing (hashIP)","id":"56-ip-hashing-haship"},{"level":3,"text":"5.7 Startup Migration","id":"57-startup-migration"},{"level":3,"text":"5.8 Route Registration in main.go","id":"58-route-registration-in-maingo"},{"level":3,"text":"5.9 validateURL Function","id":"59-validateurl-function"},{"level":3,"text":"5.10 Correlation ID Propagation","id":"510-correlation-id-propagation"},{"level":2,"text":"6. Error Handling Matrix","id":"6-error-handling-matrix"},{"level":2,"text":"7. Concurrency Specification","id":"7-concurrency-specification"},{"level":2,"text":"8. Implementation Sequence with Checkpoints","id":"8-implementation-sequence-with-checkpoints"},{"level":3,"text":"Phase 1: DB Schema — urls + outbox Tables, Migrations, Indexes (1h)","id":"phase-1-db-schema-urls-outbox-tables-migrations-indexes-1h"},{"level":3,"text":"Phase 2: Base62 Encoder + ShortCodeGenerator with Collision Retry (1–1.5h)","id":"phase-2-base62-encoder-shortcodegenerator-with-collision-retry-115h"},{"level":3,"text":"Phase 3: POST /shorten Handler + Atomic URL+Outbox Insert (2–2.5h)","id":"phase-3-post-shorten-handler-atomic-urloutbox-insert-225h"},{"level":3,"text":"Phase 4: Redis Cache Helpers + GET /:code Redirect (2–2.5h)","id":"phase-4-redis-cache-helpers-get-code-redirect-225h"},{"level":3,"text":"Phase 5: GET /urls + DELETE /urls/:code (1.5–2h)","id":"phase-5-get-urls-delete-urlscode-152h"},{"level":3,"text":"Phase 6: Outbox Coordinator + 3-Worker Pool + Graceful Shutdown (2–2.5h)","id":"phase-6-outbox-coordinator-3-worker-pool-graceful-shutdown-225h"},{"level":3,"text":"Phase 7: Tests + Benchmark (1–1.5h)","id":"phase-7-tests-benchmark-115h"},{"level":2,"text":"Checkpoint: All unit tests pass. Redirect benchmark reports p99 &lt; 5ms under 100 concurrent simulated requests (see §9 for wrk command)","id":"checkpoint-all-unit-tests-pass-redirect-benchmark-reports-p99-lt-5ms-under-100-concurrent-simulated-requests-see-9-for-wrk-command"},{"level":2,"text":"9. Test Specification","id":"9-test-specification"},{"level":3,"text":"9.1 Base62 Tests (url_test.go)","id":"91-base62-tests-url_testgo"},{"level":3,"text":"9.2 validateURL Tests","id":"92-validateurl-tests"},{"level":3,"text":"9.3 Handler Unit Tests (with mock stores)","id":"93-handler-unit-tests-with-mock-stores"},{"level":3,"text":"9.4 RedisCache Unit Tests","id":"94-rediscache-unit-tests"},{"level":3,"text":"9.5 Outbox Worker Test","id":"95-outbox-worker-test"},{"level":3,"text":"9.6 Benchmark (bench_test.go)","id":"96-benchmark-bench_testgo"},{"level":2,"text":"10. Performance Targets","id":"10-performance-targets"},{"level":2,"text":"11. Anti-Pattern Guard","id":"11-anti-pattern-guard"},{"level":1,"text":"Analytics Service: Click Ingestion + Stats API","id":"analytics-service-click-ingestion-stats-api"},{"level":2,"text":"Module ID: url-shortener-m4","id":"module-id-url-shortener-m4"},{"level":2,"text":"1. Module Charter","id":"1-module-charter"},{"level":2,"text":"2. File Structure","id":"2-file-structure"},{"level":2,"text":"3. Complete Data Model","id":"3-complete-data-model"},{"level":3,"text":"3.1 PostgreSQL Schema (migration.sql)","id":"31-postgresql-schema-migrationsql"},{"level":3,"text":"3.2 Go Structs","id":"32-go-structs"},{"level":3,"text":"3.3 Repository Interfaces","id":"33-repository-interfaces"},{"level":2,"text":"4. Interface Contracts","id":"4-interface-contracts"},{"level":3,"text":"4.1 ClickRepository — pgxClickStore Implementation","id":"41-clickrepository-pgxclickstore-implementation"},{"level":3,"text":"4.2 MilestoneRepository — pgxMilestoneStore Implementation","id":"42-milestonerepository-pgxmilestonestore-implementation"},{"level":3,"text":"4.3 DeduplicationRepository — pgxDeduplicationStore Implementation","id":"43-deduplicationrepository-pgxdeduplicationstore-implementation"},{"level":3,"text":"4.4 AnalyticsPublisher Interface","id":"44-analyticspublisher-interface"},{"level":3,"text":"4.5 MilestoneChecker","id":"45-milestonechecker"},{"level":2,"text":"5. Algorithm Specification","id":"5-algorithm-specification"},{"level":3,"text":"5.1 Consumer Startup and AMQP Prefetch","id":"51-consumer-startup-and-amqp-prefetch"},{"level":3,"text":"5.2 MilestoneChecker.CheckAndPublish Algorithm","id":"52-milestonecheckercheckandpublish-algorithm"},{"level":3,"text":"5.3 GET /stats/:code Handler","id":"53-get-statscode-handler"},{"level":3,"text":"5.4 GET /stats/:code/timeline Handler","id":"54-get-statscodetimeline-handler"},{"level":3,"text":"5.5 Schema Migration on Startup","id":"55-schema-migration-on-startup"},{"level":3,"text":"5.6 hashIP Function (haship.go)","id":"56-haship-function-hashipgo"},{"level":3,"text":"5.7 newUUID Helper","id":"57-newuuid-helper"},{"level":3,"text":"5.8 Route and Consumer Registration in main.go","id":"58-route-and-consumer-registration-in-maingo"},{"level":2,"text":"6. Error Handling Matrix","id":"6-error-handling-matrix"},{"level":2,"text":"7. Concurrency Specification","id":"7-concurrency-specification"},{"level":2,"text":"8. Implementation Sequence with Checkpoints","id":"8-implementation-sequence-with-checkpoints"},{"level":3,"text":"Phase 1: DB Schema — clicks, milestones, processed_events Tables (1h)","id":"phase-1-db-schema-clicks-milestones-processed_events-tables-1h"},{"level":3,"text":"Phase 2: AMQP Consumer Goroutine — Prefetch, Message Loop, Panic Recovery, Idempotency (2–2.5h)","id":"phase-2-amqp-consumer-goroutine-prefetch-message-loop-panic-recovery-idempotency-225h"},{"level":3,"text":"Phase 3: Click Insert, Milestone Check, MilestoneReachedEvent Publish — One Transaction (2–2.5h)","id":"phase-3-click-insert-milestone-check-milestonereachedevent-publish-one-transaction-225h"},{"level":3,"text":"Phase 4: GET /stats/:code and GET /stats/:code/timeline Handlers (1.5–2h)","id":"phase-4-get-statscode-and-get-statscodetimeline-handlers-152h"},{"level":3,"text":"Phase 5: Test — Duplicate URLClickedEvent → Click Count = 1 (1h)","id":"phase-5-test-duplicate-urlclickedevent-click-count-1-1h"},{"level":2,"text":"9. Test Specification","id":"9-test-specification"},{"level":3,"text":"9.1 Unit Tests — MilestoneChecker (mock stores)","id":"91-unit-tests-milestonechecker-mock-stores"},{"level":3,"text":"9.2 Unit Tests — Consumer Idempotency and Poison Messages","id":"92-unit-tests-consumer-idempotency-and-poison-messages"},{"level":3,"text":"9.3 Unit Tests — StatsHandler","id":"93-unit-tests-statshandler"},{"level":3,"text":"9.4 Integration Test — Duplicate URLClickedEvent → Click Count = 1 (Primary Acceptance Criterion)","id":"94-integration-test-duplicate-urlclickedevent-click-count-1-primary-acceptance-criterion"},{"level":3,"text":"9.5 pgxClickStore Referer NULL Handling Test","id":"95-pgxclickstore-referer-null-handling-test"},{"level":2,"text":"10. Performance Targets","id":"10-performance-targets"},{"level":3,"text":"10.1 go.mod Additions for Analytics Service","id":"101-gomod-additions-for-analytics-service"},{"level":3,"text":"10.2 docker-compose.yml Additions","id":"102-docker-composeyml-additions"},{"level":2,"text":"11. Anti-Pattern Guard","id":"11-anti-pattern-guard"},{"level":1,"text":"Notification Service + API Gateway + Circuit Breaker","id":"notification-service-api-gateway-circuit-breaker"},{"level":2,"text":"Module ID: url-shortener-m5","id":"module-id-url-shortener-m5"},{"level":2,"text":"1. Module Charter","id":"1-module-charter"},{"level":2,"text":"2. File Structure","id":"2-file-structure"},{"level":2,"text":"3. Complete Data Model","id":"3-complete-data-model"},{"level":3,"text":"3.1 PostgreSQL Schema — Notification Service (migration.sql)","id":"31-postgresql-schema-notification-service-migrationsql"},{"level":3,"text":"3.2 Go Structs — Notification Service","id":"32-go-structs-notification-service"},{"level":3,"text":"3.3 HTTP Response Schema — Notification Service","id":"33-http-response-schema-notification-service"},{"level":3,"text":"3.4 Go Structs — Gateway","id":"34-go-structs-gateway"},{"level":3,"text":"3.5 Routing Table (Immutable After Construction)","id":"35-routing-table-immutable-after-construction"},{"level":3,"text":"3.6 Extended shared/logger Package","id":"36-extended-sharedlogger-package"},{"level":2,"text":"4. Interface Contracts","id":"4-interface-contracts"},{"level":3,"text":"4.1 NotificationRepository — pgxNotificationStore Implementation","id":"41-notificationrepository-pgxnotificationstore-implementation"},{"level":3,"text":"4.2 NotificationConsumer","id":"42-notificationconsumer"},{"level":3,"text":"4.3 NotificationHandler","id":"43-notificationhandler"},{"level":3,"text":"4.4 CircuitBreaker","id":"44-circuitbreaker"},{"level":3,"text":"4.5 RateLimiter — redisTokenBucket Implementation","id":"45-ratelimiter-redistokenbucket-implementation"},{"level":3,"text":"4.6 Gateway ReverseProxy","id":"46-gateway-reverseproxy"},{"level":2,"text":"5. Algorithm Specification","id":"5-algorithm-specification"},{"level":3,"text":"5.1 Gateway Request Processing Pipeline","id":"51-gateway-request-processing-pipeline"},{"level":3,"text":"5.2 CorrelationIDMiddleware Implementation","id":"52-correlationidmiddleware-implementation"},{"level":3,"text":"5.3 Gateway JWT Middleware","id":"53-gateway-jwt-middleware"},{"level":3,"text":"5.4 Rate Limiter — Client IP Extraction","id":"54-rate-limiter-client-ip-extraction"},{"level":3,"text":"5.5 Gateway ServeHTTP — Full Router Logic","id":"55-gateway-servehttp-full-router-logic"},{"level":3,"text":"5.6 Gateway Startup Sequence","id":"56-gateway-startup-sequence"},{"level":3,"text":"5.7 Notification Service Startup Sequence","id":"57-notification-service-startup-sequence"},{"level":3,"text":"5.8 Schema Migration — Notification Service","id":"58-schema-migration-notification-service"},{"level":3,"text":"5.9 docker-compose.yml Additions (M5)","id":"59-docker-composeyml-additions-m5"},{"level":2,"text":"JWT_SECRET must be identical across: user-service, url-service, notification-service, gateway. Any mismatch causes all JWT verifications to fail with 401","id":"jwt_secret-must-be-identical-across-user-service-url-service-notification-service-gateway-any-mismatch-causes-all-jwt-verifications-to-fail-with-401"},{"level":2,"text":"6. Error Handling Matrix","id":"6-error-handling-matrix"},{"level":3,"text":"6.1 Notification Service","id":"61-notification-service"},{"level":3,"text":"6.2 API Gateway","id":"62-api-gateway"},{"level":2,"text":"7. Implementation Sequence with Checkpoints","id":"7-implementation-sequence-with-checkpoints"},{"level":3,"text":"Phase 1: Notification Service — DB Schema, Consumer, Handler (2–2.5h)","id":"phase-1-notification-service-db-schema-consumer-handler-225h"},{"level":3,"text":"Phase 2: Extended shared/logger (0.5–1h)","id":"phase-2-extended-sharedlogger-051h"},{"level":3,"text":"Phase 3: Gateway Routing Table and Reverse Proxy (1–1.5h)","id":"phase-3-gateway-routing-table-and-reverse-proxy-115h"},{"level":3,"text":"Phase 4: Gateway JWT Middleware and X-Correlation-ID Propagation (1h)","id":"phase-4-gateway-jwt-middleware-and-x-correlation-id-propagation-1h"},{"level":3,"text":"Phase 5: Redis Token-Bucket Rate Limiter with 429 + Retry-After (1.5–2h)","id":"phase-5-redis-token-bucket-rate-limiter-with-429-retry-after-152h"},{"level":3,"text":"Phase 6: Circuit Breaker State Machine (2–2.5h)","id":"phase-6-circuit-breaker-state-machine-225h"},{"level":3,"text":"Phase 7: End-to-End Integration Test (1.5–2h)","id":"phase-7-end-to-end-integration-test-152h"},{"level":2,"text":"8. Test Specification","id":"8-test-specification"},{"level":3,"text":"8.1 Circuit Breaker Unit Tests (gateway_test.go)","id":"81-circuit-breaker-unit-tests-gateway_testgo"},{"level":3,"text":"8.2 Rate Limiter Unit Tests","id":"82-rate-limiter-unit-tests"},{"level":3,"text":"8.3 Router Unit Tests","id":"83-router-unit-tests"},{"level":3,"text":"8.4 Notification Consumer Unit Tests","id":"84-notification-consumer-unit-tests"},{"level":3,"text":"8.5 NotificationHandler Unit Tests","id":"85-notificationhandler-unit-tests"},{"level":3,"text":"8.6 End-to-End Integration Test Script (scripts/e2e_test.sh)","id":"86-end-to-end-integration-test-script-scriptse2e_testsh"},{"level":2,"text":"9. Performance Targets","id":"9-performance-targets"},{"level":3,"text":"9.1 go.mod Additions","id":"91-gomod-additions"},{"level":1,"text":"Project Structure: URL Shortener (Microservices)","id":"project-structure-url-shortener-microservices"},{"level":2,"text":"Directory Tree","id":"directory-tree"},{"level":2,"text":"Creation Order","id":"creation-order"},{"level":3,"text":"1. Project Scaffold (30 min)","id":"1-project-scaffold-30-min"},{"level":3,"text":"2. Shared Packages — Events and Logger (30 min)","id":"2-shared-packages-events-and-logger-30-min"},{"level":3,"text":"3. Infrastructure Config — docker-compose.yml (1–1.5h)","id":"3-infrastructure-config-docker-composeyml-115h"},{"level":3,"text":"4. Per-Service Foundations: db.go, redis.go, rabbitmq.go, health.go, config.go, main.go, Dockerfile (1.5–2h)","id":"4-per-service-foundations-dbgo-redisgo-rabbitmqgo-healthgo-configgo-maingo-dockerfile-152h"},{"level":3,"text":"5. Shared Auth Package (1h)","id":"5-shared-auth-package-1h"},{"level":3,"text":"6. User Service — Full Implementation (3–4h)","id":"6-user-service-full-implementation-34h"},{"level":3,"text":"7. URL Service — Full Implementation (6–8h)","id":"7-url-service-full-implementation-68h"},{"level":3,"text":"8. Analytics Service — Full Implementation (4–5h)","id":"8-analytics-service-full-implementation-45h"},{"level":3,"text":"9. Extended shared/logger (30 min)","id":"9-extended-sharedlogger-30-min"},{"level":3,"text":"10. Notification Service — Full Implementation (2–3h)","id":"10-notification-service-full-implementation-23h"},{"level":3,"text":"11. API Gateway — Full Implementation (4–5h)","id":"11-api-gateway-full-implementation-45h"},{"level":2,"text":"File Count Summary","id":"file-count-summary"}],"title":"URL Shortener — Engineering Design Document","markdown":"# URL Shortener — Engineering Design Document\n\n## System Purpose\n\nFive independently deployable Go services (four domain services plus a gateway) implement a production-grade URL shortener: accepting long URLs, generating collision-resistant 7-character base62 short codes, serving sub-millisecond redirects via a Redis read-through cache, and delivering asynchronous side-effects (click analytics, milestone notifications) through a RabbitMQ topic exchange. The system uses URL shortening as a deliberately narrow domain so that every architectural boundary—service ownership, event flow, cache semantics, auth propagation—is unambiguous and verifiable in isolation.\n\n## Service Map\n\n| Service | Port | Responsibility | DB | Owns Events |\n|---|---|---|---|---|\n| api-gateway | 8080 | JWT validation, per-IP token-bucket rate limiting, circuit breaker, correlation ID injection, reverse proxy routing | Redis (rate-limit counters) | None |\n| url-service | 8081 | Shorten, redirect (read-through cache), list/delete URLs, outbox worker pool | url_db (PostgreSQL) | URLCreatedEvent, URLClickedEvent, URLDeletedEvent |\n| user-service | 8082 | Registration, bcrypt password hashing, HS256 JWT issuance; exports shared/auth package consumed by all services | user_db (PostgreSQL) | None |\n| analytics-service | 8083 | Sequential URLClickedEvent consumer with event-ID deduplication, click aggregation, milestone detection, public stats API | analytics_db (PostgreSQL) | MilestoneReachedEvent |\n| notification-service | 8084 | Consumes url.created / url.deleted / milestone.reached events, persists notification rows, logs mock email delivery | notification_db (PostgreSQL) | None |\n\n## Tech Stack\n\n- **Language:** Go 1.23 — stdlib `net/http`, `log/slog`, `crypto/rand`, `math/big`; no HTTP framework\n- **Message broker:** RabbitMQ 3.13 — single topic exchange `url-shortener`; durable queues `analytics.clicks` and `notifications.events`\n- **Databases:** PostgreSQL 16 — one container per service (host ports 5432–5435); `pgx/v5` with `pgxpool`\n- **Cache / rate-limit store:** Redis 7 — ephemeral, no persistence; `go-redis/v9`\n- **Auth:** HS256 JWT via `golang-jwt/jwt/v5`; verified locally by each service from a shared `JWT_SECRET` — no inter-service auth calls\n- **Containerization:** Docker Compose with per-service `depends_on: condition: service_healthy` gates; Go workspace (`go.work`) monorepo\n\n## Key Design Decisions\n\n- **Outbox pattern over direct AMQP publish:** URL mutations (create, click, delete) write the domain event into the `outbox` table within the same PostgreSQL transaction as the URL row change. A background coordinator (1 goroutine) polls every 2 seconds and fans out to 3 worker goroutines for publish. This decouples redirect latency from broker availability and prevents silent event loss on AMQP channel failure; `FOR UPDATE SKIP LOCKED` makes the poller safe against accidental dual-coordinator scenarios.\n- **Redis as non-authoritative accelerator:** The redirect hot path attempts a Redis `GET` with a 50 ms timeout; any error or miss falls through to PostgreSQL. Redis holds no data that is not already durable in Postgres. A 410-triggering deactivation immediately invalidates the Redis key after committing the SQL update, keeping the cache consistent without distributed coordination.\n- **Database isolation enforced at the container level:** Each service is given its own PostgreSQL container. Cross-service joins are physically impossible, not merely policy-prohibited. Service boundaries are therefore enforceable in tests without process-level mocking.\n- **Gateway as stateless infrastructure:** The gateway imports no domain packages (`shared/events` is explicitly excluded). It performs JWT HMAC verification locally, runs a `sync.Mutex`-guarded three-state circuit breaker (CLOSED → OPEN → HALF_OPEN) exclusively on the url-service proxy path, and applies Redis INCR+EXPIRE token-bucket rate limiting per client IP. Domain ownership rules and business validation live solely in downstream services.\n- **Event payloads carry all consumer-needed context:** `URLCreatedEvent`, `URLDeletedEvent`, and `MilestoneReachedEvent` include `user_email` directly. The notification service never calls user-service to resolve an email address, eliminating a synchronous dependency and a failure mode.\n\n## Anti-Patterns Explicitly Avoided\n\n| Anti-Pattern | Mitigation |\n|---|---|\n| **Shared database** | Four separate PostgreSQL containers; no cross-service schema access at any layer |\n| **Synchronous call chain for analytics** | Analytics consumes `URLClickedEvent` from RabbitMQ; it never calls url-service to validate a short_code |\n| **God service** | Auth, URL lifecycle, analytics, and notifications are separate binaries with separate bounded contexts and separate databases |\n| **Chatty notification service** | All consumer-needed fields (user email, short code) are denormalized into event payloads at publish time |\n| **Redis as source of truth** | Every write goes to PostgreSQL first; Redis holds only TTL-bounded copies with a hard 1-hour cap |\n| **Algorithm confusion in JWT** | Token verifier checks `token.Method.(*jwt.SigningMethodHMAC)` before accepting the key, rejecting RS256 and `none` |\n\n---\n\n# TDD\n\nFive independently deployable Go binaries (4 services + 1 gateway) communicate via HTTP/JSON for synchronous reads and RabbitMQ topic exchange for asynchronous side effects. Each service owns a dedicated PostgreSQL instance. Redis serves dual roles: read-through URL cache in url-service and shared rate-limit counter store in the gateway. The outbox pattern guarantees at-least-once event delivery without distributed transactions. A circuit breaker state machine protects the redirect hot path. Correlation IDs propagate through both sync HTTP headers and async event payloads, enabling full cross-service trace reconstruction from structured JSON logs.\n\n<!-- TDD_MOD_ID: url-shortener-m1 -->\n\n# Foundation: Repo Layout, Shared Contracts, Local Dev Stack\n\n## **Module ID:** `url-shortener-m1`\n\n## 1. Module Charter\n\n## This module establishes the entire structural foundation that every subsequent milestone builds upon. It creates the monorepo directory layout, writes one `go.mod` per service, authors the `docker-compose.yml` that defines the full container mesh (4 PostgreSQL instances, 1 RabbitMQ, 1 Redis, 4 app services, 1 gateway stub), defines the canonical domain event Go structs in `shared/events`, provides a structured-JSON logger stub in `shared/logger`, and wires each service to its own database via `pgxpool` with correct pool sizing. It does **not** implement any business logic, URL shortening, authentication, message publishing, or consumer loops. The only RabbitMQ work performed here is topology declaration (exchange + queue + binding) on startup — no messages are produced or consumed. The only HTTP surface exposed is `/health` on each service. Every invariant established here — one database per service, Redis as optional cache (never authoritative), RabbitMQ connection with retry-backoff, fatal exit on missing required config — must never be violated by later milestones. This module is complete when `docker compose up` brings all containers to a healthy state within 60 seconds and every `/health` endpoint returns 200\n\n## 2. File Structure\n\nCreate files in the numbered order below. This ordering ensures dependencies (shared packages) exist before services import them.\n\n```\nurl-shortener/                          ← monorepo root\n│\n├── 1.  go.work                         ← Go workspace file tying all modules\n│\n├── shared/\n│   ├── events/\n│   │   ├── 2.  events.go               ← all domain event structs\n│   │   └── 3.  go.mod                  ← module: github.com/yourhandle/url-shortener/shared/events\n│   └── logger/\n│       ├── 4.  logger.go               ← structured JSON logger\n│       └── 5.  go.mod                  ← module: github.com/yourhandle/url-shortener/shared/logger\n│\n├── services/\n│   ├── url-service/\n│   │   ├── 6.  go.mod                  ← module: github.com/yourhandle/url-shortener/url-service\n│   │   ├── 7.  main.go\n│   │   ├── 8.  config.go\n│   │   ├── 9.  db.go\n│   │   ├── 10. redis.go\n│   │   ├── 11. rabbitmq.go\n│   │   ├── 12. health.go\n│   │   └── 13. Dockerfile\n│   │\n│   ├── analytics-service/\n│   │   ├── 14. go.mod\n│   │   ├── 15. main.go\n│   │   ├── 16. config.go\n│   │   ├── 17. db.go\n│   │   ├── 18. rabbitmq.go\n│   │   ├── 19. health.go\n│   │   └── 20. Dockerfile\n│   │\n│   ├── user-service/\n│   │   ├── 21. go.mod\n│   │   ├── 22. main.go\n│   │   ├── 23. config.go\n│   │   ├── 24. db.go\n│   │   ├── 25. health.go\n│   │   └── 26. Dockerfile\n│   │\n│   └── notification-service/\n│       ├── 27. go.mod\n│       ├── 28. main.go\n│       ├── 29. config.go\n│       ├── 30. db.go\n│       ├── 31. rabbitmq.go\n│       ├── 32. health.go\n│       └── 33. Dockerfile\n│\n├── gateway/\n│   ├── 34. go.mod                      ← module: github.com/yourhandle/url-shortener/gateway\n│   ├── 35. main.go                     ← stub: /health only\n│   ├── 36. config.go\n│   ├── 37. health.go\n│   └── 38. Dockerfile\n│\n├── 39. docker-compose.yml\n└── 40. README.md\n```\n\n---\n\n## 3. Complete Data Model\n\n### 3.1 Domain Event Structs (`shared/events/events.go`)\n\nAll events share a common header. Each event is serialized to JSON when placed in RabbitMQ message bodies. The `EventType` string is the RabbitMQ routing key.\n\n```go\npackage events\nimport (\n    \"time\"\n)\n// EventType constants — these are also the RabbitMQ routing keys.\nconst (\n    EventTypeURLCreated      = \"url.created\"\n    EventTypeURLClicked      = \"url.clicked\"\n    EventTypeURLDeleted      = \"url.deleted\"\n    EventTypeMilestoneReached = \"milestone.reached\"\n)\n// BaseEvent carries fields present on every domain event.\n// Embedding this in concrete events guarantees envelope consistency.\ntype BaseEvent struct {\n    EventType     string    `json:\"event_type\"`      // routing key literal\n    OccurredAt    time.Time `json:\"occurred_at\"`     // UTC wall clock at event creation\n    CorrelationID string    `json:\"correlation_id\"`  // propagated from HTTP X-Correlation-ID header\n    EventID       string    `json:\"event_id\"`        // UUID v4, used for idempotency dedup\n}\n// URLCreatedEvent is published by url-service after a new short URL is persisted.\n// Includes user email so notification-service never needs to call user-service.\ntype URLCreatedEvent struct {\n    BaseEvent\n    ShortCode   string    `json:\"short_code\"`\n    OriginalURL string    `json:\"original_url\"`\n    UserID      string    `json:\"user_id\"`   // UUID string\n    UserEmail   string    `json:\"user_email\"`\n    ExpiresAt   *time.Time `json:\"expires_at,omitempty\"`\n}\n// URLClickedEvent is published by url-service on every successful redirect.\n// Analytics-service is the primary consumer; milestone checks happen there.\ntype URLClickedEvent struct {\n    BaseEvent\n    ShortCode   string `json:\"short_code\"`\n    IPHash      string `json:\"ip_hash\"`    // SHA-256(IP+salt), never raw IP\n    UserAgent   string `json:\"user_agent\"`\n    Referer     string `json:\"referer,omitempty\"`\n    ClickedAt   time.Time `json:\"clicked_at\"` // duplicates OccurredAt for query clarity\n}\n// URLDeletedEvent is published by url-service when is_active set to false.\ntype URLDeletedEvent struct {\n    BaseEvent\n    ShortCode string `json:\"short_code\"`\n    UserID    string `json:\"user_id\"`\n    UserEmail string `json:\"user_email\"` // for notification-service, avoids callback\n}\n// MilestoneReachedEvent is published by analytics-service when a click\n// threshold (10, 100, 1000) is crossed for a short code.\ntype MilestoneReachedEvent struct {\n    BaseEvent\n    ShortCode   string `json:\"short_code\"`\n    UserID      string `json:\"user_id\"`\n    UserEmail   string `json:\"user_email\"` // denormalized; analytics stores from URLClickedEvent context\n    MilestoneN  int    `json:\"milestone\"`  // 10 | 100 | 1000\n    TotalClicks int64  `json:\"total_clicks\"`\n}\n```\n\n**Why each field exists:**\n\n- `EventID` (UUID): deduplication key for idempotent consumers; without it, at-least-once delivery causes double-counting.\n- `CorrelationID`: cross-service trace continuity through async boundary; must survive the message broker hop.\n- `UserEmail` on mutation events: prevents notification-service from calling user-service (avoids chatty service anti-pattern and sync coupling).\n- `ClickedAt` on `URLClickedEvent`: mirrors `OccurredAt` with explicit semantic name; PostgreSQL `date_trunc` queries use this column directly.\n\n### 3.2 Per-Service Config Structs\n\nEach service has its own `config.go`. All fields are populated once at startup from environment variables. `os.Getenv` is **never** called in handler or hot-path code.\n\n```go\n// services/url-service/config.go\npackage urlservice\ntype Config struct {\n    DatabaseURL string // required; fatal if empty\n    RedisURL    string // required; non-fatal if unreachable\n    RabbitMQURL string // required; retry with backoff\n    Port        string // default \"8080\"\n    ServiceName string // constant \"url-service\"\n}\nfunc loadConfig() (*Config, error) {\n    cfg := &Config{\n        DatabaseURL: os.Getenv(\"DATABASE_URL\"),\n        RedisURL:    os.Getenv(\"REDIS_URL\"),\n        RabbitMQURL: os.Getenv(\"RABBITMQ_URL\"),\n        Port:        envOrDefault(\"PORT\", \"8080\"),\n        ServiceName: \"url-service\",\n    }\n    if cfg.DatabaseURL == \"\" {\n        return nil, fmt.Errorf(\"DATABASE_URL is required\")\n    }\n    if cfg.RabbitMQURL == \"\" {\n        return nil, fmt.Errorf(\"RABBITMQ_URL is required\")\n    }\n    if cfg.RedisURL == \"\" {\n        return nil, fmt.Errorf(\"REDIS_URL is required\") // required env var; non-fatal only if *connection* fails\n    }\n    return cfg, nil\n}\nfunc envOrDefault(key, def string) string {\n    if v := os.Getenv(key); v != \"\" {\n        return v\n    }\n    return def\n}\n```\n\n```go\n// services/analytics-service/config.go\npackage analytics\ntype Config struct {\n    DatabaseURL string\n    RabbitMQURL string\n    Port        string\n    ServiceName string\n}\n// services/user-service/config.go\npackage userservice\ntype Config struct {\n    DatabaseURL string\n    Port        string\n    ServiceName string\n}\n// services/notification-service/config.go\npackage notification\ntype Config struct {\n    DatabaseURL string\n    RabbitMQURL string\n    Port        string\n    ServiceName string\n}\n// gateway/config.go\npackage gateway\ntype Config struct {\n    URLServiceURL          string // e.g. http://url-service:8080\n    AnalyticsServiceURL    string\n    UserServiceURL         string\n    NotificationServiceURL string\n    RedisURL               string\n    Port                   string\n    ServiceName            string\n}\n```\n\nFor services without Redis or RabbitMQ, those fields simply do not exist in the config struct.\n\n### 3.3 Health Response Schema\n\n```go\ntype HealthResponse struct {\n    Status  string `json:\"status\"`  // always \"ok\"\n    Service string `json:\"service\"` // service name constant\n}\n```\n\n### 3.4 RabbitMQ Topology\n\n```\nExchange: \"url-shortener\"   type: topic   durable: true   autoDelete: false\nQueue: \"analytics.clicks\"\n  binding: exchange=\"url-shortener\"  routing_key=\"url.clicked\"  durable: true\nQueue: \"notifications.events\"\n  binding: exchange=\"url-shortener\"  routing_key=\"url.created\"  durable: true\n  binding: exchange=\"url-shortener\"  routing_key=\"url.deleted\"  durable: true\n  binding: exchange=\"url-shortener\"  routing_key=\"milestone.reached\"  durable: true\n```\n\n![Monorepo Directory Tree](./diagrams/tdd-diag-1.svg)\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                    RabbitMQ Broker                              │\n│                                                                 │\n│   Exchange: \"url-shortener\" (topic, durable)                    │\n│       │                                                         │\n│       ├─── routing_key: \"url.clicked\" ──────► Queue:           │\n│       │                                       \"analytics.clicks\"│\n│       │                                                         │\n│       ├─── routing_key: \"url.created\" ──────► Queue:           │\n│       │                                       \"notifications.   │\n│       ├─── routing_key: \"url.deleted\" ──────►  events\"          │\n│       │                                                         │\n│       └─── routing_key: \"milestone.reached\" ─►  (same queue)   │\n└─────────────────────────────────────────────────────────────────┘\nDeclaration responsibility:\n  url-service:            declares exchange \"url-shortener\"\n  analytics-service:      declares queue \"analytics.clicks\" + binding\n  notification-service:   declares queue \"notifications.events\" + all 3 bindings\n```\n\n---\n\n## 4. Interface Contracts\n\n### 4.1 `shared/logger` Package\n\n```go\npackage logger\nimport (\n    \"log/slog\"\n    \"os\"\n)\n// New returns a *slog.Logger writing JSON to stdout.\n// serviceName is embedded in every log record as \"service\" field.\n// This is the ONLY logger constructor that should be used across all services.\nfunc New(serviceName string) *slog.Logger\n// Usage pattern (all services):\n//   log := logger.New(\"url-service\")\n//   log.Info(\"connected to DB\", \"host\", \"url_db:5432\")\n//   log.Error(\"startup failure\", \"error\", err)\n```\n\n**Implementation detail:** Use `slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{Level: slog.LevelInfo})`. Wrap with `slog.New`. Add `serviceName` as a default attribute via `logger.With(\"service\", serviceName)`. The returned logger is safe for concurrent use (slog guarantees this).\n**Fields emitted in every log line:**\n\n| Field | Type | Source |\n|---|---|---|\n| `time` | RFC3339Nano | slog default |\n| `level` | string | slog default |\n| `service` | string | constructor arg |\n| `msg` | string | log call |\n| any extras | varies | per log call |\n\n### 4.2 DB Connection Factory\n\n```go\n// db.go (per service — same pattern, different pool owner)\npackage urlservice\nimport (\n    \"context\"\n    \"fmt\"\n    \"github.com/jackc/pgx/v5/pgxpool\"\n)\n// NewDBPool creates a pgxpool with project-standard settings.\n// Returns fatal error if the pool cannot ping the DB within 10s.\n//\n// Parameters:\n//   ctx        - a context with a 10-second timeout applied internally\n//   databaseURL - postgres:// DSN from config\n//   log        - structured logger for startup messages\n//\n// Returns:\n//   *pgxpool.Pool - ready pool, caller must call .Close() on shutdown\n//   error         - non-nil if DB unreachable; caller must os.Exit(1)\nfunc NewDBPool(ctx context.Context, databaseURL string, log *slog.Logger) (*pgxpool.Pool, error) {\n    cfg, err := pgxpool.ParseConfig(databaseURL)\n    if err != nil {\n        return nil, fmt.Errorf(\"parse db url: %w\", err)\n    }\n    cfg.MaxConns = 10\n    cfg.MinConns = 2\n    pool, err := pgxpool.NewWithConfig(ctx, cfg)\n    if err != nil {\n        return nil, fmt.Errorf(\"create pool: %w\", err)\n    }\n    pingCtx, cancel := context.WithTimeout(ctx, 10*time.Second)\n    defer cancel()\n    if err := pool.Ping(pingCtx); err != nil {\n        pool.Close()\n        return nil, fmt.Errorf(\"ping db: %w\", err)\n    }\n    log.Info(\"connected to DB\", \"max_conns\", cfg.MaxConns, \"min_conns\", cfg.MinConns)\n    return pool, nil\n}\n```\n\n**Error contract:**\n\n- If `pgxpool.ParseConfig` fails → return error immediately, do not attempt connection.\n- If `pool.Ping` times out or is refused → close pool, return wrapped error.\n- Caller in `main.go` must call `log.Error(...); os.Exit(1)` on non-nil return.\n\n### 4.3 Redis Connection Factory (url-service only)\n\n```go\n// redis.go — url-service only\npackage urlservice\nimport (\n    \"context\"\n    \"fmt\"\n    \"time\"\n    \"github.com/redis/go-redis/v9\"\n)\n// NewRedisClient creates a Redis client and pings the server.\n// UNLIKE the DB pool, a failed ping here is NON-FATAL.\n// The function always returns a *redis.Client (usable even if server is down).\n// The bool return indicates whether the initial ping succeeded.\n//\n// Parameters:\n//   ctx      - used for initial ping only\n//   redisURL - redis://host:port/0 DSN\n//   log      - structured logger\n//\n// Returns:\n//   *redis.Client - always non-nil; configured client\n//   bool          - true if initial ping succeeded, false otherwise\nfunc NewRedisClient(ctx context.Context, redisURL string, log *slog.Logger) (*redis.Client, bool) {\n    opts, err := redis.ParseURL(redisURL)\n    if err != nil {\n        log.Warn(\"redis URL parse failed, cache disabled\", \"error\", err)\n        return redis.NewClient(&redis.Options{Addr: \"localhost:6379\"}), false\n    }\n    client := redis.NewClient(opts)\n    pingCtx, cancel := context.WithTimeout(ctx, 3*time.Second)\n    defer cancel()\n    if err := client.Ping(pingCtx).Err(); err != nil {\n        log.Warn(\"redis unreachable on startup, cache will be disabled until available\", \"error\", err)\n        return client, false\n    }\n    log.Info(\"connected to Redis cache\", \"addr\", opts.Addr)\n    return client, true\n}\n```\n\n**Critical:** The Redis client is returned regardless of ping success. Later cache operations must each independently handle errors (wrap in a helper that logs and continues).\n\n### 4.4 RabbitMQ Connection Factory\n\n```go\n// rabbitmq.go (url-service, analytics-service, notification-service)\npackage urlservice\nimport (\n    \"context\"\n    \"fmt\"\n    \"time\"\n    amqp \"github.com/rabbitmq/amqp091-go\"\n)\nconst (\n    exchangeName = \"url-shortener\"\n    exchangeType = \"topic\"\n)\n// RabbitMQConn wraps an AMQP connection and channel.\ntype RabbitMQConn struct {\n    Conn    *amqp.Connection\n    Channel *amqp.Channel\n}\n// NewRabbitMQConn connects to RabbitMQ with exponential backoff.\n// Retries up to maxAttempts times before returning error.\n// Each attempt is logged. On success, declares the exchange.\n//\n// Parameters:\n//   ctx         - for cancellation during retry loop\n//   amqpURL     - amqp://user:pass@host:5672/\n//   log         - structured logger\n//   maxAttempts - typically 10 for startup; backoff doubles each retry (1s→2s→4s...max 30s)\n//\n// Returns:\n//   *RabbitMQConn - connected and channel-open; caller owns Close()\n//   error         - non-nil after maxAttempts exhausted\nfunc NewRabbitMQConn(ctx context.Context, amqpURL string, log *slog.Logger, maxAttempts int) (*RabbitMQConn, error) {\n    var conn *amqp.Connection\n    var err error\n    backoff := time.Second\n    for attempt := 1; attempt <= maxAttempts; attempt++ {\n        conn, err = amqp.Dial(amqpURL)\n        if err == nil {\n            break\n        }\n        log.Warn(\"rabbitmq connection attempt failed\",\n            \"attempt\", attempt,\n            \"max_attempts\", maxAttempts,\n            \"backoff_seconds\", backoff.Seconds(),\n            \"error\", err,\n        )\n        select {\n        case <-ctx.Done():\n            return nil, fmt.Errorf(\"context cancelled during rabbitmq connect: %w\", ctx.Err())\n        case <-time.After(backoff):\n        }\n        backoff = min(backoff*2, 30*time.Second)\n    }\n    if err != nil {\n        return nil, fmt.Errorf(\"rabbitmq connect after %d attempts: %w\", maxAttempts, err)\n    }\n    ch, err := conn.Channel()\n    if err != nil {\n        conn.Close()\n        return nil, fmt.Errorf(\"open rabbitmq channel: %w\", err)\n    }\n    if err := declareExchange(ch); err != nil {\n        ch.Close()\n        conn.Close()\n        return nil, fmt.Errorf(\"declare exchange: %w\", err)\n    }\n    log.Info(\"connected to RabbitMQ\", \"exchange\", exchangeName)\n    return &RabbitMQConn{Conn: conn, Channel: ch}, nil\n}\nfunc declareExchange(ch *amqp.Channel) error {\n    return ch.ExchangeDeclare(\n        exchangeName, // name\n        exchangeType, // kind: \"topic\"\n        true,         // durable\n        false,        // autoDelete\n        false,        // internal\n        false,        // noWait\n        nil,          // args\n    )\n}\n// Close shuts down channel then connection in correct order.\nfunc (r *RabbitMQConn) Close() {\n    if r.Channel != nil {\n        r.Channel.Close()\n    }\n    if r.Conn != nil {\n        r.Conn.Close()\n    }\n}\n```\n\n### 4.5 Queue/Binding Declaration (Consumer Services)\n\n```go\n// analytics-service rabbitmq.go — additional function after NewRabbitMQConn\nfunc DeclareAnalyticsQueue(ch *amqp.Channel) error {\n    q, err := ch.QueueDeclare(\n        \"analytics.clicks\", // name\n        true,               // durable\n        false,              // autoDelete\n        false,              // exclusive\n        false,              // noWait\n        nil,                // args\n    )\n    if err != nil {\n        return fmt.Errorf(\"declare analytics.clicks queue: %w\", err)\n    }\n    if err := ch.QueueBind(\n        q.Name,        // queue name\n        \"url.clicked\", // routing key\n        exchangeName,  // exchange\n        false,         // noWait\n        nil,           // args\n    ); err != nil {\n        return fmt.Errorf(\"bind analytics.clicks to url.clicked: %w\", err)\n    }\n    return nil\n}\n// notification-service rabbitmq.go\nfunc DeclareNotificationQueue(ch *amqp.Channel) error {\n    q, err := ch.QueueDeclare(\n        \"notifications.events\",\n        true, false, false, false, nil,\n    )\n    if err != nil {\n        return fmt.Errorf(\"declare notifications.events queue: %w\", err)\n    }\n    for _, routingKey := range []string{\"url.created\", \"url.deleted\", \"milestone.reached\"} {\n        if err := ch.QueueBind(q.Name, routingKey, exchangeName, false, nil); err != nil {\n            return fmt.Errorf(\"bind notifications.events to %s: %w\", routingKey, err)\n        }\n    }\n    return nil\n}\n```\n\n**Error contract for consumer services:** If queue/binding declaration fails, it is **fatal**. The consumer service cannot function without its queue. Call `log.Error(...); os.Exit(1)`.\n\n### 4.6 Health Handler\n\n```go\n// health.go (same pattern all services; serviceName differs)\npackage urlservice\nimport (\n    \"encoding/json\"\n    \"net/http\"\n)\ntype HealthResponse struct {\n    Status  string `json:\"status\"`\n    Service string `json:\"service\"`\n}\n// NewHealthHandler returns an http.HandlerFunc for GET /health.\n// No authentication required. Responds in < 10ms.\n// Does NOT check DB connectivity on every request (too expensive).\nfunc NewHealthHandler(serviceName string) http.HandlerFunc {\n    resp := HealthResponse{Status: \"ok\", Service: serviceName}\n    body, _ := json.Marshal(resp) // pre-encoded; never changes\n    return func(w http.ResponseWriter, r *http.Request) {\n        w.Header().Set(\"Content-Type\", \"application/json\")\n        w.WriteHeader(http.StatusOK)\n        w.Write(body)\n    }\n}\n```\n\n## **Why pre-encode:** The response never changes during the process lifetime. Encoding once at startup avoids per-request allocation. `json.Marshal` on this tiny struct cannot fail (no custom marshalers, no channels/funcs)\n\n## 5. Algorithm Specification\n\n### 5.1 Startup Sequence — url-service (most complex; others are subsets)\n\n```\n1. loadConfig()\n   → if any required env var is empty: log.Error + os.Exit(1)\n2. log := logger.New(cfg.ServiceName)\n   → all subsequent log calls use this logger\n3. pool, err := NewDBPool(ctx, cfg.DatabaseURL, log)\n   → if err != nil: log.Error(\"db unreachable\", \"error\", err); os.Exit(1)\n   → if ok: log(\"connected to DB\") already emitted inside factory\n4. redisClient, _ := NewRedisClient(ctx, cfg.RedisURL, log)\n   → warning already logged inside factory; continue regardless\n5. mq, err := NewRabbitMQConn(ctx, cfg.RabbitMQURL, log, maxAttempts=10)\n   → if err != nil: log.Error + os.Exit(1)\n   → exchange declared inside factory\n6. Register HTTP routes:\n   mux := http.NewServeMux()\n   mux.HandleFunc(\"GET /health\", NewHealthHandler(cfg.ServiceName))\n7. Start HTTP server on cfg.Port\n   → log.Info(\"server listening\", \"port\", cfg.Port)\n8. Block on server.ListenAndServe() or OS signal\n   → on SIGTERM/SIGINT: pool.Close(), mq.Close(), redisClient.Close()\n```\n\n### 5.2 Startup Sequence — analytics-service\n\nSteps 1-5 as url-service except:\n\n- No Redis (step 4 omitted)\n- After step 5 (RabbitMQ connected), call `DeclareAnalyticsQueue(mq.Channel)`\n  - If error: log.Error + os.Exit(1)\n\n### 5.3 Startup Sequence — notification-service\n\nSame as analytics-service but calls `DeclareNotificationQueue(mq.Channel)` instead.\n\n### 5.4 Startup Sequence — user-service\n\nSteps 1 (DATABASE_URL required, no RABBITMQ_URL), 2, 3, 6, 7, 8 only. No Redis, no RabbitMQ.\n\n### 5.5 Startup Sequence — gateway (stub)\n\nSteps 1 (requires URLServiceURL, AnalyticsServiceURL, UserServiceURL, NotificationServiceURL), 2, 6, 7, 8. Registers `/health` only at this milestone.\n\n![Docker Compose Container Topology](./diagrams/tdd-diag-2.svg)\n\n```\nurl-service startup:\n  ┌──────────┐  ┌────────┐  ┌───────┐  ┌─────────┐  ┌────────┐\n  │loadConfig│→ │DB ping │→ │Redis  │→ │RabbitMQ │→ │HTTP    │\n  │          │  │(fatal) │  │ping   │  │connect  │→ │server  │\n  └──────────┘  └────────┘  │(warn) │  │+ exch   │  │listen  │\n                             └───────┘  │(fatal)  │  └────────┘\n                                        └─────────┘\nanalytics/notification startup:\n  loadConfig → DB ping (fatal) → RabbitMQ connect (fatal) → queue declare (fatal) → HTTP\nuser-service startup:\n  loadConfig → DB ping (fatal) → HTTP\ngateway startup:\n  loadConfig → HTTP (health only for now)\n```\n\n---\n\n## 6. Docker Compose Specification\n\n### 6.1 Complete `docker-compose.yml`\n\n```yaml\nversion: \"3.9\"\nnetworks:\n  url-shortener:\n    driver: bridge\nvolumes:\n  url_db_data:\n  analytics_db_data:\n  user_db_data:\n  notification_db_data:\n  rabbitmq_data:\n  redis_data:\nservices:\n  # ── Databases ────────────────────────────────────────────────────────────────\n  url_db:\n    image: postgres:16-alpine\n    environment:\n      POSTGRES_DB: urldb\n      POSTGRES_USER: urluser\n      POSTGRES_PASSWORD: urlpass\n    ports:\n      - \"5432:5432\"\n    volumes:\n      - url_db_data:/var/lib/postgresql/data\n    networks:\n      - url-shortener\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U urluser -d urldb\"]\n      interval: 5s\n      timeout: 5s\n      retries: 10\n      start_period: 10s\n  analytics_db:\n    image: postgres:16-alpine\n    environment:\n      POSTGRES_DB: analyticsdb\n      POSTGRES_USER: analyticsuser\n      POSTGRES_PASSWORD: analyticspass\n    ports:\n      - \"5433:5432\"\n    volumes:\n      - analytics_db_data:/var/lib/postgresql/data\n    networks:\n      - url-shortener\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U analyticsuser -d analyticsdb\"]\n      interval: 5s\n      timeout: 5s\n      retries: 10\n      start_period: 10s\n  user_db:\n    image: postgres:16-alpine\n    environment:\n      POSTGRES_DB: userdb\n      POSTGRES_USER: useruser\n      POSTGRES_PASSWORD: userpass\n    ports:\n      - \"5434:5432\"\n    volumes:\n      - user_db_data:/var/lib/postgresql/data\n    networks:\n      - url-shortener\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U useruser -d userdb\"]\n      interval: 5s\n      timeout: 5s\n      retries: 10\n      start_period: 10s\n  notification_db:\n    image: postgres:16-alpine\n    environment:\n      POSTGRES_DB: notificationdb\n      POSTGRES_USER: notificationuser\n      POSTGRES_PASSWORD: notificationpass\n    ports:\n      - \"5435:5432\"\n    volumes:\n      - notification_db_data:/var/lib/postgresql/data\n    networks:\n      - url-shortener\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U notificationuser -d notificationdb\"]\n      interval: 5s\n      timeout: 5s\n      retries: 10\n      start_period: 10s\n  # ── Message Broker ───────────────────────────────────────────────────────────\n  rabbitmq:\n    image: rabbitmq:3.13-management-alpine\n    environment:\n      RABBITMQ_DEFAULT_USER: guest\n      RABBITMQ_DEFAULT_PASS: guest\n    ports:\n      - \"5672:5672\" # AMQP\n      - \"15672:15672\" # Management UI\n    volumes:\n      - rabbitmq_data:/var/lib/rabbitmq\n    networks:\n      - url-shortener\n    healthcheck:\n      test: [\"CMD\", \"rabbitmq-diagnostics\", \"ping\"]\n      interval: 10s\n      timeout: 10s\n      retries: 10\n      start_period: 20s\n  # ── Cache ────────────────────────────────────────────────────────────────────\n  redis:\n    image: redis:7-alpine\n    command: redis-server --save \"\" --appendonly no # ephemeral; cache only\n    ports:\n      - \"6379:6379\"\n    volumes:\n      - redis_data:/data\n    networks:\n      - url-shortener\n    healthcheck:\n      test: [\"CMD\", \"redis-cli\", \"ping\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n  # ── Application Services ─────────────────────────────────────────────────────\n  url-service:\n    build:\n      context: ./services/url-service\n      dockerfile: Dockerfile\n    environment:\n      DATABASE_URL: postgres://urluser:urlpass@url_db:5432/urldb\n      REDIS_URL: redis://redis:6379/0\n      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/\n      PORT: \"8080\"\n    ports:\n      - \"8081:8080\"\n    networks:\n      - url-shortener\n    depends_on:\n      url_db:\n        condition: service_healthy\n      redis:\n        condition: service_healthy\n      rabbitmq:\n        condition: service_healthy\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:8080/health || exit 1\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n      start_period: 15s\n  analytics-service:\n    build:\n      context: ./services/analytics-service\n      dockerfile: Dockerfile\n    environment:\n      DATABASE_URL: postgres://analyticsuser:analyticspass@analytics_db:5432/analyticsdb\n      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/\n      PORT: \"8080\"\n    ports:\n      - \"8082:8080\"\n    networks:\n      - url-shortener\n    depends_on:\n      analytics_db:\n        condition: service_healthy\n      rabbitmq:\n        condition: service_healthy\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:8080/health || exit 1\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n      start_period: 15s\n  user-service:\n    build:\n      context: ./services/user-service\n      dockerfile: Dockerfile\n    environment:\n      DATABASE_URL: postgres://useruser:userpass@user_db:5432/userdb\n      PORT: \"8080\"\n    ports:\n      - \"8083:8080\"\n    networks:\n      - url-shortener\n    depends_on:\n      user_db:\n        condition: service_healthy\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:8080/health || exit 1\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n      start_period: 15s\n  notification-service:\n    build:\n      context: ./services/notification-service\n      dockerfile: Dockerfile\n    environment:\n      DATABASE_URL: postgres://notificationuser:notificationpass@notification_db:5432/notificationdb\n      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/\n      PORT: \"8080\"\n    ports:\n      - \"8084:8080\"\n    networks:\n      - url-shortener\n    depends_on:\n      notification_db:\n        condition: service_healthy\n      rabbitmq:\n        condition: service_healthy\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:8080/health || exit 1\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n      start_period: 15s\n  gateway:\n    build:\n      context: ./gateway\n      dockerfile: Dockerfile\n    environment:\n      URL_SERVICE_URL: http://url-service:8080\n      ANALYTICS_SERVICE_URL: http://analytics-service:8080\n      USER_SERVICE_URL: http://user-service:8080\n      NOTIFICATION_SERVICE_URL: http://notification-service:8080\n      PORT: \"8080\"\n    ports:\n      - \"8080:8080\"\n    networks:\n      - url-shortener\n    depends_on:\n      url-service:\n        condition: service_healthy\n      analytics-service:\n        condition: service_healthy\n      user-service:\n        condition: service_healthy\n      notification-service:\n        condition: service_healthy\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:8080/health || exit 1\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n      start_period: 20s\n```\n\n![Domain Event Struct Data Model](./diagrams/tdd-diag-3.svg)\n\n```\nPort mapping (host → container):\n  8080 → gateway\n  8081 → url-service\n  8082 → analytics-service\n  8083 → user-service\n  8084 → notification-service\n  5432 → url_db        (postgres)\n  5433 → analytics_db  (postgres)\n  5434 → user_db       (postgres)\n  5435 → notification_db (postgres)\n  5672 → rabbitmq      (AMQP)\n  15672→ rabbitmq      (management UI)\n  6379 → redis\ndepends_on chain (healthy gate):\n  gateway ← {url-service, analytics-service, user-service, notification-service}\n  url-service ← {url_db, redis, rabbitmq}\n  analytics-service ← {analytics_db, rabbitmq}\n  notification-service ← {notification_db, rabbitmq}\n  user-service ← {user_db}\n```\n\n### 6.2 Dockerfile (uniform across all services)\n\n```dockerfile\n# services/url-service/Dockerfile\nFROM golang:1.23-alpine AS builder\nWORKDIR /app\n# Copy go.work and all module go.mod/go.sum files first (cache layer)\nCOPY go.mod go.sum ./\n# Download dependencies\nRUN go mod download\n# Copy source\nCOPY . .\n# Build static binary\nRUN CGO_ENABLED=0 GOOS=linux go build -ldflags=\"-s -w\" -o /service ./...\nFROM scratch\nCOPY --from=builder /service /service\nEXPOSE 8080\nENTRYPOINT [\"/service\"]\n```\n\n**Note on go.work:** Because services share `shared/events` and `shared/logger`, the `go.work` file at root must list all modules so Docker build context resolves replace directives correctly. Copy the entire monorepo into each service's build context, or use a root-level multi-stage build. The simpler approach for this milestone: set Docker build context to monorepo root and specify Dockerfile path per service.\nRevised `docker-compose.yml` build section for monorepo:\n\n```yaml\nurl-service:\n  build:\n    context: . # monorepo root\n    dockerfile: services/url-service/Dockerfile\n```\n\nAnd corresponding Dockerfile modification to `WORKDIR /app` then `COPY . .` from root.\n\n### 6.3 Go Workspace (`go.work`)\n\n```\ngo 1.23\nuse (\n    ./shared/events\n    ./shared/logger\n    ./services/url-service\n    ./services/analytics-service\n    ./services/user-service\n    ./services/notification-service\n    ./gateway\n)\n```\n\nEach service `go.mod` references shared packages:\n\n```\n// services/url-service/go.mod\nmodule github.com/yourhandle/url-shortener/url-service\ngo 1.23\nrequire (\n    github.com/yourhandle/url-shortener/shared/events v0.0.0\n    github.com/yourhandle/url-shortener/shared/logger v0.0.0\n    github.com/jackc/pgx/v5 v5.6.0\n    github.com/redis/go-redis/v9 v9.6.0\n    github.com/rabbitmq/amqp091-go v1.10.0\n)\nreplace (\n    github.com/yourhandle/url-shortener/shared/events => ../../shared/events\n    github.com/yourhandle/url-shortener/shared/logger => ../../shared/logger\n)\n```\n\n---\n\n## 7. Error Handling Matrix\n\n| Error                                                 | Detected By                                          | Recovery                                      | User-Visible? | Exit?              |\n| ----------------------------------------------------- | ---------------------------------------------------- | --------------------------------------------- | ------------- | ------------------ |\n| Missing required env var (DATABASE_URL, RABBITMQ_URL) | `loadConfig()` at startup                            | Log descriptive message naming the variable   | No (pre-HTTP) | Yes (`os.Exit(1)`) |\n| DB unreachable at startup (`pool.Ping` timeout)       | `NewDBPool()`                                        | Log error with DSN host (mask password)       | No            | Yes (`os.Exit(1)`) |\n| DB DSN malformed                                      | `pgxpool.ParseConfig`                                | Log with raw error                            | No            | Yes (`os.Exit(1)`) |\n| Redis URL malformed                                   | `redis.ParseURL`                                     | Log warning, use default client, continue     | No            | No                 |\n| Redis unreachable at startup (`Ping` fail)            | `NewRedisClient()`                                   | Log warning, return client anyway             | No            | No                 |\n| RabbitMQ unreachable, within maxAttempts              | `amqp.Dial` in retry loop                            | Log each attempt with backoff duration, retry | No            | No (retrying)      |\n| RabbitMQ unreachable, maxAttempts exhausted           | `NewRabbitMQConn()`                                  | Log fatal                                     | No            | Yes (`os.Exit(1)`) |\n| Exchange declare failure                              | `declareExchange()`                                  | Log error                                     | No            | Yes (`os.Exit(1)`) |\n| Queue declare failure (consumer services)             | `DeclareAnalyticsQueue` / `DeclareNotificationQueue` | Log error                                     | No            | Yes (`os.Exit(1)`) |\n| Queue binding failure                                 | same functions                                       | Log error                                     | No            | Yes (`os.Exit(1)`) |\n| Context cancelled during RabbitMQ retry               | select in retry loop                                 | Return wrapped error                          | No            | Yes (caller exits) |\n| `/health` handler write error                         | `w.Write` return                                     | Ignored (client disconnected)                 | No            | No                 |\n\n**Password masking for DB DSN in logs:**\n\n```go\n// When logging the DSN in an error, strip credentials:\nfunc maskDSN(dsn string) string {\n    u, err := url.Parse(dsn)\n    if err != nil {\n        return \"[unparseable DSN]\"\n    }\n    u.User = url.User(\"***\")\n    return u.String()\n}\n```\n\n---\n\n## 8. Implementation Sequence with Checkpoints\n\n### Phase 1: Monorepo Scaffold and go.mod per Service (0.5–1h)\n\n1. Create directory tree exactly as shown in §2.\n2. Write `go.work` at root.\n3. Write `go.mod` for `shared/events` and `shared/logger` (no dependencies beyond stdlib for logger).\n4. Write `go.mod` for each service with the `require` + `replace` blocks.\n5. Run `go work sync` at root.\n   **Checkpoint:** `go build ./...` from monorepo root exits 0 (even with empty `main.go` stubs that just `package main; func main() {}`).\n\n### Phase 2: docker-compose.yml with All Containers (1–1.5h)\n\n1. Write `docker-compose.yml` as specified in §6.1.\n2. Verify `docker compose config` exits 0 (validates YAML syntax).\n3. Run `docker compose up rabbitmq redis url_db analytics_db user_db notification_db -d`.\n4. Check `docker compose ps` — all six infra containers show `healthy`.\n   **Checkpoint:** `docker compose ps` shows all infra containers in `healthy` state. `psql -h localhost -p 5432 -U urluser -d urldb -c '\\l'` connects. `redis-cli -p 6379 ping` returns `PONG`. RabbitMQ management UI reachable at `http://localhost:15672` (guest/guest).\n\n### Phase 3: shared/events and shared/logger (0.5h)\n\n1. Write `shared/events/events.go` exactly as §3.1.\n2. Write `shared/logger/logger.go`:\n\n```go\npackage logger\nimport (\n    \"log/slog\"\n    \"os\"\n)\nfunc New(serviceName string) *slog.Logger {\n    h := slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{\n        Level: slog.LevelInfo,\n    })\n    return slog.New(h).With(\"service\", serviceName)\n}\n```\n\n1. Run `go build github.com/yourhandle/url-shortener/shared/...` → exits 0.\n   **Checkpoint:** A throwaway `main.go` that imports `shared/logger`, calls `logger.New(\"test\").Info(\"hello\")`, and runs prints valid JSON to stdout: `{\"time\":\"...\",\"level\":\"INFO\",\"service\":\"test\",\"msg\":\"hello\"}`.\n\n### Phase 4: Per-Service Config, DB Pool, Redis, Health Handler (1–1.5h)\n\nFor each service in order (url-service → analytics-service → user-service → notification-service → gateway):\n\n1. Write `config.go` (Config struct + `loadConfig()`).\n2. Write `db.go` (`NewDBPool`).\n3. (url-service only) Write `redis.go` (`NewRedisClient`).\n4. Write `health.go` (`NewHealthHandler`).\n5. Wire in `main.go`:\n\n```go\n// services/url-service/main.go\npackage main\nimport (\n    \"context\"\n    \"fmt\"\n    \"net/http\"\n    \"os\"\n    \"os/signal\"\n    \"syscall\"\n    \"github.com/yourhandle/url-shortener/shared/logger\"\n)\nfunc main() {\n    cfg, err := loadConfig()\n    if err != nil {\n        // logger not yet initialized; use fmt\n        fmt.Fprintf(os.Stderr, \"config error: %v\\n\", err)\n        os.Exit(1)\n    }\n    log := logger.New(cfg.ServiceName)\n    ctx := context.Background()\n    pool, err := NewDBPool(ctx, cfg.DatabaseURL, log)\n    if err != nil {\n        log.Error(\"db unreachable\", \"error\", err)\n        os.Exit(1)\n    }\n    defer pool.Close()\n    redisClient, _ := NewRedisClient(ctx, cfg.RedisURL, log)\n    defer redisClient.Close()\n    mq, err := NewRabbitMQConn(ctx, cfg.RabbitMQURL, log, 10)\n    if err != nil {\n        log.Error(\"rabbitmq unreachable\", \"error\", err)\n        os.Exit(1)\n    }\n    defer mq.Close()\n    mux := http.NewServeMux()\n    mux.HandleFunc(\"GET /health\", NewHealthHandler(cfg.ServiceName))\n    srv := &http.Server{Addr: \":\" + cfg.Port, Handler: mux}\n    go func() {\n        log.Info(\"server listening\", \"port\", cfg.Port)\n        if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {\n            log.Error(\"server error\", \"error\", err)\n            os.Exit(1)\n        }\n    }()\n    quit := make(chan os.Signal, 1)\n    signal.Notify(quit, syscall.SIGTERM, syscall.SIGINT)\n    <-quit\n    log.Info(\"shutting down\")\n    srv.Shutdown(ctx)\n}\n```\n\n1. Build each service: `go build ./services/url-service/...` → exits 0.\n   **Checkpoint:** `go build ./...` from root exits 0 for all services. Each binary starts without panicking when environment variables are set.\n\n### Phase 5: RabbitMQ Exchange and Queue/Binding Declaration (0.5–1h)\n\n1. Complete `rabbitmq.go` in url-service (exchange declare already in `NewRabbitMQConn`).\n2. Write `DeclareAnalyticsQueue` in analytics-service `rabbitmq.go`.\n3. Write `DeclareNotificationQueue` in notification-service `rabbitmq.go`.\n4. Call declare functions in `main.go` of analytics-service and notification-service after `NewRabbitMQConn` returns.\n   **Checkpoint:** Run all four app services locally (with env vars pointing to Docker infra containers):\n\n```bash\nDATABASE_URL=... REDIS_URL=... RABBITMQ_URL=... go run ./services/url-service/\n```\n\nRabbitMQ management UI at `http://localhost:15672/#/exchanges` shows `url-shortener` exchange (type: topic, durable). `http://localhost:15672/#/queues` shows `analytics.clicks` and `notifications.events` queues with correct bindings.\n\n### Phase 6: Full docker compose up + README (0.5h)\n\n1. Write Dockerfiles as §6.2, ensuring build context is monorepo root.\n2. Update `docker-compose.yml` build contexts to `.` with explicit Dockerfile paths.\n3. Run `docker compose up --build -d`.\n4. Wait up to 60s then check `docker compose ps` — all containers `healthy`.\n5. Smoke test each `/health` endpoint:\n\n```bash\nfor port in 8080 8081 8082 8083 8084; do\n  echo -n \"Port $port: \"\n  curl -s http://localhost:$port/health\n  echo\ndone\n```\n\nExpected output for each:\n\n```json\n{ \"status\": \"ok\", \"service\": \"<service-name>\" }\n```\n\n1. Write `README.md` (§9).\n   **Checkpoint:** All five `/health` endpoints return 200 with correct `service` field. `docker compose down -v` tears down everything cleanly with exit 0. `docker compose up` again restores all to healthy.\n\n---\n\n## 9. Test Specification\n\n### 9.1 `shared/events` Package Tests\n\n```go\n// shared/events/events_test.go\npackage events_test\nimport (\n    \"encoding/json\"\n    \"testing\"\n    \"time\"\n    \"github.com/yourhandle/url-shortener/shared/events\"\n)\nfunc TestURLCreatedEvent_RoundTrip(t *testing.T) {\n    evt := events.URLCreatedEvent{\n        BaseEvent: events.BaseEvent{\n            EventType:     events.EventTypeURLCreated,\n            OccurredAt:    time.Now().UTC().Truncate(time.Millisecond),\n            CorrelationID: \"corr-123\",\n            EventID:       \"evt-456\",\n        },\n        ShortCode:   \"abc1234\",\n        OriginalURL: \"https://example.com/long/path\",\n        UserID:      \"user-uuid\",\n        UserEmail:   \"user@example.com\",\n    }\n    b, err := json.Marshal(evt)\n    if err != nil {\n        t.Fatalf(\"marshal: %v\", err)\n    }\n    var decoded events.URLCreatedEvent\n    if err := json.Unmarshal(b, &decoded); err != nil {\n        t.Fatalf(\"unmarshal: %v\", err)\n    }\n    if decoded.EventType != events.EventTypeURLCreated {\n        t.Errorf(\"event_type: got %q want %q\", decoded.EventType, events.EventTypeURLCreated)\n    }\n    if decoded.ShortCode != evt.ShortCode {\n        t.Errorf(\"short_code mismatch\")\n    }\n    if decoded.ExpiresAt != nil {\n        t.Errorf(\"nil expires_at should stay nil\")\n    }\n}\nfunc TestURLClickedEvent_OmitEmptyReferer(t *testing.T) {\n    evt := events.URLClickedEvent{\n        BaseEvent: events.BaseEvent{EventType: events.EventTypeURLClicked},\n        // Referer intentionally empty\n    }\n    b, _ := json.Marshal(evt)\n    var m map[string]any\n    json.Unmarshal(b, &m)\n    if _, ok := m[\"referer\"]; ok {\n        t.Error(\"referer should be omitted when empty\")\n    }\n}\nfunc TestEventTypeConstants(t *testing.T) {\n    // routing keys must match RabbitMQ binding keys exactly\n    cases := map[string]string{\n        events.EventTypeURLCreated:       \"url.created\",\n        events.EventTypeURLClicked:       \"url.clicked\",\n        events.EventTypeURLDeleted:       \"url.deleted\",\n        events.EventTypeMilestoneReached: \"milestone.reached\",\n    }\n    for got, want := range cases {\n        if got != want {\n            t.Errorf(\"constant mismatch: got %q want %q\", got, want)\n        }\n    }\n}\n```\n\n### 9.2 Config Loading Tests\n\n```go\n// services/url-service/config_test.go\npackage urlservice\nimport (\n    \"os\"\n    \"testing\"\n)\nfunc TestLoadConfig_MissingDatabaseURL(t *testing.T) {\n    os.Unsetenv(\"DATABASE_URL\")\n    os.Setenv(\"RABBITMQ_URL\", \"amqp://localhost:5672\")\n    os.Setenv(\"REDIS_URL\", \"redis://localhost:6379\")\n    _, err := loadConfig()\n    if err == nil {\n        t.Fatal(\"expected error for missing DATABASE_URL\")\n    }\n}\nfunc TestLoadConfig_MissingRabbitMQURL(t *testing.T) {\n    os.Setenv(\"DATABASE_URL\", \"postgres://user:pass@localhost/db\")\n    os.Unsetenv(\"RABBITMQ_URL\")\n    os.Setenv(\"REDIS_URL\", \"redis://localhost:6379\")\n    _, err := loadConfig()\n    if err == nil {\n        t.Fatal(\"expected error for missing RABBITMQ_URL\")\n    }\n}\nfunc TestLoadConfig_DefaultPort(t *testing.T) {\n    os.Setenv(\"DATABASE_URL\", \"postgres://user:pass@localhost/db\")\n    os.Setenv(\"RABBITMQ_URL\", \"amqp://localhost:5672\")\n    os.Setenv(\"REDIS_URL\", \"redis://localhost:6379\")\n    os.Unsetenv(\"PORT\")\n    cfg, err := loadConfig()\n    if err != nil {\n        t.Fatalf(\"unexpected error: %v\", err)\n    }\n    if cfg.Port != \"8080\" {\n        t.Errorf(\"default port: got %q want %q\", cfg.Port, \"8080\")\n    }\n}\nfunc TestLoadConfig_ServiceName(t *testing.T) {\n    os.Setenv(\"DATABASE_URL\", \"postgres://user:pass@localhost/db\")\n    os.Setenv(\"RABBITMQ_URL\", \"amqp://localhost:5672\")\n    os.Setenv(\"REDIS_URL\", \"redis://localhost:6379\")\n    cfg, _ := loadConfig()\n    if cfg.ServiceName != \"url-service\" {\n        t.Errorf(\"service name: got %q want url-service\", cfg.ServiceName)\n    }\n}\n```\n\n### 9.3 Health Handler Tests\n\n```go\n// services/url-service/health_test.go\npackage urlservice\nimport (\n    \"encoding/json\"\n    \"net/http\"\n    \"net/http/httptest\"\n    \"testing\"\n)\nfunc TestHealthHandler_ResponseShape(t *testing.T) {\n    handler := NewHealthHandler(\"url-service\")\n    req := httptest.NewRequest(\"GET\", \"/health\", nil)\n    rec := httptest.NewRecorder()\n    handler(rec, req)\n    if rec.Code != http.StatusOK {\n        t.Errorf(\"status: got %d want 200\", rec.Code)\n    }\n    ct := rec.Header().Get(\"Content-Type\")\n    if ct != \"application/json\" {\n        t.Errorf(\"content-type: got %q want application/json\", ct)\n    }\n    var resp HealthResponse\n    if err := json.Unmarshal(rec.Body.Bytes(), &resp); err != nil {\n        t.Fatalf(\"parse body: %v\", err)\n    }\n    if resp.Status != \"ok\" {\n        t.Errorf(\"status field: got %q want ok\", resp.Status)\n    }\n    if resp.Service != \"url-service\" {\n        t.Errorf(\"service field: got %q want url-service\", resp.Service)\n    }\n}\nfunc TestHealthHandler_DifferentServiceNames(t *testing.T) {\n    for _, name := range []string{\"analytics-service\", \"user-service\", \"notification-service\", \"gateway\"} {\n        t.Run(name, func(t *testing.T) {\n            h := NewHealthHandler(name)\n            req := httptest.NewRequest(\"GET\", \"/health\", nil)\n            rec := httptest.NewRecorder()\n            h(rec, req)\n            var resp HealthResponse\n            json.Unmarshal(rec.Body.Bytes(), &resp)\n            if resp.Service != name {\n                t.Errorf(\"service: got %q want %q\", resp.Service, name)\n            }\n        })\n    }\n}\n```\n\n### 9.4 Integration Smoke Test (shell script)\n\n```bash\n#!/usr/bin/env bash\n# scripts/smoke_test.sh — run after docker compose up\nset -e\nSERVICES=(\n  \"http://localhost:8080/health:gateway\"\n  \"http://localhost:8081/health:url-service\"\n  \"http://localhost:8082/health:analytics-service\"\n  \"http://localhost:8083/health:user-service\"\n  \"http://localhost:8084/health:notification-service\"\n)\nfor entry in \"${SERVICES[@]}\"; do\n  URL=\"${entry%%:*}\"\n  EXPECTED_SERVICE=\"${entry##*:}\"\n  RESPONSE=$(curl -sf \"$URL\")\n  STATUS=$(echo \"$RESPONSE\" | python3 -c \"import sys,json; d=json.load(sys.stdin); print(d['status'])\")\n  SERVICE=$(echo \"$RESPONSE\" | python3 -c \"import sys,json; d=json.load(sys.stdin); print(d['service'])\")\n  if [ \"$STATUS\" != \"ok\" ]; then\n    echo \"FAIL $URL: status=$STATUS\"\n    exit 1\n  fi\n  if [ \"$SERVICE\" != \"$EXPECTED_SERVICE\" ]; then\n    echo \"FAIL $URL: service=$SERVICE (expected $EXPECTED_SERVICE)\"\n    exit 1\n  fi\n  echo \"PASS $URL → {status:ok, service:$SERVICE}\"\ndone\necho \"\"\necho \"All health checks passed.\"\n```\n\n---\n\n## 10. Performance Targets\n\n| Operation                                    | Target                   | How to Measure                                                                                |\n| -------------------------------------------- | ------------------------ | --------------------------------------------------------------------------------------------- |\n| `docker compose up` → all containers healthy | ≤ 60s                    | `time docker compose up -d` then poll `docker compose ps` until no container shows `starting` |\n| `/health` response time (any service)        | < 10ms p99               | `wrk -t1 -c10 -d10s http://localhost:8081/health` — check Latency 99th percentile             |\n| `pgxpool.Acquire` on warm pool               | < 100ms                  | Instrument `NewDBPool` with `time.Since` around `pool.Ping`; log duration                     |\n| `docker compose down -v` teardown            | ≤ 30s                    | `time docker compose down -v`                                                                 |\n| Service startup (process → HTTP ready)       | < 5s after infra healthy | Measure from container start to first successful healthcheck                                  |\n\n---\n\n## 11. README Content\n\n````markdown\n# URL Shortener — Microservices\n\n## Prerequisites\n\n- Docker >= 24 with Compose v2\n- Go 1.23+ (for local development outside Docker)\n\n## Start the full stack\n\n\\```bash\ndocker compose up --build -d\n\\```\nWait ~60s for all containers to reach healthy state:\n\\```bash\ndocker compose ps\n\\```\n\n## Verify health\n\n\\```bash\nbash scripts/smoke_test.sh\n\\```\n\n## Stop and clean up (including volumes)\n\n\\```bash\ndocker compose down -v\n\\```\n\n## Service ports (host)\n\n| Service              | Port  |\n| -------------------- | ----- |\n| Gateway              | 8080  |\n| URL Service          | 8081  |\n| Analytics Service    | 8082  |\n| User Service         | 8083  |\n| Notification Service | 8084  |\n| RabbitMQ AMQP        | 5672  |\n| RabbitMQ Management  | 15672 |\n| Redis                | 6379  |\n| URL DB (PostgreSQL)  | 5432  |\n| Analytics DB         | 5433  |\n| User DB              | 5434  |\n| Notification DB      | 5435  |\n\n## RabbitMQ credentials\n\nUser: guest / Password: guest\nManagement UI: http://localhost:15672\n````\n\n---\n\n## 12. Pitfall Prevention\n\n![RabbitMQ Exchange/Queue/Binding Topology](./diagrams/tdd-diag-4.svg)\n\n```\nPITFALL MAP for M1:\n1. Hardcoded \"localhost\" in DSN\n   Wrong:  DATABASE_URL=postgres://user:pass@localhost:5432/urldb\n   Right:  DATABASE_URL=postgres://user:pass@url_db:5432/urldb\n   Why: Docker bridge network resolves service names, not \"localhost\"\n2. Single PostgreSQL with multiple schemas\n   Wrong:  url_db: ... POSTGRES_DB: urls,analytics,users\n   Right:  Four separate postgres containers on ports 5432-5435\n   Why: database-per-service is the invariant; schemas in one instance\n        still couple services via a shared crash domain\n3. Producer-only exchange/queue declaration\n   Wrong:  url-service declares \"analytics.clicks\" queue\n   Right:  analytics-service declares its OWN queue and binding\n   Why:    If analytics-service starts first, messages publish to\n           exchange but no queue exists → messages dropped silently\n4. No depends_on + healthcheck → crash loop\n   Wrong:  app starts, DB isn't ready, pgxpool.Ping fails → os.Exit(1)\n           Docker restarts → repeat\n   Right:  depends_on with condition: service_healthy gates app start\n           until pg_isready returns 0\n5. Redis as authoritative store\n   Wrong:  Storing the canonical URL record only in Redis\n   Right:  All writes go to PostgreSQL first; Redis holds TTL copies\n```\n\n![Service Startup Sequence with Dependency Readiness](./diagrams/tdd-diag-5.svg)\n\n```\nExchange/Queue declaration sequence (correct):\n  url-service     analytics-service    notification-service\n       │                  │                    │\n       ▼                  ▼                    ▼\n  ExchangeDeclare    QueueDeclare         QueueDeclare\n  \"url-shortener\"  \"analytics.clicks\"  \"notifications.events\"\n                         │                    │\n                    QueueBind            QueueBind × 3\n                    url.clicked          url.created\n                                         url.deleted\n                                         milestone.reached\nAll three declarations are idempotent:\n  → declaring an existing exchange/queue with same params = no-op\n  → declaring with DIFFERENT params = error (caught at startup)\n```\n\n![pgxpool Connection Pool Configuration Data Flow](./diagrams/tdd-diag-6.svg)\n\n```\nstartup fatality matrix:\nService               │ DB fail │ Redis fail │ RabbitMQ fail │ Queue declare fail\n──────────────────────┼─────────┼────────────┼───────────────┼───────────────────\nurl-service           │  FATAL  │  WARN+cont │    FATAL      │   N/A (producer)\nanalytics-service     │  FATAL  │     N/A    │    FATAL      │      FATAL\nuser-service          │  FATAL  │     N/A    │     N/A       │       N/A\nnotification-service  │  FATAL  │     N/A    │    FATAL      │      FATAL\ngateway               │   N/A   │     N/A    │     N/A       │       N/A\n```\n\n---\n\n<!-- END_TDD_MOD -->\n\n<!-- TDD_MOD_ID: url-shortener-m2 -->\n\n# User Service: Registration, Login, JWT Issuance\n\n## **Module ID:** `url-shortener-m2`\n\n## 1. Module Charter\n\nThis module implements the User Service as a fully self-contained authentication provider. It owns the `users` table in its dedicated PostgreSQL instance (`user_db`), hashes passwords with bcrypt at cost 12, issues HS256-signed JWT tokens on successful login, and exposes three HTTP endpoints: `POST /register`, `POST /login`, and `GET /me`. It produces a reusable `shared/auth` package containing the JWT verification middleware consumed by **all other services** to validate tokens locally without inter-service calls.\nThis module does **not** publish domain events to RabbitMQ. It does **not** call any other service. It does **not** implement URL shortening, analytics, or notification logic. It does **not** maintain session state — every token verification is purely computational (HMAC-SHA256 + claims parsing), with no database round-trip after issuance. The User Service is the **only** service that writes to `user_db`; all other services treat user identity as a verified JWT claim, never as a DB lookup.\n**Upstream dependencies:** `shared/logger` (structured JSON logging), `shared/auth` (produced by this module, consumed by others), PostgreSQL `user_db` (this service's exclusive database), `shared/events` package (imported by go.mod but unused in this module — no events emitted).\n**Downstream consumers:** Every other service imports `shared/auth` for the `JWTMiddleware` and `VerifyToken` function. The `JWT_SECRET` environment variable is the shared secret — it must be identical across all services.\n**Invariants that must always hold:**\n\n- Plaintext passwords never appear in logs, HTTP responses, or the database.\n- The bcrypt hash stored in `password_hash` column is never returned in any API response.\n- Failed login always returns 401 with a generic message — the response must be identical whether the email does not exist or the password is wrong (timing-safe behavior at the application layer; bcrypt compare is constant-time internally).\n- `user_id` in JWT is always a UUID v4 (not an integer); integer IDs would be enumerable.\n- `JWT_SECRET` is read from environment at startup and stored in the Config struct; it is never read from `os.Getenv` in hot paths.\n\n---\n\n## 2. File Structure\n\nCreate files in the numbered order below. Shared packages first, then service files.\n\n```\nurl-shortener/\n│\n├── shared/\n│   └── auth/\n│       ├── 1. go.mod          ← module: github.com/yourhandle/url-shortener/shared/auth\n│       ├── 2. auth.go         ← Claims struct, TokenIssuer interface, VerifyToken func\n│       └── 3. middleware.go   ← JWTMiddleware: func(http.Handler) http.Handler\n│\n├── services/\n│   └── user-service/\n│       ├── (existing from M1)\n│       │   ├── go.mod         ← add shared/auth + golang-jwt/jwt dependency\n│       │   ├── main.go        ← extend: add routes, wire handler deps\n│       │   ├── config.go      ← extend: add JWTSecret, BCryptCost, TokenTTL fields\n│       │   ├── db.go          ← (unchanged from M1)\n│       │   └── health.go      ← (unchanged from M1)\n│       │\n│       ├── 4.  migration.sql  ← CREATE TABLE users + indexes\n│       ├── 5.  store.go       ← UserRepository interface + pgxUserStore implementation\n│       ├── 6.  password.go    ← PasswordHasher interface + bcryptHasher implementation\n│       ├── 7.  token.go       ← jwtTokenIssuer implementing TokenIssuer\n│       ├── 8.  handler.go     ← Handler struct with Register, Login, Me methods\n│       ├── 9.  validate.go    ← email format + password length validators\n│       ├── 10. errors.go      ← sentinel errors and writeError helper\n│       └── 11. user_test.go   ← unit tests (store mock, handler tests, validator tests)\n│\n└── (M1 files unchanged: docker-compose.yml, gateway/, analytics-service/, etc.)\n```\n\n---\n\n## 3. Complete Data Model\n\n### 3.1 PostgreSQL Schema (`migration.sql`)\n\n```sql\n-- migration.sql (run once against user_db on startup or via init script)\nCREATE TABLE IF NOT EXISTS users (\n    id            UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n    email         TEXT        UNIQUE NOT NULL,\n    password_hash TEXT        NOT NULL,\n    created_at    TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n-- Supports: lookup by email on login (exact match, unique index)\nCREATE UNIQUE INDEX IF NOT EXISTS idx_users_email ON users(email);\n-- Note: no index needed on id — it is the PRIMARY KEY (clustered B-tree by default in pgx).\n-- Note: created_at has no index; no time-range queries are required for this service.\n```\n\n**Column rationale:**\n\n| Column | Type | Constraint | Why |\n|---|---|---|---|\n| `id` | UUID | PK, DEFAULT gen_random_uuid() | Non-enumerable identifier; safe to embed in JWT `sub` claim; no sequential leak |\n| `email` | TEXT | UNIQUE NOT NULL | Login credential, must be unique; TEXT over VARCHAR because max email length (254 chars RFC 5321) is not worth constraining separately |\n| `password_hash` | TEXT | NOT NULL | bcrypt output is always 60 chars but TEXT avoids coupling schema to algorithm output length |\n| `created_at` | TIMESTAMPTZ | NOT NULL DEFAULT now() | Audit trail; timezone-aware |\n\n### 3.2 Go Structs — `shared/auth` Package\n\n```go\n// shared/auth/auth.go\npackage auth\nimport (\n    \"time\"\n)\n// Claims is the JWT payload structure.\n// These fields appear in every token issued by the User Service.\n// Other services parse this after signature verification.\ntype Claims struct {\n    // Sub is the user_id UUID string. Named \"sub\" per JWT RFC 7519 §4.1.2.\n    Sub   string `json:\"sub\"`\n    // Email is denormalized from the users table for convenience.\n    // Avoids downstream services needing a DB lookup to display user context.\n    Email string `json:\"email\"`\n    // Iss is the issuer claim. Always \"url-shortener\".\n    Iss   string `json:\"iss\"`\n    // Iat is issued-at Unix timestamp (seconds).\n    Iat   int64  `json:\"iat\"`\n    // Exp is expiry Unix timestamp (seconds). Default: iat + 86400 (24h).\n    Exp   int64  `json:\"exp\"`\n}\n// IsExpired returns true if the current wall time is past Exp.\n// Does NOT verify the signature — that is done by VerifyToken.\nfunc (c *Claims) IsExpired() bool {\n    return time.Now().Unix() > c.Exp\n}\n// ExpiresAt converts the Exp Unix timestamp to a time.Time for response serialization.\nfunc (c *Claims) ExpiresAt() time.Time {\n    return time.Unix(c.Exp, 0).UTC()\n}\n```\n\n```go\n// TokenIssuer and VerifyToken live in auth.go to co-locate the contract with Claims.\n// TokenIssuer abstracts JWT issuance. Allows test doubles.\n// Implemented by jwtTokenIssuer in user-service/token.go.\ntype TokenIssuer interface {\n    // Issue creates and signs a JWT for the given user.\n    // Returns the signed token string and the expiry time, or an error.\n    Issue(userID, email string) (tokenString string, expiresAt time.Time, err error)\n    // Verify parses and validates a token string.\n    // Returns the Claims on success, or an error if the token is expired,\n    // has an invalid signature, or is malformed.\n    Verify(tokenString string) (*Claims, error)\n}\n```\n\n### 3.3 Go Structs — `user-service` Package\n\n```go\n// services/user-service/store.go\n// User is the domain object. Never returned directly in HTTP responses.\ntype User struct {\n    ID           string    // UUID string, e.g. \"550e8400-e29b-41d4-a716-446655440000\"\n    Email        string\n    PasswordHash string    // bcrypt hash; NEVER log this field\n    CreatedAt    time.Time\n}\n// UserRepository abstracts all DB operations for the users table.\n// Defined at the consumer (handler package), not the producer (pgxUserStore).\ntype UserRepository interface {\n    // Insert creates a new user row. Returns ErrDuplicateEmail if email exists.\n    Insert(ctx context.Context, email, passwordHash string) (*User, error)\n    // FindByEmail retrieves a user by email.\n    // Returns ErrUserNotFound if no row matches.\n    FindByEmail(ctx context.Context, email string) (*User, error)\n}\n```\n\n```go\n// services/user-service/password.go\n// PasswordHasher abstracts bcrypt to allow test doubles.\ntype PasswordHasher interface {\n    // Hash returns a bcrypt hash of the plaintext password.\n    // Cost is configured at construction time (default 12).\n    Hash(plaintext string) (string, error)\n    // Verify compares a plaintext password against a stored hash.\n    // Returns nil on match, ErrPasswordMismatch on mismatch.\n    // This call takes O(2^cost) CPU time — do not call in tight loops.\n    Verify(plaintext, hash string) error\n}\n```\n\n```go\n// services/user-service/config.go (extended from M1)\npackage userservice\nimport (\n    \"fmt\"\n    \"os\"\n    \"strconv\"\n    \"time\"\n)\ntype Config struct {\n    DatabaseURL string        // required; fatal if empty\n    Port        string        // default \"8080\"\n    ServiceName string        // constant \"user-service\"\n    JWTSecret   string        // required; HS256 signing key; min 32 bytes recommended\n    BCryptCost  int           // default 12; range [10, 14] for this project\n    TokenTTL    time.Duration // default 24h; configurable via TOKEN_TTL_HOURS env var\n}\nfunc loadConfig() (*Config, error) {\n    cfg := &Config{\n        DatabaseURL: os.Getenv(\"DATABASE_URL\"),\n        JWTSecret:   os.Getenv(\"JWT_SECRET\"),\n        Port:        envOrDefault(\"PORT\", \"8080\"),\n        ServiceName: \"user-service\",\n        BCryptCost:  12,\n        TokenTTL:    24 * time.Hour,\n    }\n    if cfg.DatabaseURL == \"\" {\n        return nil, fmt.Errorf(\"DATABASE_URL is required\")\n    }\n    if cfg.JWTSecret == \"\" {\n        return nil, fmt.Errorf(\"JWT_SECRET is required\")\n    }\n    if cost := os.Getenv(\"BCRYPT_COST\"); cost != \"\" {\n        n, err := strconv.Atoi(cost)\n        if err != nil || n < 10 || n > 14 {\n            return nil, fmt.Errorf(\"BCRYPT_COST must be integer in [10,14], got %q\", cost)\n        }\n        cfg.BCryptCost = n\n    }\n    if ttlHours := os.Getenv(\"TOKEN_TTL_HOURS\"); ttlHours != \"\" {\n        h, err := strconv.Atoi(ttlHours)\n        if err != nil || h < 1 {\n            return nil, fmt.Errorf(\"TOKEN_TTL_HOURS must be positive integer, got %q\", ttlHours)\n        }\n        cfg.TokenTTL = time.Duration(h) * time.Hour\n    }\n    return cfg, nil\n}\nfunc envOrDefault(key, def string) string {\n    if v := os.Getenv(key); v != \"\" {\n        return v\n    }\n    return def\n}\n```\n\n### 3.4 HTTP Request/Response Schemas\n\n```go\n// services/user-service/handler.go — request/response types\ntype registerRequest struct {\n    Email    string `json:\"email\"`\n    Password string `json:\"password\"`\n}\ntype registerResponse struct {\n    UserID string `json:\"user_id\"`\n    Email  string `json:\"email\"`\n}\ntype loginRequest struct {\n    Email    string `json:\"email\"`\n    Password string `json:\"password\"`\n}\ntype loginResponse struct {\n    Token     string `json:\"token\"`\n    ExpiresAt string `json:\"expires_at\"` // RFC3339 format: \"2026-03-03T12:00:00Z\"\n}\ntype meResponse struct {\n    UserID string `json:\"user_id\"`\n    Email  string `json:\"email\"`\n}\ntype errorResponse struct {\n    Error string `json:\"error\"`\n    // Field is present only for 400 validation errors, identifying which input field failed.\n    Field string `json:\"field,omitempty\"`\n}\n```\n\n### 3.5 Sentinel Errors (`errors.go`)\n\n```go\n// services/user-service/errors.go\npackage userservice\nimport \"errors\"\nvar (\n    // ErrDuplicateEmail is returned by UserRepository.Insert when the email\n    // already exists. Mapped to 409 Conflict in the handler.\n    ErrDuplicateEmail = errors.New(\"email already registered\")\n    // ErrUserNotFound is returned by UserRepository.FindByEmail when no row matches.\n    // MUST NOT be surfaced directly to HTTP clients (email enumeration).\n    ErrUserNotFound = errors.New(\"user not found\")\n    // ErrPasswordMismatch is returned by PasswordHasher.Verify on wrong password.\n    // MUST NOT be surfaced directly to HTTP clients (same 401 as ErrUserNotFound).\n    ErrPasswordMismatch = errors.New(\"password mismatch\")\n    // ErrTokenInvalid is returned by TokenIssuer.Verify for any invalid token:\n    // expired, wrong signature, malformed. Maps to 401 Unauthorized.\n    ErrTokenInvalid = errors.New(\"token invalid or expired\")\n)\n```\n\n![User Service Module Architecture](./diagrams/tdd-diag-7.svg)\n\n```\nData flow and ownership:\nHTTP Client\n    │\n    ▼\nuser-service (port 8083)\n    │\n    ├─ POST /register ──► validateEmail + validatePassword\n    │                       │\n    │                       ▼\n    │                   PasswordHasher.Hash(password) ──► bcrypt hash (60 chars)\n    │                       │\n    │                       ▼\n    │                   UserRepository.Insert(email, hash)\n    │                       │\n    │                       ▼\n    │                   user_db.users table\n    │                       │\n    │                       ▼\n    │                   201 {user_id, email}  ← PasswordHash NEVER included\n    │\n    ├─ POST /login ───► UserRepository.FindByEmail(email)\n    │                       │                      │\n    │                   found                   not found\n    │                       │                      │\n    │                       ▼                      ▼\n    │                   PasswordHasher.Verify   401 (generic)\n    │                       │          │\n    │                    match      mismatch\n    │                       │          │\n    │                       ▼          ▼\n    │                   TokenIssuer  401 (generic, same message as not-found)\n    │                   .Issue(id, email)\n    │                       │\n    │                       ▼\n    │                   200 {token, expires_at}\n    │\n    └─ GET /me ───────► JWTMiddleware (local HMAC verify, no DB)\n                            │                │\n                         valid            invalid/expired\n                            │                │\n                            ▼                ▼\n                        200 {user_id,     401\n                             email}\nshared/auth package:\n  TokenIssuer interface ──── implemented by ──── jwtTokenIssuer (user-service/token.go)\n  JWTMiddleware func ──────── imported by ──────── all other services (M3, M4, M5)\n  VerifyToken func ───────── imported by ──────── all other services\nuser_db (exclusive):\n  users table ── owned by user-service ONLY ── no other service reads this table\n```\n\n---\n\n## 4. Interface Contracts\n\n### 4.1 `UserRepository` — `pgxUserStore` Implementation\n\n```go\n// store.go\ntype pgxUserStore struct {\n    pool *pgxpool.Pool\n}\nfunc NewUserStore(pool *pgxpool.Pool) UserRepository {\n    return &pgxUserStore{pool: pool}\n}\n```\n\n**`Insert(ctx context.Context, email, passwordHash string) (*User, error)`**\n\n- Executes: `INSERT INTO users (email, password_hash) VALUES ($1, $2) RETURNING id, email, created_at`\n- `email` must not be empty (caller validates before Insert call; store does not re-validate)\n- `passwordHash` must not be empty (caller always hashes before calling Insert)\n- On success: returns `*User` with `ID`, `Email`, `CreatedAt` populated; `PasswordHash` is **not** populated in the returned struct (read-once; no need to round-trip)\n- On PostgreSQL error code `23505` (unique_violation): return `nil, ErrDuplicateEmail`\n- On any other DB error: return `nil, fmt.Errorf(\"insert user: %w\", err)` — do NOT return `ErrDuplicateEmail` for other errors\n- Detecting pg error code:\n\n```go\nimport \"github.com/jackc/pgx/v5/pgconn\"\nfunc isPgUniqueViolation(err error) bool {\n    var pgErr *pgconn.PgError\n    return errors.As(err, &pgErr) && pgErr.Code == \"23505\"\n}\n```\n\n**`FindByEmail(ctx context.Context, email string) (*User, error)`**\n\n- Executes: `SELECT id, email, password_hash, created_at FROM users WHERE email = $1`\n- On no rows: return `nil, ErrUserNotFound`\n- On success: return `*User` with all four fields populated (including `PasswordHash` — needed for bcrypt comparison)\n- On any other DB error: return `nil, fmt.Errorf(\"find user by email: %w\", err)`\n- Uses `pool.QueryRow` + `pgx.ErrNoRows` detection:\n\n```go\nimport \"github.com/jackc/pgx/v5\"\nrow := s.pool.QueryRow(ctx, `SELECT id, email, password_hash, created_at FROM users WHERE email = $1`, email)\nvar u User\nerr := row.Scan(&u.ID, &u.Email, &u.PasswordHash, &u.CreatedAt)\nif errors.Is(err, pgx.ErrNoRows) {\n    return nil, ErrUserNotFound\n}\nif err != nil {\n    return nil, fmt.Errorf(\"find user by email: %w\", err)\n}\nreturn &u, nil\n```\n\n### 4.2 `PasswordHasher` — `bcryptHasher` Implementation\n\n```go\n// password.go\ntype bcryptHasher struct {\n    cost int\n}\nfunc NewPasswordHasher(cost int) PasswordHasher {\n    return &bcryptHasher{cost: cost}\n}\n```\n\n**`Hash(plaintext string) (string, error)`**\n\n- Calls `bcrypt.GenerateFromPassword([]byte(plaintext), h.cost)`\n- Returns the hash as a string (bcrypt output is always valid UTF-8, 60 chars, starts with `$2a$`)\n- Returns `(\"\", fmt.Errorf(\"hash password: %w\", err))` on failure (extremely rare — only on system entropy failure)\n- Does **not** validate password length or format — that is the validator's responsibility\n- The returned hash string is what gets stored in `password_hash` column\n  **`Verify(plaintext, hash string) error`**\n- Calls `bcrypt.CompareHashAndPassword([]byte(hash), []byte(plaintext))`\n- Returns `nil` on match\n- Returns `ErrPasswordMismatch` on `bcrypt.ErrMismatchedHashAndPassword`\n- Returns `fmt.Errorf(\"verify password: %w\", err)` on any other error (malformed hash — should not occur in production)\n- **Timing note:** `bcrypt.CompareHashAndPassword` is inherently slow (that is the security property). Do not add artificial delays. Do not short-circuit before calling bcrypt even when the user is not found — see Login handler algorithm in §5.2 for the dummy-hash strategy.\n\n### 4.3 `TokenIssuer` — `jwtTokenIssuer` Implementation\n\n```go\n// token.go\ntype jwtTokenIssuer struct {\n    secret []byte\n    ttl    time.Duration\n}\nfunc NewTokenIssuer(secret string, ttl time.Duration) TokenIssuer {\n    return &jwtTokenIssuer{secret: []byte(secret), ttl: ttl}\n}\n```\n\n**`Issue(userID, email string) (string, time.Time, error)`**\n\n- Algorithm: see §5.3\n- Returns `(\"\", time.Time{}, fmt.Errorf(\"sign token: %w\", err))` on HMAC failure\n  **`Verify(tokenString string) (*Claims, error)`**\n- Algorithm: see §5.4\n- Returns `(nil, ErrTokenInvalid)` for **all** failure modes (expired, wrong signature, malformed, wrong issuer)\n- Must not return different errors for different failure reasons — all map to 401 with no hint\n\n### 4.4 `shared/auth` — `JWTMiddleware`\n\n```go\n// shared/auth/middleware.go\n// JWTMiddleware returns an http.Handler middleware that:\n//   1. Reads the Authorization header\n//   2. Strips the \"Bearer \" prefix\n//   3. Verifies the token using the provided secret\n//   4. On success: injects Claims into request context using claimsKey\n//   5. On failure: writes 401 JSON and does NOT call next\n//\n// Parameters:\n//   secret  - the HS256 signing secret (must match JWT_SECRET env var)\n//   next    - the downstream handler to call on success\n//\n// Returns: http.Handler\nfunc JWTMiddleware(secret string) func(http.Handler) http.Handler\n// ClaimsFromContext extracts Claims injected by JWTMiddleware.\n// Returns (nil, false) if the context has no claims (middleware not applied or failed).\nfunc ClaimsFromContext(ctx context.Context) (*Claims, bool)\n// claimsKey is the unexported context key type — prevents collisions with other packages.\ntype claimsKey struct{}\n```\n\n**Authorization header parsing:**\n\n- Must be exactly `Authorization: Bearer <token>` (case-sensitive header name, case-sensitive scheme)\n- Header absent → 401 `{\"error\": \"authorization header required\"}`\n- Header present but not starting with `\"Bearer \"` (with space) → 401 `{\"error\": \"invalid authorization header format\"}`\n- Token string empty after stripping prefix → 401 `{\"error\": \"token is required\"}`\n\n### 4.5 `shared/auth` — `VerifyToken` Standalone Function\n\n```go\n// shared/auth/auth.go\n// VerifyToken parses and verifies a JWT token string using the given secret.\n// Used by services that verify tokens outside of HTTP middleware (e.g., in RabbitMQ consumers).\n//\n// Parameters:\n//   tokenString - raw JWT string (no \"Bearer \" prefix)\n//   secret      - HS256 signing key bytes\n//\n// Returns:\n//   *Claims - populated on success\n//   error   - ErrTokenInvalid on any failure (expired, wrong sig, malformed)\nfunc VerifyToken(tokenString, secret string) (*Claims, error)\n```\n\n### 4.6 Validation Functions (`validate.go`)\n\n```go\n// services/user-service/validate.go\n// validateEmail returns an error if email does not match a minimal valid format.\n// Uses regexp: ^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$\n// Does NOT do DNS MX lookup — format check only.\n// Returns nil on valid, non-nil with field=\"email\" on invalid.\nfunc validateEmail(email string) error\n// validatePassword returns an error if password is shorter than 8 characters.\n// No other complexity rules (no uppercase/symbol requirements per spec).\n// Returns nil on valid, non-nil with field=\"password\" on invalid.\nfunc validatePassword(password string) error\n```\n\n---\n\n## 5. Algorithm Specification\n\n### 5.1 `POST /register` Handler\n\n```\nInput:  JSON body { email: string, password: string }\nOutput: 201 { user_id, email } | 400 | 409 | 500\nStep 1: Decode JSON body\n  - json.NewDecoder(r.Body).Decode(&req)\n  - On error (malformed JSON, wrong types): writeError(w, 400, \"invalid request body\", \"\")\n  - Limit body to 1MB: r.Body = http.MaxBytesReader(w, r.Body, 1<<20)\nStep 2: Validate inputs\n  - if err := validateEmail(req.Email); err != nil:\n      writeError(w, 400, \"invalid email format\", \"email\")\n      return\n  - if err := validatePassword(req.Password); err != nil:\n      writeError(w, 400, \"password must be at least 8 characters\", \"password\")\n      return\nStep 3: Hash password\n  - hash, err := h.hasher.Hash(req.Password)\n  - On error: log.Error(\"bcrypt hash failed\", \"error\", err)\n              writeError(w, 500, \"internal server error\", \"\")\n              return\nStep 4: Insert user\n  - user, err := h.store.Insert(r.Context(), req.Email, hash)\n  - if errors.Is(err, ErrDuplicateEmail):\n      writeError(w, 409, \"email already registered\", \"\")\n      return\n  - On other error: log.Error(\"insert user failed\", \"error\", err)\n                    writeError(w, 500, \"internal server error\", \"\")\n                    return\nStep 5: Write response\n  - w.Header().Set(\"Content-Type\", \"application/json\")\n  - w.WriteHeader(201)\n  - json.NewEncoder(w).Encode(registerResponse{UserID: user.ID, Email: user.Email})\nInvariants after execution:\n  - user.PasswordHash never appears in the HTTP response\n  - On 409: no new row was inserted (constraint violated → rolled back by Postgres)\n  - On 500: caller may retry; handler is idempotent per email (duplicate → 409)\n```\n\n### 5.2 `POST /login` Handler — Timing-Safe Design\n\n```\nInput:  JSON body { email: string, password: string }\nOutput: 200 { token, expires_at } | 401\nStep 1: Decode JSON body (same as /register step 1)\nStep 2: Attempt to find user\n  - user, findErr := h.store.FindByEmail(r.Context(), req.Email)\n  - Do NOT return 401 here yet — must always call bcrypt compare (see Step 3)\nStep 3: Constant-time password comparison\n  - if errors.Is(findErr, ErrUserNotFound):\n      // Dummy compare: prevents timing difference that reveals email existence.\n      // bcrypt.CompareHashAndPassword with dummyHash takes same wall time as real compare.\n      dummyHash := \"$2a$12$invalidhashfortimingsafetyonlyxx\"\n      h.hasher.Verify(req.Password, dummyHash)  // result intentionally discarded\n      writeError(w, 401, \"invalid credentials\", \"\")\n      return\n  - if findErr != nil:\n      log.Error(\"find user failed\", \"error\", findErr)\n      writeError(w, 500, \"internal server error\", \"\")\n      return\n  // User found:\n  - if err := h.hasher.Verify(req.Password, user.PasswordHash); err != nil:\n      // errors.Is(err, ErrPasswordMismatch) OR unexpected error: both → 401\n      writeError(w, 401, \"invalid credentials\", \"\")\n      return\nStep 4: Issue token\n  - tokenString, expiresAt, err := h.issuer.Issue(user.ID, user.Email)\n  - On error: log.Error(\"token issue failed\", \"error\", err)\n              writeError(w, 500, \"internal server error\", \"\")\n              return\nStep 5: Write response\n  - w.Header().Set(\"Content-Type\", \"application/json\")\n  - w.WriteHeader(200)\n  - json.NewEncoder(w).Encode(loginResponse{\n        Token:     tokenString,\n        ExpiresAt: expiresAt.Format(time.RFC3339),\n    })\nSECURITY NOTE on dummy hash:\n  The dummyHash literal must NOT be a valid bcrypt hash that could match any password.\n  Use a string that starts with \"$2a$12$\" (correct prefix) but has an invalid/impossible\n  body so bcrypt parse succeeds (cost extraction works) but comparison always fails.\n  Example: \"$2a$12$0000000000000000000000uZLbwxnpY0o6Fh.za8VOf/OjIPFGXGhG\"\n  (31 chars of deterministic non-random salt+hash data — bcrypt will always return mismatch)\n  This ensures the timing profile is identical to a real failed compare.\n```\n\n### 5.3 `TokenIssuer.Issue` Algorithm\n\n```\nInput:  userID string (UUID), email string\nOutput: tokenString string, expiresAt time.Time, error\nStep 1: Build Claims\n  now := time.Now().UTC()\n  claims := Claims{\n      Sub:   userID,\n      Email: email,\n      Iss:   \"url-shortener\",\n      Iat:   now.Unix(),\n      Exp:   now.Add(i.ttl).Unix(),\n  }\nStep 2: Create JWT token using golang-jwt/jwt\n  // Use map claims to avoid importing jwt in shared/auth — embed in jwtTokenIssuer\n  token := jwt.NewWithClaims(jwt.SigningMethodHS256, jwt.MapClaims{\n      \"sub\":   claims.Sub,\n      \"email\": claims.Email,\n      \"iss\":   claims.Iss,\n      \"iat\":   claims.Iat,\n      \"exp\":   claims.Exp,\n  })\nStep 3: Sign\n  signed, err := token.SignedString(i.secret)\n  if err != nil:\n      return \"\", time.Time{}, fmt.Errorf(\"sign token: %w\", err)\nStep 4: Return\n  expiresAt := time.Unix(claims.Exp, 0).UTC()\n  return signed, expiresAt, nil\nToken format (HS256, compact serialization):\n  <base64url(header)>.<base64url(payload)>.<base64url(signature)>\n  Header: {\"alg\":\"HS256\",\"typ\":\"JWT\"}\n  Payload: {\"sub\":\"<uuid>\",\"email\":\"...\",\"iss\":\"url-shortener\",\"iat\":<unix>,\"exp\":<unix>}\n  Signature: HMAC-SHA256(base64url(header) + \".\" + base64url(payload), secret)\n```\n\n### 5.4 `TokenIssuer.Verify` / `shared/auth.VerifyToken` Algorithm\n\n```\nInput:  tokenString string, secret []byte\nOutput: *Claims, error\nStep 1: Parse token with golang-jwt/jwt\n  token, err := jwt.Parse(tokenString, func(token *jwt.Token) (interface{}, error) {\n      // Verify algorithm is HS256 — MANDATORY check\n      if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok {\n          return nil, fmt.Errorf(\"unexpected signing method: %v\", token.Header[\"alg\"])\n      }\n      return secret, nil\n  })\nStep 2: Handle parse error\n  if err != nil:\n      return nil, ErrTokenInvalid\n      // NOTE: do not wrap err — all failures are opaque ErrTokenInvalid to callers\nStep 3: Check token.Valid\n  if !token.Valid:\n      return nil, ErrTokenInvalid\nStep 4: Extract MapClaims\n  mapClaims, ok := token.Claims.(jwt.MapClaims)\n  if !ok:\n      return nil, ErrTokenInvalid\nStep 5: Build Claims struct\n  claims := &Claims{}\n  claims.Sub   = mapClaims[\"sub\"].(string)   // type assert; on panic → see Step 5a\n  claims.Email = mapClaims[\"email\"].(string)\n  claims.Iss   = mapClaims[\"iss\"].(string)\n  // iat and exp are float64 in JSON-decoded maps\n  if iat, ok := mapClaims[\"iat\"].(float64); ok:\n      claims.Iat = int64(iat)\n  if exp, ok := mapClaims[\"exp\"].(float64); ok:\n      claims.Exp = int64(exp)\nStep 5a: Safe extraction to avoid panic\n  Use a helper that returns (string, bool) and check ok before asserting:\n  func extractString(m jwt.MapClaims, key string) (string, bool) {\n      v, exists := m[key]\n      if !exists { return \"\", false }\n      s, ok := v.(string)\n      return s, ok\n  }\n  If any required claim is absent or wrong type: return nil, ErrTokenInvalid\nStep 6: Verify issuer\n  if claims.Iss != \"url-shortener\":\n      return nil, ErrTokenInvalid\nStep 7: Return\n  return claims, nil\nNOTE: golang-jwt/jwt automatically validates exp (token expired) during Parse\n      when the jwt.Parser's ValidateExpiry option is enabled (default true).\n      No manual time comparison is needed in this function.\n```\n\n### 5.5 `GET /me` Handler\n\n```\nInput:  Authorization: Bearer <jwt> in request header\n        (Claims already in context, injected by JWTMiddleware)\nOutput: 200 { user_id, email } | 401\nStep 1: Extract claims from context\n  claims, ok := auth.ClaimsFromContext(r.Context())\n  if !ok:\n      // Should not happen if middleware is correctly applied, but guard anyway\n      writeError(w, 401, \"unauthorized\", \"\")\n      return\nStep 2: Write response (no DB lookup)\n  w.Header().Set(\"Content-Type\", \"application/json\")\n  w.WriteHeader(200)\n  json.NewEncoder(w).Encode(meResponse{\n      UserID: claims.Sub,\n      Email:  claims.Email,\n  })\n```\n\n![POST /register Data Flow](./diagrams/tdd-diag-8.svg)\n\n```\nPOST /login timing-safe flow:\nFindByEmail(email)\n       │\n  ┌────┴────────────────────────────────────────────────┐\n  │ User NOT found                  User found           │\n  │       │                              │               │\n  │       ▼                              ▼               │\n  │  Verify(password,           Verify(password,         │\n  │  dummyHash)                 user.PasswordHash)       │\n  │  [always fails,             [bcrypt.CompareHash...]  │\n  │   takes ~same time]              │           │       │\n  │       │                       match       mismatch   │\n  │       ▼                          │              │    │\n  │  401 generic              Issue(id, email)   401 generic\n  │                                  │\n  │                           200 {token, expires_at}\n  └────────────────────────────────────────────────────┘\nCRITICAL: Both 401 paths go through bcrypt.CompareHashAndPassword.\n          Network latency variation masks the residual timing difference\n          between a valid bcrypt hash and the dummy hash structure,\n          but using the same cost prefix minimizes it further.\n```\n\n### 5.6 Schema Migration on Service Startup\n\nThe user-service does not use a migration tool in M2. Migration is applied via a startup SQL exec:\n\n```go\n// main.go — after NewDBPool succeeds\nconst schema = `\nCREATE TABLE IF NOT EXISTS users (\n    id            UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n    email         TEXT        UNIQUE NOT NULL,\n    password_hash TEXT        NOT NULL,\n    created_at    TIMESTAMPTZ NOT NULL DEFAULT now()\n);\nCREATE UNIQUE INDEX IF NOT EXISTS idx_users_email ON users(email);\n`\nfunc runMigrations(ctx context.Context, pool *pgxpool.Pool, log *slog.Logger) error {\n    _, err := pool.Exec(ctx, schema)\n    if err != nil {\n        return fmt.Errorf(\"run migrations: %w\", err)\n    }\n    log.Info(\"migrations applied\")\n    return nil\n}\n```\n\n## Called in `main()` after `NewDBPool`, before starting the HTTP server. Fatal on error\n\n## 6. Error Handling Matrix\n\n| Error Scenario                      | Detected By                                  | HTTP Status  | Response Body                                                           | Log Level                            | Log Fields                              |\n| ----------------------------------- | -------------------------------------------- | ------------ | ----------------------------------------------------------------------- | ------------------------------------ | --------------------------------------- |\n| Missing `DATABASE_URL`              | `loadConfig()`                               | — (pre-HTTP) | stderr message                                                          | `Error` (fmt.Fprintf)                | env var name                            |\n| Missing `JWT_SECRET`                | `loadConfig()`                               | — (pre-HTTP) | stderr message                                                          | `Error` (fmt.Fprintf)                | env var name                            |\n| DB unreachable at startup           | `NewDBPool` → `pool.Ping`                    | — (pre-HTTP) | —                                                                       | `Error` + `os.Exit(1)`               | masked DSN                              |\n| Migration SQL fails                 | `runMigrations`                              | — (pre-HTTP) | —                                                                       | `Error` + `os.Exit(1)`               | error string                            |\n| Malformed JSON request body         | `json.Decode` in handler                     | 400          | `{\"error\":\"invalid request body\"}`                                      | `Warn`                               | path, body size                         |\n| Invalid email format                | `validateEmail`                              | 400          | `{\"error\":\"invalid email format\",\"field\":\"email\"}`                      | none                                 | —                                       |\n| Password < 8 chars                  | `validatePassword`                           | 400          | `{\"error\":\"password must be at least 8 characters\",\"field\":\"password\"}` | none                                 | —                                       |\n| Duplicate email on register         | `isPgUniqueViolation` in store               | 409          | `{\"error\":\"email already registered\"}`                                  | `Info`                               | email (safe to log)                     |\n| DB error on Insert                  | `store.Insert` non-unique error              | 500          | `{\"error\":\"internal server error\"}`                                     | `Error`                              | error string                            |\n| User not found on login             | `store.FindByEmail` → `ErrUserNotFound`      | 401          | `{\"error\":\"invalid credentials\"}`                                       | none (timing-safe: log would reveal) | —                                       |\n| Wrong password on login             | `hasher.Verify` → `ErrPasswordMismatch`      | 401          | `{\"error\":\"invalid credentials\"}`                                       | none                                 | —                                       |\n| DB error on FindByEmail             | `store.FindByEmail` non-ErrUserNotFound      | 500          | `{\"error\":\"internal server error\"}`                                     | `Error`                              | error string                            |\n| bcrypt hash failure (Hash)          | `bcrypt.GenerateFromPassword`                | 500          | `{\"error\":\"internal server error\"}`                                     | `Error`                              | error string                            |\n| bcrypt unexpected verify error      | `bcrypt.CompareHashAndPassword` non-mismatch | 401          | `{\"error\":\"invalid credentials\"}`                                       | `Error`                              | error (malformed stored hash — serious) |\n| Token sign failure                  | `token.SignedString`                         | 500          | `{\"error\":\"internal server error\"}`                                     | `Error`                              | error string                            |\n| Missing Authorization header        | `JWTMiddleware`                              | 401          | `{\"error\":\"authorization header required\"}`                             | none                                 | —                                       |\n| Malformed Authorization header      | `JWTMiddleware`                              | 401          | `{\"error\":\"invalid authorization header format\"}`                       | none                                 | —                                       |\n| JWT signature invalid               | `jwt.Parse` error                            | 401          | `{\"error\":\"unauthorized\"}`                                              | none                                 | —                                       |\n| JWT expired                         | `jwt.Parse` exp validation                   | 401          | `{\"error\":\"unauthorized\"}`                                              | none                                 | —                                       |\n| JWT wrong issuer                    | claims.Iss check                             | 401          | `{\"error\":\"unauthorized\"}`                                              | none                                 | —                                       |\n| `GET /me` missing claims in context | `ClaimsFromContext`                          | 401          | `{\"error\":\"unauthorized\"}`                                              | `Warn`                               | path                                    |\n\n**`writeError` helper:**\n\n```go\n// services/user-service/errors.go\nfunc writeError(w http.ResponseWriter, status int, message, field string) {\n    w.Header().Set(\"Content-Type\", \"application/json\")\n    w.WriteHeader(status)\n    resp := errorResponse{Error: message, Field: field}\n    json.NewEncoder(w).Encode(resp) // encode error intentionally ignored\n}\n```\n\n## **Security note:** 401 responses for login always use the message `\"invalid credentials\"` regardless of whether the email was not found or the password was wrong. The log lines for these two paths are also identical (neither logs). This prevents log-based email enumeration\n\n## 7. Threat Model\n\n| Attack                               | Surface              | Mitigation                                                                                                           |\n| ------------------------------------ | -------------------- | -------------------------------------------------------------------------------------------------------------------- |\n| Password disclosure                  | HTTP response        | `password_hash` field never serialized in any response type                                                          |\n| Password disclosure                  | Logs                 | `req.Password` and `user.PasswordHash` never passed to any logger                                                    |\n| Email enumeration via login timing   | POST /login          | Dummy bcrypt compare on unknown email; same response body and status for both paths                                  |\n| Email enumeration via login response | POST /login          | Identical 401 body `{\"error\":\"invalid credentials\"}` for both cases                                                  |\n| Email enumeration via register       | POST /register       | 409 on duplicate does reveal email existence — this is documented and acceptable per spec (user is self-registering) |\n| JWT algorithm confusion              | `jwt.Parse` key func | `if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok { return nil, err }` — rejects RS256/none                    |\n| JWT `none` algorithm attack          | `jwt.Parse` key func | Same check above rejects `jwt.SigningMethodNone`                                                                     |\n| JWT secret brute force               | JWT_SECRET env       | Secret must be ≥ 32 bytes (loaded from env; weak secrets are an ops problem, not caught in code)                     |\n| Integer user_id enumeration          | JWT `sub` claim      | UUID v4, not sequential integer                                                                                      |\n| Hardcoded JWT_SECRET                 | Config               | `loadConfig` enforces `os.Getenv(\"JWT_SECRET\")` — fatal if empty; no default value                                   |\n\n---\n\n## 8. Concurrency Specification\n\nThe User Service is stateless at the handler level. `net/http`'s default server dispatches each request in its own goroutine. The shared state components are:\n\n| Component | Thread Safety | Rationale |\n|---|---|---|\n| `pgxpool.Pool` | ✅ Safe | pgxpool is goroutine-safe; connection acquisition uses internal mutex |\n| `bcryptHasher` | ✅ Safe | No mutable state; `bcrypt.GenerateFromPassword` and `CompareHashAndPassword` are pure functions |\n| `jwtTokenIssuer` | ✅ Safe | `secret []byte` is read-only after construction; `golang-jwt/jwt` operations are pure |\n| `pgxUserStore` | ✅ Safe | Only holds `*pgxpool.Pool` which is safe |\n| `Handler` struct | ✅ Safe | All fields set at construction; no mutation after `main()` wires dependencies |\nNo mutexes are required in this module. The `JWTMiddleware` uses `context.WithValue` which is goroutine-safe. The pre-encoded health response byte slice in `NewHealthHandler` is read-only after construction.\n**bcrypt CPU saturation:** At cost 12, each `bcrypt.GenerateFromPassword` call takes ~200–400ms of CPU. Under concurrent load (N simultaneous logins), N goroutines will each consume one CPU for ~300ms. `net/http`'s goroutine-per-request model means the OS scheduler handles this automatically; no explicit worker pool is needed at this traffic level. If load becomes a concern in future milestones, a semaphore can limit concurrent bcrypt operations — not required for M2.\n\n---\n\n## 9. Implementation Sequence with Checkpoints\n\n### Phase 1: `shared/auth` Package + `users` Table Migration (1–1.5h)\n\n1. Create `shared/auth/go.mod`:\n\n```\nmodule github.com/yourhandle/url-shortener/shared/auth\ngo 1.23\nrequire github.com/golang-jwt/jwt/v5 v5.2.1\n```\n\n1. Write `shared/auth/auth.go`: `Claims` struct, `IsExpired()`, `ExpiresAt()`, `TokenIssuer` interface, `VerifyToken` function, `ErrTokenInvalid` sentinel.\n2. Write `shared/auth/middleware.go`: `JWTMiddleware`, `ClaimsFromContext`, `claimsKey` type.\n3. Add `shared/auth` to `go.work`:\n\n```\nuse (\n    ...\n    ./shared/auth\n)\n```\n\n1. Write `services/user-service/migration.sql` as specified in §3.1.\n2. Update `services/user-service/go.mod`:\n\n```\nrequire (\n    github.com/yourhandle/url-shortener/shared/auth v0.0.0\n    github.com/yourhandle/url-shortener/shared/logger v0.0.0\n    github.com/jackc/pgx/v5 v5.6.0\n    golang.org/x/crypto v0.23.0   // for bcrypt\n    github.com/golang-jwt/jwt/v5 v5.2.1\n)\nreplace (\n    github.com/yourhandle/url-shortener/shared/auth => ../../shared/auth\n    github.com/yourhandle/url-shortener/shared/logger => ../../shared/logger\n)\n```\n\n1. Run `go work sync` at monorepo root.\n   **Checkpoint:** `go build github.com/yourhandle/url-shortener/shared/auth` exits 0. Write a throwaway test that calls `VerifyToken(\"bad-token\", \"secret\")` and asserts it returns `ErrTokenInvalid`. Run: `go test ./shared/auth/...` → PASS.\n\n### Phase 2: `store.go`, `password.go`, `token.go`, `errors.go` (1–1.5h)\n\n1. Write `services/user-service/errors.go` with four sentinel errors and `writeError` helper.\n2. Write `services/user-service/store.go`: `User` struct, `UserRepository` interface, `pgxUserStore`, `isPgUniqueViolation` helper.\n3. Write `services/user-service/password.go`: `PasswordHasher` interface, `bcryptHasher`, both methods.\n4. Write `services/user-service/token.go`: `jwtTokenIssuer`, `Issue` and `Verify` methods.\n   **Checkpoint:** `go build ./services/user-service/...` exits 0. Run unit tests for store (with mock), password hasher (Hash → Verify round trip), and token issuer (Issue → Verify round trip). See §10 for test specs. Run: `go test ./services/user-service/...` → PASS.\n\n### Phase 3: `validate.go` + `handler.go` + Updated `config.go` and `main.go` (1.5–2h)\n\n1. Write `services/user-service/validate.go` with `validateEmail` and `validatePassword`.\n2. Update `services/user-service/config.go` to add `JWTSecret`, `BCryptCost`, `TokenTTL`.\n3. Write `services/user-service/handler.go`:\n   - `Handler` struct holding `store UserRepository`, `hasher PasswordHasher`, `issuer TokenIssuer`, `log *slog.Logger`\n   - `NewHandler` constructor\n   - `Register`, `Login`, `Me` methods\n4. Update `services/user-service/main.go`:\n   - Load config (now includes JWT fields)\n   - Call `runMigrations`\n   - Construct `NewUserStore`, `NewPasswordHasher`, `NewTokenIssuer`, `NewHandler`\n   - Register routes: `POST /register`, `POST /login`, `GET /me` (wrapped in `JWTMiddleware`)\n   - Remove old stub routes if any\n\n```go\n// main.go route registration\nmux.HandleFunc(\"POST /register\", h.Register)\nmux.HandleFunc(\"POST /login\", h.Login)\nmux.Handle(\"GET /me\", auth.JWTMiddleware(cfg.JWTSecret)(http.HandlerFunc(h.Me)))\nmux.HandleFunc(\"GET /health\", NewHealthHandler(cfg.ServiceName))\n```\n\n**Checkpoint:** Start service locally:\n\n```bash\nDATABASE_URL=\"postgres://useruser:userpass@localhost:5434/userdb\" \\\nJWT_SECRET=\"supersecretkey-at-least-32-chars-long\" \\\ngo run ./services/user-service/\n```\n\n`curl http://localhost:8080/health` → `{\"status\":\"ok\",\"service\":\"user-service\"}`.\n`curl -X POST http://localhost:8080/register -d '{\"email\":\"test@example.com\",\"password\":\"password123\"}' -H 'Content-Type: application/json'` → `201 {\"user_id\":\"...\",\"email\":\"test@example.com\"}`.\n\n### Phase 4: `JWTMiddleware` Integration + `GET /me` (1h)\n\n1. Verify `JWTMiddleware` in `shared/auth/middleware.go` correctly injects claims into context.\n2. Verify `ClaimsFromContext` returns claims from context.\n3. Wire `GET /me` handler using the middleware (done in Phase 3 above).\n4. Test `GET /me` with a valid token and with an expired/invalid token.\n   **Checkpoint:** Full manual flow:\n\n```bash\n# Register\nRESP=$(curl -s -X POST http://localhost:8080/register \\\n  -d '{\"email\":\"user@example.com\",\"password\":\"securepass\"}' \\\n  -H 'Content-Type: application/json')\necho $RESP  # {\"user_id\":\"<uuid>\",\"email\":\"user@example.com\"}\n# Login\nTOKEN_RESP=$(curl -s -X POST http://localhost:8080/login \\\n  -d '{\"email\":\"user@example.com\",\"password\":\"securepass\"}' \\\n  -H 'Content-Type: application/json')\nTOKEN=$(echo $TOKEN_RESP | python3 -c \"import sys,json; print(json.load(sys.stdin)['token'])\")\n# Me\ncurl -s http://localhost:8080/me \\\n  -H \"Authorization: Bearer $TOKEN\"\n# → {\"user_id\":\"<uuid>\",\"email\":\"user@example.com\"}\n```\n\n### Phase 5: Integration Test (1–2h)\n\nWrite `services/user-service/user_test.go` covering full round trip. See §10 for detailed test specifications. Run with Docker-started `user_db`:\n\n```bash\nDATABASE_URL=\"postgres://useruser:userpass@localhost:5434/userdb\" \\\nJWT_SECRET=\"testsecret-at-least-32-chars-long-ok\" \\\ngo test -v -run TestIntegration ./services/user-service/...\n```\n\n**Checkpoint:** All integration tests PASS. No test leaks connections (each test uses `t.Cleanup`).\n{{DIAGRAM:tdd-diag-9}}\n\n```\nDependency wiring in main.go:\n  loadConfig() ─────────────────────────────────────────────────────┐\n       │                                                             │\n       ▼                                                             ▼\n  NewDBPool() ──► *pgxpool.Pool ──► NewUserStore() ──► UserRepository\n       │                                                             │\n       │          cfg.BCryptCost ──► NewPasswordHasher() ──► PasswordHasher\n       │                                                             │\n       │          cfg.JWTSecret  ──► NewTokenIssuer() ──► TokenIssuer\n       │          cfg.TokenTTL                                       │\n       │                                                             │\n       │          log *slog.Logger                                   │\n       │                                                             ▼\n       └────────────────────────────────────► NewHandler(store, hasher, issuer, log)\n                                                         │\n                                             mux.Handle(\"POST /register\", h.Register)\n                                             mux.Handle(\"POST /login\", h.Login)\n                                             mux.Handle(\"GET /me\",\n                                               JWTMiddleware(secret)(h.Me))\n                                             mux.Handle(\"GET /health\", healthHandler)\n```\n\n---\n\n## 10. Test Specification\n\n### 10.1 Unit Tests — Validators (`validate_test.go`)\n\n```go\nfunc TestValidateEmail(t *testing.T) {\n    cases := []struct {\n        input   string\n        wantErr bool\n    }{\n        {\"user@example.com\", false},\n        {\"user+tag@sub.domain.org\", false},\n        {\"\", true},               // empty\n        {\"notanemail\", true},     // no @\n        {\"@nodomain.com\", true},  // empty local part\n        {\"user@\", true},          // no domain\n        {\"user @example.com\", true}, // space in email\n    }\n    for _, tc := range cases {\n        t.Run(tc.input, func(t *testing.T) {\n            err := validateEmail(tc.input)\n            if (err != nil) != tc.wantErr {\n                t.Errorf(\"validateEmail(%q) err=%v, wantErr=%v\", tc.input, err, tc.wantErr)\n            }\n        })\n    }\n}\nfunc TestValidatePassword(t *testing.T) {\n    cases := []struct {\n        input   string\n        wantErr bool\n    }{\n        {\"12345678\", false},    // exactly 8 chars\n        {\"longerpassword\", false},\n        {\"1234567\", true},      // 7 chars\n        {\"\", true},             // empty\n        {\"       7\", false},    // 8 spaces — valid (no complexity rules)\n    }\n    for _, tc := range cases {\n        t.Run(fmt.Sprintf(\"len%d\", len(tc.input)), func(t *testing.T) {\n            err := validatePassword(tc.input)\n            if (err != nil) != tc.wantErr {\n                t.Errorf(\"validatePassword(%q) err=%v, wantErr=%v\", tc.input, err, tc.wantErr)\n            }\n        })\n    }\n}\n```\n\n### 10.2 Unit Tests — `bcryptHasher`\n\n```go\nfunc TestBcryptHasher_HashAndVerify(t *testing.T) {\n    h := NewPasswordHasher(bcrypt.MinCost) // cost=4 for test speed\n    hash, err := h.Hash(\"mypassword\")\n    if err != nil {\n        t.Fatalf(\"Hash: %v\", err)\n    }\n    if hash == \"\" {\n        t.Fatal(\"hash is empty\")\n    }\n    if err := h.Verify(\"mypassword\", hash); err != nil {\n        t.Errorf(\"Verify correct password: %v\", err)\n    }\n    if err := h.Verify(\"wrongpassword\", hash); !errors.Is(err, ErrPasswordMismatch) {\n        t.Errorf(\"Verify wrong password: got %v, want ErrPasswordMismatch\", err)\n    }\n}\nfunc TestBcryptHasher_DifferentHashesSamePassword(t *testing.T) {\n    h := NewPasswordHasher(bcrypt.MinCost)\n    hash1, _ := h.Hash(\"samepassword\")\n    hash2, _ := h.Hash(\"samepassword\")\n    if hash1 == hash2 {\n        t.Error(\"bcrypt should produce different hashes (different salts)\")\n    }\n    // Both should verify correctly\n    if err := h.Verify(\"samepassword\", hash1); err != nil {\n        t.Errorf(\"hash1 verify: %v\", err)\n    }\n    if err := h.Verify(\"samepassword\", hash2); err != nil {\n        t.Errorf(\"hash2 verify: %v\", err)\n    }\n}\n```\n\n### 10.3 Unit Tests — `jwtTokenIssuer`\n\n```go\nfunc TestJWTTokenIssuer_IssueAndVerify(t *testing.T) {\n    issuer := NewTokenIssuer(\"test-secret-32-chars-long-exactly\", 24*time.Hour)\n    tokenStr, expiresAt, err := issuer.Issue(\"user-uuid-123\", \"user@example.com\")\n    if err != nil {\n        t.Fatalf(\"Issue: %v\", err)\n    }\n    if tokenStr == \"\" {\n        t.Fatal(\"token string is empty\")\n    }\n    if time.Until(expiresAt) < 23*time.Hour {\n        t.Errorf(\"expiresAt too soon: %v\", expiresAt)\n    }\n    claims, err := issuer.Verify(tokenStr)\n    if err != nil {\n        t.Fatalf(\"Verify: %v\", err)\n    }\n    if claims.Sub != \"user-uuid-123\" {\n        t.Errorf(\"sub: got %q\", claims.Sub)\n    }\n    if claims.Email != \"user@example.com\" {\n        t.Errorf(\"email: got %q\", claims.Email)\n    }\n    if claims.Iss != \"url-shortener\" {\n        t.Errorf(\"iss: got %q\", claims.Iss)\n    }\n}\nfunc TestJWTTokenIssuer_Verify_InvalidSignature(t *testing.T) {\n    issuer1 := NewTokenIssuer(\"secret-one-32-chars-long-exactly\", 24*time.Hour)\n    issuer2 := NewTokenIssuer(\"secret-two-32-chars-long-exactly\", 24*time.Hour)\n    tok, _, _ := issuer1.Issue(\"uid\", \"u@e.com\")\n    _, err := issuer2.Verify(tok)\n    if !errors.Is(err, ErrTokenInvalid) {\n        t.Errorf(\"wrong secret verify: got %v, want ErrTokenInvalid\", err)\n    }\n}\nfunc TestJWTTokenIssuer_Verify_Expired(t *testing.T) {\n    issuer := NewTokenIssuer(\"test-secret-32-chars-long-exactly\", -1*time.Hour) // negative TTL → already expired\n    tok, _, _ := issuer.Issue(\"uid\", \"u@e.com\")\n    _, err := issuer.Verify(tok)\n    if !errors.Is(err, ErrTokenInvalid) {\n        t.Errorf(\"expired token verify: got %v, want ErrTokenInvalid\", err)\n    }\n}\nfunc TestJWTTokenIssuer_Verify_Malformed(t *testing.T) {\n    issuer := NewTokenIssuer(\"test-secret-32-chars-long-exactly\", 24*time.Hour)\n    _, err := issuer.Verify(\"not.a.jwt\")\n    if !errors.Is(err, ErrTokenInvalid) {\n        t.Errorf(\"malformed token: got %v, want ErrTokenInvalid\", err)\n    }\n}\n```\n\n### 10.4 Unit Tests — Handlers (with mock store)\n\n```go\n// Mock implementations for handler unit tests:\ntype mockStore struct {\n    insertFn      func(ctx context.Context, email, hash string) (*User, error)\n    findByEmailFn func(ctx context.Context, email string) (*User, error)\n}\nfunc (m *mockStore) Insert(ctx context.Context, email, hash string) (*User, error) {\n    return m.insertFn(ctx, email, hash)\n}\nfunc (m *mockStore) FindByEmail(ctx context.Context, email string) (*User, error) {\n    return m.findByEmailFn(ctx, email)\n}\nfunc TestRegisterHandler_Success(t *testing.T) {\n    store := &mockStore{\n        insertFn: func(ctx context.Context, email, hash string) (*User, error) {\n            return &User{ID: \"test-uuid\", Email: email, CreatedAt: time.Now()}, nil\n        },\n    }\n    issuer := NewTokenIssuer(\"test-secret-32-chars-long-exactly\", time.Hour)\n    h := NewHandler(store, NewPasswordHasher(bcrypt.MinCost), issuer, slog.Default())\n    body := `{\"email\":\"test@example.com\",\"password\":\"securepass\"}`\n    req := httptest.NewRequest(\"POST\", \"/register\", strings.NewReader(body))\n    req.Header.Set(\"Content-Type\", \"application/json\")\n    rec := httptest.NewRecorder()\n    h.Register(rec, req)\n    if rec.Code != 201 {\n        t.Errorf(\"status: got %d want 201, body: %s\", rec.Code, rec.Body.String())\n    }\n    var resp registerResponse\n    json.Unmarshal(rec.Body.Bytes(), &resp)\n    if resp.UserID != \"test-uuid\" {\n        t.Errorf(\"user_id: got %q\", resp.UserID)\n    }\n    // Ensure PasswordHash is NOT in response:\n    if strings.Contains(rec.Body.String(), \"password\") {\n        t.Error(\"response body must not contain password or password_hash\")\n    }\n}\nfunc TestRegisterHandler_DuplicateEmail(t *testing.T) {\n    store := &mockStore{\n        insertFn: func(_ context.Context, _, _ string) (*User, error) {\n            return nil, ErrDuplicateEmail\n        },\n    }\n    h := NewHandler(store, NewPasswordHasher(bcrypt.MinCost), nil, slog.Default())\n    body := `{\"email\":\"dup@example.com\",\"password\":\"password123\"}`\n    req := httptest.NewRequest(\"POST\", \"/register\", strings.NewReader(body))\n    req.Header.Set(\"Content-Type\", \"application/json\")\n    rec := httptest.NewRecorder()\n    h.Register(rec, req)\n    if rec.Code != 409 {\n        t.Errorf(\"status: got %d want 409\", rec.Code)\n    }\n}\nfunc TestRegisterHandler_ShortPassword(t *testing.T) {\n    h := NewHandler(nil, nil, nil, slog.Default())\n    body := `{\"email\":\"user@example.com\",\"password\":\"short\"}`\n    req := httptest.NewRequest(\"POST\", \"/register\", strings.NewReader(body))\n    req.Header.Set(\"Content-Type\", \"application/json\")\n    rec := httptest.NewRecorder()\n    h.Register(rec, req)\n    if rec.Code != 400 {\n        t.Errorf(\"status: got %d want 400\", rec.Code)\n    }\n    var errResp errorResponse\n    json.Unmarshal(rec.Body.Bytes(), &errResp)\n    if errResp.Field != \"password\" {\n        t.Errorf(\"field: got %q want password\", errResp.Field)\n    }\n}\nfunc TestLoginHandler_InvalidCredentials_UnknownEmail(t *testing.T) {\n    store := &mockStore{\n        findByEmailFn: func(_ context.Context, _ string) (*User, error) {\n            return nil, ErrUserNotFound\n        },\n    }\n    h := NewHandler(store, NewPasswordHasher(bcrypt.MinCost), nil, slog.Default())\n    body := `{\"email\":\"nobody@example.com\",\"password\":\"somepassword\"}`\n    req := httptest.NewRequest(\"POST\", \"/login\", strings.NewReader(body))\n    req.Header.Set(\"Content-Type\", \"application/json\")\n    rec := httptest.NewRecorder()\n    h.Login(rec, req)\n    if rec.Code != 401 {\n        t.Errorf(\"status: got %d want 401\", rec.Code)\n    }\n    // Verify response body is generic — no hint of user existence\n    var errResp errorResponse\n    json.Unmarshal(rec.Body.Bytes(), &errResp)\n    if errResp.Error != \"invalid credentials\" {\n        t.Errorf(\"error message: got %q, want opaque message\", errResp.Error)\n    }\n}\nfunc TestLoginHandler_WrongPassword(t *testing.T) {\n    hash, _ := bcrypt.GenerateFromPassword([]byte(\"correctpassword\"), bcrypt.MinCost)\n    store := &mockStore{\n        findByEmailFn: func(_ context.Context, _ string) (*User, error) {\n            return &User{ID: \"uid\", Email: \"u@e.com\", PasswordHash: string(hash)}, nil\n        },\n    }\n    h := NewHandler(store, NewPasswordHasher(bcrypt.MinCost), nil, slog.Default())\n    body := `{\"email\":\"u@e.com\",\"password\":\"wrongpassword\"}`\n    req := httptest.NewRequest(\"POST\", \"/login\", strings.NewReader(body))\n    req.Header.Set(\"Content-Type\", \"application/json\")\n    rec := httptest.NewRecorder()\n    h.Login(rec, req)\n    if rec.Code != 401 {\n        t.Errorf(\"status: got %d want 401\", rec.Code)\n    }\n}\nfunc TestMeHandler_ValidToken(t *testing.T) {\n    claims := &auth.Claims{Sub: \"user-uuid\", Email: \"user@example.com\", Iss: \"url-shortener\"}\n    ctx := context.WithValue(context.Background(), auth.TestClaimsKey{}, claims)\n    req := httptest.NewRequest(\"GET\", \"/me\", nil).WithContext(ctx)\n    rec := httptest.NewRecorder()\n    h := NewHandler(nil, nil, nil, slog.Default())\n    h.Me(rec, req)\n    if rec.Code != 200 {\n        t.Errorf(\"status: got %d\", rec.Code)\n    }\n    var resp meResponse\n    json.Unmarshal(rec.Body.Bytes(), &resp)\n    if resp.UserID != \"user-uuid\" {\n        t.Errorf(\"user_id: got %q\", resp.UserID)\n    }\n}\n```\n\n**Note on `TestClaimsKey`:** Expose an exported key type from `shared/auth` for testing purposes only:\n\n```go\n// shared/auth/auth.go — add alongside unexported claimsKey\n// TestClaimsKey is exported ONLY for use in handler unit tests.\n// Do not use in production code; use JWTMiddleware instead.\ntype TestClaimsKey = claimsKey\n```\n\n### 10.5 Integration Test — Full Round Trip\n\n```go\n// +build integration\n// Run with: go test -tags integration -run TestIntegrationRoundTrip ./services/user-service/...\nfunc TestIntegrationRoundTrip(t *testing.T) {\n    // Requires running user_db at DATABASE_URL env var\n    cfg, err := loadConfig()\n    if err != nil {\n        t.Skipf(\"config not available (set DATABASE_URL, JWT_SECRET): %v\", err)\n    }\n    pool, err := NewDBPool(context.Background(), cfg.DatabaseURL, slog.Default())\n    if err != nil {\n        t.Fatalf(\"db: %v\", err)\n    }\n    t.Cleanup(pool.Close)\n    if err := runMigrations(context.Background(), pool, slog.Default()); err != nil {\n        t.Fatalf(\"migrate: %v\", err)\n    }\n    store := NewUserStore(pool)\n    hasher := NewPasswordHasher(bcrypt.MinCost) // fast cost for tests\n    issuer := NewTokenIssuer(cfg.JWTSecret, cfg.TokenTTL)\n    h := NewHandler(store, hasher, issuer, slog.Default())\n    mux := http.NewServeMux()\n    mux.HandleFunc(\"POST /register\", h.Register)\n    mux.HandleFunc(\"POST /login\", h.Login)\n    mux.Handle(\"GET /me\", auth.JWTMiddleware(cfg.JWTSecret)(http.HandlerFunc(h.Me)))\n    srv := httptest.NewServer(mux)\n    t.Cleanup(srv.Close)\n    email := fmt.Sprintf(\"integration+%d@example.com\", time.Now().UnixNano())\n    password := \"testpassword123\"\n    // Step 1: Register\n    regBody, _ := json.Marshal(map[string]string{\"email\": email, \"password\": password})\n    regResp, err := http.Post(srv.URL+\"/register\", \"application/json\", bytes.NewReader(regBody))\n    if err != nil {\n        t.Fatalf(\"register request: %v\", err)\n    }\n    if regResp.StatusCode != 201 {\n        body, _ := io.ReadAll(regResp.Body)\n        t.Fatalf(\"register: got %d, body: %s\", regResp.StatusCode, body)\n    }\n    var regResult registerResponse\n    json.NewDecoder(regResp.Body).Decode(&regResult)\n    if regResult.UserID == \"\" {\n        t.Fatal(\"user_id is empty\")\n    }\n    // Step 2: Login\n    loginBody, _ := json.Marshal(map[string]string{\"email\": email, \"password\": password})\n    loginResp, _ := http.Post(srv.URL+\"/login\", \"application/json\", bytes.NewReader(loginBody))\n    if loginResp.StatusCode != 200 {\n        body, _ := io.ReadAll(loginResp.Body)\n        t.Fatalf(\"login: got %d, body: %s\", loginResp.StatusCode, body)\n    }\n    var loginResult loginResponse\n    json.NewDecoder(loginResp.Body).Decode(&loginResult)\n    if loginResult.Token == \"\" {\n        t.Fatal(\"token is empty\")\n    }\n    // Step 3: GET /me\n    meReq, _ := http.NewRequest(\"GET\", srv.URL+\"/me\", nil)\n    meReq.Header.Set(\"Authorization\", \"Bearer \"+loginResult.Token)\n    meResp, _ := http.DefaultClient.Do(meReq)\n    if meResp.StatusCode != 200 {\n        body, _ := io.ReadAll(meResp.Body)\n        t.Fatalf(\"me: got %d, body: %s\", meResp.StatusCode, body)\n    }\n    var meResult meResponse\n    json.NewDecoder(meResp.Body).Decode(&meResult)\n    if meResult.UserID != regResult.UserID {\n        t.Errorf(\"user_id mismatch: register=%q me=%q\", regResult.UserID, meResult.UserID)\n    }\n    if meResult.Email != email {\n        t.Errorf(\"email mismatch: got %q want %q\", meResult.Email, email)\n    }\n    // Step 4: Duplicate email returns 409\n    regBody2, _ := json.Marshal(map[string]string{\"email\": email, \"password\": \"differentpassword\"})\n    dupResp, _ := http.Post(srv.URL+\"/register\", \"application/json\", bytes.NewReader(regBody2))\n    if dupResp.StatusCode != 409 {\n        t.Errorf(\"duplicate email: got %d want 409\", dupResp.StatusCode)\n    }\n    // Step 5: Wrong password returns 401 (same body as unknown email)\n    badLoginBody, _ := json.Marshal(map[string]string{\"email\": email, \"password\": \"wrongpassword\"})\n    badLoginResp, _ := http.Post(srv.URL+\"/login\", \"application/json\", bytes.NewReader(badLoginBody))\n    if badLoginResp.StatusCode != 401 {\n        t.Errorf(\"wrong password: got %d want 401\", badLoginResp.StatusCode)\n    }\n    // Step 6: Unknown email returns 401 with identical body\n    unknownLoginBody, _ := json.Marshal(map[string]string{\"email\": \"nobody@example.com\", \"password\": \"whatever\"})\n    unknownLoginResp, _ := http.Post(srv.URL+\"/login\", \"application/json\", bytes.NewReader(unknownLoginBody))\n    if unknownLoginResp.StatusCode != 401 {\n        t.Errorf(\"unknown email: got %d want 401\", unknownLoginResp.StatusCode)\n    }\n    // Verify response bodies are identical (anti-enumeration)\n    badBody, _ := io.ReadAll(badLoginResp.Body)\n    unknownBody, _ := io.ReadAll(unknownLoginResp.Body)\n    if string(badBody) != string(unknownBody) {\n        t.Errorf(\"401 bodies differ: wrong-password=%q unknown-email=%q\", badBody, unknownBody)\n    }\n}\n```\n\n![JWT Claims Layout and Shared Verification Flow](./diagrams/tdd-diag-10.svg)\n\n```\nIntegration test sequence:\n  Test        user-service        user_db\n   │               │                │\n   ├─POST /register─►               │\n   │               ├─INSERT users──►│\n   │               │◄──{id,email}───┤\n   │◄──201{user_id}─┤               │\n   │               │                │\n   ├─POST /login───►               │\n   │               ├─SELECT users──►│\n   │               │◄──{row}────────┤\n   │               ├─bcrypt.Compare │\n   │               ├─jwt.Sign       │\n   │◄──200{token}──┤               │\n   │               │                │\n   ├─GET /me───────►               │\n   │  (Bearer tok) │                │\n   │               ├─jwt.Parse(tok) │  ← no DB call\n   │               ├─context inject │\n   │◄──200{user_id}─┤               │\n   │               │                │\n   ├─POST /register (dup email)     │\n   │               ├─INSERT users──►│\n   │               │◄──PgError 23505┤\n   │◄──409──────────┤               │\n```\n\n---\n\n## 11. Performance Targets\n\n| Operation                                   | Target                    | Measurement Command                                                                            |\n| ------------------------------------------- | ------------------------- | ---------------------------------------------------------------------------------------------- |\n| `POST /register` (bcrypt cost=12)           | < 400ms p99               | `wrk -t4 -c4 -d30s -s register.lua http://localhost:8083/register` — check Latency 99th        |\n| `POST /login` (bcrypt compare cost=12 + DB) | < 500ms p99               | `wrk -t4 -c4 -d30s -s login.lua http://localhost:8083/login`                                   |\n| `GET /me` (local JWT verify, no DB)         | < 2ms p99                 | `wrk -t4 -c20 -d10s http://localhost:8083/me` with valid Bearer token in header via lua script |\n| `GET /health`                               | < 10ms p99                | `wrk -t1 -c10 -d10s http://localhost:8083/health`                                              |\n| `NewDBPool` startup ping                    | < 10s total (10s timeout) | Instrument with `time.Since` around `pool.Ping`; log as `Info`                                 |\n| bcrypt cost=12 single hash                  | < 400ms                   | `go test -bench=BenchmarkHash -benchtime=10s ./services/user-service/`                         |\n\n**bcrypt benchmark:**\n\n```go\nfunc BenchmarkBcryptHash(b *testing.B) {\n    h := NewPasswordHasher(12)\n    b.ResetTimer()\n    for i := 0; i < b.N; i++ {\n        h.Hash(\"benchmarkpassword123\")\n    }\n}\nfunc BenchmarkBcryptVerify(b *testing.B) {\n    h := NewPasswordHasher(12)\n    hash, _ := h.Hash(\"benchmarkpassword123\")\n    b.ResetTimer()\n    for i := 0; i < b.N; i++ {\n        h.Verify(\"benchmarkpassword123\", hash)\n    }\n}\n```\n\nExpected output: `BenchmarkBcryptHash-8    4    280000000 ns/op` (≈280ms per op at cost 12 on modern hardware).\n\n![users Table Schema and Index](./diagrams/tdd-diag-11.svg)\n\n```\nRequest latency breakdown:\nPOST /register:\n  ┌─────────────────────────────────────────────────────┐\n  │ Network + parse: ~1ms                               │\n  │ validateEmail + validatePassword: <1ms              │\n  │ bcrypt.GenerateFromPassword (cost=12): ~250-350ms   │ ← dominates\n  │ pgxpool.Exec INSERT: ~1-3ms                         │\n  │ JSON encode response: <1ms                          │\n  │ TOTAL: ~252-355ms (bcrypt is intentionally slow)    │\n  └─────────────────────────────────────────────────────┘\nPOST /login:\n  ┌─────────────────────────────────────────────────────┐\n  │ Network + parse: ~1ms                               │\n  │ pgxpool.QueryRow SELECT: ~1-2ms                     │\n  │ bcrypt.CompareHashAndPassword (cost=12): ~250-350ms │ ← dominates\n  │ jwt.Sign (HMAC-SHA256): <1ms                        │\n  │ JSON encode response: <1ms                          │\n  │ TOTAL: ~252-354ms                                   │\n  └─────────────────────────────────────────────────────┘\nGET /me:\n  ┌─────────────────────────────────────────────────────┐\n  │ Network + parse: ~0.5ms                             │\n  │ JWTMiddleware (jwt.Parse + HMAC-SHA256): <1ms       │ ← pure computation\n  │ ClaimsFromContext: <0.1ms                           │\n  │ JSON encode response: <0.1ms                        │\n  │ TOTAL: ~1-2ms ✓ well within 2ms p99 target         │\n  └─────────────────────────────────────────────────────┘\n```\n\n---\n\n## 12. `docker-compose.yml` Addition for JWT_SECRET\n\nAdd `JWT_SECRET` to the user-service environment block. The same value must be added to **all** services that consume `shared/auth` in later milestones:\n\n```yaml\nuser-service:\n  environment:\n    DATABASE_URL: postgres://useruser:userpass@user_db:5432/userdb\n    JWT_SECRET: \"change-this-in-production-minimum-32-chars\"\n    PORT: \"8080\"\n```\n\n## Add to `go.work` and `go.mod` replace directives for `shared/auth` in all services that will verify JWTs (url-service, analytics-service, notification-service, gateway) — even though those services don't use it until M3+, adding the dependency now prevents `go.work` synchronization issues\n\n<!-- END_TDD_MOD -->\n\n<!-- TDD_MOD_ID: url-shortener-m3 -->\n\n# URL Service: Shorten, Redirect, CRUD + Domain Event Publishing\n\n## **Module ID:** `url-shortener-m3`\n\n## 1. Module Charter\n\nThis module implements the core business logic of the URL shortener: accepting long URLs, generating collision-resistant 7-character base62 short codes, storing URL records in the `urls` table, serving redirects with a Redis read-through cache, and guaranteeing asynchronous event delivery to RabbitMQ via the outbox pattern. It extends the url-service binary established in M1 with the full HTTP surface (`POST /shorten`, `GET /:code`, `GET /urls`, `DELETE /urls/:code`) and a background outbox worker pool (1 coordinator + 3 workers).\nThis module does **not** implement analytics — click events are published to RabbitMQ and consumed by analytics-service in M4. It does **not** send emails or touch the notification queue. It does **not** implement the API Gateway layer. It does **not** call any other service synchronously — the redirect hot path is entirely self-contained (DB + Redis). It does **not** run database migrations against any service's DB other than `url_db`.\n**Upstream dependencies:** `shared/events` (event struct definitions), `shared/auth` (JWT middleware + `ClaimsFromContext`), `shared/logger` (structured JSON logger), `pgxpool` (from M1 `NewDBPool`), `NewRedisClient` (from M1), `NewRabbitMQConn` (from M1), `url_db` PostgreSQL instance.\n**Downstream consumers:** analytics-service consumes `URLClickedEvent` from queue `analytics.clicks`. notification-service consumes `URLCreatedEvent` and `URLDeletedEvent` from queue `notifications.events`. The outbox pattern guarantees at-least-once delivery to both.\n**Invariants that must always hold:**\n\n- Every `POST /shorten` and `DELETE /urls/:code` writes the URL row and its outbox event in a **single database transaction** — no partial writes ever occur.\n- Redis is never authoritative: every cache miss falls through to PostgreSQL; Redis errors are non-fatal and logged at `Warn` level.\n- Short codes use `crypto/rand` exclusively — `math/rand` is forbidden.\n- Expired URLs (`expires_at < now()`) always return 410, never 404.\n- Deactivated URLs (`is_active = false`) always return 410, never 404.\n- URL ownership is verified on `DELETE` — mismatched `user_id` returns 403.\n- Cache TTL is always `min(expires_at - now, 1h)` for URLs with expiry; `1h` for perpetual URLs; never unbounded.\n\n---\n\n## 2. File Structure\n\nCreate files in the numbered order below. Shared packages exist from M1/M2; only url-service files are new here.\n\n```\nurl-shortener/\n│\n├── shared/                             ← unchanged from M1/M2\n│   ├── events/events.go\n│   ├── auth/auth.go + middleware.go\n│   └── logger/logger.go\n│\n└── services/\n    └── url-service/\n        ├── (from M1, extended)\n        │   ├── go.mod                  ← add dependencies (see §6.3)\n        │   ├── main.go                 ← extend: wire all new components, start outbox\n        │   ├── config.go               ← extend: add ShortURLBase, OutboxPollInterval\n        │   ├── db.go                   ← unchanged\n        │   ├── redis.go                ← unchanged\n        │   ├── rabbitmq.go             ← unchanged\n        │   └── health.go               ← unchanged\n        │\n        ├── 1.  migration.sql           ← urls + outbox tables, all indexes\n        ├── 2.  store.go                ← URLRepository interface + pgxURLStore\n        ├── 3.  outbox_store.go         ← OutboxRepository interface + pgxOutboxStore\n        ├── 4.  base62.go               ← Base62Encoder, alphabet constant\n        ├── 5.  codegen.go              ← ShortCodeGenerator (crypto/rand, collision retry)\n        ├── 6.  cache.go                ← RedisCache: Get/Set/Del with error isolation\n        ├── 7.  publisher.go            ← RabbitMQPublisher interface + amqpPublisher\n        ├── 8.  outbox.go               ← OutboxCoordinator + OutboxWorker\n        ├── 9.  handler.go              ← Handler struct, Shorten/Redirect/ListURLs/DeleteURL\n        ├── 10. validate.go             ← URL format validator (scheme + host check)\n        ├── 11. errors.go               ← sentinel errors, writeError, writeJSON helpers\n        ├── 12. url_test.go             ← unit tests (base62, codegen, handler, cache)\n        └── 13. bench_test.go           ← redirect benchmark\n```\n\n---\n\n## 3. Complete Data Model\n\n### 3.1 PostgreSQL Schema (`migration.sql`)\n\n```sql\n-- ── urls table ────────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS urls (\n    id           UUID         PRIMARY KEY DEFAULT gen_random_uuid(),\n    short_code   VARCHAR(10)  UNIQUE NOT NULL,\n    original_url TEXT         NOT NULL,\n    user_id      UUID         NOT NULL,\n    created_at   TIMESTAMPTZ  NOT NULL DEFAULT now(),\n    expires_at   TIMESTAMPTZ  NULL,         -- NULL means no expiry\n    is_active    BOOLEAN      NOT NULL DEFAULT true\n);\n-- Redirect lookup: short_code → row. UNIQUE implies B-tree index;\n-- explicit name for EXPLAIN ANALYZE verification.\nCREATE UNIQUE INDEX IF NOT EXISTS idx_urls_short_code\n    ON urls(short_code);\n-- Paginated user URL list, newest-first.\n-- Composite index supports: WHERE user_id = $1 AND id > $2 ORDER BY created_at DESC.\nCREATE INDEX IF NOT EXISTS idx_urls_user_id_created\n    ON urls(user_id, created_at DESC);\n-- ── outbox table ──────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS outbox (\n    id           UUID         PRIMARY KEY DEFAULT gen_random_uuid(),\n    event_type   TEXT         NOT NULL,     -- routing key, e.g. \"url.created\"\n    payload      JSONB        NOT NULL,     -- full event struct serialized\n    created_at   TIMESTAMPTZ  NOT NULL DEFAULT now(),\n    published_at TIMESTAMPTZ  NULL          -- NULL = unpublished; set by worker on success\n);\n-- Outbox poller index: fetch only unpublished rows, oldest first.\n-- Partial index omits published rows (WHERE published_at IS NULL) to stay small.\nCREATE INDEX IF NOT EXISTS idx_outbox_unpublished\n    ON outbox(created_at ASC)\n    WHERE published_at IS NULL;\n```\n\n**Column rationale:**\n\n| Column | Type | Constraint | Rationale |\n|---|---|---|---|\n| `urls.id` | UUID | PK | Non-enumerable; used as cursor in pagination |\n| `urls.short_code` | VARCHAR(10) | UNIQUE NOT NULL | 7-char base62 + room for custom codes up to 10 chars |\n| `urls.original_url` | TEXT | NOT NULL | Unbounded URL length; TEXT avoids artificial limit |\n| `urls.user_id` | UUID | NOT NULL | Owner reference; checked on DELETE for 403 |\n| `urls.expires_at` | TIMESTAMPTZ | NULL | NULL = perpetual; compared with `now()` on redirect |\n| `urls.is_active` | BOOLEAN | DEFAULT true | Soft delete; false → 410 Gone |\n| `outbox.event_type` | TEXT | NOT NULL | RabbitMQ routing key; must match `events.EventType*` constants |\n| `outbox.payload` | JSONB | NOT NULL | Full event JSON; worker deserializes to verify, then publishes as AMQP body |\n| `outbox.published_at` | TIMESTAMPTZ | NULL | Poller criterion: `WHERE published_at IS NULL`; set atomically by worker |\n\n### 3.2 Go Structs\n\n```go\n// store.go\npackage urlservice\nimport \"time\"\n// URLRecord is the domain object mapped from the urls table.\n// Never returned directly in HTTP responses — projection structs handle serialization.\ntype URLRecord struct {\n    ID          string     // UUID string\n    ShortCode   string\n    OriginalURL string\n    UserID      string     // UUID string\n    CreatedAt   time.Time\n    ExpiresAt   *time.Time // nil if no expiry\n    IsActive    bool\n}\n// OutboxRecord is the domain object mapped from the outbox table.\ntype OutboxRecord struct {\n    ID          string     // UUID string\n    EventType   string\n    Payload     []byte     // raw JSONB bytes; sent as AMQP message body\n    CreatedAt   time.Time\n    PublishedAt *time.Time // nil if unpublished\n}\n```\n\n```go\n// cache.go\n// CachedURL is the Redis-stored projection for the redirect path.\n// Small enough to fit in a single Redis string value.\n// Storing is_active avoids returning 301 for a deactivated URL cached before deletion.\ntype CachedURL struct {\n    OriginalURL string     `json:\"original_url\"`\n    ExpiresAt   *time.Time `json:\"expires_at,omitempty\"`\n    IsActive    bool       `json:\"is_active\"`\n}\n```\n\n```go\n// handler.go — HTTP request/response types\ntype shortenRequest struct {\n    URL        string  `json:\"url\"`\n    CustomCode *string `json:\"custom_code,omitempty\"` // nil = auto-generate\n    ExpiresAt  *string `json:\"expires_at,omitempty\"`  // RFC3339 string or absent\n}\ntype shortenResponse struct {\n    ShortCode   string  `json:\"short_code\"`\n    ShortURL    string  `json:\"short_url\"`    // cfg.ShortURLBase + \"/\" + short_code\n    OriginalURL string  `json:\"original_url\"`\n    ExpiresAt   *string `json:\"expires_at,omitempty\"` // RFC3339 or absent\n}\ntype urlListItem struct {\n    ShortCode   string  `json:\"short_code\"`\n    OriginalURL string  `json:\"original_url\"`\n    CreatedAt   string  `json:\"created_at\"`           // RFC3339\n    ExpiresAt   *string `json:\"expires_at,omitempty\"` // RFC3339 or absent\n    IsActive    bool    `json:\"is_active\"`\n}\ntype urlListResponse struct {\n    URLs       []urlListItem `json:\"urls\"`\n    NextCursor *string       `json:\"next_cursor\"` // null if no more pages\n}\n```\n\n```go\n// config.go (extended from M1)\ntype Config struct {\n    DatabaseURL         string\n    RedisURL            string\n    RabbitMQURL         string\n    Port                string\n    ServiceName         string\n    JWTSecret           string        // required; added in M2 for other services, now url-service needs it\n    ShortURLBase        string        // e.g. \"http://localhost:8080\" or \"https://sho.rt\"\n    OutboxPollInterval  time.Duration // default 2s; configurable via OUTBOX_POLL_INTERVAL_MS\n    OutboxWorkerCount   int           // default 3; fixed per spec but readable from config\n}\n```\n\n### 3.3 Repository Interfaces\n\n```go\n// store.go — URLRepository\ntype URLRepository interface {\n    // Insert creates a new URL record. Returns ErrShortCodeConflict if short_code already exists.\n    Insert(ctx context.Context, rec *URLRecord) (*URLRecord, error)\n    // FindByCode retrieves a URL by short_code.\n    // Returns ErrURLNotFound if no row exists (active or not).\n    FindByCode(ctx context.Context, shortCode string) (*URLRecord, error)\n    // FindByUserID returns paginated URLs for a user, ordered by created_at DESC.\n    // afterID is the cursor: if non-empty, returns rows with id < afterID in created_at DESC order.\n    // limit is the page size (max 50).\n    // Returns slice (possibly empty) and the next cursor UUID string (empty if no more pages).\n    FindByUserID(ctx context.Context, userID, afterID string, limit int) ([]*URLRecord, string, error)\n    // Deactivate sets is_active=false for the given short_code owned by userID.\n    // Returns ErrURLNotFound if short_code doesn't exist.\n    // Returns ErrNotOwner if the row exists but user_id doesn't match.\n    Deactivate(ctx context.Context, shortCode, userID string) error\n}\n```\n\n```go\n// outbox_store.go — OutboxRepository\ntype OutboxRepository interface {\n    // InsertWithURL inserts a URL record and an outbox row atomically within tx.\n    // Called only by the shorten handler via a transaction helper.\n    // tx is a *pgx.Tx passed from the handler's transaction scope.\n    InsertWithURL(ctx context.Context, tx pgx.Tx, urlRec *URLRecord, outboxRec *OutboxRecord) error\n    // InsertEvent inserts a single outbox row (used for URLDeletedEvent, URLClickedEvent).\n    // Also called within an existing transaction.\n    InsertEvent(ctx context.Context, tx pgx.Tx, outboxRec *OutboxRecord) error\n    // FetchUnpublished returns up to limit outbox rows with published_at IS NULL,\n    // ordered by created_at ASC. Uses SELECT ... FOR UPDATE SKIP LOCKED to prevent\n    // multiple coordinator instances from picking the same row (safe for future scaling).\n    FetchUnpublished(ctx context.Context, limit int) ([]*OutboxRecord, error)\n    // MarkPublished sets published_at = now() for the given outbox row ID.\n    MarkPublished(ctx context.Context, id string) error\n}\n```\n\n```go\n// publisher.go — RabbitMQPublisher\ntype RabbitMQPublisher interface {\n    // Publish sends a message to the exchange with the given routing key.\n    // body is the raw JSON bytes (outbox.payload column value).\n    // Returns error if the AMQP channel is closed or publish fails.\n    Publish(ctx context.Context, routingKey string, body []byte) error\n}\n```\n\n![URL Service Module Architecture](./diagrams/tdd-diag-12.svg)\n\n```\nData ownership and flow:\n                                        url_db (exclusive)\n                                        ┌─────────────────────┐\nurl-service                             │  urls table          │\n┌──────────────────────────────┐        │  outbox table        │\n│  POST /shorten               │        └─────────────────────┘\n│    │                         │               ▲\n│    ▼                         │               │  single transaction\n│  validateURL() + JWT claims  │               │\n│    │                         │        INSERT urls + INSERT outbox\n│    ▼                         │               │\n│  ShortCodeGenerator          │    ───────────┘\n│    │                         │\n│    ▼                         │        outbox rows (published_at IS NULL)\n│  pgxURLStore.Insert(tx) ─────┼──►            │\n│  pgxOutboxStore.Insert(tx) ──┼──►     OutboxCoordinator (polls every 2s)\n│    │                         │               │\n│    ▼                         │        buffered channel (cap=50)\n│  201 response                │               │\n│                              │        3 × OutboxWorker\n│  GET /:code                  │               │\n│    │                         │        amqpPublisher.Publish()\n│    ▼                         │               │\n│  RedisCache.Get(code) ───────┼──► hit: 301   │\n│    │ miss                    │        RabbitMQ exchange \"url-shortener\"\n│    ▼                         │               │\n│  pgxURLStore.FindByCode() ───┼──►     routing key \"url.created\" ──► analytics.clicks\n│    │                         │        routing key \"url.clicked\" ──► notifications.events\n│    ▼                         │        routing key \"url.deleted\" ──► notifications.events\n│  RedisCache.Set(code) ───────┼──►\n│    │                         │\n│    ▼                         │\n│  301 Location redirect       │\n└──────────────────────────────┘\n```\n\n---\n\n## 4. Interface Contracts\n\n### 4.1 `URLRepository` — `pgxURLStore` Implementation\n\n```go\n// store.go\ntype pgxURLStore struct {\n    pool *pgxpool.Pool\n}\nfunc NewURLStore(pool *pgxpool.Pool) URLRepository {\n    return &pgxURLStore{pool: pool}\n}\n```\n\n**`Insert(ctx context.Context, rec *URLRecord) (*URLRecord, error)`**\nCalled within a transaction scope from the shorten handler. The `rec.ID` field is left empty on input — the DB generates it via `DEFAULT gen_random_uuid()`.\n\n```\nSQL:\n  INSERT INTO urls (short_code, original_url, user_id, expires_at)\n  VALUES ($1, $2, $3, $4)\n  RETURNING id, short_code, original_url, user_id, created_at, expires_at, is_active\nParameters: rec.ShortCode, rec.OriginalURL, rec.UserID, rec.ExpiresAt (nil OK)\nOn success:  return populated *URLRecord (all fields from RETURNING clause)\nOn pgError 23505 (unique_violation on short_code): return nil, ErrShortCodeConflict\nOn other DB error: return nil, fmt.Errorf(\"insert url: %w\", err)\n```\n\n**`FindByCode(ctx context.Context, shortCode string) (*URLRecord, error)`**\n\n```\nSQL:\n  SELECT id, short_code, original_url, user_id, created_at, expires_at, is_active\n  FROM urls\n  WHERE short_code = $1\nOn pgx.ErrNoRows: return nil, ErrURLNotFound\nOn success: return *URLRecord with all fields\nOn other DB error: return nil, fmt.Errorf(\"find url by code: %w\", err)\nNote: This returns the row regardless of is_active and expires_at.\n      The caller (handler) decides 404 vs 410 semantics.\n```\n\n**`FindByUserID(ctx context.Context, userID, afterID string, limit int) ([]*URLRecord, string, error)`**\nImplements cursor-based pagination. The cursor is the `id` (UUID) of the last item returned in the previous page. Because `created_at` is the sort column and UUIDs are unique, the cursor resolves to a created_at boundary using a subquery.\n\n```\nWhen afterID == \"\" (first page):\n  SQL:\n    SELECT id, short_code, original_url, user_id, created_at, expires_at, is_active\n    FROM urls\n    WHERE user_id = $1\n    ORDER BY created_at DESC, id DESC\n    LIMIT $2\nWhen afterID != \"\" (subsequent pages):\n  SQL:\n    SELECT id, short_code, original_url, user_id, created_at, expires_at, is_active\n    FROM urls\n    WHERE user_id = $1\n      AND (created_at, id) < (\n          SELECT created_at, id FROM urls WHERE id = $2\n      )\n    ORDER BY created_at DESC, id DESC\n    LIMIT $3\n  Parameters: userID, afterID (cursor UUID), limit+1\nAfter query: fetch limit+1 rows to determine if a next page exists.\n  - If len(rows) == limit+1: nextCursor = rows[limit].ID; return rows[:limit]\n  - If len(rows) <= limit:   nextCursor = \"\"; return rows as-is\n  - Uses idx_urls_user_id_created; verify with EXPLAIN ANALYZE (checkpoint §9)\nOn success: return ([]*URLRecord, nextCursorString, nil)\n  nextCursorString is \"\" if no more pages (JSON null in response)\nOn DB error: return nil, \"\", fmt.Errorf(\"find urls by user: %w\", err)\n```\n\n**`Deactivate(ctx context.Context, shortCode, userID string) error`**\n\n```\nSQL:\n  UPDATE urls\n  SET is_active = false\n  WHERE short_code = $1\n  RETURNING user_id\nOn pgx.ErrNoRows from QueryRow: return ErrURLNotFound\nOn success scan: compare returned user_id with param userID\n  - If different: return ErrNotOwner\n  - If same: return nil\nOn other DB error: return fmt.Errorf(\"deactivate url: %w\", err)\nNote: Uses RETURNING user_id to do ownership check and update in one round-trip.\n```\n\n### 4.2 `OutboxRepository` — `pgxOutboxStore` Implementation\n\n```go\n// outbox_store.go\ntype pgxOutboxStore struct {\n    pool *pgxpool.Pool\n}\nfunc NewOutboxStore(pool *pgxpool.Pool) OutboxRepository {\n    return &pgxOutboxStore{pool: pool}\n}\n```\n\n**`InsertWithURL(ctx context.Context, tx pgx.Tx, urlRec *URLRecord, outboxRec *OutboxRecord) error`**\nBoth inserts execute on the same `pgx.Tx`. Called from the handler's transaction scope.\n\n```go\n// Implementation pattern — caller provides the tx:\nfunc (s *pgxOutboxStore) InsertWithURL(ctx context.Context, tx pgx.Tx, urlRec *URLRecord, outboxRec *OutboxRecord) error {\n    // Insert URL row\n    row := tx.QueryRow(ctx,\n        `INSERT INTO urls (short_code, original_url, user_id, expires_at)\n         VALUES ($1, $2, $3, $4)\n         RETURNING id, short_code, original_url, user_id, created_at, expires_at, is_active`,\n        urlRec.ShortCode, urlRec.OriginalURL, urlRec.UserID, urlRec.ExpiresAt,\n    )\n    if err := row.Scan(&urlRec.ID, &urlRec.ShortCode, &urlRec.OriginalURL,\n        &urlRec.UserID, &urlRec.CreatedAt, &urlRec.ExpiresAt, &urlRec.IsActive); err != nil {\n        if isPgUniqueViolation(err) {\n            return ErrShortCodeConflict\n        }\n        return fmt.Errorf(\"insert url in tx: %w\", err)\n    }\n    // Insert outbox row in same transaction\n    return s.InsertEvent(ctx, tx, outboxRec)\n}\n```\n\n**`InsertEvent(ctx context.Context, tx pgx.Tx, outboxRec *OutboxRecord) error`**\n\n```\nSQL (on tx):\n  INSERT INTO outbox (event_type, payload)\n  VALUES ($1, $2)\n  RETURNING id, created_at\nParameters: outboxRec.EventType, outboxRec.Payload ([]byte)\nOn success: populate outboxRec.ID and outboxRec.CreatedAt from RETURNING clause\nOn error: return fmt.Errorf(\"insert outbox event: %w\", err)\n```\n\n**`FetchUnpublished(ctx context.Context, limit int) ([]*OutboxRecord, error)`**\n\n```\nSQL:\n  SELECT id, event_type, payload, created_at\n  FROM outbox\n  WHERE published_at IS NULL\n  ORDER BY created_at ASC\n  LIMIT $1\n  FOR UPDATE SKIP LOCKED\nParameters: limit (always 50 per coordinator call)\nReturns: slice of *OutboxRecord with ID, EventType, Payload, CreatedAt\nOn empty result: return empty slice, nil (not an error)\nOn DB error: return nil, fmt.Errorf(\"fetch unpublished outbox: %w\", err)\nNote: FOR UPDATE SKIP LOCKED is safe here even with a single coordinator instance.\n      It prevents double-processing if a second coordinator is ever started.\n      The coordinator runs this in a pgxpool.BeginTx context — see §5.5.\n```\n\n**`MarkPublished(ctx context.Context, id string) error`**\n\n```\nSQL:\n  UPDATE outbox SET published_at = now() WHERE id = $1\nOn 0 rows affected: not an error (idempotent; already marked by another instance)\nOn DB error: return fmt.Errorf(\"mark outbox published: %w\", err)\n```\n\n### 4.3 `RedisCache`\n\n```go\n// cache.go\ntype RedisCache struct {\n    client *redis.Client\n    log    *slog.Logger\n}\nfunc NewRedisCache(client *redis.Client, log *slog.Logger) *RedisCache\nconst cacheKeyPrefix = \"url:\"  // key format: \"url:{short_code}\"\nconst defaultCacheTTL = time.Hour\n```\n\n**`Get(ctx context.Context, shortCode string) (*CachedURL, bool)`**\n\n```\nkey := \"url:\" + shortCode\nval, err := c.client.Get(ctx, key).Bytes()\n  - On redis.Nil (key missing): return nil, false   // cache miss — normal\n  - On other error: c.log.Warn(\"redis get failed\", \"key\", key, \"error\", err)\n                    return nil, false               // treat as miss, fall to DB\n  - On success: unmarshal val into *CachedURL\n      - If unmarshal fails: c.log.Warn(\"redis unmarshal failed\", \"key\", key, \"error\", err)\n                            return nil, false        // treat as miss\n      - If success: return &cachedURL, true          // cache hit\n```\n\n**`Set(ctx context.Context, shortCode string, cu *CachedURL, expiresAt *time.Time)`**\n\n```\nkey := \"url:\" + shortCode\nttl := computeTTL(expiresAt)           // see algorithm below\nbody, err := json.Marshal(cu)\n  - If marshal fails: c.log.Warn(\"redis marshal failed\", \"key\", key, \"error\", err); return\nval := c.client.Set(ctx, key, body, ttl)\n  - If val.Err() != nil: c.log.Warn(\"redis set failed\", \"key\", key, \"error\", val.Err())\n  - Either way: return (no error propagated to caller)\ncomputeTTL(expiresAt *time.Time) time.Duration:\n  if expiresAt == nil:\n      return defaultCacheTTL  // 1 hour\n  remaining := time.Until(*expiresAt)\n  if remaining <= 0:\n      return 1 * time.Second  // will expire immediately; don't cache at all in practice\n                               // (handler returns 410 before reaching Set; but guard here)\n  if remaining < defaultCacheTTL:\n      return remaining\n  return defaultCacheTTL\n```\n\n**`Del(ctx context.Context, shortCode string)`**\n\n```\nkey := \"url:\" + shortCode\nerr := c.client.Del(ctx, key).Err()\n  - If err != nil: c.log.Warn(\"redis del failed\", \"key\", key, \"error\", err)\n  - Either way: return (best-effort; caller does not see error)\n```\n\n### 4.4 `Base62Encoder` and `ShortCodeGenerator`\n\n```go\n// base62.go\nconst base62Alphabet = \"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\"\nconst shortCodeLength = 7\n// Encode converts a big.Int to a base62 string of exactly shortCodeLength characters.\n// Pads with '0' (alphabet[0]) on the left if the number requires fewer digits.\nfunc Encode(n *big.Int) string\n// Decode converts a base62 string back to a big.Int (used in tests for round-trip verification).\nfunc Decode(s string) (*big.Int, error)\n```\n\n```go\n// codegen.go\ntype ShortCodeGenerator struct{}\nfunc NewShortCodeGenerator() *ShortCodeGenerator\n// Generate creates a cryptographically random 7-character base62 short code.\n// Uses crypto/rand to fill 5 bytes (40 bits → max value 2^40 = 1,099,511,627,776)\n// then takes modulo 62^7 = 3,521,614,606,208 to map into base62 space.\n//\n// Probability analysis:\n//   62^7 = 3.5 trillion codes.\n//   After 1 million URLs: collision probability ≈ 1.4 × 10^-7 per attempt.\n//   5-retry budget makes the probability of all 5 colliding negligible.\n//\n// Returns: 7-character string from base62Alphabet\n// Never returns an error (crypto/rand failure panics — system entropy failure is unrecoverable)\nfunc (g *ShortCodeGenerator) Generate() string\n```\n\n### 4.5 `RabbitMQPublisher` — `amqpPublisher` Implementation\n\n```go\n// publisher.go\ntype amqpPublisher struct {\n    ch          *amqp.Channel\n    exchangeName string\n    log         *slog.Logger\n}\nfunc NewRabbitMQPublisher(ch *amqp.Channel, log *slog.Logger) RabbitMQPublisher {\n    return &amqpPublisher{ch: ch, exchangeName: \"url-shortener\", log: log}\n}\n```\n\n**`Publish(ctx context.Context, routingKey string, body []byte) error`**\n\n```go\nerr := p.ch.PublishWithContext(ctx,\n    p.exchangeName,  // exchange\n    routingKey,      // routing key = event_type constant\n    false,           // mandatory: false — drop if no queue bound (shouldn't happen)\n    false,           // immediate: false — AMQP 0-9-1 doesn't support immediate\n    amqp.Publishing{\n        ContentType:  \"application/json\",\n        DeliveryMode: amqp.Persistent, // survive broker restart\n        Body:         body,\n    },\n)\nif err != nil:\n    return fmt.Errorf(\"amqp publish %s: %w\", routingKey, err)\nreturn nil\n```\n\n---\n\n## 5. Algorithm Specification\n\n### 5.1 `ShortCodeGenerator.Generate()` — Base62 Random Code\n\n```\nInput:  none\nOutput: 7-character string from base62Alphabet [0-9A-Za-z]\nStep 1: Allocate 8-byte buffer\n  buf := make([]byte, 8)\nStep 2: Fill with crypto/rand\n  if _, err := rand.Read(buf); err != nil {\n      panic(fmt.Sprintf(\"crypto/rand read failed: %v\", err))\n  }\n  // Panicking here is correct: crypto/rand failure means the OS entropy pool\n  // is exhausted — no safe randomness is possible. The process must not continue.\nStep 3: Convert to big.Int and reduce to base62 space\n  n := new(big.Int).SetBytes(buf)\n  // 62^7 = 3,521,614,606,208\n  maxCode := new(big.Int).Exp(big.NewInt(62), big.NewInt(7), nil)\n  n.Mod(n, maxCode)\nStep 4: Encode to base62 string of length 7\n  return Encode(n)  // left-pads with '0' if n encodes to fewer than 7 chars\nEncode(n *big.Int) string:\n  result := make([]byte, shortCodeLength)\n  // Fill right-to-left:\n  sixty2 := big.NewInt(62)\n  mod := new(big.Int)\n  for i := shortCodeLength - 1; i >= 0; i-- {\n      n.DivMod(n, sixty2, mod)\n      result[i] = base62Alphabet[mod.Int64()]\n  }\n  return string(result)\n```\n\n### 5.2 `POST /shorten` Handler — Full Algorithm\n\n```\nInput:  JWT-authenticated request; body: shortenRequest\nOutput: 201 {short_code, short_url, original_url, expires_at} | 400 | 409 | 422 | 503\nStep 1: Extract JWT claims\n  claims, ok := auth.ClaimsFromContext(r.Context())\n  if !ok: writeError(w, 401, \"unauthorized\", \"\"); return\nStep 2: Decode and validate request body\n  Limit body: r.Body = http.MaxBytesReader(w, r.Body, 1<<20)\n  var req shortenRequest\n  if err := json.NewDecoder(r.Body).Decode(&req); err != nil:\n      writeError(w, 400, \"invalid request body\", \"\"); return\nStep 3: Validate URL\n  if err := validateURL(req.URL); err != nil:\n      writeError(w, 422, err.Error(), \"url\"); return\nStep 4: Parse optional expires_at\n  var expiresAt *time.Time\n  if req.ExpiresAt != nil:\n      t, err := time.Parse(time.RFC3339, *req.ExpiresAt)\n      if err != nil:\n          writeError(w, 422, \"expires_at must be RFC3339 format\", \"expires_at\"); return\n      if t.Before(time.Now()):\n          writeError(w, 422, \"expires_at must be in the future\", \"expires_at\"); return\n      expiresAt = &t\nStep 5: Determine short code\n  var shortCode string\n  if req.CustomCode != nil:\n      shortCode = *req.CustomCode\n      if len(shortCode) == 0 || len(shortCode) > 10:\n          writeError(w, 422, \"custom_code must be 1-10 characters\", \"custom_code\"); return\n      // Custom code: attempt insert directly; DB unique constraint handles conflict\n      // (no retry loop for custom codes)\n  else:\n      shortCode = \"\"  // will be set in retry loop below\nStep 6: Insert URL + outbox in single transaction (with collision retry)\n  const maxRetries = 5\n  var urlRec *URLRecord\n  var insertErr error\n  for attempt := 0; attempt < maxRetries; attempt++:\n      if shortCode == \"\" {  // auto-generate\n          shortCode = h.codegen.Generate()\n      }\n      urlRec = &URLRecord{\n          ShortCode:   shortCode,\n          OriginalURL: req.URL,\n          UserID:      claims.Sub,\n          ExpiresAt:   expiresAt,\n      }\n      // Build outbox record (payload serialized before tx opens)\n      event := &events.URLCreatedEvent{\n          BaseEvent: events.BaseEvent{\n              EventType:     events.EventTypeURLCreated,\n              OccurredAt:    time.Now().UTC(),\n              CorrelationID: correlationIDFromContext(r.Context()),\n              EventID:       newUUID(),\n          },\n          ShortCode:   shortCode,\n          OriginalURL: req.URL,\n          UserID:      claims.Sub,\n          UserEmail:   claims.Email,\n          ExpiresAt:   expiresAt,\n      }\n      payload, err := json.Marshal(event)\n      if err != nil:\n          log.Error(\"marshal URLCreatedEvent\", \"error\", err)\n          writeError(w, 500, \"internal server error\", \"\"); return\n      outboxRec := &OutboxRecord{\n          EventType: events.EventTypeURLCreated,\n          Payload:   payload,\n      }\n      // Open transaction\n      tx, err := h.pool.Begin(r.Context())\n      if err != nil:\n          log.Error(\"begin tx\", \"error\", err)\n          writeError(w, 500, \"internal server error\", \"\"); return\n      insertErr = h.outboxStore.InsertWithURL(r.Context(), tx, urlRec, outboxRec)\n      if insertErr == nil:\n          if err := tx.Commit(r.Context()); err != nil:\n              tx.Rollback(r.Context())\n              log.Error(\"commit tx\", \"error\", err)\n              writeError(w, 500, \"internal server error\", \"\"); return\n          break  // success\n      tx.Rollback(r.Context())\n      if errors.Is(insertErr, ErrShortCodeConflict):\n          if req.CustomCode != nil:\n              // Custom code conflict is permanent — do not retry\n              writeError(w, 409, \"short code already taken\", \"custom_code\"); return\n          // Auto-generated: reset and retry with new code\n          shortCode = \"\"\n          continue\n      // Other DB error\n      log.Error(\"insert url+outbox\", \"error\", insertErr, \"attempt\", attempt)\n      writeError(w, 500, \"internal server error\", \"\"); return\n  if insertErr != nil:\n      // Exhausted maxRetries on collision\n      log.Error(\"short code collision exhausted\", \"attempts\", maxRetries)\n      writeError(w, 503, \"service temporarily unavailable, try again\", \"\"); return\nStep 7: Write response\n  var expiresAtStr *string\n  if urlRec.ExpiresAt != nil:\n      s := urlRec.ExpiresAt.Format(time.RFC3339)\n      expiresAtStr = &s\n  writeJSON(w, 201, shortenResponse{\n      ShortCode:   urlRec.ShortCode,\n      ShortURL:    h.cfg.ShortURLBase + \"/\" + urlRec.ShortCode,\n      OriginalURL: urlRec.OriginalURL,\n      ExpiresAt:   expiresAtStr,\n  })\n```\n\n### 5.3 `GET /:code` — Read-Through Cache Redirect\n\n```\nInput:  path parameter: code string (from URL path)\nOutput: 301 Location | 404 | 410\nStep 1: Extract short_code from path\n  code := r.PathValue(\"code\")   // Go 1.22+ net/http pattern: \"GET /{code}\"\n  if code == \"\": writeError(w, 404, \"not found\", \"\"); return\nStep 2: Try Redis cache\n  cacheCtx, cancel := context.WithTimeout(r.Context(), 50*time.Millisecond)\n  defer cancel()\n  cached, hit := h.cache.Get(cacheCtx, code)\n  if hit:\n      if !cached.IsActive:\n          writeError(w, 410, \"url has been deactivated\", \"\"); return\n      if cached.ExpiresAt != nil && cached.ExpiresAt.Before(time.Now()):\n          writeError(w, 410, \"url has expired\", \"\"); return\n      http.Redirect(w, r, cached.OriginalURL, http.StatusMovedPermanently)  // 301\n      return\nStep 3: Cache miss — query PostgreSQL\n  urlRec, err := h.urlStore.FindByCode(r.Context(), code)\n  if errors.Is(err, ErrURLNotFound):\n      writeError(w, 404, \"short url not found\", \"\"); return\n  if err != nil:\n      h.log.Error(\"find url by code\", \"code\", code, \"error\", err)\n      writeError(w, 500, \"internal server error\", \"\"); return\nStep 4: Evaluate active + expiry state\n  if !urlRec.IsActive:\n      // Do NOT cache deactivated URLs\n      writeError(w, 410, \"url has been deactivated\", \"\"); return\n  if urlRec.ExpiresAt != nil && urlRec.ExpiresAt.Before(time.Now()):\n      // Do NOT cache expired URLs (TTL would be negative)\n      writeError(w, 410, \"url has expired\", \"\"); return\nStep 5: Populate cache (non-blocking, errors swallowed inside Set)\n  setCtx, cancel := context.WithTimeout(r.Context(), 100*time.Millisecond)\n  defer cancel()\n  h.cache.Set(setCtx, code, &CachedURL{\n      OriginalURL: urlRec.OriginalURL,\n      ExpiresAt:   urlRec.ExpiresAt,\n      IsActive:    urlRec.IsActive,\n  }, urlRec.ExpiresAt)\nStep 6: Write click event to outbox (same transaction as redirect is impractical —\n        redirect is a read, not a write. Click event MUST be in its own transaction\n        to be atomic. If service crashes between redirect and click insert, event\n        is lost — this is acceptable per spec: the redirect happened; the click\n        event may be delayed or lost. The outbox pattern provides at-least-once\n        for the write path, not for reads.)\n  clickEvent := &events.URLClickedEvent{\n      BaseEvent: events.BaseEvent{\n          EventType:     events.EventTypeURLClicked,\n          OccurredAt:    time.Now().UTC(),\n          CorrelationID: correlationIDFromContext(r.Context()),\n          EventID:       newUUID(),\n      },\n      ShortCode: code,\n      IPHash:    hashIP(r.RemoteAddr),  // SHA-256(IP + salt), see §5.6\n      UserAgent: r.Header.Get(\"User-Agent\"),\n      Referer:   r.Header.Get(\"Referer\"),\n      ClickedAt: time.Now().UTC(),\n  }\n  payload, err := json.Marshal(clickEvent)\n  if err == nil:\n      tx, err := h.pool.Begin(r.Context())\n      if err == nil:\n          outboxRec := &OutboxRecord{EventType: events.EventTypeURLClicked, Payload: payload}\n          if err := h.outboxStore.InsertEvent(r.Context(), tx, outboxRec); err != nil:\n              tx.Rollback(r.Context())\n              h.log.Warn(\"insert click event outbox\", \"code\", code, \"error\", err)\n          else:\n              if err := tx.Commit(r.Context()); err != nil:\n                  h.log.Warn(\"commit click event tx\", \"error\", err)\n      else:\n          h.log.Warn(\"begin click tx\", \"error\", err)\n  // Click event failure is always non-fatal — redirect proceeds regardless\nStep 7: Redirect\n  http.Redirect(w, r, urlRec.OriginalURL, http.StatusMovedPermanently)  // 301\n```\n\n**Critical design note on click atomicity:** The M3 spec states the outbox write must be atomic. For `URLClickedEvent`, this is written in its own transaction immediately after the redirect decision is made. If the process crashes after writing the redirect response but before committing the outbox row, the click is lost — this is the acceptable trade-off documented in the spec. The alternative (writing the event before sending the redirect) risks a phantom event if the redirect fails. The outbox guarantees at-least-once for events that do commit; it cannot guarantee events for HTTP responses already sent.\n\n### 5.4 `DELETE /urls/:code` Handler\n\n```\nInput:  JWT-authenticated; path param: code\nOutput: 204 | 403 | 404 | 500\nStep 1: Extract claims\n  claims, ok := auth.ClaimsFromContext(r.Context())\n  if !ok: writeError(w, 401, \"unauthorized\", \"\"); return\nStep 2: Deactivate in DB (ownership check inside store)\n  tx, err := h.pool.Begin(r.Context())\n  if err != nil: writeError(w, 500, \"internal server error\", \"\"); return\n  // Must read the URL before deactivating to build the event payload\n  urlRec, err := h.urlStore.FindByCode(r.Context(), r.PathValue(\"code\"))\n  if errors.Is(err, ErrURLNotFound): tx.Rollback(r.Context()); writeError(w, 404, ...); return\n  if err != nil: tx.Rollback(r.Context()); writeError(w, 500, ...); return\n  if urlRec.UserID != claims.Sub: tx.Rollback(r.Context()); writeError(w, 403, \"forbidden\", \"\"); return\n  // Deactivate (UPDATE within same tx)\n  // Execute: UPDATE urls SET is_active = false WHERE short_code = $1 AND user_id = $2\n  _, err = tx.Exec(r.Context(),\n      `UPDATE urls SET is_active = false WHERE short_code = $1 AND user_id = $2`,\n      r.PathValue(\"code\"), claims.Sub)\n  if err != nil: tx.Rollback(r.Context()); writeError(w, 500, ...); return\nStep 3: Insert URLDeletedEvent into outbox (same tx)\n  event := &events.URLDeletedEvent{\n      BaseEvent: events.BaseEvent{\n          EventType:     events.EventTypeURLDeleted,\n          OccurredAt:    time.Now().UTC(),\n          CorrelationID: correlationIDFromContext(r.Context()),\n          EventID:       newUUID(),\n      },\n      ShortCode: r.PathValue(\"code\"),\n      UserID:    claims.Sub,\n      UserEmail: claims.Email,\n  }\n  payload, _ := json.Marshal(event)\n  outboxRec := &OutboxRecord{EventType: events.EventTypeURLDeleted, Payload: payload}\n  if err := h.outboxStore.InsertEvent(r.Context(), tx, outboxRec); err != nil:\n      tx.Rollback(r.Context())\n      h.log.Error(\"insert delete event outbox\", \"error\", err)\n      writeError(w, 500, \"internal server error\", \"\"); return\nStep 4: Commit\n  if err := tx.Commit(r.Context()); err != nil:\n      h.log.Error(\"commit delete tx\", \"error\", err)\n      writeError(w, 500, \"internal server error\", \"\"); return\nStep 5: Invalidate Redis cache (best-effort, after commit)\n  delCtx, cancel := context.WithTimeout(context.Background(), 200*time.Millisecond)\n  defer cancel()\n  h.cache.Del(delCtx, r.PathValue(\"code\"))\n  // h.cache.Del always returns void; errors are logged inside Del\nStep 6: Write 204 No Content\n  w.WriteHeader(http.StatusNoContent)\n```\n\n### 5.5 Outbox Coordinator + Worker Pool\n\n![urls and outbox Table Schemas with Index Annotations](./diagrams/tdd-diag-13.svg)\n\n```\nOutbox architecture:\n  main.go\n    │ go outboxCoordinator.Run(ctx)\n    │\n  OutboxCoordinator\n    │ every 2s: FetchUnpublished(limit=50)\n    │ for each row:\n    │   workerCh <- row                    ← buffered channel, cap=50\n    │\n  OutboxWorker × 3 (goroutines)\n    │ for row := range workerCh:\n    │   publisher.Publish(row.EventType, row.Payload)\n    │   outboxStore.MarkPublished(row.ID)\n    │\n  Graceful shutdown:\n    ctx cancelled → coordinator stops polling → workerCh drained → workers exit\n```\n\n```go\n// outbox.go\ntype OutboxCoordinator struct {\n    store     OutboxRepository\n    workerCh  chan *OutboxRecord\n    log       *slog.Logger\n    interval  time.Duration\n    workerCount int\n}\nfunc NewOutboxCoordinator(\n    store OutboxRepository,\n    publisher RabbitMQPublisher,\n    log *slog.Logger,\n    interval time.Duration,\n    workerCount int,\n) *OutboxCoordinator\n// Run starts the coordinator and worker goroutines.\n// Blocks until ctx is cancelled.\n// Called with `go coordinator.Run(ctx)` in main.go.\nfunc (c *OutboxCoordinator) Run(ctx context.Context)\n```\n\n**`OutboxCoordinator.Run(ctx context.Context)` Algorithm:**\n\n```\nStep 1: Create buffered worker channel\n  workerCh := make(chan *OutboxRecord, 50)\nStep 2: Start worker goroutines\n  var wg sync.WaitGroup\n  for i := 0; i < c.workerCount; i++:\n      wg.Add(1)\n      go func():\n          defer wg.Done()\n          c.runWorker(ctx, workerCh)\n      ()\nStep 3: Poll loop\n  ticker := time.NewTicker(c.interval)\n  defer ticker.Stop()\n  for:\n      select:\n      case <-ctx.Done():\n          close(workerCh)   // signal workers to drain and exit\n          wg.Wait()         // wait for all workers to finish in-flight publishes\n          c.log.Info(\"outbox coordinator stopped\")\n          return\n      case <-ticker.C:\n          c.poll(ctx, workerCh)\npoll(ctx context.Context, workerCh chan *OutboxRecord):\n  rows, err := c.store.FetchUnpublished(ctx, 50)\n  if err != nil:\n      c.log.Warn(\"outbox fetch failed\", \"error\", err); return\n  for _, row := range rows:\n      select:\n      case workerCh <- row:  // send to available worker\n      case <-ctx.Done():\n          return              // coordinator is shutting down\nrunWorker(ctx context.Context, workerCh <-chan *OutboxRecord):\n  for row := range workerCh:   // exits when channel is closed\n      publishCtx, cancel := context.WithTimeout(ctx, 5*time.Second)\n      err := c.publisher.Publish(publishCtx, row.EventType, row.Payload)\n      cancel()\n      if err != nil:\n          c.log.Warn(\"outbox publish failed\",\n              \"event_type\", row.EventType,\n              \"outbox_id\", row.ID,\n              \"error\", err)\n          // Leave published_at NULL — coordinator will re-fetch on next poll\n          continue\n      if err := c.store.MarkPublished(context.Background(), row.ID); err != nil:\n          c.log.Warn(\"outbox mark published failed\",\n              \"outbox_id\", row.ID,\n              \"error\", err)\n          // RabbitMQ got the message but DB update failed.\n          // Next poll will re-fetch this row and re-publish.\n          // Consumer must handle duplicate events (analytics-service does this in M4).\n```\n\n**Why `FOR UPDATE SKIP LOCKED` matters:** If `MarkPublished` fails after a successful publish, the row remains in `published_at IS NULL` state. The next poll cycle picks it up and publishes again. The consumer (analytics-service) deduplicates by `EventID`. This is the at-least-once guarantee.\n\n### 5.6 IP Hashing (`hashIP`)\n\n```go\n// handler.go helper\nimport (\n    \"crypto/sha256\"\n    \"fmt\"\n    \"net\"\n    \"os\"\n)\nvar ipHashSalt = os.Getenv(\"IP_HASH_SALT\") // set in docker-compose env; empty string is acceptable fallback\nfunc hashIP(remoteAddr string) string {\n    ip, _, err := net.SplitHostPort(remoteAddr)\n    if err != nil {\n        ip = remoteAddr // fallback: use raw if port parsing fails\n    }\n    h := sha256.Sum256([]byte(ip + ipHashSalt))\n    return fmt.Sprintf(\"%x\", h)\n}\n```\n\n### 5.7 Startup Migration\n\n```go\n// main.go — after NewDBPool succeeds\nconst urlServiceSchema = `\nCREATE TABLE IF NOT EXISTS urls (\n    id           UUID         PRIMARY KEY DEFAULT gen_random_uuid(),\n    short_code   VARCHAR(10)  UNIQUE NOT NULL,\n    original_url TEXT         NOT NULL,\n    user_id      UUID         NOT NULL,\n    created_at   TIMESTAMPTZ  NOT NULL DEFAULT now(),\n    expires_at   TIMESTAMPTZ  NULL,\n    is_active    BOOLEAN      NOT NULL DEFAULT true\n);\nCREATE UNIQUE INDEX IF NOT EXISTS idx_urls_short_code ON urls(short_code);\nCREATE INDEX IF NOT EXISTS idx_urls_user_id_created ON urls(user_id, created_at DESC);\nCREATE TABLE IF NOT EXISTS outbox (\n    id           UUID         PRIMARY KEY DEFAULT gen_random_uuid(),\n    event_type   TEXT         NOT NULL,\n    payload      JSONB        NOT NULL,\n    created_at   TIMESTAMPTZ  NOT NULL DEFAULT now(),\n    published_at TIMESTAMPTZ  NULL\n);\nCREATE INDEX IF NOT EXISTS idx_outbox_unpublished\n    ON outbox(created_at ASC) WHERE published_at IS NULL;\n`\n```\n\n### 5.8 Route Registration in `main.go`\n\n```go\n// main.go (extended from M1)\nmux := http.NewServeMux()\nmux.HandleFunc(\"GET /health\", NewHealthHandler(cfg.ServiceName))\n// Protected routes (JWT required)\nauthMw := auth.JWTMiddleware(cfg.JWTSecret)\nmux.Handle(\"POST /shorten\",       authMw(http.HandlerFunc(h.Shorten)))\nmux.Handle(\"GET /urls\",           authMw(http.HandlerFunc(h.ListURLs)))\nmux.Handle(\"DELETE /urls/{code}\", authMw(http.HandlerFunc(h.DeleteURL)))\n// Anonymous route\nmux.HandleFunc(\"GET /{code}\", h.Redirect)\n// Start outbox coordinator (before HTTP server, after RabbitMQ connected)\nappCtx, appCancel := context.WithCancel(context.Background())\ncoordinator := NewOutboxCoordinator(\n    outboxStore,\n    NewRabbitMQPublisher(mq.Channel, log),\n    log,\n    cfg.OutboxPollInterval,\n    cfg.OutboxWorkerCount,\n)\ngo coordinator.Run(appCtx)\n// On SIGTERM/SIGINT: appCancel() before pool.Close()\n```\n\n![Base62 Short Code Generation Algorithm](./diagrams/tdd-diag-14.svg)\n\n```\nmain.go startup sequence (url-service, M3 extended):\n  loadConfig()\n       │ ← fatal if DATABASE_URL | RABBITMQ_URL | REDIS_URL | JWT_SECRET missing\n       ▼\n  logger.New(\"url-service\")\n       ▼\n  NewDBPool() ── fatal on error\n       ▼\n  runMigrations(pool) ── fatal on error\n       ▼\n  NewRedisClient() ── warn+continue on error\n       ▼\n  NewRabbitMQConn() ── fatal after 10 attempts\n       ▼\n  NewURLStore(pool)\n  NewOutboxStore(pool)\n  NewShortCodeGenerator()\n  NewRedisCache(redisClient, log)\n  NewRabbitMQPublisher(mq.Channel, log)\n  NewHandler(...)\n       ▼\n  coordinator := NewOutboxCoordinator(outboxStore, publisher, log, 2s, 3)\n  go coordinator.Run(appCtx)     ← background goroutine\n       ▼\n  mux := http.NewServeMux()\n  mux.Handle(...)                ← all routes registered\n       ▼\n  srv.ListenAndServe()           ← blocks\n       │\n       │ SIGTERM received\n       ▼\n  appCancel()   ← stops coordinator and workers\n  srv.Shutdown(ctx)\n  mq.Close()\n  redisClient.Close()\n  pool.Close()\n```\n\n### 5.9 `validateURL` Function\n\n```go\n// validate.go\nfunc validateURL(rawURL string) error {\n    if rawURL == \"\" {\n        return errors.New(\"url is required\")\n    }\n    u, err := url.Parse(rawURL)\n    if err != nil {\n        return fmt.Errorf(\"invalid url: %w\", err)\n    }\n    if u.Scheme == \"\" {\n        return errors.New(\"url must include a scheme (http:// or https://)\")\n    }\n    if u.Scheme != \"http\" && u.Scheme != \"https\" {\n        return fmt.Errorf(\"url scheme must be http or https, got %q\", u.Scheme)\n    }\n    if u.Host == \"\" {\n        return errors.New(\"url must include a host\")\n    }\n    return nil\n}\n```\n\n### 5.10 Correlation ID Propagation\n\n```go\n// handler.go helper — reads X-Correlation-ID from request context or header\n// The correlation ID is injected by the gateway in M5; for direct calls it may be absent.\ntype correlationKey struct{}\nfunc correlationIDFromContext(ctx context.Context) string {\n    if id, ok := ctx.Value(correlationKey{}).(string); ok && id != \"\" {\n        return id\n    }\n    return newUUID() // generate one if missing (direct service call without gateway)\n}\n// Middleware to read X-Correlation-ID header and inject into context.\n// Applied to all routes in main.go before auth middleware.\nfunc CorrelationIDMiddleware(next http.Handler) http.Handler {\n    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n        id := r.Header.Get(\"X-Correlation-ID\")\n        if id == \"\" {\n            id = newUUID()\n        }\n        ctx := context.WithValue(r.Context(), correlationKey{}, id)\n        w.Header().Set(\"X-Correlation-ID\", id) // echo back to client\n        next.ServeHTTP(w, r.WithContext(ctx))\n    })\n}\n// newUUID returns a random UUID v4 string using crypto/rand.\nfunc newUUID() string {\n    b := make([]byte, 16)\n    rand.Read(b)\n    b[6] = (b[6] & 0x0f) | 0x40 // version 4\n    b[8] = (b[8] & 0x3f) | 0x80 // variant bits\n    return fmt.Sprintf(\"%08x-%04x-%04x-%04x-%012x\",\n        b[0:4], b[4:6], b[6:8], b[8:10], b[10:16])\n}\n```\n\n---\n\n## 6. Error Handling Matrix\n\n| Error Scenario                    | Detected By                                    | HTTP Status                 | Response Body                                                        | Log Level | Notes                                      |\n| --------------------------------- | ---------------------------------------------- | --------------------------- | -------------------------------------------------------------------- | --------- | ------------------------------------------ |\n| Missing JWT / invalid token       | `JWTMiddleware`                                | 401                         | `{\"error\":\"unauthorized\"}`                                           | none      | Handled before handler                     |\n| Invalid JSON request body         | `json.Decode`                                  | 400                         | `{\"error\":\"invalid request body\"}`                                   | Warn      | Log path + size                            |\n| URL missing scheme                | `validateURL`                                  | 422                         | `{\"error\":\"url must include a scheme...\",\"field\":\"url\"}`             | none      |                                            |\n| URL non-http scheme               | `validateURL`                                  | 422                         | `{\"error\":\"url scheme must be http or https...\",\"field\":\"url\"}`      | none      |                                            |\n| URL missing host                  | `validateURL`                                  | 422                         | `{\"error\":\"url must include a host\",\"field\":\"url\"}`                  | none      |                                            |\n| `expires_at` malformed            | RFC3339 parse                                  | 422                         | `{\"error\":\"expires_at must be RFC3339 format\",\"field\":\"expires_at\"}` | none      |                                            |\n| `expires_at` in past              | time comparison                                | 422                         | `{\"error\":\"expires_at must be in the future\",\"field\":\"expires_at\"}`  | none      |                                            |\n| Custom code already taken         | `ErrShortCodeConflict`, `custom_code != nil`   | 409                         | `{\"error\":\"short code already taken\",\"field\":\"custom_code\"}`         | Info      |                                            |\n| Auto-code collision × 5           | `ErrShortCodeConflict` × 5, attempts exhausted | 503                         | `{\"error\":\"service temporarily unavailable, try again\"}`             | Error     | Include attempt count                      |\n| DB error on INSERT urls           | `InsertWithURL` non-conflict                   | 500                         | `{\"error\":\"internal server error\"}`                                  | Error     | Log full error                             |\n| DB begin tx error                 | `pool.Begin`                                   | 500                         | `{\"error\":\"internal server error\"}`                                  | Error     |                                            |\n| DB commit error                   | `tx.Commit`                                    | 500                         | `{\"error\":\"internal server error\"}`                                  | Error     |                                            |\n| `GET /:code` not found            | `ErrURLNotFound`                               | 404                         | `{\"error\":\"short url not found\"}`                                    | none      |                                            |\n| `GET /:code` is_active=false      | `urlRec.IsActive == false`                     | 410                         | `{\"error\":\"url has been deactivated\"}`                               | none      |                                            |\n| `GET /:code` expired              | `expires_at < now()`                           | 410                         | `{\"error\":\"url has expired\"}`                                        | none      |                                            |\n| Redis GET error                   | `client.Get` non-nil error                     | cache miss (fall through)   | none (no HTTP error)                                                 | Warn      | `\"redis get failed\"`                       |\n| Redis SET error                   | `client.Set` non-nil error                     | none (redirect succeeds)    | none                                                                 | Warn      | `\"redis set failed\"`                       |\n| Redis DEL error                   | `client.Del` non-nil error                     | none (204 proceeds)         | none                                                                 | Warn      | `\"redis del failed\"`                       |\n| `GET /urls` DB error              | `FindByUserID`                                 | 500                         | `{\"error\":\"internal server error\"}`                                  | Error     |                                            |\n| `GET /urls` invalid cursor        | UUID parse fail on `after` param               | 400                         | `{\"error\":\"invalid cursor\",\"field\":\"after\"}`                         | none      |                                            |\n| `DELETE` URL not found            | `ErrURLNotFound`                               | 404                         | `{\"error\":\"short url not found\"}`                                    | none      |                                            |\n| `DELETE` wrong owner              | `urlRec.UserID != claims.Sub`                  | 403                         | `{\"error\":\"forbidden\"}`                                              | Info      | Log user_id + owner                        |\n| `DELETE` DB error                 | any non-sentinel DB err                        | 500                         | `{\"error\":\"internal server error\"}`                                  | Error     |                                            |\n| Outbox publish failure            | `amqpPublisher.Publish`                        | no HTTP (background)        | —                                                                    | Warn      | `\"outbox_id\"`, `\"event_type\"`, `\"error\"`   |\n| Outbox MarkPublished failure      | `MarkPublished`                                | no HTTP (background)        | —                                                                    | Warn      | Same fields; row re-published next cycle   |\n| Outbox FetchUnpublished failure   | `FetchUnpublished`                             | no HTTP (background)        | —                                                                    | Warn      | `\"error\"`; coordinator continues next tick |\n| Click event outbox insert failure | tx.Exec or InsertEvent                         | no HTTP (redirect proceeds) | —                                                                    | Warn      | `\"code\"`, `\"error\"`                        |\n| `crypto/rand.Read` failure        | `ShortCodeGenerator.Generate`                  | process panic               | —                                                                    | —         | Unrecoverable; OS entropy exhausted        |\n\n**`writeError` helper:**\n\n```go\n// errors.go\nfunc writeError(w http.ResponseWriter, status int, message, field string) {\n    w.Header().Set(\"Content-Type\", \"application/json\")\n    w.WriteHeader(status)\n    resp := struct {\n        Error string `json:\"error\"`\n        Field string `json:\"field,omitempty\"`\n    }{Error: message, Field: field}\n    json.NewEncoder(w).Encode(resp)\n}\nfunc writeJSON(w http.ResponseWriter, status int, v any) {\n    w.Header().Set(\"Content-Type\", \"application/json\")\n    w.WriteHeader(status)\n    json.NewEncoder(w).Encode(v)\n}\n```\n\n**Sentinel errors:**\n\n```go\n// errors.go\nvar (\n    ErrShortCodeConflict = errors.New(\"short code already exists\")\n    ErrURLNotFound       = errors.New(\"url not found\")\n    ErrNotOwner          = errors.New(\"not the url owner\")\n)\n```\n\n---\n\n## 7. Concurrency Specification\n\n| Component                | Goroutine                     | Shared State                                                    | Thread Safety                                                                                |\n| ------------------------ | ----------------------------- | --------------------------------------------------------------- | -------------------------------------------------------------------------------------------- |\n| HTTP handlers            | per-request (net/http)        | `*pgxpool.Pool`, `*RedisCache`, `*OutboxStore`                  | ✅ All safe: pgxpool is goroutine-safe; RedisCache is stateless; OutboxStore holds only pool |\n| `OutboxCoordinator.Run`  | 1 dedicated goroutine         | `workerCh chan *OutboxRecord`, `OutboxRepository`               | ✅ Channel is the only shared state; only coordinator sends                                  |\n| `OutboxWorker.runWorker` | 3 dedicated goroutines        | `workerCh` (read-only), `RabbitMQPublisher`, `OutboxRepository` | ✅ Workers only read from channel; pool is goroutine-safe                                    |\n| `amqpPublisher.Publish`  | called from worker goroutines | `*amqp.Channel`                                                 | ⚠️ **NOT safe** for concurrent calls — see below                                             |\n| `RedisCache`             | called from HTTP goroutines   | `*redis.Client`                                                 | ✅ go-redis client is goroutine-safe                                                         |\n\n**AMQP Channel concurrency:** `amqp091-go` channels are **not** goroutine-safe for concurrent publishes. Since 3 workers share one publisher, the publisher must protect the channel with a mutex:\n\n```go\n// publisher.go\ntype amqpPublisher struct {\n    mu           sync.Mutex\n    ch           *amqp.Channel\n    exchangeName string\n    log          *slog.Logger\n}\nfunc (p *amqpPublisher) Publish(ctx context.Context, routingKey string, body []byte) error {\n    p.mu.Lock()\n    defer p.mu.Unlock()\n    // ... PublishWithContext call ...\n}\n```\n\nAlternatively, give each worker its own AMQP channel (3 channels from one connection). The mutex approach is simpler for this project. For higher throughput, switch to per-worker channels in a production system.\n**Context cancellation flow:**\n\n```\nmain.go: SIGTERM received\n  → appCancel()\n  → coordinator's ctx.Done() fires in select loop\n  → coordinator closes workerCh\n  → workers drain workerCh and exit (range loop terminates on close)\n  → wg.Wait() in coordinator returns\n  → coordinator returns\n  → main.go proceeds to srv.Shutdown()\n```\n\n**Timeout contexts for Redis:**\n\n- All Redis operations must use a `context.WithTimeout` with 50ms for GET and 100ms for SET/DEL.\n- Never use `r.Context()` directly for Redis — if the HTTP client disconnects, the context is cancelled and the cache operation is aborted, but the handler continues regardless.\n\n---\n\n## 8. Implementation Sequence with Checkpoints\n\n### Phase 1: DB Schema — `urls` + `outbox` Tables, Migrations, Indexes (1h)\n\n1. Write `migration.sql` as specified in §3.1.\n2. Extend `main.go` to call `runMigrations` (add `urlServiceSchema` const, `runMigrations` func as in §5.7).\n3. Extend `config.go` to add `JWTSecret`, `ShortURLBase`, `OutboxPollInterval`, `OutboxWorkerCount`.\n4. Run against Docker `url_db`:\n\n```bash\ndocker compose up url_db -d\nDATABASE_URL=\"postgres://urluser:urlpass@localhost:5432/urldb\" \\\nJWT_SECRET=\"testjwtsecret-minimum-32-chars-long\" \\\nSHORT_URL_BASE=\"http://localhost:8081\" \\\ngo run ./services/url-service/\n```\n\n1. Verify schema:\n\n```bash\npsql -h localhost -p 5432 -U urluser -d urldb \\\n  -c \"\\d urls; \\d outbox; \\di idx_urls_*; \\di idx_outbox_*;\"\n```\n\n**Checkpoint:** Tables `urls` and `outbox` exist with correct columns and types. All four indexes visible in `\\di` output. Service exits 0 after migration.\n\n### Phase 2: Base62 Encoder + `ShortCodeGenerator` with Collision Retry (1–1.5h)\n\n1. Write `base62.go`: `base62Alphabet` constant, `Encode(*big.Int) string`, `Decode(string) (*big.Int, error)`.\n2. Write `codegen.go`: `ShortCodeGenerator`, `Generate() string`.\n3. Write initial tests in `url_test.go` (§10.1):\n   - `TestBase62RoundTrip`\n   - `TestBase62Length`\n   - `TestBase62Alphabet`\n   - `TestShortCodeUniqueness`\n\n```bash\ngo test ./services/url-service/ -run TestBase62 -v\ngo test ./services/url-service/ -run TestShortCode -v\n```\n\n**Checkpoint:** All base62 and codegen tests pass. `Generate()` always returns exactly 7 characters from the base62 alphabet.\n\n### Phase 3: `POST /shorten` Handler + Atomic URL+Outbox Insert (2–2.5h)\n\n1. Write `errors.go`: sentinels, `writeError`, `writeJSON`, `isPgUniqueViolation`.\n2. Write `validate.go`: `validateURL`.\n3. Write `store.go`: `URLRecord`, `URLRepository` interface, `pgxURLStore` with `Insert` (unique violation detection).\n4. Write `outbox_store.go`: `OutboxRecord`, `OutboxRepository` interface, `pgxOutboxStore` with `InsertWithURL` and `InsertEvent`.\n5. Write `handler.go`: `Handler` struct, `NewHandler`, `Shorten` method (full algorithm from §5.2).\n6. Wire in `main.go`: construct all dependencies, register `POST /shorten` route with `JWTMiddleware`.\n7. Add `CorrelationIDMiddleware` and wrap the mux with it.\n\n```bash\n# Start infra\ndocker compose up url_db rabbitmq redis -d\n# Start service with env vars\nDATABASE_URL=... RABBITMQ_URL=... REDIS_URL=... JWT_SECRET=... \\\nSHORT_URL_BASE=\"http://localhost:8081\" \\\ngo run ./services/url-service/\n# Test (get a token from user-service first, or generate a test JWT)\ncurl -X POST http://localhost:8081/shorten \\\n  -H \"Authorization: Bearer $TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"url\":\"https://example.com/very/long/path\"}'\n```\n\n**Checkpoint:** `POST /shorten` returns `201` with `{short_code, short_url, original_url}`. PostgreSQL `urls` table has 1 row. `outbox` table has 1 row with `published_at = NULL`. Duplicate URL returns 201 with a different short code. Invalid URL returns 422.\n\n### Phase 4: Redis Cache Helpers + `GET /:code` Redirect (2–2.5h)\n\n1. Write `cache.go`: `CachedURL`, `RedisCache`, `Get/Set/Del` methods with full error isolation.\n2. Write `publisher.go`: `RabbitMQPublisher` interface, `amqpPublisher` with mutex.\n3. Add `Redirect` method to `handler.go` (full algorithm from §5.3).\n4. Register `GET /{code}` route in `main.go` (anonymous, no auth middleware).\n\n```bash\n# After POST /shorten returned {\"short_code\":\"abc1234\", ...}\ncurl -v http://localhost:8081/abc1234\n# Expect: HTTP/1.1 301 Moved Permanently\n#         Location: https://example.com/very/long/path\n# Second request (cache hit)\ncurl -v http://localhost:8081/abc1234\n# Expect: same 301, served from Redis in < 5ms\n# Redis verification\nredis-cli -p 6379 GET \"url:abc1234\"\n# Expect: {\"original_url\":\"https://example.com/very/long/path\",\"is_active\":true}\n```\n\n**Checkpoint:** First redirect: EXPLAIN ANALYZE on `SELECT ... WHERE short_code = $1` uses `idx_urls_short_code`. Second redirect: Redis `GET url:<code>` returns JSON (cache hit). `outbox` table gains 1 row with `event_type = \"url.clicked\"` and `published_at = NULL`. Non-existent code returns 404. Redis key for expired URL has TTL set correctly.\n\n### Phase 5: `GET /urls` + `DELETE /urls/:code` (1.5–2h)\n\n1. Add `FindByUserID` to `pgxURLStore` (cursor pagination with `limit+1` trick).\n2. Add `Deactivate` to `pgxURLStore`.\n3. Add `ListURLs` and `DeleteURL` methods to `Handler`.\n4. Register routes in `main.go`.\n\n```bash\n# List URLs\ncurl http://localhost:8081/urls \\\n  -H \"Authorization: Bearer $TOKEN\"\n# Expect: {\"urls\":[...],\"next_cursor\":null} (first page)\n# Pagination test (create 10+ URLs first)\ncurl \"http://localhost:8081/urls?after=<uuid_from_previous_response>\"\n# Delete\ncurl -X DELETE http://localhost:8081/urls/abc1234 \\\n  -H \"Authorization: Bearer $TOKEN\"\n# Expect: 204 No Content\n# Verify deactivated\ncurl http://localhost:8081/abc1234\n# Expect: 410 Gone\n# Verify Redis cleared\nredis-cli -p 6379 EXISTS \"url:abc1234\"\n# Expect: (integer) 0\n# Delete wrong owner\ncurl -X DELETE http://localhost:8081/urls/abc1234 \\\n  -H \"Authorization: Bearer $OTHER_USER_TOKEN\"\n# Expect: 403 Forbidden\n# Verify outbox has URLDeletedEvent\npsql -h localhost -p 5432 -U urluser -d urldb \\\n  -c \"SELECT event_type, payload FROM outbox WHERE event_type = 'url.deleted';\"\n```\n\n**Checkpoint:** `EXPLAIN ANALYZE` on `GET /urls` query shows `Index Scan using idx_urls_user_id_created`. Pagination cursor works correctly. DELETE sets `is_active=false` in DB. Outbox has `url.deleted` row. Redis key deleted. 403 returned for non-owner.\n\n### Phase 6: Outbox Coordinator + 3-Worker Pool + Graceful Shutdown (2–2.5h)\n\n1. Write `outbox.go`: `OutboxCoordinator`, `runWorker`, coordinator poll loop (algorithm from §5.5).\n2. Start coordinator in `main.go` before HTTP server.\n3. Wire `appCancel` to OS signal handler.\n4. Start `analytics-service` + `notification-service` (M1 skeletons) to receive messages.\n\n```bash\ndocker compose up --build -d\n# Shorten a URL\ncurl -X POST http://localhost:8081/shorten \\\n  -H \"Authorization: Bearer $TOKEN\" \\\n  -d '{\"url\":\"https://example.com\"}' \\\n  -H \"Content-Type: application/json\"\n# Wait 3s for outbox poll\nsleep 3\n# Verify published\npsql -h localhost -p 5432 -U urluser -d urldb \\\n  -c \"SELECT event_type, published_at FROM outbox ORDER BY created_at DESC LIMIT 5;\"\n# Expect: url.created row with published_at != NULL\n# Check RabbitMQ management UI\n# http://localhost:15672/#/queues → analytics.clicks and notifications.events\n# should show message counts incrementing\n```\n\n**Checkpoint:** Outbox rows transition from `published_at = NULL` to `published_at = <timestamp>` within 2-5 seconds of creation. RabbitMQ management UI shows messages delivered to queues. Coordinator logs `\"outbox coordinator stopped\"` on SIGTERM. All workers exit cleanly (no goroutine leak).\n\n### Phase 7: Tests + Benchmark (1–1.5h)\n\n1. Complete `url_test.go` with all test cases from §10.\n2. Write `bench_test.go` with the redirect benchmark.\n3. Run all tests:\n\n```bash\ngo test ./services/url-service/... -v -count=1\n```\n\n1. Run redirect benchmark:\n\n```bash\ngo test ./services/url-service/ -bench=BenchmarkRedirectCacheHit -benchtime=30s -benchmem\n```\n\n## **Checkpoint:** All unit tests pass. Redirect benchmark reports p99 < 5ms under 100 concurrent simulated requests (see §9 for wrk command)\n\n## 9. Test Specification\n\n### 9.1 Base62 Tests (`url_test.go`)\n\n```go\nfunc TestBase62RoundTrip(t *testing.T) {\n    cases := []int64{0, 1, 61, 62, 3521614606207} // 0, 1, last single-digit, first two-digit, max 7-char\n    for _, n := range cases {\n        t.Run(fmt.Sprintf(\"n=%d\", n), func(t *testing.T) {\n            encoded := Encode(big.NewInt(n))\n            decoded, err := Decode(encoded)\n            if err != nil {\n                t.Fatalf(\"Decode: %v\", err)\n            }\n            if decoded.Int64() != n {\n                t.Errorf(\"round trip: got %d want %d\", decoded.Int64(), n)\n            }\n        })\n    }\n}\nfunc TestBase62Length(t *testing.T) {\n    // All encoded values must be exactly 7 chars (left-padded)\n    for _, n := range []*big.Int{big.NewInt(0), big.NewInt(1), big.NewInt(61)} {\n        s := Encode(n)\n        if len(s) != 7 {\n            t.Errorf(\"Encode(%v) = %q len=%d, want 7\", n, s, len(s))\n        }\n    }\n}\nfunc TestBase62Alphabet(t *testing.T) {\n    if len(base62Alphabet) != 62 {\n        t.Errorf(\"alphabet length: got %d want 62\", len(base62Alphabet))\n    }\n    seen := make(map[byte]bool)\n    for i := 0; i < len(base62Alphabet); i++ {\n        c := base62Alphabet[i]\n        if seen[c] {\n            t.Errorf(\"duplicate character %q at index %d\", c, i)\n        }\n        seen[c] = true\n    }\n    // Must start with digits, then uppercase, then lowercase\n    if base62Alphabet[0] != '0' || base62Alphabet[9] != '9' {\n        t.Error(\"first 10 chars must be 0-9\")\n    }\n    if base62Alphabet[10] != 'A' || base62Alphabet[35] != 'Z' {\n        t.Error(\"chars 10-35 must be A-Z\")\n    }\n    if base62Alphabet[36] != 'a' || base62Alphabet[61] != 'z' {\n        t.Error(\"chars 36-61 must be a-z\")\n    }\n}\nfunc TestShortCodeLength(t *testing.T) {\n    g := NewShortCodeGenerator()\n    for i := 0; i < 1000; i++ {\n        code := g.Generate()\n        if len(code) != 7 {\n            t.Fatalf(\"generated code %q has length %d, want 7\", code, len(code))\n        }\n    }\n}\nfunc TestShortCodeAlphabet(t *testing.T) {\n    g := NewShortCodeGenerator()\n    valid := make(map[byte]bool)\n    for i := 0; i < len(base62Alphabet); i++ {\n        valid[base62Alphabet[i]] = true\n    }\n    for i := 0; i < 100; i++ {\n        code := g.Generate()\n        for _, c := range []byte(code) {\n            if !valid[c] {\n                t.Fatalf(\"invalid char %q in code %q\", c, code)\n            }\n        }\n    }\n}\nfunc TestShortCodeUniqueness(t *testing.T) {\n    g := NewShortCodeGenerator()\n    seen := make(map[string]bool)\n    // Generate 10,000 codes; collision probability at 10k ≈ 1.4% — acceptable for test\n    // (we're testing the generator produces varied output, not that it's collision-free)\n    for i := 0; i < 10_000; i++ {\n        code := g.Generate()\n        seen[code] = true\n    }\n    // Expect at least 9990 unique codes out of 10,000\n    if len(seen) < 9990 {\n        t.Errorf(\"too many collisions: got %d unique codes from 10,000 generates\", len(seen))\n    }\n}\n```\n\n### 9.2 `validateURL` Tests\n\n```go\nfunc TestValidateURL(t *testing.T) {\n    cases := []struct {\n        input   string\n        wantErr bool\n    }{\n        {\"https://example.com\", false},\n        {\"http://example.com/path?q=1\", false},\n        {\"https://sub.domain.org/a/b/c\", false},\n        {\"\", true},                            // empty\n        {\"not-a-url\", true},                   // no scheme\n        {\"ftp://example.com\", true},           // non-http scheme\n        {\"http://\", true},                     // scheme but no host\n        {\"//example.com\", true},               // no scheme\n        {\"javascript:alert(1)\", true},         // non-http scheme\n    }\n    for _, tc := range cases {\n        t.Run(tc.input, func(t *testing.T) {\n            err := validateURL(tc.input)\n            if (err != nil) != tc.wantErr {\n                t.Errorf(\"validateURL(%q) err=%v wantErr=%v\", tc.input, err, tc.wantErr)\n            }\n        })\n    }\n}\n```\n\n### 9.3 Handler Unit Tests (with mock stores)\n\n```go\n// Mock implementations\ntype mockURLStore struct {\n    insertFn       func(ctx context.Context, rec *URLRecord) (*URLRecord, error)\n    findByCodeFn   func(ctx context.Context, code string) (*URLRecord, error)\n    findByUserIDFn func(ctx context.Context, userID, afterID string, limit int) ([]*URLRecord, string, error)\n    deactivateFn   func(ctx context.Context, code, userID string) error\n}\n// (implement URLRepository interface — each method delegates to respective Fn)\ntype mockOutboxStore struct {\n    insertWithURLFn func(ctx context.Context, tx pgx.Tx, u *URLRecord, o *OutboxRecord) error\n    insertEventFn   func(ctx context.Context, tx pgx.Tx, o *OutboxRecord) error\n    fetchFn         func(ctx context.Context, limit int) ([]*OutboxRecord, error)\n    markFn          func(ctx context.Context, id string) error\n}\nfunc TestShortenHandler_Success(t *testing.T) {\n    // Verify: 201 response, short_code 7 chars, short_url has base prefix\n}\nfunc TestShortenHandler_InvalidURL(t *testing.T) {\n    // Input: {\"url\": \"not-a-url\"}\n    // Expect: 422 with field=\"url\"\n}\nfunc TestShortenHandler_ExpiredExpiresAt(t *testing.T) {\n    // Input: expires_at = one hour ago\n    // Expect: 422\n}\nfunc TestShortenHandler_CustomCodeConflict(t *testing.T) {\n    // mockOutboxStore.insertWithURLFn returns ErrShortCodeConflict\n    // req.custom_code = \"mycode\"\n    // Expect: 409, no retry\n}\nfunc TestShortenHandler_AutoCodeCollisionExhausted(t *testing.T) {\n    // insertWithURLFn always returns ErrShortCodeConflict\n    // req has no custom_code\n    // Expect: 503 after 5 attempts (verify mock called exactly 5 times)\n}\nfunc TestRedirectHandler_CacheHit_Active(t *testing.T) {\n    // mockCache.Get returns &CachedURL{OriginalURL:\"https://x.com\", IsActive:true}\n    // Expect: 301 Location: https://x.com; no DB call (mockURLStore.findByCode not called)\n}\nfunc TestRedirectHandler_CacheHit_Inactive(t *testing.T) {\n    // cached.IsActive = false\n    // Expect: 410\n}\nfunc TestRedirectHandler_CacheMiss_Active(t *testing.T) {\n    // cache returns miss; store returns active URLRecord\n    // Expect: 301; cache.Set called\n}\nfunc TestRedirectHandler_CacheMiss_NotFound(t *testing.T) {\n    // cache miss; store returns ErrURLNotFound\n    // Expect: 404\n}\nfunc TestRedirectHandler_CacheMiss_Expired(t *testing.T) {\n    // cache miss; store returns URLRecord with ExpiresAt = 1 hour ago\n    // Expect: 410; cache.Set NOT called\n}\nfunc TestDeleteHandler_Success(t *testing.T) {\n    // store returns owned URLRecord; deactivate succeeds; outbox insert succeeds\n    // Expect: 204; cache.Del called\n}\nfunc TestDeleteHandler_NotFound(t *testing.T) {\n    // deactivate returns ErrURLNotFound\n    // Expect: 404\n}\nfunc TestDeleteHandler_WrongOwner(t *testing.T) {\n    // urlRec.UserID != claims.Sub\n    // Expect: 403\n}\nfunc TestListURLsHandler_EmptyPage(t *testing.T) {\n    // store.FindByUserID returns empty slice, \"\"\n    // Expect: 200 {\"urls\":[],\"next_cursor\":null}\n}\nfunc TestListURLsHandler_WithNextCursor(t *testing.T) {\n    // store returns 20 items and nextCursor = \"some-uuid\"\n    // Expect: 200 {\"urls\":[...],\"next_cursor\":\"some-uuid\"}\n}\n```\n\n### 9.4 `RedisCache` Unit Tests\n\n```go\nfunc TestRedisCache_GetMiss(t *testing.T) {\n    // Use miniredis (github.com/alicebob/miniredis/v2) for in-process Redis\n    mr := miniredis.RunT(t)\n    client := redis.NewClient(&redis.Options{Addr: mr.Addr()})\n    cache := NewRedisCache(client, slog.Default())\n    result, hit := cache.Get(context.Background(), \"nonexistent\")\n    if hit || result != nil {\n        t.Error(\"expected cache miss\")\n    }\n}\nfunc TestRedisCache_SetThenGet(t *testing.T) {\n    mr := miniredis.RunT(t)\n    client := redis.NewClient(&redis.Options{Addr: mr.Addr()})\n    cache := NewRedisCache(client, slog.Default())\n    cu := &CachedURL{OriginalURL: \"https://example.com\", IsActive: true}\n    cache.Set(context.Background(), \"abc1234\", cu, nil)\n    result, hit := cache.Get(context.Background(), \"abc1234\")\n    if !hit {\n        t.Fatal(\"expected cache hit\")\n    }\n    if result.OriginalURL != \"https://example.com\" {\n        t.Errorf(\"url: got %q\", result.OriginalURL)\n    }\n}\nfunc TestRedisCache_Del(t *testing.T) {\n    mr := miniredis.RunT(t)\n    client := redis.NewClient(&redis.Options{Addr: mr.Addr()})\n    cache := NewRedisCache(client, slog.Default())\n    cu := &CachedURL{OriginalURL: \"https://example.com\", IsActive: true}\n    cache.Set(context.Background(), \"abc1234\", cu, nil)\n    cache.Del(context.Background(), \"abc1234\")\n    _, hit := cache.Get(context.Background(), \"abc1234\")\n    if hit {\n        t.Error(\"expected cache miss after Del\")\n    }\n}\nfunc TestRedisCache_TTL_WithExpiry(t *testing.T) {\n    mr := miniredis.RunT(t)\n    client := redis.NewClient(&redis.Options{Addr: mr.Addr()})\n    cache := NewRedisCache(client, slog.Default())\n    // ExpiresAt 30 minutes from now → TTL should be ≈ 30min (< 1h)\n    expiresAt := time.Now().Add(30 * time.Minute)\n    cache.Set(context.Background(), \"code1\", &CachedURL{OriginalURL: \"x\", IsActive: true}, &expiresAt)\n    // miniredis doesn't check exact TTL but we can verify key exists\n    _, hit := cache.Get(context.Background(), \"code1\")\n    if !hit {\n        t.Error(\"expected hit for unexpired key\")\n    }\n    // Fast-forward 31 minutes in miniredis\n    mr.FastForward(31 * time.Minute)\n    _, hit = cache.Get(context.Background(), \"code1\")\n    if hit {\n        t.Error(\"expected cache miss after TTL expiry\")\n    }\n}\nfunc TestRedisCache_ErrorIsolation(t *testing.T) {\n    // Closed Redis client — verify Get returns (nil, false), not panics\n    client := redis.NewClient(&redis.Options{Addr: \"localhost:1\"}) // nothing listening\n    cache := NewRedisCache(client, slog.Default())\n    result, hit := cache.Get(context.Background(), \"code\")\n    if hit || result != nil {\n        t.Error(\"expected miss for unreachable Redis\")\n    }\n    // Del should not panic\n    cache.Del(context.Background(), \"code\")\n}\n```\n\n### 9.5 Outbox Worker Test\n\n```go\nfunc TestOutboxWorker_PublishAndMark(t *testing.T) {\n    published := make([]string, 0)\n    marked := make([]string, 0)\n    var mu sync.Mutex\n    publisher := &mockPublisher{\n        publishFn: func(ctx context.Context, routingKey string, body []byte) error {\n            mu.Lock(); published = append(published, routingKey); mu.Unlock()\n            return nil\n        },\n    }\n    store := &mockOutboxStore{\n        markFn: func(ctx context.Context, id string) error {\n            mu.Lock(); marked = append(marked, id); mu.Unlock()\n            return nil\n        },\n    }\n    ch := make(chan *OutboxRecord, 1)\n    ch <- &OutboxRecord{ID: \"outbox-1\", EventType: \"url.created\", Payload: []byte(`{}`)}\n    close(ch)\n    var wg sync.WaitGroup\n    wg.Add(1)\n    go func() {\n        defer wg.Done()\n        // Simulate a single worker run\n        ctx := context.Background()\n        for row := range ch {\n            publisher.Publish(ctx, row.EventType, row.Payload)\n            store.MarkPublished(ctx, row.ID)\n        }\n    }()\n    wg.Wait()\n    if len(published) != 1 || published[0] != \"url.created\" {\n        t.Errorf(\"published: %v\", published)\n    }\n    if len(marked) != 1 || marked[0] != \"outbox-1\" {\n        t.Errorf(\"marked: %v\", marked)\n    }\n}\nfunc TestOutboxWorker_PublishFail_NoMark(t *testing.T) {\n    // If publish fails, MarkPublished must NOT be called (row stays unpublished for retry)\n    markCalled := false\n    publisher := &mockPublisher{publishFn: func(_ context.Context, _ string, _ []byte) error {\n        return errors.New(\"amqp error\")\n    }}\n    store := &mockOutboxStore{markFn: func(_ context.Context, _ string) error {\n        markCalled = true; return nil\n    }}\n    // ... run worker with one row, publish fails ...\n    if markCalled {\n        t.Error(\"MarkPublished must not be called when Publish fails\")\n    }\n}\n```\n\n### 9.6 Benchmark (`bench_test.go`)\n\n```go\n// +build integration\n// Run: DATABASE_URL=... REDIS_URL=... go test -bench=BenchmarkRedirectCacheHit -benchtime=30s\nfunc BenchmarkRedirectCacheHit(b *testing.B) {\n    // Setup: insert a URL record and warm the Redis cache\n    // ...\n    b.ResetTimer()\n    b.SetParallelism(100)\n    b.RunParallel(func(pb *testing.PB) {\n        for pb.Next() {\n            req := httptest.NewRequest(\"GET\", \"/\"+shortCode, nil)\n            rec := httptest.NewRecorder()\n            handler.Redirect(rec, req)\n            if rec.Code != 301 {\n                b.Errorf(\"expected 301, got %d\", rec.Code)\n            }\n        }\n    })\n}\n```\n\n**wrk-based end-to-end benchmark:**\n\n```bash\n# Warm the cache first:\ncurl http://localhost:8081/<code> > /dev/null\n# Then benchmark:\nwrk -t4 -c100 -d30s http://localhost:8081/<code>\n# Target: Latency 99% < 5ms in \"Latency Distribution\" output\n```\n\n![POST /shorten Atomic Transaction: URL Insert + Outbox Insert](./diagrams/tdd-diag-15.svg)\n\n```\nRequest lifecycle for GET /:code (cache hit path):\n  Client ──► url-service handler\n                │\n                ▼\n         CorrelationIDMiddleware (read/generate X-Correlation-ID)\n                │\n                ▼\n         RedisCache.Get(\"url:<code>\") ──► Redis (50ms timeout ctx)\n                │                             │\n           cache hit                     cache miss or error\n                │                             │\n                ▼                             ▼\n         Check IsActive, ExpiresAt    pgxURLStore.FindByCode()\n                │                             │\n           expired/inactive              active URL\n                │                             │\n                ▼                             ▼\n              410                    RedisCache.Set() (100ms timeout ctx)\n                                              │\n                                              ▼\n                                    Insert URLClickedEvent to outbox\n                                    (separate tx, non-fatal)\n                                              │\n                                              ▼\n                                     301 Location: <original_url>\n```\n\n![GET /:code Read-Through Cache State Machine](./diagrams/tdd-diag-16.svg)\n\n```\nTransaction boundaries:\n  POST /shorten:\n  ┌─────────────────────────────────┐\n  │ BEGIN                           │\n  │   INSERT INTO urls (...)        │  ← URLRecord populated from RETURNING\n  │   INSERT INTO outbox (...)      │  ← URLCreatedEvent payload\n  │ COMMIT  ──► or ROLLBACK         │\n  └─────────────────────────────────┘\n  (one transaction, two tables, same url_db)\n  GET /:code (click event):\n  ┌─────────────────────────────────┐\n  │ BEGIN                           │\n  │   INSERT INTO outbox (...)      │  ← URLClickedEvent\n  │ COMMIT                          │\n  └─────────────────────────────────┘\n  (separate transaction; redirect response sent regardless of outcome)\n  DELETE /urls/:code:\n  ┌─────────────────────────────────┐\n  │ BEGIN                           │\n  │   SELECT ... FROM urls          │  ← read for ownership check\n  │   UPDATE urls SET is_active=false│\n  │   INSERT INTO outbox (...)      │  ← URLDeletedEvent\n  │ COMMIT                          │\n  └─────────────────────────────────┘\n  Post-commit: Redis DEL (best-effort, outside tx)\n```\n\n![Redis Cache Entry Format and TTL Calculation](./diagrams/tdd-diag-17.svg)\n\n```\nCursor-based pagination for GET /urls:\n  First page (afterID = \"\"):\n    SELECT ... FROM urls\n    WHERE user_id = $1\n    ORDER BY created_at DESC, id DESC\n    LIMIT 21   ← limit+1 to detect next page\n    If 21 rows returned: nextCursor = rows[20].ID, return rows[:20]\n    If ≤20 rows:          nextCursor = \"\",           return all rows\n  Second page (afterID = \"<uuid>\"):\n    SELECT ... FROM urls\n    WHERE user_id = $1\n      AND (created_at, id) < (SELECT created_at, id FROM urls WHERE id = $2)\n    ORDER BY created_at DESC, id DESC\n    LIMIT 21\n  Index used: idx_urls_user_id_created ON urls(user_id, created_at DESC)\n  PostgreSQL can use this index for the WHERE user_id = $1 + ORDER BY created_at DESC.\n  The subquery for cursor resolution performs a single PK lookup.\n```\n\n![Outbox Worker Pool Architecture and Data Flow](./diagrams/tdd-diag-18.svg)\n\n```\nOutbox coordinator poll cycle:\n  t=0s:  FetchUnpublished(limit=50)\n         rows = [r1, r2, r3] (3 unpublished events)\n         workerCh <- r1  ──► Worker-1 picks up r1\n         workerCh <- r2  ──► Worker-2 picks up r2\n         workerCh <- r3  ──► Worker-3 picks up r3\n  t=0.1s: Workers publish to RabbitMQ concurrently\n           Worker-1: Publish(\"url.created\", r1.Payload) → OK → MarkPublished(r1.ID)\n           Worker-2: Publish(\"url.clicked\", r2.Payload) → OK → MarkPublished(r2.ID)\n           Worker-3: Publish(\"url.deleted\", r3.Payload) → FAIL → log + skip mark\n  t=2s:  FetchUnpublished(limit=50)\n         rows = [r3] (r3 still has published_at = NULL)\n         workerCh <- r3  ──► Worker-1 picks up r3 (retry)\n         Worker-1: Publish(\"url.deleted\", r3.Payload) → OK → MarkPublished(r3.ID)\n```\n\n![Outbox Worker Pool Sequence: Coordinator to Workers](./diagrams/tdd-diag-19.svg)\n\n```\nShort code generation probability analysis:\n  Base62 space: 62^7 = 3,521,614,606,208 ≈ 3.5 trillion codes\n  After N URLs inserted, collision probability on single attempt:\n    P(collision) ≈ N / 62^7\n  At N = 1,000,000 (1M URLs):\n    P(single collision) ≈ 2.84 × 10^-7 per attempt\n    P(all 5 attempts collide) ≈ (2.84e-7)^5 ≈ 4.5 × 10^-33\n  At N = 1,000,000,000 (1B URLs, 28.4% of space):\n    P(single collision) ≈ 0.284\n    P(all 5 attempts collide) ≈ 0.284^5 ≈ 0.18% → 503 error rate 0.18%\n    (At this scale, a longer code or different strategy is warranted)\n  For the scope of this project (< 1M URLs): 5 retries is more than sufficient.\n```\n\n---\n\n## 10. Performance Targets\n\n| Operation                                 | Target                                  | How to Measure                                                                         |\n| ----------------------------------------- | --------------------------------------- | -------------------------------------------------------------------------------------- |\n| `GET /:code` cache hit                    | < 5ms p99 under 100 concurrent requests | `wrk -t4 -c100 -d30s http://localhost:8081/<warm-code>` → Latency 99th < 5ms           |\n| `GET /:code` cache miss                   | < 20ms p99                              | Flush Redis key, then `wrk -t4 -c10 -d10s` (low concurrency to force misses)           |\n| `POST /shorten` (single tx: URL + outbox) | < 50ms p99                              | `wrk -t2 -c10 -d30s -s shorten.lua http://localhost:8081/shorten`                      |\n| `GET /urls` page 1 (cold, 20 results)     | < 10ms p99                              | `EXPLAIN ANALYZE SELECT ... LIMIT 21` must show Index Scan on idx_urls_user_id_created |\n| Outbox poll-to-publish latency            | < 5s                                    | Create URL → poll RabbitMQ management API until queue depth increases; time delta      |\n| `DELETE /urls/:code` (tx + cache del)     | < 20ms p99                              | Curl timing: `time curl -X DELETE ...`                                                 |\n| Short code generation (single)            | < 1ms                                   | `go test -bench=BenchmarkGenerate -benchtime=10s` → ns/op < 1,000,000                  |\n| Outbox coordinator memory                 | < 50MB steady-state                     | `docker stats url-service-1` after 10 minutes of load                                  |\n\n**EXPLAIN ANALYZE verification:**\n\n```bash\npsql -h localhost -p 5432 -U urluser -d urldb -c \"\nEXPLAIN ANALYZE\nSELECT id, short_code, original_url, user_id, created_at, expires_at, is_active\nFROM urls\nWHERE user_id = 'some-uuid'\nORDER BY created_at DESC, id DESC\nLIMIT 21;\n\"\n# Must show: Index Scan using idx_urls_user_id_created on urls\n# Must NOT show: Seq Scan\n```\n\n**Short code generation benchmark:**\n\n```go\nfunc BenchmarkShortCodeGenerate(b *testing.B) {\n    g := NewShortCodeGenerator()\n    b.ResetTimer()\n    for i := 0; i < b.N; i++ {\n        g.Generate()\n    }\n}\n// Expected: ~1-5 µs/op (crypto/rand + big.Int arithmetic)\n```\n\n![Cursor-Based Pagination Query Plan](./diagrams/tdd-diag-20.svg)\n\n```\nPerformance budget for GET /:code cache hit path:\n  ┌─────────────────────────────────────────────────────────┐\n  │ Network recv + HTTP parse:          ~0.1ms              │\n  │ CorrelationIDMiddleware:            <0.1ms              │\n  │ RedisCache.Get (50ms ctx):          ~0.5ms (LAN Redis)  │ ← dominates\n  │ JSON unmarshal CachedURL:           <0.1ms              │\n  │ is_active + expiry check:           <0.01ms             │\n  │ http.Redirect (write headers):      ~0.1ms              │\n  │ Network send:                       ~0.1ms              │\n  │ TOTAL:                              ~1ms typical        │\n  │                                     <5ms p99 ✓          │\n  └─────────────────────────────────────────────────────────┘\nPerformance budget for GET /:code cache miss path:\n  ┌─────────────────────────────────────────────────────────┐\n  │ RedisCache.Get (miss):              ~0.5ms              │\n  │ pgxpool.Acquire:                    ~0.1ms (warm pool)  │\n  │ pgx QueryRow (idx_urls_short_code): ~1-3ms (LAN PG)    │ ← dominates\n  │ RedisCache.Set:                     ~0.5ms (async-ish)  │\n  │ Begin outbox tx + Insert + Commit:  ~2-5ms              │\n  │ http.Redirect:                      ~0.1ms              │\n  │ TOTAL:                              ~5-10ms typical     │\n  │                                     <20ms p99 ✓         │\n  └─────────────────────────────────────────────────────────┘\n```\n\n![DELETE /urls/:code Sequence with Ownership Check and Cache Invalidation](./diagrams/tdd-diag-21.svg)\n\n```\ngo.mod additions for url-service (M3):\n  (from M1): github.com/jackc/pgx/v5 v5.6.0\n             github.com/redis/go-redis/v9 v9.6.0\n             github.com/rabbitmq/amqp091-go v1.10.0\n  (from M2): github.com/yourhandle/url-shortener/shared/auth\n             github.com/golang-jwt/jwt/v5 v5.2.1\n  (new M3):  math/big — stdlib, no dependency\n             crypto/rand — stdlib, no dependency\n             github.com/alicebob/miniredis/v2 v2.32.0  (test only)\n  All require in go.mod:\n    require (\n        github.com/yourhandle/url-shortener/shared/auth v0.0.0\n        github.com/yourhandle/url-shortener/shared/events v0.0.0\n        github.com/yourhandle/url-shortener/shared/logger v0.0.0\n        github.com/jackc/pgx/v5 v5.6.0\n        github.com/redis/go-redis/v9 v9.6.0\n        github.com/rabbitmq/amqp091-go v1.10.0\n        github.com/golang-jwt/jwt/v5 v5.2.1\n        github.com/alicebob/miniredis/v2 v2.32.0\n    )\n  docker-compose.yml additions for url-service environment:\n    JWT_SECRET: \"change-this-in-production-minimum-32-chars\"\n    SHORT_URL_BASE: \"http://localhost:8080\"   ← or gateway URL in M5\n    IP_HASH_SALT: \"change-this-random-salt\"\n```\n\n---\n\n## 11. Anti-Pattern Guard\n\nThe following checks must pass before this module is considered complete:\n\n```bash\n# 1. No shared DB: url-service must ONLY connect to url_db\ngrep -r \"analytics_db\\|user_db\\|notification_db\" services/url-service/ || echo \"PASS\"\n# 2. No synchronous analytics call\ngrep -r \"analytics-service\\|analytics_service\\|8082\" services/url-service/ || echo \"PASS\"\n# 3. crypto/rand only (no math/rand in production code)\ngrep -r \"math/rand\" services/url-service/*.go | grep -v \"_test.go\" || echo \"PASS\"\n# 4. No unbounded Redis TTL\n# Verify Set always calls with non-zero TTL:\ngrep -A5 \"client.Set\" services/url-service/cache.go\n# Must show TTL parameter is never 0 or redis.KeepTTL except the 1s guard case\n# 5. Outbox and URL write in same transaction (POST /shorten)\n# Review handler.go: BEGIN → InsertWithURL (urls + outbox) → COMMIT\n# Both tables must appear inside the same pool.Begin() ... tx.Commit() scope\n```\n\n---\n\n<!-- END_TDD_MOD -->\n\n<!-- TDD_MOD_ID: url-shortener-m4 -->\n\n# Analytics Service: Click Ingestion + Stats API\n\n## **Module ID:** `url-shortener-m4`\n\n## 1. Module Charter\n\nThis module implements the Analytics Service as a self-contained read-model consumer. It owns the `clicks`, `milestones`, and `processed_events` tables in its dedicated PostgreSQL instance (`analytics_db`), subscribes to the `analytics.clicks` queue on RabbitMQ, processes `URLClickedEvent` messages with at-least-once semantics, deduplicates by `event_id`, inserts anonymized click records, checks milestone thresholds (10, 100, 1000 clicks per short code), publishes `MilestoneReachedEvent` back to RabbitMQ when thresholds are crossed, and exposes two public (unauthenticated) HTTP endpoints for click statistics.\nThis module does **not** call the URL Service to validate `short_code` — it trusts the event. It does **not** store user PII — IP addresses are stored as SHA-256 hashes, never raw. It does **not** issue or verify JWTs — both `/stats` endpoints are public. It does **not** write to any database other than `analytics_db`. It does **not** implement the outbox pattern for `MilestoneReachedEvent` — publish failure is logged and the milestone row remains committed; the event may be re-triggered if the next click re-checks the threshold (thresholds are idempotent via `milestones` table). It does **not** implement a worker pool — a single sequential consumer goroutine with AMQP `prefetch=1` provides serialized processing without race conditions.\n**Upstream dependencies:** `shared/events` (event struct definitions), `shared/logger` (structured JSON logger), `NewRabbitMQConn` and `DeclareAnalyticsQueue` (from M1 `analytics-service/rabbitmq.go`), `analytics_db` PostgreSQL instance, `NewDBPool` (from M1).\n**Downstream consumers:** `notification-service` consumes `MilestoneReachedEvent` from `notifications.events` queue (bound to routing key `milestone.reached`). The analytics service publishes this event directly on the AMQP channel — not via the outbox — because the analytics DB is the authoritative source and the milestone row is already committed before publish is attempted.\n**Invariants that must always hold:**\n\n- A `URLClickedEvent` with a previously seen `event_id` is **silently acknowledged and discarded** — click count never increments more than once per event.\n- Click insert, processed_event insert, and milestone insert (when triggered) all occur in **one database transaction** — no partial state.\n- A malformed/unparseable AMQP message body is **acknowledged** (not nacked) to prevent infinite requeue loops; it is logged as a poison message.\n- The `/health` endpoint returns `200 {\"status\":\"ok\"}` even when the RabbitMQ consumer is temporarily paused due to connection drop.\n- `MilestoneReachedEvent` publish failure never causes the consumer to crash or nack the originating click message — the milestone row is already durable.\n- `ip_hash` is always `SHA-256(raw_ip + salt)` — the raw IP never enters the database.\n\n---\n\n## 2. File Structure\n\nCreate files in the numbered order below. Shared packages exist from M1/M2/M3; only analytics-service files are new here.\n\n```\nurl-shortener/\n│\n├── shared/                                 ← unchanged from prior milestones\n│   ├── events/events.go\n│   ├── auth/auth.go + middleware.go\n│   └── logger/logger.go\n│\n└── services/\n    └── analytics-service/\n        ├── (from M1, extended)\n        │   ├── go.mod                      ← add dependencies (see §6.3 / §10)\n        │   ├── main.go                     ← extend: wire consumer, start goroutine\n        │   ├── config.go                   ← extend: add IPHashSalt, MilestoneThresholds\n        │   ├── db.go                       ← unchanged from M1 (NewDBPool reused)\n        │   ├── rabbitmq.go                 ← extend: add DeclareAnalyticsQueue (already in M1)\n        │   └── health.go                   ← unchanged from M1\n        │\n        ├── 1.  migration.sql               ← clicks, milestones, processed_events + indexes\n        ├── 2.  store.go                    ← ClickRepository, MilestoneRepository, DeduplicationRepository interfaces + pgx implementations\n        ├── 3.  consumer.go                 ← ClickConsumer struct, Run(), message loop, panic recovery\n        ├── 4.  milestone.go                ← MilestoneChecker, CheckAndPublish, threshold constants\n        ├── 5.  publisher.go                ← AnalyticsPublisher interface + amqpAnalyticsPublisher (mirrors url-service/publisher.go pattern)\n        ├── 6.  handler.go                  ← StatsHandler, TimelineHandler, route registration helper\n        ├── 7.  errors.go                   ← writeError, writeJSON helpers, sentinel errors\n        ├── 8.  haship.go                   ← hashIP(remoteAddr, salt) string\n        └── 9.  analytics_test.go           ← unit + integration tests\n```\n\n---\n\n## 3. Complete Data Model\n\n### 3.1 PostgreSQL Schema (`migration.sql`)\n\n```sql\n-- ── clicks table ──────────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS clicks (\n    id          UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n    short_code  TEXT        NOT NULL,\n    clicked_at  TIMESTAMPTZ NOT NULL,\n    ip_hash     TEXT        NOT NULL,    -- SHA-256(raw_ip + salt); never raw IP\n    user_agent  TEXT        NOT NULL DEFAULT '',\n    referer     TEXT        NULL        -- NULL when no Referer header was present\n);\n-- Primary query path: aggregate clicks per code in time windows.\n-- date_trunc bucketing and COUNT(*) both benefit from this index.\nCREATE INDEX IF NOT EXISTS idx_clicks_short_code_time\n    ON clicks(short_code, clicked_at DESC);\n-- Top-referers query: partial index omits rows with no referer (saves space).\nCREATE INDEX IF NOT EXISTS idx_clicks_referer\n    ON clicks(short_code, referer)\n    WHERE referer IS NOT NULL;\n-- ── milestones table ──────────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS milestones (\n    id            UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n    short_code    TEXT        NOT NULL,\n    milestone     INT         NOT NULL,   -- 10 | 100 | 1000\n    triggered_at  TIMESTAMPTZ NOT NULL DEFAULT now(),\n    UNIQUE (short_code, milestone)        -- exactly one row per (code, threshold)\n);\n-- Lookup: has this code already crossed a given milestone?\nCREATE UNIQUE INDEX IF NOT EXISTS idx_milestones_code_milestone\n    ON milestones(short_code, milestone);\n-- ── processed_events table (deduplication) ────────────────────────────────────\nCREATE TABLE IF NOT EXISTS processed_events (\n    event_id    TEXT        PRIMARY KEY,  -- events.BaseEvent.EventID (UUID v4 string)\n    processed_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n-- No additional index needed — PRIMARY KEY gives the O(log n) lookup we need.\n-- Retention: rows here grow indefinitely for this project. A production system\n-- would partition by processed_at and drop old partitions after TTL.\n```\n\n**Column rationale:**\n\n| Column | Type | Constraint | Rationale |\n|---|---|---|---|\n| `clicks.id` | UUID | PK | Unique row identity; not exposed in API |\n| `clicks.short_code` | TEXT | NOT NULL | Denormalized from event; analytics DB has no FK to url_db (no cross-DB joins) |\n| `clicks.clicked_at` | TIMESTAMPTZ | NOT NULL | From `URLClickedEvent.ClickedAt`; used for time-window aggregation and `date_trunc` |\n| `clicks.ip_hash` | TEXT | NOT NULL | SHA-256(IP+salt) — 64-char hex string; GDPR-safe; salted to prevent rainbow table lookup |\n| `clicks.user_agent` | TEXT | NOT NULL DEFAULT '' | From event; empty string when absent (not NULL — avoids NULL handling complexity in aggregations) |\n| `clicks.referer` | TEXT | NULL | NULL when absent; partial index on non-NULL rows for top-referers query |\n| `milestones.short_code` | TEXT | NOT NULL | Denormalized; no FK |\n| `milestones.milestone` | INT | NOT NULL | Must be one of {10, 100, 1000}; enforced in application layer, not DB constraint |\n| `milestones.UNIQUE(short_code, milestone)` | — | — | Prevents double-recording the same milestone; INSERT ... ON CONFLICT DO NOTHING is idempotent |\n| `processed_events.event_id` | TEXT | PK | EventID from BaseEvent; TEXT not UUID to avoid parsing overhead on lookup; PRIMARY KEY gives unique constraint |\n| `processed_events.processed_at` | TIMESTAMPTZ | NOT NULL DEFAULT now() | Audit trail; useful for future TTL-based cleanup |\n\n### 3.2 Go Structs\n\n```go\n// store.go\npackage analytics\nimport \"time\"\n// ClickRecord maps to one row in the clicks table.\n// Populated from URLClickedEvent fields.\ntype ClickRecord struct {\n    ID        string    // UUID, generated by DB (gen_random_uuid())\n    ShortCode string\n    ClickedAt time.Time\n    IPHash    string    // SHA-256(raw_ip + salt); 64-char hex\n    UserAgent string\n    Referer   string    // empty string when absent (not nil pointer)\n}\n// MilestoneRecord maps to one row in the milestones table.\ntype MilestoneRecord struct {\n    ID          string\n    ShortCode   string\n    Milestone   int       // 10 | 100 | 1000\n    TriggeredAt time.Time\n}\n// StatsResult is the aggregated response for GET /stats/:code.\n// Built from multiple DB queries in the handler.\ntype StatsResult struct {\n    ShortCode      string\n    TotalClicks    int64\n    ClicksLast24h  int64\n    ClicksLast7d   int64\n    TopReferers    []RefererCount\n}\n// RefererCount holds one entry in the top-referers list.\ntype RefererCount struct {\n    Referer string `json:\"referer\"`\n    Count   int64  `json:\"count\"`\n}\n// TimelinePoint holds one bucket in the timeline response.\ntype TimelinePoint struct {\n    Period string `json:\"period\"` // RFC3339 of the bucket start\n    Clicks int64  `json:\"clicks\"`\n}\n```\n\n```go\n// config.go (extended from M1)\npackage analytics\nimport (\n    \"fmt\"\n    \"os\"\n    \"time\"\n)\ntype Config struct {\n    DatabaseURL        string\n    RabbitMQURL        string\n    Port               string\n    ServiceName        string\n    IPHashSalt         string        // read from IP_HASH_SALT env var; empty string is acceptable\n    AMQPPrefetchCount  int           // always 1 for this service (not configurable — fixed per spec)\n    OutboxPollInterval time.Duration // unused in analytics; kept for config struct symmetry\n}\nfunc loadConfig() (*Config, error) {\n    cfg := &Config{\n        DatabaseURL:       os.Getenv(\"DATABASE_URL\"),\n        RabbitMQURL:       os.Getenv(\"RABBITMQ_URL\"),\n        Port:              envOrDefault(\"PORT\", \"8080\"),\n        ServiceName:       \"analytics-service\",\n        IPHashSalt:        os.Getenv(\"IP_HASH_SALT\"),\n        AMQPPrefetchCount: 1,\n    }\n    if cfg.DatabaseURL == \"\" {\n        return nil, fmt.Errorf(\"DATABASE_URL is required\")\n    }\n    if cfg.RabbitMQURL == \"\" {\n        return nil, fmt.Errorf(\"RABBITMQ_URL is required\")\n    }\n    return cfg, nil\n}\nfunc envOrDefault(key, def string) string {\n    if v := os.Getenv(key); v != \"\" {\n        return v\n    }\n    return def\n}\n```\n\n```go\n// handler.go — HTTP request/response types\npackage analytics\n// statsResponse is the JSON shape for GET /stats/:code.\ntype statsResponse struct {\n    ShortCode     string         `json:\"short_code\"`\n    TotalClicks   int64          `json:\"total_clicks\"`\n    ClicksLast24h int64          `json:\"clicks_last_24h\"`\n    ClicksLast7d  int64          `json:\"clicks_last_7d\"`\n    TopReferers   []RefererCount `json:\"top_referers\"` // always array, never null\n}\n// timelineResponse is the JSON shape for GET /stats/:code/timeline.\ntype timelineResponse struct {\n    ShortCode string          `json:\"short_code\"`\n    Interval  string          `json:\"interval\"`  // \"day\" | \"hour\" echoed back\n    Points    []TimelinePoint `json:\"points\"`    // always array, never null\n}\n```\n\n### 3.3 Repository Interfaces\n\n```go\n// store.go\n// ClickRepository abstracts all DB operations on the clicks table.\ntype ClickRepository interface {\n    // Insert creates a new click row. Called within a transaction.\n    // rec.ID is populated by the DB (gen_random_uuid()); caller passes zero value.\n    Insert(ctx context.Context, tx pgx.Tx, rec *ClickRecord) error\n    // CountByCode returns total click count for a short_code.\n    CountByCode(ctx context.Context, shortCode string) (int64, error)\n    // CountByCodeSince returns click count for a short_code after the given time.\n    CountByCodeSince(ctx context.Context, shortCode string, since time.Time) (int64, error)\n    // TopReferers returns the top N referers for a short_code by count, descending.\n    // Only non-NULL referer rows are considered (partial index).\n    // n is always 5 in this project.\n    TopReferers(ctx context.Context, shortCode string, n int) ([]RefererCount, error)\n    // TimelineBuckets returns click counts bucketed by the given PostgreSQL truncation unit.\n    // truncUnit is \"day\" or \"hour\" — validated by caller before reaching here.\n    // Returns buckets ordered by period ASC.\n    TimelineBuckets(ctx context.Context, shortCode string, truncUnit string) ([]TimelinePoint, error)\n}\n// MilestoneRepository abstracts all DB operations on the milestones table.\ntype MilestoneRepository interface {\n    // HasMilestone returns true if the given (shortCode, milestone) row exists.\n    HasMilestone(ctx context.Context, tx pgx.Tx, shortCode string, milestone int) (bool, error)\n    // Insert records that a milestone was reached. Uses ON CONFLICT DO NOTHING for idempotency.\n    // Called within a transaction.\n    Insert(ctx context.Context, tx pgx.Tx, shortCode string, milestone int) error\n}\n// DeduplicationRepository abstracts all DB operations on the processed_events table.\ntype DeduplicationRepository interface {\n    // Exists checks if the given event_id has already been processed.\n    // Called within a transaction (holds a row-level lock on the insert for the duration).\n    Exists(ctx context.Context, tx pgx.Tx, eventID string) (bool, error)\n    // Insert records an event_id as processed. Called within the same transaction as Exists.\n    // On conflict (race between two consumer instances): ON CONFLICT DO NOTHING.\n    Insert(ctx context.Context, tx pgx.Tx, eventID string) error\n}\n```\n\n![Analytics Service Module Architecture](./diagrams/tdd-diag-22.svg)\n\n```\nData ownership and flow:\nRabbitMQ                analytics-service               analytics_db\nqueue:                  ┌────────────────────────────┐  ┌──────────────────────┐\n\"analytics.clicks\"      │  ClickConsumer goroutine    │  │  clicks              │\n       │                │                            │  │  milestones          │\n       │ AMQP Deliver   │  1. decode JSON            │  │  processed_events    │\n       └───────────────►│  2. dedup check (tx)       │  └──────────────────────┘\n                        │  3. insert click (same tx) │           ▲\n                        │  4. milestone check (tx)   │           │\n                        │  5. commit tx              │───────────┘\n                        │  6. maybe publish          │\n                        │     MilestoneReachedEvent  │\n                        │  7. d.Ack()                │\n                        │                            │\nHTTP (public)           │  StatsHandler              │\nGET /stats/:code ──────►│    CountByCode             │\nGET /stats/.../timeline►│    CountByCodeSince        │\n                        │    TopReferers             │\n                        │    TimelineBuckets         │\n                        └────────────────────────────┘\n                                     │\n                              RabbitMQ publish\n                              routing key:\n                              \"milestone.reached\"\n                                     │\n                                     ▼\n                         notifications.events queue\n                         (notification-service M5)\n```\n\n---\n\n## 4. Interface Contracts\n\n### 4.1 `ClickRepository` — `pgxClickStore` Implementation\n\n```go\n// store.go\ntype pgxClickStore struct {\n    pool *pgxpool.Pool\n}\nfunc NewClickStore(pool *pgxpool.Pool) ClickRepository {\n    return &pgxClickStore{pool: pool}\n}\n```\n\n**`Insert(ctx context.Context, tx pgx.Tx, rec *ClickRecord) error`**\n\n```\nSQL (executed on tx):\n  INSERT INTO clicks (short_code, clicked_at, ip_hash, user_agent, referer)\n  VALUES ($1, $2, $3, $4, $5)\nParameters:\n  $1 rec.ShortCode\n  $2 rec.ClickedAt    (time.Time; pgx maps to TIMESTAMPTZ)\n  $3 rec.IPHash       (64-char hex string)\n  $4 rec.UserAgent    (empty string acceptable; NOT NULL DEFAULT '')\n  $5 rec.Referer      (empty string → NULL in DB via nilable helper; see note)\nReferer NULL handling:\n  Pass nil to pgx when rec.Referer == \"\" to store SQL NULL (allows partial index).\n  Use pgtype.Text{String: rec.Referer, Valid: rec.Referer != \"\"} or convert to *string.\nOn success: return nil\nOn DB error: return fmt.Errorf(\"insert click: %w\", err)\n```\n\n**`CountByCode(ctx context.Context, shortCode string) (int64, error)`**\n\n```\nSQL:\n  SELECT COUNT(*) FROM clicks WHERE short_code = $1\nUses idx_clicks_short_code_time (leading column = short_code).\nOn success: return count, nil\nOn DB error: return 0, fmt.Errorf(\"count clicks by code: %w\", err)\n```\n\n**`CountByCodeSince(ctx context.Context, shortCode string, since time.Time) (int64, error)`**\n\n```\nSQL:\n  SELECT COUNT(*) FROM clicks\n  WHERE short_code = $1 AND clicked_at >= $2\nParameters: shortCode, since (time.Time)\nSince values in use:\n  24h window: time.Now().UTC().Add(-24 * time.Hour)\n   7d window: time.Now().UTC().Add(-7 * 24 * time.Hour)\nUses idx_clicks_short_code_time (composite: short_code + clicked_at DESC).\nOn success: return count, nil\nOn DB error: return 0, fmt.Errorf(\"count clicks since: %w\", err)\n```\n\n**`TopReferers(ctx context.Context, shortCode string, n int) ([]RefererCount, error)`**\n\n```\nSQL:\n  SELECT referer, COUNT(*) AS cnt\n  FROM clicks\n  WHERE short_code = $1 AND referer IS NOT NULL\n  GROUP BY referer\n  ORDER BY cnt DESC\n  LIMIT $2\nParameters: shortCode, n (always 5)\nUses idx_clicks_referer (partial index WHERE referer IS NOT NULL).\nOn 0 rows: return empty []RefererCount{}, nil — NOT an error\nOn DB error: return nil, fmt.Errorf(\"top referers: %w\", err)\nNote: Caller is responsible for initializing []RefererCount{} (not nil) so\n      JSON serializes as [] rather than null.\n```\n\n**`TimelineBuckets(ctx context.Context, shortCode string, truncUnit string) ([]TimelinePoint, error)`**\n\n```\nSQL:\n  SELECT\n    date_trunc($1, clicked_at AT TIME ZONE 'UTC') AS period,\n    COUNT(*) AS clicks\n  FROM clicks\n  WHERE short_code = $2\n  GROUP BY period\n  ORDER BY period ASC\nParameters:\n  $1 truncUnit (\"day\" or \"hour\") — caller validates before passing\n  $2 shortCode\nOn success: scan each row into TimelinePoint{Period: period.Format(time.RFC3339), Clicks: count}\n  period is a time.Time from PostgreSQL; format with .UTC().Format(time.RFC3339)\nOn 0 rows: return empty []TimelinePoint{}, nil\nOn DB error: return nil, fmt.Errorf(\"timeline buckets: %w\", err)\n```\n\n### 4.2 `MilestoneRepository` — `pgxMilestoneStore` Implementation\n\n```go\ntype pgxMilestoneStore struct {\n    pool *pgxpool.Pool\n}\nfunc NewMilestoneStore(pool *pgxpool.Pool) MilestoneRepository {\n    return &pgxMilestoneStore{pool: pool}\n}\n```\n\n**`HasMilestone(ctx context.Context, tx pgx.Tx, shortCode string, milestone int) (bool, error)`**\n\n```\nSQL (on tx):\n  SELECT EXISTS(\n    SELECT 1 FROM milestones\n    WHERE short_code = $1 AND milestone = $2\n  )\nParameters: shortCode, milestone\nOn success: return bool, nil\nOn DB error: return false, fmt.Errorf(\"has milestone: %w\", err)\n```\n\n**`Insert(ctx context.Context, tx pgx.Tx, shortCode string, milestone int) error`**\n\n```\nSQL (on tx):\n  INSERT INTO milestones (short_code, milestone)\n  VALUES ($1, $2)\n  ON CONFLICT (short_code, milestone) DO NOTHING\nParameters: shortCode, milestone\nON CONFLICT DO NOTHING: safe for concurrent consumers or replay scenarios.\nOn success (insert or no-op): return nil\nOn DB error (non-conflict): return fmt.Errorf(\"insert milestone: %w\", err)\n```\n\n### 4.3 `DeduplicationRepository` — `pgxDeduplicationStore` Implementation\n\n```go\ntype pgxDeduplicationStore struct {\n    pool *pgxpool.Pool\n}\nfunc NewDeduplicationStore(pool *pgxpool.Pool) DeduplicationRepository {\n    return &pgxDeduplicationStore{pool: pool}\n}\n```\n\n**`Exists(ctx context.Context, tx pgx.Tx, eventID string) (bool, error)`**\n\n```\nSQL (on tx):\n  SELECT EXISTS(SELECT 1 FROM processed_events WHERE event_id = $1)\nParameters: eventID\nOn success: return bool, nil\nOn DB error: return false, fmt.Errorf(\"dedup exists: %w\", err)\nNote: Running inside the same transaction as Insert below ensures\n      that a concurrent consumer seeing the same event_id will either:\n      (a) see Exists=true (our tx already committed), or\n      (b) hit a PRIMARY KEY violation on Insert (our tx committed first).\n      Single consumer with prefetch=1 makes this moot in practice,\n      but the tx boundary is required for correctness.\n```\n\n**`Insert(ctx context.Context, tx pgx.Tx, eventID string) error`**\n\n```\nSQL (on tx):\n  INSERT INTO processed_events (event_id)\n  VALUES ($1)\n  ON CONFLICT (event_id) DO NOTHING\nParameters: eventID\nOn success (insert or no-op conflict): return nil\nOn DB error (non-conflict): return fmt.Errorf(\"dedup insert: %w\", err)\n```\n\n### 4.4 `AnalyticsPublisher` Interface\n\n```go\n// publisher.go\ntype AnalyticsPublisher interface {\n    // PublishMilestone sends a MilestoneReachedEvent to the \"url-shortener\" exchange\n    // with routing key \"milestone.reached\".\n    // Returns error if publish fails; caller logs and continues.\n    PublishMilestone(ctx context.Context, evt *events.MilestoneReachedEvent) error\n}\ntype amqpAnalyticsPublisher struct {\n    ch           *amqp.Channel\n    exchangeName string\n    log          *slog.Logger\n}\nfunc NewAnalyticsPublisher(ch *amqp.Channel, log *slog.Logger) AnalyticsPublisher {\n    return &amqpAnalyticsPublisher{ch: ch, exchangeName: \"url-shortener\", log: log}\n}\n```\n\n**`PublishMilestone(ctx context.Context, evt *events.MilestoneReachedEvent) error`**\n\n```go\nfunc (p *amqpAnalyticsPublisher) PublishMilestone(ctx context.Context, evt *events.MilestoneReachedEvent) error {\n    body, err := json.Marshal(evt)\n    if err != nil {\n        return fmt.Errorf(\"marshal MilestoneReachedEvent: %w\", err)\n    }\n    err = p.ch.PublishWithContext(ctx,\n        p.exchangeName,          // exchange\n        events.EventTypeMilestoneReached, // routing key: \"milestone.reached\"\n        false,                   // mandatory\n        false,                   // immediate\n        amqp.Publishing{\n            ContentType:  \"application/json\",\n            DeliveryMode: amqp.Persistent,\n            Body:         body,\n        },\n    )\n    if err != nil {\n        return fmt.Errorf(\"amqp publish milestone: %w\", err)\n    }\n    return nil\n}\n```\n\n**Note on channel safety:** `amqp091-go` channels are not safe for concurrent use. Since the consumer goroutine is the only goroutine calling `PublishMilestone`, no mutex is required here (unlike the url-service 3-worker case). If HTTP handlers ever need to publish, a mutex must be added.\n\n### 4.5 `MilestoneChecker`\n\n```go\n// milestone.go\nconst (\n    MilestoneThreshold10   = 10\n    MilestoneThreshold100  = 100\n    MilestoneThreshold1000 = 1000\n)\nvar MilestoneThresholds = []int{MilestoneThreshold10, MilestoneThreshold100, MilestoneThreshold1000}\ntype MilestoneChecker struct {\n    clickStore     ClickRepository\n    milestoneStore MilestoneRepository\n    publisher      AnalyticsPublisher\n    log            *slog.Logger\n}\nfunc NewMilestoneChecker(\n    clickStore ClickRepository,\n    milestoneStore MilestoneRepository,\n    publisher AnalyticsPublisher,\n    log *slog.Logger,\n) *MilestoneChecker\n// CheckAndPublish is called inline in the consumer goroutine after a click is inserted.\n// It reads total_clicks for the short_code (within the same tx to get the post-insert count),\n// checks each threshold, and for any newly crossed threshold: inserts a milestone row\n// and publishes MilestoneReachedEvent.\n//\n// Parameters:\n//   ctx       - request context with deadline\n//   tx        - the active transaction (click + dedup already inserted within it)\n//   shortCode - the code that just received a click\n//   userID    - from URLClickedEvent (may be empty if not in event; use \"unknown\")\n//   userEmail - from URLClickedEvent (may be empty; use \"\" for MilestoneReachedEvent)\n//   corrID    - correlation ID for event propagation\n//\n// Returns: error only for fatal DB errors — publish failures are logged and swallowed.\nfunc (m *MilestoneChecker) CheckAndPublish(\n    ctx context.Context,\n    tx pgx.Tx,\n    shortCode, userID, userEmail, corrID string,\n) error\n```\n\n---\n\n## 5. Algorithm Specification\n\n### 5.1 Consumer Startup and AMQP Prefetch\n\n```\n// consumer.go — called in main.go\ntype ClickConsumer struct {\n    conn       *RabbitMQConn        // from M1 factory\n    pool       *pgxpool.Pool\n    clickStore ClickRepository\n    milestoneStore MilestoneRepository\n    dedupStore DeduplicationRepository\n    checker    *MilestoneChecker\n    log        *slog.Logger\n    salt       string               // IP_HASH_SALT from config\n    healthy    atomic.Bool          // true when consumer loop is running\n}\nfunc NewClickConsumer(\n    conn *RabbitMQConn,\n    pool *pgxpool.Pool,\n    clickStore ClickRepository,\n    milestoneStore MilestoneRepository,\n    dedupStore DeduplicationRepository,\n    checker *MilestoneChecker,\n    log *slog.Logger,\n    salt string,\n) *ClickConsumer\n// Run starts the consumer loop. Blocks until ctx is Done.\n// Called with: go consumer.Run(ctx) in main.go.\nfunc (c *ClickConsumer) Run(ctx context.Context)\n```\n\n**`Run(ctx context.Context)` Algorithm:**\n\n```\nStep 1: Set quality-of-service (prefetch)\n  err := c.conn.Channel.Qos(\n      1,     // prefetchCount: process one message at a time\n      0,     // prefetchSize: no size limit\n      false, // global: apply per-consumer not per-channel\n  )\n  if err != nil:\n      c.log.Error(\"set qos failed\", \"error\", err)\n      os.Exit(1)  // fatal: cannot guarantee serial processing without prefetch\nStep 2: Register consumer\n  msgs, err := c.conn.Channel.Consume(\n      \"analytics.clicks\", // queue (declared in M1 DeclareAnalyticsQueue)\n      \"\",                 // consumer tag: auto-generated\n      false,              // autoAck: false — we ack manually after processing\n      false,              // exclusive: false\n      false,              // noLocal: false\n      false,              // noWait: false\n      nil,                // args\n  )\n  if err != nil:\n      c.log.Error(\"register consumer failed\", \"error\", err)\n      os.Exit(1)  // fatal: cannot function without consumer registration\nStep 3: Mark healthy\n  c.healthy.Store(true)\n  c.log.Info(\"consumer started\", \"queue\", \"analytics.clicks\")\nStep 4: Message loop\n  for:\n      select:\n      case <-ctx.Done():\n          c.healthy.Store(false)\n          c.log.Info(\"consumer stopped\")\n          return\n      case d, ok := <-msgs:\n          if !ok:\n              // Channel closed (RabbitMQ connection dropped)\n              c.healthy.Store(false)\n              c.log.Warn(\"amqp channel closed, consumer paused\")\n              // Do NOT os.Exit — /health must remain 200\n              // Block until ctx is done (reconnect logic is future work; in-scope for M5)\n              <-ctx.Done()\n              return\n          c.processDelivery(ctx, d)\n```\n\n**`processDelivery(ctx context.Context, d amqp.Delivery)` Algorithm:**\n\n```\nStep 1: Panic recovery (poison message guard)\n  defer func() {\n      if r := recover(); r != nil:\n          c.log.Error(\"consumer panic recovered\",\n              \"panic\", fmt.Sprintf(\"%v\", r),\n              \"body_preview\", truncate(string(d.Body), 200),\n          )\n          d.Ack(false)  // ack to remove from queue; do not requeue a panicking message\n  }()\nStep 2: Decode JSON\n  var evt events.URLClickedEvent\n  if err := json.Unmarshal(d.Body, &evt); err != nil:\n      c.log.Error(\"poison message: JSON unmarshal failed\",\n          \"error\", err,\n          \"body_preview\", truncate(string(d.Body), 200),\n      )\n      d.Ack(false)  // ack (NOT nack) to drain poison messages without requeue\n      return\nStep 3: Validate required fields\n  if evt.EventID == \"\" || evt.ShortCode == \"\":\n      c.log.Error(\"poison message: missing required fields\",\n          \"event_id\", evt.EventID,\n          \"short_code\", evt.ShortCode,\n      )\n      d.Ack(false)\n      return\nStep 4: Open transaction\n  tx, err := c.pool.Begin(ctx)\n  if err != nil:\n      c.log.Error(\"begin tx failed\", \"error\", err, \"event_id\", evt.EventID)\n      d.Nack(false, true)  // nack + requeue — DB might recover\n      return\nStep 5: Idempotency check\n  exists, err := c.dedupStore.Exists(ctx, tx, evt.EventID)\n  if err != nil:\n      tx.Rollback(ctx)\n      c.log.Error(\"dedup exists check failed\", \"error\", err, \"event_id\", evt.EventID)\n      d.Nack(false, true)\n      return\n  if exists:\n      tx.Rollback(ctx)\n      c.log.Info(\"duplicate event skipped\", \"event_id\", evt.EventID)\n      d.Ack(false)\n      return\nStep 6: Record event_id as processed\n  if err := c.dedupStore.Insert(ctx, tx, evt.EventID); err != nil:\n      tx.Rollback(ctx)\n      c.log.Error(\"dedup insert failed\", \"error\", err, \"event_id\", evt.EventID)\n      d.Nack(false, true)\n      return\nStep 7: Build and insert click record\n  rec := &ClickRecord{\n      ShortCode: evt.ShortCode,\n      ClickedAt: evt.ClickedAt,\n      IPHash:    evt.IPHash,   // already hashed by url-service; do NOT re-hash\n      UserAgent: evt.UserAgent,\n      Referer:   evt.Referer,\n  }\n  if err := c.clickStore.Insert(ctx, tx, rec); err != nil:\n      tx.Rollback(ctx)\n      c.log.Error(\"click insert failed\", \"error\", err, \"event_id\", evt.EventID)\n      d.Nack(false, true)\n      return\nStep 8: Milestone check (inline, same tx)\n  corrID := evt.CorrelationID\n  if corrID == \"\" { corrID = evt.EventID }\n  if err := c.checker.CheckAndPublish(ctx, tx, evt.ShortCode, \"\", \"\", corrID); err != nil:\n      tx.Rollback(ctx)\n      c.log.Error(\"milestone check failed\", \"error\", err, \"event_id\", evt.EventID)\n      d.Nack(false, true)\n      return\nStep 9: Commit transaction\n  if err := tx.Commit(ctx); err != nil:\n      c.log.Error(\"commit failed\", \"error\", err, \"event_id\", evt.EventID)\n      d.Nack(false, true)\n      return\nStep 10: Acknowledge message\n  d.Ack(false)\n  c.log.Info(\"click processed\",\n      \"event_id\", evt.EventID,\n      \"short_code\", evt.ShortCode,\n      \"correlation_id\", corrID,\n  )\n```\n\n### 5.2 `MilestoneChecker.CheckAndPublish` Algorithm\n\n```\nInput:\n  ctx       context.Context\n  tx        pgx.Tx          (click + dedup already inserted, tx not yet committed)\n  shortCode string\n  userID    string          (from URLClickedEvent; may be empty — use \"\" in event payload)\n  userEmail string          (from URLClickedEvent; may be empty)\n  corrID    string\nStep 1: Count total clicks for this shortCode within the transaction\n  // Use pool directly (not tx) to get committed count + current tx count.\n  // IMPORTANT: Use tx.QueryRow so the count includes the click we just inserted\n  //            (the INSERT is visible within this transaction but not yet committed).\n  var totalClicks int64\n  row := tx.QueryRow(ctx,\n      \"SELECT COUNT(*) FROM clicks WHERE short_code = $1\",\n      shortCode,\n  )\n  if err := row.Scan(&totalClicks); err != nil:\n      return fmt.Errorf(\"count clicks for milestone: %w\", err)\nStep 2: Check each threshold in ascending order\n  for _, threshold := range MilestoneThresholds:  // [10, 100, 1000]\n      if totalClicks < int64(threshold):\n          continue  // not yet reached\n      // Has it already been recorded?\n      alreadyRecorded, err := m.milestoneStore.HasMilestone(ctx, tx, shortCode, threshold)\n      if err != nil:\n          return fmt.Errorf(\"has milestone %d: %w\", threshold, err)\n      if alreadyRecorded:\n          continue  // already crossed and recorded\n      // New milestone! Record it.\n      if err := m.milestoneStore.Insert(ctx, tx, shortCode, threshold); err != nil:\n          return fmt.Errorf(\"insert milestone %d: %w\", threshold, err)\n      // Publish MilestoneReachedEvent (outside tx — publish after milestone committed is\n      // safer; but here we publish before commit. If commit fails, we have a phantom event.\n      // This is acceptable: milestone.reached is informational; notification-service\n      // deduplication via processed_events in M5 handles replays.)\n      //\n      // Build and publish after tx.Commit() in the caller would be ideal but requires\n      // returning the milestone data from this function. For simplicity, publish here\n      // before commit. If publish fails, we still commit (milestone row is durable).\n      evt := &events.MilestoneReachedEvent{\n          BaseEvent: events.BaseEvent{\n              EventType:     events.EventTypeMilestoneReached,\n              OccurredAt:    time.Now().UTC(),\n              CorrelationID: corrID,\n              EventID:       newUUID(),\n          },\n          ShortCode:   shortCode,\n          UserID:      userID,\n          UserEmail:   userEmail,\n          MilestoneN:  threshold,\n          TotalClicks: totalClicks,\n      }\n      publishCtx, cancel := context.WithTimeout(ctx, 3*time.Second)\n      if publishErr := m.publisher.PublishMilestone(publishCtx, evt); publishErr != nil:\n          m.log.Warn(\"milestone event publish failed\",\n              \"threshold\", threshold,\n              \"short_code\", shortCode,\n              \"error\", publishErr,\n          )\n          // Do NOT return error — milestone row is committed; publish failure is non-fatal\n      cancel()\nStep 3: Return nil (all thresholds checked)\n  return nil\n```\n\n**Design note on publish-before-commit:** Publishing `MilestoneReachedEvent` inside the transaction scope means the event goes out before the milestone row is committed. If the commit subsequently fails, a phantom notification is sent. The alternative (publishing post-commit) requires returning milestone data from `CheckAndPublish` and restructuring the consumer. For this project's scope, the phantom-event risk is accepted because milestone notifications are informational, not transactional. A production system would use the outbox pattern here too.\n\n### 5.3 `GET /stats/:code` Handler\n\n```\nInput:  path parameter: code string\nOutput: 200 statsResponse | 404 | 500\nNo authentication required.\nStep 1: Extract short_code from path\n  code := r.PathValue(\"code\")\n  if code == \"\":\n      writeError(w, 400, \"short_code is required\"); return\nStep 2: Execute aggregation queries (concurrent with errgroup for performance)\n  g, gCtx := errgroup.WithContext(r.Context())\n  var total, last24h, last7d int64\n  var topRefs []RefererCount\n  g.Go(func() error {\n      var err error\n      total, err = h.clickStore.CountByCode(gCtx, code)\n      return err\n  })\n  g.Go(func() error {\n      var err error\n      last24h, err = h.clickStore.CountByCodeSince(gCtx, code, time.Now().UTC().Add(-24*time.Hour))\n      return err\n  })\n  g.Go(func() error {\n      var err error\n      last7d, err = h.clickStore.CountByCodeSince(gCtx, code, time.Now().UTC().Add(-7*24*time.Hour))\n      return err\n  })\n  g.Go(func() error {\n      var err error\n      topRefs, err = h.clickStore.TopReferers(gCtx, code, 5)\n      if topRefs == nil { topRefs = []RefererCount{} }  // ensure JSON []\n      return err\n  })\n  if err := g.Wait(); err != nil:\n      h.log.Error(\"stats query failed\", \"code\", code, \"error\", err)\n      writeError(w, 500, \"internal server error\"); return\nStep 3: If total == 0 AND we want to return 404 for unknown codes...\n  Note: The spec says stats are public and does NOT require the code to exist in url_db\n  (analytics trusts events). A short_code with 0 clicks returns 200 with zeroed stats.\n  We do NOT call url-service to check existence. Return 200 with zeros.\nStep 4: Write response\n  writeJSON(w, 200, statsResponse{\n      ShortCode:     code,\n      TotalClicks:   total,\n      ClicksLast24h: last24h,\n      ClicksLast7d:  last7d,\n      TopReferers:   topRefs,\n  })\n```\n\n### 5.4 `GET /stats/:code/timeline` Handler\n\n```\nInput:  path parameter: code; query param: interval=day|hour\nOutput: 200 timelineResponse | 400 | 500\nStep 1: Extract and validate params\n  code := r.PathValue(\"code\")\n  interval := r.URL.Query().Get(\"interval\")\n  if interval != \"day\" && interval != \"hour\":\n      writeError(w, 400, `interval must be \"day\" or \"hour\"`); return\nStep 2: Map interval to PostgreSQL date_trunc unit\n  // \"day\" → \"day\", \"hour\" → \"hour\"\n  // Both are valid PostgreSQL date_trunc units; no remapping needed.\n  truncUnit := interval\nStep 3: Query buckets\n  points, err := h.clickStore.TimelineBuckets(r.Context(), code, truncUnit)\n  if err != nil:\n      h.log.Error(\"timeline query failed\", \"code\", code, \"error\", err)\n      writeError(w, 500, \"internal server error\"); return\n  if points == nil { points = []TimelinePoint{} }\nStep 4: Write response\n  writeJSON(w, 200, timelineResponse{\n      ShortCode: code,\n      Interval:  interval,\n      Points:    points,\n  })\n```\n\n### 5.5 Schema Migration on Startup\n\n```go\n// main.go — after NewDBPool succeeds, before consumer or HTTP server start\nconst analyticsSchema = `\nCREATE TABLE IF NOT EXISTS clicks (\n    id          UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n    short_code  TEXT        NOT NULL,\n    clicked_at  TIMESTAMPTZ NOT NULL,\n    ip_hash     TEXT        NOT NULL,\n    user_agent  TEXT        NOT NULL DEFAULT '',\n    referer     TEXT        NULL\n);\nCREATE INDEX IF NOT EXISTS idx_clicks_short_code_time\n    ON clicks(short_code, clicked_at DESC);\nCREATE INDEX IF NOT EXISTS idx_clicks_referer\n    ON clicks(short_code, referer)\n    WHERE referer IS NOT NULL;\nCREATE TABLE IF NOT EXISTS milestones (\n    id           UUID  PRIMARY KEY DEFAULT gen_random_uuid(),\n    short_code   TEXT  NOT NULL,\n    milestone    INT   NOT NULL,\n    triggered_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n    UNIQUE (short_code, milestone)\n);\nCREATE UNIQUE INDEX IF NOT EXISTS idx_milestones_code_milestone\n    ON milestones(short_code, milestone);\nCREATE TABLE IF NOT EXISTS processed_events (\n    event_id     TEXT PRIMARY KEY,\n    processed_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n`\nfunc runMigrations(ctx context.Context, pool *pgxpool.Pool, log *slog.Logger) error {\n    _, err := pool.Exec(ctx, analyticsSchema)\n    if err != nil {\n        return fmt.Errorf(\"run analytics migrations: %w\", err)\n    }\n    log.Info(\"analytics migrations applied\")\n    return nil\n}\n```\n\n### 5.6 `hashIP` Function (`haship.go`)\n\n```go\n// haship.go\npackage analytics\nimport (\n    \"crypto/sha256\"\n    \"fmt\"\n    \"net\"\n)\n// hashIP extracts the IP from remoteAddr and returns SHA-256(ip + salt) as a hex string.\n// If port splitting fails, uses the raw remoteAddr as the input.\n// This function is NOT called in the analytics consumer — the ip_hash is already computed\n// by url-service before being embedded in URLClickedEvent.IPHash.\n// Provided here for local test utilities and future analytics-internal use.\nfunc hashIP(remoteAddr, salt string) string {\n    ip, _, err := net.SplitHostPort(remoteAddr)\n    if err != nil {\n        ip = remoteAddr\n    }\n    h := sha256.Sum256([]byte(ip + salt))\n    return fmt.Sprintf(\"%x\", h)\n}\n```\n\n**Critical:** The analytics consumer reads `evt.IPHash` directly from the `URLClickedEvent`. It does **not** receive a raw IP. The `hashIP` function in analytics-service is present only for test utilities. The ip_hash field in the click row is always the value from the event payload, which was already hashed by url-service.\n\n### 5.7 `newUUID` Helper\n\n```go\n// consumer.go or a shared helpers.go within analytics package\nimport (\n    \"crypto/rand\"\n    \"fmt\"\n)\nfunc newUUID() string {\n    b := make([]byte, 16)\n    rand.Read(b)\n    b[6] = (b[6] & 0x0f) | 0x40\n    b[8] = (b[8] & 0x3f) | 0x80\n    return fmt.Sprintf(\"%08x-%04x-%04x-%04x-%012x\",\n        b[0:4], b[4:6], b[6:8], b[8:10], b[10:16])\n}\n```\n\n### 5.8 Route and Consumer Registration in `main.go`\n\n```go\n// services/analytics-service/main.go\npackage main\nimport (\n    \"context\"\n    \"fmt\"\n    \"net/http\"\n    \"os\"\n    \"os/signal\"\n    \"syscall\"\n    \"github.com/yourhandle/url-shortener/shared/logger\"\n)\nfunc main() {\n    cfg, err := loadConfig()\n    if err != nil {\n        fmt.Fprintf(os.Stderr, \"config error: %v\\n\", err)\n        os.Exit(1)\n    }\n    log := logger.New(cfg.ServiceName)\n    ctx, cancel := context.WithCancel(context.Background())\n    defer cancel()\n    pool, err := NewDBPool(ctx, cfg.DatabaseURL, log)\n    if err != nil {\n        log.Error(\"db unreachable\", \"error\", err)\n        os.Exit(1)\n    }\n    defer pool.Close()\n    if err := runMigrations(ctx, pool, log); err != nil {\n        log.Error(\"migration failed\", \"error\", err)\n        os.Exit(1)\n    }\n    mq, err := NewRabbitMQConn(ctx, cfg.RabbitMQURL, log, 10)\n    if err != nil {\n        log.Error(\"rabbitmq unreachable\", \"error\", err)\n        os.Exit(1)\n    }\n    defer mq.Close()\n    if err := DeclareAnalyticsQueue(mq.Channel); err != nil {\n        log.Error(\"declare analytics queue failed\", \"error\", err)\n        os.Exit(1)\n    }\n    // Construct repositories\n    clickStore     := NewClickStore(pool)\n    milestoneStore := NewMilestoneStore(pool)\n    dedupStore     := NewDeduplicationStore(pool)\n    publisher      := NewAnalyticsPublisher(mq.Channel, log)\n    checker        := NewMilestoneChecker(clickStore, milestoneStore, publisher, log)\n    consumer := NewClickConsumer(\n        mq, pool, clickStore, milestoneStore, dedupStore, checker, log, cfg.IPHashSalt,\n    )\n    // Construct HTTP handler\n    statsHandler := NewStatsHandler(clickStore, log)\n    mux := http.NewServeMux()\n    mux.HandleFunc(\"GET /health\", NewHealthHandler(cfg.ServiceName))\n    mux.HandleFunc(\"GET /stats/{code}\", statsHandler.Stats)\n    mux.HandleFunc(\"GET /stats/{code}/timeline\", statsHandler.Timeline)\n    // Start consumer goroutine\n    go consumer.Run(ctx)\n    srv := &http.Server{Addr: \":\" + cfg.Port, Handler: mux}\n    go func() {\n        log.Info(\"server listening\", \"port\", cfg.Port)\n        if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {\n            log.Error(\"server error\", \"error\", err)\n            os.Exit(1)\n        }\n    }()\n    quit := make(chan os.Signal, 1)\n    signal.Notify(quit, syscall.SIGTERM, syscall.SIGINT)\n    <-quit\n    log.Info(\"shutting down analytics-service\")\n    cancel()\n    srv.Shutdown(context.Background())\n}\n```\n\n![Analytics DB Schema: clicks, milestones, processed_events](./diagrams/tdd-diag-23.svg)\n\n```\nStartup sequence — analytics-service:\n  loadConfig() ── fatal if DATABASE_URL or RABBITMQ_URL missing\n       │\n       ▼\n  logger.New(\"analytics-service\")\n       │\n       ▼\n  NewDBPool() ── fatal on error\n       │\n       ▼\n  runMigrations() ── fatal on error\n       │\n       ▼\n  NewRabbitMQConn() ── fatal after 10 attempts; declares exchange\n       │\n       ▼\n  DeclareAnalyticsQueue() ── fatal on error\n       │              declares queue \"analytics.clicks\"\n       │              binds routing key \"url.clicked\"\n       │\n       ▼\n  Construct: clickStore, milestoneStore, dedupStore, publisher, checker, consumer\n       │\n       ▼\n  go consumer.Run(ctx) ── background goroutine\n       │       sets prefetch=1, registers consumer, marks healthy\n       │\n       ▼\n  mux.HandleFunc(...) ── /health, /stats/{code}, /stats/{code}/timeline\n       │\n       ▼\n  srv.ListenAndServe() ── blocks\n       │\n       │ SIGTERM\n       ▼\n  cancel() → consumer.Run exits → srv.Shutdown()\n```\n\n---\n\n## 6. Error Handling Matrix\n\n| Error Scenario                             | Detected By                   | Recovery                                | HTTP Status / AMQP Action | Log Level      | Notes                                                      |\n| ------------------------------------------ | ----------------------------- | --------------------------------------- | ------------------------- | -------------- | ---------------------------------------------------------- |\n| Missing `DATABASE_URL`                     | `loadConfig()`                | `fmt.Fprintf(stderr)` + `os.Exit(1)`    | — (pre-HTTP)              | Error (stderr) | Name the missing var                                       |\n| Missing `RABBITMQ_URL`                     | `loadConfig()`                | `os.Exit(1)`                            | — (pre-HTTP)              | Error          |                                                            |\n| DB unreachable at startup                  | `NewDBPool` / `pool.Ping`     | `os.Exit(1)`                            | — (pre-HTTP)              | Error          | Log masked DSN                                             |\n| Migration SQL fails                        | `runMigrations`               | `os.Exit(1)`                            | — (pre-HTTP)              | Error          |                                                            |\n| RabbitMQ unreachable (all 10 attempts)     | `NewRabbitMQConn`             | `os.Exit(1)`                            | — (pre-HTTP)              | Error          |                                                            |\n| Queue declare fails                        | `DeclareAnalyticsQueue`       | `os.Exit(1)`                            | — (pre-HTTP)              | Error          |                                                            |\n| Consumer QoS set fails                     | `ch.Qos(1,0,false)`           | `os.Exit(1)`                            | — (pre-HTTP)              | Error          | Serial guarantees lost without prefetch=1                  |\n| Consumer registration fails                | `ch.Consume(...)`             | `os.Exit(1)`                            | — (pre-HTTP)              | Error          |                                                            |\n| AMQP channel closed mid-run                | `<-msgs` ok=false             | Mark unhealthy, block on `<-ctx.Done()` | —                         | Warn           | `/health` still returns 200 (healthcheck only checks HTTP) |\n| Malformed JSON in message body             | `json.Unmarshal`              | `d.Ack(false)`                          | —                         | Error          | `\"poison message\"` + body preview (truncated 200 chars)    |\n| Missing `event_id` or `short_code`         | Field check after decode      | `d.Ack(false)`                          | —                         | Error          | `\"poison message: missing required fields\"`                |\n| Consumer panic                             | `defer recover()`             | `d.Ack(false)`                          | —                         | Error          | Log panic value + body preview                             |\n| DB `pool.Begin` fails                      | `pool.Begin`                  | `d.Nack(false, true)` — requeue         | —                         | Error          | `\"begin tx failed\"`                                        |\n| `Exists` (dedup check) DB error            | `dedupStore.Exists`           | Rollback + `d.Nack(false, true)`        | —                         | Error          |                                                            |\n| `Insert` (dedup) DB error                  | `dedupStore.Insert`           | Rollback + `d.Nack(false, true)`        | —                         | Error          |                                                            |\n| Duplicate `event_id`                       | `exists == true`              | Rollback + `d.Ack(false)`               | —                         | Info           | `\"duplicate event skipped\"`                                |\n| Click insert DB error                      | `clickStore.Insert`           | Rollback + `d.Nack(false, true)`        | —                         | Error          | `\"click insert failed\"`                                    |\n| Milestone count DB error                   | `tx.QueryRow` COUNT           | Rollback + `d.Nack(false, true)`        | —                         | Error          |                                                            |\n| `HasMilestone` DB error                    | `milestoneStore.HasMilestone` | Rollback + `d.Nack(false, true)`        | —                         | Error          |                                                            |\n| `Insert` milestone DB error                | `milestoneStore.Insert`       | Rollback + `d.Nack(false, true)`        | —                         | Error          |                                                            |\n| `MilestoneReachedEvent` publish fails      | `publisher.PublishMilestone`  | Log + continue (tx still commits)       | —                         | Warn           | `\"milestone event publish failed\"` + threshold + code      |\n| `tx.Commit` fails                          | `tx.Commit`                   | `d.Nack(false, true)`                   | —                         | Error          |                                                            |\n| `GET /stats/:code` DB error (any query)    | `errgroup.Wait`               | 500 response                            | 500                       | Error          |                                                            |\n| `GET /stats/.../timeline` invalid interval | param validation              | 400 response                            | 400                       | none           |                                                            |\n| `GET /stats/.../timeline` DB error         | `clickStore.TimelineBuckets`  | 500 response                            | 500                       | Error          |                                                            |\n\n**`writeError` and `writeJSON` helpers (`errors.go`):**\n\n```go\n// errors.go\npackage analytics\nimport (\n    \"encoding/json\"\n    \"net/http\"\n)\nfunc writeError(w http.ResponseWriter, status int, message string) {\n    w.Header().Set(\"Content-Type\", \"application/json\")\n    w.WriteHeader(status)\n    json.NewEncoder(w).Encode(struct {\n        Error string `json:\"error\"`\n    }{Error: message})\n}\nfunc writeJSON(w http.ResponseWriter, status int, v any) {\n    w.Header().Set(\"Content-Type\", \"application/json\")\n    w.WriteHeader(status)\n    json.NewEncoder(w).Encode(v)\n}\n// truncate returns at most n bytes of s for safe logging of untrusted bodies.\nfunc truncate(s string, n int) string {\n    if len(s) <= n {\n        return s\n    }\n    return s[:n] + \"...\"\n}\n```\n\n---\n\n## 7. Concurrency Specification\n\n| Component                                 | Goroutine Model                             | Shared State                                                                                          | Thread Safety                                                     |\n| ----------------------------------------- | ------------------------------------------- | ----------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------- |\n| `ClickConsumer.Run`                       | 1 dedicated goroutine                       | `*pgxpool.Pool`, `ClickRepository`, `MilestoneRepository`, `DeduplicationRepository`, `*amqp.Channel` | ✅ All safe; single goroutine owns AMQP channel — no mutex needed |\n| `StatsHandler.Stats`                      | per-request (net/http)                      | `ClickRepository` (pool)                                                                              | ✅ pgxpool goroutine-safe                                         |\n| `StatsHandler.Timeline`                   | per-request (net/http)                      | `ClickRepository` (pool)                                                                              | ✅ Same                                                           |\n| `errgroup` goroutines in Stats handler    | 4 sub-goroutines per request                | `ClickRepository` (pool)                                                                              | ✅ pgxpool handles concurrent Acquire internally                  |\n| `amqpAnalyticsPublisher.PublishMilestone` | called only from consumer goroutine         | `*amqp.Channel`                                                                                       | ✅ Single caller; no mutex needed                                 |\n| `consumer.healthy` atomic                 | read by health handler, written by consumer | `atomic.Bool`                                                                                         | ✅ Lock-free atomic                                               |\n\n**AMQP prefetch=1 consequence:** The consumer goroutine processes exactly one message at a time. The broker will not deliver the next message until `d.Ack()` or `d.Nack()` is called. This provides the sequential processing guarantee without explicit locking in the consumer loop.\n**No mutex on AMQP channel:** Unlike url-service which has 3 workers sharing one channel, analytics-service has exactly one goroutine (the consumer) using the AMQP channel for both consuming and publishing. No concurrent access occurs.\n**`atomic.Bool` for health state:** The `healthy` field is written by the consumer goroutine and read by HTTP handler goroutines. Using `sync/atomic.Bool` (Go 1.19+) avoids a mutex on the hot health-check path:\n\n```go\n// consumer.go\ntype ClickConsumer struct {\n    // ...\n    healthy atomic.Bool\n}\n// health.go (extended from M1 for consumer health awareness)\nfunc (c *ClickConsumer) IsHealthy() bool {\n    return c.healthy.Load()\n}\n```\n\n**Note on `/health` during consumer pause:** The spec requires `/health` to return `200` even when RabbitMQ is down. The health handler checks HTTP server liveness only (`{\"status\":\"ok\",\"service\":\"analytics-service\"}`). It does NOT check `consumer.IsHealthy()` — consumer state is operational metadata, not liveness. A Kubernetes readiness probe could check consumer health separately, but that is outside this project's scope.\n\n![Consumer Message Processing State Machine](./diagrams/tdd-diag-24.svg)\n\n```\nTransaction boundary within processDelivery:\n  ┌──────────────────────────────────────────────────────────────────┐\n  │  BEGIN TRANSACTION                                               │\n  │                                                                  │\n  │  dedupStore.Exists(tx, evt.EventID)                              │\n  │       │                                                          │\n  │   exists=true ──► tx.Rollback() → d.Ack() → return              │\n  │       │                                                          │\n  │   exists=false                                                   │\n  │       │                                                          │\n  │  dedupStore.Insert(tx, evt.EventID)                              │\n  │       │                                                          │\n  │  clickStore.Insert(tx, &ClickRecord{...})                        │\n  │       │                                                          │\n  │  checker.CheckAndPublish(ctx, tx, code, ...)                     │\n  │       │                                                          │\n  │       ├── SELECT COUNT(*) FROM clicks WHERE short_code=? (on tx) │\n  │       │                                                          │\n  │       ├── for each threshold [10, 100, 1000]:                    │\n  │       │     milestoneStore.HasMilestone(tx, code, threshold)     │\n  │       │       │                                                  │\n  │       │   not recorded yet                                       │\n  │       │       │                                                  │\n  │       │     milestoneStore.Insert(tx, code, threshold)           │\n  │       │       │                                                  │\n  │       │     publisher.PublishMilestone(ctx, evt)  ◄─ OUTSIDE tx  │\n  │       │       │                                                  │\n  │       │     (publish fail → log + continue; tx not affected)     │\n  │       │                                                          │\n  │  COMMIT TRANSACTION                                              │\n  │                                                                  │\n  │  d.Ack(false)                                                    │\n  └──────────────────────────────────────────────────────────────────┘\n  If any step errors before COMMIT: tx.Rollback() + d.Nack(false, true)\n  If COMMIT fails: d.Nack(false, true)\n  If publish fails after milestone INSERT but before COMMIT:\n    publish failure is logged; COMMIT still proceeds (milestone is durable)\n```\n\n---\n\n## 8. Implementation Sequence with Checkpoints\n\n### Phase 1: DB Schema — `clicks`, `milestones`, `processed_events` Tables (1h)\n\n1. Write `migration.sql` as specified in §3.1.\n2. Write `runMigrations` function in `main.go` (same pattern as url-service).\n3. Extend `config.go` to add `IPHashSalt`.\n4. Run against Docker `analytics_db`:\n\n```bash\ndocker compose up analytics_db -d\nDATABASE_URL=\"postgres://analyticsuser:analyticspass@localhost:5433/analyticsdb\" \\\nRABBITMQ_URL=\"amqp://guest:guest@localhost:5672/\" \\\ngo run ./services/analytics-service/\n```\n\n1. Verify schema:\n\n```bash\npsql -h localhost -p 5433 -U analyticsuser -d analyticsdb \\\n  -c \"\\d clicks; \\d milestones; \\d processed_events; \\di idx_clicks_*; \\di idx_milestones_*;\"\n```\n\n**Checkpoint:** Tables `clicks`, `milestones`, `processed_events` exist with correct columns and types. All five indexes visible in `\\di` output. Service starts and logs `\"analytics migrations applied\"`. `go build ./services/analytics-service/...` exits 0.\n\n### Phase 2: AMQP Consumer Goroutine — Prefetch, Message Loop, Panic Recovery, Idempotency (2–2.5h)\n\n1. Write `errors.go`: `writeError`, `writeJSON`, `truncate`.\n2. Write `haship.go`: `hashIP`, `newUUID`.\n3. Write `store.go`: `ClickRecord`, `MilestoneRecord`, all three repository interfaces, `pgxClickStore` stub (Insert + CountByCode only), `pgxMilestoneStore` stub (HasMilestone + Insert), `pgxDeduplicationStore` (both methods).\n4. Write `publisher.go`: `AnalyticsPublisher` interface, `amqpAnalyticsPublisher`, `PublishMilestone`.\n5. Write `milestone.go`: `MilestoneChecker` struct, `NewMilestoneChecker`, `CheckAndPublish` (stub returning nil for now — complete in Phase 3).\n6. Write `consumer.go`: `ClickConsumer`, `NewClickConsumer`, `Run`, `processDelivery` (full algorithm from §5.1 and §5.2).\n7. Wire consumer in `main.go`: construct all stores, call `go consumer.Run(ctx)`.\n\n```bash\ndocker compose up analytics_db rabbitmq -d\n# Start url-service too so it publishes events on redirect\ndocker compose up url-service -d\n# Start analytics-service\nDATABASE_URL=... RABBITMQ_URL=... go run ./services/analytics-service/\n```\n\nManually trigger a URL click (against url-service):\n\n```bash\ncurl http://localhost:8081/<short_code>\n```\n\n**Checkpoint:** Consumer logs `\"click processed\"` with `event_id` and `short_code`. `psql -h localhost -p 5433 -U analyticsuser -d analyticsdb -c \"SELECT * FROM clicks LIMIT 5;\"` shows a row. `processed_events` has the `event_id`. Sending the **same** AMQP message twice (use RabbitMQ management UI to redeliver) logs `\"duplicate event skipped\"` and `clicks` count stays at 1.\n\n### Phase 3: Click Insert, Milestone Check, `MilestoneReachedEvent` Publish — One Transaction (2–2.5h)\n\n1. Complete `pgxClickStore.Insert` with `pgtype.Text` for nullable referer.\n2. Complete all remaining `pgxClickStore` methods (`CountByCode`, `CountByCodeSince`, `TopReferers`, `TimelineBuckets`).\n3. Complete `MilestoneChecker.CheckAndPublish` (full algorithm from §5.2).\n4. Add `pgxMilestoneStore.HasMilestone` and `pgxMilestoneStore.Insert` (full implementations).\n\n```bash\n# Send 10 click events for the same short_code\nfor i in $(seq 1 10); do curl -s http://localhost:8081/<short_code> > /dev/null; done\nsleep 3  # wait for outbox poller\npsql -h localhost -p 5433 -U analyticsuser -d analyticsdb \\\n  -c \"SELECT short_code, milestone, triggered_at FROM milestones;\"\n# Expect: one row with milestone=10\n# RabbitMQ management UI → notifications.events queue → should show 1 message\n```\n\n**Checkpoint:** After 10 redirects, `milestones` table has one row `(short_code=<code>, milestone=10)`. After 100 total redirects, a second row appears with `milestone=100`. Sending duplicate events does not create additional milestone rows. `MilestoneReachedEvent` appears in `notifications.events` queue (verify via RabbitMQ management UI or by checking queue depth).\n\n### Phase 4: `GET /stats/:code` and `GET /stats/:code/timeline` Handlers (1.5–2h)\n\n1. Write `handler.go`: `StatsHandler`, `NewStatsHandler`, `Stats` method, `Timeline` method.\n2. Register routes in `main.go` (already shown in §5.8).\n3. Test queries with EXPLAIN ANALYZE.\n\n```bash\n# After inserting 20+ clicks across different times and referers:\ncurl http://localhost:8082/stats/<short_code>\n# Expect: {\"short_code\":\"...\",\"total_clicks\":20,\"clicks_last_24h\":20,\"clicks_last_7d\":20,\"top_referers\":[]}\ncurl \"http://localhost:8082/stats/<short_code>/timeline?interval=day\"\n# Expect: {\"short_code\":\"...\",\"interval\":\"day\",\"points\":[{\"period\":\"2026-03-02T00:00:00Z\",\"clicks\":20}]}\ncurl \"http://localhost:8082/stats/<short_code>/timeline?interval=hour\"\n# Expect: [{...}] bucketed by hour\ncurl \"http://localhost:8082/stats/<short_code>/timeline?interval=week\"\n# Expect: 400 {\"error\":\"interval must be \\\"day\\\" or \\\"hour\\\"\"}\n```\n\n**EXPLAIN ANALYZE verification:**\n\n```bash\npsql -h localhost -p 5433 -U analyticsuser -d analyticsdb -c \"\nEXPLAIN ANALYZE\nSELECT COUNT(*) FROM clicks\nWHERE short_code = 'abc1234' AND clicked_at >= now() - interval '24 hours';\n\"\n# Must show: Index Scan using idx_clicks_short_code_time\n```\n\n**Checkpoint:** All four route variants return correct responses. EXPLAIN ANALYZE on `CountByCodeSince` shows `idx_clicks_short_code_time`. EXPLAIN ANALYZE on `TopReferers` shows `idx_clicks_referer`. `GET /health` still returns `200` regardless of RabbitMQ state.\n\n### Phase 5: Test — Duplicate `URLClickedEvent` → Click Count = 1 (1h)\n\n1. Write `analytics_test.go` covering all test cases from §9.\n2. Run unit tests (mock stores) without Docker.\n3. Run integration tests with Docker `analytics_db`.\n\n```bash\n# Unit tests (no DB needed)\ngo test ./services/analytics-service/... -run TestUnit -v\n# Integration test (requires running analytics_db)\nDATABASE_URL=\"postgres://analyticsuser:analyticspass@localhost:5433/analyticsdb\" \\\nRABBITMQ_URL=\"amqp://guest:guest@localhost:5672/\" \\\ngo test ./services/analytics-service/... -run TestIntegration -tags integration -v\n```\n\n**Checkpoint:** `TestDuplicateEventIDCountIsOne` passes: after processing the same `URLClickedEvent` twice (same `event_id`), `CountByCode` returns 1. `TestMilestoneTriggeredAtExactly10` passes. `TestPoisonMessageAcked` passes (malformed JSON → consumer continues, no nack). All unit tests green. `go test ./services/analytics-service/...` exits 0.\n\n![Idempotent Click Insert Sequence](./diagrams/tdd-diag-25.svg)\n\n```\nTest scenario: duplicate URLClickedEvent\n  event_id = \"evt-abc-123\"\n  short_code = \"xyz7890\"\n  Message 1 delivered:\n    tx.Begin()\n    dedupStore.Exists(tx, \"evt-abc-123\") → false\n    dedupStore.Insert(tx, \"evt-abc-123\")\n    clickStore.Insert(tx, ClickRecord{ShortCode:\"xyz7890\",...})\n    checker.CheckAndPublish(tx, \"xyz7890\",...)\n    tx.Commit()\n    d.Ack()\n  Message 2 delivered (same event_id, redelivered by broker):\n    tx.Begin()\n    dedupStore.Exists(tx, \"evt-abc-123\") → true   ← PRIMARY KEY hit\n    tx.Rollback()\n    d.Ack()   ← NOT Nack; duplicate is permanently consumed\n  Result:\n    clicks table: 1 row\n    processed_events: 1 row\n    CountByCode(\"xyz7890\") = 1   ✓\n```\n\n---\n\n## 9. Test Specification\n\n### 9.1 Unit Tests — `MilestoneChecker` (mock stores)\n\n```go\n// analytics_test.go\npackage analytics\nimport (\n    \"context\"\n    \"errors\"\n    \"sync/atomic\"\n    \"testing\"\n    \"time\"\n    \"github.com/jackc/pgx/v5\"\n    \"github.com/yourhandle/url-shortener/shared/events\"\n)\n// mockClickStore implements ClickRepository for testing\ntype mockClickStore struct {\n    insertFn           func(ctx context.Context, tx pgx.Tx, rec *ClickRecord) error\n    countByCodeFn      func(ctx context.Context, code string) (int64, error)\n    countByCodeSinceFn func(ctx context.Context, code string, since time.Time) (int64, error)\n    topReferersFn      func(ctx context.Context, code string, n int) ([]RefererCount, error)\n    timelineFn         func(ctx context.Context, code, unit string) ([]TimelinePoint, error)\n}\n// (implement all ClickRepository methods by delegating to Fn fields)\n// mockMilestoneStore implements MilestoneRepository for testing\ntype mockMilestoneStore struct {\n    hasMilestoneFn func(ctx context.Context, tx pgx.Tx, code string, m int) (bool, error)\n    insertFn       func(ctx context.Context, tx pgx.Tx, code string, m int) error\n}\n// mockPublisher implements AnalyticsPublisher for testing\ntype mockPublisher struct {\n    publishCount int32\n    publishErr   error\n    publishFn    func(ctx context.Context, evt *events.MilestoneReachedEvent) error\n}\nfunc (m *mockPublisher) PublishMilestone(ctx context.Context, evt *events.MilestoneReachedEvent) error {\n    atomic.AddInt32(&m.publishCount, 1)\n    if m.publishFn != nil { return m.publishFn(ctx, evt) }\n    return m.publishErr\n}\nfunc TestMilestoneChecker_NoMilestoneBelow10(t *testing.T) {\n    totalClicks := int64(9)\n    clickStore := &mockClickStore{\n        // CountByCode on tx returns 9\n    }\n    checker := NewMilestoneChecker(clickStore, &mockMilestoneStore{}, &mockPublisher{}, slog.Default())\n    // pass a mock tx that returns 9 for COUNT(*)\n    // verify publishCount == 0\n    // verify hasMilestone never called (optimization: skip check when below min threshold)\n}\nfunc TestMilestoneChecker_Threshold10Triggered(t *testing.T) {\n    publisher := &mockPublisher{}\n    milestoneStore := &mockMilestoneStore{\n        hasMilestoneFn: func(_ context.Context, _ pgx.Tx, _ string, m int) (bool, error) {\n            return false, nil // not yet recorded\n        },\n        insertFn: func(_ context.Context, _ pgx.Tx, _ string, m int) error {\n            return nil\n        },\n    }\n    // totalClicks = 10 (from mock tx COUNT query)\n    // Run CheckAndPublish\n    // Assert publisher.publishCount == 1\n    // Assert published milestone == 10\n    if publisher.publishCount != 1 {\n        t.Errorf(\"expected 1 publish, got %d\", publisher.publishCount)\n    }\n}\nfunc TestMilestoneChecker_AlreadyRecorded_NoPublish(t *testing.T) {\n    publisher := &mockPublisher{}\n    milestoneStore := &mockMilestoneStore{\n        hasMilestoneFn: func(_ context.Context, _ pgx.Tx, _ string, m int) (bool, error) {\n            return true, nil // already recorded for all thresholds\n        },\n    }\n    // totalClicks = 100; all thresholds already recorded\n    // publishCount must remain 0\n    if publisher.publishCount != 0 {\n        t.Error(\"must not publish when milestone already recorded\")\n    }\n}\nfunc TestMilestoneChecker_PublishFailureContinues(t *testing.T) {\n    // publisher returns error\n    publisher := &mockPublisher{publishErr: errors.New(\"amqp down\")}\n    milestoneStore := &mockMilestoneStore{\n        hasMilestoneFn: func(_ context.Context, _ pgx.Tx, _ string, m int) (bool, error) {\n            return false, nil\n        },\n        insertFn: func(_ context.Context, _ pgx.Tx, _ string, m int) error { return nil },\n    }\n    // totalClicks = 10\n    // CheckAndPublish must return nil (publish failure is non-fatal)\n    // err := checker.CheckAndPublish(ctx, tx, code, \"\", \"\", \"\")\n    // if err != nil { t.Errorf(\"expected nil, got %v\", err) }\n}\nfunc TestMilestoneChecker_MultipleThresholdsAtOnce(t *testing.T) {\n    // totalClicks = 1000 and no milestones recorded yet\n    // Expect: 3 publishes (10, 100, 1000) and 3 inserts\n    publisher := &mockPublisher{}\n    insertCount := 0\n    milestoneStore := &mockMilestoneStore{\n        hasMilestoneFn: func(_ context.Context, _ pgx.Tx, _ string, m int) (bool, error) {\n            return false, nil\n        },\n        insertFn: func(_ context.Context, _ pgx.Tx, _ string, m int) error {\n            insertCount++\n            return nil\n        },\n    }\n    // run with totalClicks=1000\n    if publisher.publishCount != 3 {\n        t.Errorf(\"expected 3 publishes, got %d\", publisher.publishCount)\n    }\n    if insertCount != 3 {\n        t.Errorf(\"expected 3 milestone inserts, got %d\", insertCount)\n    }\n}\n```\n\n### 9.2 Unit Tests — Consumer Idempotency and Poison Messages\n\n```go\nfunc TestProcessDelivery_DuplicateEventID_SingleClick(t *testing.T) {\n    // Integration-style test using miniredis-equivalent for DB: testcontainers or real analyticsdb\n    // 1. Create consumer with real pool (requires analytics_db running)\n    // 2. Build a valid URLClickedEvent JSON with event_id = \"dedup-test-001\"\n    // 3. Call consumer.processDelivery twice with the same event_id\n    // 4. Assert clickStore.CountByCode returns 1\n    // This is the PRIMARY acceptance criterion for M4.\n}\nfunc TestProcessDelivery_MalformedJSON_Acked(t *testing.T) {\n    // Create a mock amqp.Delivery with Body = []byte(\"not json\")\n    // Call processDelivery\n    // Assert: delivery was Acked (not Nacked)\n    // Assert: no click row inserted\n    // Implementation note: wrap amqp.Delivery to allow test inspection of Ack/Nack calls\n}\nfunc TestProcessDelivery_MissingEventID_Acked(t *testing.T) {\n    // Body = valid JSON but event_id = \"\"\n    // Assert: Acked, no click row\n}\nfunc TestProcessDelivery_MissingShortCode_Acked(t *testing.T) {\n    // Body = valid JSON but short_code = \"\"\n    // Assert: Acked, no click row\n}\nfunc TestProcessDelivery_DBError_Nacked(t *testing.T) {\n    // Mock pool.Begin to fail\n    // Assert: Nacked with requeue=true\n}\n```\n\n### 9.3 Unit Tests — `StatsHandler`\n\n```go\nfunc TestStatsHandler_Returns200WithZeros_UnknownCode(t *testing.T) {\n    store := &mockClickStore{\n        countByCodeFn:      func(_ context.Context, _ string) (int64, error) { return 0, nil },\n        countByCodeSinceFn: func(_ context.Context, _ string, _ time.Time) (int64, error) { return 0, nil },\n        topReferersFn:      func(_ context.Context, _ string, _ int) ([]RefererCount, error) { return []RefererCount{}, nil },\n    }\n    h := NewStatsHandler(store, slog.Default())\n    req := httptest.NewRequest(\"GET\", \"/stats/nonexistent\", nil)\n    req.SetPathValue(\"code\", \"nonexistent\")\n    rec := httptest.NewRecorder()\n    h.Stats(rec, req)\n    if rec.Code != 200 {\n        t.Errorf(\"expected 200, got %d\", rec.Code)\n    }\n    var resp statsResponse\n    json.Unmarshal(rec.Body.Bytes(), &resp)\n    if resp.TotalClicks != 0 { t.Error(\"total_clicks should be 0\") }\n    if resp.TopReferers == nil { t.Error(\"top_referers must be [] not null\") }\n}\nfunc TestStatsHandler_TopReferers_MaxFive(t *testing.T) {\n    store := &mockClickStore{\n        countByCodeFn:      func(_ context.Context, _ string) (int64, error) { return 100, nil },\n        countByCodeSinceFn: func(_ context.Context, _ string, _ time.Time) (int64, error) { return 50, nil },\n        topReferersFn: func(_ context.Context, _ string, n int) ([]RefererCount, error) {\n            if n != 5 { return nil, fmt.Errorf(\"expected n=5, got %d\", n) }\n            return []RefererCount{\n                {\"https://google.com\", 40},\n                {\"https://twitter.com\", 20},\n                {\"https://reddit.com\", 15},\n                {\"https://hn.algolia.com\", 10},\n                {\"https://lobste.rs\", 5},\n            }, nil\n        },\n    }\n    h := NewStatsHandler(store, slog.Default())\n    req := httptest.NewRequest(\"GET\", \"/stats/abc1234\", nil)\n    req.SetPathValue(\"code\", \"abc1234\")\n    rec := httptest.NewRecorder()\n    h.Stats(rec, req)\n    var resp statsResponse\n    json.Unmarshal(rec.Body.Bytes(), &resp)\n    if len(resp.TopReferers) != 5 {\n        t.Errorf(\"expected 5 top_referers, got %d\", len(resp.TopReferers))\n    }\n    if resp.TopReferers[0].Referer != \"https://google.com\" {\n        t.Errorf(\"first referer wrong: %q\", resp.TopReferers[0].Referer)\n    }\n}\nfunc TestStatsHandler_DBError_Returns500(t *testing.T) {\n    store := &mockClickStore{\n        countByCodeFn: func(_ context.Context, _ string) (int64, error) {\n            return 0, errors.New(\"db down\")\n        },\n        countByCodeSinceFn: func(_ context.Context, _ string, _ time.Time) (int64, error) { return 0, nil },\n        topReferersFn:      func(_ context.Context, _ string, _ int) ([]RefererCount, error) { return nil, nil },\n    }\n    h := NewStatsHandler(store, slog.Default())\n    req := httptest.NewRequest(\"GET\", \"/stats/abc1234\", nil)\n    req.SetPathValue(\"code\", \"abc1234\")\n    rec := httptest.NewRecorder()\n    h.Stats(rec, req)\n    if rec.Code != 500 { t.Errorf(\"expected 500, got %d\", rec.Code) }\n}\nfunc TestTimelineHandler_InvalidInterval_Returns400(t *testing.T) {\n    h := NewStatsHandler(&mockClickStore{}, slog.Default())\n    for _, bad := range []string{\"week\", \"month\", \"\", \"DAY\", \"Hour\"} {\n        t.Run(bad, func(t *testing.T) {\n            req := httptest.NewRequest(\"GET\", \"/stats/abc/timeline?interval=\"+bad, nil)\n            req.SetPathValue(\"code\", \"abc\")\n            rec := httptest.NewRecorder()\n            h.Timeline(rec, req)\n            if rec.Code != 400 {\n                t.Errorf(\"interval=%q: expected 400, got %d\", bad, rec.Code)\n            }\n        })\n    }\n}\nfunc TestTimelineHandler_ValidIntervals_Return200(t *testing.T) {\n    store := &mockClickStore{\n        timelineFn: func(_ context.Context, _ string, _ string) ([]TimelinePoint, error) {\n            return []TimelinePoint{}, nil\n        },\n    }\n    h := NewStatsHandler(store, slog.Default())\n    for _, good := range []string{\"day\", \"hour\"} {\n        t.Run(good, func(t *testing.T) {\n            req := httptest.NewRequest(\"GET\", \"/stats/abc/timeline?interval=\"+good, nil)\n            req.SetPathValue(\"code\", \"abc\")\n            rec := httptest.NewRecorder()\n            h.Timeline(rec, req)\n            if rec.Code != 200 {\n                t.Errorf(\"interval=%q: expected 200, got %d\", good, rec.Code)\n            }\n            var resp timelineResponse\n            json.Unmarshal(rec.Body.Bytes(), &resp)\n            if resp.Points == nil { t.Error(\"points must be [] not null\") }\n        })\n    }\n}\n```\n\n### 9.4 Integration Test — Duplicate `URLClickedEvent` → Click Count = 1 (Primary Acceptance Criterion)\n\n```go\n// +build integration\n// Run: DATABASE_URL=... RABBITMQ_URL=... go test -tags integration -run TestIntegrationDuplicate ./services/analytics-service/\nfunc TestIntegrationDuplicateEventIDCountIsOne(t *testing.T) {\n    cfg, err := loadConfig()\n    if err != nil {\n        t.Skipf(\"config not available: %v\", err)\n    }\n    pool, err := NewDBPool(context.Background(), cfg.DatabaseURL, slog.Default())\n    if err != nil { t.Fatalf(\"db: %v\", err) }\n    t.Cleanup(pool.Close)\n    if err := runMigrations(context.Background(), pool, slog.Default()); err != nil {\n        t.Fatalf(\"migrate: %v\", err)\n    }\n    clickStore     := NewClickStore(pool)\n    milestoneStore := NewMilestoneStore(pool)\n    dedupStore     := NewDeduplicationStore(pool)\n    publisher      := &mockPublisher{} // don't need real RabbitMQ for this test\n    checker        := NewMilestoneChecker(clickStore, milestoneStore, publisher, slog.Default())\n    // Unique short_code and event_id for this test run\n    testCode    := fmt.Sprintf(\"tst%d\", time.Now().UnixNano()%100000)\n    testEventID := newUUID()\n    // Build a valid URLClickedEvent payload\n    evt := events.URLClickedEvent{\n        BaseEvent: events.BaseEvent{\n            EventType:  events.EventTypeURLClicked,\n            OccurredAt: time.Now().UTC(),\n            EventID:    testEventID,\n        },\n        ShortCode: testCode,\n        IPHash:    \"aabbcc\",\n        UserAgent: \"test-agent\",\n        ClickedAt: time.Now().UTC(),\n    }\n    body, _ := json.Marshal(evt)\n    // Helper: simulate processDelivery logic directly (without real AMQP)\n    processOnce := func() error {\n        tx, err := pool.Begin(context.Background())\n        if err != nil { return err }\n        exists, err := dedupStore.Exists(context.Background(), tx, testEventID)\n        if err != nil { tx.Rollback(context.Background()); return err }\n        if exists {\n            tx.Rollback(context.Background())\n            return nil // duplicate — expected on second call\n        }\n        if err := dedupStore.Insert(context.Background(), tx, testEventID); err != nil {\n            tx.Rollback(context.Background()); return err\n        }\n        rec := &ClickRecord{\n            ShortCode: evt.ShortCode,\n            ClickedAt: evt.ClickedAt,\n            IPHash:    evt.IPHash,\n            UserAgent: evt.UserAgent,\n        }\n        if err := clickStore.Insert(context.Background(), tx, rec); err != nil {\n            tx.Rollback(context.Background()); return err\n        }\n        if err := checker.CheckAndPublish(context.Background(), tx, testCode, \"\", \"\", \"\"); err != nil {\n            tx.Rollback(context.Background()); return err\n        }\n        return tx.Commit(context.Background())\n    }\n    // Process the same event twice\n    if err := processOnce(); err != nil { t.Fatalf(\"first process: %v\", err) }\n    if err := processOnce(); err != nil { t.Fatalf(\"second process: %v\", err) }\n    // Assert click count is exactly 1\n    count, err := clickStore.CountByCode(context.Background(), testCode)\n    if err != nil { t.Fatalf(\"count: %v\", err) }\n    if count != 1 {\n        t.Errorf(\"click count after 2 identical events: got %d, want 1\", count)\n    }\n    // Assert processed_events has exactly 1 row for this event_id\n    var dedupCount int\n    pool.QueryRow(context.Background(),\n        \"SELECT COUNT(*) FROM processed_events WHERE event_id = $1\",\n        testEventID,\n    ).Scan(&dedupCount)\n    if dedupCount != 1 {\n        t.Errorf(\"processed_events count: got %d, want 1\", dedupCount)\n    }\n    _ = body // suppress unused warning\n}\nfunc TestIntegrationMilestoneAt10(t *testing.T) {\n    // Insert 10 unique URLClickedEvents for the same short_code\n    // Assert milestones table has exactly one row with milestone=10\n    // Assert CountByCode = 10\n}\nfunc TestIntegrationTopReferers(t *testing.T) {\n    // Insert 20 clicks: 10 from \"https://google.com\", 5 from \"https://twitter.com\", 5 with nil referer\n    // Call TopReferers(code, 5)\n    // Assert: 2 entries returned; google.com first with count=10\n    // Assert: nil-referer clicks NOT included\n}\nfunc TestIntegrationTimelineDay(t *testing.T) {\n    // Insert 5 clicks on 2026-03-01 and 3 clicks on 2026-03-02 (via direct INSERT with past clicked_at)\n    // Call TimelineBuckets(code, \"day\")\n    // Assert: 2 TimelinePoints returned, ordered ASC\n    // Assert: point[0].Clicks == 5, point[1].Clicks == 3\n}\n```\n\n![IP Anonymization: SHA-256 Hash with Per-Service Salt](./diagrams/tdd-diag-26.svg)\n\n```\nIntegration test: duplicate event flow\n  Test                   analytics-service              analytics_db\n  process logic                layer                      (real DB)\n      │                         │                            │\n      ├──processOnce(evt-A)─────►                            │\n      │                         ├─BEGIN─────────────────────►│\n      │                         ├─Exists(\"evt-A\")────────────►│\n      │                         │◄──false────────────────────┤\n      │                         ├─Insert(\"evt-A\")────────────►│\n      │                         ├─INSERT clicks──────────────►│\n      │                         ├─COUNT(*) clicks─────────────►│\n      │                         │◄──1────────────────────────┤\n      │                         ├─COMMIT─────────────────────►│\n      │◄──nil────────────────────┤                            │\n      │                         │                            │\n      ├──processOnce(evt-A)─────► (same event_id)            │\n      │                         ├─BEGIN─────────────────────►│\n      │                         ├─Exists(\"evt-A\")────────────►│\n      │                         │◄──true─────────────────────┤ ← PRIMARY KEY hit\n      │                         ├─ROLLBACK───────────────────►│\n      │◄──nil (no error)─────────┤                            │\n      │                         │                            │\n      ├─CountByCode()───────────►                            │\n      │                         ├─SELECT COUNT(*)────────────►│\n      │                         │◄──1────────────────────────┤\n      │◄──1──────────────────────┤                            │\n      │                         │                            │\n  assert count == 1 ✓\n```\n\n### 9.5 `pgxClickStore` Referer NULL Handling Test\n\n```go\nfunc TestClickInsert_NullReferer(t *testing.T) {\n    // Insert a ClickRecord with Referer = \"\"\n    // Verify the database stores NULL (not empty string \"\")\n    // SELECT referer FROM clicks WHERE id = inserted_id → should return NULL\n    // This ensures the partial index idx_clicks_referer filters it out correctly\n}\nfunc TestClickInsert_NonNullReferer(t *testing.T) {\n    // Insert a ClickRecord with Referer = \"https://example.com\"\n    // SELECT referer FROM clicks WHERE id = inserted_id → should return \"https://example.com\"\n    // SELECT COUNT(*) FROM clicks WHERE short_code = ? AND referer IS NOT NULL → 1\n}\n```\n\n---\n\n## 10. Performance Targets\n\n| Operation                                                                            | Target     | How to Measure                                                                                          |\n| ------------------------------------------------------------------------------------ | ---------- | ------------------------------------------------------------------------------------------------------- |\n| `URLClickedEvent` consumer processing (dedup + click insert + milestone check + ack) | < 50ms p99 | Log `duration_ms` in `processDelivery`; after processing 1000 messages, check log percentiles with `jq` |\n| `GET /stats/:code` (4 concurrent aggregation queries)                                | < 30ms p99 | `wrk -t4 -c20 -d30s http://localhost:8082/stats/<code>` → Latency 99th < 30ms                           |\n| `GET /stats/:code/timeline?interval=day`                                             | < 50ms p99 | `wrk -t4 -c20 -d30s 'http://localhost:8082/stats/<code>/timeline?interval=day'`                         |\n| `GET /stats/:code/timeline?interval=hour`                                            | < 50ms p99 | Same as day                                                                                             |\n| `GET /health`                                                                        | < 10ms p99 | `wrk -t1 -c10 -d10s http://localhost:8082/health`                                                       |\n| `CountByCode` query (1M click rows)                                                  | < 20ms     | `EXPLAIN ANALYZE SELECT COUNT(*) FROM clicks WHERE short_code = '...'` — must show Index Scan           |\n| `CountByCodeSince` query (1M rows, 24h window)                                       | < 20ms     | Same; must show Index Scan using `idx_clicks_short_code_time`                                           |\n| `TopReferers` query                                                                  | < 15ms     | `EXPLAIN ANALYZE SELECT referer, COUNT(*) ... WHERE short_code = '...' AND referer IS NOT NULL`         |\n| Consumer memory steady-state                                                         | < 30MB     | `docker stats analytics-service-1` after 30 min of load                                                 |\n| `processed_events` PRIMARY KEY lookup                                                | < 1ms      | `EXPLAIN ANALYZE SELECT EXISTS(SELECT 1 FROM processed_events WHERE event_id = '...')`                  |\n\n**EXPLAIN ANALYZE verification commands:**\n\n```bash\npsql -h localhost -p 5433 -U analyticsuser -d analyticsdb -c \"\nEXPLAIN ANALYZE\nSELECT COUNT(*) FROM clicks\nWHERE short_code = 'abc1234' AND clicked_at >= now() - interval '24 hours';\n\"\n# Must show: Index Scan using idx_clicks_short_code_time on clicks\npsql -h localhost -p 5433 -U analyticsuser -d analyticsdb -c \"\nEXPLAIN ANALYZE\nSELECT referer, COUNT(*) AS cnt\nFROM clicks\nWHERE short_code = 'abc1234' AND referer IS NOT NULL\nGROUP BY referer ORDER BY cnt DESC LIMIT 5;\n\"\n# Must show: Index Scan using idx_clicks_referer (partial index)\npsql -h localhost -p 5433 -U analyticsuser -d analyticsdb -c \"\nEXPLAIN ANALYZE\nSELECT date_trunc('day', clicked_at AT TIME ZONE 'UTC') AS period, COUNT(*) AS clicks\nFROM clicks WHERE short_code = 'abc1234'\nGROUP BY period ORDER BY period ASC;\n\"\n# May show Seq Scan if row count is low (optimizer preference); with 10k+ rows, Index Scan expected\n```\n\n**Consumer throughput logging:**\n\n```go\n// In processDelivery, add timing instrumentation:\nstart := time.Now()\n// ... all processing steps ...\nc.log.Info(\"click processed\",\n    \"event_id\",      evt.EventID,\n    \"short_code\",    evt.ShortCode,\n    \"duration_ms\",   time.Since(start).Milliseconds(),\n    \"correlation_id\", corrID,\n)\n```\n\n![Stats API Query Data Flow](./diagrams/tdd-diag-27.svg)\n\n```\nGET /stats/:code concurrency (errgroup):\n  StatsHandler.Stats\n        │\n        ├─ errgroup.WithContext(r.Context())\n        │\n        ├─ go CountByCode(gCtx, code) ──────────────────────────►\n        │                                                  analytics_db\n        ├─ go CountByCodeSince(gCtx, code, now-24h) ──────────────►\n        │                                                  (4 concurrent\n        ├─ go CountByCodeSince(gCtx, code, now-7d) ───────────────►  pool acquires)\n        │\n        ├─ go TopReferers(gCtx, code, 5) ─────────────────────────►\n        │\n        └─ g.Wait() ◄── blocks until all 4 return\n               │\n           if any error:\n               500 response\n           else:\n               200 statsResponse{...}\nPerformance: 4 queries run concurrently (~5ms each) → ~5ms total (parallelism)\n             vs sequential (~20ms) → errgroup gives ~4× speedup for this endpoint.\npgxpool.Acquire is goroutine-safe; 4 concurrent acquires from pool(MaxConns=10)\nall succeed without blocking given adequate pool size.\n```\n\n### 10.1 `go.mod` Additions for Analytics Service\n\n```\n// services/analytics-service/go.mod\nmodule github.com/yourhandle/url-shortener/analytics-service\ngo 1.23\nrequire (\n    github.com/yourhandle/url-shortener/shared/events v0.0.0\n    github.com/yourhandle/url-shortener/shared/logger v0.0.0\n    github.com/jackc/pgx/v5 v5.6.0\n    github.com/rabbitmq/amqp091-go v1.10.0\n    golang.org/x/sync v0.7.0         // for errgroup in stats handler\n)\nreplace (\n    github.com/yourhandle/url-shortener/shared/events => ../../shared/events\n    github.com/yourhandle/url-shortener/shared/logger => ../../shared/logger\n)\n```\n\nNote: `golang.org/x/sync` provides `errgroup`. Alternatively, implement the four concurrent stats queries manually with goroutines + channels; `errgroup` is cleaner.\n\n### 10.2 `docker-compose.yml` Additions\n\n```yaml\nanalytics-service:\n  environment:\n    DATABASE_URL: postgres://analyticsuser:analyticspass@analytics_db:5432/analyticsdb\n    RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/\n    IP_HASH_SALT: \"change-this-random-salt\" # same salt as url-service for consistency\n    PORT: \"8080\"\n```\n\n---\n\n## 11. Anti-Pattern Guard\n\nThe following assertions must hold before this module is considered complete:\n\n```bash\n# 1. Analytics service never connects to url_db, user_db, or notification_db\ngrep -r \"url_db\\|user_db\\|notification_db\\|5432\\|5434\\|5435\" \\\n  services/analytics-service/*.go | grep -v \"_test.go\" || echo \"PASS: no cross-DB access\"\n# 2. Analytics service never calls url-service HTTP API\ngrep -r \"url-service\\|8081\\|url_service\" \\\n  services/analytics-service/*.go | grep -v \"_test.go\" || echo \"PASS: no sync call to url-service\"\n# 3. Analytics service never stores raw IP addresses\ngrep -r \"RemoteAddr\\|r\\.RemoteAddr\" \\\n  services/analytics-service/*.go | grep -v \"haship\\|_test\" || echo \"PASS: no raw IP storage\"\n# 4. Consumer uses manual Ack (not autoAck)\ngrep \"autoAck.*false\\|false.*autoAck\" services/analytics-service/consumer.go && echo \"PASS\" \\\n  || echo \"FAIL: autoAck must be false\"\n# 5. Poison messages are Acked (not Nacked) — prevent requeue loop\ngrep -A3 \"json.Unmarshal.*err\" services/analytics-service/consumer.go | grep \"Ack\" \\\n  && echo \"PASS: poison msg acked\" || echo \"FAIL: check Ack vs Nack on parse error\"\n# 6. No fmt.Println in handlers or consumer (use structured logger)\ngrep -n \"fmt.Println\\|fmt.Printf\" services/analytics-service/*.go \\\n  | grep -v \"_test.go\" || echo \"PASS: no fmt.Println\"\n```\n\n---\n\n<!-- END_TDD_MOD -->\n\n<!-- TDD_MOD_ID: url-shortener-m5 -->\n\n# Notification Service + API Gateway + Circuit Breaker\n\n## **Module ID:** `url-shortener-m5`\n\n## 1. Module Charter\n\nThis module implements the two final infrastructure pieces that complete the system: the Notification Service and the API Gateway. The Notification Service owns the `notifications` table in `notification_db`, consumes `url.created`, `url.deleted`, and `milestone.reached` routing keys from the `notifications.events` RabbitMQ queue, persists notification rows with status tracking, logs mock email sends, and exposes `GET /notifications` with JWT verification. The API Gateway is a pure infrastructure component that provides the single client-facing entry point: it routes requests to the appropriate upstream service, verifies JWT tokens on all `/api/*` routes except `/api/auth/*`, enforces per-IP token-bucket rate limiting via Redis INCR+EXPIRE, implements a three-state circuit breaker (CLOSED → OPEN → HALF_OPEN → CLOSED) protecting the url-service proxy path, propagates `X-Correlation-ID` through all forwarded requests, and emits structured JSON logs for every request.\nThis module does **not** implement any business logic in the gateway — the gateway has no knowledge of URL records, users, clicks, or analytics. It does **not** have the notification service call any other service to look up user email addresses — all necessary context (user email, short code) is carried in the event payload itself (established in M1 `shared/events`). It does **not** implement the outbox pattern in either the notification service or the gateway. It does **not** add new domain events — it only consumes events produced by prior milestones. The circuit breaker applies only to the url-service proxy; other upstream proxies use standard error handling.\n**Upstream dependencies:** `shared/events` (event structs), `shared/auth` (JWT verification), `shared/logger` (structured JSON logger — extended in this module with `correlation_id` default field), RabbitMQ `notifications.events` queue (declared in M1), `notification_db` PostgreSQL, Redis (shared instance from M1, now used by gateway for rate limiting).\n**Downstream consumers:** End users and API clients communicate exclusively through the gateway. No service calls the notification service.\n**Invariants that must always hold:**\n\n- The gateway contains zero domain logic — no imports of `shared/events`, no URL record lookups, no analytics queries.\n- The circuit breaker state transitions are guarded by a single `sync.Mutex` — no goroutine ever reads `failures` or `lastFailure` without holding the lock.\n- Redis errors in the rate limiter cause fail-open behavior (request is allowed through) and are logged at `Warn` — they never return 5xx to the client.\n- JWT verification in the gateway is stateless local HMAC verification — the gateway never calls user-service per request.\n- The notification service consumer is a single goroutine with `prefetch=1` — no concurrent message processing occurs.\n- `notification_db` is the only database the notification service ever writes to.\n\n---\n\n## 2. File Structure\n\nCreate files in the numbered order below.\n\n```\nurl-shortener/\n│\n├── shared/\n│   └── logger/\n│       └── 1. logger.go          ← extend: WithCorrelationID helper, request logger middleware\n│\n├── services/\n│   └── notification-service/\n│       ├── (from M1)\n│       │   ├── go.mod            ← add dependencies\n│       │   ├── main.go           ← extend: wire consumer, handler, routes\n│       │   ├── config.go         ← extend: add JWTSecret field\n│       │   ├── db.go             ← unchanged\n│       │   ├── rabbitmq.go       ← unchanged (DeclareNotificationQueue from M1)\n│       │   └── health.go         ← unchanged\n│       │\n│       ├── 2.  migration.sql     ← notifications table + index\n│       ├── 3.  store.go          ← NotificationRepository interface + pgxNotificationStore\n│       ├── 4.  consumer.go       ← NotificationConsumer, Run(), processDelivery(), mockEmail()\n│       ├── 5.  handler.go        ← NotificationHandler, ListNotifications method\n│       ├── 6.  errors.go         ← writeError, writeJSON helpers\n│       └── 7.  notification_test.go ← unit + integration tests\n│\n└── gateway/\n    ├── (from M1 stub)\n    │   ├── go.mod                ← add all dependencies\n    │   ├── main.go               ← extend: full wiring\n    │   ├── config.go             ← extend: full config\n    │   ├── health.go             ← unchanged\n    │   └── Dockerfile            ← unchanged\n    │\n    ├── 8.  router.go             ← routing table, route matching, upstream selection\n    ├── 9.  proxy.go              ← ReverseProxy per upstream, request forwarding, response copy\n    ├── 10. middleware.go         ← CorrelationIDMiddleware, LoggingMiddleware, chain helper\n    ├── 11. ratelimit.go          ← RateLimiter interface, redisTokenBucket, 429 response\n    ├── 12. circuitbreaker.go     ← CircuitBreaker struct, state machine, Do() method\n    ├── 13. jwtmiddleware.go      ← gateway-local JWT middleware (wraps shared/auth)\n    └── 14. gateway_test.go       ← circuit breaker, rate limiter, routing, integration tests\n```\n\n---\n\n## 3. Complete Data Model\n\n### 3.1 PostgreSQL Schema — Notification Service (`migration.sql`)\n\n```sql\n-- ── notifications table ───────────────────────────────────────────────────────\nCREATE TABLE IF NOT EXISTS notifications (\n    id         UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id    UUID        NOT NULL,\n    event_type TEXT        NOT NULL,   -- routing key: \"url.created\" | \"url.deleted\" | \"milestone.reached\"\n    payload    JSONB       NOT NULL,   -- full event JSON for audit; never queried for filtering\n    status     TEXT        NOT NULL DEFAULT 'sent',  -- \"pending\" | \"sent\" | \"failed\"\n    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n    sent_at    TIMESTAMPTZ NULL        -- set when mock email is logged; NULL if pending/failed\n);\n-- Primary query: caller's notifications newest-first, for GET /notifications pagination.\nCREATE INDEX IF NOT EXISTS idx_notifications_user_created\n    ON notifications(user_id, created_at DESC);\n```\n\n**Column rationale:**\n\n| Column | Type | Constraint | Rationale |\n|---|---|---|---|\n| `id` | UUID | PK | Non-enumerable row identity |\n| `user_id` | UUID | NOT NULL | Extracted from event payload; used to filter GET /notifications results |\n| `event_type` | TEXT | NOT NULL | Routing key literal; displayed in API response and logs |\n| `payload` | JSONB | NOT NULL | Full event JSON for audit trail; allows replaying notifications without re-querying upstream |\n| `status` | TEXT | NOT NULL DEFAULT 'sent' | Tracks notification delivery state; `sent` immediately after mock email log |\n| `created_at` | TIMESTAMPTZ | NOT NULL | Cursor key for pagination; matches `idx_notifications_user_created` |\n| `sent_at` | TIMESTAMPTZ | NULL | Set when `mockEmail()` completes; NULL for failed or pending rows |\n**Status lifecycle:** In this implementation, all notifications immediately transition `pending → sent` in a single handler call (mock email = log line). The `status` column and `sent_at` column exist to support real email integration without schema changes.\n\n### 3.2 Go Structs — Notification Service\n\n```go\n// store.go\npackage notification\nimport \"time\"\n// NotificationRecord maps to one row in the notifications table.\ntype NotificationRecord struct {\n    ID        string     // UUID string\n    UserID    string     // UUID string; extracted from event payload\n    EventType string     // routing key literal\n    Payload   []byte     // raw JSONB bytes (the full event JSON)\n    Status    string     // \"pending\" | \"sent\" | \"failed\"\n    CreatedAt time.Time\n    SentAt    *time.Time // nil if pending/failed\n}\n// NotificationRepository abstracts all DB operations on the notifications table.\ntype NotificationRepository interface {\n    // Insert creates a new notification row.\n    // rec.Status must be \"pending\" on input; implementation sets it to \"sent\" and\n    // populates SentAt after the mock email log succeeds.\n    // Both the insert and the status update occur in a single transaction.\n    Insert(ctx context.Context, rec *NotificationRecord) (*NotificationRecord, error)\n    // FindByUserID returns paginated notifications for a user, newest-first.\n    // afterID is the cursor UUID; empty string = first page.\n    // limit is the page size (default 20, max 50).\n    // Returns ([]*NotificationRecord, nextCursorID string, error).\n    FindByUserID(ctx context.Context, userID, afterID string, limit int) ([]*NotificationRecord, string, error)\n}\n```\n\n```go\n// config.go (extended from M1)\npackage notification\nimport (\n    \"fmt\"\n    \"os\"\n)\ntype Config struct {\n    DatabaseURL string // required; fatal if empty\n    RabbitMQURL string // required; fatal if empty\n    Port        string // default \"8080\"\n    ServiceName string // constant \"notification-service\"\n    JWTSecret   string // required; must match JWT_SECRET across all services\n}\nfunc loadConfig() (*Config, error) {\n    cfg := &Config{\n        DatabaseURL: os.Getenv(\"DATABASE_URL\"),\n        RabbitMQURL: os.Getenv(\"RABBITMQ_URL\"),\n        JWTSecret:   os.Getenv(\"JWT_SECRET\"),\n        Port:        envOrDefault(\"PORT\", \"8080\"),\n        ServiceName: \"notification-service\",\n    }\n    if cfg.DatabaseURL == \"\" {\n        return nil, fmt.Errorf(\"DATABASE_URL is required\")\n    }\n    if cfg.RabbitMQURL == \"\" {\n        return nil, fmt.Errorf(\"RABBITMQ_URL is required\")\n    }\n    if cfg.JWTSecret == \"\" {\n        return nil, fmt.Errorf(\"JWT_SECRET is required\")\n    }\n    return cfg, nil\n}\n```\n\n### 3.3 HTTP Response Schema — Notification Service\n\n```go\n// handler.go\npackage notification\ntype notificationItem struct {\n    ID        string  `json:\"id\"`\n    EventType string  `json:\"event_type\"`\n    Payload   any     `json:\"payload\"`    // re-decoded from JSONB for JSON embedding\n    Status    string  `json:\"status\"`\n    CreatedAt string  `json:\"created_at\"` // RFC3339\n    SentAt    *string `json:\"sent_at,omitempty\"` // RFC3339 or absent\n}\ntype notificationListResponse struct {\n    Notifications []notificationItem `json:\"notifications\"` // always array, never null\n    NextCursor    *string            `json:\"next_cursor\"`   // null if no more pages\n}\n```\n\n### 3.4 Go Structs — Gateway\n\n```go\n// router.go\npackage gateway\nimport \"net/http\"\n// Route describes one entry in the routing table.\n// The gateway matches incoming requests against all routes and selects the first match.\ntype Route struct {\n    Method        string   // HTTP method, or \"\" to match any method\n    PathPrefix    string   // matched with strings.HasPrefix against r.URL.Path\n    Upstream      string   // config key: \"url-service\" | \"analytics-service\" | \"user-service\" | \"notification-service\"\n    StripPrefix   string   // strip this prefix before forwarding (e.g., \"/api\" stripped, \"/shorten\" left)\n    RequiresAuth  bool     // true = JWT required; false = public\n    RateLimitKey  string   // \"\" = no rate limit; \"shorten\" | \"redirect\" = apply named limit\n}\n```\n\n```go\n// circuitbreaker.go\npackage gateway\nimport (\n    \"sync\"\n    \"time\"\n)\n// State represents the circuit breaker's current state.\ntype State int\nconst (\n    StateClosed   State = iota // normal operation; requests pass through\n    StateOpen                  // tripped; requests fail immediately with 503\n    StateHalfOpen              // probe mode; one request allowed through to test upstream\n)\nfunc (s State) String() string {\n    switch s {\n    case StateClosed:   return \"CLOSED\"\n    case StateOpen:     return \"OPEN\"\n    case StateHalfOpen: return \"HALF_OPEN\"\n    default:            return \"UNKNOWN\"\n    }\n}\n// CircuitBreaker implements a three-state circuit breaker protecting one upstream.\n// All state is protected by mu. Do not embed State in other structs without this protection.\ntype CircuitBreaker struct {\n    mu              sync.Mutex\n    state           State\n    failures        int       // consecutive failure count (reset on success in CLOSED)\n    lastFailureTime time.Time // time of most recent failure; drives OPEN→HALF_OPEN timeout\n    // Configuration (immutable after construction):\n    maxFailures     int           // failures to trip: default 5\n    openTimeout     time.Duration // how long to stay OPEN before probing: default 30s\n    failureWindow   time.Duration // window in which failures are counted: default 10s\n    windowStart     time.Time     // when current failure window began\n}\n```\n\n```go\n// ratelimit.go\npackage gateway\nimport \"context\"\n// RateLimiter abstracts the rate limiting strategy.\n// Implementation uses Redis INCR + EXPIRE for shared state across gateway replicas.\ntype RateLimiter interface {\n    // Allow checks whether the given key has capacity remaining.\n    // key is typically \"rl:{route_key}:{ip}\" e.g. \"rl:shorten:192.168.1.1\"\n    // limit is the maximum requests per window.\n    // windowSecs is the window duration in seconds (EXPIRE value).\n    //\n    // Returns:\n    //   allowed bool   - true if request should proceed; false if 429 should be returned\n    //   retryAfter int - seconds until the window resets (used in Retry-After header)\n    //   err error      - non-nil only on infrastructure failure (Redis down); caller logs + allows\n    Allow(ctx context.Context, key string, limit int, windowSecs int) (allowed bool, retryAfter int, err error)\n}\n```\n\n```go\n// config.go (gateway, extended from M1 stub)\npackage gateway\nimport (\n    \"fmt\"\n    \"os\"\n    \"time\"\n)\n// RateLimitConfig holds one named rate limit policy.\ntype RateLimitConfig struct {\n    Limit      int // requests per window\n    WindowSecs int // window duration in seconds\n}\ntype Config struct {\n    URLServiceURL          string // required\n    AnalyticsServiceURL    string // required\n    UserServiceURL         string // required\n    NotificationServiceURL string // required\n    RedisURL               string // required (rate limit store)\n    JWTSecret              string // required (local verification)\n    Port                   string // default \"8080\"\n    ServiceName            string // constant \"gateway\"\n    // Circuit breaker settings for url-service:\n    CBMaxFailures   int           // default 5\n    CBOpenTimeout   time.Duration // default 30s\n    CBFailureWindow time.Duration // default 10s\n    // Rate limit policies (keyed by route identifier):\n    RateLimits map[string]RateLimitConfig\n    // Populated at loadConfig() as:\n    //   \"shorten\":  {Limit: 10, WindowSecs: 60}\n    //   \"redirect\": {Limit: 300, WindowSecs: 60}\n}\nfunc loadConfig() (*Config, error) {\n    cfg := &Config{\n        URLServiceURL:          os.Getenv(\"URL_SERVICE_URL\"),\n        AnalyticsServiceURL:    os.Getenv(\"ANALYTICS_SERVICE_URL\"),\n        UserServiceURL:         os.Getenv(\"USER_SERVICE_URL\"),\n        NotificationServiceURL: os.Getenv(\"NOTIFICATION_SERVICE_URL\"),\n        RedisURL:               os.Getenv(\"REDIS_URL\"),\n        JWTSecret:              os.Getenv(\"JWT_SECRET\"),\n        Port:                   envOrDefault(\"PORT\", \"8080\"),\n        ServiceName:            \"gateway\",\n        CBMaxFailures:          5,\n        CBOpenTimeout:          30 * time.Second,\n        CBFailureWindow:        10 * time.Second,\n        RateLimits: map[string]RateLimitConfig{\n            \"shorten\":  {Limit: 10, WindowSecs: 60},\n            \"redirect\": {Limit: 300, WindowSecs: 60},\n        },\n    }\n    required := map[string]string{\n        \"URL_SERVICE_URL\":          cfg.URLServiceURL,\n        \"ANALYTICS_SERVICE_URL\":    cfg.AnalyticsServiceURL,\n        \"USER_SERVICE_URL\":         cfg.UserServiceURL,\n        \"NOTIFICATION_SERVICE_URL\": cfg.NotificationServiceURL,\n        \"REDIS_URL\":                cfg.RedisURL,\n        \"JWT_SECRET\":               cfg.JWTSecret,\n    }\n    for k, v := range required {\n        if v == \"\" {\n            return nil, fmt.Errorf(\"%s is required\", k)\n        }\n    }\n    return cfg, nil\n}\nfunc envOrDefault(key, def string) string {\n    if v := os.Getenv(key); v != \"\" {\n        return v\n    }\n    return def\n}\n```\n\n### 3.5 Routing Table (Immutable After Construction)\n\n```go\n// router.go — constructed once in main.go and never mutated\nvar routingTable = []Route{\n    // Auth routes — no JWT required\n    {Method: \"POST\", PathPrefix: \"/api/auth/register\", Upstream: \"user-service\",         RequiresAuth: false},\n    {Method: \"POST\", PathPrefix: \"/api/auth/login\",    Upstream: \"user-service\",         RequiresAuth: false},\n    // URL service routes — auth required\n    {Method: \"POST\", PathPrefix: \"/api/shorten\",       Upstream: \"url-service\",          RequiresAuth: true,  RateLimitKey: \"shorten\",  StripPrefix: \"/api\"},\n    {Method: \"GET\",  PathPrefix: \"/api/urls\",          Upstream: \"url-service\",          RequiresAuth: true,  StripPrefix: \"/api\"},\n    {Method: \"DELETE\",PathPrefix:\"/api/urls/\",         Upstream: \"url-service\",          RequiresAuth: true,  StripPrefix: \"/api\"},\n    // Redirect — no auth, rate limited\n    {Method: \"GET\",  PathPrefix: \"/r/\",               Upstream: \"url-service\",          RequiresAuth: false, RateLimitKey: \"redirect\"},\n    // Analytics — no auth\n    {Method: \"GET\",  PathPrefix: \"/api/stats/\",        Upstream: \"analytics-service\",    RequiresAuth: false, StripPrefix: \"/api\"},\n    // Notifications — auth required\n    {Method: \"GET\",  PathPrefix: \"/api/notifications\", Upstream: \"notification-service\", RequiresAuth: true,  StripPrefix: \"/api\"},\n}\n```\n\n**Path rewriting rule:** When `StripPrefix` is non-empty, remove that prefix from `r.URL.Path` before forwarding. Example: `GET /api/shorten` → url-service receives `GET /shorten`. `GET /r/abc1234` → url-service receives `GET /r/abc1234` (no strip). `GET /api/stats/abc1234` → analytics-service receives `GET /stats/abc1234`.\n**Redirect path rewrite:** url-service internally handles `GET /{code}` (7-char codes). The gateway exposes `GET /r/{code}` and rewrites to `GET /{code}`:\n\n```go\n// In proxy forwarding for redirect route: strip \"/r\" prefix\n// /r/abc1234 → /abc1234\n```\n\n![API Gateway Middleware Stack and Request Pipeline](./diagrams/tdd-diag-28.svg)\n\n```\nGateway routing table (prefix matching, first match wins):\n  Incoming path                         → Upstream service      → Forwarded path\n  ─────────────────────────────────────────────────────────────────────────────\n  POST /api/auth/register               → user-service         → /register\n  POST /api/auth/login                  → user-service         → /login\n  POST /api/shorten         [auth+rl]   → url-service          → /shorten\n  GET  /api/urls            [auth]      → url-service          → /urls\n  DELETE /api/urls/*        [auth]      → url-service          → /urls/*\n  GET  /r/*                 [rl]        → url-service          → /*\n  GET  /api/stats/*                     → analytics-service    → /stats/*\n  GET  /api/notifications   [auth]      → notification-service → /notifications\n  GET  /health                          → gateway itself       → (no proxy)\n  * anything else                       → 404\n  [auth] = JWT middleware applied\n  [rl]   = rate limiter applied\n```\n\n### 3.6 Extended `shared/logger` Package\n\n```go\n// shared/logger/logger.go (extended)\npackage logger\nimport (\n    \"context\"\n    \"log/slog\"\n    \"net/http\"\n    \"os\"\n    \"time\"\n)\ntype correlationKey struct{}\n// New returns a *slog.Logger writing JSON to stdout with \"service\" pre-attached.\nfunc New(serviceName string) *slog.Logger {\n    h := slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{Level: slog.LevelInfo})\n    return slog.New(h).With(\"service\", serviceName)\n}\n// WithCorrelationID returns a derived logger with \"correlation_id\" attached.\n// Used in handlers to bind the correlation ID to all log lines for a request.\nfunc WithCorrelationID(log *slog.Logger, correlationID string) *slog.Logger {\n    return log.With(\"correlation_id\", correlationID)\n}\n// CorrelationIDFromContext retrieves the correlation ID stored by CorrelationIDMiddleware.\n// Returns \"\" if not set.\nfunc CorrelationIDFromContext(ctx context.Context) string {\n    if id, ok := ctx.Value(correlationKey{}).(string); ok {\n        return id\n    }\n    return \"\"\n}\n// ContextWithCorrelationID stores a correlation ID into a context.\nfunc ContextWithCorrelationID(ctx context.Context, id string) context.Context {\n    return context.WithValue(ctx, correlationKey{}, id)\n}\n// RequestLogger returns middleware that logs each HTTP request as a structured JSON line.\n// Emits: time, level, service, correlation_id, method, path, status, duration_ms, msg=\"request\"\n// Applied at the outermost layer in the gateway; inner services apply it similarly.\nfunc RequestLogger(log *slog.Logger) func(http.Handler) http.Handler {\n    return func(next http.Handler) http.Handler {\n        return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n            start := time.Now()\n            corrID := CorrelationIDFromContext(r.Context())\n            rw := &responseWriter{ResponseWriter: w, status: http.StatusOK}\n            next.ServeHTTP(rw, r)\n            log.Info(\"request\",\n                \"correlation_id\", corrID,\n                \"method\",         r.Method,\n                \"path\",           r.URL.Path,\n                \"status\",         rw.status,\n                \"duration_ms\",    time.Since(start).Milliseconds(),\n            )\n        })\n    }\n}\n// responseWriter wraps http.ResponseWriter to capture the status code.\ntype responseWriter struct {\n    http.ResponseWriter\n    status int\n}\nfunc (rw *responseWriter) WriteHeader(status int) {\n    rw.status = status\n    rw.ResponseWriter.WriteHeader(status)\n}\n```\n\n---\n\n## 4. Interface Contracts\n\n### 4.1 `NotificationRepository` — `pgxNotificationStore` Implementation\n\n```go\n// store.go\ntype pgxNotificationStore struct {\n    pool *pgxpool.Pool\n}\nfunc NewNotificationStore(pool *pgxpool.Pool) NotificationRepository {\n    return &pgxNotificationStore{pool: pool}\n}\n```\n\n**`Insert(ctx context.Context, rec *NotificationRecord) (*NotificationRecord, error)`**\n\n```\nInput:  rec.UserID, rec.EventType, rec.Payload, rec.Status=\"pending\"\n        (rec.ID, rec.CreatedAt, rec.SentAt are populated by DB / function)\nAlgorithm:\n  tx, err := s.pool.Begin(ctx)\n  if err: return nil, fmt.Errorf(\"begin notification tx: %w\", err)\n  Step 1: INSERT with status=\"pending\"\n    SQL:\n      INSERT INTO notifications (user_id, event_type, payload, status)\n      VALUES ($1, $2, $3, 'pending')\n      RETURNING id, user_id, event_type, payload, status, created_at, sent_at\n    Params: rec.UserID, rec.EventType, rec.Payload\n  Step 2: Call mockEmail(rec) — log the mock send\n    // mockEmail logs: log.Info(\"would send email to <user>: <message>\")\n    // Always succeeds (no real network call)\n  Step 3: UPDATE status to \"sent\", set sent_at = now()\n    SQL:\n      UPDATE notifications\n      SET status = 'sent', sent_at = now()\n      WHERE id = $1\n      RETURNING sent_at\n    Param: inserted.ID\n  Step 4: COMMIT\n    if err: tx.Rollback(ctx); return nil, fmt.Errorf(\"commit notification tx: %w\", err)\n  Step 5: Return populated *NotificationRecord (all fields from RETURNING + updated SentAt)\nOn any INSERT error:\n  tx.Rollback(ctx)\n  return nil, fmt.Errorf(\"insert notification: %w\", err)\nOn UPDATE error:\n  tx.Rollback(ctx)\n  return nil, fmt.Errorf(\"update notification status: %w\", err)\n```\n\n**`FindByUserID(ctx context.Context, userID, afterID string, limit int) ([]*NotificationRecord, string, error)`**\n\n```\nCursor-based pagination — same pattern as url-service GET /urls.\nDefault limit: 20. Max enforced by caller.\nWhen afterID == \"\":\n  SQL:\n    SELECT id, user_id, event_type, payload, status, created_at, sent_at\n    FROM notifications\n    WHERE user_id = $1\n    ORDER BY created_at DESC, id DESC\n    LIMIT $2\n  Params: userID, limit+1\nWhen afterID != \"\":\n  SQL:\n    SELECT id, user_id, event_type, payload, status, created_at, sent_at\n    FROM notifications\n    WHERE user_id = $1\n      AND (created_at, id) < (\n          SELECT created_at, id FROM notifications WHERE id = $2\n      )\n    ORDER BY created_at DESC, id DESC\n    LIMIT $3\n  Params: userID, afterID, limit+1\nNext-cursor logic:\n  Fetch limit+1 rows.\n  If len(rows) == limit+1: nextCursor = rows[limit].ID; return rows[:limit]\n  Else: nextCursor = \"\"; return all rows\nOn success: ([]*NotificationRecord, nextCursor string, nil)\nOn error:   nil, \"\", fmt.Errorf(\"find notifications by user: %w\", err)\n```\n\n### 4.2 `NotificationConsumer`\n\n```go\n// consumer.go\ntype NotificationConsumer struct {\n    conn  *RabbitMQConn\n    pool  *pgxpool.Pool\n    store NotificationRepository\n    log   *slog.Logger\n}\nfunc NewNotificationConsumer(\n    conn  *RabbitMQConn,\n    pool  *pgxpool.Pool,\n    store NotificationRepository,\n    log   *slog.Logger,\n) *NotificationConsumer\n// Run starts the consumer loop. Blocks until ctx is Done.\nfunc (c *NotificationConsumer) Run(ctx context.Context)\n```\n\n**`Run(ctx context.Context)` — full algorithm:**\n\n```\nStep 1: Set QoS prefetch\n  c.conn.Channel.Qos(1, 0, false)\n  On error: log.Error + os.Exit(1)\nStep 2: Consume from \"notifications.events\"\n  msgs, err := c.conn.Channel.Consume(\n      \"notifications.events\",\n      \"\",     // auto consumer tag\n      false,  // autoAck = false\n      false, false, false, nil,\n  )\n  On error: log.Error + os.Exit(1)\nStep 3: Message loop\n  for:\n    select:\n    case <-ctx.Done(): log.Info(\"notification consumer stopped\"); return\n    case d, ok := <-msgs:\n      if !ok:\n        log.Warn(\"notification amqp channel closed\")\n        <-ctx.Done()\n        return\n      c.processDelivery(ctx, d)\n```\n\n**`processDelivery(ctx context.Context, d amqp.Delivery)` — full algorithm:**\n\n```\nStep 1: Panic recovery\n  defer func() {\n    if r := recover(); r != nil:\n      log.Error(\"notification consumer panic\", \"panic\", fmt.Sprintf(\"%v\", r))\n      d.Ack(false)\n  }()\nStep 2: Determine event type from routing key\n  eventType := d.RoutingKey\n  if eventType is not one of {\"url.created\",\"url.deleted\",\"milestone.reached\"}:\n    log.Warn(\"unknown routing key\", \"key\", eventType)\n    d.Ack(false); return\nStep 3: Extract user_id and user_email from payload\n  // Route-specific unmarshaling to extract user context without calling other services.\n  var userID, userEmail, message string\n  switch eventType:\n  case \"url.created\":\n    var evt events.URLCreatedEvent\n    if err := json.Unmarshal(d.Body, &evt); err != nil:\n      log.Error(\"poison: unmarshal URLCreatedEvent\", \"error\", err,\n                \"body_preview\", truncate(d.Body, 200))\n      d.Ack(false); return\n    userID    = evt.UserID\n    userEmail = evt.UserEmail\n    message   = fmt.Sprintf(\"Your short URL %s has been created for %s\", evt.ShortCode, evt.OriginalURL)\n    correlationID = evt.CorrelationID\n  case \"url.deleted\":\n    var evt events.URLDeletedEvent\n    if err := json.Unmarshal(d.Body, &evt); err != nil:\n      log.Error(\"poison: unmarshal URLDeletedEvent\", ...)\n      d.Ack(false); return\n    userID    = evt.UserID\n    userEmail = evt.UserEmail\n    message   = fmt.Sprintf(\"Your short URL %s has been deactivated\", evt.ShortCode)\n    correlationID = evt.CorrelationID\n  case \"milestone.reached\":\n    var evt events.MilestoneReachedEvent\n    if err := json.Unmarshal(d.Body, &evt); err != nil:\n      log.Error(\"poison: unmarshal MilestoneReachedEvent\", ...)\n      d.Ack(false); return\n    userID    = evt.UserID\n    userEmail = evt.UserEmail\n    message   = fmt.Sprintf(\"Your short URL %s has reached %d clicks!\", evt.ShortCode, evt.MilestoneN)\n    correlationID = evt.CorrelationID\nStep 4: Validate required fields\n  if userID == \"\":\n    log.Error(\"notification: missing user_id in event\", \"event_type\", eventType)\n    d.Ack(false); return\n  // userEmail may be \"\" for milestone events from incomplete event payloads; proceed\nStep 5: Build and insert notification record\n  rec := &NotificationRecord{\n    UserID:    userID,\n    EventType: eventType,\n    Payload:   d.Body,\n    Status:    \"pending\",\n  }\n  saved, err := c.store.Insert(ctx, rec)\n  if err != nil:\n    log.Error(\"notification insert failed\", \"error\", err, \"event_type\", eventType)\n    d.Nack(false, true)  // requeue for retry\n    return\nStep 6: Mock email log\n  // mockEmail is called inside store.Insert before commit.\n  // Log here as confirmation with correlation_id for trace:\n  log.Info(\"would send email to user\",\n    \"user_id\",        userID,\n    \"user_email\",     userEmail,\n    \"message\",        message,\n    \"notification_id\",saved.ID,\n    \"correlation_id\", correlationID,\n  )\nStep 7: Acknowledge\n  d.Ack(false)\n  log.Info(\"notification processed\",\n    \"notification_id\", saved.ID,\n    \"event_type\",      eventType,\n    \"correlation_id\",  correlationID,\n  )\n```\n\n### 4.3 `NotificationHandler`\n\n```go\n// handler.go\ntype NotificationHandler struct {\n    store NotificationRepository\n    log   *slog.Logger\n}\nfunc NewNotificationHandler(store NotificationRepository, log *slog.Logger) *NotificationHandler\n// ListNotifications handles GET /notifications.\n// Requires JWT. Returns caller's notifications, newest-first, paginated.\n// Query params: after=<uuid> (cursor), limit=<int> (default 20, max 50)\nfunc (h *NotificationHandler) ListNotifications(w http.ResponseWriter, r *http.Request)\n```\n\n**`ListNotifications` Algorithm:**\n\n```\nStep 1: Extract claims\n  claims, ok := auth.ClaimsFromContext(r.Context())\n  if !ok: writeError(w, 401, \"unauthorized\"); return\nStep 2: Parse query params\n  afterID := r.URL.Query().Get(\"after\")\n  limit   := 20\n  if limitStr := r.URL.Query().Get(\"limit\"); limitStr != \"\":\n    n, err := strconv.Atoi(limitStr)\n    if err != nil || n < 1 || n > 50:\n      writeError(w, 400, \"limit must be integer 1-50\"); return\n    limit = n\nStep 3: Fetch notifications\n  recs, nextCursor, err := h.store.FindByUserID(r.Context(), claims.Sub, afterID, limit)\n  if err != nil:\n    h.log.Error(\"find notifications failed\", \"error\", err, \"user_id\", claims.Sub)\n    writeError(w, 500, \"internal server error\"); return\nStep 4: Build response items\n  items := make([]notificationItem, 0, len(recs))\n  for _, rec := range recs:\n    var rawPayload any\n    json.Unmarshal(rec.Payload, &rawPayload)  // re-hydrate JSONB for embedding\n    item := notificationItem{\n      ID:        rec.ID,\n      EventType: rec.EventType,\n      Payload:   rawPayload,\n      Status:    rec.Status,\n      CreatedAt: rec.CreatedAt.UTC().Format(time.RFC3339),\n    }\n    if rec.SentAt != nil:\n      s := rec.SentAt.UTC().Format(time.RFC3339)\n      item.SentAt = &s\n    items = append(items, item)\nStep 5: Build next_cursor pointer\n  var nextCursorPtr *string\n  if nextCursor != \"\":\n    nextCursorPtr = &nextCursor\nStep 6: Write response\n  writeJSON(w, 200, notificationListResponse{\n    Notifications: items,\n    NextCursor:    nextCursorPtr,\n  })\n```\n\n### 4.4 `CircuitBreaker`\n\n```go\n// circuitbreaker.go\n// NewCircuitBreaker constructs a CircuitBreaker with explicit configuration.\nfunc NewCircuitBreaker(maxFailures int, openTimeout, failureWindow time.Duration) *CircuitBreaker {\n    return &CircuitBreaker{\n        state:           StateClosed,\n        maxFailures:     maxFailures,\n        openTimeout:     openTimeout,\n        failureWindow:   failureWindow,\n        windowStart:     time.Now(),\n    }\n}\n```\n\n**`Do(ctx context.Context, upstream func() error) error`**\nThis is the primary entry point. The gateway calls `cb.Do(ctx, func() error { return proxy.forward(req, resp) })`.\n\n```\nfunc (cb *CircuitBreaker) Do(ctx context.Context, upstream func() error) error:\nStep 1: Acquire lock and evaluate state\n  cb.mu.Lock()\n  switch cb.state:\n  case StateOpen:\n    // Check if openTimeout has elapsed since last failure\n    if time.Since(cb.lastFailureTime) >= cb.openTimeout:\n      cb.state = StateHalfOpen\n      cb.mu.Unlock()\n      // fall through to execute probe request (StateHalfOpen case)\n    else:\n      cb.mu.Unlock()\n      return ErrCircuitOpen  // 503 immediately, no upstream call\n  case StateHalfOpen:\n    // Allow exactly one probe request through.\n    // Do NOT release any other concurrent requests — they would see StateHalfOpen\n    // and spin-wait or fail. With net/http single-request model, this is safe:\n    // set state to something that blocks others.\n    // Simple approach: transition to StateClosed optimistically; rollback on failure.\n    // This is acceptable for single-gateway, low concurrency probe scenarios.\n    cb.mu.Unlock()\n    // execute probe below\n  case StateClosed:\n    // Reset failure window if window has expired\n    if time.Since(cb.windowStart) > cb.failureWindow:\n      cb.failures    = 0\n      cb.windowStart = time.Now()\n    cb.mu.Unlock()\n    // execute request below\nStep 2: Execute upstream function\n  err := upstream()\nStep 3: Record outcome\n  cb.mu.Lock()\n  defer cb.mu.Unlock()\n  if err == nil:\n    // Success\n    if cb.state == StateHalfOpen:\n      cb.state    = StateClosed\n      cb.failures = 0\n      cb.log.Info(\"circuit breaker CLOSED (probe succeeded)\")\n    else if cb.state == StateClosed:\n      cb.failures = 0  // reset consecutive failures on success\n    return nil\n  // Failure\n  cb.lastFailureTime = time.Now()\n  if cb.state == StateHalfOpen:\n    cb.state = StateOpen\n    cb.log.Warn(\"circuit breaker OPEN (probe failed)\")\n    return err\n  // StateClosed failure\n  cb.failures++\n  if cb.failures >= cb.maxFailures:\n    cb.state       = StateOpen\n    cb.windowStart = time.Now()  // reset window for next open period\n    cb.log.Warn(\"circuit breaker OPEN\",\n      \"failures\", cb.failures,\n      \"max_failures\", cb.maxFailures,\n    )\n  return err\n// ErrCircuitOpen is returned when the breaker is open and rejects the request.\nvar ErrCircuitOpen = errors.New(\"circuit breaker open\")\n```\n\n**What counts as a failure:** The `upstream` function passed to `Do` must return a non-nil error on any of the following conditions from the proxied response:\n\n- HTTP 5xx response from upstream (500, 502, 503, 504)\n- Network timeout or connection refused\n- Context deadline exceeded\n  HTTP 4xx responses (400, 401, 403, 404, 422, 429) are **not** failures — they indicate the upstream is healthy and responding correctly.\n\n![Circuit Breaker State Machine](./diagrams/tdd-diag-29.svg)\n\n```\nCircuit breaker state machine:\n  ┌─────────────────────────────────────────────────────────────┐\n  │                                                             │\n  │    ┌──────────┐                                            │\n  │    │  CLOSED  │◄─────────────────────────────────────┐    │\n  │    │ (normal) │                                       │    │\n  │    └────┬─────┘                                       │    │\n  │         │                                             │    │\n  │   failures >= maxFailures                     probe success │\n  │   within failureWindow (10s)                         │    │\n  │         │                                             │    │\n  │         ▼                                             │    │\n  │    ┌──────────┐   openTimeout (30s) elapsed    ┌──────┴───┐│\n  │    │   OPEN   │─────────────────────────────►  │HALF_OPEN ││\n  │    │  (trip)  │                                │ (probe)  ││\n  │    └──────────┘                                └──────────┘│\n  │         ▲                                             │    │\n  │         └─────────────── probe failure ───────────────┘    │\n  │                                                             │\n  │  CLOSED:    requests pass through; failures counted         │\n  │  OPEN:      requests rejected immediately → 503             │\n  │  HALF_OPEN: one probe request allowed; success→CLOSED,      │\n  │             failure→OPEN                                    │\n  └─────────────────────────────────────────────────────────────┘\n  Configuration: maxFailures=5, failureWindow=10s, openTimeout=30s\n  All state transitions guarded by sync.Mutex.\n  ILLEGAL transitions: CLOSED→HALF_OPEN, OPEN→CLOSED (must go through HALF_OPEN)\n```\n\n### 4.5 `RateLimiter` — `redisTokenBucket` Implementation\n\n```go\n// ratelimit.go\ntype redisTokenBucket struct {\n    client *redis.Client\n    log    *slog.Logger\n}\nfunc NewRateLimiter(client *redis.Client, log *slog.Logger) RateLimiter {\n    return &redisTokenBucket{client: client, log: log}\n}\n```\n\n**`Allow(ctx context.Context, key string, limit int, windowSecs int) (bool, int, error)`**\n\n```\nAlgorithm — uses two-command Redis pipeline (INCR + EXPIRE):\nStep 1: Build Redis key\n  redisKey := \"rl:\" + key   // e.g. \"rl:shorten:192.168.1.1\"\nStep 2: INCR the counter (creates key with value 1 if absent)\n  count, err := c.client.Incr(ctx, redisKey).Result()\n  if err != nil:\n    c.log.Warn(\"rate limit redis incr failed\", \"key\", redisKey, \"error\", err)\n    return true, 0, err  // fail-open: allow the request\nStep 3: Set expiry only on the first increment (count == 1)\n  // Setting EXPIRE on every request would reset the window on each hit.\n  // Setting only on count==1 means the window starts with the first request\n  // and expires exactly windowSecs later. Subsequent requests in the window\n  // increment but do not reset the expiry.\n  if count == 1:\n    expireErr := c.client.Expire(ctx, redisKey, time.Duration(windowSecs)*time.Second).Err()\n    if expireErr != nil:\n      c.log.Warn(\"rate limit redis expire failed\", \"key\", redisKey, \"error\", expireErr)\n      // Non-fatal: key will exist without TTL. INCR will keep counting but never expire.\n      // Accept this edge case: the counter resets on Redis restart anyway.\nStep 4: Calculate retryAfter\n  // Approximate: TTL of the current window.\n  // For simplicity, use windowSecs as retryAfter (conservative upper bound).\n  retryAfter := windowSecs\nStep 5: Check limit\n  if count > int64(limit):\n    return false, retryAfter, nil  // 429\n  return true, 0, nil              // allowed\nNote on atomicity: INCR is atomic in Redis. The race condition where two concurrent\nrequests both see count==1 and both call EXPIRE is harmless — both EXPIRE calls\nset the same TTL on the same key. The window boundary is accurate.\nNote on key structure:\n  \"shorten\" route:  \"rl:shorten:<client_ip>\"\n  \"redirect\" route: \"rl:redirect:<client_ip>\"\n  IP extraction:    net.SplitHostPort(r.RemoteAddr) or r.Header.Get(\"X-Forwarded-For\")\n                    (for this project: use RemoteAddr; no load balancer in front)\n```\n\n### 4.6 Gateway `ReverseProxy`\n\n```go\n// proxy.go\npackage gateway\nimport (\n    \"net/http\"\n    \"net/http/httputil\"\n    \"net/url\"\n)\n// UpstreamProxy wraps httputil.ReverseProxy for one upstream service.\ntype UpstreamProxy struct {\n    proxy    *httputil.ReverseProxy\n    upstream string  // service name for logging\n    log      *slog.Logger\n}\n// NewUpstreamProxy constructs a reverse proxy targeting baseURL.\nfunc NewUpstreamProxy(baseURL string, log *slog.Logger, upstream string) (*UpstreamProxy, error) {\n    target, err := url.Parse(baseURL)\n    if err != nil {\n        return nil, fmt.Errorf(\"parse upstream URL %q: %w\", baseURL, err)\n    }\n    rp := httputil.NewSingleHostReverseProxy(target)\n    // Custom error handler: capture upstream 5xx for circuit breaker\n    rp.ErrorHandler = func(w http.ResponseWriter, r *http.Request, err error) {\n        log.Warn(\"upstream error\", \"upstream\", upstream, \"error\", err,\n            \"correlation_id\", logger.CorrelationIDFromContext(r.Context()))\n        http.Error(w, `{\"error\":\"upstream error\"}`, http.StatusBadGateway)\n    }\n    return &UpstreamProxy{proxy: rp, upstream: upstream, log: log}, nil\n}\n// ServeHTTP forwards the request to the upstream. Strips the given prefix before forwarding.\nfunc (p *UpstreamProxy) ServeHTTP(w http.ResponseWriter, r *http.Request, stripPrefix, addPath string) {\n    // Rewrite path: strip gateway-level prefix, optionally rewrite\n    if stripPrefix != \"\" {\n        r.URL.Path = strings.TrimPrefix(r.URL.Path, stripPrefix)\n    }\n    if addPath != \"\" {\n        r.URL.Path = addPath + r.URL.Path\n    }\n    if r.URL.Path == \"\" {\n        r.URL.Path = \"/\"\n    }\n    p.proxy.ServeHTTP(w, r)\n}\n```\n\n**How the circuit breaker wraps the proxy:**\n\n```go\n// In the gateway handler — url-service only gets the circuit breaker:\nfunc (g *Gateway) handleURLService(w http.ResponseWriter, r *http.Request, route Route) {\n    rw := &responseWriter{ResponseWriter: w, status: 200}\n    err := g.urlServiceCB.Do(r.Context(), func() error {\n        g.urlProxy.ServeHTTP(rw, r, route.StripPrefix, \"\")\n        // Count 5xx as circuit breaker failures:\n        if rw.status >= 500 {\n            return fmt.Errorf(\"upstream 5xx: %d\", rw.status)\n        }\n        return nil\n    })\n    if errors.Is(err, ErrCircuitOpen):\n        w.Header().Set(\"Content-Type\", \"application/json\")\n        w.WriteHeader(http.StatusServiceUnavailable)\n        w.Write([]byte(`{\"error\":\"service unavailable\"}`))\n        return\n    // Other errors are already written by ErrorHandler\n}\n```\n\n---\n\n## 5. Algorithm Specification\n\n### 5.1 Gateway Request Processing Pipeline\n\nEvery incoming request passes through this ordered middleware chain:\n\n```\nIncoming HTTP Request\n        │\n        ▼\n1. CorrelationIDMiddleware\n   - Read X-Correlation-ID header\n   - If absent: generate UUID v4\n   - Store in request context\n   - Echo as X-Correlation-ID response header\n        │\n        ▼\n2. RequestLogger (shared/logger.RequestLogger)\n   - Record start time\n   - Wrap ResponseWriter to capture status code\n   - Call next handler\n   - After response: log {time, level, service, correlation_id, method, path, status, duration_ms}\n        │\n        ▼\n3. Router.ServeHTTP\n   - Match request against routingTable (first match wins)\n   - If no match: 404 {\"error\":\"not found\"}\n   - Determine: upstream, requiresAuth, rateLimitKey, stripPrefix\n        │\n        ▼\n4. [If requiresAuth] JWTMiddleware\n   - Read Authorization: Bearer <token>\n   - Verify HMAC-SHA256 locally (shared secret)\n   - On failure: 401 {\"error\":\"unauthorized\"} — stop processing\n   - On success: inject Claims into context\n        │\n        ▼\n5. [If rateLimitKey != \"\"] RateLimiter.Allow\n   - key = \"rl:{rateLimitKey}:{clientIP}\"\n   - Redis INCR + conditional EXPIRE\n   - If count > limit: 429 {\"error\":\"rate limit exceeded\"} + Retry-After header — stop\n   - On Redis error: log Warn + allow (fail-open)\n        │\n        ▼\n6. Forward X-Correlation-ID to upstream\n   - r.Header.Set(\"X-Correlation-ID\", correlationIDFromContext(r.Context()))\n        │\n        ▼\n7. [If upstream == \"url-service\"] CircuitBreaker.Do(upstream func)\n   - If OPEN: 503 {\"error\":\"service unavailable\"} — stop\n   - If CLOSED/HALF_OPEN: execute proxy forward\n   - Record success or failure based on response status\n        │\n        ▼\n8. [All other upstreams] Direct proxy forward\n   - httputil.ReverseProxy.ServeHTTP\n   - Path rewrite per route.StripPrefix\n        │\n        ▼\n   Upstream response → client\n```\n\n![Circuit Breaker State Transition Sequence](./diagrams/tdd-diag-30.svg)\n\n```\nGateway middleware chain (layered decorators):\n  ┌──────────────────────────────────────────────────────────────┐\n  │  net/http server                                             │\n  │                                                              │\n  │  handler := chain(                                           │\n  │    CorrelationIDMiddleware,      ← outermost (always runs)   │\n  │    logger.RequestLogger(log),   ← second (captures timing)  │\n  │    router.ServeHTTP,            ← matches route             │\n  │  )                                                           │\n  │                                                              │\n  │  Per-route (inside router):                                  │\n  │    if requiresAuth:  JWTMiddleware → 401 on fail            │\n  │    if rateLimitKey:  RateLimiter → 429 on exceeded          │\n  │    add correlation header                                    │\n  │    if upstream=url-service: CircuitBreaker.Do(proxy)        │\n  │    else: direct proxy                                        │\n  └──────────────────────────────────────────────────────────────┘\n```\n\n### 5.2 `CorrelationIDMiddleware` Implementation\n\n```go\n// middleware.go\npackage gateway\nimport (\n    \"net/http\"\n    \"github.com/yourhandle/url-shortener/shared/logger\"\n)\nfunc CorrelationIDMiddleware(next http.Handler) http.Handler {\n    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n        id := r.Header.Get(\"X-Correlation-ID\")\n        if id == \"\" {\n            id = newUUID()  // crypto/rand UUID v4 (same helper as other services)\n        }\n        ctx := logger.ContextWithCorrelationID(r.Context(), id)\n        w.Header().Set(\"X-Correlation-ID\", id)\n        next.ServeHTTP(w, r.WithContext(ctx))\n    })\n}\n// chain applies middlewares right-to-left (outermost first in call order).\nfunc chain(h http.Handler, middlewares ...func(http.Handler) http.Handler) http.Handler {\n    for i := len(middlewares) - 1; i >= 0; i-- {\n        h = middlewares[i](h)\n    }\n    return h\n}\n```\n\n### 5.3 Gateway JWT Middleware\n\n```go\n// jwtmiddleware.go\npackage gateway\nimport (\n    \"encoding/json\"\n    \"net/http\"\n    \"strings\"\n    \"github.com/yourhandle/url-shortener/shared/auth\"\n    \"github.com/yourhandle/url-shortener/shared/logger\"\n)\n// GatewayJWTMiddleware verifies JWT on routes with requiresAuth=true.\n// On success: injects Claims into context for downstream use.\n// On failure: writes 401 and does NOT forward to upstream.\n// This wraps shared/auth.JWTMiddleware to add gateway-specific logging.\nfunc GatewayJWTMiddleware(secret string, log *slog.Logger) func(http.Handler) http.Handler {\n    inner := auth.JWTMiddleware(secret)\n    return func(next http.Handler) http.Handler {\n        return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n            // shared/auth.JWTMiddleware writes 401 if token invalid.\n            // We wrap it to log the rejection with correlation ID.\n            rw := &responseWriter{ResponseWriter: w, status: 200}\n            inner(next).ServeHTTP(rw, r)\n            if rw.status == 401 {\n                log.Info(\"JWT rejected\",\n                    \"correlation_id\", logger.CorrelationIDFromContext(r.Context()),\n                    \"path\", r.URL.Path,\n                )\n            }\n        })\n    }\n}\n```\n\n### 5.4 Rate Limiter — Client IP Extraction\n\n```go\n// ratelimit.go\n// clientIP extracts the real client IP from a request.\n// For this project (no load balancer): uses RemoteAddr directly.\n// In production with a reverse proxy, check X-Forwarded-For first.\nfunc clientIP(r *http.Request) string {\n    ip, _, err := net.SplitHostPort(r.RemoteAddr)\n    if err != nil {\n        return r.RemoteAddr\n    }\n    return ip\n}\n// rateLimitKey builds the Redis key for a route+IP combination.\n// Format: \"rl:{routeKey}:{ip}\"\nfunc buildRateLimitKey(routeKey, ip string) string {\n    return \"rl:\" + routeKey + \":\" + ip\n}\n```\n\n### 5.5 Gateway `ServeHTTP` — Full Router Logic\n\n```go\n// router.go\ntype Gateway struct {\n    routes         []Route\n    proxies        map[string]*UpstreamProxy  // keyed by upstream service name\n    urlServiceCB   *CircuitBreaker\n    rateLimiter    RateLimiter\n    jwtSecret      string\n    rateLimits     map[string]RateLimitConfig\n    log            *slog.Logger\n}\nfunc (g *Gateway) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n    // Find matching route\n    var matched *Route\n    for i := range g.routes {\n        rt := &g.routes[i]\n        if strings.HasPrefix(r.URL.Path, rt.PathPrefix) {\n            if rt.Method == \"\" || rt.Method == r.Method {\n                matched = rt\n                break\n            }\n        }\n    }\n    if matched == nil {\n        writeError(w, 404, \"not found\")\n        return\n    }\n    // JWT authentication\n    if matched.RequiresAuth {\n        claims, ok := g.verifyJWT(w, r)\n        if !ok {\n            return  // 401 already written\n        }\n        _ = claims  // inject into context for upstream if needed\n    }\n    // Rate limiting\n    if matched.RateLimitKey != \"\" {\n        rlCfg, exists := g.rateLimits[matched.RateLimitKey]\n        if exists {\n            ip := clientIP(r)\n            key := buildRateLimitKey(matched.RateLimitKey, ip)\n            allowed, retryAfter, _ := g.rateLimiter.Allow(r.Context(), key, rlCfg.Limit, rlCfg.WindowSecs)\n            if !allowed {\n                w.Header().Set(\"Retry-After\", strconv.Itoa(retryAfter))\n                writeError(w, 429, \"rate limit exceeded\")\n                return\n            }\n        }\n    }\n    // Forward X-Correlation-ID header to upstream\n    corrID := logger.CorrelationIDFromContext(r.Context())\n    r.Header.Set(\"X-Correlation-ID\", corrID)\n    // Route to upstream\n    proxy, ok := g.proxies[matched.Upstream]\n    if !ok {\n        g.log.Error(\"no proxy for upstream\", \"upstream\", matched.Upstream)\n        writeError(w, 500, \"internal server error\")\n        return\n    }\n    // Apply path rewriting for redirect route\n    outPath := r.URL.Path\n    if matched.StripPrefix != \"\" {\n        outPath = strings.TrimPrefix(outPath, matched.StripPrefix)\n    }\n    // Special: /r/{code} → /{code}\n    if strings.HasPrefix(r.URL.Path, \"/r/\") {\n        outPath = strings.TrimPrefix(outPath, \"/r\")\n    }\n    r2 := r.Clone(r.Context())\n    r2.URL.Path = outPath\n    if r2.URL.Path == \"\" { r2.URL.Path = \"/\" }\n    // Circuit breaker for url-service only\n    if matched.Upstream == \"url-service\" {\n        rw := &responseWriter{ResponseWriter: w, status: 200}\n        err := g.urlServiceCB.Do(r.Context(), func() error {\n            proxy.proxy.ServeHTTP(rw, r2)\n            if rw.status >= 500 {\n                return fmt.Errorf(\"upstream 5xx: %d\", rw.status)\n            }\n            return nil\n        })\n        if errors.Is(err, ErrCircuitOpen) {\n            w.Header().Set(\"Content-Type\", \"application/json\")\n            w.WriteHeader(http.StatusServiceUnavailable)\n            w.Write([]byte(`{\"error\":\"service unavailable\"}`))\n        }\n        return\n    }\n    // Direct proxy for other upstreams\n    proxy.proxy.ServeHTTP(w, r2)\n}\n```\n\n### 5.6 Gateway Startup Sequence\n\n```\nmain.go startup — gateway:\n  1. loadConfig()\n     → if any required env var empty: fmt.Fprintf(stderr) + os.Exit(1)\n  2. log := logger.New(cfg.ServiceName)\n  3. Build Redis client for rate limiting:\n     opts, err := redis.ParseURL(cfg.RedisURL)\n     client := redis.NewClient(opts)\n     // Ping with 3s timeout; warn on failure (fail-open)\n     pingCtx, cancel := context.WithTimeout(ctx, 3*time.Second)\n     if err := client.Ping(pingCtx).Err(); err != nil:\n       log.Warn(\"gateway redis unreachable, rate limiting will fail-open\", \"error\", err)\n     cancel()\n  4. Build UpstreamProxy for each service:\n     proxies := map[string]*UpstreamProxy{\n       \"url-service\":          NewUpstreamProxy(cfg.URLServiceURL, log, \"url-service\"),\n       \"analytics-service\":    NewUpstreamProxy(cfg.AnalyticsServiceURL, log, \"analytics-service\"),\n       \"user-service\":         NewUpstreamProxy(cfg.UserServiceURL, log, \"user-service\"),\n       \"notification-service\": NewUpstreamProxy(cfg.NotificationServiceURL, log, \"notification-service\"),\n     }\n  5. Build CircuitBreaker:\n     cb := NewCircuitBreaker(cfg.CBMaxFailures, cfg.CBOpenTimeout, cfg.CBFailureWindow)\n  6. Build RateLimiter:\n     rl := NewRateLimiter(client, log)\n  7. Build Gateway:\n     gw := &Gateway{\n       routes: routingTable,\n       proxies: proxies,\n       urlServiceCB: cb,\n       rateLimiter: rl,\n       jwtSecret: cfg.JWTSecret,\n       rateLimits: cfg.RateLimits,\n       log: log,\n     }\n  8. Build mux:\n     mux := http.NewServeMux()\n     mux.HandleFunc(\"GET /health\", NewHealthHandler(cfg.ServiceName))\n     mux.Handle(\"/\", chain(\n       gw,\n       logger.RequestLogger(log),\n       CorrelationIDMiddleware,\n     ))\n  9. Health-check all four downstream services on startup:\n     go func():\n       for _, upstream := range []struct{name, url string}{\n         {\"url-service\", cfg.URLServiceURL},\n         {\"analytics-service\", cfg.AnalyticsServiceURL},\n         {\"user-service\", cfg.UserServiceURL},\n         {\"notification-service\", cfg.NotificationServiceURL},\n       }:\n         resp, err := http.Get(upstream.url + \"/health\")\n         if err != nil || resp.StatusCode != 200:\n           log.Warn(\"upstream not healthy at startup\",\n             \"upstream\", upstream.name,\n             \"error\", err,\n           )\n         else:\n           log.Info(\"upstream healthy\", \"upstream\", upstream.name)\n     ()\n  10. srv.ListenAndServe()\n```\n\n![Redis Token Bucket Rate Limiter Implementation](./diagrams/tdd-diag-31.svg)\n\n```\nGateway wiring diagram:\n                        ┌─────────────────────────────────┐\n  Client ──HTTP──►      │           API Gateway            │\n                        │                                  │\n                        │  CorrelationIDMiddleware         │\n                        │  RequestLogger                   │\n                        │  Router (routingTable)           │\n                        │    │                             │\n                        │    ├─[auth]   JWTMiddleware      │  ← shared/auth.VerifyToken\n                        │    ├─[rl]     redisTokenBucket   │  ← Redis INCR+EXPIRE\n                        │    └─[proxy]                     │\n                        │          │                       │\n                        │    url-service ──► CircuitBreaker│\n                        │          │                       │\n                        │    analytics-service ──► direct  │\n                        │    user-service ──► direct       │\n                        │    notification-service ──►direct│\n                        │                                  │\n                        │  Redis ◄───── rate limit keys    │\n                        └─────────────────────────────────┘\n                                        │\n                                  (proxied to)\n                              ┌─────────────────────────────┐\n                              │  url-service       :8081    │\n                              │  analytics-service :8082    │\n                              │  user-service      :8083    │\n                              │  notification-svc  :8084    │\n                              └─────────────────────────────┘\n```\n\n### 5.7 Notification Service Startup Sequence\n\n```\nmain.go startup — notification-service:\n  1. loadConfig() → fatal if DATABASE_URL | RABBITMQ_URL | JWT_SECRET missing\n  2. log := logger.New(cfg.ServiceName)\n  3. ctx, cancel := context.WithCancel(context.Background())\n  4. NewDBPool(ctx, cfg.DatabaseURL, log) → fatal on error\n  5. runMigrations(ctx, pool, log) → fatal on error\n  6. NewRabbitMQConn(ctx, cfg.RabbitMQURL, log, 10) → fatal after 10 attempts\n  7. DeclareNotificationQueue(mq.Channel) → fatal on error (from M1)\n  8. store := NewNotificationStore(pool)\n  9. consumer := NewNotificationConsumer(mq, pool, store, log)\n  10. handler := NewNotificationHandler(store, log)\n  11. mux := http.NewServeMux()\n      mux.HandleFunc(\"GET /health\", NewHealthHandler(cfg.ServiceName))\n      mux.Handle(\"GET /notifications\",\n        auth.JWTMiddleware(cfg.JWTSecret)(http.HandlerFunc(handler.ListNotifications)))\n  12. go consumer.Run(ctx)\n  13. srv.ListenAndServe()\n  14. On SIGTERM: cancel(); srv.Shutdown(...)\n```\n\n### 5.8 Schema Migration — Notification Service\n\n```go\n// main.go\nconst notificationSchema = `\nCREATE TABLE IF NOT EXISTS notifications (\n    id         UUID        PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id    UUID        NOT NULL,\n    event_type TEXT        NOT NULL,\n    payload    JSONB       NOT NULL,\n    status     TEXT        NOT NULL DEFAULT 'sent',\n    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n    sent_at    TIMESTAMPTZ NULL\n);\nCREATE INDEX IF NOT EXISTS idx_notifications_user_created\n    ON notifications(user_id, created_at DESC);\n`\nfunc runMigrations(ctx context.Context, pool *pgxpool.Pool, log *slog.Logger) error {\n    _, err := pool.Exec(ctx, notificationSchema)\n    if err != nil {\n        return fmt.Errorf(\"notification migrations: %w\", err)\n    }\n    log.Info(\"notification migrations applied\")\n    return nil\n}\n```\n\n### 5.9 `docker-compose.yml` Additions (M5)\n\n```yaml\n# Extend existing service environment blocks:\nnotification-service:\n  environment:\n    DATABASE_URL: postgres://notificationuser:notificationpass@notification_db:5432/notificationdb\n    RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/\n    JWT_SECRET: \"change-this-in-production-minimum-32-chars\"\n    PORT: \"8080\"\ngateway:\n  environment:\n    URL_SERVICE_URL: http://url-service:8080\n    ANALYTICS_SERVICE_URL: http://analytics-service:8080\n    USER_SERVICE_URL: http://user-service:8080\n    NOTIFICATION_SERVICE_URL: http://notification-service:8080\n    REDIS_URL: redis://redis:6379/0\n    JWT_SECRET: \"change-this-in-production-minimum-32-chars\"\n    PORT: \"8080\"\n```\n\n## **`JWT_SECRET` must be identical across:** user-service, url-service, notification-service, gateway. Any mismatch causes all JWT verifications to fail with 401\n\n## 6. Error Handling Matrix\n\n### 6.1 Notification Service\n\n| Error Scenario                            | Detected By                            | Recovery                     | HTTP Status / AMQP | Log Level      |\n| ----------------------------------------- | -------------------------------------- | ---------------------------- | ------------------ | -------------- |\n| Missing `DATABASE_URL`                    | `loadConfig()`                         | `os.Exit(1)`                 | — (pre-HTTP)       | Error (stderr) |\n| Missing `RABBITMQ_URL`                    | `loadConfig()`                         | `os.Exit(1)`                 | — (pre-HTTP)       | Error (stderr) |\n| Missing `JWT_SECRET`                      | `loadConfig()`                         | `os.Exit(1)`                 | — (pre-HTTP)       | Error (stderr) |\n| DB unreachable at startup                 | `NewDBPool` ping                       | `os.Exit(1)`                 | —                  | Error          |\n| Migration SQL fails                       | `pool.Exec`                            | `os.Exit(1)`                 | —                  | Error          |\n| RabbitMQ unreachable (all 10 attempts)    | `NewRabbitMQConn`                      | `os.Exit(1)`                 | —                  | Error          |\n| Queue declare fails                       | `DeclareNotificationQueue`             | `os.Exit(1)`                 | —                  | Error          |\n| Consumer QoS fails                        | `ch.Qos`                               | `os.Exit(1)`                 | —                  | Error          |\n| Consumer `Consume` fails                  | `ch.Consume`                           | `os.Exit(1)`                 | —                  | Error          |\n| AMQP channel closed mid-run               | `ok == false` on msgs                  | Block on `<-ctx.Done()`      | —                  | Warn           |\n| Consumer panic                            | `defer recover()`                      | `d.Ack(false)`               | —                  | Error          |\n| Unknown routing key                       | key not in {created,deleted,milestone} | `d.Ack(false)`               | —                  | Warn           |\n| Malformed JSON body (any event type)      | `json.Unmarshal`                       | `d.Ack(false)`               | —                  | Error          |\n| Missing `user_id` in event                | field check                            | `d.Ack(false)`               | —                  | Error          |\n| DB `Insert` fails                         | `store.Insert`                         | `d.Nack(false, true)`        | —                  | Error          |\n| Missing Authorization header              | `JWTMiddleware`                        | 401                          | 401                | none           |\n| Invalid/expired JWT on GET /notifications | `JWTMiddleware`                        | 401                          | 401                | none           |\n| DB `FindByUserID` fails                   | `store.FindByUserID`                   | 500                          | 500                | Error          |\n| Invalid `limit` query param               | `strconv.Atoi`                         | 400                          | 400                | none           |\n| Invalid `after` cursor (non-UUID)         | subquery on PK                         | DB returns 0 rows gracefully | —                  | none           |\n\n### 6.2 API Gateway\n\n| Error Scenario                         | Detected By                      | Recovery                                        | HTTP Status   | Log Level                              |\n| -------------------------------------- | -------------------------------- | ----------------------------------------------- | ------------- | -------------------------------------- |\n| Missing required env var               | `loadConfig()`                   | `os.Exit(1)`                                    | —             | Error (stderr)                         |\n| Redis parse URL fails                  | `redis.ParseURL`                 | Warn + continue (fail-open)                     | —             | Warn                                   |\n| Redis unreachable at startup           | `client.Ping`                    | Warn + continue (fail-open)                     | —             | Warn                                   |\n| Invalid upstream URL in config         | `url.Parse`                      | `os.Exit(1)`                                    | —             | Error                                  |\n| No matching route                      | router loop exhausted            | 404 `{\"error\":\"not found\"}`                     | 404           | none                                   |\n| Missing Authorization header           | `JWTMiddleware`                  | 401 `{\"error\":\"authorization header required\"}` | 401           | Info                                   |\n| Invalid/expired JWT                    | `auth.VerifyToken`               | 401 `{\"error\":\"unauthorized\"}`                  | 401           | Info                                   |\n| Rate limit exceeded                    | `redisTokenBucket.Allow`         | 429 + `Retry-After: 60` header                  | 429           | none                                   |\n| Redis INCR error (rate limiter)        | `client.Incr`                    | Warn + allow (fail-open)                        | —             | Warn                                   |\n| Redis Expire error (rate limiter)      | `client.Expire`                  | Warn + continue (non-fatal)                     | —             | Warn                                   |\n| Circuit OPEN, request rejected         | `cb.Do` returns `ErrCircuitOpen` | 503 `{\"error\":\"service unavailable\"}`           | 503           | none (state transition already logged) |\n| Upstream returns 5xx                   | proxy response status            | Increment circuit breaker failure counter       | 5xx (proxied) | Warn                                   |\n| Upstream network error / timeout       | `proxy.ErrorHandler`             | 502 `{\"error\":\"upstream error\"}`                | 502           | Warn                                   |\n| Circuit transitions CLOSED→OPEN        | `cb.Do` failure count            | Log state transition                            | —             | Warn                                   |\n| Circuit transitions OPEN→HALF_OPEN     | timeout elapsed                  | Log state transition                            | —             | Info                                   |\n| Probe succeeds (HALF_OPEN→CLOSED)      | `cb.Do` success                  | Log state transition                            | —             | Info                                   |\n| Probe fails (HALF_OPEN→OPEN)           | `cb.Do` failure                  | Log state transition                            | —             | Warn                                   |\n| Upstream health check fails at startup | `http.Get` on `/health`          | Log warning; gateway starts anyway              | —             | Warn                                   |\n| Response writer write error            | `w.Write` return                 | Ignored (client disconnected)                   | —             | none                                   |\n\n**`writeError` and `writeJSON` in gateway (`router.go` or `errors.go`):**\n\n```go\n// errors.go in gateway package\nfunc writeError(w http.ResponseWriter, status int, message string) {\n    w.Header().Set(\"Content-Type\", \"application/json\")\n    w.WriteHeader(status)\n    json.NewEncoder(w).Encode(struct {\n        Error string `json:\"error\"`\n    }{Error: message})\n}\nfunc writeJSON(w http.ResponseWriter, status int, v any) {\n    w.Header().Set(\"Content-Type\", \"application/json\")\n    w.WriteHeader(status)\n    json.NewEncoder(w).Encode(v)\n}\n```\n\n---\n\n## 7. Implementation Sequence with Checkpoints\n\n### Phase 1: Notification Service — DB Schema, Consumer, Handler (2–2.5h)\n\n1. Write `migration.sql` as specified in §3.1.\n2. Write `errors.go`: `writeError`, `writeJSON`, `truncate`.\n3. Write `store.go`: `NotificationRecord`, `NotificationRepository` interface, `pgxNotificationStore` with `Insert` (two-step tx: INSERT then UPDATE status) and `FindByUserID` (cursor pagination).\n4. Write `consumer.go`: `NotificationConsumer`, `Run()`, `processDelivery()` with full event-type switch and `mockEmail` log.\n5. Write `handler.go`: `NotificationHandler`, `ListNotifications` method.\n6. Extend `config.go` with `JWTSecret`.\n7. Extend `main.go`: `runMigrations`, wire all components, register routes, start consumer goroutine.\n\n```bash\ndocker compose up notification_db rabbitmq -d\nDATABASE_URL=\"postgres://notificationuser:notificationpass@localhost:5435/notificationdb\" \\\nRABBITMQ_URL=\"amqp://guest:guest@localhost:5672/\" \\\nJWT_SECRET=\"test-secret-minimum-32-chars-long\" \\\ngo run ./services/notification-service/\n```\n\nVerify schema:\n\n```bash\npsql -h localhost -p 5435 -U notificationuser -d notificationdb \\\n  -c \"\\d notifications; \\di idx_notifications_*;\"\n```\n\nManually publish a test message to `notifications.events` queue via RabbitMQ management UI (routing key `url.created`, body matching `URLCreatedEvent` JSON with `user_id` and `user_email` populated).\n**Checkpoint:** Consumer logs `\"would send email to user\"` with `user_id` and `message`. `SELECT * FROM notifications;` shows one row with `status='sent'` and non-null `sent_at`. `GET /notifications` with a valid JWT returns `200 [{\"id\":\"...\",\"event_type\":\"url.created\",...}]`. `go build ./services/notification-service/...` exits 0.\n\n### Phase 2: Extended `shared/logger` (0.5–1h)\n\n1. Extend `shared/logger/logger.go` with `WithCorrelationID`, `CorrelationIDFromContext`, `ContextWithCorrelationID`, `RequestLogger`, and the `responseWriter` capture struct.\n2. Update `go.work` if not already including `shared/logger`.\n3. Verify all existing services still compile: `go build ./...` from monorepo root.\n   **Checkpoint:** `go build github.com/yourhandle/url-shortener/shared/logger` exits 0. A test that calls `logger.RequestLogger` as middleware and checks that the log line contains `\"correlation_id\"` passes.\n\n### Phase 3: Gateway Routing Table and Reverse Proxy (1–1.5h)\n\n1. Extend `gateway/config.go` to full spec (§3.4 Config struct with all fields).\n2. Write `gateway/router.go`: `Route` struct, `routingTable` slice, `Gateway` struct, stub `ServeHTTP` that routes + proxies without auth/rate limit yet.\n3. Write `gateway/proxy.go`: `UpstreamProxy`, `NewUpstreamProxy`, `ServeHTTP` with path rewriting.\n4. Write `gateway/middleware.go`: `CorrelationIDMiddleware`, `chain` helper.\n5. Extend `gateway/main.go`: construct proxies, gateway, wire mux, start server.\n\n```bash\ndocker compose up url-service analytics-service user-service notification-service -d\nREDIS_URL=\"redis://localhost:6379/0\" \\\nURL_SERVICE_URL=\"http://localhost:8081\" \\\nANALYTICS_SERVICE_URL=\"http://localhost:8082\" \\\nUSER_SERVICE_URL=\"http://localhost:8083\" \\\nNOTIFICATION_SERVICE_URL=\"http://localhost:8084\" \\\nJWT_SECRET=\"test-secret-minimum-32-chars-long\" \\\ngo run ./gateway/\n# Test proxy routing (no auth yet on protected routes in this phase):\ncurl http://localhost:8080/api/auth/register -X POST \\\n  -d '{\"email\":\"e2e@example.com\",\"password\":\"password123\"}' \\\n  -H \"Content-Type: application/json\"\n# Expect: 201 {user_id, email} (proxied to user-service)\n```\n\n**Checkpoint:** `GET http://localhost:8080/health` returns `{\"status\":\"ok\",\"service\":\"gateway\"}`. `POST /api/auth/register` proxied correctly to user-service. `GET /api/stats/<code>` proxied to analytics-service. Unknown path `/xyz` returns 404. `X-Correlation-ID` response header present on all responses.\n\n### Phase 4: Gateway JWT Middleware and X-Correlation-ID Propagation (1h)\n\n1. Write `gateway/jwtmiddleware.go`: `GatewayJWTMiddleware` wrapping `shared/auth.JWTMiddleware`.\n2. Integrate into `Gateway.ServeHTTP`: apply JWT check when `route.RequiresAuth == true`.\n3. Verify `X-Correlation-ID` is forwarded to upstream (set on `r.Header` before proxy).\n\n```bash\n# Without token on protected route:\ncurl http://localhost:8080/api/shorten -X POST \\\n  -d '{\"url\":\"https://example.com\"}' -H \"Content-Type: application/json\"\n# Expect: 401 {\"error\":\"authorization header required\"}\n# With invalid token:\ncurl http://localhost:8080/api/urls \\\n  -H \"Authorization: Bearer invalid.token.here\"\n# Expect: 401\n# With valid token (get one from login first):\ncurl http://localhost:8080/api/urls \\\n  -H \"Authorization: Bearer $VALID_TOKEN\"\n# Expect: 200 {\"urls\":[],\"next_cursor\":null} (proxied to url-service)\n```\n\nCheck that `X-Correlation-ID` appears in url-service logs:\n\n```bash\ndocker compose logs url-service | grep correlation_id\n```\n\n**Checkpoint:** Auth-protected routes return 401 without valid JWT. Valid JWT routes through to upstream. `X-Correlation-ID` appears in forwarded request headers and in downstream service logs. Public routes (`/api/auth/*`, `/r/*`, `/api/stats/*`) pass through without JWT check.\n\n### Phase 5: Redis Token-Bucket Rate Limiter with 429 + Retry-After (1.5–2h)\n\n1. Write `gateway/ratelimit.go`: `RateLimiter` interface, `redisTokenBucket`, `Allow` implementation, `clientIP`, `buildRateLimitKey`.\n2. Integrate into `Gateway.ServeHTTP`: apply rate limit when `route.RateLimitKey != \"\"`.\n3. Wire `redis.Client` construction in `gateway/main.go`.\n\n```bash\n# Rate limit test for POST /api/shorten (limit=10/min):\nTOKEN=$(curl -s -X POST http://localhost:8080/api/auth/login \\\n  -d '{\"email\":\"e2e@example.com\",\"password\":\"password123\"}' \\\n  -H \"Content-Type: application/json\" | python3 -c \"import sys,json; print(json.load(sys.stdin)['token'])\")\nfor i in $(seq 1 11); do\n  RESP=$(curl -s -o /dev/null -w \"%{http_code}\" -X POST http://localhost:8080/api/shorten \\\n    -d '{\"url\":\"https://example.com/'$i'\"}' \\\n    -H \"Content-Type: application/json\" \\\n    -H \"Authorization: Bearer $TOKEN\")\n  echo \"Request $i: HTTP $RESP\"\ndone\n# Expected output:\n# Request 1-10: HTTP 201 (or whatever url-service returns)\n# Request 11:   HTTP 429\n```\n\nVerify `Retry-After` header on 429:\n\n```bash\ncurl -v -X POST http://localhost:8080/api/shorten ... 2>&1 | grep -i retry-after\n# Expect: < Retry-After: 60\n```\n\nVerify Redis keys:\n\n```bash\nredis-cli -p 6379 KEYS \"rl:*\"\n# Expect: [\"rl:shorten:127.0.0.1\"]\nredis-cli -p 6379 GET \"rl:shorten:127.0.0.1\"\n# Expect: \"11\" (or current count)\nredis-cli -p 6379 TTL \"rl:shorten:127.0.0.1\"\n# Expect: positive integer ≤ 60\n```\n\n**Checkpoint:** 11th `POST /api/shorten` from same IP returns `429` with `Retry-After: 60` header. Redis key `rl:shorten:<ip>` has a TTL ≤ 60s. `GET /r/<code>` allows 300 requests before 429. Killing Redis and making a request: gateway logs `\"rate limit redis incr failed\"` at Warn, request is allowed (fail-open), no 500 returned.\n\n### Phase 6: Circuit Breaker State Machine (2–2.5h)\n\n1. Write `gateway/circuitbreaker.go`: `State`, `CircuitBreaker`, `NewCircuitBreaker`, `Do()` method (full algorithm from §4.4).\n2. Integrate `CircuitBreaker` into `Gateway.ServeHTTP` for url-service only.\n3. Wire `NewCircuitBreaker(cfg.CBMaxFailures, cfg.CBOpenTimeout, cfg.CBFailureWindow)` in `main.go`.\n\n```bash\n# Simulate url-service failure by stopping it:\ndocker compose stop url-service\n# Make 5 requests (will fail; circuit counts them):\nfor i in $(seq 1 6); do\n  RESP=$(curl -s -o /dev/null -w \"%{http_code}\" http://localhost:8080/r/abc1234)\n  echo \"Request $i: HTTP $RESP\"\ndone\n# Requests 1-5: HTTP 502 (upstream error, circuit counting)\n# Request 6+:   HTTP 503 (circuit OPEN, rejected immediately)\n# Wait 30s then try again (half-open probe):\nsleep 31\nRESP=$(curl -s -o /dev/null -w \"%{http_code}\" http://localhost:8080/r/abc1234)\necho \"Probe: HTTP $RESP\"\n# If url-service still stopped: 502 (probe fails → back to OPEN)\n# Start url-service again:\ndocker compose start url-service\nsleep 31  # wait for next half-open\nRESP=$(curl -s -o /dev/null -w \"%{http_code}\" http://localhost:8080/r/abc1234)\necho \"Probe after restart: HTTP $RESP\"\n# Expect: 301 (probe succeeds → CLOSED)\n```\n\nCheck gateway logs for state transitions:\n\n```bash\ndocker compose logs gateway | grep \"circuit breaker\"\n# Expected lines:\n# {\"level\":\"WARN\",\"service\":\"gateway\",\"msg\":\"circuit breaker OPEN\",\"failures\":5,...}\n# {\"level\":\"INFO\",\"service\":\"gateway\",\"msg\":\"circuit breaker CLOSED (probe succeeded)\",...}\n```\n\n**Checkpoint:** Circuit opens after 5 consecutive 5xx responses within 10s. `GET /r/<code>` returns `503 {\"error\":\"service unavailable\"}` immediately (< 1ms, no upstream call) while circuit is OPEN. After 30s, one probe request is forwarded. On success, circuit closes. Other upstream proxies (analytics, user, notification) are NOT affected by url-service circuit breaker.\n\n### Phase 7: End-to-End Integration Test (1.5–2h)\n\n1. Write `gateway/gateway_test.go` (§8 test cases).\n2. Write integration test script `scripts/e2e_test.sh`.\n3. Run full stack via `docker compose up --build -d` and execute end-to-end test.\n\n```bash\ndocker compose up --build -d\nsleep 60  # wait for all containers healthy\nbash scripts/e2e_test.sh\n```\n\n**Checkpoint:** End-to-end test script passes all assertions. Rate limit test: 11th `POST /api/shorten` returns 429. Circuit breaker test: 6th request after simulated failure returns 503. `X-Correlation-ID` appears in logs of gateway, url-service, analytics-service, notification-service for the same request UUID. `docker compose down -v` teardown exits 0.\n\n![X-Correlation-ID Propagation Through Sync and Async Boundaries](./diagrams/tdd-diag-32.svg)\n\n```\nEnd-to-end flow: register → login → shorten → redirect → stats → notifications\n  Client              Gateway              Services              Async\n    │                    │                     │                    │\n    ├─POST /api/auth/register──────────────►user-service           │\n    │◄──201{user_id}──────┤                     │                  │\n    │                    │                     │                  │\n    ├─POST /api/auth/login─────────────────►user-service           │\n    │◄──200{token}────────┤                     │                  │\n    │                    │                     │                  │\n    ├─POST /api/shorten──►                     │                  │\n    │  [JWT✓] [rl:shorten]────────────────►url-service            │\n    │◄──201{short_code}───┤                     │                  │\n    │                    │                     │        ─────────►outbox\n    │                    │                     │        ◄url.created event\n    │                    │                     │        ────────►analytics.clicks\n    │                    │                     │        ────────►notifications.events\n    │                    │                     │                    │\n    ├─GET /r/{code}──────►                     │                  │\n    │  [rl:redirect]──────────────────────►url-service            │\n    │◄──301 Location──────┤                     │                  │\n    │                    │                     │        ─────────►outbox(click)\n    │                    │                     │        ◄url.clicked event\n    │                    │                     │                    │\n    ├─GET /api/stats/{code}────────────────►analytics-service      │\n    │◄──200{total_clicks}─┤                     │                  │\n    │                    │                     │                  │\n    ├─GET /api/notifications──────────────►notification-service    │\n    │  [JWT✓]             │                     │                  │\n    │◄──200[{notifs...}]──┤                     │                  │\n    │                    │                     │                  │\n  X-Correlation-ID = \"abc-123\" appears in logs of:\n    gateway, url-service, analytics-service, notification-service ✓\n```\n\n---\n\n## 8. Test Specification\n\n### 8.1 Circuit Breaker Unit Tests (`gateway_test.go`)\n\n```go\npackage gateway\nimport (\n    \"errors\"\n    \"sync\"\n    \"testing\"\n    \"time\"\n)\nfunc TestCircuitBreaker_InitiallyClosed(t *testing.T) {\n    cb := NewCircuitBreaker(5, 30*time.Second, 10*time.Second)\n    if cb.state != StateClosed {\n        t.Errorf(\"initial state: got %v want CLOSED\", cb.state)\n    }\n}\nfunc TestCircuitBreaker_ClosedPassesSuccess(t *testing.T) {\n    cb := NewCircuitBreaker(5, 30*time.Second, 10*time.Second)\n    err := cb.Do(context.Background(), func() error { return nil })\n    if err != nil {\n        t.Errorf(\"success in CLOSED: got error %v\", err)\n    }\n    cb.mu.Lock()\n    if cb.state != StateClosed {\n        t.Errorf(\"state after success: got %v\", cb.state)\n    }\n    cb.mu.Unlock()\n}\nfunc TestCircuitBreaker_OpensAfterMaxFailures(t *testing.T) {\n    cb := NewCircuitBreaker(3, 30*time.Second, 10*time.Second)\n    fail := func() error { return errors.New(\"upstream error\") }\n    for i := 0; i < 3; i++ {\n        cb.Do(context.Background(), fail)\n    }\n    cb.mu.Lock()\n    state := cb.state\n    cb.mu.Unlock()\n    if state != StateOpen {\n        t.Errorf(\"state after max failures: got %v want OPEN\", state)\n    }\n}\nfunc TestCircuitBreaker_OpenRejectsWithoutCallingUpstream(t *testing.T) {\n    cb := NewCircuitBreaker(1, 30*time.Second, 10*time.Second)\n    cb.Do(context.Background(), func() error { return errors.New(\"fail\") }) // trip\n    called := false\n    err := cb.Do(context.Background(), func() error {\n        called = true\n        return nil\n    })\n    if called {\n        t.Error(\"upstream should NOT be called when circuit is OPEN\")\n    }\n    if !errors.Is(err, ErrCircuitOpen) {\n        t.Errorf(\"expected ErrCircuitOpen, got %v\", err)\n    }\n}\nfunc TestCircuitBreaker_TransitionsToHalfOpenAfterTimeout(t *testing.T) {\n    cb := NewCircuitBreaker(1, 100*time.Millisecond, 10*time.Second)\n    cb.Do(context.Background(), func() error { return errors.New(\"fail\") }) // trip\n    time.Sleep(150 * time.Millisecond)\n    // Next Do should transition to HALF_OPEN and allow through\n    probeCalled := false\n    cb.Do(context.Background(), func() error {\n        probeCalled = true\n        return nil\n    })\n    if !probeCalled {\n        t.Error(\"probe request should be forwarded in HALF_OPEN\")\n    }\n    cb.mu.Lock()\n    state := cb.state\n    cb.mu.Unlock()\n    if state != StateClosed {\n        t.Errorf(\"state after successful probe: got %v want CLOSED\", state)\n    }\n}\nfunc TestCircuitBreaker_HalfOpenFailureReopens(t *testing.T) {\n    cb := NewCircuitBreaker(1, 100*time.Millisecond, 10*time.Second)\n    cb.Do(context.Background(), func() error { return errors.New(\"fail\") })\n    time.Sleep(150 * time.Millisecond)\n    cb.Do(context.Background(), func() error { return errors.New(\"probe fail\") })\n    cb.mu.Lock()\n    state := cb.state\n    cb.mu.Unlock()\n    if state != StateOpen {\n        t.Errorf(\"state after failed probe: got %v want OPEN\", state)\n    }\n}\nfunc TestCircuitBreaker_SuccessResetFailureCount(t *testing.T) {\n    cb := NewCircuitBreaker(3, 30*time.Second, 10*time.Second)\n    fail := func() error { return errors.New(\"fail\") }\n    cb.Do(context.Background(), fail)\n    cb.Do(context.Background(), fail) // 2 failures\n    cb.Do(context.Background(), func() error { return nil }) // success — reset\n    cb.mu.Lock()\n    failures := cb.failures\n    cb.mu.Unlock()\n    if failures != 0 {\n        t.Errorf(\"failures after success: got %d want 0\", failures)\n    }\n}\nfunc TestCircuitBreaker_ConcurrentSafe(t *testing.T) {\n    cb := NewCircuitBreaker(100, 30*time.Second, 10*time.Second)\n    var wg sync.WaitGroup\n    for i := 0; i < 100; i++ {\n        wg.Add(1)\n        go func() {\n            defer wg.Done()\n            cb.Do(context.Background(), func() error { return nil })\n        }()\n    }\n    wg.Wait() // must not race-detect or panic\n}\nfunc TestCircuitBreaker_FailureWindowReset(t *testing.T) {\n    // Failures in window 1 do not carry over to window 2\n    cb := NewCircuitBreaker(3, 30*time.Second, 100*time.Millisecond)\n    fail := func() error { return errors.New(\"fail\") }\n    cb.Do(context.Background(), fail)\n    cb.Do(context.Background(), fail) // 2 failures in window 1\n    time.Sleep(150 * time.Millisecond) // window expires\n    cb.Do(context.Background(), fail) // 1 failure in window 2\n    cb.mu.Lock()\n    state := cb.state\n    failures := cb.failures\n    cb.mu.Unlock()\n    if state != StateClosed {\n        t.Errorf(\"should still be CLOSED (only 1 failure in new window): got %v\", state)\n    }\n    if failures != 1 {\n        t.Errorf(\"failures in new window: got %d want 1\", failures)\n    }\n}\n```\n\n### 8.2 Rate Limiter Unit Tests\n\n```go\nfunc TestRateLimiter_AllowsUnderLimit(t *testing.T) {\n    mr := miniredis.RunT(t)\n    client := redis.NewClient(&redis.Options{Addr: mr.Addr()})\n    rl := NewRateLimiter(client, slog.Default())\n    for i := 0; i < 10; i++ {\n        allowed, _, err := rl.Allow(context.Background(), \"test:127.0.0.1\", 10, 60)\n        if err != nil { t.Fatalf(\"Allow error: %v\", err) }\n        if !allowed { t.Errorf(\"request %d should be allowed\", i+1) }\n    }\n}\nfunc TestRateLimiter_BlocksAtLimit(t *testing.T) {\n    mr := miniredis.RunT(t)\n    client := redis.NewClient(&redis.Options{Addr: mr.Addr()})\n    rl := NewRateLimiter(client, slog.Default())\n    for i := 0; i < 10; i++ {\n        rl.Allow(context.Background(), \"shorten:127.0.0.1\", 10, 60)\n    }\n    allowed, retryAfter, err := rl.Allow(context.Background(), \"shorten:127.0.0.1\", 10, 60)\n    if err != nil { t.Fatalf(\"Allow error: %v\", err) }\n    if allowed { t.Error(\"11th request should be blocked\") }\n    if retryAfter != 60 { t.Errorf(\"retryAfter: got %d want 60\", retryAfter) }\n}\nfunc TestRateLimiter_KeyHasTTL(t *testing.T) {\n    mr := miniredis.RunT(t)\n    client := redis.NewClient(&redis.Options{Addr: mr.Addr()})\n    rl := NewRateLimiter(client, slog.Default())\n    rl.Allow(context.Background(), \"shorten:10.0.0.1\", 10, 60)\n    ttl := mr.TTL(\"rl:shorten:10.0.0.1\")\n    if ttl <= 0 { t.Error(\"rate limit key must have a positive TTL\") }\n    if ttl > 60*time.Second { t.Errorf(\"TTL too long: %v\", ttl) }\n}\nfunc TestRateLimiter_WindowResets(t *testing.T) {\n    mr := miniredis.RunT(t)\n    client := redis.NewClient(&redis.Options{Addr: mr.Addr()})\n    rl := NewRateLimiter(client, slog.Default())\n    for i := 0; i < 10; i++ {\n        rl.Allow(context.Background(), \"shorten:1.1.1.1\", 10, 1)\n    }\n    mr.FastForward(2 * time.Second)\n    allowed, _, _ := rl.Allow(context.Background(), \"shorten:1.1.1.1\", 10, 1)\n    if !allowed { t.Error(\"request after window reset should be allowed\") }\n}\nfunc TestRateLimiter_FailOpenOnRedisError(t *testing.T) {\n    // Unreachable Redis → Allow returns true (fail-open)\n    client := redis.NewClient(&redis.Options{Addr: \"localhost:1\"})\n    rl := NewRateLimiter(client, slog.Default())\n    allowed, _, err := rl.Allow(context.Background(), \"test:1.2.3.4\", 10, 60)\n    if !allowed { t.Error(\"should fail-open when Redis unreachable\") }\n    if err == nil { t.Error(\"err should be non-nil for infrastructure failure\") }\n}\nfunc TestRateLimiter_DifferentIPsIndependent(t *testing.T) {\n    mr := miniredis.RunT(t)\n    client := redis.NewClient(&redis.Options{Addr: mr.Addr()})\n    rl := NewRateLimiter(client, slog.Default())\n    // Exhaust limit for IP1\n    for i := 0; i < 10; i++ {\n        rl.Allow(context.Background(), \"shorten:192.168.1.1\", 10, 60)\n    }\n    // IP2 should still be allowed\n    allowed, _, _ := rl.Allow(context.Background(), \"shorten:192.168.1.2\", 10, 60)\n    if !allowed { t.Error(\"different IP should not be rate limited\") }\n}\n```\n\n### 8.3 Router Unit Tests\n\n```go\nfunc TestRouter_MatchesCorrectRoute(t *testing.T) {\n    cases := []struct {\n        method   string\n        path     string\n        wantUpstream string\n        wantAuth bool\n    }{\n        {\"POST\", \"/api/auth/register\", \"user-service\", false},\n        {\"POST\", \"/api/auth/login\",    \"user-service\", false},\n        {\"POST\", \"/api/shorten\",       \"url-service\",  true},\n        {\"GET\",  \"/api/urls\",          \"url-service\",  true},\n        {\"GET\",  \"/r/abc1234\",         \"url-service\",  false},\n        {\"GET\",  \"/api/stats/abc1234\", \"analytics-service\", false},\n        {\"GET\",  \"/api/notifications\", \"notification-service\", true},\n    }\n    gw := &Gateway{routes: routingTable, log: slog.Default()}\n    for _, tc := range cases {\n        t.Run(tc.method+\" \"+tc.path, func(t *testing.T) {\n            matched := gw.matchRoute(tc.method, tc.path)\n            if matched == nil {\n                t.Fatal(\"no route matched\")\n            }\n            if matched.Upstream != tc.wantUpstream {\n                t.Errorf(\"upstream: got %q want %q\", matched.Upstream, tc.wantUpstream)\n            }\n            if matched.RequiresAuth != tc.wantAuth {\n                t.Errorf(\"auth: got %v want %v\", matched.RequiresAuth, tc.wantAuth)\n            }\n        })\n    }\n}\nfunc TestRouter_NoMatchReturns404(t *testing.T) {\n    req := httptest.NewRequest(\"GET\", \"/nonexistent/path\", nil)\n    rec := httptest.NewRecorder()\n    gw := buildTestGateway()\n    gw.ServeHTTP(rec, req)\n    if rec.Code != 404 {\n        t.Errorf(\"unknown path: got %d want 404\", rec.Code)\n    }\n}\nfunc TestRouter_JWTRequired_Returns401WithoutToken(t *testing.T) {\n    req := httptest.NewRequest(\"GET\", \"/api/urls\", nil)\n    rec := httptest.NewRecorder()\n    gw := buildTestGateway()\n    gw.ServeHTTP(rec, req)\n    if rec.Code != 401 {\n        t.Errorf(\"protected route without JWT: got %d want 401\", rec.Code)\n    }\n}\n```\n\n### 8.4 Notification Consumer Unit Tests\n\n```go\nfunc TestNotificationConsumer_URLCreatedEvent(t *testing.T) {\n    // Build URLCreatedEvent JSON\n    evt := events.URLCreatedEvent{\n        BaseEvent: events.BaseEvent{\n            EventType:     \"url.created\",\n            OccurredAt:    time.Now().UTC(),\n            EventID:       \"test-evt-001\",\n            CorrelationID: \"corr-123\",\n        },\n        ShortCode:   \"abc1234\",\n        OriginalURL: \"https://example.com\",\n        UserID:      \"user-uuid-001\",\n        UserEmail:   \"user@example.com\",\n    }\n    body, _ := json.Marshal(evt)\n    inserted := make([]*NotificationRecord, 0)\n    store := &mockNotificationStore{\n        insertFn: func(ctx context.Context, rec *NotificationRecord) (*NotificationRecord, error) {\n            inserted = append(inserted, rec)\n            rec.ID = \"notif-uuid-001\"\n            return rec, nil\n        },\n    }\n    consumer := &NotificationConsumer{store: store, log: slog.Default()}\n    d := amqp.Delivery{RoutingKey: \"url.created\", Body: body}\n    consumer.processDelivery(context.Background(), d)  // NOTE: test version that doesn't call d.Ack\n    if len(inserted) != 1 {\n        t.Fatalf(\"expected 1 insert, got %d\", len(inserted))\n    }\n    if inserted[0].UserID != \"user-uuid-001\" {\n        t.Errorf(\"user_id: got %q\", inserted[0].UserID)\n    }\n    if inserted[0].EventType != \"url.created\" {\n        t.Errorf(\"event_type: got %q\", inserted[0].EventType)\n    }\n}\nfunc TestNotificationConsumer_MalformedJSON_DoesNotInsert(t *testing.T) {\n    insertCalled := false\n    store := &mockNotificationStore{\n        insertFn: func(_ context.Context, _ *NotificationRecord) (*NotificationRecord, error) {\n            insertCalled = true\n            return nil, nil\n        },\n    }\n    consumer := &NotificationConsumer{store: store, log: slog.Default()}\n    d := amqp.Delivery{RoutingKey: \"url.created\", Body: []byte(\"not json\")}\n    consumer.processDelivery(context.Background(), d)\n    if insertCalled {\n        t.Error(\"insert should NOT be called for malformed JSON\")\n    }\n}\nfunc TestNotificationConsumer_MissingUserID_DoesNotInsert(t *testing.T) {\n    // URLCreatedEvent with UserID = \"\"\n    evt := events.URLCreatedEvent{\n        BaseEvent: events.BaseEvent{EventType: \"url.created\", EventID: \"x\"},\n        UserID:    \"\", // missing\n    }\n    body, _ := json.Marshal(evt)\n    insertCalled := false\n    store := &mockNotificationStore{\n        insertFn: func(_ context.Context, _ *NotificationRecord) (*NotificationRecord, error) {\n            insertCalled = true; return nil, nil\n        },\n    }\n    consumer := &NotificationConsumer{store: store, log: slog.Default()}\n    consumer.processDelivery(context.Background(), amqp.Delivery{RoutingKey: \"url.created\", Body: body})\n    if insertCalled { t.Error(\"insert must not be called when user_id is empty\") }\n}\nfunc TestNotificationConsumer_UnknownRoutingKey_Acked(t *testing.T) {\n    // Routing key not in {url.created, url.deleted, milestone.reached}\n    // Must Ack (not Nack) and not insert\n    insertCalled := false\n    store := &mockNotificationStore{\n        insertFn: func(_ context.Context, _ *NotificationRecord) (*NotificationRecord, error) {\n            insertCalled = true; return nil, nil\n        },\n    }\n    consumer := &NotificationConsumer{store: store, log: slog.Default()}\n    consumer.processDelivery(context.Background(), amqp.Delivery{\n        RoutingKey: \"unknown.key\", Body: []byte(`{}`),\n    })\n    if insertCalled { t.Error(\"unknown routing key must not trigger insert\") }\n}\n```\n\n### 8.5 `NotificationHandler` Unit Tests\n\n```go\nfunc TestListNotifications_EmptyList(t *testing.T) {\n    store := &mockNotificationStore{\n        findByUserIDFn: func(_ context.Context, _, _ string, _ int) ([]*NotificationRecord, string, error) {\n            return []*NotificationRecord{}, \"\", nil\n        },\n    }\n    h := NewNotificationHandler(store, slog.Default())\n    claims := &auth.Claims{Sub: \"user-uuid\", Email: \"u@e.com\", Iss: \"url-shortener\"}\n    ctx := context.WithValue(context.Background(), auth.TestClaimsKey{}, claims)\n    req := httptest.NewRequest(\"GET\", \"/notifications\", nil).WithContext(ctx)\n    rec := httptest.NewRecorder()\n    h.ListNotifications(rec, req)\n    if rec.Code != 200 { t.Errorf(\"got %d\", rec.Code) }\n    var resp notificationListResponse\n    json.Unmarshal(rec.Body.Bytes(), &resp)\n    if resp.Notifications == nil { t.Error(\"notifications must be [] not null\") }\n    if len(resp.Notifications) != 0 { t.Errorf(\"expected 0, got %d\", len(resp.Notifications)) }\n    if resp.NextCursor != nil { t.Error(\"next_cursor should be null\") }\n}\nfunc TestListNotifications_WithResults(t *testing.T) {\n    createdAt := time.Now().UTC()\n    store := &mockNotificationStore{\n        findByUserIDFn: func(_ context.Context, _, _ string, _ int) ([]*NotificationRecord, string, error) {\n            return []*NotificationRecord{\n                {\n                    ID:        \"notif-001\",\n                    UserID:    \"user-uuid\",\n                    EventType: \"url.created\",\n                    Payload:   []byte(`{\"short_code\":\"abc\"}`),\n                    Status:    \"sent\",\n                    CreatedAt: createdAt,\n                },\n            }, \"\", nil\n        },\n    }\n    h := NewNotificationHandler(store, slog.Default())\n    claims := &auth.Claims{Sub: \"user-uuid\"}\n    ctx := context.WithValue(context.Background(), auth.TestClaimsKey{}, claims)\n    req := httptest.NewRequest(\"GET\", \"/notifications\", nil).WithContext(ctx)\n    rec := httptest.NewRecorder()\n    h.ListNotifications(rec, req)\n    var resp notificationListResponse\n    json.Unmarshal(rec.Body.Bytes(), &resp)\n    if len(resp.Notifications) != 1 { t.Fatalf(\"expected 1 notification\") }\n    if resp.Notifications[0].ID != \"notif-001\" { t.Error(\"id mismatch\") }\n    if resp.Notifications[0].EventType != \"url.created\" { t.Error(\"event_type mismatch\") }\n}\nfunc TestListNotifications_InvalidLimitParam(t *testing.T) {\n    for _, bad := range []string{\"abc\", \"0\", \"51\", \"-1\"} {\n        t.Run(\"limit=\"+bad, func(t *testing.T) {\n            h := NewNotificationHandler(&mockNotificationStore{}, slog.Default())\n            claims := &auth.Claims{Sub: \"uid\"}\n            ctx := context.WithValue(context.Background(), auth.TestClaimsKey{}, claims)\n            req := httptest.NewRequest(\"GET\", \"/notifications?limit=\"+bad, nil).WithContext(ctx)\n            rec := httptest.NewRecorder()\n            h.ListNotifications(rec, req)\n            if rec.Code != 400 { t.Errorf(\"limit=%s: got %d want 400\", bad, rec.Code) }\n        })\n    }\n}\n```\n\n### 8.6 End-to-End Integration Test Script (`scripts/e2e_test.sh`)\n\n```bash\n#!/usr/bin/env bash\n# scripts/e2e_test.sh — full end-to-end test through gateway\nset -e\nBASE=\"http://localhost:8080\"\nEMAIL=\"e2e+$(date +%s)@example.com\"\nPASSWORD=\"e2epassword123\"\necho \"=== 1. Register ===\"\nREG=$(curl -sf -X POST \"$BASE/api/auth/register\" \\\n  -H \"Content-Type: application/json\" \\\n  -d \"{\\\"email\\\":\\\"$EMAIL\\\",\\\"password\\\":\\\"$PASSWORD\\\"}\")\nUSER_ID=$(echo \"$REG\" | python3 -c \"import sys,json; print(json.load(sys.stdin)['user_id'])\")\necho \"PASS: registered user_id=$USER_ID\"\necho \"=== 2. Login ===\"\nLOGIN=$(curl -sf -X POST \"$BASE/api/auth/login\" \\\n  -H \"Content-Type: application/json\" \\\n  -d \"{\\\"email\\\":\\\"$EMAIL\\\",\\\"password\\\":\\\"$PASSWORD\\\"}\")\nTOKEN=$(echo \"$LOGIN\" | python3 -c \"import sys,json; print(json.load(sys.stdin)['token'])\")\necho \"PASS: token obtained\"\necho \"=== 3. Shorten URL ===\"\nSHORTEN=$(curl -sf -X POST \"$BASE/api/shorten\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer $TOKEN\" \\\n  -d '{\"url\":\"https://example.com/very/long/path\"}')\nSHORT_CODE=$(echo \"$SHORTEN\" | python3 -c \"import sys,json; print(json.load(sys.stdin)['short_code'])\")\necho \"PASS: short_code=$SHORT_CODE\"\necho \"=== 4. Redirect ===\"\nREDIRECT_STATUS=$(curl -so /dev/null -w \"%{http_code}\" \"http://localhost:8080/r/$SHORT_CODE\")\nif [ \"$REDIRECT_STATUS\" != \"301\" ]; then\n  echo \"FAIL: redirect returned $REDIRECT_STATUS, want 301\"; exit 1\nfi\necho \"PASS: redirect returned 301\"\necho \"=== 5. Check stats (wait 3s for outbox) ===\"\nsleep 3\nSTATS=$(curl -sf \"$BASE/api/stats/$SHORT_CODE\")\nTOTAL=$(echo \"$STATS\" | python3 -c \"import sys,json; print(json.load(sys.stdin)['total_clicks'])\")\nif [ \"$TOTAL\" -lt \"1\" ]; then\n  echo \"FAIL: total_clicks=$TOTAL, expected >= 1\"; exit 1\nfi\necho \"PASS: total_clicks=$TOTAL\"\necho \"=== 6. Check notifications (wait 2s) ===\"\nsleep 2\nNOTIFS=$(curl -sf \"$BASE/api/notifications\" -H \"Authorization: Bearer $TOKEN\")\nCOUNT=$(echo \"$NOTIFS\" | python3 -c \"import sys,json; print(len(json.load(sys.stdin)['notifications']))\")\nif [ \"$COUNT\" -lt \"1\" ]; then\n  echo \"FAIL: notifications count=$COUNT, expected >= 1\"; exit 1\nfi\necho \"PASS: notifications count=$COUNT\"\necho \"=== 7. Rate limit test (11 POST /api/shorten) ===\"\nfor i in $(seq 1 10); do\n  curl -s -X POST \"$BASE/api/shorten\" \\\n    -H \"Content-Type: application/json\" \\\n    -H \"Authorization: Bearer $TOKEN\" \\\n    -d \"{\\\"url\\\":\\\"https://example.com/$i\\\"}\" > /dev/null\ndone\nELEVENTH=$(curl -so /dev/null -w \"%{http_code}\" -X POST \"$BASE/api/shorten\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer $TOKEN\" \\\n  -d '{\"url\":\"https://example.com/overflow\"}')\nif [ \"$ELEVENTH\" != \"429\" ]; then\n  echo \"FAIL: 11th shorten request returned $ELEVENTH, want 429\"; exit 1\nfi\necho \"PASS: 11th request returned 429\"\necho \"=== 8. Correlation ID propagation ===\"\nCORR_ID=\"test-corr-$(date +%s)\"\ncurl -sf \"$BASE/api/stats/$SHORT_CODE\" -H \"X-Correlation-ID: $CORR_ID\" > /dev/null\nsleep 1\nGW_LOG=$(docker compose logs gateway 2>/dev/null | grep \"$CORR_ID\" | wc -l)\nANALYTICS_LOG=$(docker compose logs analytics-service 2>/dev/null | grep \"$CORR_ID\" | wc -l)\nif [ \"$GW_LOG\" -eq \"0\" ]; then\n  echo \"FAIL: correlation_id $CORR_ID not found in gateway logs\"; exit 1\nfi\nif [ \"$ANALYTICS_LOG\" -eq \"0\" ]; then\n  echo \"FAIL: correlation_id $CORR_ID not found in analytics-service logs\"; exit 1\nfi\necho \"PASS: correlation_id propagated to gateway and analytics-service logs\"\necho \"\"\necho \"All end-to-end tests PASSED.\"\n```\n\n---\n\n## 9. Performance Targets\n\n| Operation                                                      | Target                           | How to Measure                                                                                     |\n| -------------------------------------------------------------- | -------------------------------- | -------------------------------------------------------------------------------------------------- |\n| Gateway overhead (JWT verify + rate limit Redis check + proxy) | < 5ms added latency p99          | Compare `wrk` p99 direct to url-service vs through gateway on `GET /r/<code>`                      |\n| Circuit breaker state read (CLOSED → allow)                    | < 1µs                            | `go test -bench=BenchmarkCBClosed -benchtime=10s ./gateway/`                                       |\n| Circuit breaker reject (OPEN → 503)                            | < 100µs                          | `go test -bench=BenchmarkCBOpen -benchtime=10s ./gateway/`                                         |\n| Rate limit check (`INCR` + conditional `EXPIRE`)               | < 2ms p99                        | `wrk -t1 -c1 -d10s` against gateway shorten route; compare Redis latency via `redis-cli --latency` |\n| `GET /notifications` (DB query, 20 rows)                       | < 20ms p99                       | `wrk -t4 -c20 -d30s` with valid Bearer token via Lua script                                        |\n| End-to-end register→shorten→redirect→stats through gateway     | < 100ms p99                      | Shell script with `curl --trace-time` measuring each step                                          |\n| 11th rate-limited request (429, no upstream call)              | < 2ms                            | `curl -o /dev/null -w \"%{time_total}\"` on the 11th request                                         |\n| 503 circuit-open response (no upstream call)                   | < 1ms                            | Same measurement approach                                                                          |\n| Notification consumer message processing                       | < 30ms p99                       | Log `duration_ms` in `processDelivery`, check after 1000 messages                                  |\n| Gateway startup to HTTP ready                                  | < 5s after all upstreams healthy | Docker healthcheck pass time in `docker compose ps`                                                |\n\n**Circuit breaker benchmarks:**\n\n```go\nfunc BenchmarkCircuitBreakerClosed(b *testing.B) {\n    cb := NewCircuitBreaker(5, 30*time.Second, 10*time.Second)\n    b.ResetTimer()\n    for i := 0; i < b.N; i++ {\n        cb.Do(context.Background(), func() error { return nil })\n    }\n    // Expected: ~200-500 ns/op (mutex acquire + single function call)\n}\nfunc BenchmarkCircuitBreakerOpen(b *testing.B) {\n    cb := NewCircuitBreaker(1, 30*time.Second, 10*time.Second)\n    cb.Do(context.Background(), func() error { return errors.New(\"trip\") })\n    b.ResetTimer()\n    for i := 0; i < b.N; i++ {\n        cb.Do(context.Background(), func() error { return nil })\n    }\n    // Expected: ~100-200 ns/op (mutex acquire + state check + return ErrCircuitOpen)\n}\n```\n\n![Structured JSON Log Schema](./diagrams/tdd-diag-33.svg)\n\n```\nLatency budget for GET /r/{code} through gateway (cache hit path):\n  ┌──────────────────────────────────────────────────────────────┐\n  │ Network recv + HTTP parse:                  ~0.1ms           │\n  │ CorrelationIDMiddleware (UUID gen if absent):< 0.1ms         │\n  │ RequestLogger start:                         < 0.01ms        │\n  │ Router.matchRoute (linear scan, 8 entries):  < 0.01ms        │\n  │ [No auth required for redirect route]                        │\n  │ RateLimiter.Allow (Redis INCR):              ~0.5-1ms        │ ← network to Redis\n  │ Set X-Correlation-ID on forwarded request:   < 0.01ms        │\n  │ CircuitBreaker.Do (mutex acquire, CLOSED):   < 0.001ms       │\n  │ httputil.ReverseProxy.ServeHTTP:             ~1-3ms          │ ← url-service cache hit\n  │ ResponseWriter capture status:               < 0.01ms        │\n  │ RequestLogger log write:                     < 0.1ms         │\n  │ Network send:                                ~0.1ms           │\n  │ TOTAL gateway overhead (above direct call):  ~1-2ms typical  │\n  │                                              < 5ms p99 ✓    │\n  └──────────────────────────────────────────────────────────────┘\n```\n\n![Notification Service Module Architecture and Consumer Flow](./diagrams/tdd-diag-34.svg)\n\n```\nRate limiter Redis key lifecycle:\n  Request 1 (t=0):\n    INCR \"rl:shorten:192.168.1.1\" → 1\n    EXPIRE \"rl:shorten:192.168.1.1\" 60\n    allowed=true\n  Requests 2-10 (t=1s to t=10s):\n    INCR → 2, 3, ..., 10\n    (EXPIRE not called; count==1 is false)\n    allowed=true\n  Request 11 (t=11s):\n    INCR → 11\n    11 > 10 → allowed=false, retryAfter=60\n    Response: 429 + \"Retry-After: 60\"\n  t=60s: Redis key expires automatically\n  Request 12 (t=61s):\n    INCR \"rl:shorten:192.168.1.1\" → 1 (key re-created)\n    EXPIRE \"rl:shorten:192.168.1.1\" 60\n    allowed=true (new window)\n```\n\n### 9.1 `go.mod` Additions\n\n```\n// services/notification-service/go.mod\nmodule github.com/yourhandle/url-shortener/notification-service\ngo 1.23\nrequire (\n    github.com/yourhandle/url-shortener/shared/events v0.0.0\n    github.com/yourhandle/url-shortener/shared/logger v0.0.0\n    github.com/yourhandle/url-shortener/shared/auth   v0.0.0\n    github.com/jackc/pgx/v5 v5.6.0\n    github.com/rabbitmq/amqp091-go v1.10.0\n    github.com/golang-jwt/jwt/v5 v5.2.1\n)\nreplace (\n    github.com/yourhandle/url-shortener/shared/events => ../../shared/events\n    github.com/yourhandle/url-shortener/shared/logger => ../../shared/logger\n    github.com/yourhandle/url-shortener/shared/auth   => ../../shared/auth\n)\n// gateway/go.mod\nmodule github.com/yourhandle/url-shortener/gateway\ngo 1.23\nrequire (\n    github.com/yourhandle/url-shortener/shared/logger v0.0.0\n    github.com/yourhandle/url-shortener/shared/auth   v0.0.0\n    github.com/golang-jwt/jwt/v5 v5.2.1\n    github.com/redis/go-redis/v9 v9.6.0\n    github.com/alicebob/miniredis/v2 v2.32.0  // test only\n)\nreplace (\n    github.com/yourhandle/url-shortener/shared/logger => ../shared/logger\n    github.com/yourhandle/url-shortener/shared/auth   => ../shared/auth\n)\n```\n\n![Gateway Routing Table](./diagrams/tdd-diag-35.svg)\n\n```\nCorrelation ID propagation across all five processes:\n  Client               Gateway              url-service        analytics-service\n    │                     │                      │                      │\n    ├─X-Corr-ID: abc-123──►                     │                      │\n    │                     ├─CorrelationIDMiddleware: stores \"abc-123\"   │\n    │                     ├─RequestLogger: logs {correlation_id:\"abc-123\",...}\n    │                     ├─X-Corr-ID: abc-123──►                      │\n    │                     │                ├─CorrelationIDMiddleware    │\n    │                     │                ├─handler logs {correlation_id:\"abc-123\"}\n    │                     │                ├─INSERT outbox(correlation_id:\"abc-123\")\n    │                     │                │                     │\n    │                     │          [outbox poll → AMQP publish]│\n    │                     │            URLClickedEvent.CorrelationID = \"abc-123\"\n    │                     │                                ├─consumer.processDelivery\n    │                     │                                ├─log {correlation_id:\"abc-123\"}\n    │                     │                                │\n  async boundary:         │\n    │                     │\n  URLCreatedEvent.CorrelationID = \"abc-123\" → notifications.events\n    │                                                notification-service\n    │                                                ├─processDelivery\n    │                                                ├─log {correlation_id:\"abc-123\"}\n```\n\n![End-to-End Request Trace: Register → Shorten → Redirect → Stats → Notifications](./diagrams/tdd-diag-36.svg)\n\n```\nAnti-pattern guard — gateway contains ZERO domain logic:\n  FORBIDDEN imports in gateway/:\n    github.com/yourhandle/url-shortener/shared/events  ← domain events\n    Any reference to \"short_code\", \"URLRecord\", \"clicks\"\n  ALLOWED imports in gateway/:\n    github.com/yourhandle/url-shortener/shared/auth   ← JWT verification\n    github.com/yourhandle/url-shortener/shared/logger ← structured logging\n    github.com/redis/go-redis/v9                       ← rate limiting\n    net/http, net/http/httputil                        ← proxy\n    sync, time, strings, context                       ← stdlib\n  Verification command:\n    grep -r \"shared/events\\|URLRecord\\|short_code\\|ClickRecord\" gateway/ \\\n      | grep -v \"_test.go\" && echo \"FAIL: domain logic in gateway\" \\\n      || echo \"PASS: gateway is domain-free\"\n  Additional anti-pattern: notification service MUST NOT call other services\n    grep -r \"url-service\\|analytics-service\\|user-service\\|8081\\|8082\\|8083\" \\\n      services/notification-service/*.go | grep -v \"_test.go\" \\\n      && echo \"FAIL: notification-service makes cross-service call\" \\\n      || echo \"PASS: notification-service self-contained\"\n```\n\n---\n\n<!-- END_TDD_MOD -->\n\n# Project Structure: URL Shortener (Microservices)\n\n## Directory Tree\n\n```\nurl-shortener/                                          # Monorepo root\n│\n├── go.work                                             # Go workspace (all modules) — M1\n│\n├── shared/\n│   ├── events/\n│   │   ├── go.mod                                      # module: shared/events — M1\n│   │   ├── events.go                                   # All domain event structs + routing key constants — M1\n│   │   └── events_test.go                              # JSON round-trip + constant tests — M1\n│   │\n│   ├── logger/\n│   │   ├── go.mod                                      # module: shared/logger — M1\n│   │   └── logger.go                                   # JSON logger + WithCorrelationID + RequestLogger middleware — M1, M5\n│   │\n│   └── auth/\n│       ├── go.mod                                      # module: shared/auth — M2\n│       ├── auth.go                                     # Claims struct, TokenIssuer interface, VerifyToken, ErrTokenInvalid — M2\n│       └── middleware.go                               # JWTMiddleware, ClaimsFromContext, claimsKey — M2\n│\n├── services/\n│   │\n│   ├── url-service/\n│   │   ├── go.mod                                      # module: url-service; requires shared/events, auth, logger, pgx, redis, amqp, jwt — M1–M3\n│   │   ├── main.go                                     # Startup sequence, route wiring, outbox coordinator start, graceful shutdown — M1–M3\n│   │   ├── config.go                                   # Config struct: DB/Redis/AMQP/JWT/ShortURLBase/Outbox fields, loadConfig() — M1–M3\n│   │   ├── db.go                                       # NewDBPool (pgxpool, 10s ping, MaxConns=10) — M1\n│   │   ├── redis.go                                    # NewRedisClient (non-fatal ping, always returns client) — M1\n│   │   ├── rabbitmq.go                                 # NewRabbitMQConn (retry+backoff), declareExchange — M1\n│   │   ├── health.go                                   # NewHealthHandler (pre-encoded JSON, no DB check) — M1\n│   │   ├── migration.sql                               # urls + outbox tables, all 4 indexes — M3\n│   │   ├── store.go                                    # URLRecord, URLRepository interface, pgxURLStore (Insert/FindByCode/FindByUserID/Deactivate) — M3\n│   │   ├── outbox_store.go                             # OutboxRecord, OutboxRepository interface, pgxOutboxStore (InsertWithURL/InsertEvent/FetchUnpublished/MarkPublished) — M3\n│   │   ├── base62.go                                   # base62Alphabet const, Encode(*big.Int), Decode() — M3\n│   │   ├── codegen.go                                  # ShortCodeGenerator, Generate() using crypto/rand — M3\n│   │   ├── cache.go                                    # CachedURL, RedisCache (Get/Set/Del, error-isolated, TTL logic) — M3\n│   │   ├── publisher.go                                # RabbitMQPublisher interface, amqpPublisher with sync.Mutex — M3\n│   │   ├── outbox.go                                   # OutboxCoordinator, 3-worker pool, Run(), poll(), runWorker(), graceful drain — M3\n│   │   ├── handler.go                                  # Handler struct; Shorten/Redirect/ListURLs/DeleteURL; CorrelationIDMiddleware; hashIP; newUUID — M3\n│   │   ├── validate.go                                 # validateURL (scheme + host check) — M3\n│   │   ├── errors.go                                   # ErrShortCodeConflict, ErrURLNotFound, ErrNotOwner; writeError, writeJSON, isPgUniqueViolation — M3\n│   │   ├── url_test.go                                 # Base62 round-trip, codegen, validateURL, handler unit tests (mock stores), RedisCache tests (miniredis), outbox worker tests — M3\n│   │   ├── bench_test.go                               # BenchmarkRedirectCacheHit, BenchmarkShortCodeGenerate — M3\n│   │   └── Dockerfile                                  # Multi-stage Go build, scratch final image, EXPOSE 8080 — M1\n│   │\n│   ├── analytics-service/\n│   │   ├── go.mod                                      # module: analytics-service; requires shared/events, logger, pgx, amqp, golang.org/x/sync — M1, M4\n│   │   ├── main.go                                     # Startup: DB→migrations→AMQP→queues→stores→consumer goroutine→HTTP — M1, M4\n│   │   ├── config.go                                   # Config: DATABASE_URL, RABBITMQ_URL, IPHashSalt, AMQPPrefetchCount=1 — M1, M4\n│   │   ├── db.go                                       # NewDBPool reused from M1 pattern — M1\n│   │   ├── rabbitmq.go                                 # NewRabbitMQConn + DeclareAnalyticsQueue (\"analytics.clicks\" + \"url.clicked\" binding) — M1\n│   │   ├── health.go                                   # NewHealthHandler (always 200, no consumer state) — M1\n│   │   ├── migration.sql                               # clicks + milestones + processed_events tables, 5 indexes — M4\n│   │   ├── store.go                                    # ClickRecord, MilestoneRecord, StatsResult; ClickRepository, MilestoneRepository, DeduplicationRepository interfaces + pgx impls — M4\n│   │   ├── consumer.go                                 # ClickConsumer, Run() (prefetch=1, manual ack), processDelivery() (dedup→click→milestone in one tx), panic recovery, newUUID — M4\n│   │   ├── milestone.go                                # MilestoneChecker, CheckAndPublish() (thresholds 10/100/1000, tx-scoped COUNT, ON CONFLICT DO NOTHING) — M4\n│   │   ├── publisher.go                                # AnalyticsPublisher interface, amqpAnalyticsPublisher.PublishMilestone() — M4\n│   │   ├── handler.go                                  # StatsHandler; Stats() (errgroup 4 concurrent queries); Timeline() (day/hour validation) — M4\n│   │   ├── errors.go                                   # writeError, writeJSON, truncate helpers — M4\n│   │   ├── haship.go                                   # hashIP(remoteAddr, salt) → SHA-256 hex; newUUID — M4\n│   │   ├── analytics_test.go                           # MilestoneChecker unit tests (mock stores), consumer idempotency test, StatsHandler tests (mock), integration tests — M4\n│   │   └── Dockerfile                                  # Multi-stage Go build, scratch final image — M1\n│   │\n│   ├── user-service/\n│   │   ├── go.mod                                      # module: user-service; requires shared/auth, logger, pgx, bcrypt, jwt — M1, M2\n│   │   ├── main.go                                     # Startup: DB→migrations→stores→handler→routes (register/login/me) — M1, M2\n│   │   ├── config.go                                   # Config: DATABASE_URL, JWTSecret, BCryptCost=12, TokenTTL=24h — M1, M2\n│   │   ├── db.go                                       # NewDBPool — M1\n│   │   ├── health.go                                   # NewHealthHandler — M1\n│   │   ├── migration.sql                               # users table (id UUID PK, email UNIQUE, password_hash, created_at) + idx_users_email — M2\n│   │   ├── store.go                                    # User struct, UserRepository interface, pgxUserStore (Insert/FindByEmail), isPgUniqueViolation — M2\n│   │   ├── password.go                                 # PasswordHasher interface, bcryptHasher (Hash/Verify, ErrPasswordMismatch) — M2\n│   │   ├── token.go                                    # jwtTokenIssuer (Issue/Verify), dummy-hash constant for timing safety — M2\n│   │   ├── handler.go                                  # Handler struct; Register/Login (timing-safe)/Me methods; request/response types — M2\n│   │   ├── validate.go                                 # validateEmail (regex), validatePassword (min 8 chars) — M2\n│   │   ├── errors.go                                   # ErrDuplicateEmail, ErrUserNotFound, ErrPasswordMismatch, ErrTokenInvalid; writeError — M2\n│   │   ├── user_test.go                                # Validator tests, bcryptHasher tests, jwtTokenIssuer tests, handler unit tests (mock store), integration round-trip test — M2\n│   │   └── Dockerfile                                  # Multi-stage Go build, scratch final image — M1\n│   │\n│   └── notification-service/\n│       ├── go.mod                                      # module: notification-service; requires shared/events, auth, logger, pgx, amqp, jwt — M1, M5\n│       ├── main.go                                     # Startup: DB→migrations→AMQP→queues→store→consumer goroutine→HTTP (JWTMiddleware on /notifications) — M1, M5\n│       ├── config.go                                   # Config: DATABASE_URL, RABBITMQ_URL, JWTSecret — M1, M5\n│       ├── db.go                                       # NewDBPool — M1\n│       ├── rabbitmq.go                                 # NewRabbitMQConn + DeclareNotificationQueue (\"notifications.events\" + 3 bindings) — M1\n│       ├── health.go                                   # NewHealthHandler — M1\n│       ├── migration.sql                               # notifications table (id, user_id, event_type, payload JSONB, status, created_at, sent_at) + idx_notifications_user_created — M5\n│       ├── store.go                                    # NotificationRecord, NotificationRepository interface, pgxNotificationStore (Insert 2-step tx / FindByUserID cursor pagination) — M5\n│       ├── consumer.go                                 # NotificationConsumer, Run() (prefetch=1), processDelivery() (routing-key switch, mockEmail log, insert, ack/nack), panic recovery — M5\n│       ├── handler.go                                  # NotificationHandler, ListNotifications() (JWT claims→FindByUserID→paginated response) — M5\n│       ├── errors.go                                   # writeError, writeJSON, truncate — M5\n│       ├── notification_test.go                        # Consumer unit tests (mock store, all event types, malformed JSON, unknown key), handler unit tests, integration test — M5\n│       └── Dockerfile                                  # Multi-stage Go build, scratch final image — M1\n│\n├── gateway/\n│   ├── go.mod                                          # module: gateway; requires shared/auth, logger, go-redis, jwt, miniredis (test) — M1, M5\n│   ├── main.go                                         # Startup: config→Redis→proxies→CircuitBreaker→RateLimiter→Gateway→mux→upstream health checks→serve — M1, M5\n│   ├── config.go                                       # Config: all upstream URLs, RedisURL, JWTSecret, CB settings, RateLimits map — M1, M5\n│   ├── health.go                                       # NewHealthHandler — M1\n│   ├── router.go                                       # Route struct, routingTable (8 routes), Gateway struct, ServeHTTP (match→auth→rl→proxy), matchRoute() — M5\n│   ├── proxy.go                                        # UpstreamProxy (httputil.ReverseProxy wrapper), NewUpstreamProxy, path rewriting, ErrorHandler — M5\n│   ├── middleware.go                                   # CorrelationIDMiddleware, chain() helper — M5\n│   ├── ratelimit.go                                    # RateLimiter interface, redisTokenBucket (INCR+EXPIRE, fail-open), clientIP, buildRateLimitKey — M5\n│   ├── circuitbreaker.go                               # State enum, CircuitBreaker (sync.Mutex, 3-state machine), NewCircuitBreaker, Do(), ErrCircuitOpen — M5\n│   ├── jwtmiddleware.go                                # GatewayJWTMiddleware (wraps shared/auth.JWTMiddleware, adds correlation log) — M5\n│   ├── errors.go                                       # writeError, writeJSON helpers — M5\n│   ├── gateway_test.go                                 # CircuitBreaker unit tests (all transitions, concurrency), RateLimiter tests (miniredis), router matching tests, notification handler tests — M5\n│   └── Dockerfile                                      # Multi-stage Go build, scratch final image — M1\n│\n├── scripts/\n│   ├── smoke_test.sh                                   # Health-check all 5 /health endpoints — M1\n│   └── e2e_test.sh                                     # Full register→login→shorten→redirect→stats→notifications→rate-limit→correlation-ID test — M5\n│\n├── docker-compose.yml                                  # Full container mesh: 4 PostgreSQL, RabbitMQ, Redis, 4 services, gateway — M1 (extended M2–M5)\n└── README.md                                           # Prerequisites, startup commands, port table, RabbitMQ credentials — M1\n```\n\n---\n\n## Creation Order\n\n### 1. Project Scaffold (30 min)\n\n- Create all directories: `shared/events/`, `shared/logger/`, `shared/auth/`, `services/url-service/`, `services/analytics-service/`, `services/user-service/`, `services/notification-service/`, `gateway/`, `scripts/`\n- `go.work` (workspace root)\n- `shared/events/go.mod`\n- `shared/logger/go.mod`\n- All five service `go.mod` files with empty `require` blocks (fill in as needed per phase)\n- Stub `main.go` in each service/gateway: `package main; func main() {}`\n\n### 2. Shared Packages — Events and Logger (30 min)\n\n- `shared/events/events.go` — BaseEvent, URLCreatedEvent, URLClickedEvent, URLDeletedEvent, MilestoneReachedEvent, EventType constants\n- `shared/events/events_test.go` — JSON round-trip tests, constant value tests\n- `shared/logger/logger.go` — `New()` (JSON handler, service field) — M5 extensions added later\n\n### 3. Infrastructure Config — docker-compose.yml (1–1.5h)\n\n- `docker-compose.yml` — all 4 PostgreSQL instances (ports 5432–5435), RabbitMQ (5672, 15672), Redis (6379), all 5 app containers with healthchecks and depends_on chains\n- Verify: `docker compose config` → exit 0; `docker compose up` infra containers → all healthy\n\n### 4. Per-Service Foundations: db.go, redis.go, rabbitmq.go, health.go, config.go, main.go, Dockerfile (1.5–2h)\n\n- **url-service**: `config.go`, `db.go`, `redis.go`, `rabbitmq.go`, `health.go`, `main.go` (health route only), `Dockerfile`\n- **analytics-service**: `config.go`, `db.go`, `rabbitmq.go` (+ `DeclareAnalyticsQueue`), `health.go`, `main.go`, `Dockerfile`\n- **user-service**: `config.go`, `db.go`, `health.go`, `main.go`, `Dockerfile`\n- **notification-service**: `config.go`, `db.go`, `rabbitmq.go` (+ `DeclareNotificationQueue`), `health.go`, `main.go`, `Dockerfile`\n- **gateway**: `config.go` (stub), `health.go`, `main.go` (health only), `Dockerfile`\n- `scripts/smoke_test.sh`\n- `README.md`\n- **Checkpoint M1**: `docker compose up --build -d` → all 10 containers healthy; all `/health` return `200 {\"status\":\"ok\"}`\n\n### 5. Shared Auth Package (1h)\n\n- `shared/auth/go.mod`\n- `shared/auth/auth.go` — Claims, TokenIssuer interface, VerifyToken, ErrTokenInvalid, TestClaimsKey\n- `shared/auth/middleware.go` — JWTMiddleware, ClaimsFromContext, claimsKey\n- Update `go.work` to include `./shared/auth`\n\n### 6. User Service — Full Implementation (3–4h)\n\n- `services/user-service/migration.sql`\n- `services/user-service/errors.go`\n- `services/user-service/store.go`\n- `services/user-service/password.go`\n- `services/user-service/token.go`\n- `services/user-service/validate.go`\n- `services/user-service/handler.go`\n- Extend `services/user-service/config.go` (JWTSecret, BCryptCost, TokenTTL)\n- Extend `services/user-service/main.go` (runMigrations, full route wiring)\n- `services/user-service/user_test.go`\n- **Checkpoint M2**: register→login→GET /me round-trip succeeds; duplicate email → 409; wrong password → 401 (same body as unknown email)\n\n### 7. URL Service — Full Implementation (6–8h)\n\n- `services/url-service/migration.sql`\n- `services/url-service/errors.go`\n- `services/url-service/validate.go`\n- `services/url-service/base62.go`\n- `services/url-service/codegen.go`\n- `services/url-service/store.go`\n- `services/url-service/outbox_store.go`\n- `services/url-service/cache.go`\n- `services/url-service/publisher.go`\n- `services/url-service/outbox.go`\n- `services/url-service/handler.go`\n- Extend `services/url-service/config.go` (JWTSecret, ShortURLBase, OutboxPollInterval)\n- Extend `services/url-service/main.go` (runMigrations, all routes, outbox coordinator start)\n- `services/url-service/url_test.go`\n- `services/url-service/bench_test.go`\n- **Checkpoint M3**: POST /shorten → 201; GET /:code → 301 (DB then Redis); DELETE → 204 + 410; outbox rows transition to `published_at != NULL` within 5s; `EXPLAIN ANALYZE` shows index scans\n\n### 8. Analytics Service — Full Implementation (4–5h)\n\n- `services/analytics-service/migration.sql`\n- `services/analytics-service/errors.go`\n- `services/analytics-service/haship.go`\n- `services/analytics-service/store.go`\n- `services/analytics-service/publisher.go`\n- `services/analytics-service/milestone.go`\n- `services/analytics-service/consumer.go`\n- `services/analytics-service/handler.go`\n- Extend `services/analytics-service/config.go` (IPHashSalt)\n- Extend `services/analytics-service/main.go` (runMigrations, consumer goroutine, /stats routes)\n- `services/analytics-service/analytics_test.go`\n- **Checkpoint M4**: same `event_id` processed twice → click count = 1; 10 redirects → `milestones` row milestone=10; GET /stats → 200 with correct counts; `EXPLAIN ANALYZE` shows index scans\n\n### 9. Extended shared/logger (30 min)\n\n- Extend `shared/logger/logger.go` — add `WithCorrelationID`, `CorrelationIDFromContext`, `ContextWithCorrelationID`, `RequestLogger`, `responseWriter`\n- Verify `go build ./...` from root still exits 0\n\n### 10. Notification Service — Full Implementation (2–3h)\n\n- `services/notification-service/migration.sql`\n- `services/notification-service/errors.go`\n- `services/notification-service/store.go`\n- `services/notification-service/consumer.go`\n- `services/notification-service/handler.go`\n- Extend `services/notification-service/config.go` (JWTSecret)\n- Extend `services/notification-service/main.go` (runMigrations, consumer goroutine, /notifications route)\n- `services/notification-service/notification_test.go`\n- **Checkpoint M5-a**: URLCreatedEvent consumed → notifications row inserted with status='sent'; GET /notifications with valid JWT → 200 with notification item\n\n### 11. API Gateway — Full Implementation (4–5h)\n\n- Extend `gateway/config.go` (all fields: upstream URLs, Redis, JWT, CB settings, RateLimits map)\n- `gateway/errors.go`\n- `gateway/middleware.go`\n- `gateway/proxy.go`\n- `gateway/router.go`\n- `gateway/jwtmiddleware.go`\n- `gateway/ratelimit.go`\n- `gateway/circuitbreaker.go`\n- Extend `gateway/main.go` (full wiring: Redis client, proxies, CB, RL, Gateway, mux, upstream health checks)\n- `gateway/gateway_test.go`\n- `scripts/e2e_test.sh`\n- **Checkpoint M5-b**: `bash scripts/e2e_test.sh` → all assertions pass; 11th POST /api/shorten → 429; 6th request after url-service stop → 503; circuit reopens after 30s probe; `X-Correlation-ID` in logs of all services for same request\n\n---\n\n## File Count Summary\n\n| Category                      | Count            |\n| ----------------------------- | ---------------- |\n| `shared/` package files       | 8                |\n| `url-service/` files          | 18               |\n| `analytics-service/` files    | 16               |\n| `user-service/` files         | 15               |\n| `notification-service/` files | 14               |\n| `gateway/` files              | 13               |\n| Root / scripts / infra        | 3                |\n| **Total files**               | **87**           |\n| **Directories**               | **14**           |\n| **Estimated lines of code**   | **~6,500–8,000** |\n\n"}