id: firewall-packet-filter
name: Firewall and Packet Filter
description: Build a stateful packet filter firewall with rule matching, connection tracking, and NAT.
difficulty: advanced
domain: systems
estimated_hours: 50-70
essence: Firewalls inspect packets against rules and track connection state for security.
why_important: Every production network uses firewalls. Understanding internals is critical for security engineers.
learning_outcomes:
- Implement packet matching against rules
- Build connection tracking table
- Implement basic NAT
- Design rule language
- Handle multiple chains
skills:
- Packet Filtering
- Connection Tracking
- NAT Implementation
- Network Security
tags:
- advanced
- networking
- security
- firewall
- nat
languages:
  recommended:
  - Rust
  - C
  - Go
  also_possible:
  - Python
prerequisites:
- type: skill
  name: Socket programming
- type: skill
  name: IP TCP UDP headers
- type: skill
  name: Basic networking
resources:
- name: iptables Tutorial
  type: tutorial
  url: https://www.frozentux.net/iptables-tutorial/iptables-tutorial.html
- name: nftables Wiki
  type: documentation
  url: https://wiki.nftables.org/
- name: Netfilter Architecture
  type: documentation
  url: https://www.netfilter.org/
milestones:
- id: fw-m1
  name: Rule Engine and Matching
  description: Implement rule parser and packet matching logic.
  estimated_hours: 10-14
  concepts:
  - Five-tuple matching
  - Rule priority
  - CIDR notation
  skills:
  - Rule parsing
  - Pattern matching
  acceptance_criteria:
  - Design rule format with all fields
  - Parse rules from config file
  - Implement CIDR matching correctly
  - Implement port range matching
  - First match wins ordering
  - Default policy when no match
  - Rule evaluation under 1ms for 1000 rules
  pitfalls:
  - CIDR needs bit manipulation
  - Empty fields mean match any
  deliverables:
  - Rule parser
  - Five-tuple matching engine
  - Performance benchmark
- id: fw-m2
  name: Connection Tracking
  description: Implement connection tracking for stateful inspection.
  estimated_hours: 12-16
  concepts:
  - Connection states
  - Table management
  - Timeout cleanup
  skills:
  - State machine
  - Hash table design
  acceptance_criteria:
  - Build connection table by five-tuple
  - Track NEW ESTABLISHED RELATED INVALID states
  - Handle TCP flags for state transitions
  - Implement connection timeout
  - Support rules matching on state
  - Support 10000 concurrent connections
  - Lookup under 100 microseconds
  pitfalls:
  - UDP is connectionless
  - Memory leak without cleanup
  deliverables:
  - Connection tracking table
  - State transitions
  - Timeout cleanup
- id: fw-m3
  name: Packet Processing Chains
  description: Implement INPUT OUTPUT and FORWARD chains.
  estimated_hours: 10-12
  concepts:
  - Netfilter chains
  - Packet flow hooks
  - Jump targets
  skills:
  - Pipeline design
  - Chain management
  acceptance_criteria:
  - Implement three chains
  - Route packets to correct chain
  - Each chain has own rules and policy
  - Support jump to another chain
  - Implement RETURN action
  - Loop detection with max depth 10
  - Process 10000 packets per second
  pitfalls:
  - Loops cause overflow
  - FORWARD needs IP forwarding enabled
  deliverables:
  - Three-chain architecture
  - Packet routing
  - Jump and return actions
- id: fw-m4
  name: NAT Implementation
  description: Implement Source NAT and Destination NAT.
  estimated_hours: 12-16
  concepts:
  - Source NAT
  - Destination NAT
  - Port allocation
  skills:
  - Address translation
  - Checksum recalculation
  acceptance_criteria:
  - Implement SNAT for outgoing packets
  - Implement DNAT for incoming packets
  - Implement MASQUERADE mode
  - Allocate unique external ports
  - Integrate with connection tracking
  - Recalculate IP and TCP checksums
  - Support port forwarding rules
  - Handle 100 concurrent NAT connections
  pitfalls:
  - Checksum must be recalculated
  - Port exhaustion issues
  deliverables:
  - SNAT implementation
  - DNAT implementation
  - Port allocation
- id: fw-m5
  name: Rate Limiting and Logging
  description: Add rate limiting and packet logging.
  estimated_hours: 8-10
  concepts:
  - Token bucket
  - Connection limits
  - Packet logging
  skills:
  - Rate limiting algorithms
  - Logging infrastructure
  acceptance_criteria:
  - Implement token bucket rate limiter
  - Support burst allowance
  - Connection limit per source IP
  - Log matched packets with details
  - Export to PCAP format
  - Rate accuracy within 10 percent
  - DoS protection by dropping excess
  pitfalls:
  - Precise timing needed
  - Logging overhead
  deliverables:
  - Token bucket limiter
  - Connection limiter
  - Packet logging
