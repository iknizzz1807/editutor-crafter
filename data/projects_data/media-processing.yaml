id: media-processing
name: Media Processing Pipeline
description: >-
  Image and video processing pipeline with async job queue, format conversion,
  transcoding, thumbnail generation, progress tracking, and webhook
  notifications.
difficulty: advanced
estimated_hours: 45
essence: >-
  Async job queue orchestrating concurrent media transformation workers that
  perform codec-level video transcoding with FFmpeg, image format conversion
  and optimization, and thumbnail generation — with real-time progress
  tracking, retry logic for failed jobs, and webhook notifications on
  completion.
why_important: >-
  Building this teaches production-grade async processing architecture,
  codec-level media manipulation, and distributed job patterns essential for
  scalable content platforms and streaming services.
learning_outcomes:
  - Design async task queue architecture for distributed media processing
  - Implement image resizing and format conversion with optimization
  - Build FFmpeg video transcoding pipeline with multi-bitrate output
  - Implement real-time progress tracking across worker processes
  - Design resilient error handling and retry logic for processing jobs
  - Build webhook notification system for job lifecycle events
skills:
  - Async Task Queues
  - Video Codec Transcoding
  - Image Format Optimization
  - FFmpeg Pipeline Design
  - Distributed Worker Systems
  - Progress Tracking
  - Webhook Integration
tags:
  - advanced
  - ffmpeg
  - images
  - media
  - thumbnails
  - transcoding
  - video
architecture_doc: architecture-docs/media-processing/index.md
languages:
  recommended:
    - Python
    - Go
    - Rust
  also_possible: []
resources:
  - name: FFmpeg Official Documentation
    url: https://www.ffmpeg.org/documentation.html
    type: documentation
  - name: Pillow Python Imaging Library
    url: https://pillow.readthedocs.io/
    type: documentation
  - name: Celery Distributed Task Queue
    url: https://www.linode.com/docs/guides/task-queue-celery-rabbitmq/
    type: tutorial
  - name: Modern Image Formats Guide
    url: https://www.smashingmagazine.com/2021/09/modern-image-formats-avif-webp/
    type: article
  - name: Web Video Codec Reference
    url: https://developer.mozilla.org/en-US/docs/Web/Media/Guides/Formats/Video_codecs
    type: documentation
prerequisites:
  - type: skill
    name: Message queue/pub-sub basics
  - type: skill
    name: File I/O and streaming
milestones:
  - id: media-processing-m1
    name: Processing Queue & Worker Infrastructure
    description: >-
      Build the async job queue and worker infrastructure that will orchestrate
      all media processing. This is the foundation — image and video processing
      modules will be plugged into this queue in subsequent milestones.
    estimated_hours: 14
    concepts:
      - Message queue patterns: work queues with competing consumers
      - Priority queues: urgent jobs processed before batch jobs
      - Idempotent job processing: same job submitted twice produces same result without duplication
      - "Exponential backoff retry for transient failures"
      - "Webhook delivery with signature verification and retry"
      - Temporary file lifecycle: create before processing, clean up after completion or failure
    skills:
      - Job queue implementation
      - Worker process management
      - Progress tracking
      - Webhook integration
      - Error handling and retry
    acceptance_criteria:
      - "Jobs are submitted to a queue with a type (image_resize, video_transcode, thumbnail), payload, priority (high/normal/low), and optional webhook callback URL"
      - "Workers dequeue jobs by priority and execute the corresponding handler; configurable concurrency (default 2 parallel jobs) prevents resource exhaustion"
      - "Processing progress is tracked in stages (queued -> processing -> stage_1 -> stage_2 -> ... -> completed/failed) queryable via API; each stage transition records a timestamp"
      - "Failed jobs are retried with exponential backoff (base 5s, max 5 minutes) up to a configurable maximum (default 3 retries)"
      - "Webhook notifications are sent on job state transitions (started, progress, completed, failed) to the callback URL with HMAC-SHA256 signature; webhook delivery is retried up to 3 times on failure"
      - "Temporary files created during processing are cleaned up within 60 seconds of job completion or failure, verified by checking the temp directory"
      - "Job results (output file paths, metadata) are stored and retrievable by job ID for 24 hours after completion"
      - "A stuck job (no progress update for configurable timeout, default 10 minutes) is detected and marked as failed with a timeout error"
    pitfalls:
      - "Not cleaning up temporary files after processing, filling disk over time"
      - "Video progress percentage is hard to estimate — use discrete stages instead"
      - "Webhook delivery failure going unnoticed — must retry and log failures"
      - "No resource limits allowing a single large video to consume all CPU/memory"
      - "Processing same job twice due to missing idempotency check"
    deliverables:
      - Job queue accepting processing requests with type, payload, priority, and callback URL
      - Worker pool with configurable concurrency and job type routing
      - "Stage-based progress tracker (queued, processing, stages, completed, failed)"
      - Exponential backoff retry handler with configurable max retries
      - Webhook notification sender with HMAC signature and retry logic
      - Temporary file cleanup on job completion and failure
      - Stuck job detector with configurable timeout
      - Job result storage with TTL-based expiration

  - id: media-processing-m2
    name: Image Processing
    description: >-
      Implement image processing handlers (resize, crop, format conversion,
      thumbnail) that plug into the job queue from Milestone 1.
    estimated_hours: 13
    concepts:
      - Color space: images must be in RGB for processing; CMYK input requires conversion
      - Interpolation algorithms: Lanczos for downscaling, bicubic for upscaling
      - EXIF orientation: rotate image according to EXIF orientation tag before processing
      - Lossy vs lossless: JPEG/WebP lossy save bandwidth; PNG lossless preserves quality
      - Privacy: strip EXIF GPS data from output unless explicitly configured to preserve
    skills:
      - Image format handling
      - Resize algorithms
      - Format optimization
      - EXIF metadata handling
    acceptance_criteria:
      - "Images are resized to multiple target dimensions (configurable list, e.g., 150x150, 600x400, 1200x800) preserving aspect ratio with letterboxing or center-crop as configured"
      - "EXIF orientation tag is read and applied (image rotated/flipped accordingly) BEFORE any resize or crop operation"
      - "Format conversion between JPEG, PNG, and WebP produces valid output with configurable quality level (1-100); output file size for WebP is at least 20% smaller than equivalent JPEG at same perceptual quality"
      - "Thumbnails are generated at standard sizes (64x64, 128x128, 256x256) with center-crop; the crop center is the geometric center of the image"
      - "EXIF metadata is stripped from output by default (privacy: no GPS data); an explicit 'preserve_exif' option retains metadata when needed"
      - "Invalid or corrupt image inputs return a descriptive error within 1 second rather than hanging or crashing the worker"
      - "Image processing jobs report progress stages to the queue: (validating -> resizing -> converting -> uploading -> completed)"
    pitfalls:
      - "Not applying EXIF orientation before processing — images appear rotated"
      - "WebP/AVIF browser support varies — always generate JPEG fallback"
      - "Using wrong interpolation algorithm (nearest-neighbor for downscaling produces aliasing)"
      - "Processing very large images (50MP+) in memory — consider streaming or tiling"
      - "Not validating image dimensions before processing causing OOM on decompression bombs"
    deliverables:
      - Image loader reading JPEG, PNG, WebP, GIF with EXIF orientation auto-rotation
      - Resize engine with configurable dimensions, aspect ratio mode, and interpolation
      - Center-crop thumbnail generator at standard sizes
      - Format converter (JPEG, PNG, WebP) with quality parameter
      - EXIF metadata reader, stripper, and optional preserver
      - Input validation (file type, dimensions, decompression bomb detection)
      - Progress stage reporting to job queue

  - id: media-processing-m3
    name: Video Transcoding
    description: >-
      Implement video transcoding handlers using FFmpeg that plug into the job
      queue, producing multiple quality variants with thumbnail extraction.
    estimated_hours: 18
    concepts:
      - Container vs codec: MP4 container with H.264 video + AAC audio for maximum compatibility
      - CRF (Constant Rate Factor): quality-based encoding where lower CRF = higher quality = larger file
      - Keyframe interval (GOP): shorter GOP enables faster seeking but increases file size
      - HLS segmentation: split video into 6-second TS segments with M3U8 playlist
      - -movflags +faststart: moves metadata to beginning of MP4 for progressive download
    skills:
      - FFmpeg command-line integration
      - Video codec parameters
      - HLS manifest generation
      - Progress parsing from FFmpeg output
    acceptance_criteria:
      - "FFmpeg transcodes videos to H.264 (baseline profile for compatibility) + AAC audio in MP4 container with -movflags +faststart"
      - "Multiple quality variants are generated from a single source: 360p (CRF 28), 720p (CRF 23), 1080p (CRF 20) with configurable CRF values"
      - "HLS output is generated with fixed 6-second segments (TS format) and valid M3U8 playlists; a master playlist references all quality variants with BANDWIDTH and RESOLUTION tags"
      - "Video thumbnail frames are extracted at configurable time offsets (default: 0s, 25%, 50%, 75%) as JPEG images"
      - "FFmpeg progress is parsed from stderr output (frame count / total frames) and reported as stage progress to the job queue, updated at least every 5 seconds"
      - "Transcoding jobs run with configurable resource limits (max 2 concurrent FFmpeg processes, CPU nice level) to prevent resource exhaustion"
      - "Failed transcoding (FFmpeg exit code != 0) captures the FFmpeg stderr output in the error record for debugging"
      - "Output files are written to configurable storage (local disk or object storage path) with a predictable directory structure: /{job_id}/{variant}/"
    pitfalls:
      - "Not using H.264 baseline profile — some mobile devices can't decode main/high profile"
      - "Forgetting -movflags +faststart for MP4 — video won't play until fully downloaded"
      - "FFmpeg process consuming all system memory on 4K source files — limit resolution and memory"
      - "Not handling audio-only or video-only inputs (FFmpeg errors on missing streams)"
      - "HLS segment duration mismatch between variants causing quality switching glitches"
      - "H.265 encoding requires patent licensing — stick with H.264 for open-source projects"
    deliverables:
      - FFmpeg wrapper executing transcoding as subprocess with stderr progress parsing
      - Quality variant configuration (resolution, CRF, codec profile per variant)
      - HLS segment and manifest generator (TS segments + M3U8 playlists)
      - Thumbnail frame extractor at configurable time offsets
      - Resource limiter for concurrent FFmpeg processes
      - Output storage organizer with predictable directory structure
      - FFmpeg error capture and reporting to job queue
      - Progress stage reporting (queued -> transcoding: 360p -> transcoding:720p -> ... -> completed)