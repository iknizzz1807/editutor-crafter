id: micro-vmm-hypervisor
name: Micro VMM Hypervisor
description: >
  Build a minimal Virtual Machine Monitor (hypervisor) using the KVM API
  to run simple guest operating systems with virtual CPUs and memory.

difficulty: expert
estimated_hours: 80-100
domain: systems

essence: >
  KVM API for creating and managing virtual machines, vCPU execution loops,
  memory slot management for guest physical memory, interrupt injection,
  and I/O handling for virtual devices.

why_important: >
  Cloud infrastructure runs on hypervisors. Understanding VM internals is
  valuable at $200K-400K+ for cloud engineers, security researchers, and
  systems developers at AWS, Google Cloud, Azure.

learning_outcomes:
  - Use KVM API to create and manage VMs
  - Implement vCPU execution loop
  - Configure guest physical memory
  - Handle VM exits for I/O and interrupts
  - Implement basic virtual devices (serial, block)
  - Boot a simple guest OS (Linux, minimal kernel)
  - Understand x86 virtualization extensions
  - Debug hypervisor and guest issues

skills:
  - KVM API
  - Hypervisor Design
  - vCPU Management
  - Memory Virtualization
  - I/O Virtualization
  - Interrupt Handling
  - x86 Architecture
  - Guest OS Debugging

tags:
  - cloud
  - expert
  - hypervisor
  - kvm
  - systems
  - virtual-machine
  - virtualization
  - vmm

languages:
  recommended:
    - C
    - Rust
  also_possible:
    - C++

resources:
  - name: "KVM API Documentation"
    url: https://www.kernel.org/doc/html/latest/virt/kvm/api.html
    type: documentation
  - name: "Writing a Simple KVM Hypervisor"
    url: https://kvmforum2020.sched.com/event/eEz4/diy-create-your-own-minimal-vmm-mohamed-fawzy-karam-allam-amazon
    type: video
  - name: "Cloud Hypervisor (Rust VMM)"
    url: https://github.com/cloud-hypervisor/cloud-hypervisor
    type: reference
  - name: "Intel VT-x Specification"
    url: https://www.intel.com/content/www/us/en/developer/articles/technical/virtualization-technology-for-directed-io-vt-d-enhancing-intel-platforms-for-efficient-virtualization-of-io-devices.html
    type: documentation

prerequisites:
  - type: skill
    name: C systems programming
  - type: skill
    name: x86 architecture knowledge (registers, modes)
  - type: skill
    name: Linux kernel API experience
  - type: skill
    name: Understanding of virtualization concepts

milestones:
  - id: vmm-m1
    name: KVM Setup & VM Creation
    description: >
      Initialize KVM and create a basic virtual machine with memory slots.
    acceptance_criteria:
      - Open /dev/kvm and check capabilities
      - Create VM file descriptor
      - Set up guest physical memory slots
      - Create vCPU file descriptor
      - Query and display KVM capabilities
      - Basic error handling for KVM operations
    pitfalls:
      - Memory slots must be page-aligned
      - KVM capabilities vary by kernel version
      - Permission issues with /dev/kvm
      - Memory slot limits (usually 32-512)
      - Guest physical address space layout
    concepts:
      - KVM API
      - VM creation
      - Memory slots
      - vCPU creation
    skills:
      - KVM initialization
      - Memory configuration
      - API usage
      - Error handling
    deliverables:
      - KVM initialization code
      - Memory slot setup
      - vCPU creation
      - Capability display
    estimated_hours: "12-14"

  - id: vmm-m2
    name: vCPU Execution Loop
    description: >
      Implement the vCPU execution loop that runs guest code and handles
      VM exits.
    acceptance_criteria:
      - Set up vCPU registers (RIP, RSP, CR0, CR4, etc.)
      - Implement vCPU run loop with KVM_RUN ioctl
      - Handle basic VM exits (HLT, IO, EXCEPTION)
      - Parse exit reasons from kvm_run structure
      - Support for at least 100K VM exits/second
      - Clean shutdown on guest termination
    pitfalls:
      - Initial register state must be valid for real mode
      - Some exits require emulation; some can be reflected
      - Infinite exit loops indicate configuration problems
      - vCPU state must be consistent across exits
      - Signal handling during KVM_RUN
    concepts:
      - vCPU state
      - VM exits
      - Execution loop
      - Exit handling
    skills:
      - Register setup
      - Exit dispatch
      - State management
      - Performance optimization
    deliverables:
      - vCPU initialization
      - Run loop implementation
      - Exit handler dispatch
      - State management
    estimated_hours: "16-18"

  - id: vmm-m3
    name: I/O Virtualization
    description: >
      Implement I/O handling for virtual devices including serial console
      and basic block device.
    acceptance_criteria:
      - Handle PIO (port I/O) exits
      - Handle MMIO (memory-mapped I/O) exits
      - Implement simple serial console (0x3F8)
      - Basic virtio device skeleton (optional)
      - Guest can print to console
      - Guest can read keyboard input (optional)
    pitfalls:
      - PIO vs MMIO have different handling
      - String I/O (rep ins/outs) is complex
      - MMIO must be registered in memory slots
      - Device state must persist across exits
      - Timing differences from real hardware
    concepts:
      - I/O virtualization
      - PIO handling
      - MMIO handling
      - Device emulation
    skills:
      - Exit handling
      - Device emulation
      - State management
      - Console implementation
    deliverables:
      - PIO handler
      - MMIO handler
      - Serial console
      - Device state
    estimated_hours: "16-20"

  - id: vmm-m4
    name: Interrupt & Exception Handling
    description: >
      Implement interrupt injection and exception handling for the guest.
    acceptance_criteria:
      - Set up IDT in guest
      - Inject external interrupts (timer, keyboard)
      - Handle guest exceptions (page fault, GPF)
      - Implement interrupt controller (PIC/APIC) basics
      - Timer interrupt for guest scheduling
      - Exception reflection to guest when appropriate
    pitfalls:
      - Interrupt injection window must be checked
      - Exception handling can cause nested exits
      - IDT setup in real vs protected mode differs
      - APIC is much more complex than PIC
      - Interrupt priority and masking
    concepts:
      - Interrupt injection
      - Exception handling
      - IDT setup
      - Interrupt controller
    skills:
      - Interrupt programming
      - Exception handling
      - IDT management
      - Timing
    deliverables:
      - IDT setup code
      - Interrupt injection
      - Exception handler
      - Timer interrupt
    estimated_hours: "14-16"

  - id: vmm-m5
    name: Boot Linux & Production Features
    description: >
      Boot a real Linux kernel as guest and add production features
      like snapshot/restore and monitoring.
    acceptance_criteria:
      - Load Linux kernel (bzImage) into guest memory
      - Set up boot parameters (cmdline, initrd)
      - Boot to init process or shell
      - Basic snapshot (save/restore state)
      - Memory statistics tracking
      - vCPU usage metrics
      - Documentation for running guests
    pitfalls:
      - Linux boot protocol is complex
      - Boot parameters must be correct
      - initrd/initramfs setup
      - Console output requires proper serial setup
      - Snapshot consistency is hard
    concepts:
      - Linux boot protocol
      - Guest OS support
      - Snapshot/restore
      - Monitoring
    skills:
      - Boot process
      - Linux configuration
      - State serialization
      - Monitoring
    deliverables:
      - Linux boot support
      - Snapshot feature
      - Statistics collection
      - Documentation
    estimated_hours: "18-22"
